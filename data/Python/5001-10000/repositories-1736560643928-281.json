{
  "metadata": {
    "timestamp": 1736560643928,
    "page": 281,
    "hasNextPage": true,
    "endCursor": "Y3Vyc29yOjI5MA==",
    "completionStatus": "IN_PROGRESS"
  },
  "repositories": [
    {
      "nameWithOwner": "TheLastBen/fast-stable-diffusion",
      "stars": 7607,
      "defaultBranch": "main",
      "files": [
        {
          "name": ".gitattributes",
          "type": "blob",
          "size": 0.1162109375,
          "content": "Dependencies/db_deps.tar.zst filter=lfs diff=lfs merge=lfs -text\nA1111_dep.tar.zst filter=lfs diff=lfs merge=lfs -text\n"
        },
        {
          "name": ".github",
          "type": "tree",
          "content": null
        },
        {
          "name": ".gitignore",
          "type": "blob",
          "size": 0.009765625,
          "content": ".DS_Store\n"
        },
        {
          "name": "AUTOMATIC1111_files",
          "type": "tree",
          "content": null
        },
        {
          "name": "Dependencies",
          "type": "tree",
          "content": null
        },
        {
          "name": "Dreambooth",
          "type": "tree",
          "content": null
        },
        {
          "name": "LICENSE",
          "type": "blob",
          "size": 1.0302734375,
          "content": "Copyright © 2022 Ben\n\nPermission is hereby granted, free of charge, to any person obtaining a copy of this software and associated documentation files (the “Software”), to deal in the Software without restriction, including without limitation the rights to use, copy, modify, merge, publish, distribute, sublicense, and/or sell copies of the Software, and to permit persons to whom the Software is furnished to do so, subject to the following conditions:\n\nThe above copyright notice and this permission notice shall be included in all copies or substantial portions of the Software.\n\nTHE SOFTWARE IS PROVIDED “AS IS”, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.\n\n"
        },
        {
          "name": "README.md",
          "type": "blob",
          "size": 1.5966796875,
          "content": "# Shoutout to <a href=\"https://www.paperspace.com\" target=\"_blank\"><img src='https://raw.githubusercontent.com/TheLastBen/fast-stable-diffusion/main/.github/Paperspace.png' width=\"170\" height=\"40\" style=\"vertical-align: middle; margin-bottom: 8px; background-color: black\"></a> for sponsoring the project\n \n# fast-stable-diffusion Notebooks, A1111 + ComfyUI + DreamBooth\nPaperspace adaptations AUTOMATIC1111 Webui, ComfyUI and Dreambooth.\n \n<center><b>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Paperspace\n\n \n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\n<a href=\"https://console.paperspace.com/github/TheLastBen/PPS\"><img src='https://github.com/TheLastBen/fast-stable-diffusion/raw/main/Dreambooth/2.png'></a>\n \n \n\nDreambooth paper : https://dreambooth.github.io/\n\nSD implementation by @XavierXiao : https://github.com/XavierXiao/Dreambooth-Stable-Diffusion\n"
        },
        {
          "name": "fast-DreamBooth.ipynb",
          "type": "blob",
          "size": 65.4892578125,
          "content": "{\n \"cells\": [\n  {\n   \"attachments\": {},\n   \"cell_type\": \"markdown\",\n   \"metadata\": {\n    \"id\": \"qEsNHTtVlbkV\"\n   },\n   \"source\": [\n    \"# **Colab Pro notebook from https://github.com/TheLastBen/fast-stable-diffusion** *Alternatives : [Paperspace](https://console.paperspace.com/github/TheLastBen/PPS?machine=Free-GPU)*\"\n   ]\n  },\n  {\n   \"cell_type\": \"code\",\n   \"execution_count\": null,\n   \"metadata\": {\n    \"id\": \"A4Bae3VP6UsE\"\n   },\n   \"outputs\": [],\n   \"source\": [\n    \"from google.colab import drive\\n\",\n    \"drive.mount('/content/gdrive')\"\n   ]\n  },\n  {\n   \"cell_type\": \"code\",\n   \"execution_count\": null,\n   \"metadata\": {\n    \"cellView\": \"form\",\n    \"id\": \"QyvcqeiL65Tj\"\n   },\n   \"outputs\": [],\n   \"source\": [\n    \"#@markdown # Dependencies\\n\",\n    \"\\n\",\n    \"from IPython.utils import capture\\n\",\n    \"import time\\n\",\n    \"import os\\n\",\n    \"\\n\",\n    \"print('\\u001b[1;32mInstalling dependencies...')\\n\",\n    \"with capture.capture_output() as cap:\\n\",\n    \"    os.chdir('/content')\\n\",\n    \"    !pip uninstall diffusers -qq -y\\n\",\n    \"    !pip install -qq --no-deps accelerate==0.12.0\\n\",\n    \"    !rm -r /usr/local/lib/python3.10/dist-packages/wandb*\\n\",\n    \"    !wget -q -i https://raw.githubusercontent.com/TheLastBen/fast-stable-diffusion/main/Dependencies/dbdeps.txt\\n\",\n    \"    !dpkg -i *.deb\\n\",\n    \"    !tar -C / --zstd -xf gcolabdeps.tar.zst\\n\",\n    \"    !rm *.deb | rm *.zst | rm *.txt\\n\",\n    \"    !git clone -q --depth 1 --branch main https://github.com/TheLastBen/diffusers\\n\",\n    \"    !pip install gradio==3.16.2 --no-deps -qq\\n\",\n    \"    !rm -r /usr/local/lib/python3.10/dist-packages/google/_upb\\n\",\n    \"\\n\",\n    \"    if not os.path.exists('gdrive/MyDrive/sd/libtcmalloc/libtcmalloc_minimal.so.4'):\\n\",\n    \"        %env CXXFLAGS=-std=c++14\\n\",\n    \"        !wget -q https://github.com/gperftools/gperftools/releases/download/gperftools-2.5/gperftools-2.5.tar.gz && tar zxf gperftools-2.5.tar.gz && mv gperftools-2.5 gperftools\\n\",\n    \"        !wget -q https://github.com/TheLastBen/fast-stable-diffusion/raw/main/AUTOMATIC1111_files/Patch\\n\",\n    \"        %cd /content/gperftools  \\n\",\n    \"        !patch -p1 < /content/Patch\\n\",\n    \"        !./configure --enable-minimal --enable-libunwind --enable-frame-pointers --enable-dynamic-sized-delete-support --enable-sized-delete --enable-emergency-malloc; make -j4\\n\",\n    \"        !mkdir -p /content/gdrive/MyDrive/sd/libtcmalloc && cp .libs/libtcmalloc*.so* /content/gdrive/MyDrive/sd/libtcmalloc\\n\",\n    \"        %env LD_PRELOAD=/content/gdrive/MyDrive/sd/libtcmalloc/libtcmalloc_minimal.so.4\\n\",\n    \"        %cd /content\\n\",\n    \"        !rm *.tar.gz Patch && rm -r /content/gperftools\\n\",\n    \"    else:\\n\",\n    \"        %env LD_PRELOAD=/content/gdrive/MyDrive/sd/libtcmalloc/libtcmalloc_minimal.so.4\\n\",\n    \"\\n\",\n    \"    os.environ['TF_CPP_MIN_LOG_LEVEL'] = '3'\\n\",\n    \"    os.environ['PYTHONWARNINGS'] = 'ignore'\\n\",\n    \"    !sed -i 's@raise AttributeError(f\\\"module {module!r} has no attribute {name!r}\\\")@@g' /usr/local/lib/python3.10/dist-packages/jax/_src/deprecations.py\\n\",\n    \"\\n\",\n    \"print('\\u001b[1;32mDone, proceed')\"\n   ]\n  },\n  {\n   \"cell_type\": \"markdown\",\n   \"metadata\": {\n    \"id\": \"R3SsbIlxw66N\"\n   },\n   \"source\": [\n    \"# Model Download\"\n   ]\n  },\n  {\n   \"cell_type\": \"code\",\n   \"execution_count\": null,\n   \"metadata\": {\n    \"cellView\": \"form\",\n    \"id\": \"O3KHGKqyeJp9\"\n   },\n   \"outputs\": [],\n   \"source\": [\n    \"import os\\n\",\n    \"import time\\n\",\n    \"from IPython.utils import capture\\n\",\n    \"from IPython.display import clear_output\\n\",\n    \"import wget\\n\",\n    \"from subprocess import check_output\\n\",\n    \"import urllib.request\\n\",\n    \"import requests\\n\",\n    \"import base64\\n\",\n    \"from gdown.download import get_url_from_gdrive_confirmation\\n\",\n    \"from urllib.parse import urlparse, parse_qs, unquote\\n\",\n    \"from urllib.request import urlopen, Request\\n\",\n    \"import re\\n\",\n    \"\\n\",\n    \"def getsrc(url):\\n\",\n    \"    parsed_url = urlparse(url)\\n\",\n    \"    if parsed_url.netloc == 'civitai.com':\\n\",\n    \"        src='civitai'\\n\",\n    \"    elif parsed_url.netloc == 'drive.google.com':\\n\",\n    \"        src='gdrive'\\n\",\n    \"    elif parsed_url.netloc == 'huggingface.co':\\n\",\n    \"        src='huggingface'\\n\",\n    \"    else:\\n\",\n    \"        src='others'\\n\",\n    \"    return src\\n\",\n    \"\\n\",\n    \"\\n\",\n    \"\\n\",\n    \"def get_name(url, gdrive):\\n\",\n    \"    if not gdrive:\\n\",\n    \"        response = requests.get(url, allow_redirects=False)\\n\",\n    \"        if \\\"Location\\\" in response.headers:\\n\",\n    \"            redirected_url = response.headers[\\\"Location\\\"]\\n\",\n    \"            quer = parse_qs(urlparse(redirected_url).query)\\n\",\n    \"            if \\\"response-content-disposition\\\" in quer:\\n\",\n    \"                disp_val = quer[\\\"response-content-disposition\\\"][0].split(\\\";\\\")\\n\",\n    \"                for vals in disp_val:\\n\",\n    \"                    if vals.strip().startswith(\\\"filename=\\\"):\\n\",\n    \"                        filenm=unquote(vals.split(\\\"=\\\", 1)[1].strip())\\n\",\n    \"                        return filenm.replace(\\\"\\\\\\\"\\\",\\\"\\\")\\n\",\n    \"    else:\\n\",\n    \"        headers = {\\\"User-Agent\\\": \\\"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_10_1) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/39.0.2171.95 Safari/537.36\\\"}\\n\",\n    \"        lnk=\\\"https://drive.google.com/uc?id={id}&export=download\\\".format(id=url[url.find(\\\"/d/\\\")+3:url.find(\\\"/view\\\")])\\n\",\n    \"        res = requests.session().get(lnk, headers=headers, stream=True, verify=True)\\n\",\n    \"        res = requests.session().get(get_url_from_gdrive_confirmation(res.text), headers=headers, stream=True, verify=True)\\n\",\n    \"        content_disposition = six.moves.urllib_parse.unquote(res.headers[\\\"Content-Disposition\\\"])\\n\",\n    \"        filenm = re.search('attachment; filename=\\\"(.*?)\\\"', content_disposition).groups()[0]\\n\",\n    \"        return filenm\\n\",\n    \"\\n\",\n    \"#@markdown - Skip this cell if you are loading a previous session that contains a trained model.\\n\",\n    \"\\n\",\n    \"#@markdown ---\\n\",\n    \"\\n\",\n    \"Model_Version = \\\"1.5\\\" #@param [ \\\"1.5\\\", \\\"V2.1-512px\\\", \\\"V2.1-768px\\\"]\\n\",\n    \"\\n\",\n    \"#@markdown - Choose which version to finetune.\\n\",\n    \"\\n\",\n    \"with capture.capture_output() as cap: \\n\",\n    \"  os.chdir('/content')\\n\",\n    \"\\n\",\n    \"#@markdown ---\\n\",\n    \"\\n\",\n    \"Path_to_HuggingFace= \\\"\\\" #@param {type:\\\"string\\\"}\\n\",\n    \"\\n\",\n    \"#@markdown - Load and finetune a model from Hugging Face, use the format \\\"profile/model\\\" like : runwayml/stable-diffusion-v1-5\\n\",\n    \"#@markdown - If the custom model is private or requires a token, create token.txt containing the token in \\\"Fast-Dreambooth\\\" folder in your gdrive.\\n\",\n    \"\\n\",\n    \"MODEL_PATH = \\\"\\\" #@param {type:\\\"string\\\"}\\n\",\n    \"\\n\",\n    \"MODEL_LINK = \\\"\\\" #@param {type:\\\"string\\\"}\\n\",\n    \"\\n\",\n    \"\\n\",\n    \"if os.path.exists('/content/gdrive/MyDrive/Fast-Dreambooth/token.txt'):\\n\",\n    \"  with open(\\\"/content/gdrive/MyDrive/Fast-Dreambooth/token.txt\\\") as f:\\n\",\n    \"     token = f.read()\\n\",\n    \"  authe=f'https://USER:{token}@'\\n\",\n    \"else:\\n\",\n    \"  authe=\\\"https://\\\"\\n\",\n    \"\\n\",\n    \"def downloadmodel():\\n\",\n    \"\\n\",\n    \"  if os.path.exists('/content/stable-diffusion-v1-5'):\\n\",\n    \"    !rm -r /content/stable-diffusion-v1-5\\n\",\n    \"  clear_output()\\n\",\n    \"\\n\",\n    \"  os.chdir('/content')\\n\",\n    \" \\n\",\n    \"  print(\\\"\\u001b[1;32mDownloading the model...\\\")\\n\",\n    \"  !wget -q \\\"https://huggingface.co/runwayml/stable-diffusion-v1-5/resolve/main/v1-5-pruned-emaonly.safetensors\\\" -O model.safetensors\\n\",\n    \"\\n\",\n    \"  if os.path.exists('/content/model.safetensors'):\\n\",\n    \"      !wget -q -O config.yaml https://github.com/CompVis/stable-diffusion/raw/main/configs/stable-diffusion/v1-inference.yaml\\n\",\n    \"      clear_output()\\n\",\n    \"      !python /content/diffusers/scripts/convert_original_stable_diffusion_to_diffusers.py --checkpoint_path /content/model.safetensors --dump_path /content/stable-diffusion-v1-5 --original_config_file config.yaml --from_safetensors\\n\",\n    \"      !rm config.yaml\\n\",\n    \"      clear_output()\\n\",\n    \"      os.chdir('/content/stable-diffusion-v1-5')\\n\",\n    \"      !wget -q -O vae/diffusion_pytorch_model.bin https://huggingface.co/stabilityai/sd-vae-ft-mse/resolve/main/diffusion_pytorch_model.bin\\n\",\n    \"      !rm model_index.json\\n\",\n    \"      clear_output()\\n\",\n    \"      time.sleep(1)    \\n\",\n    \"      wget.download('https://raw.githubusercontent.com/TheLastBen/fast-stable-diffusion/main/Dreambooth/model_index.json')\\n\",\n    \"      os.chdir('/content')\\n\",\n    \"\\n\",\n    \"\\n\",\n    \"def newdownloadmodel():\\n\",\n    \"\\n\",\n    \"  os.chdir('/content')\\n\",\n    \"  clear_output()\\n\",\n    \"  !mkdir /content/stable-diffusion-v2-768\\n\",\n    \"  os.chdir('/content/stable-diffusion-v2-768')\\n\",\n    \"  !git config --global init.defaultBranch main\\n\",\n    \"  !git init\\n\",\n    \"  !git lfs install --system --skip-repo\\n\",\n    \"  !git remote add -f origin  \\\"https://huggingface.co/stabilityai/stable-diffusion-2-1\\\"\\n\",\n    \"  !git config core.sparsecheckout true\\n\",\n    \"  !echo -e \\\"scheduler\\\\ntext_encoder\\\\ntokenizer\\\\nunet\\\\nvae\\\\nfeature_extractor\\\\nmodel_index.json\\\\n!*.safetensors\\\\n!*.fp16.bin\\\" > .git/info/sparse-checkout\\n\",\n    \"  !git pull origin main\\n\",\n    \"  !rm -r /content/stable-diffusion-v2-768/.git\\n\",\n    \"  os.chdir('/content')\\n\",\n    \"  clear_output()\\n\",\n    \"  print('\\u001b[1;32mDONE !')\\n\",\n    \"\\n\",\n    \"\\n\",\n    \"def newdownloadmodelb():\\n\",\n    \"\\n\",\n    \"  os.chdir('/content')\\n\",\n    \"  clear_output()\\n\",\n    \"  !mkdir /content/stable-diffusion-v2-512\\n\",\n    \"  os.chdir('/content/stable-diffusion-v2-512')\\n\",\n    \"  !git config --global init.defaultBranch main\\n\",\n    \"  !git init\\n\",\n    \"  !git lfs install --system --skip-repo\\n\",\n    \"  !git remote add -f origin  \\\"https://huggingface.co/stabilityai/stable-diffusion-2-1-base\\\"\\n\",\n    \"  !git config core.sparsecheckout true\\n\",\n    \"  !echo -e \\\"scheduler\\\\ntext_encoder\\\\ntokenizer\\\\nunet\\\\nvae\\\\nfeature_extractor\\\\nmodel_index.json\\\\n!*.safetensors\\\\n!*.fp16.bin\\\" > .git/info/sparse-checkout\\n\",\n    \"  !git pull origin main\\n\",\n    \"  !rm -r /content/stable-diffusion-v2-512/.git\\n\",\n    \"  os.chdir('/content')\\n\",\n    \"  clear_output()\\n\",\n    \"  print('\\u001b[1;32mDONE !')\\n\",\n    \"\\n\",\n    \"\\n\",\n    \"if Path_to_HuggingFace != \\\"\\\":\\n\",\n    \"  if authe==\\\"https://\\\":\\n\",\n    \"    textenc= f\\\"{authe}huggingface.co/{Path_to_HuggingFace}/resolve/main/text_encoder/pytorch_model.bin\\\"\\n\",\n    \"    txtenc_size=urllib.request.urlopen(textenc).info().get('Content-Length', None)\\n\",\n    \"  else:\\n\",\n    \"    textenc= f\\\"https://huggingface.co/{Path_to_HuggingFace}/resolve/main/text_encoder/pytorch_model.bin\\\"\\n\",\n    \"    req=urllib.request.Request(textenc)\\n\",\n    \"    req.add_header('Authorization', f'Bearer {token}')\\n\",\n    \"    txtenc_size=urllib.request.urlopen(req).info().get('Content-Length', None)\\n\",\n    \"  if int(txtenc_size)> 670000000 :\\n\",\n    \"    if os.path.exists('/content/stable-diffusion-custom'):\\n\",\n    \"      !rm -r /content/stable-diffusion-custom\\n\",\n    \"    clear_output()\\n\",\n    \"    os.chdir('/content')\\n\",\n    \"    clear_output()\\n\",\n    \"    print(\\\"\\u001b[1;32mV2\\\")\\n\",\n    \"    !mkdir /content/stable-diffusion-custom\\n\",\n    \"    os.chdir('/content/stable-diffusion-custom')\\n\",\n    \"    !git config --global init.defaultBranch main\\n\",\n    \"    !git init\\n\",\n    \"    !git lfs install --system --skip-repo\\n\",\n    \"    !git remote add -f origin  \\\"{authe}huggingface.co/{Path_to_HuggingFace}\\\"\\n\",\n    \"    !git config core.sparsecheckout true\\n\",\n    \"    !echo -e \\\"scheduler\\\\ntext_encoder\\\\ntokenizer\\\\nunet\\\\nvae\\\\nfeature_extractor\\\\nmodel_index.json\\\\n!*.safetensors\\\" > .git/info/sparse-checkout\\n\",\n    \"    !git pull origin main\\n\",\n    \"    if os.path.exists('/content/stable-diffusion-custom/unet/diffusion_pytorch_model.bin'):\\n\",\n    \"      !rm -r /content/stable-diffusion-custom/.git\\n\",\n    \"      os.chdir('/content')\\n\",\n    \"      MODEL_NAME=\\\"/content/stable-diffusion-custom\\\"\\n\",\n    \"      clear_output()\\n\",\n    \"      print('\\u001b[1;32mDONE !')\\n\",\n    \"    else:\\n\",\n    \"      while not os.path.exists('/content/stable-diffusion-custom/unet/diffusion_pytorch_model.bin'):\\n\",\n    \"            print('\\u001b[1;31mCheck the link you provided')\\n\",\n    \"            time.sleep(5)\\n\",\n    \"  else:\\n\",\n    \"    if os.path.exists('/content/stable-diffusion-custom'):\\n\",\n    \"      !rm -r /content/stable-diffusion-custom\\n\",\n    \"    clear_output()\\n\",\n    \"    os.chdir('/content')\\n\",\n    \"    clear_output()\\n\",\n    \"    print(\\\"\\u001b[1;32mV1\\\")\\n\",\n    \"    !mkdir /content/stable-diffusion-custom\\n\",\n    \"    os.chdir('/content/stable-diffusion-custom')\\n\",\n    \"    !git init\\n\",\n    \"    !git lfs install --system --skip-repo\\n\",\n    \"    !git remote add -f origin  \\\"{authe}huggingface.co/{Path_to_HuggingFace}\\\"\\n\",\n    \"    !git config core.sparsecheckout true\\n\",\n    \"    !echo -e \\\"scheduler\\\\ntext_encoder\\\\ntokenizer\\\\nunet\\\\nvae\\\\nmodel_index.json\\\\n!*.safetensors\\\" > .git/info/sparse-checkout\\n\",\n    \"    !git pull origin main\\n\",\n    \"    if os.path.exists('/content/stable-diffusion-custom/unet/diffusion_pytorch_model.bin'):\\n\",\n    \"      !rm -r /content/stable-diffusion-custom/.git\\n\",\n    \"      !rm model_index.json\\n\",\n    \"      time.sleep(1)\\n\",\n    \"      wget.download('https://raw.githubusercontent.com/TheLastBen/fast-stable-diffusion/main/Dreambooth/model_index.json')\\n\",\n    \"      os.chdir('/content')\\n\",\n    \"      MODEL_NAME=\\\"/content/stable-diffusion-custom\\\"\\n\",\n    \"      clear_output()\\n\",\n    \"      print('\\u001b[1;32mDONE !')\\n\",\n    \"    else:\\n\",\n    \"      while not os.path.exists('/content/stable-diffusion-custom/unet/diffusion_pytorch_model.bin'):\\n\",\n    \"            print('\\u001b[1;31mCheck the link you provided')\\n\",\n    \"            time.sleep(5)\\n\",\n    \"\\n\",\n    \"elif MODEL_PATH !=\\\"\\\":\\n\",\n    \"\\n\",\n    \"  modelname=os.path.basename(MODEL_PATH)\\n\",\n    \"  sftnsr=\\\"\\\"\\n\",\n    \"  if modelname.split('.')[-1]=='safetensors':\\n\",\n    \"    sftnsr=\\\"--from_safetensors\\\"  \\n\",\n    \"\\n\",\n    \"  %cd /content\\n\",\n    \"  clear_output()\\n\",\n    \"  if os.path.exists(str(MODEL_PATH)):\\n\",\n    \"    wget.download('https://github.com/TheLastBen/fast-stable-diffusion/raw/main/Dreambooth/det.py')\\n\",\n    \"    print('\\u001b[1;33mDetecting model version...')\\n\",\n    \"    Custom_Model_Version=check_output('python det.py '+sftnsr+' --MODEL_PATH '+str(MODEL_PATH), shell=True).decode('utf-8').replace('\\\\n', '')\\n\",\n    \"    clear_output()\\n\",\n    \"    print('\\u001b[1;32m'+Custom_Model_Version+' Detected')    \\n\",\n    \"    !rm det.py\\n\",\n    \"    if Custom_Model_Version=='1.5':      \\n\",\n    \"      !wget -q -O config.yaml https://github.com/CompVis/stable-diffusion/raw/main/configs/stable-diffusion/v1-inference.yaml\\n\",\n    \"      !python /content/diffusers/scripts/convert_original_stable_diffusion_to_diffusers.py --checkpoint_path \\\"$MODEL_PATH\\\" --dump_path stable-diffusion-custom --original_config_file config.yaml $sftnsr\\n\",\n    \"      !rm /content/config.yaml\\n\",\n    \"\\n\",\n    \"    elif Custom_Model_Version=='V2.1-512px':\\n\",\n    \"      !wget -q -O convertodiff.py https://raw.githubusercontent.com/TheLastBen/fast-stable-diffusion/main/Dreambooth/convertodiffv2.py\\n\",\n    \"      !python /content/convertodiff.py \\\"$MODEL_PATH\\\" /content/stable-diffusion-custom --v2 --reference_model stabilityai/stable-diffusion-2-1-base $sftnsr\\n\",\n    \"      !rm /content/convertodiff.py\\n\",\n    \"\\n\",\n    \"    elif Custom_Model_Version=='V2.1-768px':\\n\",\n    \"      !wget -q -O convertodiff.py https://github.com/TheLastBen/fast-stable-diffusion/raw/main/Dreambooth/convertodiffv2-768.py\\n\",\n    \"      !python /content/convertodiff.py \\\"$MODEL_PATH\\\" /content/stable-diffusion-custom --v2 --reference_model stabilityai/stable-diffusion-2-1 $sftnsr\\n\",\n    \"      !rm /content/convertodiff.py\\n\",\n    \"\\n\",\n    \"\\n\",\n    \"    if os.path.exists('/content/stable-diffusion-custom/unet/diffusion_pytorch_model.bin'):\\n\",\n    \"      clear_output()\\n\",\n    \"      MODEL_NAME=\\\"/content/stable-diffusion-custom\\\"\\n\",\n    \"      print('\\u001b[1;32mDONE !')\\n\",\n    \"    else:\\n\",\n    \"      !rm -r /content/stable-diffusion-custom\\n\",\n    \"      while not os.path.exists('/content/stable-diffusion-custom/unet/diffusion_pytorch_model.bin'):\\n\",\n    \"        print('\\u001b[1;31mConversion error')\\n\",\n    \"        time.sleep(5)\\n\",\n    \"  else:\\n\",\n    \"    while not os.path.exists(str(MODEL_PATH)):\\n\",\n    \"       print('\\u001b[1;31mWrong path, use the colab file explorer to copy the path')\\n\",\n    \"       time.sleep(5)\\n\",\n    \"\\n\",\n    \"elif MODEL_LINK !=\\\"\\\":\\n\",\n    \"    os.chdir('/content')\\n\",\n    \"\\n\",\n    \"    src=getsrc(MODEL_LINK)\\n\",\n    \"\\n\",\n    \"    if src=='civitai':\\n\",\n    \"       modelname=get_name(str(MODEL_LINK), False)\\n\",\n    \"    elif src=='gdrive':\\n\",\n    \"       modelname=get_name(str(MODEL_LINK), True)\\n\",\n    \"    else:\\n\",\n    \"       modelname=os.path.basename(str(MODEL_LINK))\\n\",\n    \"\\n\",\n    \"    sftnsr=\\\"\\\"\\n\",\n    \"    if modelname.split('.')[-1]!='safetensors':\\n\",\n    \"      modelnm=\\\"model.ckpt\\\"\\n\",\n    \"    else:\\n\",\n    \"      modelnm=\\\"model.safetensors\\\"\\n\",\n    \"      sftnsr=\\\"--from_safetensors\\\"\\n\",\n    \"    \\n\",\n    \"    !gdown --fuzzy \\\"$MODEL_LINK\\\" -O $modelnm\\n\",\n    \"\\n\",\n    \"    if os.path.exists(modelnm):\\n\",\n    \"      if os.path.getsize(modelnm) > 1810671599:\\n\",\n    \"        wget.download('https://github.com/TheLastBen/fast-stable-diffusion/raw/main/Dreambooth/det.py')\\n\",\n    \"        print('\\u001b[1;33mDetecting model version...')\\n\",\n    \"        Custom_Model_Version=check_output('python det.py '+sftnsr+' --MODEL_PATH '+modelnm, shell=True).decode('utf-8').replace('\\\\n', '')\\n\",\n    \"        clear_output()\\n\",\n    \"        print('\\u001b[1;32m'+Custom_Model_Version+' Detected') \\n\",\n    \"        !rm det.py\\n\",\n    \"        if Custom_Model_Version=='1.5':\\n\",\n    \"          !wget -q -O config.yaml https://github.com/CompVis/stable-diffusion/raw/main/configs/stable-diffusion/v1-inference.yaml\\n\",\n    \"          !python /content/diffusers/scripts/convert_original_stable_diffusion_to_diffusers.py --checkpoint_path $modelnm --dump_path stable-diffusion-custom --original_config_file config.yaml $sftnsr\\n\",\n    \"          !rm config.yaml\\n\",\n    \"\\n\",\n    \"        elif Custom_Model_Version=='V2.1-512px':\\n\",\n    \"          !wget -q -O convertodiff.py https://raw.githubusercontent.com/TheLastBen/fast-stable-diffusion/main/Dreambooth/convertodiffv2.py\\n\",\n    \"          !python /content/convertodiff.py $modelnm /content/stable-diffusion-custom --v2 --reference_model stabilityai/stable-diffusion-2-1-base $sftnsr\\n\",\n    \"          !rm convertodiff.py\\n\",\n    \"\\n\",\n    \"        elif Custom_Model_Version=='V2.1-768px':\\n\",\n    \"          !wget -q -O convertodiff.py https://github.com/TheLastBen/fast-stable-diffusion/raw/main/Dreambooth/convertodiffv2-768.py\\n\",\n    \"          !python /content/convertodiff.py $modelnm /content/stable-diffusion-custom --v2 --reference_model stabilityai/stable-diffusion-2-1 $sftnsr\\n\",\n    \"          !rm convertodiff.py\\n\",\n    \"\\n\",\n    \"\\n\",\n    \"        if os.path.exists('/content/stable-diffusion-custom/unet/diffusion_pytorch_model.bin'):\\n\",\n    \"          clear_output()\\n\",\n    \"          MODEL_NAME=\\\"/content/stable-diffusion-custom\\\"\\n\",\n    \"          print('\\u001b[1;32mDONE !')\\n\",\n    \"        else:\\n\",\n    \"          !rm -r stable-diffusion-custom\\n\",\n    \"          !rm $modelnm\\n\",\n    \"          while not os.path.exists('/content/stable-diffusion-custom/unet/diffusion_pytorch_model.bin'):\\n\",\n    \"            print('\\u001b[1;31mConversion error')\\n\",\n    \"            time.sleep(5)\\n\",\n    \"      else:\\n\",\n    \"        while os.path.getsize(modelnm) < 1810671599:\\n\",\n    \"           print('\\u001b[1;31mWrong link, check that the link is valid')\\n\",\n    \"           time.sleep(5)\\n\",\n    \"\\n\",\n    \"else:\\n\",\n    \"  if Model_Version==\\\"1.5\\\":\\n\",\n    \"    if not os.path.exists('/content/stable-diffusion-v1-5/unet'):\\n\",\n    \"      downloadmodel()\\n\",\n    \"      MODEL_NAME=\\\"/content/stable-diffusion-v1-5\\\"\\n\",\n    \"      print(\\\"\\u001b[1;32mv1.5 model downloaded\\\")\\n\",\n    \"    else:\\n\",\n    \"      MODEL_NAME=\\\"/content/stable-diffusion-v1-5\\\"\\n\",\n    \"      print(\\\"\\u001b[1;32mThe v1.5 model already exists, using this model.\\\")\\n\",\n    \"  elif Model_Version==\\\"V2.1-512px\\\":\\n\",\n    \"    if not os.path.exists('/content/stable-diffusion-v2-512'):\\n\",\n    \"      newdownloadmodelb()\\n\",\n    \"      MODEL_NAME=\\\"/content/stable-diffusion-v2-512\\\"\\n\",\n    \"    else:\\n\",\n    \"      MODEL_NAME=\\\"/content/stable-diffusion-v2-512\\\"\\n\",\n    \"      print(\\\"\\u001b[1;32mThe v2-512px model already exists, using this model.\\\")\\n\",\n    \"  elif Model_Version==\\\"V2.1-768px\\\":\\n\",\n    \"    if not os.path.exists('/content/stable-diffusion-v2-768'):\\n\",\n    \"      newdownloadmodel()\\n\",\n    \"      MODEL_NAME=\\\"/content/stable-diffusion-v2-768\\\"\\n\",\n    \"    else:\\n\",\n    \"      MODEL_NAME=\\\"/content/stable-diffusion-v2-768\\\"\\n\",\n    \"      print(\\\"\\u001b[1;32mThe v2-768px model already exists, using this model.\\\")\"\n   ]\n  },\n  {\n   \"cell_type\": \"markdown\",\n   \"metadata\": {\n    \"id\": \"0tN76Cj5P3RL\"\n   },\n   \"source\": [\n    \"# Dreambooth\"\n   ]\n  },\n  {\n   \"cell_type\": \"code\",\n   \"execution_count\": null,\n   \"metadata\": {\n    \"cellView\": \"form\",\n    \"id\": \"A1B299g-_VJo\"\n   },\n   \"outputs\": [],\n   \"source\": [\n    \"import os\\n\",\n    \"from IPython.display import clear_output\\n\",\n    \"from IPython.utils import capture\\n\",\n    \"from os import listdir\\n\",\n    \"from os.path import isfile\\n\",\n    \"from subprocess import check_output\\n\",\n    \"import wget\\n\",\n    \"import time\\n\",\n    \"\\n\",\n    \"#@markdown #Create/Load a Session\\n\",\n    \"\\n\",\n    \"try:\\n\",\n    \"  MODEL_NAME\\n\",\n    \"  pass\\n\",\n    \"except:\\n\",\n    \"  MODEL_NAME=\\\"\\\"\\n\",\n    \"  \\n\",\n    \"PT=\\\"\\\"\\n\",\n    \"\\n\",\n    \"Session_Name = \\\"\\\" #@param{type: 'string'}\\n\",\n    \"while Session_Name==\\\"\\\":\\n\",\n    \"  print('\\u001b[1;31mInput the Session Name:') \\n\",\n    \"  Session_Name=input('')\\n\",\n    \"Session_Name=Session_Name.replace(\\\" \\\",\\\"_\\\")\\n\",\n    \"\\n\",\n    \"#@markdown - Enter the session name, it if it exists, it will load it, otherwise it'll create an new session.\\n\",\n    \"\\n\",\n    \"Session_Link_optional = \\\"\\\" #@param{type: 'string'}\\n\",\n    \"\\n\",\n    \"#@markdown - Import a session from another gdrive, the shared gdrive link must point to the specific session's folder that contains the trained CKPT, remove any intermediary CKPT if any.\\n\",\n    \"\\n\",\n    \"WORKSPACE='/content/gdrive/MyDrive/Fast-Dreambooth'\\n\",\n    \"\\n\",\n    \"if Session_Link_optional !=\\\"\\\":\\n\",\n    \"  print('\\u001b[1;32mDownloading session...')\\n\",\n    \"  with capture.capture_output() as cap:\\n\",\n    \"    %cd /content\\n\",\n    \"    if not os.path.exists(str(WORKSPACE+'/Sessions')):\\n\",\n    \"      %mkdir -p $WORKSPACE'/Sessions'\\n\",\n    \"      time.sleep(1)\\n\",\n    \"    %cd $WORKSPACE'/Sessions'\\n\",\n    \"    !gdown --folder --remaining-ok -O $Session_Name  $Session_Link_optional\\n\",\n    \"    %cd $Session_Name\\n\",\n    \"    !rm -r instance_images\\n\",\n    \"    !unzip instance_images.zip\\n\",\n    \"    !rm -r captions\\n\",\n    \"    !unzip captions.zip\\n\",\n    \"    %cd /content\\n\",\n    \"\\n\",\n    \"\\n\",\n    \"INSTANCE_NAME=Session_Name\\n\",\n    \"OUTPUT_DIR=\\\"/content/models/\\\"+Session_Name\\n\",\n    \"SESSION_DIR=WORKSPACE+'/Sessions/'+Session_Name\\n\",\n    \"INSTANCE_DIR=SESSION_DIR+'/instance_images'\\n\",\n    \"CAPTIONS_DIR=SESSION_DIR+'/captions'\\n\",\n    \"MDLPTH=str(SESSION_DIR+\\\"/\\\"+Session_Name+'.ckpt')\\n\",\n    \"\\n\",\n    \"if os.path.exists(str(SESSION_DIR)):\\n\",\n    \"  mdls=[ckpt for ckpt in listdir(SESSION_DIR) if ckpt.split(\\\".\\\")[-1]==\\\"ckpt\\\"]\\n\",\n    \"  if not os.path.exists(MDLPTH) and '.ckpt' in str(mdls):  \\n\",\n    \"    \\n\",\n    \"    def f(n):\\n\",\n    \"      k=0\\n\",\n    \"      for i in mdls:\\n\",\n    \"        if k==n:\\n\",\n    \"          !mv \\\"$SESSION_DIR/$i\\\" $MDLPTH\\n\",\n    \"        k=k+1\\n\",\n    \"\\n\",\n    \"    k=0\\n\",\n    \"    print('\\u001b[1;33mNo final checkpoint model found, select which intermediary checkpoint to use, enter only the number, (000 to skip):\\\\n\\u001b[1;34m')\\n\",\n    \"\\n\",\n    \"    for i in mdls:\\n\",\n    \"      print(str(k)+'- '+i)\\n\",\n    \"      k=k+1\\n\",\n    \"    n=input()\\n\",\n    \"    while int(n)>k-1:\\n\",\n    \"      n=input()\\n\",\n    \"    if n!=\\\"000\\\":\\n\",\n    \"      f(int(n))\\n\",\n    \"      print('\\u001b[1;32mUsing the model '+ mdls[int(n)]+\\\" ...\\\")\\n\",\n    \"      time.sleep(2)\\n\",\n    \"    else:\\n\",\n    \"      print('\\u001b[1;32mSkipping the intermediary checkpoints.')\\n\",\n    \"    del n\\n\",\n    \"\\n\",\n    \"with capture.capture_output() as cap:\\n\",\n    \"  %cd /content\\n\",\n    \"  resume=False\\n\",\n    \"\\n\",\n    \"if os.path.exists(str(SESSION_DIR)) and not os.path.exists(MDLPTH):\\n\",\n    \"  print('\\u001b[1;32mLoading session with no previous model, using the original model or the custom downloaded model')\\n\",\n    \"  if MODEL_NAME==\\\"\\\":\\n\",\n    \"    print('\\u001b[1;31mNo model found, use the \\\"Model Download\\\" cell to download a model.')\\n\",\n    \"  else:\\n\",\n    \"    print('\\u001b[1;32mSession Loaded, proceed to uploading instance images')\\n\",\n    \"\\n\",\n    \"elif os.path.exists(MDLPTH):\\n\",\n    \"  print('\\u001b[1;32mSession found, loading the trained model ...')\\n\",\n    \"  wget.download('https://github.com/TheLastBen/fast-stable-diffusion/raw/main/Dreambooth/det.py')\\n\",\n    \"  print('\\u001b[1;33mDetecting model version...')\\n\",\n    \"  Model_Version=check_output('python det.py --MODEL_PATH '+MDLPTH, shell=True).decode('utf-8').replace('\\\\n', '')\\n\",\n    \"  clear_output()\\n\",\n    \"  print('\\u001b[1;32m'+Model_Version+' Detected') \\n\",\n    \"  !rm det.py  \\n\",\n    \"  if Model_Version=='1.5':\\n\",\n    \"    !wget -q -O config.yaml https://github.com/CompVis/stable-diffusion/raw/main/configs/stable-diffusion/v1-inference.yaml\\n\",\n    \"    print('\\u001b[1;32mSession found, loading the trained model ...')\\n\",\n    \"    !python /content/diffusers/scripts/convert_original_stable_diffusion_to_diffusers.py --checkpoint_path $MDLPTH --dump_path \\\"$OUTPUT_DIR\\\" --original_config_file config.yaml\\n\",\n    \"    !rm /content/config.yaml\\n\",\n    \"\\n\",\n    \"  elif Model_Version=='V2.1-512px':\\n\",\n    \"    !wget -q -O convertodiff.py https://raw.githubusercontent.com/TheLastBen/fast-stable-diffusion/main/Dreambooth/convertodiffv2.py\\n\",\n    \"    print('\\u001b[1;32mSession found, loading the trained model ...')\\n\",\n    \"    !python /content/convertodiff.py \\\"$MDLPTH\\\" \\\"$OUTPUT_DIR\\\" --v2 --reference_model stabilityai/stable-diffusion-2-1-base\\n\",\n    \"    !rm /content/convertodiff.py\\n\",\n    \"\\n\",\n    \"  elif Model_Version=='V2.1-768px':\\n\",\n    \"    !wget -q -O convertodiff.py https://github.com/TheLastBen/fast-stable-diffusion/raw/main/Dreambooth/convertodiffv2-768.py\\n\",\n    \"    print('\\u001b[1;32mSession found, loading the trained model ...')\\n\",\n    \"    !python /content/convertodiff.py \\\"$MDLPTH\\\" \\\"$OUTPUT_DIR\\\" --v2 --reference_model stabilityai/stable-diffusion-2-1\\n\",\n    \"    !rm /content/convertodiff.py\\n\",\n    \"  \\n\",\n    \"  \\n\",\n    \"  if os.path.exists(OUTPUT_DIR+'/unet/diffusion_pytorch_model.bin'):\\n\",\n    \"    resume=True\\n\",\n    \"    clear_output()\\n\",\n    \"    print('\\u001b[1;32mSession loaded.')\\n\",\n    \"  else:     \\n\",\n    \"    if not os.path.exists(OUTPUT_DIR+'/unet/diffusion_pytorch_model.bin'):\\n\",\n    \"      print('\\u001b[1;31mConversion error, if the error persists, remove the CKPT file from the current session folder')\\n\",\n    \"\\n\",\n    \"elif not os.path.exists(str(SESSION_DIR)):\\n\",\n    \"    %mkdir -p \\\"$INSTANCE_DIR\\\"\\n\",\n    \"    print('\\u001b[1;32mCreating session...')\\n\",\n    \"    if MODEL_NAME==\\\"\\\":\\n\",\n    \"      print('\\u001b[1;31mNo model found, use the \\\"Model Download\\\" cell to download a model.')\\n\",\n    \"    else:\\n\",\n    \"      print('\\u001b[1;32mSession created, proceed to uploading instance images')\\n\",\n    \"\\n\",\n    \"    #@markdown\\n\",\n    \"\\n\",\n    \"    #@markdown # The most important step is to rename the instance pictures of each subject to a unique unknown identifier, example :\\n\",\n    \"    #@markdown - If you have 10 pictures of yourself, simply select them all and rename only one to the chosen identifier for example : phtmejhn, the files would be : phtmejhn (1).jpg, phtmejhn (2).png ....etc then upload them, do the same for other people or objects with a different identifier, and that's it.\\n\",\n    \"    #@markdown - Checkout this example : https://i.imgur.com/d2lD3rz.jpeg\"\n   ]\n  },\n  {\n   \"cell_type\": \"code\",\n   \"execution_count\": null,\n   \"metadata\": {\n    \"cellView\": \"form\",\n    \"id\": \"LC4ukG60fgMy\"\n   },\n   \"outputs\": [],\n   \"source\": [\n    \"import shutil\\n\",\n    \"from google.colab import files\\n\",\n    \"import time\\n\",\n    \"from PIL import Image\\n\",\n    \"from tqdm import tqdm\\n\",\n    \"import ipywidgets as widgets\\n\",\n    \"from io import BytesIO\\n\",\n    \"import wget\\n\",\n    \"\\n\",\n    \"with capture.capture_output() as cap:\\n\",\n    \"  %cd /content\\n\",\n    \"  if not os.path.exists(\\\"/content/smart_crop.py\\\"):\\n\",\n    \"    wget.download('https://raw.githubusercontent.com/TheLastBen/fast-stable-diffusion/main/Dreambooth/smart_crop.py')\\n\",\n    \"  from smart_crop import *\\n\",\n    \"\\n\",\n    \"#@markdown #Instance Images\\n\",\n    \"#@markdown ----\\n\",\n    \"\\n\",\n    \"#@markdown\\n\",\n    \"#@markdown - Run the cell to upload the instance pictures.\\n\",\n    \"#@markdown - You can add `external captions` in txt files by simply giving each txt file the same name as the instance image, for example dikgur (1).jpg and dikgur (1).txt, and upload them here, to use the external captions, check the box \\\"external_captions\\\" in the training cell. `All the images must have one same extension` jpg or png or....etc\\n\",\n    \"\\n\",\n    \"Remove_existing_instance_images= True #@param{type: 'boolean'}\\n\",\n    \"#@markdown - Uncheck the box to keep the existing instance images.\\n\",\n    \"\\n\",\n    \"if Remove_existing_instance_images:\\n\",\n    \"  if os.path.exists(str(INSTANCE_DIR)):\\n\",\n    \"    !rm -r \\\"$INSTANCE_DIR\\\"\\n\",\n    \"  if os.path.exists(str(CAPTIONS_DIR)):\\n\",\n    \"    !rm -r \\\"$CAPTIONS_DIR\\\"\\n\",\n    \"\\n\",\n    \"if not os.path.exists(str(INSTANCE_DIR)):\\n\",\n    \"  %mkdir -p \\\"$INSTANCE_DIR\\\"\\n\",\n    \"if not os.path.exists(str(CAPTIONS_DIR)):\\n\",\n    \"  %mkdir -p \\\"$CAPTIONS_DIR\\\"\\n\",\n    \"\\n\",\n    \"if os.path.exists(INSTANCE_DIR+\\\"/.ipynb_checkpoints\\\"):\\n\",\n    \"  %rm -r $INSTANCE_DIR\\\"/.ipynb_checkpoints\\\"\\n\",\n    \"\\n\",\n    \"\\n\",\n    \"IMAGES_FOLDER_OPTIONAL=\\\"\\\" #@param{type: 'string'}\\n\",\n    \"\\n\",\n    \"#@markdown - If you prefer to specify directly the folder of the pictures instead of uploading, this will add the pictures to the existing (if any) instance images. Leave EMPTY to upload.\\n\",\n    \"\\n\",\n    \"Smart_Crop_images= True #@param{type: 'boolean'}\\n\",\n    \"Crop_size = 512 #@param [\\\"512\\\", \\\"576\\\", \\\"640\\\", \\\"704\\\", \\\"768\\\", \\\"832\\\", \\\"896\\\", \\\"960\\\", \\\"1024\\\"] {type:\\\"raw\\\"}\\n\",\n    \"\\n\",\n    \"#@markdown - Smart crop the images without manual intervention.\\n\",\n    \"\\n\",\n    \"while IMAGES_FOLDER_OPTIONAL !=\\\"\\\" and not os.path.exists(str(IMAGES_FOLDER_OPTIONAL)):\\n\",\n    \"  print('\\u001b[1;31mThe image folder specified does not exist, use the colab file explorer to copy the path :')\\n\",\n    \"  IMAGES_FOLDER_OPTIONAL=input('')\\n\",\n    \"\\n\",\n    \"if IMAGES_FOLDER_OPTIONAL!=\\\"\\\":\\n\",\n    \"  if os.path.exists(IMAGES_FOLDER_OPTIONAL+\\\"/.ipynb_checkpoints\\\"):\\n\",\n    \"    %rm -r \\\"$IMAGES_FOLDER_OPTIONAL\\\"\\\"/.ipynb_checkpoints\\\"\\n\",\n    \"\\n\",\n    \"  with capture.capture_output() as cap:\\n\",\n    \"    !mv $IMAGES_FOLDER_OPTIONAL/*.txt $CAPTIONS_DIR\\n\",\n    \"  if Smart_Crop_images:\\n\",\n    \"    for filename in tqdm(os.listdir(IMAGES_FOLDER_OPTIONAL), bar_format='  |{bar:15}| {n_fmt}/{total_fmt} Uploaded'):\\n\",\n    \"      extension = filename.split(\\\".\\\")[-1]\\n\",\n    \"      identifier=filename.split(\\\".\\\")[0]\\n\",\n    \"      new_path_with_file = os.path.join(INSTANCE_DIR, filename)\\n\",\n    \"      file = Image.open(IMAGES_FOLDER_OPTIONAL+\\\"/\\\"+filename)\\n\",\n    \"      width, height = file.size\\n\",\n    \"      if file.size !=(Crop_size, Crop_size):\\n\",\n    \"        image=crop_image(file, Crop_size)\\n\",\n    \"        if extension.upper()==\\\"JPG\\\" or extension.upper()==\\\"jpg\\\":\\n\",\n    \"            image[0] = image[0].convert(\\\"RGB\\\")\\n\",\n    \"            image[0].save(new_path_with_file, format=\\\"JPEG\\\", quality = 100)\\n\",\n    \"        else:\\n\",\n    \"            image[0].save(new_path_with_file, format=extension.upper())\\n\",\n    \"      else:\\n\",\n    \"        !cp \\\"$IMAGES_FOLDER_OPTIONAL/$filename\\\" \\\"$INSTANCE_DIR\\\"\\n\",\n    \"\\n\",\n    \"  else:\\n\",\n    \"    for filename in tqdm(os.listdir(IMAGES_FOLDER_OPTIONAL), bar_format='  |{bar:15}| {n_fmt}/{total_fmt} Uploaded'):\\n\",\n    \"      %cp -r \\\"$IMAGES_FOLDER_OPTIONAL/$filename\\\" \\\"$INSTANCE_DIR\\\"\\n\",\n    \"\\n\",\n    \"  print('\\\\n\\u001b[1;32mDone, proceed to the next cell')\\n\",\n    \"\\n\",\n    \"\\n\",\n    \"elif IMAGES_FOLDER_OPTIONAL ==\\\"\\\":\\n\",\n    \"  up=\\\"\\\"\\n\",\n    \"  uploaded = files.upload()\\n\",\n    \"  for filename in uploaded.keys():\\n\",\n    \"    if filename.split(\\\".\\\")[-1]==\\\"txt\\\":\\n\",\n    \"      shutil.move(filename, CAPTIONS_DIR)\\n\",\n    \"    up=[filename for filename in uploaded.keys() if filename.split(\\\".\\\")[-1]!=\\\"txt\\\"]\\n\",\n    \"  if Smart_Crop_images:\\n\",\n    \"    for filename in tqdm(up, bar_format='  |{bar:15}| {n_fmt}/{total_fmt} Uploaded'):\\n\",\n    \"      shutil.move(filename, INSTANCE_DIR)\\n\",\n    \"      extension = filename.split(\\\".\\\")[-1]\\n\",\n    \"      identifier=filename.split(\\\".\\\")[0]\\n\",\n    \"      new_path_with_file = os.path.join(INSTANCE_DIR, filename)\\n\",\n    \"      file = Image.open(new_path_with_file)\\n\",\n    \"      width, height = file.size\\n\",\n    \"      if file.size !=(Crop_size, Crop_size):\\n\",\n    \"        image=crop_image(file, Crop_size)\\n\",\n    \"        if extension.upper()==\\\"JPG\\\" or extension.upper()==\\\"jpg\\\":\\n\",\n    \"            image[0] = image[0].convert(\\\"RGB\\\")\\n\",\n    \"            image[0].save(new_path_with_file, format=\\\"JPEG\\\", quality = 100)\\n\",\n    \"        else:\\n\",\n    \"            image[0].save(new_path_with_file, format=extension.upper())\\n\",\n    \"      clear_output()\\n\",\n    \"  else:\\n\",\n    \"    for filename in tqdm(uploaded.keys(), bar_format='  |{bar:15}| {n_fmt}/{total_fmt} Uploaded'):\\n\",\n    \"      shutil.move(filename, INSTANCE_DIR)\\n\",\n    \"      clear_output()\\n\",\n    \"  print('\\\\n\\u001b[1;32mDone, proceed to the next cell')\\n\",\n    \"\\n\",\n    \"with capture.capture_output() as cap:\\n\",\n    \"  %cd \\\"$INSTANCE_DIR\\\"\\n\",\n    \"  !find . -name \\\"* *\\\" -type f | rename 's/ /-/g'\\n\",\n    \"  %cd \\\"$CAPTIONS_DIR\\\"\\n\",\n    \"  !find . -name \\\"* *\\\" -type f | rename 's/ /-/g'\\n\",\n    \"  \\n\",\n    \"  %cd $SESSION_DIR\\n\",\n    \"  !rm instance_images.zip captions.zip\\n\",\n    \"  !zip -r instance_images instance_images\\n\",\n    \"  !zip -r captions captions\\n\",\n    \"  %cd /content\"\n   ]\n  },\n  {\n   \"cell_type\": \"code\",\n   \"execution_count\": null,\n   \"metadata\": {\n    \"cellView\": \"form\",\n    \"id\": \"Baw78R-w4T2j\"\n   },\n   \"outputs\": [],\n   \"source\": [\n    \"import ipywidgets as widgets\\n\",\n    \"from io import BytesIO\\n\",\n    \"#@markdown #Captions (optional)\\n\",\n    \"\\n\",\n    \"#@markdown - Open a tool to manually `create` captions or edit existing captions of the instance images, do not use captions when training on a face.\\n\",\n    \"\\n\",\n    \"paths=\\\"\\\"\\n\",\n    \"out=\\\"\\\"\\n\",\n    \"widgets_l=\\\"\\\"\\n\",\n    \"clear_output()\\n\",\n    \"def Caption(path):\\n\",\n    \"    if path!=\\\"Select an instance image to caption\\\":\\n\",\n    \"      \\n\",\n    \"      name = os.path.splitext(os.path.basename(path))[0]\\n\",\n    \"      ext=os.path.splitext(os.path.basename(path))[-1][1:]\\n\",\n    \"      if ext==\\\"jpg\\\" or \\\"JPG\\\":\\n\",\n    \"        ext=\\\"JPEG\\\"      \\n\",\n    \"\\n\",\n    \"      if os.path.exists(CAPTIONS_DIR+\\\"/\\\"+name + '.txt'):\\n\",\n    \"        with open(CAPTIONS_DIR+\\\"/\\\"+name + '.txt', 'r') as f:\\n\",\n    \"            text = f.read()\\n\",\n    \"      else:\\n\",\n    \"        with open(CAPTIONS_DIR+\\\"/\\\"+name + '.txt', 'w') as f:\\n\",\n    \"            f.write(\\\"\\\")\\n\",\n    \"            with open(CAPTIONS_DIR+\\\"/\\\"+name + '.txt', 'r') as f:\\n\",\n    \"                text = f.read()   \\n\",\n    \"\\n\",\n    \"      img=Image.open(os.path.join(INSTANCE_DIR,path))\\n\",\n    \"      img=img.convert(\\\"RGB\\\")\\n\",\n    \"      img=img.resize((420, 420))\\n\",\n    \"      image_bytes = BytesIO()\\n\",\n    \"      img.save(image_bytes, format=ext, qualiy=10)\\n\",\n    \"      image_bytes.seek(0)\\n\",\n    \"      image_data = image_bytes.read()\\n\",\n    \"      img= image_data  \\n\",\n    \"      image = widgets.Image(\\n\",\n    \"          value=img,\\n\",\n    \"          width=420,\\n\",\n    \"          height=420\\n\",\n    \"      )\\n\",\n    \"      text_area = widgets.Textarea(value=text, description='', disabled=False, layout={'width': '300px', 'height': '120px'})\\n\",\n    \"      \\n\",\n    \"\\n\",\n    \"      def update_text(text):\\n\",\n    \"          with open(CAPTIONS_DIR+\\\"/\\\"+name + '.txt', 'w') as f:\\n\",\n    \"              f.write(text)\\n\",\n    \"\\n\",\n    \"      button = widgets.Button(description='Save', button_style='success')\\n\",\n    \"      button.on_click(lambda b: update_text(text_area.value))\\n\",\n    \"\\n\",\n    \"      return widgets.VBox([widgets.HBox([image, text_area, button])])\\n\",\n    \"\\n\",\n    \"\\n\",\n    \"paths = os.listdir(INSTANCE_DIR)\\n\",\n    \"widgets_l = widgets.Select(options=[\\\"Select an instance image to caption\\\"]+paths, rows=25)\\n\",\n    \"\\n\",\n    \"\\n\",\n    \"out = widgets.Output()\\n\",\n    \"\\n\",\n    \"def click(change):\\n\",\n    \"    with out:\\n\",\n    \"        out.clear_output()\\n\",\n    \"        display(Caption(change.new))\\n\",\n    \"\\n\",\n    \"widgets_l.observe(click, names='value')\\n\",\n    \"display(widgets.HBox([widgets_l, out]))\"\n   ]\n  },\n  {\n   \"cell_type\": \"markdown\",\n   \"metadata\": {\n    \"id\": \"ZnmQYfZilzY6\"\n   },\n   \"source\": [\n    \"# Training\"\n   ]\n  },\n  {\n   \"cell_type\": \"code\",\n   \"execution_count\": null,\n   \"metadata\": {\n    \"cellView\": \"form\",\n    \"id\": \"1-9QbkfAVYYU\"\n   },\n   \"outputs\": [],\n   \"source\": [\n    \"#@markdown ---\\n\",\n    \"#@markdown #Start DreamBooth\\n\",\n    \"#@markdown ---\\n\",\n    \"import os\\n\",\n    \"from IPython.display import clear_output\\n\",\n    \"from google.colab import runtime\\n\",\n    \"from subprocess import getoutput\\n\",\n    \"import time\\n\",\n    \"import random\\n\",\n    \"\\n\",\n    \"if os.path.exists(INSTANCE_DIR+\\\"/.ipynb_checkpoints\\\"):\\n\",\n    \"  %rm -r $INSTANCE_DIR\\\"/.ipynb_checkpoints\\\"\\n\",\n    \"\\n\",\n    \"if os.path.exists(CAPTIONS_DIR+\\\"/.ipynb_checkpoints\\\"):\\n\",\n    \"  %rm -r $CAPTIONS_DIR\\\"/.ipynb_checkpoints\\\"\\n\",\n    \"\\n\",\n    \"Resume_Training = False #@param {type:\\\"boolean\\\"}\\n\",\n    \"\\n\",\n    \"if resume and not Resume_Training:\\n\",\n    \"  print('\\u001b[1;31mOverwrite your previously trained model ? answering \\\"yes\\\" will train a new model, answering \\\"no\\\" will resume the training of the previous model?  yes or no ?\\u001b[0m')\\n\",\n    \"  while True:\\n\",\n    \"    ansres=input('')\\n\",\n    \"    if ansres=='no':\\n\",\n    \"      Resume_Training = True\\n\",\n    \"      break\\n\",\n    \"    elif ansres=='yes':\\n\",\n    \"      Resume_Training = False\\n\",\n    \"      resume= False\\n\",\n    \"      break\\n\",\n    \"\\n\",\n    \"while not Resume_Training and MODEL_NAME==\\\"\\\":\\n\",\n    \"  print('\\u001b[1;31mNo model found, use the \\\"Model Download\\\" cell to download a model.')\\n\",\n    \"  time.sleep(5)\\n\",\n    \"\\n\",\n    \"#@markdown  - If you're not satisfied with the result, check this box, run again the cell and it will continue training the current model.\\n\",\n    \"\\n\",\n    \"MODELT_NAME=MODEL_NAME\\n\",\n    \"\\n\",\n    \"UNet_Training_Steps=1500 #@param{type: 'number'}\\n\",\n    \"UNet_Learning_Rate = 2e-6 #@param [\\\"2e-5\\\",\\\"1e-5\\\",\\\"9e-6\\\",\\\"8e-6\\\",\\\"7e-6\\\",\\\"6e-6\\\",\\\"5e-6\\\", \\\"4e-6\\\", \\\"3e-6\\\", \\\"2e-6\\\"] {type:\\\"raw\\\"}\\n\",\n    \"untlr=UNet_Learning_Rate\\n\",\n    \"\\n\",\n    \"#@markdown - These default settings are for a dataset of 10 pictures which is enough for training a face, start with 1500 or lower, test the model, if not enough, resume training for 200 steps, keep testing until you get the desired output, `set it to 0 to train only the text_encoder`.\\n\",\n    \"\\n\",\n    \"Text_Encoder_Training_Steps=350 #@param{type: 'number'}\\n\",\n    \"\\n\",\n    \"#@markdown - 200-450 steps is enough for a small dataset, keep this number small to avoid overfitting, set to 0 to disable, `set it to 0 before resuming training if it is already trained`.\\n\",\n    \"\\n\",\n    \"Text_Encoder_Learning_Rate = 1e-6 #@param [\\\"2e-6\\\", \\\"1e-6\\\",\\\"8e-7\\\",\\\"6e-7\\\",\\\"5e-7\\\",\\\"4e-7\\\"] {type:\\\"raw\\\"}\\n\",\n    \"txlr=Text_Encoder_Learning_Rate\\n\",\n    \"\\n\",\n    \"#@markdown - Learning rate for the text_encoder, keep it low to avoid overfitting (1e-6 is higher than 4e-7)\\n\",\n    \"\\n\",\n    \"\\n\",\n    \"trnonltxt=\\\"\\\"\\n\",\n    \"if UNet_Training_Steps==0:\\n\",\n    \"   trnonltxt=\\\"--train_only_text_encoder\\\"\\n\",\n    \"\\n\",\n    \"Seed=''\\n\",\n    \"\\n\",\n    \"ofstnse=\\\"\\\"\\n\",\n    \"Offset_Noise = False #@param {type:\\\"boolean\\\"}\\n\",\n    \"#@markdown - Always use it for style training.\\n\",\n    \"\\n\",\n    \"if Offset_Noise:\\n\",\n    \"  ofstnse=\\\"--offset_noise\\\"\\n\",\n    \"\\n\",\n    \"External_Captions = False #@param {type:\\\"boolean\\\"}\\n\",\n    \"#@markdown - Get the captions from a text file for each instance image.\\n\",\n    \"extrnlcptn=\\\"\\\"\\n\",\n    \"if External_Captions:\\n\",\n    \"  extrnlcptn=\\\"--external_captions\\\"\\n\",\n    \"\\n\",\n    \"Resolution = \\\"512\\\" #@param [\\\"512\\\", \\\"576\\\", \\\"640\\\", \\\"704\\\", \\\"768\\\", \\\"832\\\", \\\"896\\\", \\\"960\\\", \\\"1024\\\"]\\n\",\n    \"Res=int(Resolution)\\n\",\n    \"\\n\",\n    \"#@markdown - Higher resolution = Higher quality, make sure the instance images are cropped to this selected size (or larger).\\n\",\n    \"\\n\",\n    \"fp16 = True\\n\",\n    \"\\n\",\n    \"if Seed =='' or Seed=='0':\\n\",\n    \"  Seed=random.randint(1, 999999)\\n\",\n    \"else:\\n\",\n    \"  Seed=int(Seed)\\n\",\n    \"\\n\",\n    \"if fp16:\\n\",\n    \"  prec=\\\"fp16\\\"\\n\",\n    \"else:\\n\",\n    \"  prec=\\\"no\\\"\\n\",\n    \"\\n\",\n    \"precision=prec\\n\",\n    \"\\n\",\n    \"resuming=\\\"\\\"\\n\",\n    \"if Resume_Training and os.path.exists(OUTPUT_DIR+'/unet/diffusion_pytorch_model.bin'):\\n\",\n    \"  MODELT_NAME=OUTPUT_DIR\\n\",\n    \"  print('\\u001b[1;32mResuming Training...\\u001b[0m')\\n\",\n    \"  resuming=\\\"Yes\\\"\\n\",\n    \"elif Resume_Training and not os.path.exists(OUTPUT_DIR+'/unet/diffusion_pytorch_model.bin'):\\n\",\n    \"  print('\\u001b[1;31mPrevious model not found, training a new model...\\u001b[0m')\\n\",\n    \"  MODELT_NAME=MODEL_NAME\\n\",\n    \"  while MODEL_NAME==\\\"\\\":\\n\",\n    \"    print('\\u001b[1;31mNo model found, use the \\\"Model Download\\\" cell to download a model.')\\n\",\n    \"    time.sleep(5)\\n\",\n    \"\\n\",\n    \"V2=False\\n\",\n    \"if os.path.getsize(MODELT_NAME+\\\"/text_encoder/pytorch_model.bin\\\") > 670901463:\\n\",\n    \"  V2=True\\n\",\n    \"\\n\",\n    \"s = getoutput('nvidia-smi')\\n\",\n    \"GCUNET=\\\"--gradient_checkpointing\\\"\\n\",\n    \"TexRes=Res\\n\",\n    \"if Res<=768:\\n\",\n    \"  GCUNET=\\\"\\\"\\n\",\n    \"\\n\",\n    \"if V2:  \\n\",\n    \"  if Res>704:\\n\",\n    \"    GCUNET=\\\"--gradient_checkpointing\\\"\\n\",\n    \"  if Res>576:\\n\",\n    \"    TexRes=576\\n\",\n    \"\\n\",\n    \"if 'A100' in s :\\n\",\n    \"   GCUNET=\\\"\\\"\\n\",\n    \"   TexRes=Res\\n\",\n    \"\\n\",\n    \"\\n\",\n    \"Enable_text_encoder_training= True\\n\",\n    \"\\n\",\n    \"if Text_Encoder_Training_Steps==0 :\\n\",\n    \"   Enable_text_encoder_training= False\\n\",\n    \"else:\\n\",\n    \"  stptxt=Text_Encoder_Training_Steps\\n\",\n    \"\\n\",\n    \"\\n\",\n    \"#@markdown ---------------------------\\n\",\n    \"Save_Checkpoint_Every_n_Steps = False #@param {type:\\\"boolean\\\"}\\n\",\n    \"Save_Checkpoint_Every=500 #@param{type: 'number'}\\n\",\n    \"if Save_Checkpoint_Every==None:\\n\",\n    \"  Save_Checkpoint_Every=1\\n\",\n    \"#@markdown - Minimum 200 steps between each save.\\n\",\n    \"stp=0\\n\",\n    \"Start_saving_from_the_step=500 #@param{type: 'number'}\\n\",\n    \"if Start_saving_from_the_step==None:\\n\",\n    \"  Start_saving_from_the_step=0\\n\",\n    \"if (Start_saving_from_the_step < 200):\\n\",\n    \"  Start_saving_from_the_step=Save_Checkpoint_Every\\n\",\n    \"stpsv=Start_saving_from_the_step\\n\",\n    \"if Save_Checkpoint_Every_n_Steps:\\n\",\n    \"  stp=Save_Checkpoint_Every\\n\",\n    \"#@markdown - Start saving intermediary checkpoints from this step.\\n\",\n    \"\\n\",\n    \"Disconnect_after_training=False #@param {type:\\\"boolean\\\"}\\n\",\n    \"\\n\",\n    \"#@markdown - Auto-disconnect from google colab after the training to avoid wasting compute units.\\n\",\n    \"\\n\",\n    \"def dump_only_textenc(trnonltxt, MODELT_NAME, INSTANCE_DIR, OUTPUT_DIR, PT, Seed, precision, Training_Steps):\\n\",\n    \"    \\n\",\n    \"    !accelerate launch /content/diffusers/examples/dreambooth/train_dreambooth.py \\\\\\n\",\n    \"    $trnonltxt \\\\\\n\",\n    \"    $extrnlcptn \\\\\\n\",\n    \"    $ofstnse \\\\\\n\",\n    \"    --image_captions_filename \\\\\\n\",\n    \"    --train_text_encoder \\\\\\n\",\n    \"    --dump_only_text_encoder \\\\\\n\",\n    \"    --pretrained_model_name_or_path=\\\"$MODELT_NAME\\\" \\\\\\n\",\n    \"    --instance_data_dir=\\\"$INSTANCE_DIR\\\" \\\\\\n\",\n    \"    --output_dir=\\\"$OUTPUT_DIR\\\" \\\\\\n\",\n    \"    --captions_dir=\\\"$CAPTIONS_DIR\\\" \\\\\\n\",\n    \"    --instance_prompt=\\\"$PT\\\" \\\\\\n\",\n    \"    --seed=$Seed \\\\\\n\",\n    \"    --resolution=$TexRes \\\\\\n\",\n    \"    --mixed_precision=$precision \\\\\\n\",\n    \"    --train_batch_size=1 \\\\\\n\",\n    \"    --gradient_accumulation_steps=1 --gradient_checkpointing \\\\\\n\",\n    \"    --use_8bit_adam \\\\\\n\",\n    \"    --learning_rate=$txlr \\\\\\n\",\n    \"    --lr_scheduler=\\\"linear\\\" \\\\\\n\",\n    \"    --lr_warmup_steps=0 \\\\\\n\",\n    \"    --max_train_steps=$Training_Steps\\n\",\n    \"\\n\",\n    \"def train_only_unet(stpsv, stp, SESSION_DIR, MODELT_NAME, INSTANCE_DIR, OUTPUT_DIR, PT, Seed, Res, precision, Training_Steps):\\n\",\n    \"    clear_output()\\n\",\n    \"    if resuming==\\\"Yes\\\":\\n\",\n    \"      print('\\u001b[1;32mResuming Training...\\u001b[0m')\\n\",\n    \"    print('\\u001b[1;33mTraining the UNet...\\u001b[0m')\\n\",\n    \"    !accelerate launch /content/diffusers/examples/dreambooth/train_dreambooth.py \\\\\\n\",\n    \"    $extrnlcptn \\\\\\n\",\n    \"    $ofstnse \\\\\\n\",\n    \"    --image_captions_filename \\\\\\n\",\n    \"    --train_only_unet \\\\\\n\",\n    \"    --save_starting_step=$stpsv \\\\\\n\",\n    \"    --save_n_steps=$stp \\\\\\n\",\n    \"    --Session_dir=$SESSION_DIR \\\\\\n\",\n    \"    --pretrained_model_name_or_path=\\\"$MODELT_NAME\\\" \\\\\\n\",\n    \"    --instance_data_dir=\\\"$INSTANCE_DIR\\\" \\\\\\n\",\n    \"    --output_dir=\\\"$OUTPUT_DIR\\\" \\\\\\n\",\n    \"    --captions_dir=\\\"$CAPTIONS_DIR\\\" \\\\\\n\",\n    \"    --instance_prompt=\\\"$PT\\\" \\\\\\n\",\n    \"    --seed=$Seed \\\\\\n\",\n    \"    --resolution=$Res \\\\\\n\",\n    \"    --mixed_precision=$precision \\\\\\n\",\n    \"    --train_batch_size=1 \\\\\\n\",\n    \"    --gradient_accumulation_steps=1 $GCUNET \\\\\\n\",\n    \"    --use_8bit_adam \\\\\\n\",\n    \"    --learning_rate=$untlr \\\\\\n\",\n    \"    --lr_scheduler=\\\"linear\\\" \\\\\\n\",\n    \"    --lr_warmup_steps=0 \\\\\\n\",\n    \"    --max_train_steps=$Training_Steps\\n\",\n    \"\\n\",\n    \"\\n\",\n    \"if Enable_text_encoder_training :\\n\",\n    \"  print('\\u001b[1;33mTraining the text encoder...\\u001b[0m')\\n\",\n    \"  if os.path.exists(OUTPUT_DIR+'/'+'text_encoder_trained'):\\n\",\n    \"    %rm -r $OUTPUT_DIR\\\"/text_encoder_trained\\\"\\n\",\n    \"  dump_only_textenc(trnonltxt, MODELT_NAME, INSTANCE_DIR, OUTPUT_DIR, PT, Seed, precision, Training_Steps=stptxt)\\n\",\n    \"\\n\",\n    \"\\n\",\n    \"if UNet_Training_Steps!=0:\\n\",\n    \"  train_only_unet(stpsv, stp, SESSION_DIR, MODELT_NAME, INSTANCE_DIR, OUTPUT_DIR, PT, Seed, Res, precision, Training_Steps=UNet_Training_Steps)\\n\",\n    \"\\n\",\n    \"if UNet_Training_Steps==0 and Text_Encoder_Training_Steps==0 :\\n\",\n    \"  print('\\u001b[1;32mNothing to do')\\n\",\n    \"else:\\n\",\n    \"  if os.path.exists('/content/models/'+INSTANCE_NAME+'/unet/diffusion_pytorch_model.bin'):\\n\",\n    \"    prc=\\\"--fp16\\\" if precision==\\\"fp16\\\" else \\\"\\\"\\n\",\n    \"    !python /content/diffusers/scripts/convertosdv2.py $prc $OUTPUT_DIR $SESSION_DIR/$Session_Name\\\".ckpt\\\"\\n\",\n    \"    clear_output()\\n\",\n    \"    if os.path.exists(SESSION_DIR+\\\"/\\\"+INSTANCE_NAME+'.ckpt'):\\n\",\n    \"      clear_output()\\n\",\n    \"      print(\\\"\\u001b[1;32mDONE, the CKPT model is in your Gdrive in the sessions folder\\\")\\n\",\n    \"      if Disconnect_after_training :\\n\",\n    \"        time.sleep(20)\\n\",\n    \"        runtime.unassign()\\n\",\n    \"    else:\\n\",\n    \"      print(\\\"\\u001b[1;31mSomething went wrong\\\")\\n\",\n    \"  else:\\n\",\n    \"    print(\\\"\\u001b[1;31mSomething went wrong\\\")\"\n   ]\n  },\n  {\n   \"cell_type\": \"markdown\",\n   \"metadata\": {\n    \"id\": \"ehi1KKs-l-ZS\"\n   },\n   \"source\": [\n    \"# Test The Trained Model\"\n   ]\n  },\n  {\n   \"cell_type\": \"code\",\n   \"execution_count\": null,\n   \"metadata\": {\n    \"cellView\": \"form\",\n    \"id\": \"iAZGngFcI8hq\"\n   },\n   \"outputs\": [],\n   \"source\": [\n    \"import os\\n\",\n    \"import time\\n\",\n    \"import sys\\n\",\n    \"import fileinput\\n\",\n    \"from IPython.display import clear_output\\n\",\n    \"from subprocess import getoutput\\n\",\n    \"from IPython.utils import capture\\n\",\n    \"from pyngrok import ngrok, conf\\n\",\n    \"import base64\\n\",\n    \"\\n\",\n    \"blasphemy=base64.b64decode((\\\"d2VidWk=\\\")).decode('ascii')\\n\",\n    \"\\n\",\n    \"Previous_Session=\\\"\\\" #@param{type: 'string'}\\n\",\n    \"\\n\",\n    \"#@markdown - Leave empty if you want to use the current trained model.\\n\",\n    \"\\n\",\n    \"Use_Custom_Path = False #@param {type:\\\"boolean\\\"}\\n\",\n    \"\\n\",\n    \"try:\\n\",\n    \"  INSTANCE_NAME\\n\",\n    \"  INSTANCET=INSTANCE_NAME\\n\",\n    \"except:\\n\",\n    \"  pass\\n\",\n    \"#@markdown - if checked, an input box will ask the full path to a desired model.\\n\",\n    \"\\n\",\n    \"if Previous_Session!=\\\"\\\":\\n\",\n    \"  INSTANCET=Previous_Session\\n\",\n    \"  INSTANCET=INSTANCET.replace(\\\" \\\",\\\"_\\\")\\n\",\n    \"\\n\",\n    \"if Use_Custom_Path:\\n\",\n    \"  try:\\n\",\n    \"    INSTANCET\\n\",\n    \"    del INSTANCET\\n\",\n    \"  except:\\n\",\n    \"    pass\\n\",\n    \"\\n\",\n    \"try:\\n\",\n    \"  INSTANCET\\n\",\n    \"  if Previous_Session!=\\\"\\\":\\n\",\n    \"    path_to_trained_model='/content/gdrive/MyDrive/Fast-Dreambooth/Sessions/'+Previous_Session+\\\"/\\\"+Previous_Session+'.ckpt'\\n\",\n    \"  else:\\n\",\n    \"    path_to_trained_model=SESSION_DIR+\\\"/\\\"+INSTANCET+'.ckpt'\\n\",\n    \"except:\\n\",\n    \"  print('\\u001b[1;31mIt seems that you did not perform training during this session \\u001b[1;32mor you chose to use a custom path,\\\\nprovide the full path to the model (including the name of the model):\\\\n')\\n\",\n    \"  path_to_trained_model=input()\\n\",\n    \"     \\n\",\n    \"while not os.path.exists(path_to_trained_model):\\n\",\n    \"   print(\\\"\\u001b[1;31mThe model doesn't exist on you Gdrive, use the file explorer to get the path : \\\")\\n\",\n    \"   path_to_trained_model=input()\\n\",\n    \"   \\n\",\n    \"fgitclone = \\\"git clone --depth 1\\\"\\n\",\n    \"\\n\",\n    \"with capture.capture_output() as cap:\\n\",\n    \"    if not os.path.exists('/content/gdrive/MyDrive'):\\n\",\n    \"      !mkdir -p /content/gdrive/MyDrive\\n\",\n    \"\\n\",\n    \"if not os.path.exists('/content/gdrive/MyDrive/sd/stablediffusion'):\\n\",\n    \"    !wget -q -O /content/sd_rep.tar.zst https://huggingface.co/TheLastBen/dependencies/resolve/main/sd_rep.tar.zst\\n\",\n    \"    !tar -C  /content/gdrive/MyDrive --zstd -xf /content/sd_rep.tar.zst\\n\",\n    \"    !rm /content/sd_rep.tar.zst\\n\",\n    \"    clear_output()\\n\",\n    \"\\n\",\n    \"with capture.capture_output() as cap:\\n\",\n    \"  %cd /content/gdrive/MyDrive/sd\\n\",\n    \"  !git clone -q --branch master https://github.com/AUTOMATIC1111/stable-diffusion-$blasphemy\\n\",\n    \"  %cd stable-diffusion-$blasphemy\\n\",\n    \"  !mkdir cache\\n\",\n    \"  !sed -i 's@~/.cache@/content/gdrive/MyDrive/sd/stable-diffusion-{blasphemy}/cache@' /usr/local/lib/python3.10/dist-packages/transformers/utils/hub.py\\n\",\n    \"\\n\",\n    \"  clear_output()\\n\",\n    \"  !git reset --hard\\n\",\n    \"  time.sleep(1)\\n\",\n    \"  !rm webui.sh\\n\",\n    \"  !git pull\\n\",\n    \"  !git fetch --unshallow\\n\",\n    \"  !git checkout a9eab236d7e8afa4d6205127904a385b2c43bb24\\n\",\n    \"  \\n\",\n    \"with capture.capture_output() as cap:\\n\",\n    \"  if not os.path.exists('/tools/node/bin/lt'):\\n\",\n    \"    !npm install -g localtunnel\\n\",\n    \"\\n\",\n    \"Ngrok_token = \\\"\\\" #@param {type:\\\"string\\\"}\\n\",\n    \"\\n\",\n    \"#@markdown - Input your ngrok token if you want to use ngrok server.\\n\",\n    \"\\n\",\n    \"Use_localtunnel = False #@param {type:\\\"boolean\\\"}\\n\",\n    \"\\n\",\n    \"User = \\\"\\\" #@param {type:\\\"string\\\"}\\n\",\n    \"Password= \\\"\\\" #@param {type:\\\"string\\\"}\\n\",\n    \"#@markdown - Add credentials to your Gradio interface (optional).\\n\",\n    \"\\n\",\n    \"auth=f\\\"--gradio-auth {User}:{Password}\\\"\\n\",\n    \"if User ==\\\"\\\" or Password==\\\"\\\":\\n\",\n    \"  auth=\\\"\\\"\\n\",\n    \"\\n\",\n    \"with capture.capture_output() as cap:\\n\",\n    \"  %cd modules\\n\",\n    \"  !wget -q -O paths.py https://github.com/TheLastBen/fast-stable-diffusion/raw/5632d2ef7fffd940976538d270854ec4faf26855/AUTOMATIC1111_files/paths.py\\n\",\n    \"  !wget -q -O extras.py https://github.com/AUTOMATIC1111/stable-diffusion-$blasphemy/raw/a9eab236d7e8afa4d6205127904a385b2c43bb24/modules/extras.py\\n\",\n    \"  !wget -q -O sd_models.py https://github.com/AUTOMATIC1111/stable-diffusion-$blasphemy/raw/a9eab236d7e8afa4d6205127904a385b2c43bb24/modules/sd_models.py\\n\",\n    \"  !wget -q -O /usr/local/lib/python3.10/dist-packages/gradio/blocks.py https://github.com/TheLastBen/fast-stable-diffusion/raw/7ff88eaa1fb4997bacd9845bd487f9a14335d625/AUTOMATIC1111_files/blocks.py\\n\",\n    \"  %cd /content/gdrive/MyDrive/sd/stable-diffusion-$blasphemy/\\n\",\n    \"\\n\",\n    \"  !sed -i \\\"s@os.path.splitext(checkpoint_file)@os.path.splitext(checkpoint_file); map_location='cuda'@\\\" /content/gdrive/MyDrive/sd/stable-diffusion-$blasphemy/modules/sd_models.py\\n\",\n    \"  !sed -i 's@ui.create_ui().*@ui.create_ui();shared.demo.queue(concurrency_count=999999,status_update_rate=0.1)@' /content/gdrive/MyDrive/sd/stable-diffusion-$blasphemy/webui.py\\n\",\n    \"  !sed -i \\\"s@map_location='cpu'@map_location='cuda'@\\\" /content/gdrive/MyDrive/sd/stable-diffusion-$blasphemy/modules/extras.py\\n\",\n    \"  !sed -i 's@print(\\\\\\\"No module.*@@' /content/gdrive/MyDrive/sd/stablediffusion/ldm/modules/diffusionmodules/model.py\\n\",\n    \"  !sed -i 's@\\\\\\\"quicksettings\\\\\\\": OptionInfo(.*@\\\"quicksettings\\\": OptionInfo(\\\"sd_model_checkpoint,  sd_vae, CLIP_stop_at_last_layers, inpainting_mask_weight, initial_noise_multiplier\\\", \\\"Quicksettings list\\\"),@' /content/gdrive/MyDrive/sd/stable-diffusion-$blasphemy/modules/shared.py\\n\",\n    \"\\n\",\n    \"share=''\\n\",\n    \"if Ngrok_token!=\\\"\\\":\\n\",\n    \"  ngrok.kill()\\n\",\n    \"  srv=ngrok.connect(7860, pyngrok_config=conf.PyngrokConfig(auth_token=Ngrok_token) , bind_tls=True).public_url\\n\",\n    \"\\n\",\n    \"  for line in fileinput.input('/usr/local/lib/python3.10/dist-packages/gradio/blocks.py', inplace=True):\\n\",\n    \"    if line.strip().startswith('self.server_name ='):\\n\",\n    \"        line = f'            self.server_name = \\\"{srv[8:]}\\\"\\\\n'\\n\",\n    \"    if line.strip().startswith('self.protocol = \\\"https\\\"'):\\n\",\n    \"        line = '            self.protocol = \\\"https\\\"\\\\n'\\n\",\n    \"    if line.strip().startswith('if self.local_url.startswith(\\\"https\\\") or self.is_colab'):\\n\",\n    \"        line = ''\\n\",\n    \"    if line.strip().startswith('else \\\"http\\\"'):\\n\",\n    \"        line = ''\\n\",\n    \"    sys.stdout.write(line)\\n\",\n    \"\\n\",\n    \"elif Use_localtunnel:\\n\",\n    \"  with capture.capture_output() as cap:\\n\",\n    \"    share=''\\n\",\n    \"    %cd /content\\n\",\n    \"    !nohup lt --port 7860 > srv.txt 2>&1 &\\n\",\n    \"    time.sleep(2)\\n\",\n    \"    !grep -o 'https[^ ]*' /content/srv.txt >srvr.txt\\n\",\n    \"    time.sleep(2)\\n\",\n    \"    srv= getoutput('cat /content/srvr.txt')\\n\",\n    \"\\n\",\n    \"    for line in fileinput.input('/usr/local/lib/python3.10/dist-packages/gradio/blocks.py', inplace=True):\\n\",\n    \"      if line.strip().startswith('self.server_name ='):\\n\",\n    \"          line = f'            self.server_name = \\\"{srv[8:]}\\\"\\\\n'\\n\",\n    \"      if line.strip().startswith('self.protocol = \\\"https\\\"'):\\n\",\n    \"          line = '            self.protocol = \\\"https\\\"\\\\n'\\n\",\n    \"      if line.strip().startswith('if self.local_url.startswith(\\\"https\\\") or self.is_colab'):\\n\",\n    \"          line = ''\\n\",\n    \"      if line.strip().startswith('else \\\"http\\\"'):\\n\",\n    \"          line = ''\\n\",\n    \"      sys.stdout.write(line)\\n\",\n    \"            \\n\",\n    \"    !rm /content/srv.txt /content/srvr.txt\\n\",\n    \"    %cd /content/gdrive/MyDrive/sd/stable-diffusion-$blasphemy\\n\",\n    \"\\n\",\n    \"else:\\n\",\n    \"  share='--share'\\n\",\n    \"\\n\",\n    \"configf=\\\"--api --disable-safe-unpickle --enable-insecure-extension-access --no-half-vae --opt-sdp-attention --no-download-sd-model --disable-console-progressbars\\\"\\n\",\n    \"\\n\",\n    \"clear_output()\\n\",\n    \"\\n\",\n    \"if os.path.isfile(path_to_trained_model):\\n\",\n    \"  !python /content/gdrive/MyDrive/sd/stable-diffusion-$blasphemy/webui.py $share --ckpt \\\"$path_to_trained_model\\\" $auth $configf\\n\",\n    \"else:\\n\",\n    \"  !python /content/gdrive/MyDrive/sd/stable-diffusion-$blasphemy/webui.py $share --ckpt-dir \\\"$path_to_trained_model\\\" $auth $configf\"\n   ]\n  },\n  {\n   \"cell_type\": \"markdown\",\n   \"metadata\": {\n    \"id\": \"d_mQ23XsOc5R\"\n   },\n   \"source\": [\n    \"# Upload The Trained Model to Hugging Face \"\n   ]\n  },\n  {\n   \"cell_type\": \"code\",\n   \"execution_count\": null,\n   \"metadata\": {\n    \"cellView\": \"form\",\n    \"id\": \"NTqUIuhROdH4\"\n   },\n   \"outputs\": [],\n   \"source\": [\n    \"from slugify import slugify\\n\",\n    \"from huggingface_hub import HfApi, HfFolder, CommitOperationAdd\\n\",\n    \"from huggingface_hub import create_repo\\n\",\n    \"from IPython.display import display_markdown\\n\",\n    \"from IPython.display import clear_output\\n\",\n    \"from IPython.utils import capture\\n\",\n    \"from google.colab import files\\n\",\n    \"import shutil\\n\",\n    \"import time\\n\",\n    \"import os\\n\",\n    \"\\n\",\n    \"Upload_sample_images = False #@param {type:\\\"boolean\\\"}\\n\",\n    \"#@markdown - Upload showcase images of your trained model\\n\",\n    \"\\n\",\n    \"Name_of_your_concept = \\\"\\\" #@param {type:\\\"string\\\"}\\n\",\n    \"if(Name_of_your_concept == \\\"\\\"):\\n\",\n    \"  Name_of_your_concept = Session_Name\\n\",\n    \"Name_of_your_concept=Name_of_your_concept.replace(\\\" \\\",\\\"-\\\")  \\n\",\n    \"  \\n\",\n    \"#@markdown - [Create a write access token](https://huggingface.co/settings/tokens) , go to \\\"New token\\\" -> Role : Write. A regular read token won't work here.\\n\",\n    \"hf_token_write = \\\"\\\" #@param {type:\\\"string\\\"}\\n\",\n    \"if hf_token_write ==\\\"\\\":\\n\",\n    \"  print('\\u001b[1;32mYour Hugging Face write access token : ')\\n\",\n    \"  hf_token_write=input()\\n\",\n    \"\\n\",\n    \"hf_token = hf_token_write\\n\",\n    \"\\n\",\n    \"api = HfApi()\\n\",\n    \"your_username = api.whoami(token=hf_token)[\\\"name\\\"]\\n\",\n    \"\\n\",\n    \"repo_id = f\\\"{your_username}/{slugify(Name_of_your_concept)}\\\"\\n\",\n    \"output_dir = f'/content/models/'+INSTANCE_NAME\\n\",\n    \"\\n\",\n    \"def bar(prg):\\n\",\n    \"    br=\\\"\\u001b[1;33mUploading to HuggingFace : \\\" '\\u001b[0m|'+'█' * prg + ' ' * (25-prg)+'| ' +str(prg*4)+ \\\"%\\\"\\n\",\n    \"    return br\\n\",\n    \"\\n\",\n    \"print(\\\"\\u001b[1;32mLoading...\\\")\\n\",\n    \"\\n\",\n    \"NM=\\\"False\\\"\\n\",\n    \"if os.path.getsize(OUTPUT_DIR+\\\"/text_encoder/pytorch_model.bin\\\") > 670901463:\\n\",\n    \"  NM=\\\"True\\\"\\n\",\n    \"\\n\",\n    \"with capture.capture_output() as cap:\\n\",\n    \"  if NM==\\\"False\\\":\\n\",\n    \"    %cd $OUTPUT_DIR\\n\",\n    \"    !rm -r safety_checker feature_extractor .git\\n\",\n    \"    !rm model_index.json\\n\",\n    \"    !git init\\n\",\n    \"    !git lfs install --system --skip-repo\\n\",\n    \"    !git remote add -f origin  \\\"https://USER:{hf_token}@huggingface.co/runwayml/stable-diffusion-v1-5\\\"\\n\",\n    \"    !git config core.sparsecheckout true\\n\",\n    \"    !echo -e \\\"feature_extractor\\\\nsafety_checker\\\\nmodel_index.json\\\" > .git/info/sparse-checkout\\n\",\n    \"    !git pull origin main\\n\",\n    \"    !rm -r .git\\n\",\n    \"    %cd /content\\n\",\n    \"  else:\\n\",\n    \"    %cd $OUTPUT_DIR\\n\",\n    \"    !rm -r feature_extractor .git\\n\",\n    \"    !git init\\n\",\n    \"    !git lfs install --system --skip-repo\\n\",\n    \"    !git remote add -f origin  \\\"https://USER:{hf_token}@huggingface.co/stabilityai/stable-diffusion-2-1\\\"\\n\",\n    \"    !git config core.sparsecheckout true\\n\",\n    \"    !echo -e \\\"feature_extractor\\\" > .git/info/sparse-checkout\\n\",\n    \"    !git pull origin main\\n\",\n    \"    !rm -r .git\\n\",\n    \"    %cd /content\\n\",\n    \"\\n\",\n    \"\\n\",\n    \"image_string = \\\"\\\"\\n\",\n    \"\\n\",\n    \"if os.path.exists('/content/sample_images'):\\n\",\n    \"  !rm -r /content/sample_images\\n\",\n    \"Samples=\\\"/content/sample_images\\\"\\n\",\n    \"!mkdir $Samples\\n\",\n    \"clear_output()\\n\",\n    \"\\n\",\n    \"if Upload_sample_images:\\n\",\n    \"\\n\",\n    \"  print(\\\"\\u001b[1;32mUpload Sample images of the model\\\")\\n\",\n    \"  uploaded = files.upload()\\n\",\n    \"  for filename in uploaded.keys():\\n\",\n    \"    shutil.move(filename, Samples)\\n\",\n    \"  %cd $Samples\\n\",\n    \"  !find . -name \\\"* *\\\" -type f | rename 's/ /_/g'\\n\",\n    \"  %cd /content\\n\",\n    \"  clear_output()\\n\",\n    \"\\n\",\n    \"  print(bar(1))\\n\",\n    \"\\n\",\n    \"  images_upload = os.listdir(Samples)\\n\",\n    \"  instance_prompt_list = []\\n\",\n    \"  for i, image in enumerate(images_upload):\\n\",\n    \"      image_string = f'''\\n\",\n    \"  {image_string}![{i}](https://huggingface.co/{repo_id}/resolve/main/sample_images/{image})\\n\",\n    \"      '''\\n\",\n    \"    \\n\",\n    \"readme_text = f'''---\\n\",\n    \"license: creativeml-openrail-m\\n\",\n    \"tags:\\n\",\n    \"- text-to-image\\n\",\n    \"- stable-diffusion\\n\",\n    \"---\\n\",\n    \"### {Name_of_your_concept} Dreambooth model trained by {api.whoami(token=hf_token)[\\\"name\\\"]} with [TheLastBen's fast-DreamBooth](https://colab.research.google.com/github/TheLastBen/fast-stable-diffusion/blob/main/fast-DreamBooth.ipynb) notebook\\n\",\n    \"\\n\",\n    \"\\n\",\n    \"Test the concept via A1111 Colab [fast-Colab-A1111](https://colab.research.google.com/github/TheLastBen/fast-stable-diffusion/blob/main/fast_stable_diffusion_AUTOMATIC1111.ipynb)\\n\",\n    \"\\n\",\n    \"Sample pictures of this concept:\\n\",\n    \"{image_string}\\n\",\n    \"'''\\n\",\n    \"#Save the readme to a file\\n\",\n    \"readme_file = open(\\\"README.md\\\", \\\"w\\\")\\n\",\n    \"readme_file.write(readme_text)\\n\",\n    \"readme_file.close()\\n\",\n    \"\\n\",\n    \"operations = [\\n\",\n    \"  CommitOperationAdd(path_in_repo=\\\"README.md\\\", path_or_fileobj=\\\"README.md\\\"),\\n\",\n    \"  CommitOperationAdd(path_in_repo=f\\\"{Session_Name}.ckpt\\\",path_or_fileobj=MDLPTH)\\n\",\n    \"\\n\",\n    \"]\\n\",\n    \"create_repo(repo_id,private=True, token=hf_token)\\n\",\n    \"\\n\",\n    \"api.create_commit(\\n\",\n    \"  repo_id=repo_id,\\n\",\n    \"  operations=operations,\\n\",\n    \"  commit_message=f\\\"Upload the concept {Name_of_your_concept} embeds and token\\\",\\n\",\n    \"  token=hf_token\\n\",\n    \")\\n\",\n    \"\\n\",\n    \"api.upload_folder(\\n\",\n    \"  folder_path=OUTPUT_DIR+\\\"/feature_extractor\\\",\\n\",\n    \"  path_in_repo=\\\"feature_extractor\\\",\\n\",\n    \"  repo_id=repo_id,\\n\",\n    \"  token=hf_token\\n\",\n    \")\\n\",\n    \"\\n\",\n    \"clear_output()\\n\",\n    \"print(bar(4))\\n\",\n    \"\\n\",\n    \"if NM==\\\"False\\\":\\n\",\n    \"  api.upload_folder(\\n\",\n    \"    folder_path=OUTPUT_DIR+\\\"/safety_checker\\\",\\n\",\n    \"    path_in_repo=\\\"safety_checker\\\",\\n\",\n    \"    repo_id=repo_id,\\n\",\n    \"    token=hf_token\\n\",\n    \"  )\\n\",\n    \"\\n\",\n    \"clear_output()\\n\",\n    \"print(bar(8))\\n\",\n    \"\\n\",\n    \"\\n\",\n    \"api.upload_folder(\\n\",\n    \"  folder_path=OUTPUT_DIR+\\\"/scheduler\\\",\\n\",\n    \"  path_in_repo=\\\"scheduler\\\",\\n\",\n    \"  repo_id=repo_id,\\n\",\n    \"  token=hf_token\\n\",\n    \")\\n\",\n    \"\\n\",\n    \"clear_output()\\n\",\n    \"print(bar(9))\\n\",\n    \"\\n\",\n    \"api.upload_folder(\\n\",\n    \"  folder_path=OUTPUT_DIR+\\\"/text_encoder\\\",\\n\",\n    \"  path_in_repo=\\\"text_encoder\\\",\\n\",\n    \"  repo_id=repo_id,\\n\",\n    \"  token=hf_token\\n\",\n    \")\\n\",\n    \"\\n\",\n    \"clear_output()\\n\",\n    \"print(bar(12))\\n\",\n    \"\\n\",\n    \"api.upload_folder(\\n\",\n    \"  folder_path=OUTPUT_DIR+\\\"/tokenizer\\\",\\n\",\n    \"  path_in_repo=\\\"tokenizer\\\",\\n\",\n    \"  repo_id=repo_id,\\n\",\n    \"  token=hf_token\\n\",\n    \")\\n\",\n    \"\\n\",\n    \"clear_output()\\n\",\n    \"print(bar(13))\\n\",\n    \"\\n\",\n    \"api.upload_folder(\\n\",\n    \"  folder_path=OUTPUT_DIR+\\\"/unet\\\",\\n\",\n    \"  path_in_repo=\\\"unet\\\",\\n\",\n    \"  repo_id=repo_id,\\n\",\n    \"  token=hf_token\\n\",\n    \")\\n\",\n    \"\\n\",\n    \"clear_output()\\n\",\n    \"print(bar(21))\\n\",\n    \"\\n\",\n    \"api.upload_folder(\\n\",\n    \"  folder_path=OUTPUT_DIR+\\\"/vae\\\",\\n\",\n    \"  path_in_repo=\\\"vae\\\",\\n\",\n    \"  repo_id=repo_id,\\n\",\n    \"  token=hf_token\\n\",\n    \")\\n\",\n    \"\\n\",\n    \"clear_output()\\n\",\n    \"print(bar(23))\\n\",\n    \"\\n\",\n    \"api.upload_file(\\n\",\n    \"  path_or_fileobj=OUTPUT_DIR+\\\"/model_index.json\\\",\\n\",\n    \"  path_in_repo=\\\"model_index.json\\\",\\n\",\n    \"  repo_id=repo_id,\\n\",\n    \"  token=hf_token\\n\",\n    \")\\n\",\n    \"\\n\",\n    \"clear_output()\\n\",\n    \"print(bar(24))\\n\",\n    \"\\n\",\n    \"api.upload_folder(\\n\",\n    \"  folder_path=Samples,\\n\",\n    \"  path_in_repo=\\\"sample_images\\\",\\n\",\n    \"  repo_id=repo_id,\\n\",\n    \"  token=hf_token\\n\",\n    \")\\n\",\n    \"\\n\",\n    \"clear_output()\\n\",\n    \"print(bar(25))\\n\",\n    \"\\n\",\n    \"display_markdown(f'''## Your concept was saved successfully. [Click here to access it](https://huggingface.co/{repo_id})\\n\",\n    \"''', raw=True)\"\n   ]\n  },\n  {\n   \"cell_type\": \"code\",\n   \"execution_count\": null,\n   \"metadata\": {\n    \"cellView\": \"form\",\n    \"id\": \"iVqNi8IDzA1Z\"\n   },\n   \"outputs\": [],\n   \"source\": [\n    \"#@markdown #Free Gdrive Space\\n\",\n    \"\\n\",\n    \"#@markdown Display the list of sessions from your gdrive and choose which ones to remove.\\n\",\n    \"\\n\",\n    \"import ipywidgets as widgets\\n\",\n    \"\\n\",\n    \"Sessions=os.listdir(\\\"/content/gdrive/MyDrive/Fast-Dreambooth/Sessions\\\")\\n\",\n    \"\\n\",\n    \"s = widgets.Select(\\n\",\n    \"    options=Sessions,\\n\",\n    \"    rows=5,\\n\",\n    \"    description='',\\n\",\n    \"    disabled=False\\n\",\n    \")\\n\",\n    \"\\n\",\n    \"out=widgets.Output()\\n\",\n    \"\\n\",\n    \"d = widgets.Button(\\n\",\n    \"    description='Remove',\\n\",\n    \"    disabled=False,\\n\",\n    \"    button_style='warning',\\n\",\n    \"    tooltip='Removet the selected session',\\n\",\n    \"    icon='warning'\\n\",\n    \")\\n\",\n    \"\\n\",\n    \"def rem(d):\\n\",\n    \"    with out:\\n\",\n    \"        if s.value is not None:\\n\",\n    \"            clear_output()\\n\",\n    \"            print(\\\"\\u001b[1;33mTHE SESSION \\u001b[1;31m\\\"+s.value+\\\" \\u001b[1;33mHAS BEEN REMOVED FROM YOUR GDRIVE\\\")\\n\",\n    \"            !rm -r '/content/gdrive/MyDrive/Fast-Dreambooth/Sessions/{s.value}'\\n\",\n    \"            s.options=os.listdir(\\\"/content/gdrive/MyDrive/Fast-Dreambooth/Sessions\\\")       \\n\",\n    \"        else:\\n\",\n    \"            d.close()\\n\",\n    \"            s.close()\\n\",\n    \"            clear_output()\\n\",\n    \"            print(\\\"\\u001b[1;32mNOTHING TO REMOVE\\\")\\n\",\n    \"\\n\",\n    \"d.on_click(rem)\\n\",\n    \"if s.value is not None:\\n\",\n    \"    display(s,d,out)\\n\",\n    \"else:\\n\",\n    \"    print(\\\"\\u001b[1;32mNOTHING TO REMOVE\\\")\"\n   ]\n  }\n ],\n \"metadata\": {\n  \"accelerator\": \"GPU\",\n  \"colab\": {\n   \"collapsed_sections\": [\n    \"bbKbx185zqlz\",\n    \"AaLtXBbPleBr\"\n   ],\n   \"provenance\": []\n  },\n  \"kernelspec\": {\n   \"display_name\": \"Python 3\",\n   \"name\": \"python3\"\n  },\n  \"language_info\": {\n   \"name\": \"python\"\n  }\n },\n \"nbformat\": 4,\n \"nbformat_minor\": 0\n}\n"
        },
        {
          "name": "fast_stable_diffusion_AUTOMATIC1111.ipynb",
          "type": "blob",
          "size": 31.75,
          "content": "{\n \"cells\": [\n  {\n   \"cell_type\": \"markdown\",\n   \"metadata\": {\n    \"id\": \"47kV9o1Ni8GH\"\n   },\n   \"source\": [\n    \"# **Colab Pro notebook from https://github.com/TheLastBen/fast-stable-diffusion** *Alternatives : [Paperspace](https://console.paperspace.com/github/TheLastBen/PPS?machine=Free-GPU)*\"\n   ]\n  },\n  {\n   \"cell_type\": \"code\",\n   \"execution_count\": null,\n   \"metadata\": {\n    \"cellView\": \"form\",\n    \"id\": \"Y9EBc437WDOs\"\n   },\n   \"outputs\": [],\n   \"source\": [\n    \"#@markdown # Connect Google Drive\\n\",\n    \"from google.colab import drive\\n\",\n    \"from IPython.display import clear_output\\n\",\n    \"import ipywidgets as widgets\\n\",\n    \"import os\\n\",\n    \"\\n\",\n    \"def inf(msg, style, wdth): inf = widgets.Button(description=msg, disabled=True, button_style=style, layout=widgets.Layout(min_width=wdth));display(inf)\\n\",\n    \"Shared_Drive = \\\"\\\" #@param {type:\\\"string\\\"}\\n\",\n    \"#@markdown - Leave empty if you're not using a shared drive\\n\",\n    \"\\n\",\n    \"print(\\\"\\u001b[0;33mConnecting...\\\")\\n\",\n    \"drive.mount('/content/gdrive')\\n\",\n    \"\\n\",\n    \"if Shared_Drive!=\\\"\\\" and os.path.exists(\\\"/content/gdrive/Shareddrives\\\"):\\n\",\n    \"  mainpth=\\\"Shareddrives/\\\"+Shared_Drive\\n\",\n    \"else:\\n\",\n    \"  mainpth=\\\"MyDrive\\\"\\n\",\n    \"\\n\",\n    \"clear_output()\\n\",\n    \"inf('\\\\u2714 Done','success', '50px')\\n\",\n    \"\\n\",\n    \"#@markdown ---\"\n   ]\n  },\n  {\n   \"cell_type\": \"code\",\n   \"execution_count\": null,\n   \"metadata\": {\n    \"cellView\": \"form\",\n    \"id\": \"CFWtw-6EPrKi\"\n   },\n   \"outputs\": [],\n   \"source\": [\n    \"#@markdown # Install/Update AUTOMATIC1111 repo\\n\",\n    \"from IPython.utils import capture\\n\",\n    \"from IPython.display import clear_output\\n\",\n    \"from subprocess import getoutput\\n\",\n    \"import ipywidgets as widgets\\n\",\n    \"import sys\\n\",\n    \"import fileinput\\n\",\n    \"import os\\n\",\n    \"import time\\n\",\n    \"import base64\\n\",\n    \"import requests\\n\",\n    \"from urllib.request import urlopen, Request\\n\",\n    \"from urllib.parse import urlparse, parse_qs, unquote\\n\",\n    \"from tqdm import tqdm\\n\",\n    \"import six\\n\",\n    \"\\n\",\n    \"\\n\",\n    \"blsaphemy=base64.b64decode((\\\"ZWJ1aQ==\\\").encode('ascii')).decode('ascii')\\n\",\n    \"\\n\",\n    \"if not os.path.exists(\\\"/content/gdrive\\\"):\\n\",\n    \"  print('\\u001b[1;31mGdrive not connected, using temporary colab storage ...')\\n\",\n    \"  time.sleep(4)\\n\",\n    \"  mainpth=\\\"MyDrive\\\"\\n\",\n    \"  !mkdir -p /content/gdrive/$mainpth\\n\",\n    \"  Shared_Drive=\\\"\\\"\\n\",\n    \"\\n\",\n    \"if Shared_Drive!=\\\"\\\" and not os.path.exists(\\\"/content/gdrive/Shareddrives\\\"):\\n\",\n    \"  print('\\u001b[1;31mShared drive not detected, using default MyDrive')\\n\",\n    \"  mainpth=\\\"MyDrive\\\"\\n\",\n    \"\\n\",\n    \"with capture.capture_output() as cap:\\n\",\n    \"  def inf(msg, style, wdth): inf = widgets.Button(description=msg, disabled=True, button_style=style, layout=widgets.Layout(min_width=wdth));display(inf)\\n\",\n    \"  fgitclone = \\\"git clone --depth 1\\\"\\n\",\n    \"  %mkdir -p /content/gdrive/$mainpth/sd\\n\",\n    \"  %cd /content/gdrive/$mainpth/sd\\n\",\n    \"  !git clone -q --branch master https://github.com/AUTOMATIC1111/stable-diffusion-w$blsaphemy\\n\",\n    \"  !mkdir -p /content/gdrive/$mainpth/sd/stable-diffusion-w$blsaphemy/cache/\\n\",\n    \"  os.environ['TRANSFORMERS_CACHE']=f\\\"/content/gdrive/{mainpth}/sd/stable-diffusion-w\\\"+blsaphemy+\\\"/cache\\\"\\n\",\n    \"  os.environ['TORCH_HOME'] = f\\\"/content/gdrive/{mainpth}/sd/stable-diffusion-w\\\"+blsaphemy+\\\"/cache\\\"\\n\",\n    \"  !mkdir -p /content/gdrive/$mainpth/sd/stable-diffusion-w$blsaphemy/repositories\\n\",\n    \"  !git clone https://github.com/AUTOMATIC1111/stable-diffusion-w$blsaphemy-assets /content/gdrive/$mainpth/sd/stable-diffusion-w$blsaphemy/repositories/stable-diffusion-webui-assets\\n\",\n    \"\\n\",\n    \"with capture.capture_output() as cap:\\n\",\n    \"  %cd /content/gdrive/$mainpth/sd/stable-diffusion-w$blsaphemy/\\n\",\n    \"  !git reset --hard\\n\",\n    \"  !git checkout master\\n\",\n    \"  time.sleep(1)\\n\",\n    \"  !rm webui.sh\\n\",\n    \"  !git pull\\n\",\n    \"clear_output()\\n\",\n    \"inf('\\\\u2714 Done','success', '50px')\\n\",\n    \"\\n\",\n    \"#@markdown ---\"\n   ]\n  },\n  {\n   \"cell_type\": \"code\",\n   \"execution_count\": null,\n   \"metadata\": {\n    \"cellView\": \"form\",\n    \"id\": \"ZGV_5H4xrOSp\"\n   },\n   \"outputs\": [],\n   \"source\": [\n    \"#@markdown # Requirements\\n\",\n    \"\\n\",\n    \"print('\\u001b[1;32mInstalling requirements...')\\n\",\n    \"\\n\",\n    \"with capture.capture_output() as cap:\\n\",\n    \"  %cd /content/\\n\",\n    \"  !wget -q -i https://raw.githubusercontent.com/TheLastBen/fast-stable-diffusion/main/Dependencies/A1111.txt\\n\",\n    \"  !dpkg -i *.deb\\n\",\n    \"  !rm -r /usr/local/lib/python3.10/dist-packages/wandb*\\n\",\n    \"  if not os.path.exists('/content/gdrive/'+mainpth+'/sd/stablediffusion'):\\n\",\n    \"    !tar -C /content/gdrive/$mainpth --zstd -xf sd_mrep.tar.zst\\n\",\n    \"  !tar -C / --zstd -xf gcolabdeps.tar.zst\\n\",\n    \"  !rm *.deb | rm *.zst | rm *.txt\\n\",\n    \"  if not os.path.exists('gdrive/'+mainpth+'/sd/libtcmalloc/libtcmalloc_minimal.so.4'):\\n\",\n    \"    %env CXXFLAGS=-std=c++14\\n\",\n    \"    !wget -q https://github.com/gperftools/gperftools/releases/download/gperftools-2.5/gperftools-2.5.tar.gz && tar zxf gperftools-2.5.tar.gz && mv gperftools-2.5 gperftools\\n\",\n    \"    !wget -q https://github.com/TheLastBen/fast-stable-diffusion/raw/main/AUTOMATIC1111_files/Patch\\n\",\n    \"    %cd /content/gperftools\\n\",\n    \"    !patch -p1 < /content/Patch\\n\",\n    \"    !./configure --enable-minimal --enable-libunwind --enable-frame-pointers --enable-dynamic-sized-delete-support --enable-sized-delete --enable-emergency-malloc; make -j4\\n\",\n    \"    !mkdir -p /content/gdrive/$mainpth/sd/libtcmalloc && cp .libs/libtcmalloc*.so* /content/gdrive/$mainpth/sd/libtcmalloc\\n\",\n    \"    %env LD_PRELOAD=/content/gdrive/$mainpth/sd/libtcmalloc/libtcmalloc_minimal.so.4\\n\",\n    \"    %cd /content\\n\",\n    \"    !rm *.tar.gz Patch && rm -r /content/gperftools\\n\",\n    \"  else:\\n\",\n    \"    %env LD_PRELOAD=/content/gdrive/$mainpth/sd/libtcmalloc/libtcmalloc_minimal.so.4\\n\",\n    \"\\n\",\n    \"  !pip install controlnet_aux -qq --no-deps\\n\",\n    \"  !rm -r /usr/local/lib/python3.10/dist-packages/google/_upb\\n\",\n    \"  os.environ['TF_CPP_MIN_LOG_LEVEL'] = '3'\\n\",\n    \"  os.environ['PYTHONWARNINGS'] = 'ignore'\\n\",\n    \"  !sed -i 's@text = _formatwarnmsg(msg)@text =\\\\\\\"\\\\\\\"@g' /usr/lib/python3.10/warnings.py\\n\",\n    \"\\n\",\n    \"clear_output()\\n\",\n    \"inf('\\\\u2714 Done','success', '50px')\\n\",\n    \"\\n\",\n    \"#@markdown ---\"\n   ]\n  },\n  {\n   \"cell_type\": \"code\",\n   \"execution_count\": null,\n   \"metadata\": {\n    \"cellView\": \"form\",\n    \"id\": \"p4wj_txjP3TC\"\n   },\n   \"outputs\": [],\n   \"source\": [\n    \"#@markdown # Model Download/Load\\n\",\n    \"\\n\",\n    \"import gdown\\n\",\n    \"from gdown.download import get_url_from_gdrive_confirmation\\n\",\n    \"import re\\n\",\n    \"\\n\",\n    \"Use_Temp_Storage = False #@param {type:\\\"boolean\\\"}\\n\",\n    \"#@markdown - If not, make sure you have enough space on your gdrive\\n\",\n    \"\\n\",\n    \"#@markdown ---\\n\",\n    \"\\n\",\n    \"Model_Version = \\\"SDXL\\\" #@param [\\\"SDXL\\\", \\\"1.5\\\", \\\"v1.5 Inpainting\\\", \\\"V2.1-768px\\\"]\\n\",\n    \"\\n\",\n    \"#@markdown Or\\n\",\n    \"PATH_to_MODEL = \\\"\\\" #@param {type:\\\"string\\\"}\\n\",\n    \"#@markdown - Insert the full path of your custom model or to a folder containing multiple models\\n\",\n    \"\\n\",\n    \"#@markdown Or\\n\",\n    \"MODEL_LINK = \\\"\\\" #@param {type:\\\"string\\\"}\\n\",\n    \"\\n\",\n    \"\\n\",\n    \"def getsrc(url):\\n\",\n    \"    parsed_url = urlparse(url)\\n\",\n    \"    if parsed_url.netloc == 'civitai.com':\\n\",\n    \"        src='civitai'\\n\",\n    \"    elif parsed_url.netloc == 'drive.google.com':\\n\",\n    \"        src='gdrive'\\n\",\n    \"    elif parsed_url.netloc == 'huggingface.co':\\n\",\n    \"        src='huggingface'\\n\",\n    \"    else:\\n\",\n    \"        src='others'\\n\",\n    \"    return src\\n\",\n    \"\\n\",\n    \"src=getsrc(MODEL_LINK)\\n\",\n    \"\\n\",\n    \"def get_name(url, gdrive):\\n\",\n    \"    if not gdrive:\\n\",\n    \"        response = requests.get(url, allow_redirects=False)\\n\",\n    \"        if \\\"Location\\\" in response.headers:\\n\",\n    \"            redirected_url = response.headers[\\\"Location\\\"]\\n\",\n    \"            quer = parse_qs(urlparse(redirected_url).query)\\n\",\n    \"            if \\\"response-content-disposition\\\" in quer:\\n\",\n    \"                disp_val = quer[\\\"response-content-disposition\\\"][0].split(\\\";\\\")\\n\",\n    \"                for vals in disp_val:\\n\",\n    \"                    if vals.strip().startswith(\\\"filename=\\\"):\\n\",\n    \"                        filenm=unquote(vals.split(\\\"=\\\", 1)[1].strip())\\n\",\n    \"                        return filenm.replace(\\\"\\\\\\\"\\\",\\\"\\\")\\n\",\n    \"    else:\\n\",\n    \"        headers = {\\\"User-Agent\\\": \\\"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_10_1) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/39.0.2171.95 Safari/537.36\\\"}\\n\",\n    \"        lnk=\\\"https://drive.google.com/uc?id={id}&export=download\\\".format(id=url[url.find(\\\"/d/\\\")+3:url.find(\\\"/view\\\")])\\n\",\n    \"        res = requests.session().get(lnk, headers=headers, stream=True, verify=True)\\n\",\n    \"        res = requests.session().get(get_url_from_gdrive_confirmation(res.text), headers=headers, stream=True, verify=True)\\n\",\n    \"        content_disposition = six.moves.urllib_parse.unquote(res.headers[\\\"Content-Disposition\\\"])\\n\",\n    \"        filenm = re.search('attachment; filename=\\\"(.*?)\\\"', content_disposition).groups()[0]\\n\",\n    \"        return filenm\\n\",\n    \"\\n\",\n    \"\\n\",\n    \"def dwn(url, dst, msg):\\n\",\n    \"    file_size = None\\n\",\n    \"    req = Request(url, headers={\\\"User-Agent\\\": \\\"torch.hub\\\"})\\n\",\n    \"    u = urlopen(req)\\n\",\n    \"    meta = u.info()\\n\",\n    \"    if hasattr(meta, 'getheaders'):\\n\",\n    \"        content_length = meta.getheaders(\\\"Content-Length\\\")\\n\",\n    \"    else:\\n\",\n    \"        content_length = meta.get_all(\\\"Content-Length\\\")\\n\",\n    \"    if content_length is not None and len(content_length) > 0:\\n\",\n    \"        file_size = int(content_length[0])\\n\",\n    \"\\n\",\n    \"    with tqdm(total=file_size, disable=False, mininterval=0.5,\\n\",\n    \"              bar_format=msg+' |{bar:20}| {percentage:3.0f}%') as pbar:\\n\",\n    \"        with open(dst, \\\"wb\\\") as f:\\n\",\n    \"            while True:\\n\",\n    \"                buffer = u.read(8192)\\n\",\n    \"                if len(buffer) == 0:\\n\",\n    \"                    break\\n\",\n    \"                f.write(buffer)\\n\",\n    \"                pbar.update(len(buffer))\\n\",\n    \"            f.close()\\n\",\n    \"\\n\",\n    \"\\n\",\n    \"def sdmdls(ver, Use_Temp_Storage):\\n\",\n    \"\\n\",\n    \"  if ver=='1.5':\\n\",\n    \"    if Use_Temp_Storage:\\n\",\n    \"      os.makedirs('/content/temp_models', exist_ok=True)\\n\",\n    \"      model='/content/temp_models/v1-5-pruned-emaonly.safetensors'\\n\",\n    \"    else:\\n\",\n    \"      model='/content/gdrive/'+mainpth+'/sd/stable-diffusion-w'+blsaphemy+'/models/Stable-diffusion/v1-5-pruned-emaonly.safetensors'\\n\",\n    \"    link='https://huggingface.co/runwayml/stable-diffusion-v1-5/resolve/main/v1-5-pruned-emaonly.safetensors'\\n\",\n    \"  elif ver=='V2.1-768px':\\n\",\n    \"    if Use_Temp_Storage:\\n\",\n    \"      os.makedirs('/content/temp_models', exist_ok=True)\\n\",\n    \"      model='/content/temp_models/v2-1_768-ema-pruned.safetensors'\\n\",\n    \"    else:\\n\",\n    \"      model='/content/gdrive/'+mainpth+'/sd/stable-diffusion-w'+blsaphemy+'/models/Stable-diffusion/v2-1_768-ema-pruned.safetensors'\\n\",\n    \"    link='https://huggingface.co/stabilityai/stable-diffusion-2-1/resolve/main/v2-1_768-ema-pruned.safetensors'\\n\",\n    \"  elif ver=='v1.5 Inpainting':\\n\",\n    \"    if Use_Temp_Storage:\\n\",\n    \"      os.makedirs('/content/temp_models', exist_ok=True)\\n\",\n    \"      model='/content/temp_models/sd-v1-5-inpainting.ckpt'\\n\",\n    \"    else:\\n\",\n    \"      model='/content/gdrive/'+mainpth+'/sd/stable-diffusion-w'+blsaphemy+'/models/Stable-diffusion/sd-v1-5-inpainting.ckpt'\\n\",\n    \"    link='https://huggingface.co/runwayml/stable-diffusion-inpainting/resolve/main/sd-v1-5-inpainting.ckpt'\\n\",\n    \"  elif ver=='SDXL':\\n\",\n    \"    if Use_Temp_Storage:\\n\",\n    \"      os.makedirs('/content/temp_models', exist_ok=True)\\n\",\n    \"      model='/content/temp_models/sd_xl_base_1.0.safetensors'\\n\",\n    \"    else:\\n\",\n    \"      model='/content/gdrive/'+mainpth+'/sd/stable-diffusion-w'+blsaphemy+'/models/Stable-diffusion/sd_xl_base_1.0.safetensors'\\n\",\n    \"    link='https://huggingface.co/stabilityai/stable-diffusion-xl-base-1.0/resolve/main/sd_xl_base_1.0.safetensors'\\n\",\n    \"\\n\",\n    \"  if not os.path.exists(model):\\n\",\n    \"    !gdown --fuzzy -O $model $link\\n\",\n    \"    if os.path.exists(model):\\n\",\n    \"      clear_output()\\n\",\n    \"      inf('\\\\u2714 Done','success', '50px')\\n\",\n    \"    else:\\n\",\n    \"      inf('\\\\u2718 Something went wrong, try again','danger', \\\"250px\\\")\\n\",\n    \"  else:\\n\",\n    \"      clear_output()\\n\",\n    \"      inf('\\\\u2714 Model already exists','primary', '300px')\\n\",\n    \"\\n\",\n    \"  return model\\n\",\n    \"\\n\",\n    \"\\n\",\n    \"if (PATH_to_MODEL !=''):\\n\",\n    \"  if os.path.exists(str(PATH_to_MODEL)):\\n\",\n    \"    inf('\\\\u2714 Using the trained model.','success', '200px')\\n\",\n    \"\\n\",\n    \"  else:\\n\",\n    \"      while not os.path.exists(str(PATH_to_MODEL)):\\n\",\n    \"        inf('\\\\u2718 Wrong path, use the colab file explorer to copy the path : ','danger', \\\"400px\\\")\\n\",\n    \"        PATH_to_MODEL=input()\\n\",\n    \"      if os.path.exists(str(PATH_to_MODEL)):\\n\",\n    \"        inf('\\\\u2714 Using the custom model.','success', '200px')\\n\",\n    \"\\n\",\n    \"  model=PATH_to_MODEL\\n\",\n    \"\\n\",\n    \"elif MODEL_LINK != \\\"\\\":\\n\",\n    \"\\n\",\n    \"      if src=='civitai':\\n\",\n    \"         modelname=get_name(MODEL_LINK, False)\\n\",\n    \"         if Use_Temp_Storage:\\n\",\n    \"            os.makedirs('/content/temp_models', exist_ok=True)\\n\",\n    \"            model=f'/content/temp_models/{modelname}'\\n\",\n    \"         else:\\n\",\n    \"            model=f'/content/gdrive/{mainpth}/sd/stable-diffusion-w{blsaphemy}/models/Stable-diffusion/{modelname}'\\n\",\n    \"         if not os.path.exists(model):\\n\",\n    \"            dwn(MODEL_LINK, model, 'Downloading the custom model')\\n\",\n    \"            clear_output()\\n\",\n    \"         else:\\n\",\n    \"            inf('\\\\u2714 Model already exists','primary', '300px')\\n\",\n    \"      elif src=='gdrive':\\n\",\n    \"         modelname=get_name(MODEL_LINK, True)\\n\",\n    \"         if Use_Temp_Storage:\\n\",\n    \"            os.makedirs('/content/temp_models', exist_ok=True)\\n\",\n    \"            model=f'/content/temp_models/{modelname}'\\n\",\n    \"         else:\\n\",\n    \"            model=f'/content/gdrive/{mainpth}/sd/stable-diffusion-w{blsaphemy}/models/Stable-diffusion/{modelname}'\\n\",\n    \"         if not os.path.exists(model):\\n\",\n    \"            gdown.download(url=MODEL_LINK, output=model, quiet=False, fuzzy=True)\\n\",\n    \"            clear_output()\\n\",\n    \"         else:\\n\",\n    \"            inf('\\\\u2714 Model already exists','primary', '300px')\\n\",\n    \"      else:\\n\",\n    \"         modelname=os.path.basename(MODEL_LINK)\\n\",\n    \"         if Use_Temp_Storage:\\n\",\n    \"            os.makedirs('/content/temp_models', exist_ok=True)\\n\",\n    \"            model=f'/content/temp_models/{modelname}'\\n\",\n    \"         else:\\n\",\n    \"            model=f'/content/gdrive/{mainpth}/sd/stable-diffusion-w{blsaphemy}/models/Stable-diffusion/{modelname}'\\n\",\n    \"         if not os.path.exists(model):\\n\",\n    \"            gdown.download(url=MODEL_LINK, output=model, quiet=False, fuzzy=True)\\n\",\n    \"            clear_output()\\n\",\n    \"         else:\\n\",\n    \"            inf('\\\\u2714 Model already exists','primary', '700px')\\n\",\n    \"\\n\",\n    \"      if os.path.exists(model) and os.path.getsize(model) > 1810671599:\\n\",\n    \"        inf('\\\\u2714 Model downloaded, using the custom model.','success', '300px')\\n\",\n    \"      else:\\n\",\n    \"        !rm model\\n\",\n    \"        inf('\\\\u2718 Wrong link, check that the link is valid','danger', \\\"300px\\\")\\n\",\n    \"\\n\",\n    \"else:\\n\",\n    \"  model=sdmdls(Model_Version, Use_Temp_Storage)\\n\",\n    \"\\n\",\n    \"#@markdown ---\"\n   ]\n  },\n  {\n   \"cell_type\": \"code\",\n   \"execution_count\": null,\n   \"metadata\": {\n    \"cellView\": \"form\",\n    \"id\": \"Svx6Hx0iUPd1\"\n   },\n   \"outputs\": [],\n   \"source\": [\n    \"#@markdown # Download LoRA\\n\",\n    \"\\n\",\n    \"LoRA_LINK = \\\"\\\" #@param {type:\\\"string\\\"}\\n\",\n    \"\\n\",\n    \"if LoRA_LINK == \\\"\\\":\\n\",\n    \"  inf('\\\\u2714 Nothing to do','primary', '200px')\\n\",\n    \"else:\\n\",\n    \"  os.makedirs('/content/gdrive/'+mainpth+'/sd/stable-diffusion-w'+blsaphemy+'/models/Lora', exist_ok=True)\\n\",\n    \"\\n\",\n    \"  src=getsrc(LoRA_LINK)\\n\",\n    \"\\n\",\n    \"  if src=='civitai':\\n\",\n    \"      modelname=get_name(LoRA_LINK, False)\\n\",\n    \"      loramodel=f'/content/gdrive/{mainpth}/sd/stable-diffusion-w{blsaphemy}/models/Lora/{modelname}'\\n\",\n    \"      if not os.path.exists(loramodel):\\n\",\n    \"        dwn(LoRA_LINK, loramodel, 'Downloading the LoRA model '+modelname)\\n\",\n    \"        clear_output()\\n\",\n    \"      else:\\n\",\n    \"        inf('\\\\u2714 Model already exists','primary', '200px')\\n\",\n    \"  elif src=='gdrive':\\n\",\n    \"      modelname=get_name(LoRA_LINK, True)\\n\",\n    \"      loramodel=f'/content/gdrive/{mainpth}/sd/stable-diffusion-w{blsaphemy}/models/Lora/{modelname}'\\n\",\n    \"      if not os.path.exists(loramodel):\\n\",\n    \"        gdown.download(url=LoRA_LINK, output=loramodel, quiet=False, fuzzy=True)\\n\",\n    \"        clear_output()\\n\",\n    \"      else:\\n\",\n    \"        inf('\\\\u2714 Model already exists','primary', '200px')\\n\",\n    \"  else:\\n\",\n    \"      modelname=os.path.basename(LoRA_LINK)\\n\",\n    \"      loramodel=f'/content/gdrive/{mainpth}/sd/stable-diffusion-w{blsaphemy}/models/Lora/{modelname}'\\n\",\n    \"      if not os.path.exists(loramodel):\\n\",\n    \"        gdown.download(url=LoRA_LINK, output=loramodel, quiet=False, fuzzy=True)\\n\",\n    \"        clear_output()\\n\",\n    \"      else:\\n\",\n    \"        inf('\\\\u2714 Model already exists','primary', '200px')\\n\",\n    \"\\n\",\n    \"  if os.path.exists(loramodel) :\\n\",\n    \"    inf('\\\\u2714 LoRA downloaded','success', '200px')\\n\",\n    \"  else:\\n\",\n    \"    inf('\\\\u2718 Wrong link, check that the link is valid','danger', \\\"300px\\\")\\n\",\n    \"\\n\",\n    \"#@markdown ---\"\n   ]\n  },\n  {\n   \"cell_type\": \"code\",\n   \"execution_count\": null,\n   \"metadata\": {\n    \"cellView\": \"form\",\n    \"id\": \"zC3Rz1b2TBcB\"\n   },\n   \"outputs\": [],\n   \"source\": [\n    \"#@markdown # ControlNet\\n\",\n    \"from torch.hub import download_url_to_file\\n\",\n    \"from urllib.parse import urlparse\\n\",\n    \"import re\\n\",\n    \"from subprocess import run\\n\",\n    \"\\n\",\n    \"XL_Model = \\\"None\\\" #@param [ \\\"None\\\", \\\"All\\\", \\\"Canny\\\", \\\"Depth\\\", \\\"Sketch\\\", \\\"OpenPose\\\", \\\"Recolor\\\"]\\n\",\n    \"\\n\",\n    \"v1_Model = \\\"None\\\" #@param [ \\\"None\\\", \\\"All (21GB)\\\", \\\"Canny\\\", \\\"Depth\\\", \\\"Lineart\\\", \\\"MLSD\\\", \\\"Normal\\\", \\\"OpenPose\\\", \\\"Scribble\\\", \\\"Seg\\\", \\\"ip2p\\\", \\\"Shuffle\\\", \\\"Inpaint\\\", \\\"Softedge\\\", \\\"Lineart_Anime\\\", \\\"Tile\\\", \\\"T2iadapter_Models\\\"]\\n\",\n    \"\\n\",\n    \"v2_Model = \\\"None\\\" #@param [ \\\"None\\\", \\\"All\\\", \\\"Canny\\\", \\\"Depth\\\", \\\"HED\\\", \\\"OpenPose\\\", \\\"Scribble\\\"]\\n\",\n    \"\\n\",\n    \"#@markdown - Download/update ControlNet extension and its models\\n\",\n    \"\\n\",\n    \"def download(url, model_dir):\\n\",\n    \"\\n\",\n    \"    filename = os.path.basename(urlparse(url).path)\\n\",\n    \"    pth = os.path.abspath(os.path.join(model_dir, filename))\\n\",\n    \"    if not os.path.exists(pth):\\n\",\n    \"        print('Downloading: '+os.path.basename(url))\\n\",\n    \"        download_url_to_file(url, pth, hash_prefix=None, progress=True)\\n\",\n    \"    else:\\n\",\n    \"      print(f\\\"\\u001b[1;32mThe model {filename} already exists\\u001b[0m\\\")\\n\",\n    \"\\n\",\n    \"\\n\",\n    \"Canny='https://huggingface.co/lllyasviel/sd_control_collection/resolve/main/diffusers_xl_canny_mid.safetensors'\\n\",\n    \"Depth='https://huggingface.co/lllyasviel/sd_control_collection/resolve/main/diffusers_xl_depth_mid.safetensors'\\n\",\n    \"Sketch='https://huggingface.co/lllyasviel/sd_control_collection/resolve/main/sai_xl_sketch_256lora.safetensors'\\n\",\n    \"OpenPose='https://huggingface.co/lllyasviel/sd_control_collection/resolve/main/thibaud_xl_openpose_256lora.safetensors'\\n\",\n    \"Recolor='https://huggingface.co/lllyasviel/sd_control_collection/resolve/main/sai_xl_recolor_128lora.safetensors'\\n\",\n    \"\\n\",\n    \"\\n\",\n    \"with capture.capture_output() as cap:\\n\",\n    \"  %cd /content/gdrive/$mainpth/sd/stable-diffusion-w$blsaphemy/extensions\\n\",\n    \"  if not os.path.exists('sd-w'+blsaphemy+'-controlnet'):\\n\",\n    \"    !git clone https://github.com/Mikubill/sd-w$blsaphemy-controlnet.git\\n\",\n    \"    %cd /content\\n\",\n    \"  else:\\n\",\n    \"    %cd sd-w$blsaphemy-controlnet\\n\",\n    \"    !git reset --hard\\n\",\n    \"    !git pull\\n\",\n    \"    %cd /content\\n\",\n    \"\\n\",\n    \"mdldir='/content/gdrive/'+mainpth+'/sd/stable-diffusion-w'+blsaphemy+'/extensions/sd-w'+blsaphemy+'-controlnet/models'\\n\",\n    \"for filename in os.listdir(mdldir):\\n\",\n    \"  if \\\"_sd14v1\\\" in filename:\\n\",\n    \"    renamed = re.sub(\\\"_sd14v1\\\", \\\"-fp16\\\", filename)\\n\",\n    \"    os.rename(os.path.join(mdldir, filename), os.path.join(mdldir, renamed))\\n\",\n    \"\\n\",\n    \"!wget -q -O CN_models.txt https://github.com/TheLastBen/fast-stable-diffusion/raw/main/AUTOMATIC1111_files/CN_models.txt\\n\",\n    \"!wget -q -O CN_models_v2.txt https://github.com/TheLastBen/fast-stable-diffusion/raw/main/AUTOMATIC1111_files/CN_models_v2.txt\\n\",\n    \"!wget -q -O CN_models_XL.txt https://github.com/TheLastBen/fast-stable-diffusion/raw/main/AUTOMATIC1111_files/CN_models_XL.txt\\n\",\n    \"\\n\",\n    \"\\n\",\n    \"with open(\\\"CN_models.txt\\\", 'r') as f:\\n\",\n    \"  mdllnk = f.read().splitlines()\\n\",\n    \"with open(\\\"CN_models_v2.txt\\\", 'r') as d:\\n\",\n    \"  mdllnk_v2 = d.read().splitlines()\\n\",\n    \"with open(\\\"CN_models_XL.txt\\\", 'r') as d:\\n\",\n    \"  mdllnk_XL = d.read().splitlines()\\n\",\n    \"\\n\",\n    \"!rm CN_models.txt CN_models_v2.txt CN_models_XL.txt\\n\",\n    \"\\n\",\n    \"\\n\",\n    \"if XL_Model == \\\"All\\\":\\n\",\n    \"  for lnk_XL in mdllnk_XL:\\n\",\n    \"      download(lnk_XL, mdldir)\\n\",\n    \"  clear_output()\\n\",\n    \"  inf('\\\\u2714 Done','success', '50px')\\n\",\n    \"\\n\",\n    \"elif XL_Model == \\\"None\\\":\\n\",\n    \"    pass\\n\",\n    \"    clear_output()\\n\",\n    \"    inf('\\\\u2714 Done','success', '50px')\\n\",\n    \"\\n\",\n    \"else:\\n\",\n    \"  download(globals()[XL_Model], mdldir)\\n\",\n    \"  clear_output()\\n\",\n    \"  inf('\\\\u2714 Done','success', '50px')\\n\",\n    \"\\n\",\n    \"\\n\",\n    \"Canny='https://huggingface.co/lllyasviel/ControlNet-v1-1/resolve/main/control_v11p_sd15_canny.pth'\\n\",\n    \"Depth='https://huggingface.co/lllyasviel/ControlNet-v1-1/resolve/main/control_v11f1p_sd15_depth.pth'\\n\",\n    \"Lineart='https://huggingface.co/lllyasviel/ControlNet-v1-1/resolve/main/control_v11p_sd15_lineart.pth'\\n\",\n    \"MLSD='https://huggingface.co/lllyasviel/ControlNet-v1-1/resolve/main/control_v11p_sd15_mlsd.pth'\\n\",\n    \"Normal='https://huggingface.co/lllyasviel/ControlNet-v1-1/resolve/main/control_v11p_sd15_normalbae.pth'\\n\",\n    \"OpenPose='https://huggingface.co/lllyasviel/ControlNet-v1-1/resolve/main/control_v11p_sd15_openpose.pth'\\n\",\n    \"Scribble='https://huggingface.co/lllyasviel/ControlNet-v1-1/resolve/main/control_v11p_sd15_scribble.pth'\\n\",\n    \"Seg='https://huggingface.co/lllyasviel/ControlNet-v1-1/resolve/main/control_v11p_sd15_seg.pth'\\n\",\n    \"ip2p='https://huggingface.co/lllyasviel/ControlNet-v1-1/resolve/main/control_v11e_sd15_ip2p.pth'\\n\",\n    \"Shuffle='https://huggingface.co/lllyasviel/ControlNet-v1-1/resolve/main/control_v11e_sd15_shuffle.pth'\\n\",\n    \"Inpaint='https://huggingface.co/lllyasviel/ControlNet-v1-1/resolve/main/control_v11p_sd15_inpaint.pth'\\n\",\n    \"Softedge='https://huggingface.co/lllyasviel/ControlNet-v1-1/resolve/main/control_v11p_sd15_softedge.pth'\\n\",\n    \"Lineart_Anime='https://huggingface.co/lllyasviel/ControlNet-v1-1/resolve/main/control_v11p_sd15s2_lineart_anime.pth'\\n\",\n    \"Tile='https://huggingface.co/lllyasviel/ControlNet-v1-1/resolve/main/control_v11f1e_sd15_tile.pth'\\n\",\n    \"\\n\",\n    \"\\n\",\n    \"with capture.capture_output() as cap:\\n\",\n    \"  cfgnames=[os.path.basename(url).split('.')[0]+'.yaml' for url in mdllnk_v2]\\n\",\n    \"  %cd /content/gdrive/$mainpth/sd/stable-diffusion-w$blsaphemy/extensions/sd-w$blsaphemy-controlnet/models\\n\",\n    \"  for name in cfgnames:\\n\",\n    \"      run(['cp', 'cldm_v21.yaml', name])\\n\",\n    \"  %cd /content\\n\",\n    \"\\n\",\n    \"if v1_Model == \\\"All (21GB)\\\":\\n\",\n    \"  for lnk in mdllnk:\\n\",\n    \"      download(lnk, mdldir)\\n\",\n    \"  clear_output()\\n\",\n    \"\\n\",\n    \"elif v1_Model == \\\"T2iadapter_Models\\\":\\n\",\n    \"  mdllnk=list(filter(lambda x: 't2i' in x, mdllnk))\\n\",\n    \"  for lnk in mdllnk:\\n\",\n    \"      download(lnk, mdldir)\\n\",\n    \"  clear_output()\\n\",\n    \"\\n\",\n    \"elif v1_Model == \\\"None\\\":\\n\",\n    \"    pass\\n\",\n    \"    clear_output()\\n\",\n    \"\\n\",\n    \"else:\\n\",\n    \"  download(globals()[v1_Model], mdldir)\\n\",\n    \"  clear_output()\\n\",\n    \"\\n\",\n    \"Canny='https://huggingface.co/thibaud/controlnet-sd21/resolve/main/control_v11p_sd21_canny.safetensors'\\n\",\n    \"Depth='https://huggingface.co/thibaud/controlnet-sd21/resolve/main/control_v11p_sd21_depth.safetensors'\\n\",\n    \"HED='https://huggingface.co/thibaud/controlnet-sd21/resolve/main/control_v11p_sd21_hed.safetensors'\\n\",\n    \"OpenPose='https://huggingface.co/thibaud/controlnet-sd21/resolve/main/control_v11p_sd21_openposev2.safetensors'\\n\",\n    \"Scribble='https://huggingface.co/thibaud/controlnet-sd21/resolve/main/control_v11p_sd21_scribble.safetensors'\\n\",\n    \"\\n\",\n    \"\\n\",\n    \"if v2_Model == \\\"All\\\":\\n\",\n    \"  for lnk_v2 in mdllnk_v2:\\n\",\n    \"      download(lnk_v2, mdldir)\\n\",\n    \"  clear_output()\\n\",\n    \"  inf('\\\\u2714 Done','success', '50px')\\n\",\n    \"\\n\",\n    \"elif v2_Model == \\\"None\\\":\\n\",\n    \"    pass\\n\",\n    \"    clear_output()\\n\",\n    \"    inf('\\\\u2714 Done','success', '50px')\\n\",\n    \"\\n\",\n    \"else:\\n\",\n    \"  download(globals()[v2_Model], mdldir)\\n\",\n    \"  clear_output()\\n\",\n    \"  inf('\\\\u2714 Done','success', '50px')\\n\",\n    \"\\n\",\n    \"  #@markdown ---\"\n   ]\n  },\n  {\n   \"cell_type\": \"code\",\n   \"execution_count\": null,\n   \"metadata\": {\n    \"cellView\": \"form\",\n    \"id\": \"PjzwxTkPSPHf\"\n   },\n   \"outputs\": [],\n   \"source\": [\n    \"#@markdown # Start Stable-Diffusion\\n\",\n    \"from IPython.utils import capture\\n\",\n    \"import time\\n\",\n    \"import sys\\n\",\n    \"import fileinput\\n\",\n    \"from pyngrok import ngrok, conf\\n\",\n    \"import re\\n\",\n    \"\\n\",\n    \"\\n\",\n    \"Use_Cloudflare_Tunnel = False #@param {type:\\\"boolean\\\"}\\n\",\n    \"#@markdown - Offers better gradio responsivity\\n\",\n    \"\\n\",\n    \"Ngrok_token = \\\"\\\" #@param {type:\\\"string\\\"}\\n\",\n    \"\\n\",\n    \"#@markdown - Input your ngrok token if you want to use ngrok server\\n\",\n    \"\\n\",\n    \"User = \\\"\\\" #@param {type:\\\"string\\\"}\\n\",\n    \"Password= \\\"\\\" #@param {type:\\\"string\\\"}\\n\",\n    \"#@markdown - Add credentials to your Gradio interface (optional)\\n\",\n    \"\\n\",\n    \"auth=f\\\"--gradio-auth {User}:{Password}\\\"\\n\",\n    \"if User ==\\\"\\\" or Password==\\\"\\\":\\n\",\n    \"  auth=\\\"\\\"\\n\",\n    \"\\n\",\n    \"\\n\",\n    \"with capture.capture_output() as cap:\\n\",\n    \"  %cd /content/gdrive/$mainpth/sd/stable-diffusion-w$blsaphemy/modules/\\n\",\n    \"  !wget -q -O extras.py https://raw.githubusercontent.com/AUTOMATIC1111/stable-diffusion-w$blsaphemy/master/modules/extras.py\\n\",\n    \"  !wget -q -O sd_models.py https://raw.githubusercontent.com/AUTOMATIC1111/stable-diffusion-w$blsaphemy/master/modules/sd_models.py\\n\",\n    \"  !wget -q -O /usr/local/lib/python3.10/dist-packages/gradio/blocks.py https://raw.githubusercontent.com/TheLastBen/fast-stable-diffusion/main/AUTOMATIC1111_files/blocks.py\\n\",\n    \"  %cd /content/gdrive/$mainpth/sd/stable-diffusion-w$blsaphemy/\\n\",\n    \"  \\n\",\n    \"  !sed -i 's@shared.opts.data\\\\[\\\"sd_model_checkpoint\\\"] = checkpoint_info.title@shared.opts.data\\\\[\\\"sd_model_checkpoint\\\"] = checkpoint_info.title;model.half()@' /content/gdrive/$mainpth/sd/stable-diffusion-w$blsaphemy/modules/sd_models.py\\n\",\n    \"  #!sed -i 's@ui.create_ui().*@ui.create_ui();shared.demo.queue(concurrency_count=999999,status_update_rate=0.1)@' /content/gdrive/$mainpth/sd/stable-diffusion-w$blsaphemy/webui.py\\n\",\n    \"  !sed -i \\\"s@map_location='cpu'@map_location='cuda'@\\\" /content/gdrive/$mainpth/sd/stable-diffusion-w$blsaphemy/modules/extras.py\\n\",\n    \"\\n\",\n    \"  !sed -i 's@possible_sd_paths =.*@possible_sd_paths = [\\\\\\\"/content/gdrive/{mainpth}/sd/stablediffusion\\\\\\\"]@' /content/gdrive/$mainpth/sd/stable-diffusion-w$blsaphemy/modules/paths.py\\n\",\n    \"  !sed -i 's@\\\\.\\\\.\\\\/@src/@g' /content/gdrive/$mainpth/sd/stable-diffusion-w$blsaphemy/modules/paths.py\\n\",\n    \"  !sed -i 's@src/generative-models@generative-models@g' /content/gdrive/$mainpth/sd/stable-diffusion-w$blsaphemy/modules/paths.py\\n\",\n    \"\\n\",\n    \"  !sed -i 's@print(\\\\\\\"No module.*@@' /content/gdrive/$mainpth/sd/stablediffusion/ldm/modules/diffusionmodules/model.py\\n\",\n    \"  !sed -i 's@\\\\[\\\"sd_model_checkpoint\\\"\\\\]@\\\\[\\\"sd_model_checkpoint\\\", \\\"sd_vae\\\", \\\"CLIP_stop_at_last_layers\\\", \\\"inpainting_mask_weight\\\", \\\"initial_noise_multiplier\\\"\\\\]@g' /content/gdrive/$mainpth/sd/stable-diffusion-w$blsaphemy/modules/shared.py\\n\",\n    \"\\n\",\n    \"share=''\\n\",\n    \"if Ngrok_token!=\\\"\\\":\\n\",\n    \"  ngrok.kill()\\n\",\n    \"  srv=ngrok.connect(7860, pyngrok_config=conf.PyngrokConfig(auth_token=Ngrok_token) , bind_tls=True).public_url\\n\",\n    \"\\n\",\n    \"  for line in fileinput.input('/usr/local/lib/python3.10/dist-packages/gradio/blocks.py', inplace=True):\\n\",\n    \"    if line.strip().startswith('self.server_name ='):\\n\",\n    \"        line = f'            self.server_name = \\\"{srv[8:]}\\\"\\\\n'\\n\",\n    \"    if line.strip().startswith('self.protocol = \\\"https\\\"'):\\n\",\n    \"        line = '            self.protocol = \\\"https\\\"\\\\n'\\n\",\n    \"    if line.strip().startswith('if self.local_url.startswith(\\\"https\\\") or self.is_colab'):\\n\",\n    \"        line = ''\\n\",\n    \"    if line.strip().startswith('else \\\"http\\\"'):\\n\",\n    \"        line = ''\\n\",\n    \"    sys.stdout.write(line)\\n\",\n    \"\\n\",\n    \"elif Use_Cloudflare_Tunnel:\\n\",\n    \"  with capture.capture_output() as cap:\\n\",\n    \"    !pkill cloudflared\\n\",\n    \"    time.sleep(4)\\n\",\n    \"    !nohup cloudflared tunnel --url http://localhost:7860 > /content/srv.txt 2>&1 &\\n\",\n    \"    time.sleep(4)\\n\",\n    \"    with open('/content/srv.txt', \\\"r\\\") as file: text = file.read()\\n\",\n    \"    srv= re.findall(r\\\"https?://(?:\\\\S+?\\\\.)?trycloudflare\\\\.com\\\\S*\\\", text)[0]\\n\",\n    \"\\n\",\n    \"    for line in fileinput.input('/usr/local/lib/python3.10/dist-packages/gradio/blocks.py', inplace=True):\\n\",\n    \"      if line.strip().startswith('self.server_name ='):\\n\",\n    \"          line = f'            self.server_name = \\\"{srv[8:]}\\\"\\\\n'\\n\",\n    \"      if line.strip().startswith('self.protocol = \\\"https\\\"'):\\n\",\n    \"          line = '            self.protocol = \\\"https\\\"\\\\n'\\n\",\n    \"      if line.strip().startswith('if self.local_url.startswith(\\\"https\\\") or self.is_colab'):\\n\",\n    \"          line = ''\\n\",\n    \"      if line.strip().startswith('else \\\"http\\\"'):\\n\",\n    \"          line = ''\\n\",\n    \"      sys.stdout.write(line)\\n\",\n    \"\\n\",\n    \"    !rm /content/srv.txt\\n\",\n    \"\\n\",\n    \"else:\\n\",\n    \"  share='--share'\\n\",\n    \"\\n\",\n    \"ckptdir=''\\n\",\n    \"if os.path.exists('/content/temp_models'):\\n\",\n    \"  ckptdir='--ckpt-dir /content/temp_models'\\n\",\n    \"\\n\",\n    \"try:\\n\",\n    \"  model\\n\",\n    \"  if os.path.isfile(model):\\n\",\n    \"    !python /content/gdrive/$mainpth/sd/stable-diffusion-w$blsaphemy/webui.py $share --api --disable-safe-unpickle --enable-insecure-extension-access --no-download-sd-model --no-half-vae  --ckpt \\\"$model\\\" --xformers $auth --disable-console-progressbars --skip-version-check $ckptdir\\n\",\n    \"  else:\\n\",\n    \"    !python /content/gdrive/$mainpth/sd/stable-diffusion-w$blsaphemy/webui.py $share --api --disable-safe-unpickle --enable-insecure-extension-access --no-download-sd-model --no-half-vae  --ckpt-dir \\\"$model\\\" --xformers $auth --disable-console-progressbars --skip-version-check\\n\",\n    \"except:\\n\",\n    \"   !python /content/gdrive/$mainpth/sd/stable-diffusion-w$blsaphemy/webui.py $share --api --disable-safe-unpickle --enable-insecure-extension-access --no-download-sd-model --no-half-vae --xformers $auth --disable-console-progressbars --skip-version-check $ckptdir\"\n   ]\n  }\n ],\n \"metadata\": {\n  \"accelerator\": \"GPU\",\n  \"colab\": {\n   \"provenance\": []\n  },\n  \"gpuClass\": \"standard\",\n  \"kernelspec\": {\n   \"display_name\": \"Python 3\",\n   \"name\": \"python3\"\n  },\n  \"language_info\": {\n   \"name\": \"python\"\n  }\n },\n \"nbformat\": 4,\n \"nbformat_minor\": 0\n}\n"
        }
      ]
    }
  ]
}