{
  "metadata": {
    "timestamp": 1736560348712,
    "page": 878,
    "hasNextPage": true,
    "endCursor": "Y3Vyc29yOjg4MA==",
    "completionStatus": "IN_PROGRESS"
  },
  "repositories": [
    {
      "nameWithOwner": "PiotrMachowski/Xiaomi-cloud-tokens-extractor",
      "stars": 3332,
      "defaultBranch": "master",
      "files": [
        {
          "name": ".dockerignore",
          "type": "blob",
          "size": 0.0673828125,
          "content": "# Ignore everything\n*\n# Except\n!requirements.txt\n!token_extractor.py\n"
        },
        {
          "name": ".github",
          "type": "tree",
          "content": null
        },
        {
          "name": ".gitignore",
          "type": "blob",
          "size": 2.1962890625,
          "content": "\n# Created by https://www.toptal.com/developers/gitignore/api/python\n# Edit at https://www.toptal.com/developers/gitignore?templates=python\n\n### Python ###\n# Byte-compiled / optimized / DLL files\n__pycache__/\n*.py[cod]\n*$py.class\n\n# C extensions\n*.so\n\n# Distribution / packaging\n.Python\nbuild/\ndevelop-eggs/\ndist/\ndownloads/\neggs/\n.eggs/\nlib/\nlib64/\nparts/\nsdist/\nvar/\nwheels/\nshare/python-wheels/\n*.egg-info/\n.installed.cfg\n*.egg\nMANIFEST\n\n# PyInstaller\n#  Usually these files are written by a python script from a template\n#  before PyInstaller builds the exe, so as to inject date/other infos into it.\n*.manifest\n\n# Installer logs\npip-log.txt\npip-delete-this-directory.txt\n\n# Unit test / coverage reports\nhtmlcov/\n.tox/\n.nox/\n.coverage\n.coverage.*\n.cache\nnosetests.xml\ncoverage.xml\n*.cover\n*.py,cover\n.hypothesis/\n.pytest_cache/\ncover/\n\n# Translations\n*.mo\n*.pot\n\n# Django stuff:\n*.log\nlocal_settings.py\ndb.sqlite3\ndb.sqlite3-journal\n\n# Flask stuff:\ninstance/\n.webassets-cache\n\n# Scrapy stuff:\n.scrapy\n\n# Sphinx documentation\ndocs/_build/\n\n# PyBuilder\n.pybuilder/\ntarget/\n\n# Jupyter Notebook\n.ipynb_checkpoints\n\n# IPython\nprofile_default/\nipython_config.py\n\n# pyenv\n#   For a library or package, you might want to ignore these files since the code is\n#   intended to run in multiple environments; otherwise, check them in:\n# .python-version\n\n# pipenv\n#   According to pypa/pipenv#598, it is recommended to include Pipfile.lock in version control.\n#   However, in case of collaboration, if having platform-specific dependencies or dependencies\n#   having no cross-platform support, pipenv may install dependencies that don't work, or not\n#   install all needed dependencies.\n#Pipfile.lock\n\n# PEP 582; used by e.g. github.com/David-OConnor/pyflow\n__pypackages__/\n\n# Celery stuff\ncelerybeat-schedule\ncelerybeat.pid\n\n# SageMath parsed files\n*.sage.py\n\n# Environments\n.env\n.venv\nenv/\nvenv/\nENV/\nenv.bak/\nvenv.bak/\n\n# Spyder project settings\n.spyderproject\n.spyproject\n\n# Rope project settings\n.ropeproject\n\n# mkdocs documentation\n/site\n\n# mypy\n.mypy_cache/\n.dmypy.json\ndmypy.json\n\n# Pyre type checker\n.pyre/\n\n# pytype static type analyzer\n.pytype/\n\n# Cython debug symbols\ncython_debug/\n\n# End of https://www.toptal.com/developers/gitignore/api/python\n"
        },
        {
          "name": "Dockerfile",
          "type": "blob",
          "size": 0.208984375,
          "content": "FROM python:3-alpine\n\nWORKDIR /usr/src/app\n\nCOPY requirements.txt ./\nRUN apk add build-base\nRUN pip3 install --no-cache-dir -r requirements.txt\n\nCOPY token_extractor.py ./\n\nCMD [ \"python\", \"./token_extractor.py\" ]\n"
        },
        {
          "name": "LICENSE",
          "type": "blob",
          "size": 1.046875,
          "content": "MIT License\n\nCopyright (c) 2020 Piotr Machowski\n\nPermission is hereby granted, free of charge, to any person obtaining a copy\nof this software and associated documentation files (the \"Software\"), to deal\nin the Software without restriction, including without limitation the rights\nto use, copy, modify, merge, publish, distribute, sublicense, and/or sell\ncopies of the Software, and to permit persons to whom the Software is\nfurnished to do so, subject to the following conditions:\n\nThe above copyright notice and this permission notice shall be included in all\ncopies or substantial portions of the Software.\n\nTHE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\nIMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\nFITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\nAUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\nLIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\nOUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE\nSOFTWARE.\n"
        },
        {
          "name": "README.md",
          "type": "blob",
          "size": 6.6826171875,
          "content": "[![GitHub Latest Release][releases_shield]][latest_release]\n[![GitHub All Releases][downloads_total_shield]][releases]<!-- piotrmachowski_support_badges_start -->\n[![Ko-Fi][ko_fi_shield]][ko_fi]\n[![buycoffee.to][buycoffee_to_shield]][buycoffee_to]\n[![PayPal.Me][paypal_me_shield]][paypal_me]\n[![Revolut.Me][revolut_me_shield]][revolut_me]\n<!-- piotrmachowski_support_badges_end -->\n\n[latest_release]: https://github.com/PiotrMachowski/Xiaomi-cloud-tokens-extractor/releases/latest\n[releases_shield]: https://img.shields.io/github/release/PiotrMachowski/Xiaomi-cloud-tokens-extractor.svg?style=popout\n\n[releases]: https://github.com/PiotrMachowski/Xiaomi-cloud-tokens-extractor/releases\n[downloads_total_shield]: https://img.shields.io/github/downloads/PiotrMachowski/Xiaomi-cloud-tokens-extractor/total\n\n\n# Xiaomi Cloud Tokens Extractor\n\nThis tool/script retrieves tokens for all devices connected to Xiaomi cloud and encryption keys for BLE devices.\n\nYou will need to provide Xiaomi Home credentials (_not ones from Roborock app_):\n- username (e-mail or Xiaomi Cloud account ID)\n- password\n- Xiaomi's server region (`cn` - China, `de` - Germany etc.). Leave empty to check all available\n\nIn return all of your devices connected to account will be listed, together with their name and IP address.\n\n## Windows\nDownload and run [token_extractor.exe](https://github.com/PiotrMachowski/Xiaomi-cloud-tokens-extractor/releases/latest/download/token_extractor.exe).\n\n## Linux & Home Assistant (in [SSH & Web Terminal](https://github.com/hassio-addons/addon-ssh))\n\nExecute following command:\n```bash\nbash <(curl -L https://github.com/PiotrMachowski/Xiaomi-cloud-tokens-extractor/raw/master/run.sh)\n```\n\n> If installation fails try Docker version\n\n## Docker & Home Assistant (in [SSH & Web Terminal](https://github.com/hassio-addons/addon-ssh))\n\nExecute following command:\n```bash\nbash <(curl -L https://github.com/PiotrMachowski/Xiaomi-cloud-tokens-extractor/raw/master/run_docker.sh)\n```\n\n> To run this command in HA you have to disable `protected mode` in addon's settings and restart it\n\n## Manual run in python\n\nDownload and unpack archive:\n```bash\nwget https://github.com/PiotrMachowski/Xiaomi-cloud-tokens-extractor/releases/latest/download/token_extractor.zip\nunzip token_extractor.zip\ncd token_extractor\n```\n\nInstall dependencies and run script:\n```bash\npip3 install -r requirements.txt\npython3 token_extractor.py\n```\n\n## Troubleshooting\n\nIf you have problems with using this tool try following solutions:\n- Make yourself sure that you provide correct credentials (_e.g. not ones from Roborock app!_)\n- Remove Cloudflare DNS\n- Disable network ad blockers (AdGuard, PiHole, etc.) and restrictions (UniFi Country Restriction etc.)\n- Open 2FA link on the same device that runs Tokens Extractor\n\n## Home Assistant additional tools\n\n* [Map extractor](https://github.com/PiotrMachowski/Home-Assistant-custom-components-Xiaomi-Cloud-Map-Extractor) - live map for Xiaomi Vacuums\n* [Map card](https://github.com/PiotrMachowski/lovelace-xiaomi-vacuum-map-card) - manual vacuum control from a Lovelace card\n\n\n<!-- piotrmachowski_support_links_start -->\n\n## Support\n\nIf you want to support my work with a donation you can use one of the following platforms:\n\n<table>\n  <tr>\n    <th>Platform</th>\n    <th>Payment methods</th>\n    <th>Link</th>\n    <th>Comment</th>\n  </tr>\n  <tr>\n    <td>Ko-fi</td>\n    <td>\n      <li>PayPal</li>\n      <li>Credit card</li>\n    </td>\n    <td>\n      <a href='https://ko-fi.com/piotrmachowski' target='_blank'><img height='35px' src='https://az743702.vo.msecnd.net/cdn/kofi3.png?v=0' border='0' alt='Buy Me a Coffee at ko-fi.com' /></a>\n    </td>\n    <td>\n      <li>No fees</li>\n      <li>Single or monthly payment</li>\n    </td>\n  </tr>\n  <tr>\n    <td>buycoffee.to</td>\n    <td>\n      <li>BLIK</li>\n      <li>Bank transfer</li>\n    </td>\n    <td>\n      <a href=\"https://buycoffee.to/piotrmachowski\" target=\"_blank\"><img src=\"https://buycoffee.to/btn/buycoffeeto-btn-primary.svg\" height=\"35px\" alt=\"Postaw mi kawÄ™ na buycoffee.to\"></a>\n    </td>\n    <td></td>\n  </tr>\n  <tr>\n    <td>PayPal</td>\n    <td>\n      <li>PayPal</li>\n    </td>\n    <td>\n      <a href=\"https://paypal.me/PiMachowski\" target=\"_blank\"><img src=\"https://www.paypalobjects.com/webstatic/mktg/logo/pp_cc_mark_37x23.jpg\" border=\"0\" alt=\"PayPal Logo\" height=\"35px\" style=\"height: auto !important;width: auto !important;\"></a>\n    </td>\n    <td>\n      <li>No fees</li>\n    </td>\n  </tr>\n  <tr>\n    <td>Revolut</td>\n    <td>\n      <li>Revolut</li>\n      <li>Credit Card</li>\n    </td>\n    <td>\n      <a href=\"https://revolut.me/314ma\" target=\"_blank\"><img src=\"https://www.revolut.com/favicon/android-chrome-192x192.png\" height=\"35px\" alt=\"Revolut\"></a>\n    </td>\n    <td>\n      <li>No fees</li>\n    </td>\n  </tr>\n</table>\n\n\n[ko_fi_shield]: https://img.shields.io/static/v1.svg?label=%20&message=Ko-Fi&color=F16061&logo=ko-fi&logoColor=white\n\n[ko_fi]: https://ko-fi.com/piotrmachowski\n\n[buycoffee_to_shield]: https://shields.io/badge/buycoffee.to-white?style=flat&labelColor=white&logo=data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAABhmlDQ1BJQ0MgcHJvZmlsZQAAKJF9kT1Iw1AUhU9TpaIVh1YQcchQnayIijhKFYtgobQVWnUweemP0KQhSXFxFFwLDv4sVh1cnHV1cBUEwR8QVxcnRRcp8b6k0CLGC4/3cd49h/fuA4R6malmxzigapaRisfEbG5FDLzChxB6MIZ+iZl6Ir2QgWd93VM31V2UZ3n3/Vm9St5kgE8knmW6YRGvE09vWjrnfeIwK0kK8TnxqEEXJH7kuuzyG+eiwwLPDBuZ1BxxmFgstrHcxqxkqMRTxBFF1ShfyLqscN7irJarrHlP/sJgXltOc53WEOJYRAJJiJBRxQbKsBClXSPFRIrOYx7+QcefJJdMrg0wcsyjAhWS4wf/g9+zNQuTE25SMAZ0vtj2xzAQ2AUaNdv+PrbtxgngfwautJa/UgdmPkmvtbTIEdC3DVxctzR5D7jcAQaedMmQHMlPSygUgPcz+qYcELoFulfduTXPcfoAZGhWSzfAwSEwUqTsNY93d7XP7d+e5vx+AIahcq//o+yoAAAABmJLR0QA/wD/AP+gvaeTAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH5wETCy4vFNqLzwAAAVpJREFUOMvd0rFLVXEYxvHPOedKJnKJhrDLuUFREULE7YDCMYj+AydpsCWiaKu29hZxiP4Al4aWwC1EdFI4Q3hqEmkIBI8ZChWXKNLLvS0/Qcza84V3enm/7/s878t/HxGkeTaIGziP+EB918nawu7Dq1d0e1+2J2bepnk2jFEUVVF+qKV51o9neBCaugfge70keoxxUbSWjrQ+4SUyzKZ5NlnDZdzGG7w4DIh+dtZEFntDA98l8S0MYwctNGrYz9WqKJePFLq80g5Sr+EHlnATp+NA+4qLaZ7FfzMrzbMBjGEdq8GrJMZnvAvFC/8wfAwjWMQ8XmMzaW9sdevNRgd3MFhvNpbaG1u/Dk2/hOc4gadVUa7Um425qii/7Z+xH9O4jwW8Cqv24Tru4hyeVEU588cfBMgpPMI9nMFe0BkFzVOYrYqycyQgQJLwTC2cDZCPeF8V5Y7jGb8BUpRicy7OU5MAAAAASUVORK5CYII=\n\n[buycoffee_to]: https://buycoffee.to/piotrmachowski\n\n[buy_me_a_coffee_shield]: https://img.shields.io/static/v1.svg?label=%20&message=Buy%20me%20a%20coffee&color=6f4e37&logo=buy%20me%20a%20coffee&logoColor=white\n\n[buy_me_a_coffee]: https://www.buymeacoffee.com/PiotrMachowski\n\n[paypal_me_shield]: https://img.shields.io/static/v1.svg?label=%20&message=PayPal.Me&logo=paypal\n\n[paypal_me]: https://paypal.me/PiMachowski\n\n[revolut_me_shield]: https://img.shields.io/static/v1.svg?label=%20&message=Revolut&logo=revolut\n\n[revolut_me]: https://revolut.me/314ma\n<!-- piotrmachowski_support_links_end -->"
        },
        {
          "name": "requirements.txt",
          "type": "blob",
          "size": 0.0400390625,
          "content": "requests\npycryptodome\ncharset-normalizer\n"
        },
        {
          "name": "run.sh",
          "type": "blob",
          "size": 0.4755859375,
          "content": "#!/usr/bin/env bash\nset -o errexit  # fail on first error\nset -o nounset  # fail on undef var\nset -o pipefail # fail on first error in pipe\n\ncurl --silent --fail --show-error --location --remote-name --remote-header-name\\\n  https://github.com/PiotrMachowski/Xiaomi-cloud-tokens-extractor/releases/latest/download/token_extractor.zip\nunzip token_extractor.zip\ncd token_extractor\npip3 install -r requirements.txt\npython3 token_extractor.py\ncd ..\nrm -rf token_extractor token_extractor.zip\n"
        },
        {
          "name": "run_docker.sh",
          "type": "blob",
          "size": 0.5419921875,
          "content": "#!/usr/bin/env bash\nset -o errexit  # fail on first error\nset -o nounset  # fail on undef var\nset -o pipefail # fail on first error in pipe\n\ncurl --silent --fail --show-error --location --remote-name --remote-header-name\\\n  https://github.com/PiotrMachowski/Xiaomi-cloud-tokens-extractor/releases/latest/download/token_extractor_docker.zip\nunzip token_extractor_docker.zip\ncd token_extractor_docker\ndocker_image=$(docker build -q .)\ndocker run --rm -it $docker_image\ndocker rmi $docker_image\ncd ..\nrm -rf token_extractor_docker token_extractor_docker.zip\n"
        },
        {
          "name": "token_extractor.py",
          "type": "blob",
          "size": 12.78515625,
          "content": "import base64\nimport hashlib\nimport hmac\nimport json\nimport os\nimport random\nimport time\nfrom getpass import getpass\nfrom sys import platform\n\nimport requests\nfrom Crypto.Cipher import ARC4\n\nif platform != \"win32\":\n    import readline\n\n\nclass XiaomiCloudConnector:\n\n    def __init__(self, username, password):\n        self._username = username\n        self._password = password\n        self._agent = self.generate_agent()\n        self._device_id = self.generate_device_id()\n        self._session = requests.session()\n        self._sign = None\n        self._ssecurity = None\n        self.userId = None\n        self._cUserId = None\n        self._passToken = None\n        self._location = None\n        self._code = None\n        self._serviceToken = None\n\n    def login_step_1(self):\n        url = \"https://account.xiaomi.com/pass/serviceLogin?sid=xiaomiio&_json=true\"\n        headers = {\n            \"User-Agent\": self._agent,\n            \"Content-Type\": \"application/x-www-form-urlencoded\"\n        }\n        cookies = {\n            \"userId\": self._username\n        }\n        response = self._session.get(url, headers=headers, cookies=cookies)\n        valid = response.status_code == 200 and \"_sign\" in self.to_json(response.text)\n        if valid:\n            self._sign = self.to_json(response.text)[\"_sign\"]\n        return valid\n\n    def login_step_2(self):\n        url = \"https://account.xiaomi.com/pass/serviceLoginAuth2\"\n        headers = {\n            \"User-Agent\": self._agent,\n            \"Content-Type\": \"application/x-www-form-urlencoded\"\n        }\n        fields = {\n            \"sid\": \"xiaomiio\",\n            \"hash\": hashlib.md5(str.encode(self._password)).hexdigest().upper(),\n            \"callback\": \"https://sts.api.io.mi.com/sts\",\n            \"qs\": \"%3Fsid%3Dxiaomiio%26_json%3Dtrue\",\n            \"user\": self._username,\n            \"_sign\": self._sign,\n            \"_json\": \"true\"\n        }\n        response = self._session.post(url, headers=headers, params=fields)\n        valid = response is not None and response.status_code == 200\n        if valid:\n            json_resp = self.to_json(response.text)\n            valid = \"ssecurity\" in json_resp and len(str(json_resp[\"ssecurity\"])) > 4\n            if valid:\n                self._ssecurity = json_resp[\"ssecurity\"]\n                self.userId = json_resp[\"userId\"]\n                self._cUserId = json_resp[\"cUserId\"]\n                self._passToken = json_resp[\"passToken\"]\n                self._location = json_resp[\"location\"]\n                self._code = json_resp[\"code\"]\n            else:\n                if \"notificationUrl\" in json_resp:\n                    print(\"Two factor authentication required, please use following url and restart extractor:\")\n                    print(json_resp[\"notificationUrl\"])\n                    print()\n        return valid\n\n    def login_step_3(self):\n        headers = {\n            \"User-Agent\": self._agent,\n            \"Content-Type\": \"application/x-www-form-urlencoded\"\n        }\n        response = self._session.get(self._location, headers=headers)\n        if response.status_code == 200:\n            self._serviceToken = response.cookies.get(\"serviceToken\")\n        return response.status_code == 200\n\n    def login(self):\n        self._session.cookies.set(\"sdkVersion\", \"accountsdk-18.8.15\", domain=\"mi.com\")\n        self._session.cookies.set(\"sdkVersion\", \"accountsdk-18.8.15\", domain=\"xiaomi.com\")\n        self._session.cookies.set(\"deviceId\", self._device_id, domain=\"mi.com\")\n        self._session.cookies.set(\"deviceId\", self._device_id, domain=\"xiaomi.com\")\n        if self.login_step_1():\n            if self.login_step_2():\n                if self.login_step_3():\n                    return True\n                else:\n                    print(\"Unable to get service token.\")\n            else:\n                print(\"Invalid login or password.\")\n        else:\n            print(\"Invalid username.\")\n        return False\n\n    def get_homes(self, country):\n        url = self.get_api_url(country) + \"/v2/homeroom/gethome\"\n        params = {\n            \"data\": '{\"fg\": true, \"fetch_share\": true, \"fetch_share_dev\": true, \"limit\": 300, \"app_ver\": 7}'}\n        return self.execute_api_call_encrypted(url, params)\n\n    def get_devices(self, country, home_id, owner_id):\n        url = self.get_api_url(country) + \"/v2/home/home_device_list\"\n        params = {\n            \"data\": '{\"home_owner\": ' + str(owner_id) +\n            ',\"home_id\": ' + str(home_id) +\n            ',  \"limit\": 200,  \"get_split_device\": true, \"support_smart_home\": true}'\n        }\n        return self.execute_api_call_encrypted(url, params)\n\n    def get_dev_cnt(self, country):\n        url = self.get_api_url(country) + \"/v2/user/get_device_cnt\"\n        params = {\n            \"data\": '{ \"fetch_own\": true, \"fetch_share\": true}'\n        }\n        return self.execute_api_call_encrypted(url, params)\n\n    def get_beaconkey(self, country, did):\n        url = self.get_api_url(country) + \"/v2/device/blt_get_beaconkey\"\n        params = {\n            \"data\": '{\"did\":\"' + did + '\",\"pdid\":1}'\n        }\n        return self.execute_api_call_encrypted(url, params)\n\n    def execute_api_call_encrypted(self, url, params):\n        headers = {\n            \"Accept-Encoding\": \"identity\",\n            \"User-Agent\": self._agent,\n            \"Content-Type\": \"application/x-www-form-urlencoded\",\n            \"x-xiaomi-protocal-flag-cli\": \"PROTOCAL-HTTP2\",\n            \"MIOT-ENCRYPT-ALGORITHM\": \"ENCRYPT-RC4\",\n        }\n        cookies = {\n            \"userId\": str(self.userId),\n            \"yetAnotherServiceToken\": str(self._serviceToken),\n            \"serviceToken\": str(self._serviceToken),\n            \"locale\": \"en_GB\",\n            \"timezone\": \"GMT+02:00\",\n            \"is_daylight\": \"1\",\n            \"dst_offset\": \"3600000\",\n            \"channel\": \"MI_APP_STORE\"\n        }\n        millis = round(time.time() * 1000)\n        nonce = self.generate_nonce(millis)\n        signed_nonce = self.signed_nonce(nonce)\n        fields = self.generate_enc_params(url, \"POST\", signed_nonce, nonce, params, self._ssecurity)\n        response = self._session.post(url, headers=headers, cookies=cookies, params=fields)\n        if response.status_code == 200:\n            decoded = self.decrypt_rc4(self.signed_nonce(fields[\"_nonce\"]), response.text)\n            return json.loads(decoded)\n        return None\n\n    @staticmethod\n    def get_api_url(country):\n        return \"https://\" + (\"\" if country == \"cn\" else (country + \".\")) + \"api.io.mi.com/app\"\n\n    def signed_nonce(self, nonce):\n        hash_object = hashlib.sha256(base64.b64decode(self._ssecurity) + base64.b64decode(nonce))\n        return base64.b64encode(hash_object.digest()).decode('utf-8')\n\n    @staticmethod\n    def signed_nonce_sec(nonce, ssecurity):\n        hash_object = hashlib.sha256(base64.b64decode(ssecurity) + base64.b64decode(nonce))\n        return base64.b64encode(hash_object.digest()).decode('utf-8')\n\n    @staticmethod\n    def generate_nonce(millis):\n        nonce_bytes = os.urandom(8) + (int(millis / 60000)).to_bytes(4, byteorder='big')\n        return base64.b64encode(nonce_bytes).decode()\n\n    @staticmethod\n    def generate_agent():\n        agent_id = \"\".join(map(lambda i: chr(i), [random.randint(65, 69) for _ in range(13)]))\n        return f\"Android-7.1.1-1.0.0-ONEPLUS A3010-136-{agent_id} APP/xiaomi.smarthome APPV/62830\"\n\n    @staticmethod\n    def generate_device_id():\n        return \"\".join(map(lambda i: chr(i), [random.randint(97, 122) for _ in range(6)]))\n\n    @staticmethod\n    def generate_signature(url, signed_nonce, nonce, params):\n        signature_params = [url.split(\"com\")[1], signed_nonce, nonce]\n        for k, v in params.items():\n            signature_params.append(f\"{k}={v}\")\n        signature_string = \"&\".join(signature_params)\n        signature = hmac.new(base64.b64decode(signed_nonce), msg=signature_string.encode(), digestmod=hashlib.sha256)\n        return base64.b64encode(signature.digest()).decode()\n\n    @staticmethod\n    def generate_enc_signature(url, method, signed_nonce, params):\n        signature_params = [str(method).upper(), url.split(\"com\")[1].replace(\"/app/\", \"/\")]\n        for k, v in params.items():\n            signature_params.append(f\"{k}={v}\")\n        signature_params.append(signed_nonce)\n        signature_string = \"&\".join(signature_params)\n        return base64.b64encode(hashlib.sha1(signature_string.encode('utf-8')).digest()).decode()\n\n    @staticmethod\n    def generate_enc_params(url, method, signed_nonce, nonce, params, ssecurity):\n        params['rc4_hash__'] = XiaomiCloudConnector.generate_enc_signature(url, method, signed_nonce, params)\n        for k, v in params.items():\n            params[k] = XiaomiCloudConnector.encrypt_rc4(signed_nonce, v)\n        params.update({\n            'signature': XiaomiCloudConnector.generate_enc_signature(url, method, signed_nonce, params),\n            'ssecurity': ssecurity,\n            '_nonce': nonce,\n        })\n        return params\n\n    @staticmethod\n    def to_json(response_text):\n        return json.loads(response_text.replace(\"&&&START&&&\", \"\"))\n\n    @staticmethod\n    def encrypt_rc4(password, payload):\n        r = ARC4.new(base64.b64decode(password))\n        r.encrypt(bytes(1024))\n        return base64.b64encode(r.encrypt(payload.encode())).decode()\n\n    @staticmethod\n    def decrypt_rc4(password, payload):\n        r = ARC4.new(base64.b64decode(password))\n        r.encrypt(bytes(1024))\n        return r.encrypt(base64.b64decode(payload))\n\n\ndef print_tabbed(value, tab):\n    print(\" \" * tab + value)\n\n\ndef print_entry(key, value, tab):\n    if value:\n        print_tabbed(f'{key + \":\": <10}{value}', tab)\n\n\ndef main():\n    servers = [\"cn\", \"de\", \"us\", \"ru\", \"tw\", \"sg\", \"in\", \"i2\"]\n    servers_str = \", \".join(servers)\n    print(\"Username (email or user ID):\")\n    username = input()\n    print(\"Password:\")\n    password = getpass(\"\")\n    print(f\"Server (one of: {servers_str}) Leave empty to check all available:\")\n    server = input()\n    while server not in [\"\", *servers]:\n        print(f\"Invalid server provided. Valid values: {servers_str}\")\n        print(\"Server:\")\n        server = input()\n\n    print()\n    if not server == \"\":\n        servers = [server]\n\n    connector = XiaomiCloudConnector(username, password)\n    print(\"Logging in...\")\n    logged = connector.login()\n    if logged:\n        print(\"Logged in.\")\n        print()\n        for current_server in servers:\n            hh = []\n            homes = connector.get_homes(current_server)\n            if homes is not None:\n                for h in homes['result']['homelist']:\n                    hh.append({'home_id': h['id'], 'home_owner': connector.userId})\n            dev_cnt = connector.get_dev_cnt(current_server)\n            if dev_cnt is not None:\n                for h in dev_cnt[\"result\"][\"share\"][\"share_family\"]:\n                    hh.append({'home_id': h['home_id'], 'home_owner': h['home_owner']})\n\n            if len(hh) == 0:\n                print(f'No homes found for server \"{current_server}\".')\n                continue\n\n            for home in hh:\n                devices = connector.get_devices(current_server, home['home_id'], home['home_owner'])\n                if devices is not None:\n                    if devices[\"result\"][\"device_info\"] is None or len(devices[\"result\"][\"device_info\"]) == 0:\n                        print(f'No devices found for server \"{current_server}\" @ home \"{home[\"home_id\"]}\".')\n                        continue\n                    print(f'Devices found for server \"{current_server}\" @ home \"{home[\"home_id\"]}\":')\n                    for device in devices[\"result\"][\"device_info\"]:\n                        print_tabbed(\"---------\", 3)\n                        if \"name\" in device:\n                            print_entry(\"NAME\", device[\"name\"], 3)\n                        if \"did\" in device:\n                            print_entry(\"ID\", device[\"did\"], 3)\n                            if \"blt\" in device[\"did\"]:\n                                beaconkey = connector.get_beaconkey(current_server, device[\"did\"])\n                                if beaconkey and \"result\" in beaconkey and \"beaconkey\" in beaconkey[\"result\"]:\n                                    print_entry(\"BLE KEY\", beaconkey[\"result\"][\"beaconkey\"], 3)\n                        if \"mac\" in device:\n                            print_entry(\"MAC\", device[\"mac\"], 3)\n                        if \"localip\" in device:\n                            print_entry(\"IP\", device[\"localip\"], 3)\n                        if \"token\" in device:\n                            print_entry(\"TOKEN\", device[\"token\"], 3)\n                        if \"model\" in device:\n                            print_entry(\"MODEL\", device[\"model\"], 3)\n                    print_tabbed(\"---------\", 3)\n                    print()\n                else:\n                    print(f\"Unable to get devices from server {current_server}.\")\n    else:\n        print(\"Unable to log in.\")\n\n    print()\n    print(\"Press ENTER to finish\")\n    input()\n\n\nif __name__ == \"__main__\":\n    main()\n"
        },
        {
          "name": "token_extractor.spec",
          "type": "blob",
          "size": 0.7998046875,
          "content": "# -*- mode: python ; coding: utf-8 -*-\n\nblock_cipher = None\n\n\na = Analysis(['token_extractor.py'],\n             binaries=[],\n             datas=[],\n             hiddenimports=[],\n             hookspath=[],\n             runtime_hooks=[],\n             excludes=[],\n             win_no_prefer_redirects=False,\n             win_private_assemblies=False,\n             cipher=block_cipher,\n             noarchive=False)\npyz = PYZ(a.pure, a.zipped_data,\n             cipher=block_cipher)\nexe = EXE(pyz,\n          a.scripts,\n          a.binaries,\n          a.zipfiles,\n          a.datas,\n          [],\n          name='token_extractor',\n          debug=False,\n          bootloader_ignore_signals=False,\n          strip=False,\n          upx=True,\n          upx_exclude=[],\n          runtime_tmpdir=None,\n          console=True )\n"
        }
      ]
    }
  ]
}