{
  "metadata": {
    "timestamp": 1736566739547,
    "page": 295,
    "hasNextPage": true,
    "endCursor": "Y3Vyc29yOjMwMA==",
    "completionStatus": "IN_PROGRESS"
  },
  "repositories": [
    {
      "nameWithOwner": "quackduck/devzat",
      "stars": 3727,
      "defaultBranch": "main",
      "files": [
        {
          "name": ".gitattributes",
          "type": "blob",
          "size": 0.052734375,
          "content": "**.pb.go -diff -merge\n**.pb.go linguist-generated=true"
        },
        {
          "name": ".github",
          "type": "tree",
          "content": null
        },
        {
          "name": ".gitignore",
          "type": "blob",
          "size": 0.3388671875,
          "content": "*.DS_Store\n.vscode\n/devzat\n.idea\n/dist\nslackAPI.txt*\nadminPass.txt\n*.gob\n*.swp\ndevzat-data/log.txt\ndevzat-data/bans.json\ndevzat-data/user-prefs\ndevzat-data/tokens.json\nallusers.json\niptables.sh\ntwitter-creds.json\ntwitter-creds.json.bak\ndevzat-creds.yml\ndevzat-sshkey\ndevzat-sshkey.pub\ndevzat-config.yml\nadmins.json\n*.bak\ndevzat.yml\nintegration.yml"
        },
        {
          "name": ".gitpod.yml",
          "type": "blob",
          "size": 0.3095703125,
          "content": "# This configuration file was automatically generated by Gitpod.\n# Please adjust to your needs (see https://www.gitpod.io/docs/config-gitpod-file)\n# and commit this file to your remote git repository to share the goodness with others.\n\ntasks:\n  - init: go get && go build ./... && go test ./...\n    command: go run\n\n\n"
        },
        {
          "name": "Admin's Manual.md",
          "type": "blob",
          "size": 6.9677734375,
          "content": "# Devzat Admin's Manual\n\nThis document is for those who want to manage a self-hosted Devzat server.\n\nFeel free to make a [new issue](https://github.com/quackduck/devzat/issues) if something doesn't work.\n\n## Installation\n```shell\ngit clone https://github.com/quackduck/devzat\ncd devzat\n```\nTo compile Devzat, you will need Go installed with a minimum version of 1.17.\n\nNow run `go install` to install the Devzat binary globally, or run `go build` to build and keep the binary in the working directory.\n\nYou may need to generate a new key pair for your server using the `ssh-keygen` command. When prompted, save as `devzat-sshkey` since this is the default location (it can be changed in the config).\nWhile you can use the same key pair that your user account has, it is recommended to use a new key pair.\n\n## Usage\n\n```shell\n./devzat # use without \"./\" for a global binary\n```\n\nDevzat listens on port 2221 for new SSH connections by default. Users can now join using `ssh -p 2221 <server-hostname>`.\n\nSet the environment variable `PORT` to a different port number or edit your config to change what port Devzat listens for SSH connections on. Users would then run `ssh -p <port> <server-hostname>` to join.\n\n## Configuration\n\nDevzat writes the default config file if one isn't found, so you do not need to make one before using Devzat. \n\nThe default location Devzat looks for a config file is `devzat.yml` in the current directory. Alternatively, it uses the path set in the `DEVZAT_CONFIG` environment variable.\n\nAn example config file:\n```yaml\n# what port to host a server on ($PORT overrides this)\nport: 2221\n# an alternate port to avoid firewalls\nalt_port: 443\n# what port to host profiling on (unimportant)\nprofile_port: 5555\n# where to store data such as bans and logs\ndata_dir: devzat-data\n# where the SSH private key is stored\nkey_file: devzat-sshkey\n# where an integration config is stored (optional)\nintegration_config: devzat-integrations.yml\n# whether to censor messages (optional)\ncensor: true\n# a list of admin IDs and notes about them\nadmins:\n  d6acd2f5c5a8ef95563883032ef0b7c0239129b2d3672f964e5711b5016e05f5: 'Arkaeriit: github.com/Arkaeriit'\n  ff7d1586cdecb9fbd9fcd4c9548522493c29172bc3121d746c83b28993bd723e: 'Ishan Goel: quackduck'\n```\n\n### Using admin power\n\nAs an admin, you can ban, unban and kick users. When logged into the chat, you can run commands like these:\n```shell\nban <user>\nban <user> 1h10m\nunban <user ID or IP>\nkick <user>\n```\n\nIf running these commands makes Devbot complain about authorization, you need to add your ID under the `admins` key in your config file (`devzat-config.yml` by default).\n\n### Enabling a user allowlist\n\nDevzat can use be used as a private chatroom. Add this to your config:\n\n```yaml\nprivate: true # enable allowlist checking\nallowlist: \n  272b326d7d5e9a6b1d98a10b453bdc8cc950fc15cae2c2e858e30645c72ae7c0: 'John Doe'\n  ...\n```\n\nThe `allowlist` has the same format as the `admins` list. Add the IDs of the allowed users and info about that user (this is to make IDs easier to identify when editing the config file, and isn't used by Devzat)\n\nAll admins are allowed even if their ID is not in the allowlist. So, if everyone on the private server is an admin, an allowlist isn't necessary, just enable private mode.\n\nMessage backlog on `#main` is disabled in private chats. Only those logged in at the same time as you can read your messages.\n\n### Enabling integrations\n\nDevzat includes features that may not be needed by self-hosted instances. These are called integrations.\n\nYou can enable these integrations by setting the `integration_config` in your config file to some path:\n\n```yaml\nintegration_config: devzat-integrations.yml\n```\nNow make a new file at that path. This is your integration config file.\n\n#### Using the Slack integration\n\nDevzat supports a bridge to Slack. You'll need a Slack bot token so Devzat can post to and receive messages from Slack. Follow the guide [here](https://api.slack.com/authentication/basics) to get your token and add a Slack app to your workspace. Ensure it has read and write scopes.\n\nAdd your bot token to your integration config file. The `prefix` key defines what messages from Slack rendered in Devzat will be prefixed with. Find the channel ID of the channel you want to bridge to with a right-click on it in Slack.\n\n```yaml\nslack:\n    token: xoxb-XXXXXXXXXX-XXXXXXXXXXXX-XXXXXXXXXXXXXXXXXXXXXXXX\n    channel_id: XXXXXXXXXXX # usually starts with a C, but could be a G or D\n    prefix: Slack\n```\n\n#### Using the Discord integration\n\nDevzat supports a bridge to Discord. You'll need a Discord bot token so Devzat can post to and receive messages from Discord. Follow the guide [here](https://www.writebots.com/discord-bot-token) to set up your bot and ensure it will have the \"Send Messages\", \"Read Message History\", and \"Manage Webhooks\" permissions.\n\nAdd your bot token to your integration config file. The `prefix` key defines what messages from Discord rendered in Devzat will be prefixed with. Find the channel ID of the channel you want to bridge to with a right-click on it.\n\n```yaml\ndiscord:\n    token: XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX\n    channel_id: XXXXXXXXXXXXXXXXXXX\n    prefix: Discord\n    compact_mode: true # optional: disables avatars so messages take up less vertical space\n```\n\n#### Using the Twitter integration\nDevzat supports posting updates about who is online to Twitter. Start by creating a new app through a [Twitter developer account](https://developer.twitter.com/en/apply/user) (note: Twitter's API is now paid).\n\nNow add in the relevant keys to your integration config file:\n```yaml\ntwitter:\n    consumer_key: XXXXXXXXXXXXXXXXXXXXXXXXX\n    consumer_secret: XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX\n    access_token: XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX\n    access_token_secret: XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX\n```\n\n### Using the plugin API integration\n\nDevzat includes a built-in gRPC plugin API. This is useful for building your own integration or using a third-party one.\n\nDocumentation for using the gRPC API is available [here](plugin/README.md). This integration stores API tokens inside the data directory.\n\n```yaml\nrpc:\n    port: 5556 # port to listen on for gRPC clients\n```\n\nUse the token issuing commands detailed in the [plugin documentation](plugin/README.md) to allow clients to authenticate.\n\nYou may also hard-code a key that can be used as an authentication token, but this is not recommended. This option can be useful for server owners trying to keep some API clients always online, since this key cannot be revoked by admins (unlike tokens).\n\n```yaml\n    key: \"some string\" # a string that gRPC clients authenticate with (optional)\n```\n\nYou can use any number of integrations together.\n\nThere are 4 environment variables you can set to quickly disable integrations on the command line:\n* `DEVZAT_OFFLINE_TWITTER=true` will disable Twitter\n* `DEVZAT_OFFLINE_SLACK=true` will disable Slack\n* `DEVZAT_OFFLINE_RPC=true` will disable the gRPC server\n* `DEVZAT_OFFLINE=true` will disable all integrations.\n\n"
        },
        {
          "name": "LICENSE",
          "type": "blob",
          "size": 1.0419921875,
          "content": "MIT License\n\nCopyright (c) 2023 Ishan Goel\n\nPermission is hereby granted, free of charge, to any person obtaining a copy\nof this software and associated documentation files (the \"Software\"), to deal\nin the Software without restriction, including without limitation the rights\nto use, copy, modify, merge, publish, distribute, sublicense, and/or sell\ncopies of the Software, and to permit persons to whom the Software is\nfurnished to do so, subject to the following conditions:\n\nThe above copyright notice and this permission notice shall be included in all\ncopies or substantial portions of the Software.\n\nTHE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\nIMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\nFITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\nAUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\nLIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\nOUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE\nSOFTWARE.\n"
        },
        {
          "name": "README-CN.md",
          "type": "blob",
          "size": 8.3330078125,
          "content": "<div align=\"center\">\n<img src=\"https://github.com/quackduck/devzat/assets/38882631/046fbb4d-dff2-41e9-a61c-271d0820473e\" style=\"height: 100px; border-radius: 50px;\" />\n</div>\n\n***\n\n<a href=\"https://www.producthunt.com/posts/devzat?utm_source=badge-top-post-badge&utm_medium=badge&utm_souce=badge-devzat\" target=\"_blank\"><img src=\"https://api.producthunt.com/widgets/embed-image/v1/top-post-badge.svg?post_id=298678&theme=light&period=daily\" alt=\"Devzat - Chat with other devs over SSH in your Terminal | Product Hunt\" style=\"width: 250px; height: 54px;\" width=\"250\" height=\"54\" /></a>\n\nå¼€å‘äººå‘˜åœ¨å“ªé‡Œï¼ŸDevzatï¼\n\nDevzatæ˜¯ä¸€ä¸ªè‡ªå®šä¹‰SSHæœåŠ¡å™¨ï¼Œå®ƒèƒ½å°†ä½ å¸¦å…¥ä¸€ä¸ªèŠå¤©å®¤è€Œéshell promptã€‚ç”±äºæ‰€æœ‰å¹³å°ï¼ˆç”šè‡³æ‰‹æœºï¼‰ä¸Šéƒ½æœ‰ SSH åº”ç”¨ç¨‹åºï¼Œå› æ­¤ä½ å¯ä»¥åœ¨ä»»ä½•è®¾å¤‡ä¸Šè¿æ¥åˆ° Devzatï¼\n\n\n<!-- <img src=\"https://user-images.githubusercontent.com/38882631/115499526-a4d70280-a280-11eb-8723-817f54eccf3e.png\" height=400px /> -->\n\nè¿™æ˜¯æœ‰ä¸€å¤©å½•åˆ¶çš„è®°å½•:\n[![asciicast](https://asciinema.org/a/477083.svg)](https://asciinema.org/a/477083?speed=3)\n## ä½¿ç”¨æ–¹æ³•\n\nè¯•è¯•çœ‹:\n\n```sh\nssh devzat.hackclub.com\n```\n\nå¦‚æœè¿™æ˜¯ç¬¬ä¸€æ¬¡ç™»å½•ï¼Œå¯ä»¥ä½¿ç”¨ SSH ç”¨æˆ·åé€‰æ‹©æ˜¾ç¤ºåç§°ã€‚ä¾‹å¦‚ï¼Œå¦‚æœæ‚¨æƒ³è¢«ç§°ä¸º â€œwenjieâ€ï¼Œå¯ä»¥è¿è¡Œï¼š\n```sh\nssh wenjie@devzat.hackclub.com\n```\nå¦‚æœæƒ³åœ¨é¦–æ¬¡ç™»å½•åæ›´æ”¹æ˜¾ç¤ºåç§°ï¼Œåº”åœ¨ç™»å½•åä½¿ç”¨ `nick` å‘½ä»¤ã€‚\n\n\nå¦‚æœæ‚¨åœ¨é˜²ç«å¢™ä¸‹ï¼Œæ‚¨ä»ç„¶å¯ä»¥é€šè¿‡ç«¯å£ 443 åŠ å…¥ï¼š\n```sh\nssh devzat.hackclub.com -p 443\n```\n\nå¦‚æœå°†å…¶æ·»åŠ åˆ° `~/.ssh/config`ï¼š\n```ssh\nHost chat\n    HostName devzat.hackclub.com\n```\n\næ‚¨åªéœ€ï¼š\n```sh\nssh chat\n```\n\næˆ‘ä»¬è¿˜æœ‰ä¸€ä¸ª Slack æ¡¥ï¼å¦‚æœä½ åœ¨ [Hack Club](https://hackclub.com) Slack ä¸Šï¼Œè¯·æŸ¥çœ‹ `#ssh-chat-bridge` é¢‘é“ï¼\n\nå¦‚æœé‡åˆ°é—®é¢˜ï¼Œè¯·éšæ—¶æäº¤ [æ–°issue](https://github.com/quackduck/devzat/issues)ã€‚\n\næŸ¥çœ‹Devzatä¸»æœåŠ¡å™¨çš„ [ç«™ç‚¹çŠ¶æ€](https://stats.uptimerobot.com/kxMQqfYk4y) ä»¥æ£€æŸ¥æ£€æŸ¥æ˜¯å¦å¯èƒ½å‡ºç°æ•…éšœã€‚\n\n\n### æƒ³è¦æ‰˜ç®¡è‡ªå·±çš„å®ä¾‹ï¼Ÿ\n\nå¿«é€Ÿå¼€å§‹:\n```shell\ngit clone https://github.com/quackduck/devzat && cd devzat\ngo install # or build, if you want to keep things pwd\nssh-keygen -qN '' -f devzat-sshkey # new ssh host key for the server\ndevzat # run! the default config is used & written automatically\n```\nè¿™äº›å‘½ä»¤ç”¨äºä¸‹è½½ã€æ„å»ºã€è®¾ç½®å’Œè¿è¡Œ Devzat æœåŠ¡å™¨ï¼Œé»˜è®¤ç«¯å£ä¸º 2221ï¼ˆå¯é€šè¿‡è®¾ç½® `$PORT` æ›´æ”¹ï¼‰ã€‚\n\næŸ¥çœ‹[Admin's Manual](Admin's%20Manual.md)ï¼Œäº†è§£å®Œæ•´çš„è‡ªæ‰˜ç®¡æ–‡æ¡£ï¼\n\n### æ‹’ç»æƒé™ï¼Ÿ\n\nDevzat ä½¿ç”¨å…¬é’¥æ¥è¯†åˆ«ç”¨æˆ·ã€‚å¦‚æœæ‚¨è¢«æ‹’ç»è®¿é—®ï¼š`foo@devzat.hackclub.com: Permission denied (publickey)`ï¼Œ å°è¯•ç™»å½•æ— éœ€å¯†é’¥çš„ **443** ç«¯å£ã€‚\n`ssh devzat.hackclub.com -p 443`\n\n\n\n### å¸®åŠ©\n\n```text\næ³¨ï¼šèŠå¤©å®¤ä¸­è¾“å…¥Helpè·å–çš„æ˜¯è‹±æ–‡åŸå§‹æ–‡æœ¬\n\næ¬¢è¿æ¥åˆ°Devzatï¼Devzaté€šè¿‡SSHèŠå¤©ï¼šgithub.com/quackduck/devzat\nç”±äºæ‰€æœ‰å¹³å°ä¸Šï¼ŒåŒ…æ‹¬ç§»åŠ¨è®¾å¤‡ä¸Šéƒ½æœ‰ SSH åº”ç”¨ï¼Œä½ å¯ä»¥ä»ä»»ä½•åœ°æ–¹åŠ å…¥ã€‚\n\nè¿è¡Œ `cmds` æŸ¥çœ‹å‘½ä»¤åˆ—è¡¨ã€‚\n\næœ‰è¶£çš„åŠŸèƒ½:\nâ€¢ æˆ¿é—´ï¼è¿è¡Œ cd æŸ¥çœ‹æ‰€æœ‰æˆ¿é—´ï¼Œä½¿ç”¨ cd #foo åŠ å…¥æ–°æˆ¿é—´ã€‚\nâ€¢ æ”¯æŒ Markdownï¼è¡¨æ ¼ã€æ ‡é¢˜ã€æ–œä½“ç­‰ä¸€åˆ‡ã€‚åªéœ€ç”¨ \\n ä»£æ›¿æ¢è¡Œç¬¦å³å¯ã€‚\nâ€¢ ä»£ç è¯­æ³•é«˜äº® ä½¿ç”¨ Markdown fenceså‘é€ä»£ç ã€‚è¿è¡Œ eg-code æŸ¥çœ‹ç¤ºä¾‹ã€‚\nâ€¢ ç§èŠï¼ä½¿ç”¨ =user <msg> å‘é€å¿«é€Ÿ DMï¼Œæˆ–é€šè¿‡è¿è¡Œ cd @user ç•™åœ¨ DM ä¸­ã€‚\nâ€¢ æ”¯æŒæ—¶åŒºï¼Œä½¿ç”¨ tz Continentï¼ˆå·ï¼‰/Cityï¼ˆåŸå¸‚ï¼‰è®¾ç½®æ—¶åŒºã€‚\n\nâ€¢ å†…ç½®Tic Tan Toeï¼ˆäº”å­æ£‹ï¼‰å’ŒHangman (çŒœå•è¯ï¼‰ï¼è¿è¡Œ tic æˆ–è€… hang<word> æ¥å¼€å§‹æ–°æ¸¸æˆ\nâ€¢ emoji æ›¿æ¢ï¼:rocket: => ğŸš€ ï¼ˆå°±åƒåœ¨ Slack å’Œ Discord ä¸Šä¸€æ ·ï¼‰\n\nåœ¨æ›¿æ¢æ¢è¡Œç¬¦æ—¶ï¼Œæˆ‘ç»å¸¸ä½¿ç”¨ bulkseotools.com/add-remove-line-breaks.phpã€‚\n\nç”± Ishan Goel ç”¨æœ‹å‹ä»¬çš„åˆ›æ„åˆ¶ä½œè€Œæˆã€‚\næ„Ÿè°¢ Caleb Denio å€Ÿå‡ºä»–çš„æœåŠ¡å™¨ï¼\n```\n### æŒ‡ä»¤\n```text\næ³¨ï¼šèŠå¤©å®¤ä¸­è¾“å…¥cmds/restè·å–çš„æ˜¯è‹±æ–‡åŸå§‹æ–‡æœ¬\nCommands\n   =<user>   <msg>           å‘ <user> å‘é€ç§èŠä¿¡æ¯ <msg>\n   users                     åˆ—å‡ºç”¨æˆ·\n   color     <color>         æ”¹å˜åå­—é¢œè‰²\n   exit                      ç¦»å¼€èŠå¤©å®¤\n   help                      å±•ç¤ºå¸®åŠ©ä¿¡æ¯\n   man       <cmd>           è·å–ç‰¹å®šå‘½ä»¤å¸®åŠ©\n   emojis                    æŸ¥çœ‹emojisåˆ—è¡¨\n   bell      on|off|all      ANSIé“ƒå£°å¼€å¯(on)/ä»ä¸ï¼ˆoffï¼‰/æ¯æ¡æ¶ˆæ¯å‡å“ï¼ˆallï¼‰\n   clear                     æ¸…å±\n   hang      <char|word>     ç© hangman\n   tic       <cell num>      ç© tic tac toe!\n   devmonk                   æµ‹è¯•æ‰“å­—é€Ÿåº¦\n   cd        #room|user      åŠ å…¥ #roomï¼Œç§èŠç”¨æˆ·æˆ–è¿è¡Œ cd æŸ¥çœ‹åˆ—è¡¨\n   tz        <zone> [24h]    è®¾ç½®æ‚¨çš„ IANA æ—¶åŒºï¼ˆä¾‹å¦‚ tz Asia/Dubaiï¼‰ï¼Œå¹¶å¯é€‰æ‹©è®¾ç½® 24h\n   nick      <name>          æ”¹å˜ç”¨æˆ·å\n   pronouns  @user|pronouns  è®¾ç½®ä½ çš„æ€§åˆ«ä»£è¯æˆ–è·å–å…¶ä»–ç”¨æˆ·çš„æ€§åˆ«ä»£è¯\n   theme     <theme>|list    æ›´æ”¹è¯­æ³•é«˜äº®ä¸»é¢˜\n   rest                      ä¸å¸¸ç”¨çš„å‘½ä»¤åˆ—è¡¨ \n   cmds                      å±•ç¤ºæ­¤å‘½ä»¤\n```\n```\nThe rest\n   people                  æŸ¥çœ‹åŠ å…¥çš„äººçš„ä¿¡æ¯\n   id       <user>         è·å–ç”¨æˆ·çš„å”¯ä¸€ID(hashed key)\n   admins                  æ‰“å°æ‰€æœ‰ç®¡ç†å‘˜çš„ ID(hashed key)\n   eg-code  [big]          è¯­æ³•é«˜äº®ä»£ç ç¤ºä¾‹\n   lsbans                  è¢«ç¦è¨€çš„ ID åˆ—è¡¨\n   ban      <user>         ç¦è¨€ <user> (admin)\n   unban    <IP|ID> [dur]  è§£é™¤å¯¹æŸäººçš„ç¦è¨€ï¼Œå¯é€‰æ‹©æŒç»­æ—¶é—´ï¼ˆadminï¼‰\n   kick     <user>         è¸¢å‡º <user>ç™»å½• (admin)\n   art                     å±•ç¤ºä¸€äº›ç†ŠçŒ«çš„å›¾\n   pwd                     å±•ç¤ºä½ çš„å½“å‰æˆ¿é—´\n   shrug                   Â¯\\_(ãƒ„)_/Â¯\n```\næç¤ºï¼šå¦‚æœæ˜µç§°å› ç½‘ç»œå»¶è¿Ÿè€Œè¢«å ç”¨ï¼Œ`kick` å¯ä»¥å¸®åŠ©è¸¢å‡ºä¹‹å‰æ˜µç§°ã€‚\n\n## é›†æˆ\n\nåœ¨è‡ªæ‰˜ç®¡å®ä¾‹ä¸­ï¼ŒDevzat å¯ä¸ Slack å’Œ/æˆ– Discord é›†æˆä»¥æ¡¥æ¥æ¶ˆæ¯ï¼Œå¹¶ä¸ Twitter é›†æˆä»¥å‘å¸ƒæ–°ç”¨æˆ·å…¬å‘Šã€‚\nè¯·å‚é˜… [Admin's Manual](Admin's%20Manual.md) è·å¾—æ›´å¤šä¿¡æ¯ã€‚\n\n\nDevzat æ‹¥æœ‰ä¸€ä¸ªæ’ä»¶ APIï¼Œæ‚¨å¯ä»¥ç”¨å®ƒæ¥é›†æˆè‡ªå·±çš„æœåŠ¡ï¼š [documentation](plugin/README.md)ã€‚\næ‚¨å¯ä»¥éšæ„åœ¨ä¸»å®ä¾‹ä¸­æ·»åŠ æ’ä»¶ã€‚åªéœ€åœ¨æœåŠ¡å™¨ä¸Šç”³è¯·ä¸€ä¸ª token å³å¯ã€‚\n\n\n\n\n## æ˜Ÿæ ‡å†å²\n\n[![Stargazers over time](https://starchart.cc/quackduck/devzat.svg)](https://starchart.cc/quackduck/devzat)\n\n\n### å‚ä¸è€…\n\næ‚¨å¯èƒ½è®¤è¯†çš„äººåŠ å…¥è€…ï¼š\n\nZach Latta - Founder of Hack Club: _\"omg amazing! this is so awesome\"_  \nAnt Wilson - Co founder, Supabase: [_\"brilliant!\"_](https://twitter.com/AntWilson/status/1396444302721445889)  \nBereket [@heybereket](https://twitter.com/heybereket): _\"this is pretty cool\"_  \nAyush [@ayshptk](https://twitter.com/ayshptk): _\"Can I double star the repo somehow :pleading_face:\"_  \nSanketh [@SankethYS](https://twitter.com/SankethYS): _\"Heck! How does this work. So cool.\"_  \nTony Dinh [@tdinh_me](https://twitter.com/tdinh_me): _\"supeer cool, oh, open source as well? yeah\"_  \nSrushti [@srushtiuniverse](https://twitter.com/srushtiuniverse): _\"Yess it's awesome. I tried it.\"_  \nSurjith [@surjithctly](https://twitter.com/surjithctly): _\"Whoa, who made this?\"_  \nArav [@HeyArav](https://twitter.com/HeyArav): [_\"Okay, this is actually super awesome.\"_](https://twitter.com/tregsthedev/status/1384180393893498880)  \nHarsh [@harshb__](https://twitter.com/harshb__): _\"im gonna come here everyday to chill when i get bored of studying lol, this is so cool\"_\nKrish [@krishnerkar_](https://twitter.com/krishnerkar_):  [_\"SHIT! THIS IS SO DOPE\"_](https://twitter.com/krishnerkar_/status/1384173042616573960)  \nAmrit [@astro_shenava](https://twitter.com/astro_shenava): _\"Super cool man\"_  \nMudrank [@mudrankgupta](https://twitter.com/mudrankgupta): \"ğŸ”¥ğŸš€ğŸš€\"\n\næ¥è‡ª Hack Club:  \n**[Caleb Denio](https://calebden.io), [Safin Singh](https://safin.dev), [Eleeza](https://github.com/E-Lee-Za)   \n[Jubril](https://github.com/s1ntaxe770r), [Sarthak Mohanty](https://sarthakmohanty.me)    \n[Sam Poder](http://sampoder.com), [Rishi Kothari](http://rishi.cx)    \n[Amogh Chaubey](https://amogh.sh), [Ella](https://ella.cx/), [Hugo Hu](https://github.com/Hugoyhu)\n[Matthew Stanciu](https://matthewstanciu.me/), [Tanishq Soni](https://tanishqsoni.me)**\n\néå¸¸æ„Ÿè°¢äº†ä¸èµ·çš„ [Caleb Denio](https://github.com/cjdenio)å€Ÿç»™æˆ‘æœ€åˆçš„ Devzat æœåŠ¡å™¨ ğŸ’–\n\n\n### *ç”± [Ishan Goel](https://twitter.com/usrbinishan/) æ ¹æ®æœ‹å‹çš„ç‰¹è‰²æƒ³æ³•åˆ¶ä½œã€‚æ„Ÿè°¢ [Caleb Denio](https://twitter.com/CalebDenio)å€Ÿå‡ºä»–çš„æœåŠ¡å™¨ï¼*"
        },
        {
          "name": "README.md",
          "type": "blob",
          "size": 8.349609375,
          "content": "<div align=\"center\">\n<img src=\"https://github.com/quackduck/devzat/assets/38882631/046fbb4d-dff2-41e9-a61c-271d0820473e\" style=\"height: 100px; border-radius: 50px;\" />\n</div>\n\n***\n\n<a href=\"https://www.producthunt.com/posts/devzat?utm_source=badge-top-post-badge&utm_medium=badge&utm_souce=badge-devzat\" target=\"_blank\"><img src=\"https://api.producthunt.com/widgets/embed-image/v1/top-post-badge.svg?post_id=298678&theme=light&period=daily\" alt=\"Devzat - Chat with other devs over SSH in your Terminal | Product Hunt\" style=\"width: 250px; height: 54px;\" width=\"250\" height=\"54\" /></a>\n\nWhere are the devs at? Devzat!\n\nDevzat is a custom SSH server that takes you to a chat instead of a shell prompt. Because there's SSH apps on all platforms (even on phones) you can connect to Devzat on any device!\n\n<!-- <img src=\"https://user-images.githubusercontent.com/38882631/115499526-a4d70280-a280-11eb-8723-817f54eccf3e.png\" height=400px /> -->\n\nA recording I took one day:\n[![asciicast](https://asciinema.org/a/477083.svg)](https://asciinema.org/a/477083?speed=3)\n## Usage\n\nTry it out:\n\n```sh\nssh devzat.hackclub.com\n```\n\nIf it's your first time logging in, you can choose your display name with the SSH username. For example, if you want to be called \"wenjie\", you can run:\n```sh\nssh wenjie@devzat.hackclub.com\n```\nIf you want to change your display name after the first login, you should use the `nick` command.\n\n\nIf you're under a firewall, you can still join on port 443:\n```sh\nssh devzat.hackclub.com -p 443\n```\n\nIf you add this to `~/.ssh/config`:\n```ssh\nHost chat\n    HostName devzat.hackclub.com\n```\n\nYou'll be able to join with just:\n```sh\nssh chat\n```\n\nWe also have a Slack bridge! If you're on the [Hack Club](https://hackclub.com) Slack, check out the `#ssh-chat-bridge` channel!\n\nFeel free to make a [new issue](https://github.com/quackduck/devzat/issues) if something doesn't work.\n\nSee the [status site](https://stats.uptimerobot.com/kxMQqfYk4y) of the main Devzat server to check if it might be down.\n\n### Want to host your own instance?\n\nQuick start:\n```shell\ngit clone https://github.com/quackduck/devzat && cd devzat\ngo install # or build, if you want to keep things pwd\nssh-keygen -qN '' -f devzat-sshkey # new ssh host key for the server\ndevzat # run! the default config is used & written automatically\n```\nThese commands download, build, setup and run a Devzat server listening on port 2221, the default port (change by setting `$PORT`).\n\nCheck out the [Admin's Manual](Admin's%20Manual.md) for complete self-host documentation!\n\n### Permission denied?\n\nDevzat uses public keys to identify users. If you are denied access: `foo@devzat.hackclub.com: Permission denied (publickey)` try logging in on port 443, which does not require a key, using `ssh devzat.hackclub.com -p 443`.\n\nThis error may happen because you do not have an SSH key pair. Generate one with the command `ssh-keygen` if this is the case. (you can usually check if you have a key pair by making sure a file of this form: `~/.ssh/id_*` exists)\n\n### Help\n\n```text\nWelcome to Devzat! Devzat is chat over SSH: github.com/quackduck/devzat\nBecause there's SSH apps on all platforms, even on mobile, you can join from anywhere.\n\nRun `cmds` to see a list of commands.\n\nInteresting features:\nâ€¢ Rooms! Run cd to see all rooms and use cd #foo to join a new room.\nâ€¢ Markdown support! Tables, headers, italics and everything. Just use \\n in place of newlines.\nâ€¢ Code syntax highlighting. Use Markdown fences to send code. Run eg-code to see an example.\nâ€¢ Direct messages! Send a quick DM using =user <msg> or stay in DMs by running cd @user.\nâ€¢ Timezone support, use tz Continent/City to set your timezone.\nâ€¢ Built in Tic Tac Toe and Hangman! Run tic or hang <word> to start new games.\nâ€¢ Emoji replacements! :rocket: => ğŸš€  (like on Slack and Discord)\n\nFor replacing newlines, I often use bulkseotools.com/add-remove-line-breaks.php.\n\nMade by Ishan Goel with feature ideas from friends.\nThanks to Caleb Denio for lending his server!\n```\n### Commands\n```text\nCommands\n   =<user>   <msg>           DM <user> with <msg>\n   users                     List users\n   color     <color>         Change your name's color\n   exit                      Leave the chat\n   help                      Show help\n   man       <cmd>           Get help for a specific command\n   emojis                    See a list of emojis\n   bell      on|off|all      ANSI bell on pings (on), never (off) or for every message (all)\n   clear                     Clear the screen\n   hang      <char|word>     Play hangman\n   tic       <cell num>      Play tic tac toe!\n   devmonk                   Test your typing speed\n   cd        #room|user      Join #room, DM user or run cd to see a list\n   tz        <zone> [24h]    Set your IANA timezone (like tz Asia/Dubai) and optionally set 24h\n   nick      <name>          Change your username\n   pronouns  @user|pronouns  Set your pronouns or get another user's\n   theme     <theme>|list    Change the syntax highlighting theme\n   rest                      Uncommon commands list\n   cmds                      Show this message\n```\n```\nThe rest\n   people                  See info about nice people who joined\n   id       <user>         Get a unique ID for a user (hashed key)\n   admins                  Print the ID (hashed key) for all admins\n   eg-code  [big]          Example syntax-highlighted code\n   lsbans                  List banned IDs\n   ban      <user>         Ban <user> (admin)\n   unban    <IP|ID> [dur]  Unban a person and optionally, for a duration (admin)\n   kick     <user>         Kick <user> (admin)\n   art                     Show some panda art\n   pwd                     Show your current room\n   shrug                   Â¯\\_(ãƒ„)_/Â¯\n```\ntip: `kick` can help kick out an old session when rejoining if needed\n## Integrations\n\nWhen self-hosting an instance, Devzat can integrate with Slack and/or Discord to bridge messages, and Twitter to post new-user announcements.\nSee the [Admin's Manual](Admin's%20Manual.md) for more info.\n\nDevzat has a plugin API you can use to integrate your own services: [documentation](plugin/README.md). Feel free to add a plugin to the main instance. Just ask for a token on the server.\n\n\n## Stargazers over time\n\n[![Stargazers over time](https://starchart.cc/quackduck/devzat.svg)](https://starchart.cc/quackduck/devzat)\n\n\n## People\n\nPeople who you might know who have joined:\n\nZach Latta - Founder of Hack Club: _\"omg amazing! this is so awesome\"_  \nAnt Wilson - Co founder, Supabase: [_\"brilliant!\"_](https://twitter.com/AntWilson/status/1396444302721445889)  \nBereket [@heybereket](https://twitter.com/heybereket): _\"this is pretty cool\"_  \nAyush [@ayshptk](https://twitter.com/ayshptk): _\"Can I double star the repo somehow :pleading_face:\"_  \nSanketh [@SankethYS](https://twitter.com/SankethYS): _\"Heck! How does this work. So cool.\"_  \nTony Dinh [@tdinh_me](https://twitter.com/tdinh_me): _\"supeer cool, oh, open source as well? yeah\"_  \nSrushti [@srushtiuniverse](https://twitter.com/srushtiuniverse): _\"Yess it's awesome. I tried it.\"_  \nSurjith [@surjithctly](https://twitter.com/surjithctly): _\"Whoa, who made this?\"_  \nArav [@HeyArav](https://twitter.com/HeyArav): [_\"Okay, this is actually super awesome.\"_](https://twitter.com/tregsthedev/status/1384180393893498880)  \nHarsh [@harshb__](https://twitter.com/harshb__): _\"im gonna come here everyday to chill when i get bored of studying lol, this is so cool\"_\nKrish [@krishnerkar_](https://twitter.com/krishnerkar_):  [_\"SHIT! THIS IS SO DOPE\"_](https://twitter.com/krishnerkar_/status/1384173042616573960)  \nAmrit [@astro_shenava](https://twitter.com/astro_shenava): _\"Super cool man\"_  \nMudrank [@mudrankgupta](https://twitter.com/mudrankgupta): \"ğŸ”¥ğŸš€ğŸš€\"\n\nFrom Hack Club:  \n**[Caleb Denio](https://calebden.io), [Safin Singh](https://safin.dev), [Eleeza](https://github.com/E-Lee-Za)   \n[Jubril](https://github.com/s1ntaxe770r), [Sarthak Mohanty](https://sarthakmohanty.me)    \n[Sam Poder](http://sampoder.com), [Rishi Kothari](http://rishi.cx)    \n[Amogh Chaubey](https://amogh.sh), [Ella](https://ella.cx/), [Hugo Hu](https://github.com/Hugoyhu)\n[Matthew Stanciu](https://matthewstanciu.me/), [Tanishq Soni](https://tanishqsoni.me)**\n\nHuge thanks to the amazing [Caleb Denio](https://github.com/cjdenio) for lending me the original Devzat server ğŸ’–\n\n\n### *Made by [Ishan Goel](https://twitter.com/usrbinishan/) with feature ideas from friends. Thanks to [Caleb Denio](https://twitter.com/CalebDenio) for lending his server!*\n"
        },
        {
          "name": "censor.go",
          "type": "blob",
          "size": 0.7958984375,
          "content": "package main\n\nimport (\n\t\"encoding/base64\"\n\tgoaway \"github.com/TwiN/go-away\"\n)\n\nvar detector = goaway.NewProfanityDetector().WithSanitizeSpaces(false)\n\nfunc rmBadWords(text string) string {\n\tif !Config.Censor {\n\t\treturn text\n\t}\n\treturn detector.Censor(text)\n}\n\nfunc init() {\n\tokayIshWords := []string{\"ZnVjaw==\", \"Y3JhcA==\", \"c2hpdA==\", \"YXJzZQ==\", \"YXNz\", \"YnV0dA==\", \"cGlzcw==\"} // base 64 encoded okay-ish swears\n\tfor i := 0; i < len(goaway.DefaultProfanities); i++ {\n\t\tfor _, okayIshWord := range okayIshWords {\n\t\t\tokayIshWordb, _ := base64.StdEncoding.DecodeString(okayIshWord)\n\t\t\tif goaway.DefaultProfanities[i] == string(okayIshWordb) {\n\t\t\t\tgoaway.DefaultProfanities = append(goaway.DefaultProfanities[:i], goaway.DefaultProfanities[i+1:]...)\n\t\t\t\ti-- // so we don't skip the next word\n\t\t\t\tbreak\n\t\t\t}\n\t\t}\n\t}\n}\n"
        },
        {
          "name": "code-eg.txt",
          "type": "blob",
          "size": 0.052734375,
          "content": "\\`\\`\\`go\\\\nimport whatever\\\\nfmt.Print(\"yo\")\\\\n\\`\\`\\`\n"
        },
        {
          "name": "colors.go",
          "type": "blob",
          "size": 12.130859375,
          "content": "package main\n\nimport (\n\t\"errors\"\n\t\"fmt\"\n\t\"math\"\n\t\"math/rand\"\n\t\"strconv\"\n\t\"strings\"\n\n\t\"github.com/acarl005/stripansi\"\n\t\"github.com/jwalton/gchalk\"\n)\n\nvar (\n\tTrueColor = gchalk.New(gchalk.ForceLevel(gchalk.LevelAnsi16m))\n\tChalk     = gchalk.New(gchalk.ForceLevel(gchalk.LevelAnsi256))\n\tGreen     = ansi256(1, 5, 1)\n\tRed       = ansi256(5, 1, 1)\n\tCyan      = ansi256(1, 5, 5)\n\tMagenta   = ansi256(5, 1, 5)\n\tYellow    = ansi256(5, 5, 1)\n\tOrange    = ansi256(5, 3, 0)\n\tBlue      = ansi256(0, 3, 5)\n\tWhite     = ansi256(5, 5, 5)\n\tStyles    = []*Style{\n\t\t{\"white\", buildStyle(White)},\n\t\t{\"red\", buildStyle(Red)},\n\t\t{\"coral\", buildStyle(ansi256(5, 2, 2))},\n\t\t{\"green\", buildStyle(Green)},\n\t\t{\"sky\", buildStyle(ansi256(3, 5, 5))},\n\t\t{\"cyan\", buildStyle(Cyan)},\n\t\t{\"magenta\", buildStyle(Magenta)},\n\t\t{\"pink\", buildStyle(ansi256(5, 3, 4))},\n\t\t{\"rose\", buildStyle(ansi256(5, 0, 2))},\n\t\t{\"cranberry\", buildStyle(ansi256(3, 0, 1))},\n\t\t{\"lavender\", buildStyle(ansi256(4, 2, 5))},\n\t\t{\"fire\", buildStyle(ansi256(5, 2, 0))},\n\t\t{\"pastelgreen\", buildStyle(ansi256(0, 5, 3))},\n\t\t{\"olive\", buildStyle(ansi256(2, 3, 0))},\n\t\t{\"yellow\", buildStyle(Yellow)},\n\t\t{\"orange\", buildStyle(Orange)},\n\t\t{\"blue\", buildStyle(Blue)}}\n\tSecretStyles = []*Style{\n\t\t{\"elitedino\", buildStyle(ansi256(5, 0, 0))},\n\t\t{\"ukraine\", buildStyle(TrueColor.WithHex(\"#005bbb\").WithBgHex(\"#ffd500\"))},\n\t\t{\"easter\", buildStyle(Chalk.WithRGB(255, 51, 255).WithBgRGB(255, 255, 0))},\n\t\t{\"baby\", buildStyle(Chalk.WithRGB(255, 51, 255).WithBgRGB(102, 102, 255))},\n\t\t{\"hacker\", buildStyle(Chalk.WithRGB(0, 255, 0).WithBgRGB(0, 0, 0))},\n\t\t{\"l33t\", buildStyleNoStrip(Chalk.WithBgBrightBlack())},\n\t\t{\"whiten\", buildStyleNoStrip(Chalk.WithBgWhite())},\n\t\t{\"trans\", makeFlag([]string{\"#5BCEFA\", \"#F5A9B8\", \"#FFFFFF\", \"#F5A9B8\", \"#5BCEFA\"})},\n\t\t{\"enby\", makeFlag([]string{\"#FCF45E\", \"#FFFFFF\", \"#915DC9\", \"#000000\"})},\n\t\t{\"gay\", makeFlag([]string{\"#FF0018\", \"#FFA52C\", \"#FFFF41\", \"#008018\", \"#0000F9\", \"#86007D\"})},\n\t\t{\"lesbian\", makeFlag([]string{\"#D62E02\", \"#FD9855\", \"#FFFFFF\", \"#D161A2\", \"#A20160\"})},\n\t\t{\"bi\", makeFlag([]string{\"#D60270\", \"#D60270\", \"#9B4F96\", \"#0038A8\", \"#0038A8\"})},\n\t\t{\"sunset\", func(a string) string { return applyHueRange(335, 480, a, false) }},\n\t\t{\"bg-sunset\", func(a string) string { return applyHueRange(335, 480, a, true) }},\n\t\t{\"rainbow\", func(a string) string { return rainbow(a, false) }},\n\t\t{\"bg-rainbow\", func(a string) string { return rainbow(a, true) }}}\n\tColorHelpMsg = \"\"\n)\n\nfunc colorNameWithColor(c string) string {\n\tstyle, _ := getStyle(c)\n\treturn style.apply(c)\n}\n\nfunc init() {\n\t//markdown.CurrentTheme = chromastyles.ParaisoDark\n\tColorHelpMsg = strings.Join(func() []string {\n\t\tcolors := make([]string, 0, len(Styles))\n\t\tfor i := range Styles {\n\t\t\tcolors = append(colors, Styles[i].apply(Styles[i].name))\n\t\t}\n\t\treturn colors\n\t}(), \", \") + `\n\nMake your own colors using hex (eg. color ` + colorNameWithColor(\"#A0FFFF\") + ` or RGB values from 0-5 (eg. color ` + colorNameWithColor(\"530\") + `). Generate gradients with hues (eg. color ` + colorNameWithColor(\"hue-0-360\") + `). Set bg with \"bg-\" (eg. color ` + colorNameWithColor(\"bg-101\") + `, color ` + colorNameWithColor(\"bg-hue-130-20\") + `). Use multiple colors at once (eg. color ` + colorNameWithColor(\"rose #F5A9B8\") + `). Remove bg with bg-off. There's also a few secret colors :)`\n}\n\ntype Style struct {\n\tname  string\n\tapply func(string) string\n}\n\nfunc buildStyle(c *gchalk.Builder) func(string) string {\n\treturn func(s string) string { return c.Paint(stripansi.Strip(s)) }\n}\nfunc buildStyleNoStrip(c *gchalk.Builder) func(string) string {\n\treturn func(s string) string { return c.Paint(s) }\n}\n\nfunc makeFlag(colors []string) func(a string) string {\n\tflag := make([]*gchalk.Builder, len(colors))\n\tfor i := range colors {\n\t\tflag[i] = TrueColor.WithHex(colors[i])\n\t}\n\treturn func(a string) string {\n\t\treturn applyMulticolor(flag, a)\n\t}\n}\n\nfunc rainbow(a string, bg bool) string {\n\tspan := 360.0\n\tlength := len(stripansi.Strip(a))\n\tif length < 16 {\n\t\tspan = 22.5 * float64(length) // at least 45 degrees per letter\n\t}\n\tstart := 360 * rand.Float64()\n\t//span /= 2\n\treturn applyHueRange(start, start+span, a, bg)\n}\n\nfunc applyHueRange(start, end float64, a string, bg bool) string {\n\tif !bg { // if fg, strip all color (bg is applied after fg)\n\t\ta = stripansi.Strip(a)\n\t}\n\tbuf := strings.Builder{}\n\tif !bg {\n\t\trunes := []rune(a)\n\t\tfor i, r := range runes {\n\t\t\th := start + (end-start)*float64(i)/float64(len(runes))\n\t\t\tbuf.WriteString(TrueColor.WithRGB(hueRGB(h)).Paint(string(r)))\n\t\t}\n\t} else { // need to operate with ansi codes\n\t\tsplit := tokenizeAnsi(a)\n\t\tfor i, s := range split {\n\t\t\th := start + (end-start)*float64(i)/float64(len(split))\n\t\t\tbuf.WriteString(TrueColor.WithBgRGB(hueRGB(h)).Paint(s))\n\t\t}\n\t}\n\treturn buf.String()\n}\n\nfunc applyStyles(styles []*Style, a string) string {\n\t//a = stripansi.Strip(a)\n\tbuf := strings.Builder{}\n\tcolorOffset := rand.Intn(len(styles))\n\tfor i, s := range tokenizeAnsi(a) {\n\t\tbuf.WriteString(styles[(colorOffset+i)%len(styles)].apply(s))\n\t}\n\treturn buf.String()\n}\n\nfunc applyMulticolor(colors []*gchalk.Builder, a string) string {\n\ta = stripansi.Strip(a)\n\tbuf := strings.Builder{}\n\tcolorOffset := rand.Intn(len(colors))\n\tfor i, r := range []rune(a) {\n\t\tbuf.WriteString(colors[(colorOffset+i)%len(colors)].Paint(string(r)))\n\t}\n\treturn buf.String()\n}\n\n// splits runes and includes their color codes\nfunc tokenizeAnsi(a string) []string {\n\ttokens := make([]string, 0, len(a)/3)\n\tbuf := strings.Builder{}\n\tbuildUntilM := false // m delineates end of ansi color code\n\tfor _, r := range a {\n\t\tbuf.WriteRune(r)\n\t\tif r == '\\033' {\n\t\t\tbuildUntilM = true\n\t\t\tcontinue\n\t\t}\n\t\tif buildUntilM {\n\t\t\tif r == 'm' {\n\t\t\t\tbuildUntilM = false\n\t\t\t}\n\t\t\tcontinue\n\t\t}\n\t\ttokens = append(tokens, buf.String())\n\t\tbuf.Reset()\n\t}\n\tif buf.Len() > 0 { // that last m could be needed\n\t\ttokens = append(tokens, buf.String())\n\t}\n\n\tfor i := range tokens {\n\t\tif strings.HasPrefix(tokens[i], \"\\x1b[39m\") {\n\t\t\tif i != len(tokens)-1 {\n\t\t\t\ttokens[i] = tokens[i][5:]\n\t\t\t} else {\n\t\t\t\t// move to earlier token\n\t\t\t\ttokens[i-1] += tokens[i]\n\t\t\t\ttokens = tokens[:len(tokens)-1]\n\t\t\t}\n\t\t}\n\t}\n\treturn tokens\n}\n\n// h from 0 to 360\n// https://www.desmos.com/calculator/wb91fw4nyj\nfunc hueRGB(h float64) (r, g, b uint8) {\n\tpi := math.Pi\n\th = math.Mod(h, 360) / 360.0\n\tr = uint8(math.Round(255.0 * (0.5 + 0.5*math.Sin(2*pi*h+pi/2))))\n\tg = uint8(math.Round(255.0 * (0.5 + 0.5*math.Sin(2*pi*h+pi/2+2*pi/3))))\n\tb = uint8(math.Round(255.0 * (0.5 + 0.5*math.Sin(2*pi*h+pi/2+4*pi/3))))\n\t//r, g, b, err := colorconv.HSVToRGB(math.Mod(h, 360), s, v)\n\t//if err != nil {\n\t//\treturn Chalk.WithRGB(0, 0, 0)\n\t//}\n\treturn\n}\n\n// with r, g and b values from 0 to 5\nfunc ansi256(r, g, b uint8) *gchalk.Builder {\n\treturn Chalk.WithRGB(255/5*r, 255/5*g, 255/5*b)\n\t//return Chalk.WithRGB(uint8(math.Round(255*float64(r)/5)), uint8(math.Round(255*float64(g)/5)), uint8(math.Round(255*float64(b)/5)))\n}\n\nfunc bgAnsi256(r, g, b uint8) *gchalk.Builder {\n\treturn Chalk.WithBgRGB(255/5*r, 255/5*g, 255/5*b)\n}\n\n// Applies color from name\nfunc (u *User) changeColor(colorName string) error {\n\tif strings.Contains(colorName, \"bg\") {\n\t\tif names := strings.Fields(colorName); len(names) > 1 { // do we need to separate bg and fg colors?\n\t\t\tfgColors := make([]string, 0, len(names)-1)\n\t\t\tbgColors := make([]string, 0, len(names))\n\t\t\tfor _, name := range names {\n\t\t\t\tif strings.HasPrefix(name, \"bg\") {\n\t\t\t\t\tbgColors = append(bgColors, name)\n\t\t\t\t} else {\n\t\t\t\t\tfgColors = append(fgColors, name)\n\t\t\t\t}\n\t\t\t}\n\t\t\tif len(fgColors) != 0 { // if no fg colors, carry on normally\n\t\t\t\terr := u.changeColor(strings.Join(fgColors, \" \"))\n\t\t\t\tif err != nil {\n\t\t\t\t\treturn err\n\t\t\t\t}\n\t\t\t\treturn u.changeColor(strings.Join(bgColors, \" \"))\n\t\t\t}\n\t\t}\n\t}\n\tstyle, err := getStyle(colorName)\n\tif err != nil {\n\t\treturn err\n\t}\n\n\t//changedBg := false\n\tif strings.HasPrefix(colorName, \"bg\") {\n\t\t//changedBg = true\n\t\tu.ColorBG = style.name // update bg color\n\t} else {\n\t\tu.Color = style.name // update fg color\n\t}\n\n\tu.Name, _ = applyColorToData(u.Name, u.Color, u.ColorBG)\n\t//styleFG := &Style{}\n\t//styleBG := &Style{}\n\t//if changedBg {\n\t//\tstyleFG, _ = getStyle(u.Color) // already checked for errors\n\t//\tstyleBG = style\n\t//} else {\n\t//\tstyleBG, err = getStyle(u.ColorBG) // already checked for errors\n\t//\tstyleFG = style\n\t//}\n\t//u.Name = styleBG.apply(styleFG.apply(u.Name))\n\tu.formatPrompt()\n\treturn nil\n}\n\nfunc applyColorToData(data string, color string, colorBG string) (string, error) {\n\tstyleFG, err := getStyle(color)\n\tif err != nil {\n\t\treturn \"\", err\n\t}\n\tstyleBG, err := getStyle(colorBG)\n\tif err != nil {\n\t\treturn \"\", err\n\t}\n\treturn styleBG.apply(styleFG.apply(data)), nil // fg clears the bg color\n}\n\n// If the input is a named style, returns it. Otherwise, returns nil.\nfunc getNamedColor(name string) *Style {\n\tfor i := range Styles {\n\t\tif Styles[i].name == name {\n\t\t\treturn Styles[i]\n\t\t}\n\t}\n\tfor i := range SecretStyles {\n\t\tif SecretStyles[i].name == name {\n\t\t\treturn SecretStyles[i]\n\t\t}\n\t}\n\treturn nil\n}\n\nfunc getCustomColor(name string) (*Style, error) {\n\tif strings.HasPrefix(name, \"#\") {\n\t\treturn &Style{name, buildStyle(TrueColor.WithHex(name))}, nil\n\t}\n\tif strings.HasPrefix(name, \"bg-#\") {\n\t\treturn &Style{name, buildStyleNoStrip(TrueColor.WithBgHex(strings.TrimPrefix(name, \"bg-\")))}, nil\n\t}\n\tbghue := strings.HasPrefix(name, \"bg-hue-\")\n\tif bghue || strings.HasPrefix(name, \"hue-\") {\n\t\tvar hue1, hue2 float64\n\t\tvar err error\n\t\tif bghue {\n\t\t\t_, err = fmt.Sscanf(name, \"bg-hue-%f-%f\", &hue1, &hue2)\n\t\t} else {\n\t\t\t_, err = fmt.Sscanf(name, \"hue-%f-%f\", &hue1, &hue2)\n\t\t}\n\t\tif err != nil {\n\t\t\treturn nil, err\n\t\t}\n\t\treturn &Style{name, func(a string) string { return applyHueRange(hue1, hue2, a, bghue) }}, nil\n\t}\n\tif len(name) == 3 || len(name) == 6 {\n\t\trgbCode := name\n\t\tif strings.HasPrefix(name, \"bg-\") {\n\t\t\trgbCode = strings.TrimPrefix(rgbCode, \"bg-\")\n\t\t}\n\t\ta, err := strconv.Atoi(rgbCode)\n\t\tif err == nil {\n\t\t\tr := (a / 100) % 10\n\t\t\tg := (a / 10) % 10\n\t\t\tb := a % 10\n\t\t\tif r > 5 || g > 5 || b > 5 || r < 0 || g < 0 || b < 0 {\n\t\t\t\treturn nil, errors.New(\"custom colors have values from 0 to 5 smh\")\n\t\t\t}\n\t\t\tif strings.HasPrefix(name, \"bg-\") {\n\t\t\t\treturn &Style{name, buildStyleNoStrip(bgAnsi256(uint8(r), uint8(g), uint8(b)))}, nil\n\t\t\t}\n\t\t\treturn &Style{name, buildStyle(ansi256(uint8(r), uint8(g), uint8(b)))}, nil\n\t\t}\n\t\treturn nil, err\n\t}\n\treturn nil, nil\n}\n\n// Turns name into a style (defaults to nil)\nfunc getStyle(name string) (*Style, error) {\n\tname = strings.TrimSpace(name)\n\tif names := strings.Fields(name); len(names) > 1 {\n\t\tstyleSlice := make([]*Style, len(names))\n\t\tnewName := \"\"\n\t\tfor i := range names {\n\t\t\tstyle, err := getStyle(names[i])\n\t\t\tif err != nil {\n\t\t\t\treturn nil, err\n\t\t\t}\n\t\t\tstyleSlice[i] = style\n\t\t\tnewName += style.name + \" \"\n\t\t}\n\n\t\treturn &Style{newName[:len(newName)-1], func(a string) string {\n\t\t\treturn applyStyles(styleSlice, a)\n\t\t}}, nil\n\t}\n\tswitch name {\n\tcase \"random\":\n\t\tr, g, b := rand.Intn(256), rand.Intn(256), rand.Intn(256) // generate random hex color\n\t\treturn &Style{fmt.Sprintf(\"#%02x%02x%02x\", r, g, b), buildStyle(Chalk.WithRGB(uint8(r), uint8(g), uint8(b)))}, nil\n\tcase \"bg-random\":\n\t\tr, g, b := rand.Intn(256), rand.Intn(256), rand.Intn(256)\n\t\treturn &Style{fmt.Sprintf(\"bg-#%02x%02x%02x\", r, g, b), buildStyleNoStrip(Chalk.WithBgRGB(uint8(r), uint8(g), uint8(b)))}, nil\n\tcase \"bg-off\":\n\t\treturn &Style{\"bg-off\", func(a string) string { return a }}, nil // no background\n\t}\n\tnamedColor := getNamedColor(name)\n\tif namedColor != nil {\n\t\treturn namedColor, nil\n\t}\n\tif strings.HasPrefix(name, \"#\") {\n\t\treturn &Style{name, buildStyle(Chalk.WithHex(name))}, nil\n\t}\n\tcustomColor, err := getCustomColor(name)\n\tif err != nil {\n\t\treturn nil, err\n\t}\n\tif customColor != nil {\n\t\treturn customColor, nil\n\t}\n\treturn nil, errors.New(`Which color? Choose from ` + colorNameWithColor(\"random\") + `, ` + colorNameWithColor(\"bg-random\") + `, ` + ColorHelpMsg)\n}\n\n// Return the msg string with the same colors as the reference string\nfunc copyColor(msg string, ref string) string {\n\tstripedMsg := stripansi.Strip(msg)\n\tcolorTokens := tokenizeAnsi(ref)\n\tret := \"\"\n\tfor i, c := range stripedMsg {\n\t\ttoken := colorTokens[i%len(colorTokens)]\n\t\ttoken = strings.ReplaceAll(token, \"\\033[39m\", \"\") // Remove reset to default foreground and background\n\t\ttokenByte := []byte(strings.ReplaceAll(token, \"\\033[49m\", \"\"))\n\t\ttokenByte[len(tokenByte)-1] = byte(c)\n\t\tret += string(tokenByte)\n\t}\n\tret += \"\\033[39m\\033[49m\"\n\treturn ret\n}\n"
        },
        {
          "name": "commands.go",
          "type": "blob",
          "size": 32.947265625,
          "content": "package main\n\nimport (\n\t\"fmt\"\n\t_ \"image/gif\"\n\t_ \"image/jpeg\"\n\t_ \"image/png\"\n\t\"math\"\n\t\"math/rand\"\n\t\"os\"\n\t\"runtime\"\n\t\"sort\"\n\t\"strconv\"\n\t\"strings\"\n\t\"sync\"\n\t\"time\"\n\n\t\"github.com/alecthomas/chroma\"\n\tchromastyles \"github.com/alecthomas/chroma/styles\"\n\t\"github.com/fatih/color\"\n\t\"github.com/jwalton/gchalk\"\n\t\"github.com/quackduck/term\"\n\t\"github.com/shurcooL/tictactoe\"\n)\n\ntype CMD struct {\n\tname     string\n\trun      func(line string, u *User)\n\targsInfo string\n\tinfo     string\n}\n\nvar (\n\tMainCMDs = []CMD{\n\t\t{\"=`user`\", dmCMD, \"`msg`\", \"DM `user` with `msg`\"}, // won't actually run, here just to show in docs\n\t\t{\"users\", usersCMD, \"\", \"List users\"},\n\t\t{\"color\", colorCMD, \"`color`\", \"Change your name's color\"},\n\t\t{\"exit\", exitCMD, \"\", \"Leave the chat\"},\n\t\t{\"help\", helpCMD, \"\", \"Show help\"},\n\t\t{\"man\", manCMD, \"`cmd`\", \"Get help for a specific command\"},\n\t\t{\"emojis\", emojisCMD, \"\", \"See a list of emojis\"},\n\t\t{\"bell\", bellCMD, \"on|off|all\", \"ANSI bell on pings (on), never (off) or for every message (all)\"},\n\t\t{\"clear\", clearCMD, \"\", \"Clear the screen\"},\n\t\t{\"hang\", hangCMD, \"`char`|`word`\", \"Play hangman\"}, // won't actually run, here just to show in docs\n\t\t{\"tic\", ticCMD, \"`cell num`\", \"Play tic tac toe!\"},\n\t\t{\"devmonk\", devmonkCMD, \"\", \"Test your typing speed\"},\n\t\t{\"cd\", cdCMD, \"#`room`|`user`\", \"Join #room, DM user or run cd to see a list\"}, // won't actually run, here just to show in docs\n\t\t{\"tz\", tzCMD, \"`zone` [24h]\", \"Set your IANA timezone (like tz Asia/Dubai) and optionally set 24h\"},\n\t\t{\"nick\", nickCMD, \"`name`\", \"Change your username\"},\n\t\t{\"prompt\", promptCMD, \"`prompt`\", \"Change your prompt. Run `man prompt` for more info\"},\n\t\t{\"pronouns\", pronounsCMD, \"`@user`|`pronouns`\", \"Set your pronouns or get another user's\"},\n\t\t{\"theme\", themeCMD, \"`name`|list\", \"Change the syntax highlighting theme\"},\n\t\t{\"rest\", commandsRestCMD, \"\", \"Uncommon commands list\"}}\n\tRestCMDs = []CMD{\n\t\t// {\"people\", peopleCMD, \"\", \"See info about nice people who joined\"},\n\t\t{\"bio\", bioCMD, \"[`user`]\", \"Get a user's bio or set yours\"},\n\t\t{\"id\", idCMD, \"`user`\", \"Get a unique ID for a user (hashed key)\"},\n\t\t{\"admins\", adminsCMD, \"\", \"Print the ID (hashed key) for all admins\"},\n\t\t{\"eg-code\", exampleCodeCMD, \"[big]\", \"Example syntax-highlighted code\"},\n\t\t{\"lsbans\", listBansCMD, \"\", \"List banned IDs\"},\n\t\t{\"ban\", banCMD, \"`user` [`reason`] [`dur`]\", \"Ban <user> and optionally, with a reason or duration (admin)\"},\n\t\t{\"unban\", unbanCMD, \"IP|ID [dur]\", \"Unban a person (admin)\"},\n\t\t{\"mute\", muteCMD, \"`user`\", \"Mute <user> (admin)\"},\n\t\t{\"unmute\", unmuteCMD, \"`user`\", \"Unmute <user> (admin)\"},\n\t\t{\"kick\", kickCMD, \"`user`\", \"Kick <user> (admin)\"},\n\t\t{\"art\", asciiArtCMD, \"\", \"Show some panda art\"},\n\t\t{\"pwd\", pwdCMD, \"\", \"Show your current room\"},\n\t\t//\t\t{\"sixel\", sixelCMD, \"<png url>\", \"Render an image in high quality\"},\n\t\t{\"shrug\", shrugCMD, \"\", `Â¯\\\\\\_(ãƒ„)\\_/Â¯`}, // won't actually run, here just to show in docs\n\t\t{\"uname\", unameCMD, \"\", \"Show build info\"},\n\t\t{\"uptime\", uptimeCMD, \"\", \"Show server uptime\"},\n\t\t{\"8ball\", eightBallCMD, \"`question`\", \"Always tells the truth.\"},\n\t\t{\"rmdir\", rmdirCMD, \"#`room`\", \"Remove an empty room\"},\n\t}\n\tSecretCMDs = []CMD{\n\t\t{\"ls\", lsCMD, \"???\", \"???\"},\n\t\t{\"cat\", catCMD, \"???\", \"???\"},\n\t\t{\"rm\", rmCMD, \"???\", \"???\"},\n\t\t{\"su\", nickCMD, \"???\", \"This is an alias of nick\"},\n\t\t{\"colour\", colorCMD, \"???\", \"This is an alias of color\"}, // appease the british\n\t\t{\":q\", exitCMD, \"\", \"This is an alias of exit\"},          // appease the Vim user\n\t\t{\":wq\", exitCMD, \"\", \"This is an alias of exit\"},         // appease the Vim user, that wants to save\n\t\t{\"neofetch\", neofetchCMD, \"???\", \"???\"},                  //apease the Arch user (mostly)\n\t}\n\n\tunameCommit = \"\"\n\tunameTime   = \"\"\n)\n\nconst (\n\tMaxRoomNameLen = 30\n\tMaxBioLen      = 300\n)\n\nfunc init() {\n\tMainCMDs = append(MainCMDs, CMD{\"cmds\", commandsCMD, \"\", \"Show this message\"}) // avoid initialization loop\n}\n\n// runCommands parses a line of raw input from a User and sends a message as\n// required, running any commands the User may have called.\n// It also accepts a boolean indicating if the line of input is from slack, in\n// which case some commands will not be run (such as ./tz and ./exit)\nfunc runCommands(line string, u *User) {\n\tline = rmBadWords(line)\n\n\tif u.IsMuted {\n\t\tu.writeln(u.Name, line)\n\t\treturn\n\t}\n\n\tif line == \"\" {\n\t\treturn\n\t}\n\tdefer protectFromPanic()\n\tcurrCmd := strings.Fields(line)[0]\n\tif u.messaging != nil && currCmd != \"=\" && currCmd != \"cd\" && currCmd != \"exit\" && currCmd != \"pwd\" { // the commands allowed in a private dm room\n\t\tdmRoomCMD(line, u)\n\t\treturn\n\t}\n\tif strings.HasPrefix(line, \"=\") && !u.isBridge {\n\t\tdmCMD(strings.TrimSpace(strings.TrimPrefix(line, \"=\")), u)\n\t\treturn\n\t}\n\n\t// Now we know it is not a DM, so this is a safe place to add the hook for sending the event to plugins\n\tline = getMiddlewareResult(u, line)\n\tsendMessageToPlugins(line, u)\n\n\tswitch currCmd {\n\tcase \"hang\":\n\t\thangCMD(strings.TrimSpace(strings.TrimPrefix(line, \"hang\")), u)\n\t\treturn\n\tcase \"cd\":\n\t\tcdCMD(strings.TrimSpace(strings.TrimPrefix(line, \"cd\")), u)\n\t\treturn\n\tcase \"shrug\":\n\t\tshrugCMD(strings.TrimSpace(strings.TrimPrefix(line, \"shrug\")), u)\n\t\treturn\n\tcase \"mute\":\n\t\tmuteCMD(strings.TrimSpace(strings.TrimPrefix(line, \"mute\")), u)\n\t\treturn\n\t}\n\n\tif u.isBridge {\n\t\tu.room.broadcastNoBridges(u.Name, line)\n\t} else {\n\t\tu.room.broadcast(u.Name, line)\n\t}\n\n\tdevbotChat(u.room, line)\n\n\targs := strings.TrimSpace(strings.TrimPrefix(line, currCmd))\n\n\tif runPluginCMDs(u, currCmd, args) {\n\t\treturn\n\t}\n\n\tif cmd, ok := getCMD(currCmd); ok {\n\t\tif cmd.argsInfo != \"\" || args == \"\" {\n\t\t\tcmd.run(args, u)\n\t\t}\n\t}\n}\n\nfunc dmCMD(rest string, u *User) {\n\trestSplit := strings.Fields(rest)\n\tif len(restSplit) < 2 {\n\t\tu.writeln(Devbot, \"You gotta have a message, mate\")\n\t\treturn\n\t}\n\tpeer, ok := findUserByName(u.room, restSplit[0])\n\tif !ok {\n\t\tu.writeln(Devbot, \"No such person lol, who you wanna dm? (you might be in the wrong room)\")\n\t\treturn\n\t}\n\tmsg := strings.TrimSpace(strings.TrimPrefix(rest, restSplit[0]))\n\tu.writeln(peer.Name+\" <- \", msg)\n\tif u == peer {\n\t\tdevbotRespond(u.room, []string{\"You must be really lonely, DMing yourself.\",\n\t\t\t\"Don't worry, I won't judge :wink:\",\n\t\t\t\"srsly?\",\n\t\t\t\"what an idiot\"}, 30)\n\t\treturn\n\t}\n\tpeer.writeln(u.Name+\" -> \", msg)\n}\n\nfunc hangCMD(rest string, u *User) {\n\tif len([]rune(rest)) > 1 {\n\t\tif !u.isBridge {\n\t\t\tu.writeln(u.Name, \"hang \"+rest)\n\t\t\tu.writeln(Devbot, \"(that word won't show dw)\")\n\t\t}\n\t\thangGame = &hangman{rest, 15, \" \"} // default value of guesses so empty space is given away\n\t\tu.room.broadcast(Devbot, u.Name+\" has started a new game of Hangman! Guess letters with hang <letter>\")\n\t\tu.room.broadcast(Devbot, \"```\\n\"+hangPrint(hangGame)+\"\\nTries: \"+strconv.Itoa(hangGame.triesLeft)+\"\\n```\")\n\t\treturn\n\t}\n\tif !u.isBridge {\n\t\tu.room.broadcast(u.Name, \"hang \"+rest)\n\t}\n\tif strings.Trim(hangGame.word, hangGame.guesses) == \"\" {\n\t\tu.room.broadcast(Devbot, \"The game has ended. Start a new game with hang <word>\")\n\t\treturn\n\t}\n\tif len(rest) == 0 {\n\t\tu.room.broadcast(Devbot, \"Start a new game with hang <word> or guess with hang <letter>\")\n\t\treturn\n\t}\n\tif hangGame.triesLeft == 0 {\n\t\tu.room.broadcast(Devbot, \"No more tries! The word was \"+hangGame.word)\n\t\treturn\n\t}\n\tif strings.Contains(hangGame.guesses, rest) {\n\t\tu.room.broadcast(Devbot, \"You already guessed \"+rest)\n\t\treturn\n\t}\n\thangGame.guesses += rest\n\tif !(strings.Contains(hangGame.word, rest)) {\n\t\thangGame.triesLeft--\n\t}\n\tdisplay := hangPrint(hangGame)\n\tu.room.broadcast(Devbot, \"```\\n\"+display+\"\\nTries: \"+strconv.Itoa(hangGame.triesLeft)+\"\\n```\")\n\tif strings.Trim(hangGame.word, hangGame.guesses) == \"\" {\n\t\tu.room.broadcast(Devbot, \"You got it! The word was \"+hangGame.word)\n\t} else if hangGame.triesLeft == 0 {\n\t\tu.room.broadcast(Devbot, \"No more tries! The word was \"+hangGame.word)\n\t}\n}\n\nfunc clearCMD(_ string, u *User) {\n\tu.term.Write([]byte(\"\\033[H\\033[2J\"))\n}\n\nfunc usersCMD(_ string, u *User) {\n\tu.room.broadcast(\"\", printUsersInRoom(u.room))\n}\n\nfunc dmRoomCMD(line string, u *User) {\n\tu.writeln(u.messaging.Name+\" <- \", line)\n\tif u == u.messaging {\n\t\tdevbotRespond(u.room, []string{\"You must be really lonely, DMing yourself.\",\n\t\t\t\"Don't worry, I won't judge :wink:\",\n\t\t\t\"srsly?\",\n\t\t\t\"what an idiot\"}, 30)\n\t\treturn\n\t}\n\tu.messaging.writeln(u.Name+\" -> \", line)\n}\n\n// named devmonk at the request of a certain ced\nfunc devmonkCMD(_ string, u *User) {\n\tsentences := []string{\"I really want to go to work, but I am too sick to drive.\", \"The fence was confused about whether it was supposed to keep things in or keep things out.\", \"He found the end of the rainbow and was surprised at what he found there.\", \"He had concluded that pigs must be able to fly in Hog Heaven.\", \"I just wanted to tell you I could see the love you have for your child by the way you look at her.\", \"We will not allow you to bring your pet armadillo along.\", \"The father died during childbirth.\", \"I covered my friend in baby oil.\", \"Cursive writing is the best way to build a race track.\", \"My Mum tries to be cool by saying that she likes all the same things that I do.\", \"The sky is clear; the stars are twinkling.\", \"Flash photography is best used in full sunlight.\", \"The rusty nail stood erect, angled at a 45-degree angle, just waiting for the perfect barefoot to come along.\", \"People keep telling me \\\"orange\\\" but I still prefer \\\"pink\\\".\", \"Peanut butter and jelly caused the elderly lady to think about her past.\", \"She always had an interesting perspective on why the world must be flat.\", \"People who insist on picking their teeth with their elbows are so annoying!\", \"Joe discovered that traffic cones make excellent megaphones.\", \"They say people remember important moments in their life well, yet no one even remembers their own birth.\", \"Purple is the best city in the forest.\", \"The book is in front of the table.\", \"Everyone was curious about the large white blimp that appeared overnight.\", \"He wondered if she would appreciate his toenail collection.\", \"Situps are a terrible way to end your day.\", \"He barked orders at his daughters but they just stared back with amusement.\", \"She couldn't decide of the glass was half empty or half full so she drank it.\", \"It caught him off guard that space smelled of seared steak.\", \"There are few things better in life than a slice of pie.\", \"After exploring the abandoned building, he started to believe in ghosts.\", \"This is a Japanese doll.\", \"I've never seen a more beautiful brandy glass filled with wine.\", \"Don't piss in my garden and tell me you're trying to help my plants grow.\", \"She looked at the masterpiece hanging in the museum but all she could think is that her five-year-old could do better.\", \"Nobody loves a pig wearing lipstick.\", \"She always speaks to him in a loud voice.\", \"The teens wondered what was kept in the red shed on the far edge of the school grounds.\", \"I'll have you know I've written over fifty novels\", \"He didn't understand why the bird wanted to ride the bicycle.\", \"Potato wedges probably are not best for relationships.\", \"Baby wipes are made of chocolate stardust.\", \"Lucifer was surprised at the amount of life at Death Valley.\", \"She was too busy always talking about what she wanted to do to actually do any of it.\", \"The sudden rainstorm washed crocodiles into the ocean.\", \"I used to live in my neighbor's fishpond, but the aesthetic wasn't to my taste.\", \"He kept telling himself that one day it would all somehow make sense.\", \"The random sentence generator generated a random sentence about a random sentence.\", \"The reservoir water level continued to lower while we enjoyed our long shower.\", \"A song can make or ruin a personâ€™s day if they let it get to them.\", \"He stomped on his fruit loops and thus became a cereal killer.\", \"I know many children ask for a pony, but I wanted a bicycle with rockets strapped to it.\"}\n\ttext := sentences[rand.Intn(len(sentences))]\n\tu.writeln(Devbot, \"Okay type this text: \\n\\n> \"+text)\n\tu.term.SetPrompt(\"> \")\n\tdefer u.formatPrompt()\n\tstart := time.Now()\n\tline, err := u.term.ReadLine()\n\tif err == term.ErrPasteIndicator { // TODO: doesn't work for some reason?\n\t\tu.room.broadcast(Devbot, \"SMH did you know that \"+u.Name+\" tried to cheat in a typing game?\")\n\t\treturn\n\t}\n\tdur := time.Since(start)\n\n\taccuracy := 100.0\n\t// analyze correctness\n\tif line != text {\n\t\twrongWords := 0\n\t\tcorrect := strings.Fields(line)\n\t\ttest := strings.Fields(text)\n\t\tif len(correct) > len(test) {\n\t\t\twrongWords += len(correct) - len(test)\n\t\t\tcorrect = correct[:len(test)]\n\t\t} else {\n\t\t\twrongWords += len(test) - len(correct)\n\t\t\ttest = test[:len(correct)]\n\t\t}\n\t\tfor i := 0; i < len(correct); i++ {\n\t\t\tif correct[i] != test[i] {\n\t\t\t\twrongWords++\n\t\t\t}\n\t\t}\n\t\taccuracy -= 100 * float64(wrongWords) / float64(len(test))\n\t\tif accuracy < 0.0 {\n\t\t\taccuracy = 0.0\n\t\t}\n\t}\n\n\tu.room.broadcast(Devbot, \"Okay \"+u.Name+\", you typed that in \"+dur.Truncate(time.Second/10).String()+\" so your speed is \"+\n\t\tstrconv.FormatFloat(\n\t\t\tfloat64(len(strings.Fields(text)))/dur.Minutes(), 'f', 1, 64,\n\t\t)+\" wpm\"+\" with accuracy \"+strconv.FormatFloat(accuracy, 'f', 1, 64)+\"%\",\n\t)\n}\n\nfunc ticCMD(rest string, u *User) {\n\tif rest == \"\" {\n\t\tu.room.broadcast(Devbot, \"Starting a new game of Tic Tac Toe! The first player is always X.\")\n\t\tu.room.broadcast(Devbot, \"Play using tic <cell num>\")\n\t\tcurrentPlayer = tictactoe.X\n\t\ttttGame = new(tictactoe.Board)\n\t\tu.room.broadcast(Devbot, \"```\\n\"+\" 1 â”‚ 2 â”‚ 3\\nâ”€â”€â”€â”¼â”€â”€â”€â”¼â”€â”€â”€\\n 4 â”‚ 5 â”‚ 6\\nâ”€â”€â”€â”¼â”€â”€â”€â”¼â”€â”€â”€\\n 7 â”‚ 8 â”‚ 9\\n\"+\"\\n```\")\n\t\treturn\n\t}\n\tm, err := strconv.Atoi(rest)\n\tif err != nil {\n\t\tu.room.broadcast(Devbot, \"Make sure you're using a number lol\")\n\t\treturn\n\t}\n\tif m < 1 || m > 9 {\n\t\tu.room.broadcast(Devbot, \"Moves are numbers between 1 and 9!\")\n\t\treturn\n\t}\n\terr = tttGame.Apply(tictactoe.Move(m-1), currentPlayer)\n\tif err != nil {\n\t\tu.room.broadcast(Devbot, err.Error())\n\t\treturn\n\t}\n\tu.room.broadcast(Devbot, \"```\\n\"+tttPrint(tttGame.Cells)+\"\\n```\")\n\tif currentPlayer == tictactoe.X {\n\t\tcurrentPlayer = tictactoe.O\n\t} else {\n\t\tcurrentPlayer = tictactoe.X\n\t}\n\tif !(tttGame.Condition() == tictactoe.NotEnd) {\n\t\tu.room.broadcast(Devbot, tttGame.Condition().String())\n\t\tcurrentPlayer = tictactoe.X\n\t\ttttGame = new(tictactoe.Board)\n\t}\n}\n\nfunc exitCMD(_ string, u *User) {\n\tu.close(u.Name + \" has left the chat\")\n}\n\nfunc bellCMD(rest string, u *User) {\n\tswitch rest {\n\tcase \"off\":\n\t\tu.Bell = false\n\t\tu.PingEverytime = false\n\t\tu.room.broadcast(\"\", \"bell off (never)\")\n\tcase \"on\":\n\t\tu.Bell = true\n\t\tu.PingEverytime = false\n\t\tu.room.broadcast(\"\", \"bell on (pings)\")\n\tcase \"all\":\n\t\tu.Bell = true\n\t\tu.PingEverytime = true\n\t\tu.room.broadcast(\"\", \"bell all (every message)\")\n\tcase \"\", \"status\":\n\t\tif u.PingEverytime {\n\t\t\tu.room.broadcast(\"\", \"bell all (every message)\")\n\t\t} else if u.Bell {\n\t\t\tu.room.broadcast(\"\", \"bell on (pings)\")\n\t\t} else { // bell is off\n\t\t\tu.room.broadcast(\"\", \"bell off (never)\")\n\t\t}\n\tdefault:\n\t\tu.room.broadcast(Devbot, \"your options are off, on and all\")\n\t}\n}\n\nfunc cdCMD(rest string, u *User) {\n\tdefer u.formatPrompt()\n\tif u.messaging != nil {\n\t\tu.messaging = nil\n\t\tu.writeln(Devbot, \"Left private chat\")\n\t\tif rest == \"\" || rest == \"..\" {\n\t\t\treturn\n\t\t}\n\t}\n\tif rest == \"..\" { // cd back into the main room\n\t\tu.room.broadcast(u.Name, \"cd \"+rest)\n\t\tif u.room != MainRoom {\n\t\t\tu.changeRoom(MainRoom)\n\t\t}\n\t\treturn\n\t}\n\tif strings.HasPrefix(rest, \"#\") {\n\t\tu.room.broadcast(u.Name, \"cd \"+rest)\n\t\tif len(rest) > MaxRoomNameLen {\n\t\t\trest = rest[0:MaxRoomNameLen]\n\t\t\tu.room.broadcast(Devbot, \"Room name lengths are limited, so I'm shortening it to \"+rest+\".\")\n\t\t}\n\t\tif v, ok := Rooms[rest]; ok {\n\t\t\tu.changeRoom(v)\n\t\t} else {\n\t\t\tRooms[rest] = &Room{rest, make([]*User, 0, 10), sync.RWMutex{}}\n\t\t\tu.changeRoom(Rooms[rest])\n\t\t}\n\t\treturn\n\t}\n\tif rest == \"\" {\n\t\tu.room.broadcast(u.Name, \"cd \"+rest)\n\t\ttype kv struct {\n\t\t\troomName   string\n\t\t\tnumOfUsers int\n\t\t}\n\t\tvar ss []kv\n\t\tfor k, v := range Rooms {\n\t\t\tss = append(ss, kv{k, len(v.users)})\n\t\t}\n\t\tsort.Slice(ss, func(i, j int) bool {\n\t\t\treturn ss[i].numOfUsers > ss[j].numOfUsers\n\t\t})\n\t\troomsInfo := \"\"\n\t\tfor _, kv := range ss {\n\t\t\troomsInfo += Blue.Paint(kv.roomName) + \": \" + printUsersInRoom(Rooms[kv.roomName]) + \"  \\n\"\n\t\t}\n\t\tu.room.broadcast(\"\", \"Rooms and users  \\n\"+strings.TrimSpace(roomsInfo))\n\t\treturn\n\t}\n\tname := strings.Fields(rest)[0]\n\tif len(name) == 0 {\n\t\tu.writeln(Devbot, \"You think people have empty names?\")\n\t\treturn\n\t}\n\tpeer, ok := findUserByName(u.room, name)\n\tif !ok {\n\t\tu.writeln(Devbot, \"No such person lol, who do you want to dm? (you might be in the wrong room)\")\n\t\treturn\n\t}\n\tu.messaging = peer\n\tu.writeln(Devbot, \"Now in DMs with \"+peer.Name+\". To leave use cd ..\")\n}\n\nfunc tzCMD(tzArg string, u *User) {\n\tdefer u.formatPrompt()\n\tif tzArg == \"\" {\n\t\tu.Timezone.Location = nil\n\t\tu.room.broadcast(Devbot, \"Enabled relative times!\")\n\t\treturn\n\t}\n\ttzArgList := strings.Fields(tzArg)\n\ttz := tzArgList[0]\n\tswitch strings.ToUpper(tz) {\n\tcase \"PST\", \"PDT\":\n\t\ttz = \"PST8PDT\"\n\tcase \"CST\", \"CDT\":\n\t\ttz = \"CST6CDT\"\n\tcase \"EST\", \"EDT\":\n\t\ttz = \"EST5EDT\"\n\tcase \"MT\":\n\t\ttz = \"America/Phoenix\"\n\t}\n\tvar err error\n\tu.Timezone.Location, err = time.LoadLocation(tz)\n\tif err != nil {\n\t\tu.room.broadcast(Devbot, \"Weird timezone you have there, use the format Continent/City, the usual US timezones (PST, PDT, EST, EDT...) or check nodatime.org/TimeZones!\")\n\t\treturn\n\t}\n\tu.FormatTime24 = len(tzArgList) == 2 && tzArgList[1] == \"24h\"\n\tu.room.broadcast(Devbot, \"Changed your timezone!\")\n}\n\nfunc bioCMD(line string, u *User) {\n\tif line == \"\" {\n\t\tu.writeln(Devbot, \"Your current bio is:  \\n> \"+u.Bio)\n\t\tu.term.SetPrompt(\"> \")\n\t\tdefer u.formatPrompt()\n\t\tfor {\n\t\t\tinput, err := u.term.ReadLine()\n\t\t\tif err != nil {\n\t\t\t\treturn\n\t\t\t}\n\t\t\tinput = strings.TrimSpace(input)\n\t\t\tif input != \"\" {\n\t\t\t\tif len(input) > MaxBioLen {\n\t\t\t\t\tu.writeln(Devbot, \"Your bio is too long. It shouldn't be more than \"+strconv.Itoa(MaxBioLen)+\" characters.\")\n\t\t\t\t}\n\t\t\t\tu.Bio = input\n\t\t\t\t// make sure it gets saved now so it stays even if the server crashes\n\t\t\t\tu.savePrefs() //nolint:errcheck // best effort\n\t\t\t\treturn\n\t\t\t}\n\t\t}\n\t}\n\ttarget, ok := findUserByName(u.room, line)\n\tif !ok {\n\t\tu.room.broadcast(Devbot, \"Who???\")\n\t\treturn\n\t}\n\tu.room.broadcast(\"\", target.Bio)\n}\n\nfunc idCMD(line string, u *User) {\n\tvictim, ok := findUserByName(u.room, line)\n\tif !ok {\n\t\tu.room.broadcast(\"\", \"User not found\")\n\t\treturn\n\t}\n\tu.room.broadcast(\"\", victim.id)\n}\n\nfunc nickCMD(line string, u *User) {\n\tu.pickUsername(line) //nolint:errcheck // if reading input fails, the next repl will err out\n}\n\nfunc promptCMD(line string, u *User) {\n\tu.Prompt = line\n\tu.formatPrompt()\n\tif line == \"\" {\n\t\tu.writeln(Devbot, \"(Your prompt is now empty. Did you mean to get more info about your prompt? Run `man prompt` for more info)\")\n\t}\n}\n\nfunc listBansCMD(_ string, u *User) {\n\tmsg := \"Bans by ID:  \\n\"\n\tfor i := 0; i < len(Bans); i++ {\n\t\tmsg += Cyan.Cyan(strconv.Itoa(i+1)) + \". \" + Bans[i].ID + \"  \\n\"\n\t}\n\tu.room.broadcast(Devbot, msg)\n}\n\nfunc unbanCMD(toUnban string, u *User) {\n\tif !auth(u) {\n\t\tu.room.broadcast(Devbot, \"Not authorized\")\n\t\treturn\n\t}\n\n\tif unbanIDorIP(toUnban) {\n\t\tu.room.broadcast(Devbot, \"Unbanned person: \"+toUnban)\n\t\tsaveBans()\n\t} else {\n\t\tu.room.broadcast(Devbot, \"I couldn't find that person\")\n\t}\n}\n\n// unbanIDorIP unbans an ID or an IP, but does NOT save bans to the bans file.\n// It returns whether the person was found, and so, whether the bans slice was modified.\nfunc unbanIDorIP(toUnban string) bool {\n\tfor i := 0; i < len(Bans); i++ {\n\t\tif Bans[i].ID == toUnban || Bans[i].Addr == toUnban { // allow unbanning by either ID or IP\n\t\t\t// remove this ban\n\t\t\tBans = append(Bans[:i], Bans[i+1:]...)\n\t\t\tsaveBans()\n\t\t\treturn true\n\t\t}\n\t}\n\treturn false\n}\n\nfunc banCMD(line string, u *User) {\n\tsplit := strings.Split(line, \" \")\n\tif len(split) == 0 {\n\t\tu.room.broadcast(Devbot, \"Which user do you want to ban?\")\n\t\treturn\n\t}\n\tvar victim *User\n\tvar ok bool\n\tbanner := u.Name\n\tbanReason := \"\" // Initial ban reason is an empty string\n\n\tif split[0] == \"devbot\" {\n\t\tu.room.broadcast(Devbot, \"Do you really think you can ban me, puny human?\")\n\t\tvictim = u // mwahahahaha - devbot\n\t\tbanner = Devbot\n\t} else if !auth(u) {\n\t\tu.room.broadcast(Devbot, \"Not authorized\")\n\t\treturn\n\t} else if victim, ok = findUserByName(u.room, split[0]); !ok {\n\t\tu.room.broadcast(\"\", \"User not found\")\n\t\treturn\n\t}\n\n\tif len(split) > 1 {\n\t\tdur, err := time.ParseDuration(split[len(split)-1])\n\t\tif err != nil {\n\t\t\tsplit[len(split)-1] = \"\" // there's no duration so don't trim anything from the reason\n\t\t}\n\t\tif len(split) > 2 {\n\t\t\tbanReason = strings.TrimSpace(strings.TrimSuffix(strings.TrimPrefix(line, split[0]), split[len(split)-1]))\n\t\t}\n\t\tif err == nil { // there was a duration\n\t\t\tvictim.ban(victim.Name + \" has been banned by \" + banner + \" for \" + dur.String() + \" \" + banReason)\n\t\t\tgo func(id string) {\n\t\t\t\ttime.Sleep(dur)\n\t\t\t\tunbanIDorIP(id)\n\t\t\t}(victim.id) // evaluate id now, call unban with that value later\n\t\t\treturn\n\t\t}\n\t}\n\tvictim.ban(victim.Name + \" has been banned by \" + banner + \" \" + banReason)\n}\n\nfunc kickCMD(line string, u *User) {\n\tvictim, ok := findUserByName(u.room, line)\n\tif !ok {\n\t\tif line == \"devbot\" {\n\t\t\tu.room.broadcast(Devbot, \"You will pay for this\")\n\t\t\tu.close(u.Name + Red.Paint(\" has been kicked by \") + Devbot)\n\t\t} else {\n\t\t\tu.room.broadcast(\"\", \"User not found\")\n\t\t}\n\t\treturn\n\t}\n\tif !auth(u) && victim.id != u.id {\n\t\tu.room.broadcast(Devbot, \"Not authorized\")\n\t\treturn\n\t}\n\tvictim.close(victim.Name + Red.Paint(\" has been kicked by \") + u.Name)\n}\n\nfunc muteCMD(line string, u *User) {\n\tvictim, ok := findUserByName(u.room, line)\n\tif !ok {\n\t\tu.room.broadcast(\"\", \"User not found\")\n\t\treturn\n\t}\n\tif !auth(u) && victim.id != u.id {\n\t\tu.room.broadcast(Devbot, \"Not authorized\")\n\t\treturn\n\t}\n\tvictim.IsMuted = true\n}\n\nfunc unmuteCMD(line string, u *User) {\n\tvictim, ok := findUserByName(u.room, line)\n\tif !ok {\n\t\tu.room.broadcast(\"\", \"User not found\")\n\t\treturn\n\t}\n\tif !auth(u) && victim.id != u.id {\n\t\tu.room.broadcast(Devbot, \"Not authorized\")\n\t\treturn\n\t}\n\tvictim.IsMuted = false\n}\n\nfunc colorCMD(rest string, u *User) {\n\tif rest == \"which\" {\n\t\tu.room.broadcast(Devbot, u.Color+\" \"+u.ColorBG)\n\t} else if err := u.changeColor(rest); err != nil {\n\t\tu.room.broadcast(Devbot, err.Error())\n\t}\n}\n\nfunc adminsCMD(_ string, u *User) {\n\tmsg := \"Admins by ID:  \\n\"\n\ti := 1\n\tfor id, info := range Config.Admins {\n\t\tif len(id) > 10 {\n\t\t\tid = id[:10] + \"...\"\n\t\t}\n\t\tmsg += Cyan.Cyan(strconv.Itoa(i)) + \". \" + id + \"\\t\" + info + \"  \\n\"\n\t\ti++\n\t}\n\tu.room.broadcast(Devbot, msg)\n}\n\nfunc helpCMD(_ string, u *User) {\n\tu.room.broadcast(\"\", `Welcome to Devzat! Devzat is chat over SSH: github.com/quackduck/devzat  \nBecause there's SSH apps on all platforms, even on mobile, you can join from anywhere.\n\nRun cmds to see a list of commands.\n\nInteresting features:\n* Rooms! Run cd to see all rooms and use cd #foo to join a new room.\n* Markdown support! Tables, headers, italics and everything. Just use \\\\n in place of newlines.\n* Code syntax highlighting. Use Markdown fences to send code. Run eg-code to see an example.\n* Direct messages! Send a quick DM using =user <msg> or stay in DMs by running cd @user.\n* Timezone support, use tz Continent/City to set your timezone.\n* Built in Tic Tac Toe and Hangman! Run tic or hang <word> to start new games.\n* Emoji replacements! \\:rocket\\: => :rocket: (like on Slack and Discord)\n\nFor replacing newlines, I often use https\\://bulkseotools.com/add-remove-line-breaks.php.\n\nJoin the Devzat discord server: https://discord.gg/yERQNTBbD5\n\nMade by Ishan Goel with feature ideas from friends.  \nThanks to Caleb Denio for lending his server!`)\n}\n\nfunc catCMD(line string, u *User) {\n\tif line == \"\" {\n\t\tu.room.broadcast(\"\", \"usage: cat [-benstuv] [file ...]\")\n\t} else if line == \"README.md\" {\n\t\thelpCMD(line, u)\n\t} else {\n\t\tu.room.broadcast(\"\", \"cat: \"+line+\": Permission denied\")\n\t}\n}\n\nfunc rmCMD(line string, u *User) {\n\tif line == \"\" {\n\t\tu.room.broadcast(\"\", `usage: rm [-f | -i] [-dPRrvW] file ...\nunlink file`)\n\t} else {\n\t\tu.room.broadcast(\"\", \"rm: \"+line+\": Permission denied, sucker\")\n\t}\n}\n\nfunc exampleCodeCMD(line string, u *User) {\n\tif line == \"big\" {\n\t\tu.room.broadcast(Devbot, \"```go\\npackage main\\n\\nimport \\\"fmt\\\"\\n\\nfunc sum(nums ...int) {\\n    fmt.Print(nums, \\\" \\\")\\n    total := 0\\n    for _, num := range nums {\\n        total += num\\n    }\\n    fmt.Println(total)\\n}\\n\\nfunc main() {\\n\\n    sum(1, 2)\\n    sum(1, 2, 3)\\n\\n    nums := []int{1, 2, 3, 4}\\n    sum(nums...)\\n}\\n```\")\n\t\treturn\n\t}\n\tu.room.broadcast(Devbot, \"\\n```go\\npackage main\\nimport \\\"fmt\\\"\\nfunc main() {\\n   fmt.Println(\\\"Example!\\\")\\n}\\n```\")\n}\n\nfunc init() { // add Matt Gleich's blackbird theme from https://github.com/blackbirdtheme/vscode/blob/master/themes/blackbird-midnight-color-theme.json#L175\n\tred := \"#ff1131\" // added saturation\n\tredItalic := \"italic \" + red\n\twhite := \"#fdf7cd\"\n\tyellow := \"#e1db3f\"\n\tblue := \"#268ef8\"  // added saturation\n\tgreen := \"#22e327\" // added saturation\n\tgray := \"#5a637e\"\n\tteal := \"#00ecd8\"\n\ttealItalic := \"italic \" + teal\n\n\tchromastyles.Register(chroma.MustNewStyle(\"blackbird\", chroma.StyleEntries{chroma.Text: white, chroma.Error: red, chroma.Comment: gray, chroma.Keyword: redItalic, chroma.KeywordNamespace: redItalic, chroma.KeywordType: tealItalic, chroma.Operator: blue, chroma.Punctuation: white, chroma.Name: white, chroma.NameAttribute: white, chroma.NameClass: green, chroma.NameConstant: tealItalic, chroma.NameDecorator: green, chroma.NameException: red, chroma.NameFunction: green, chroma.NameOther: white, chroma.NameTag: yellow, chroma.LiteralNumber: blue, chroma.Literal: yellow, chroma.LiteralDate: yellow, chroma.LiteralString: yellow, chroma.LiteralStringEscape: teal, chroma.GenericDeleted: red, chroma.GenericEmph: \"italic\", chroma.GenericInserted: green, chroma.GenericStrong: \"bold\", chroma.GenericSubheading: yellow, chroma.Background: \"bg:#000000\"}))\n}\n\nfunc themeCMD(line string, u *User) {\n\t// TODO: make this work with glamour\n\tu.room.broadcast(Devbot, \"Themes do not currently work because Devzat is switching to using glamour for rendering.\")\n\tif line == \"list\" {\n\t\tu.room.broadcast(Devbot, \"Available themes: \"+strings.Join(chromastyles.Names(), \", \"))\n\t\treturn\n\t}\n\tfor _, name := range chromastyles.Names() {\n\t\tif name == line {\n\t\t\t//markdown.CurrentTheme = chromastyles.Get(name)\n\t\t\tu.room.broadcast(Devbot, \"Theme set to \"+name)\n\t\t\treturn\n\t\t}\n\t}\n\tu.room.broadcast(Devbot, \"What theme is that? Use theme list to see what's available.\")\n}\n\nfunc asciiArtCMD(_ string, u *User) {\n\tu.room.broadcast(\"\", Art)\n}\n\nfunc pwdCMD(_ string, u *User) {\n\tif u.messaging != nil {\n\t\tu.writeln(\"\", u.messaging.Name)\n\t} else {\n\t\tu.room.broadcast(\"\", u.room.name)\n\t}\n}\n\nfunc shrugCMD(line string, u *User) {\n\tu.room.broadcast(u.Name, line+` Â¯\\\\_(ãƒ„)_/Â¯`)\n}\n\nfunc pronounsCMD(line string, u *User) {\n\targs := strings.Fields(line)\n\n\tif line == \"\" {\n\t\tu.room.broadcast(Devbot, \"Set pronouns by providing em or query a user's pronouns!\")\n\t\treturn\n\t}\n\n\tif len(args) == 1 && strings.HasPrefix(args[0], \"@\") {\n\t\tvictim, ok := findUserByName(u.room, args[0][1:])\n\t\tif !ok {\n\t\t\tu.room.broadcast(Devbot, \"Who's that?\")\n\t\t\treturn\n\t\t}\n\t\tu.room.broadcast(Devbot, victim.Name+\"'s pronouns are \"+victim.displayPronouns())\n\t\treturn\n\t}\n\n\tu.Pronouns = strings.Fields(strings.ReplaceAll(strings.ToLower(line), \"\\n\", \"\"))\n\t//u.changeColor(u.Color) // refresh pronouns\n\tu.room.broadcast(Devbot, u.Name+\" now goes by \"+u.displayPronouns())\n}\n\nfunc emojisCMD(_ string, u *User) {\n\tu.room.broadcast(Devbot, `See the complete list at https://github.com/ikatyang/emoji-cheat-sheet/  \nHere are a few examples (type :emoji_text: to use):  \n:doughnut: doughnut  \n:yum: yum  \n:joy: joy  \n:thinking: thinking  \n:smile: smile  \n:zipper_mouth_face: zipper_mouth_face  \n:kangaroo: kangaroo  \n:sleepy: sleepy  \n:hot_pepper:  hot_pepper  \n:face_with_thermometer: face_with_thermometer  \n:dumpling: dumpling  \n:sunglasses: sunglasses  \n:skull: skull`)\n}\n\nfunc commandsRestCMD(_ string, u *User) {\n\tu.room.broadcast(\"\", \"The rest  \\n\"+autogenCommands(RestCMDs))\n}\n\nfunc manCMD(rest string, u *User) {\n\tif rest == \"\" {\n\t\tu.room.broadcast(Devbot, \"What command do you want help with?\")\n\t\treturn\n\t}\n\n\tif rest == \"prompt\" {\n\t\tu.room.broadcast(Devbot, `prompt <prompt> sets your prompt\n\nYou can use some bash PS1 tags in it.  \nThe supported tags are:  \n* \\u: your user name\n* \\h, \\H: devzat colored like your username\n* \\t, \\T: the time in your preferred formatting\n* \\w: the current room\n* \\W: the current room with #main aliased to ~\n* \\S: a space character\n* \\$: $ for normal users, # for admins\n\nThe default prompt is \"\\u:\\S\".`)\n\t\treturn\n\t}\n\n\tif cmd, ok := getCMD(rest); ok {\n\t\tu.room.broadcast(Devbot, \"Usage: \"+cmd.name+\" \"+cmd.argsInfo+\"  \\n\"+cmd.info)\n\t\treturn\n\t}\n\t// Plugin commands\n\tif c, ok := PluginCMDs[rest]; ok {\n\t\tu.room.broadcast(Devbot, \"Usage: \"+rest+\" \"+c.argsInfo+\"  \\n\"+c.info)\n\t\treturn\n\t}\n\n\tu.room.broadcast(\"\", \"This system has been minimized by removing packages and content that are not required on a system that users do not log into.\\n\\nTo restore this content, including manpages, you can run the 'unminimize' command. You will still need to ensure the 'man-db' package is installed.\")\n}\n\nfunc lsCMD(rest string, u *User) {\n\tif len(rest) > 0 && rest[0] == '#' {\n\t\tif r, ok := Rooms[rest]; ok {\n\t\t\tusersList := \"\"\n\t\t\tfor _, us := range r.users {\n\t\t\t\tusersList += us.Name + Blue.Paint(\"/ \")\n\t\t\t}\n\t\t\tu.room.broadcast(\"\", usersList)\n\t\t\treturn\n\t\t}\n\t}\n\tif rest == \"-i\" { // show ids\n\t\ts := \"\"\n\t\tfor _, us := range u.room.users {\n\t\t\ts += us.id + \" \" + us.Name + \"  \\n\"\n\t\t}\n\t\tu.room.broadcast(\"\", s)\n\t\treturn\n\t}\n\tif rest != \"\" {\n\t\tu.room.broadcast(\"\", \"ls: \"+rest+\" Permission denied\")\n\t\treturn\n\t}\n\troomList := \"\"\n\tfor _, r := range Rooms {\n\t\troomList += Blue.Paint(r.name + \"/ \")\n\t}\n\tusersList := \"\"\n\tfor _, us := range u.room.users {\n\t\tusersList += us.Name + Blue.Paint(\"/ \")\n\t}\n\tusersList += Devbot + Blue.Paint(\"/ \")\n\tu.room.broadcast(\"\", \"README.md \"+usersList+roomList)\n}\n\nfunc commandsCMD(_ string, u *User) {\n\tu.room.broadcast(\"\", \"Commands  \\n\"+autogenCommands(MainCMDs))\n}\n\nfunc unameCMD(rest string, u *User) {\n\tif unameCommit == \"\" || unameTime == \"\" {\n\t\tu.room.broadcast(\"\", \"No uname output available. Build Devzat with `\"+color.HiYellowString(`go build -ldflags \"-X 'main.unameCommit=$(git rev-parse HEAD)' -X 'main.unameTime=$(date)'\"`)+\"` to enable.\")\n\t\treturn\n\t}\n\tu.room.broadcast(\"\", \"Devzat (\"+unameCommit+\") \"+unameTime)\n}\n\nfunc uptimeCMD(rest string, u *User) {\n\tuptime := time.Since(StartupTime)\n\tu.room.broadcast(\"\", fmt.Sprintf(\"up %v days, %02d:%02d:%02d\", int(uptime.Hours()/24), int(math.Mod(uptime.Hours(), 24)), int(math.Mod(uptime.Minutes(), 60)), int(math.Mod(uptime.Seconds(), 60))))\n}\n\nfunc neofetchCMD(_ string, u *User) {\n\tcontent, err := os.ReadFile(Config.DataDir + \"/neofetch.txt\")\n\tif err != nil {\n\t\tu.room.broadcast(\"\", \"Error reading \"+Config.DataDir+\"/neofetch.txt: \"+err.Error())\n\t\treturn\n\t}\n\tcontentSplit := strings.Split(string(content), \"\\n\")\n\tuptime := time.Since(StartupTime)\n\tuptimeStr := fmt.Sprintf(\"%v days, %v hours, %v minutes\", int(uptime.Hours()/24), int(math.Mod(uptime.Hours(), 24)), int(math.Mod(uptime.Minutes(), 60)))\n\tmemstats := runtime.MemStats{}\n\truntime.ReadMemStats(&memstats)\n\tyellow := gchalk.RGB(255, 255, 0)\n\tuserHost := yellow(os.Getenv(\"USER\")) + \"@\" + yellow(os.Getenv(\"HOSTNAME\"))\n\tcolorSwatch1 := \"\\u001B[30m\\u001B[40m   \\u001B[31m\\u001B[41m   \\u001B[32m\\u001B[42m   \\u001B[33m\\u001B[43m   \\u001B[34m\\u001B[44m   \\u001B[35m\\u001B[45m   \\u001B[36m\\u001B[46m   \\u001B[37m\\u001B[47m   \\u001B[m\"\n\tcolorSwatch2 := \"\\u001B[38;5;8m\\u001B[48;5;8m   \\u001B[38;5;9m\\u001B[48;5;9m   \\u001B[38;5;10m\\u001B[48;5;10m   \\u001B[38;5;11m\\u001B[48;5;11m   \\u001B[38;5;12m\\u001B[48;5;12m   \\u001B[38;5;13m\\u001B[48;5;13m   \\u001B[38;5;14m\\u001B[48;5;14m   \\u001B[38;5;15m\\u001B[48;5;15m   \\u001B[m\"\n\tproperties := []struct {\n\t\tKey   string\n\t\tValue string\n\t}{\n\t\t{\"\", userHost},\n\t\t{\"\", strings.Repeat(\"-\", len(userHost))},\n\t\t{\"OS\", \"Devzat\"},\n\t\t{\"Uptime\", uptimeStr},\n\t\t{\"Packages\", fmt.Sprint(len(PluginCMDs)+len(MainCMDs)+len(RestCMDs)) + \" commands\"},\n\t\t{\"Shell\", \"devzat\"},\n\t\t{\"Memory\", fmt.Sprintf(\"%v MiB alloc / %v MiB sys, %v GC cycles\", memstats.Alloc/1024/1024, memstats.Sys/1024/1024, memstats.NumGC)},\n\t\t{\"\", \"\"},\n\t\t{\"\", colorSwatch1},\n\t\t{\"\", colorSwatch2},\n\t}\n\tresult := \"\"\n\tfor i, l := range contentSplit {\n\t\tresult += l\n\t\tif i < len(properties) {\n\t\t\tp := properties[i]\n\t\t\tif p.Key != \"\" && p.Value != \"\" {\n\t\t\t\tresult += \"   \" + yellow(p.Key) + \": \" + p.Value\n\t\t\t} else if p.Value != \"\" {\n\t\t\t\tresult += \"   \" + p.Value\n\t\t\t}\n\t\t}\n\t\tresult += \"  \\n\"\n\t}\n\tu.room.broadcast(\"\", result)\n}\n\nfunc eightBallCMD(_ string, u *User) {\n\tresponses := []string{\n\t\t\"It is certain, \", \"It is decidedly so, \", \"Without a doubt, \", \"Yes, definitely, \",\n\t\t\"You may rely on it, \", \"As I see it, yes, \", \"Most likely, \", \"Outlook good, \",\n\t\t\"Yes, \", \"Signs point to yes, \", \"Reply hazy, try again, \", \"Ask again later, \",\n\t\t\"Better not tell you now, \", \"Cannot predict now, \", \"Concentrate and ask again, \",\n\t\t\"Don't count on it, \", \"My reply is no, \", \"My sources say no, \", \"Outlook not so good, \",\n\t\t\"Very doubtful, \",\n\t}\n\tgo func() {\n\t\ttime.Sleep(time.Second * time.Duration(rand.Intn(10)))\n\t\tu.room.broadcast(\"8ball\", responses[rand.Intn(len(responses))]+u.Name)\n\t}()\n}\n\nfunc rmdirCMD(rest string, u *User) {\n\tif rest == \"#main\" {\n\t\tu.room.broadcast(\"\", \"rmdir: failed to remove '\"+rest+\"': Operation not permitted\")\n\t} else if room, ok := Rooms[rest]; ok {\n\t\tif len(room.users) == 0 {\n\t\t\tdelete(Rooms, rest)\n\t\t\tu.room.broadcast(\"\", \"rmdir: removing directory, '\"+rest+\"'\")\n\t\t} else {\n\t\t\tu.room.broadcast(\"\", \"rmdir: failed to remove '\"+rest+\"': Room not empty\")\n\t\t}\n\t} else {\n\t\tu.room.broadcast(\"\", \"rmdir: failed to remove '\"+rest+\"': No such room\")\n\t}\n}\n"
        },
        {
          "name": "compile-protobuf.sh",
          "type": "blob",
          "size": 0.1708984375,
          "content": "#!/bin/sh\n\nprotoc --go_out=. --go_opt=paths=source_relative --go-grpc_out=. --go-grpc_opt=paths=source_relative ./plugin/plugin.proto && echo \"Generated Go code for protobuf\"\n"
        },
        {
          "name": "config.go",
          "type": "blob",
          "size": 5.5048828125,
          "content": "package main\n\nimport (\n\t\"fmt\"\n\t\"io\"\n\t\"log\"\n\t\"os\"\n\t\"strconv\"\n\n\t\"gopkg.in/yaml.v2\"\n)\n\ntype ConfigType struct {\n\tPort        int               `yaml:\"port\"`\n\tAltPort     int               `yaml:\"alt_port\"`\n\tProfilePort int               `yaml:\"profile_port\"`\n\tScrollback  int               `yaml:\"scrollback\"`\n\tDataDir     string            `yaml:\"data_dir\"`\n\tKeyFile     string            `yaml:\"key_file\"`\n\tAdmins      map[string]string `yaml:\"admins\"`\n\tCensor      bool              `yaml:\"censor,omitempty\"`\n\tPrivate     bool              `yaml:\"private,omitempty\"`\n\tAllowlist   map[string]string `yaml:\"allowlist,omitempty\"`\n\n\tIntegrationConfig string `yaml:\"integration_config\"`\n}\n\n// IntegrationsType stores information needed by integrations.\n// Code that uses this should check if fields are nil.\ntype IntegrationsType struct {\n\t// Twitter stores the information needed for the Twitter integration.\n\t// Check if it is enabled by checking if Twitter is nil.\n\tTwitter *TwitterInfo `yaml:\"twitter\"`\n\t// Slack stores the information needed for the Slack integration.\n\t// Check if it is enabled by checking if Slack is nil.\n\tSlack *SlackInfo `yaml:\"slack\"`\n\t// Discord stores the information needed for the Discord integration.\n\t// Check if it is enabled by checking if Discord is nil.\n\tDiscord *DiscordInfo `yaml:\"discord\"`\n\n\tRPC *RPCInfo `yaml:\"rpc\"`\n}\n\ntype TwitterInfo struct {\n\tConsumerKey       string `yaml:\"consumer_key\"`\n\tConsumerSecret    string `yaml:\"consumer_secret\"`\n\tAccessToken       string `yaml:\"access_token\"`\n\tAccessTokenSecret string `yaml:\"access_token_secret\"`\n}\n\ntype SlackInfo struct {\n\t// Token is the Slack API token\n\tToken string `yaml:\"token\"`\n\t// ChannelID is the Slack channel to post to\n\tChannelID string `yaml:\"channel_id\"`\n\t// Prefix is the prefix to prepend to messages from Slack when rendered for SSH users\n\tPrefix string `yaml:\"prefix\"`\n}\n\ntype DiscordInfo struct {\n\t// Token is the Discord API token\n\tToken string `yaml:\"token\"`\n\t// ChannelID is the ID of the channel to post to\n\tChannelID string `yaml:\"channel_id\"`\n\t// Prefix is the prefix to prepend to messages from Discord when rendered for SSH users\n\tPrefix string `yaml:\"prefix\"`\n\t// Compact mode disables avatars to save vertical space\n\tCompactMode bool `yaml:\"compact_mode\"`\n}\n\ntype RPCInfo struct {\n\tPort int    `yaml:\"port\"`\n\tKey  string `yaml:\"key\"`\n}\n\nvar (\n\tConfig = ConfigType{ // first stores default config\n\t\tPort:        2221,\n\t\tAltPort:     8080,\n\t\tProfilePort: 5555,\n\t\tScrollback:  16,\n\t\tDataDir:     \"devzat-data\",\n\t\tKeyFile:     \"devzat-sshkey\",\n\n\t\tIntegrationConfig: \"\",\n\t}\n\n\tIntegrations = IntegrationsType{} // all nil\n\n\tLog *log.Logger\n)\n\nfunc init() {\n\tcfgFile := os.Getenv(\"DEVZAT_CONFIG\")\n\tif cfgFile == \"\" {\n\t\tcfgFile = \"devzat.yml\"\n\t}\n\n\terrCheck := func(err error) {\n\t\tif err != nil {\n\t\t\tfmt.Println(\"err: \" + err.Error())\n\t\t\tos.Exit(0) // match `return` behavior\n\t\t}\n\t}\n\n\tvar d []byte\n\tif _, err := os.Stat(cfgFile); err != nil {\n\t\tif os.IsNotExist(err) {\n\t\t\tfmt.Println(\"Config file not found, so using the default one and writing it to \" + cfgFile)\n\n\t\t\td, err = yaml.Marshal(Config)\n\t\t\terrCheck(err)\n\t\t\terr = os.WriteFile(cfgFile, d, 0644)\n\t\t}\n\t\terrCheck(err)\n\t} else {\n\t\td, err = os.ReadFile(cfgFile)\n\t\terrCheck(err)\n\t\terr = yaml.UnmarshalStrict(d, &Config)\n\t\terrCheck(err)\n\t\tfmt.Println(\"Config loaded from \" + cfgFile)\n\t}\n\n\terr := os.MkdirAll(Config.DataDir, 0755)\n\terrCheck(err)\n\n\tlogfile, err := os.OpenFile(Config.DataDir+string(os.PathSeparator)+\"log.txt\", os.O_TRUNC|os.O_CREATE|os.O_WRONLY, 0666)\n\terrCheck(err)\n\tLog = log.New(io.MultiWriter(logfile, os.Stdout), \"\", log.Ldate|log.Ltime|log.Lshortfile)\n\n\tif os.Getenv(\"PORT\") != \"\" {\n\t\tConfig.Port, err = strconv.Atoi(os.Getenv(\"PORT\"))\n\t\terrCheck(err)\n\t}\n\n\tBacklog = make([]backlogMessage, Config.Scrollback)\n\n\tif Config.IntegrationConfig != \"\" {\n\t\td, err = os.ReadFile(Config.IntegrationConfig)\n\t\terrCheck(err)\n\t\terr = yaml.UnmarshalStrict(d, &Integrations)\n\t\terrCheck(err)\n\n\t\tif Integrations.Slack != nil {\n\t\t\tif Integrations.Slack.Prefix == \"\" {\n\t\t\t\tIntegrations.Slack.Prefix = \"Slack\"\n\t\t\t}\n\t\t\tif sl := Integrations.Slack; sl.Token == \"\" || sl.ChannelID == \"\" {\n\t\t\t\tfmt.Println(\"error: Slack token or channel ID is missing\")\n\t\t\t\tos.Exit(0)\n\t\t\t}\n\t\t}\n\t\tif Integrations.Discord != nil {\n\t\t\tif Integrations.Discord.Prefix == \"\" {\n\t\t\t\tIntegrations.Discord.Prefix = \"Discord\"\n\t\t\t}\n\t\t\tif sl := Integrations.Discord; sl.Token == \"\" || sl.ChannelID == \"\" {\n\t\t\t\tfmt.Println(\"error: Discord token or channel ID is missing\")\n\t\t\t\tos.Exit(0)\n\t\t\t}\n\t\t}\n\t\tif Integrations.Twitter != nil {\n\t\t\tif tw := Integrations.Twitter; tw.AccessToken == \"\" ||\n\t\t\t\ttw.AccessTokenSecret == \"\" ||\n\t\t\t\ttw.ConsumerKey == \"\" ||\n\t\t\t\ttw.ConsumerSecret == \"\" {\n\t\t\t\tfmt.Println(\"error: Twitter credentials are incomplete\")\n\t\t\t\tos.Exit(0)\n\t\t\t}\n\t\t}\n\n\t\tfmt.Println(\"Integration config loaded from \" + Config.IntegrationConfig)\n\n\t\tif os.Getenv(\"DEVZAT_OFFLINE_SLACK\") != \"\" {\n\t\t\tfmt.Println(\"Disabling Slack\")\n\t\t\tIntegrations.Slack = nil\n\t\t}\n\t\tif os.Getenv(\"DEVZAT_OFFLINE_DISCORD\") != \"\" {\n\t\t\tfmt.Println(\"Disabling Discord\")\n\t\t\tIntegrations.Discord = nil\n\t\t}\n\t\tif os.Getenv(\"DEVZAT_OFFLINE_TWITTER\") != \"\" {\n\t\t\tfmt.Println(\"Disabling Twitter\")\n\t\t\tIntegrations.Twitter = nil\n\t\t}\n\t\tif os.Getenv(\"DEVZAT_OFFLINE_RPC\") != \"\" {\n\t\t\tfmt.Println(\"Disabling RPC\")\n\t\t\tIntegrations.RPC = nil\n\t\t}\n\t\t// Check for global offline for backwards compatibility\n\t\tif os.Getenv(\"DEVZAT_OFFLINE\") != \"\" {\n\t\t\tfmt.Println(\"Offline mode\")\n\t\t\tIntegrations.Slack = nil\n\t\t\tIntegrations.Discord = nil\n\t\t\tIntegrations.Twitter = nil\n\t\t\tIntegrations.RPC = nil\n\t\t}\n\t}\n\tslackInit()\n\tdiscordInit()\n\ttwitterInit()\n\trpcInit()\n}\n"
        },
        {
          "name": "devzat-data",
          "type": "tree",
          "content": null
        },
        {
          "name": "devzat_test.go",
          "type": "blob",
          "size": 6.5693359375,
          "content": "// This module is meant to be some standard Go unit tests for Devzat. Run\n// `go test` to run them.\n\npackage main\n\nimport (\n\t\"io\"\n\t\"net\"\n\t\"strings\"\n\t\"sync\"\n\t\"testing\"\n\n\t\"github.com/acarl005/stripansi\"\n\t\"github.com/gliderlabs/ssh\"\n\tterminal \"github.com/quackduck/term\"\n)\n\ntype dummyRW struct{}\n\nfunc (rw dummyRW) Read(p []byte) (n int, err error)  { return 0, nil }\nfunc (rw dummyRW) Write(p []byte) (n int, err error) { return 0, nil }\n\ntype dummySession struct{}\n\nfunc (s dummySession) User() string                            { return \"\" }\nfunc (s dummySession) RemoteAddr() net.Addr                    { return nil }\nfunc (s dummySession) LocalAddr() net.Addr                     { return nil }\nfunc (s dummySession) Environ() []string                       { return make([]string, 0) }\nfunc (s dummySession) Exit(code int) error                     { return nil }\nfunc (s dummySession) Command() []string                       { return make([]string, 0) }\nfunc (s dummySession) RawCommand() string                      { return \"\" }\nfunc (s dummySession) Subsystem() string                       { return \"\" }\nfunc (s dummySession) PublicKey() ssh.PublicKey                { return nil }\nfunc (s dummySession) Context() ssh.Context                    { return nil }\nfunc (s dummySession) Permissions() ssh.Permissions            { return ssh.Permissions{} }\nfunc (s dummySession) Pty() (ssh.Pty, <-chan ssh.Window, bool) { return ssh.Pty{}, nil, true }\nfunc (s dummySession) Signals(c chan<- ssh.Signal)             {}\nfunc (s dummySession) Break(c chan<- bool)                     {}\nfunc (s dummySession) Close() error                            { return nil }\nfunc (s dummySession) CloseWrite() error                       { return nil }\nfunc (s dummySession) Read(data []byte) (int, error)           { return 0, nil }\nfunc (s dummySession) SendRequest(name string, wantReply bool, payload []byte) (bool, error) {\n\treturn false, nil\n}\nfunc (s dummySession) Stderr() io.ReadWriter          { return nil }\nfunc (s dummySession) Write(data []byte) (int, error) { return 0, nil }\n\nfunc makeDummyRoom() *Room {\n\tdrw := dummyRW{}\n\tdummyTerm := terminal.NewTerminal(drw, \"\")\n\tret := &Room{name: \"DummyRoom\", users: []*User{}, usersMutex: sync.RWMutex{}}\n\n\ttim := &User{Name: \"tim\", term: dummyTerm, ColorBG: \"bg-off\", room: ret, session: dummySession{}}\n\t_ = tim.changeColor(\"red\")\n\ttom := &User{Name: \"tom\", term: dummyTerm, ColorBG: \"bg-off\", room: ret, session: dummySession{}}\n\t_ = tom.changeColor(\"blue\")\n\ttimtom := &User{Name: \"timtom\", term: dummyTerm, ColorBG: \"bg-off\", room: ret, session: dummySession{}}\n\t_ = timtom.changeColor(\"sky\")\n\ttimt := &User{Name: \"timt\", term: dummyTerm, ColorBG: \"bg-off\", room: ret, session: dummySession{}}\n\t_ = timt.changeColor(\"coral\")\n\n\tret.users = append(ret.users, tim, tom, timtom, timt)\n\treturn ret\n}\n\n/* ------------------ Testing correctness of findMention ------------------- */\n\nfunc performTestFindMention(t *testing.T, r *Room, raw string, expected string) {\n\tcolored := r.findMention(raw)\n\tt.Log(colored)\n\tif colored != expected {\n\t\tt.Log(expected)\n\t\tt.Fail()\n\t}\n}\n\nfunc TestFindMention(t *testing.T) {\n\tr := makeDummyRoom()\n\tinputMsg := \"@tim @tom @timtom @timt Hi!\"\n\t// Warning, the order the elements have been put in the dummy room affects the result of the test\n\texpectedMsg := r.users[0].Name + \" \" + r.users[1].Name + \" \" + r.users[2].Name + \" \" + r.users[3].Name + \" Hi!\"\n\tperformTestFindMention(t, r, inputMsg, expectedMsg)\n\tinputMsg = \"@tim @fakemention\"\n\texpectedMsg = r.users[0].Name + \" @fakemention\"\n\tperformTestFindMention(t, r, inputMsg, expectedMsg)\n\tinputMsg = \"  @tim  \"\n\texpectedMsg = \"  \" + r.users[0].Name + \"  \"\n\tperformTestFindMention(t, r, inputMsg, expectedMsg)\n\tperformTestFindMention(t, r, \"\", \"\")\n\tperformTestFindMention(t, r, \"@tom\", r.users[1].Name)\n\tperformTestFindMention(t, r, \"no mention\", \"no mention\")\n\tperformTestFindMention(t, r, \"@tim \\\\@tim\", r.users[0].Name+\" @tim\")\n\tperformTestFindMention(t, r, \"@\", \"@\")\n\tperformTestFindMention(t, r, \"\\\\@\", \"@\")\n}\n\n/* ---------------------- Testing speed of findMention ---------------------- */\n\nvar (\n\tnoMention      = strings.Repeat(\"This is a message with no mentions.\", 100)\n\tcompactMention = \"@timt @timt @tom @timt.\"\n\tlongMention    = strings.Repeat(\" @timt\", 100)\n\tescapedMention = strings.Repeat(\" \\\\@timt\", 100)\n)\n\nfunc oldMention(r *Room, msg string) string {\n\tfor i := range r.users {\n\t\tmsg = strings.ReplaceAll(msg, \"@\"+stripansi.Strip(r.users[i].Name), r.users[i].Name)\n\t\tmsg = strings.ReplaceAll(msg, `\\`+r.users[i].Name, \"@\"+stripansi.Strip(r.users[i].Name)) // allow escaping\n\t}\n\treturn msg\n}\n\nfunc BenchmarkFindMentionNoMention(b *testing.B) {\n\tr := makeDummyRoom()\n\tfor i := 0; i < b.N; i++ {\n\t\t_ = r.findMention(noMention)\n\t}\n}\n\nfunc BenchmarkFindMentionCompactMention(b *testing.B) {\n\tr := makeDummyRoom()\n\tfor i := 0; i < b.N; i++ {\n\t\t_ = r.findMention(compactMention)\n\t}\n}\n\nfunc BenchmarkFindMentionLongMessage(b *testing.B) {\n\tr := makeDummyRoom()\n\tfor i := 0; i < b.N; i++ {\n\t\t_ = r.findMention(longMention)\n\t}\n}\n\nfunc BenchmarkFindMentionEscapedMention(b *testing.B) {\n\tr := makeDummyRoom()\n\tfor i := 0; i < b.N; i++ {\n\t\t_ = r.findMention(escapedMention)\n\t}\n}\n\nfunc BenchmarkOldMentionNoMention(b *testing.B) {\n\tr := makeDummyRoom()\n\tfor i := 0; i < b.N; i++ {\n\t\t_ = oldMention(r, noMention)\n\t}\n}\n\nfunc BenchmarkOldMentionCompactMention(b *testing.B) {\n\tr := makeDummyRoom()\n\tfor i := 0; i < b.N; i++ {\n\t\t_ = oldMention(r, compactMention)\n\t}\n}\n\nfunc BenchmarkOldMentionLongMessage(b *testing.B) {\n\tr := makeDummyRoom()\n\tfor i := 0; i < b.N; i++ {\n\t\t_ = oldMention(r, longMention)\n\t}\n}\n\nfunc BenchmarkOldMentionEscapedMention(b *testing.B) {\n\tr := makeDummyRoom()\n\tfor i := 0; i < b.N; i++ {\n\t\t_ = oldMention(r, escapedMention)\n\t}\n}\n\n/* --------------------- Testing correctness of banning --------------------- */\n\nfunc performTestBan(t *testing.T, id0 string, id1 string, id2 string, id3 string, usersBanned int) {\n\tr := makeDummyRoom()\n\tRooms = map[string]*Room{r.name: r}\n\tr.users[0].id = id0\n\tr.users[1].id = id1\n\tr.users[2].id = id2\n\tr.users[3].id = id3\n\tr.users[0].ban(\"Tim is a meany\")\n\tif len(r.users) != 4-usersBanned {\n\t\tt.Log(\"Error,\", usersBanned, \"users should have been kicked but\", 4-len(r.users), \"have been kicked.\")\n\t\tt.Fail()\n\t}\n}\n\nfunc TestBan(t *testing.T) {\n\t// Testing a single user being banned\n\tperformTestBan(t, \"0\", \"1\", \"2\", \"3\", 1)\n\t// Testing the two consecutive users sharing the same ID\n\tperformTestBan(t, \"bad\", \"bad\", \"900d\", \"900d\", 2)\n\t// Testing all user having the same id\n\tperformTestBan(t, \"same\", \"same\", \"same\", \"same\", 4)\n\t// Testing interlaced users sharing the same ID\n\tperformTestBan(t, \"bad\", \"900d\", \"bad\", \"900d\", 2)\n}\n"
        },
        {
          "name": "devzatapi",
          "type": "tree",
          "content": null
        },
        {
          "name": "discord.go",
          "type": "blob",
          "size": 6.6904296875,
          "content": "package main\n\nimport (\n\t\"bytes\"\n\t\"crypto/sha1\"\n\t\"encoding/base64\"\n\t\"encoding/hex\"\n\t\"image\"\n\t\"image/color\"\n\t\"image/png\"\n\t\"os\"\n\t\"strconv\"\n\t\"strings\"\n\t\"time\"\n\n\t\"github.com/acarl005/stripansi\"\n\t\"github.com/bwmarrin/discordgo\"\n\t\"github.com/leaanthony/go-ansi-parser\"\n\t\"github.com/quackduck/term\"\n\t\"golang.org/x/image/draw\"\n)\n\nvar (\n\tDiscordChan chan DiscordMsg\n\tDiscordUser = new(User)\n)\n\ntype DiscordMsg struct {\n\tsenderName string\n\tmsg        string\n\tchannel    string\n}\n\nfunc discordInit() {\n\tif Integrations.Discord == nil {\n\t\treturn\n\t}\n\n\tsess, err := discordgo.New(\"Bot \" + Integrations.Discord.Token)\n\tif err != nil {\n\t\tLog.Println(\"Error creating Discord session:\", err)\n\t\treturn\n\t}\n\n\tsess.AddHandler(discordMessageHandler)\n\tsess.Identify.Intents = discordgo.IntentsGuildMessages | discordgo.IntentGuildWebhooks // listen to messages, manage webhooks\n\terr = sess.Open()\n\tif err != nil {\n\t\tLog.Println(\"Error opening Discord session:\", err)\n\t\treturn\n\t}\n\n\tvar webhook *discordgo.Webhook\n\t// get or create a webhook if we're not in compact mode\n\tif !Integrations.Discord.CompactMode {\n\t\twebhooks, err := sess.ChannelWebhooks(Integrations.Discord.ChannelID)\n\t\tif err != nil {\n\t\t\tLog.Println(\"Error getting Discord webhooks:\", err)\n\t\t\treturn\n\t\t}\n\t\tfor _, wh := range webhooks {\n\t\t\tif wh.Name == \"Devzat\" {\n\t\t\t\twebhook = wh\n\t\t\t}\n\t\t}\n\t\tif webhook == nil {\n\t\t\twebhook, err = sess.WebhookCreate(Integrations.Discord.ChannelID, \"Devzat\", \"\")\n\t\t\tif err != nil {\n\t\t\t\tLog.Println(\"Error creating a Discord webhook:\", err)\n\t\t\t\treturn\n\t\t\t}\n\t\t}\n\t}\n\tDiscordChan = make(chan DiscordMsg, 100)\n\teditsInLastMinute := 0 // discord allows for 30 webhook edits per minute: https://twitter.com/lolpython/status/967621046277820416\n\tgo func() {\n\t\toverloading := false\n\t\tfor msg := range DiscordChan {\n\t\t\tsendingTimeStart := time.Now()\n\t\t\ttxt := strings.ReplaceAll(msg.msg, \"@everyone\", \"@\\\\everyone\")\n\t\t\tif Integrations.Discord.CompactMode || overloading {\n\t\t\t\tvar toSend string\n\t\t\t\tif msg.senderName == \"\" {\n\t\t\t\t\ttoSend = strings.ReplaceAll(stripansi.Strip(\"[\"+msg.channel+\"] \"+txt), `\\n`, \"\\n\")\n\t\t\t\t} else {\n\t\t\t\t\ttoSend = strings.ReplaceAll(stripansi.Strip(\"[\"+msg.channel+\"] **\"+msg.senderName+\"**: \"+txt), `\\n`, \"\\n\")\n\t\t\t\t}\n\t\t\t\t_, err = sess.ChannelMessageSend(Integrations.Discord.ChannelID, toSend)\n\t\t\t\tif err != nil {\n\t\t\t\t\tLog.Println(\"Error sending Discord message:\", err)\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\t//Log.Println(\"edits in last minute\", editsInLastMinute)\n\t\t\t\tif len(DiscordChan) < 5 { // rate-limit the edits\n\t\t\t\t\tavatarFor := msg.senderName\n\t\t\t\t\t//if len(DiscordChan) == 9 { // blank out pfp if we're about to hit the limit\n\t\t\t\t\t//\tavatarFor = \"\"\n\t\t\t\t\t//}\n\t\t\t\t\t//Log.Println(\"before edit\")\n\t\t\t\t\t//_, err = sess.WebhookEditWithToken(webhook.ID, webhook.Token, webhook.Name, createDiscordImage(avatarFor))\n\t\t\t\t\t_, err = sess.WebhookEdit(webhook.ID, webhook.Name, createDiscordImage(avatarFor), webhook.ChannelID, discordgo.WithRetryOnRatelimit(true))\n\t\t\t\t\tif err != nil {\n\t\t\t\t\t\tLog.Println(\"Error modifying Discord webhook:\", err)\n\t\t\t\t\t}\n\t\t\t\t\t//Log.Println(\"after edit\", msg.msg)\n\t\t\t\t\teditsInLastMinute++\n\t\t\t\t\ttime.AfterFunc(time.Minute, func() { editsInLastMinute-- })\n\t\t\t\t}\n\t\t\t\t_, err = sess.WebhookExecute(webhook.ID, webhook.Token, false,\n\t\t\t\t\t&discordgo.WebhookParams{\n\t\t\t\t\t\tContent:  strings.ReplaceAll(stripansi.Strip(txt), `\\n`, \"\\n\"),\n\t\t\t\t\t\tUsername: stripansi.Strip(\"[\" + msg.channel + \"] \" + msg.senderName),\n\t\t\t\t\t},\n\t\t\t\t\tdiscordgo.WithRetryOnRatelimit(true),\n\t\t\t\t)\n\t\t\t\tif err != nil {\n\t\t\t\t\tLog.Println(\"Error sending Discord message:\", err)\n\t\t\t\t}\n\t\t\t}\n\t\t\telaspsedTime := time.Since(sendingTimeStart)\n\t\t\tif elaspsedTime.Seconds() > 20 {\n\t\t\t\toverloading = true\n\t\t\t}\n\t\t\tif len(DiscordChan) == 0 && elaspsedTime.Seconds() < 10 {\n\t\t\t\toverloading = false\n\t\t\t}\n\t\t}\n\t}()\n\n\tDiscordUser.isBridge = true\n\tdevnull, _ := os.OpenFile(os.DevNull, os.O_RDWR, 0)\n\tDiscordUser.term = term.NewTerminal(devnull, \"\")\n\tDiscordUser.room = MainRoom\n\tLog.Println(\"Connected to Discord with bot ID\", sess.State.User.ID, \"as\", sess.State.User.Username)\n}\n\nfunc discordMessageHandler(_ *discordgo.Session, m *discordgo.MessageCreate) {\n\tif m == nil || m.Author == nil || m.Author.Bot || m.ChannelID != Integrations.Discord.ChannelID { // ignore self and other channels\n\t\treturn\n\t}\n\th := sha1.Sum([]byte(m.Author.ID))\n\ti, _ := strconv.ParseInt(hex.EncodeToString(h[:2]), 16, 0) // two bytes as an int\n\tname := m.Author.Username\n\tif m.Member != nil && m.Member.Nick != \"\" {\n\t\tname = m.Member.Nick\n\t}\n\tDiscordUser.Name = Magenta.Paint(Integrations.Discord.Prefix+\" \") + (Styles[int(i)%len(Styles)]).apply(name)\n\n\tmsgContent := strings.TrimSpace(m.ContentWithMentionsReplaced())\n\tif Integrations.Slack != nil {\n\t\tSlackChan <- Integrations.Discord.Prefix + \" \" + name + \": \" + msgContent // send this discord message to slack\n\t}\n\trunCommands(msgContent, DiscordUser)\n}\n\nvar cacheSize = 20\n\n// basic cache system\nvar imageCache = make([]struct {\n\tuser  string\n\timage string\n}, cacheSize)\n\nfunc createDiscordImage(user string) string {\n\t// a completely transparent one pixel png\n\tfallback := \"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAAEUlEQVR4nGJiYGBgAAQAAP//AA8AA/6P688AAAAASUVORK5CYII=\"\n\tif user == \"\" {\n\t\t// make messages with no sender (eg. command outputs) look seamless\n\t\treturn fallback\n\t}\n\tfor i := range imageCache {\n\t\tif imageCache[i].user == user {\n\t\t\treturn imageCache[i].image\n\t\t}\n\t}\n\tstyledTexts, err := ansi.Parse(user)\n\tif err != nil {\n\t\tLog.Println(\"Error parsing ANSI from username while creating Discord avatar:\", err)\n\t\treturn fallback\n\t}\n\timg := image.NewNRGBA(image.Rect(0, 0, len(styledTexts), 3))\n\n\tfor i := 0; i < len(styledTexts); i++ {\n\t\tfor j := 0; j < 3 && styledTexts[i].FgCol != nil; j++ {\n\t\t\tcol := styledTexts[i].FgCol\n\t\t\tif (j == 0 || j == 2) && styledTexts[i].BgCol != nil {\n\t\t\t\tcol = styledTexts[i].BgCol\n\t\t\t}\n\t\t\timg.Set(i, j, color.NRGBA{R: col.Rgb.R, G: col.Rgb.G, B: col.Rgb.B, A: 255})\n\t\t}\n\t}\n\n\tdst := image.NewNRGBA(image.Rect(0, 0, 256, 256))\n\t//(&draw.Kernel{\n\t//\tSupport: 10,\n\t//\tAt: func(t float64) float64 {\n\t//\t\treturn math.Exp(-t * t * 2)\n\t//\t},\n\t//}).Scale(dst, dst.Rect, img, img.Bounds(), draw.Over, nil)\n\t//draw.BiLinear.Scale(dst, dst.Rect, img, img.Bounds(), draw.Over, nil)\n\tdraw.CatmullRom.Scale(dst, dst.Rect, img, img.Bounds(), draw.Over, nil)\n\t//draw.NearestNeighbor.Scale(dst, dst.Rect, img, img.Bounds(), draw.Over, nil)\n\tbuff := new(bytes.Buffer)\n\terr = png.Encode(buff, dst)\n\tif err != nil {\n\t\tLog.Println(\"Error creating Discord avatar:\", err)\n\t\treturn fallback\n\t}\n\tresult := \"data:image/png;base64,\" + base64.StdEncoding.EncodeToString(buff.Bytes())\n\n\tif len(imageCache) >= cacheSize {\n\t\t// remove the first value\n\t\timageCache = imageCache[1:]\n\t}\n\timageCache = append(imageCache, struct {\n\t\tuser  string\n\t\timage string\n\t}{user: user, image: result})\n\t//Log.Println(\"returned\", result)\n\treturn result\n}\n"
        },
        {
          "name": "games.go",
          "type": "blob",
          "size": 0.9970703125,
          "content": "package main\n\nimport (\n\t\"fmt\"\n\t\"strings\"\n\n\t\"github.com/shurcooL/tictactoe\"\n)\n\nvar (\n\ttttGame       = new(tictactoe.Board)\n\tcurrentPlayer = tictactoe.X\n\thangGame      = new(hangman)\n)\n\ntype hangman struct {\n\tword      string\n\ttriesLeft int\n\tguesses   string // string containing all the guessed characters\n}\n\nfunc hangPrint(hangGame *hangman) string {\n\tdisplay := \"\"\n\tfor _, c := range hangGame.word {\n\t\tif strings.ContainsRune(hangGame.guesses, c) {\n\t\t\tdisplay += string(c)\n\t\t} else {\n\t\t\tdisplay += \"_\"\n\t\t}\n\t}\n\treturn display\n}\n\nfunc tttPrint(cells [9]tictactoe.State) string {\n\treturn strings.ReplaceAll(strings.ReplaceAll(\n\n\t\tfmt.Sprintf(` %v â”‚ %v â”‚ %v \nâ”€â”€â”€â”¼â”€â”€â”€â”¼â”€â”€â”€\n %v â”‚ %v â”‚ %v \nâ”€â”€â”€â”¼â”€â”€â”€â”¼â”€â”€â”€\n %v â”‚ %v â”‚ %v `, cells[0], cells[1], cells[2],\n\t\t\tcells[3], cells[4], cells[5],\n\t\t\tcells[6], cells[7], cells[8]),\n\n\t\ttictactoe.X.String(), Chalk.BrightYellow(tictactoe.X.String())), // add some coloring\n\t\ttictactoe.O.String(), Chalk.BrightGreen(tictactoe.O.String()))\n}\n"
        },
        {
          "name": "go.mod",
          "type": "blob",
          "size": 2.3115234375,
          "content": "module devzat\n\ngo 1.20\n\nrequire (\n\tdevzat/plugin v0.0.0-00010101000000-000000000000\n\tgithub.com/TwiN/go-away v1.6.11\n\tgithub.com/acarl005/stripansi v0.0.0-20180116102854-5a71ef0e047d\n\tgithub.com/alecthomas/chroma v0.10.0\n\tgithub.com/bwmarrin/discordgo v0.27.1\n\tgithub.com/caarlos0/sshmarshal v0.1.0\n\tgithub.com/charmbracelet/glamour v0.6.0\n\tgithub.com/dghubble/go-twitter v0.0.0-20221104224141-912508c3888b\n\tgithub.com/dghubble/oauth1 v0.7.2\n\tgithub.com/disintegration/imaging v1.6.2\n\tgithub.com/fatih/color v1.15.0\n\tgithub.com/gliderlabs/ssh v0.3.5\n\tgithub.com/jwalton/gchalk v1.3.0\n\tgithub.com/leaanthony/go-ansi-parser v1.6.1\n\tgithub.com/quackduck/term v0.0.0-20230512153006-5935fcd4d5e9\n\tgithub.com/shurcooL/tictactoe v0.0.0-20210613024444-e573ff1376a3\n\tgithub.com/slack-go/slack v0.12.3\n\tgolang.org/x/crypto v0.13.0\n\tgolang.org/x/image v0.12.0\n\tgoogle.golang.org/grpc v1.58.2\n\tgopkg.in/yaml.v2 v2.4.0\n)\n\nrequire (\n\tgithub.com/anmitsu/go-shlex v0.0.0-20200514113438-38f4b401e2be // indirect\n\tgithub.com/aymanbagabas/go-osc52/v2 v2.0.1 // indirect\n\tgithub.com/aymerick/douceur v0.2.0 // indirect\n\tgithub.com/cenkalti/backoff/v4 v4.2.1 // indirect\n\tgithub.com/dghubble/sling v1.4.1 // indirect\n\tgithub.com/dlclark/regexp2 v1.10.0 // indirect\n\tgithub.com/golang/protobuf v1.5.3 // indirect\n\tgithub.com/google/go-querystring v1.1.0 // indirect\n\tgithub.com/gorilla/css v1.0.0 // indirect\n\tgithub.com/gorilla/websocket v1.5.0 // indirect\n\tgithub.com/jwalton/go-supportscolor v1.2.0 // indirect\n\tgithub.com/lucasb-eyer/go-colorful v1.2.0 // indirect\n\tgithub.com/mattn/go-colorable v0.1.13 // indirect\n\tgithub.com/mattn/go-isatty v0.0.19 // indirect\n\tgithub.com/mattn/go-runewidth v0.0.15 // indirect\n\tgithub.com/microcosm-cc/bluemonday v1.0.25 // indirect\n\tgithub.com/muesli/reflow v0.3.0 // indirect\n\tgithub.com/muesli/termenv v0.15.2 // indirect\n\tgithub.com/olekukonko/tablewriter v0.0.5 // indirect\n\tgithub.com/rivo/uniseg v0.4.4 // indirect\n\tgithub.com/yuin/goldmark v1.5.6 // indirect\n\tgithub.com/yuin/goldmark-emoji v1.0.2 // indirect\n\tgolang.org/x/net v0.15.0 // indirect\n\tgolang.org/x/sys v0.12.0 // indirect\n\tgolang.org/x/term v0.12.0 // indirect\n\tgolang.org/x/text v0.13.0 // indirect\n\tgoogle.golang.org/genproto/googleapis/rpc v0.0.0-20230920204549-e6e6cdab5c13 // indirect\n\tgoogle.golang.org/protobuf v1.31.0 // indirect\n)\n\nreplace devzat/plugin => ./plugin\n"
        },
        {
          "name": "go.sum",
          "type": "blob",
          "size": 16.8505859375,
          "content": "github.com/TwiN/go-away v1.6.11 h1:ICUp2WE4YmO8wfKix/dqmrbmr61fD0f9I3IOCmqay7U=\ngithub.com/TwiN/go-away v1.6.11/go.mod h1:h1BfHu5UwQ1PasB8u+8uDXactyVbQcN/lOyeQ9Ow/H8=\ngithub.com/acarl005/stripansi v0.0.0-20180116102854-5a71ef0e047d h1:licZJFw2RwpHMqeKTCYkitsPqHNxTmd4SNR5r94FGM8=\ngithub.com/acarl005/stripansi v0.0.0-20180116102854-5a71ef0e047d/go.mod h1:asat636LX7Bqt5lYEZ27JNDcqxfjdBQuJ/MM4CN/Lzo=\ngithub.com/alecthomas/chroma v0.10.0 h1:7XDcGkCQopCNKjZHfYrNLraA+M7e0fMiJ/Mfikbfjek=\ngithub.com/alecthomas/chroma v0.10.0/go.mod h1:jtJATyUxlIORhUOFNA9NZDWGAQ8wpxQQqNSB4rjA/1s=\ngithub.com/anmitsu/go-shlex v0.0.0-20200514113438-38f4b401e2be h1:9AeTilPcZAjCFIImctFaOjnTIavg87rW78vTPkQqLI8=\ngithub.com/anmitsu/go-shlex v0.0.0-20200514113438-38f4b401e2be/go.mod h1:ySMOLuWl6zY27l47sB3qLNK6tF2fkHG55UZxx8oIVo4=\ngithub.com/aymanbagabas/go-osc52 v1.0.3/go.mod h1:zT8H+Rk4VSabYN90pWyugflM3ZhpTZNC7cASDfUCdT4=\ngithub.com/aymanbagabas/go-osc52/v2 v2.0.1 h1:HwpRHbFMcZLEVr42D4p7XBqjyuxQH5SMiErDT4WkJ2k=\ngithub.com/aymanbagabas/go-osc52/v2 v2.0.1/go.mod h1:uYgXzlJ7ZpABp8OJ+exZzJJhRNQ2ASbcXHWsFqH8hp8=\ngithub.com/aymerick/douceur v0.2.0 h1:Mv+mAeH1Q+n9Fr+oyamOlAkUNPWPlA8PPGR0QAaYuPk=\ngithub.com/aymerick/douceur v0.2.0/go.mod h1:wlT5vV2O3h55X9m7iVYN0TBM0NH/MmbLnd30/FjWUq4=\ngithub.com/bwmarrin/discordgo v0.27.1 h1:ib9AIc/dom1E/fSIulrBwnez0CToJE113ZGt4HoliGY=\ngithub.com/bwmarrin/discordgo v0.27.1/go.mod h1:NJZpH+1AfhIcyQsPeuBKsUtYrRnjkyu0kIVMCHkZtRY=\ngithub.com/caarlos0/sshmarshal v0.1.0 h1:zTCZrDORFfWh526Tsb7vCm3+Yg/SfW/Ub8aQDeosk0I=\ngithub.com/caarlos0/sshmarshal v0.1.0/go.mod h1:7Pd/0mmq9x/JCzKauogNjSQEhivBclCQHfr9dlpDIyA=\ngithub.com/cenkalti/backoff/v4 v4.2.1 h1:y4OZtCnogmCPw98Zjyt5a6+QwPLGkiQsYW5oUqylYbM=\ngithub.com/cenkalti/backoff/v4 v4.2.1/go.mod h1:Y3VNntkOUPxTVeUxJ/G5vcM//AlwfmyYozVcomhLiZE=\ngithub.com/charmbracelet/glamour v0.6.0 h1:wi8fse3Y7nfcabbbDuwolqTqMQPMnVPeZhDM273bISc=\ngithub.com/charmbracelet/glamour v0.6.0/go.mod h1:taqWV4swIMMbWALc0m7AfE9JkPSU8om2538k9ITBxOc=\ngithub.com/davecgh/go-spew v1.1.0/go.mod h1:J7Y8YcW2NihsgmVo/mv3lAwl/skON4iLHjSsI+c5H38=\ngithub.com/davecgh/go-spew v1.1.1 h1:vj9j/u1bqnvCEfJOwUhtlOARqs3+rkHYY13jYWTU97c=\ngithub.com/davecgh/go-spew v1.1.1/go.mod h1:J7Y8YcW2NihsgmVo/mv3lAwl/skON4iLHjSsI+c5H38=\ngithub.com/dghubble/go-twitter v0.0.0-20221104224141-912508c3888b h1:XQu6o3AwJx/jsg9LZ41uIeUdXK5be099XFfFn6H9ikk=\ngithub.com/dghubble/go-twitter v0.0.0-20221104224141-912508c3888b/go.mod h1:B0/qdW5XUupJvcsx40hnVbfjzz9He5YpYXx6eVVdiSY=\ngithub.com/dghubble/oauth1 v0.7.2 h1:pwcinOZy8z6XkNxvPmUDY52M7RDPxt0Xw1zgZ6Cl5JA=\ngithub.com/dghubble/oauth1 v0.7.2/go.mod h1:9erQdIhqhOHG/7K9s/tgh9Ks/AfoyrO5mW/43Lu2+kE=\ngithub.com/dghubble/sling v1.4.1 h1:AxjTubpVyozMvbBCtXcsWEyGGgUZutC5YGrfxPNVOcQ=\ngithub.com/dghubble/sling v1.4.1/go.mod h1:QoMB1KL3GAo+7HsD8Itd6S+6tW91who8BGZzuLvpOyc=\ngithub.com/disintegration/imaging v1.6.2 h1:w1LecBlG2Lnp8B3jk5zSuNqd7b4DXhcjwek1ei82L+c=\ngithub.com/disintegration/imaging v1.6.2/go.mod h1:44/5580QXChDfwIclfc/PCwrr44amcmDAg8hxG0Ewe4=\ngithub.com/dlclark/regexp2 v1.4.0/go.mod h1:2pZnwuY/m+8K6iRw6wQdMtk+rH5tNGR1i55kozfMjCc=\ngithub.com/dlclark/regexp2 v1.10.0 h1:+/GIL799phkJqYW+3YbOd8LCcbHzT0Pbo8zl70MHsq0=\ngithub.com/dlclark/regexp2 v1.10.0/go.mod h1:DHkYz0B9wPfa6wondMfaivmHpzrQ3v9q8cnmRbL6yW8=\ngithub.com/fatih/color v1.15.0 h1:kOqh6YHBtK8aywxGerMG2Eq3H6Qgoqeo13Bk2Mv/nBs=\ngithub.com/fatih/color v1.15.0/go.mod h1:0h5ZqXfHYED7Bhv2ZJamyIOUej9KtShiJESRwBDUSsw=\ngithub.com/gliderlabs/ssh v0.3.5 h1:OcaySEmAQJgyYcArR+gGGTHCyE7nvhEMTlYY+Dp8CpY=\ngithub.com/gliderlabs/ssh v0.3.5/go.mod h1:8XB4KraRrX39qHhT6yxPsHedjA08I/uBVwj4xC+/+z4=\ngithub.com/go-test/deep v1.0.4 h1:u2CU3YKy9I2pmu9pX0eq50wCgjfGIt539SqR7FbHiho=\ngithub.com/go-test/deep v1.0.4/go.mod h1:wGDj63lr65AM2AQyKZd/NYHGb0R+1RLqB8NKt3aSFNA=\ngithub.com/golang/protobuf v1.5.0/go.mod h1:FsONVRAS9T7sI+LIUmWTfcYkHO4aIWwzhcaSAoJOfIk=\ngithub.com/golang/protobuf v1.5.3 h1:KhyjKVUg7Usr/dYsdSqoFveMYd5ko72D+zANwlG1mmg=\ngithub.com/golang/protobuf v1.5.3/go.mod h1:XVQd3VNwM+JqD3oG2Ue2ip4fOMUkwXdXDdiuN0vRsmY=\ngithub.com/google/go-cmp v0.5.2/go.mod h1:v8dTdLbMG2kIc/vJvl+f65V22dbkXbowE6jgT/gNBxE=\ngithub.com/google/go-cmp v0.5.5/go.mod h1:v8dTdLbMG2kIc/vJvl+f65V22dbkXbowE6jgT/gNBxE=\ngithub.com/google/go-cmp v0.5.7/go.mod h1:n+brtR0CgQNWTVd5ZUFpTBC8YFBDLK/h/bpaJ8/DtOE=\ngithub.com/google/go-cmp v0.5.9 h1:O2Tfq5qg4qc4AmwVlvv0oLiVAGB7enBSJ2x2DqQFi38=\ngithub.com/google/go-querystring v1.1.0 h1:AnCroh3fv4ZBgVIf1Iwtovgjaw/GiKJo8M8yD/fhyJ8=\ngithub.com/google/go-querystring v1.1.0/go.mod h1:Kcdr2DB4koayq7X8pmAG4sNG59So17icRSOU623lUBU=\ngithub.com/gorilla/css v1.0.0 h1:BQqNyPTi50JCFMTw/b67hByjMVXZRwGha6wxVGkeihY=\ngithub.com/gorilla/css v1.0.0/go.mod h1:Dn721qIggHpt4+EFCcTLTU/vk5ySda2ReITrtgBl60c=\ngithub.com/gorilla/websocket v1.4.2/go.mod h1:YR8l580nyteQvAITg2hZ9XVh4b55+EU/adAjf1fMHhE=\ngithub.com/gorilla/websocket v1.5.0 h1:PPwGk2jz7EePpoHN/+ClbZu8SPxiqlu12wZP/3sWmnc=\ngithub.com/gorilla/websocket v1.5.0/go.mod h1:YR8l580nyteQvAITg2hZ9XVh4b55+EU/adAjf1fMHhE=\ngithub.com/jwalton/gchalk v1.3.0 h1:uTfAaNexN8r0I9bioRTksuT8VGjrPs9YIXR1PQbtX/Q=\ngithub.com/jwalton/gchalk v1.3.0/go.mod h1:ytRlj60R9f7r53IAElbpq4lVuPOPNg2J4tJcCxtFqr8=\ngithub.com/jwalton/go-supportscolor v1.1.0/go.mod h1:hFVUAZV2cWg+WFFC4v8pT2X/S2qUUBYMioBD9AINXGs=\ngithub.com/jwalton/go-supportscolor v1.2.0 h1:g6Ha4u7Vm3LIsQ5wmeBpS4gazu0UP1DRDE8y6bre4H8=\ngithub.com/jwalton/go-supportscolor v1.2.0/go.mod h1:hFVUAZV2cWg+WFFC4v8pT2X/S2qUUBYMioBD9AINXGs=\ngithub.com/leaanthony/go-ansi-parser v1.6.1 h1:xd8bzARK3dErqkPFtoF9F3/HgN8UQk0ed1YDKpEz01A=\ngithub.com/leaanthony/go-ansi-parser v1.6.1/go.mod h1:+vva/2y4alzVmmIEpk9QDhA7vLC5zKDTRwfZGOp3IWU=\ngithub.com/lucasb-eyer/go-colorful v1.2.0 h1:1nnpGOrhyZZuNyfu1QjKiUICQ74+3FNCN69Aj6K7nkY=\ngithub.com/lucasb-eyer/go-colorful v1.2.0/go.mod h1:R4dSotOR9KMtayYi1e77YzuveK+i7ruzyGqttikkLy0=\ngithub.com/matryer/is v1.4.0 h1:sosSmIWwkYITGrxZ25ULNDeKiMNzFSr4V/eqBQP0PeE=\ngithub.com/matryer/is v1.4.0/go.mod h1:8I/i5uYgLzgsgEloJE1U6xx5HkBQpAZvepWuujKwMRU=\ngithub.com/mattn/go-colorable v0.1.13 h1:fFA4WZxdEF4tXPZVKMLwD8oUnCTTo08duU7wxecdEvA=\ngithub.com/mattn/go-colorable v0.1.13/go.mod h1:7S9/ev0klgBDR4GtXTXX8a3vIGJpMovkB8vQcUbaXHg=\ngithub.com/mattn/go-isatty v0.0.16/go.mod h1:kYGgaQfpe5nmfYZH+SKPsOc2e4SrIfOl2e/yFXSvRLM=\ngithub.com/mattn/go-isatty v0.0.19 h1:JITubQf0MOLdlGRuRq+jtsDlekdYPia9ZFsB8h/APPA=\ngithub.com/mattn/go-isatty v0.0.19/go.mod h1:W+V8PltTTMOvKvAeJH7IuucS94S2C6jfK/D7dTCTo3Y=\ngithub.com/mattn/go-runewidth v0.0.9/go.mod h1:H031xJmbD/WCDINGzjvQ9THkh0rPKHF+m2gUSrubnMI=\ngithub.com/mattn/go-runewidth v0.0.12/go.mod h1:RAqKPSqVFrSLVXbA8x7dzmKdmGzieGRCM46jaSJTDAk=\ngithub.com/mattn/go-runewidth v0.0.14/go.mod h1:Jdepj2loyihRzMpdS35Xk/zdY8IAYHsh153qUoGf23w=\ngithub.com/mattn/go-runewidth v0.0.15 h1:UNAjwbU9l54TA3KzvqLGxwWjHmMgBUVhBiTjelZgg3U=\ngithub.com/mattn/go-runewidth v0.0.15/go.mod h1:Jdepj2loyihRzMpdS35Xk/zdY8IAYHsh153qUoGf23w=\ngithub.com/microcosm-cc/bluemonday v1.0.21/go.mod h1:ytNkv4RrDrLJ2pqlsSI46O6IVXmZOBBD4SaJyDwwTkM=\ngithub.com/microcosm-cc/bluemonday v1.0.25 h1:4NEwSfiJ+Wva0VxN5B8OwMicaJvD8r9tlJWm9rtloEg=\ngithub.com/microcosm-cc/bluemonday v1.0.25/go.mod h1:ZIOjCQp1OrzBBPIJmfX4qDYFuhU02nx4bn030ixfHLE=\ngithub.com/muesli/reflow v0.3.0 h1:IFsN6K9NfGtjeggFP+68I4chLZV2yIKsXJFNZ+eWh6s=\ngithub.com/muesli/reflow v0.3.0/go.mod h1:pbwTDkVPibjO2kyvBQRBxTWEEGDGq0FlB1BIKtnHY/8=\ngithub.com/muesli/termenv v0.13.0/go.mod h1:sP1+uffeLaEYpyOTb8pLCUctGcGLnoFjSn4YJK5e2bc=\ngithub.com/muesli/termenv v0.15.2 h1:GohcuySI0QmI3wN8Ok9PtKGkgkFIk7y6Vpb5PvrY+Wo=\ngithub.com/muesli/termenv v0.15.2/go.mod h1:Epx+iuz8sNs7mNKhxzH4fWXGNpZwUaJKRS1noLXviQ8=\ngithub.com/olekukonko/tablewriter v0.0.5 h1:P2Ga83D34wi1o9J6Wh1mRuqd4mF/x/lgBS7N7AbDhec=\ngithub.com/olekukonko/tablewriter v0.0.5/go.mod h1:hPp6KlRPjbx+hW8ykQs1w3UBbZlj6HuIJcUGPhkA7kY=\ngithub.com/pmezard/go-difflib v1.0.0 h1:4DBwDE0NGyQoBHbLQYPwSUPoCMWR5BEzIk/f1lZbAQM=\ngithub.com/pmezard/go-difflib v1.0.0/go.mod h1:iKH77koFhYxTK1pcRnkKkqfTogsbg7gZNVY4sRDYZ/4=\ngithub.com/quackduck/term v0.0.0-20230512153006-5935fcd4d5e9 h1:aAGwyMwqYM3SpeUTRXcpPYsUdVMlvGwdCZF2E5zLM3c=\ngithub.com/quackduck/term v0.0.0-20230512153006-5935fcd4d5e9/go.mod h1:B50IHj8pI0ysJ3R5gLUnRSIt7pIe3f1y9OUqIE7w2bA=\ngithub.com/rivo/uniseg v0.1.0/go.mod h1:J6wj4VEh+S6ZtnVlnTBMWIodfgj8LQOQFoIToxlJtxc=\ngithub.com/rivo/uniseg v0.2.0/go.mod h1:J6wj4VEh+S6ZtnVlnTBMWIodfgj8LQOQFoIToxlJtxc=\ngithub.com/rivo/uniseg v0.4.4 h1:8TfxU8dW6PdqD27gjM8MVNuicgxIjxpm4K7x4jp8sis=\ngithub.com/rivo/uniseg v0.4.4/go.mod h1:FN3SvrM+Zdj16jyLfmOkMNblXMcoc8DfTHruCPUcx88=\ngithub.com/shurcooL/component v0.0.0-20190503025225-90263df59ff6/go.mod h1:XhFIlyj5a1fBNx5aJTbKoIq0mNaPvOagO+HjB3EtxrY=\ngithub.com/shurcooL/htmlg v0.0.0-20190503024804-b6326af49ef6/go.mod h1:zPn1wHpTIePGnXSHpsVPWEktKXHr6+SS6x/IKRb7cpw=\ngithub.com/shurcooL/tictactoe v0.0.0-20210613024444-e573ff1376a3 h1:pIBdUxzMMrW4e66O0Ss9/BhcsIW0Ecld5IGCVoD0zSo=\ngithub.com/shurcooL/tictactoe v0.0.0-20210613024444-e573ff1376a3/go.mod h1:NmTNkTX0TfQWPw1vaTkUHX/Tq1AYt3RZ4v/D92O3c6Q=\ngithub.com/slack-go/slack v0.12.3 h1:92/dfFU8Q5XP6Wp5rr5/T5JHLM5c5Smtn53fhToAP88=\ngithub.com/slack-go/slack v0.12.3/go.mod h1:hlGi5oXA+Gt+yWTPP0plCdRKmjsDxecdHxYQdlMQKOw=\ngithub.com/stretchr/objx v0.1.0/go.mod h1:HFkY916IF+rwdDfMAkV7OtwuqBVzrE8GR6GFx+wExME=\ngithub.com/stretchr/testify v1.2.2/go.mod h1:a8OnRcib4nhh0OaRAV+Yts87kKdq0PP7pXfy6kDkUVs=\ngithub.com/stretchr/testify v1.7.0/go.mod h1:6Fq8oRcR53rry900zMqJjRRixrwX3KX962/h/Wwjteg=\ngithub.com/stretchr/testify v1.8.1 h1:w7B6lhMri9wdJUVmEZPGGhZzrYTPvgJArz7wNPgYKsk=\ngithub.com/yuin/goldmark v1.2.1/go.mod h1:3hX8gzYuyVAZsxl0MRgGTJEmQBFcNTphYh9decYSb74=\ngithub.com/yuin/goldmark v1.3.7/go.mod h1:mwnBkeHKe2W/ZEtQ+71ViKU8L12m81fl3OWwC1Zlc8k=\ngithub.com/yuin/goldmark v1.4.13/go.mod h1:6yULJ656Px+3vBD8DxQVa3kxgyrAnzto9xy5taEt/CY=\ngithub.com/yuin/goldmark v1.5.2/go.mod h1:6yULJ656Px+3vBD8DxQVa3kxgyrAnzto9xy5taEt/CY=\ngithub.com/yuin/goldmark v1.5.6 h1:COmQAWTCcGetChm3Ig7G/t8AFAN00t+o8Mt4cf7JpwA=\ngithub.com/yuin/goldmark v1.5.6/go.mod h1:6yULJ656Px+3vBD8DxQVa3kxgyrAnzto9xy5taEt/CY=\ngithub.com/yuin/goldmark-emoji v1.0.1/go.mod h1:2w1E6FEWLcDQkoTE+7HU6QF1F6SLlNGjRIBbIZQFqkQ=\ngithub.com/yuin/goldmark-emoji v1.0.2 h1:c/RgTShNgHTtc6xdz2KKI74jJr6rWi7FPgnP9GAsO5s=\ngithub.com/yuin/goldmark-emoji v1.0.2/go.mod h1:RhP/RWpexdp+KHs7ghKnifRoIs/Bq4nDS7tRbCkOwKY=\ngolang.org/x/crypto v0.0.0-20190308221718-c2843e01d9a2/go.mod h1:djNgcEr1/C05ACkg1iLfiJU5Ep61QUkGW8qpdssI0+w=\ngolang.org/x/crypto v0.0.0-20210421170649-83a5a9bb288b/go.mod h1:T9bdIzuCu7OtxOm1hfPfRQxPLYneinmdGuTeoZ9dtd4=\ngolang.org/x/crypto v0.0.0-20210921155107-089bfa567519/go.mod h1:GvvjBRRGRdwPK5ydBHafDWAxML/pGHZbMvKqRZ5+Abc=\ngolang.org/x/crypto v0.0.0-20220826181053-bd7e27e6170d/go.mod h1:IxCIyHEi3zRg3s0A5j5BB6A9Jmi73HwBIUl50j+osU4=\ngolang.org/x/crypto v0.13.0 h1:mvySKfSWJ+UKUii46M40LOvyWfN0s2U+46/jDd0e6Ck=\ngolang.org/x/crypto v0.13.0/go.mod h1:y6Z2r+Rw4iayiXXAIxJIDAJ1zMW4yaTpebo8fPOliYc=\ngolang.org/x/image v0.0.0-20191009234506-e7c1f5e7dbb8/go.mod h1:FeLwcggjj3mMvU+oOTbSwawSJRM1uh48EjtB4UJZlP0=\ngolang.org/x/image v0.12.0 h1:w13vZbU4o5rKOFFR8y7M+c4A5jXDC0uXTdHYRP8X2DQ=\ngolang.org/x/image v0.12.0/go.mod h1:Lu90jvHG7GfemOIcldsh9A2hS01ocl6oNO7ype5mEnk=\ngolang.org/x/mod v0.6.0-dev.0.20220419223038-86c51ed26bb4/go.mod h1:jJ57K6gSWd91VN4djpZkiMVwK6gcyfeH4XE8wZrZaV4=\ngolang.org/x/mod v0.8.0/go.mod h1:iBbtSCu2XBx23ZKBPSOrRkjjQPZFPuis4dIYUhu/chs=\ngolang.org/x/net v0.0.0-20190620200207-3b0461eec859/go.mod h1:z5CRVTTTmAJ677TzLLGU+0bjPO0LkuOLi4/5GtJWs/s=\ngolang.org/x/net v0.0.0-20210226172049-e18ecbb05110/go.mod h1:m0MpNAwzfU5UDzcl9v0D8zg8gWTRqZa9RBIspLL5mdg=\ngolang.org/x/net v0.0.0-20211112202133-69e39bad7dc2/go.mod h1:9nx3DQGgdP8bBQD5qxJ1jj9UTztislL4KSBs9R2vV5Y=\ngolang.org/x/net v0.0.0-20220722155237-a158d28d115b/go.mod h1:XRhObCWvk6IyKnWLug+ECip1KBveYUHfp+8e9klMJ9c=\ngolang.org/x/net v0.0.0-20220826154423-83b083e8dc8b/go.mod h1:YDH+HFinaLZZlnHAfSS6ZXJJ9M9t4Dl22yv3iI2vPwk=\ngolang.org/x/net v0.0.0-20221002022538-bcab6841153b/go.mod h1:YDH+HFinaLZZlnHAfSS6ZXJJ9M9t4Dl22yv3iI2vPwk=\ngolang.org/x/net v0.6.0/go.mod h1:2Tu9+aMcznHK/AK1HMvgo6xiTLG5rD5rZLDS+rp2Bjs=\ngolang.org/x/net v0.15.0 h1:ugBLEUaxABaB5AJqW9enI0ACdci2RUd4eP51NTBvuJ8=\ngolang.org/x/net v0.15.0/go.mod h1:idbUs1IY1+zTqbi8yxTbhexhEEk5ur9LInksu6HrEpk=\ngolang.org/x/sync v0.0.0-20190423024810-112230192c58/go.mod h1:RxMgew5VJxzue5/jJTE5uejpjVlOe/izrB70Jof72aM=\ngolang.org/x/sync v0.0.0-20220722155255-886fb9371eb4/go.mod h1:RxMgew5VJxzue5/jJTE5uejpjVlOe/izrB70Jof72aM=\ngolang.org/x/sync v0.1.0/go.mod h1:RxMgew5VJxzue5/jJTE5uejpjVlOe/izrB70Jof72aM=\ngolang.org/x/sys v0.0.0-20190215142949-d0b11bdaac8a/go.mod h1:STP8DvDyc/dI5b8T5hshtkjS+E42TnysNCUPdjciGhY=\ngolang.org/x/sys v0.0.0-20201119102817-f84b799fce68/go.mod h1:h1NjWce9XRLGQEsW7wpKNCjG9DtNlClVuFLEZdDNbEs=\ngolang.org/x/sys v0.0.0-20210220050731-9a76102bfb43/go.mod h1:h1NjWce9XRLGQEsW7wpKNCjG9DtNlClVuFLEZdDNbEs=\ngolang.org/x/sys v0.0.0-20210423082822-04245dca01da/go.mod h1:h1NjWce9XRLGQEsW7wpKNCjG9DtNlClVuFLEZdDNbEs=\ngolang.org/x/sys v0.0.0-20210615035016-665e8c7367d1/go.mod h1:oPkhp1MJrh7nUepCBck5+mAzfO9JrbApNNgaTdGDITg=\ngolang.org/x/sys v0.0.0-20211004093028-2c5d950f24ef/go.mod h1:oPkhp1MJrh7nUepCBck5+mAzfO9JrbApNNgaTdGDITg=\ngolang.org/x/sys v0.0.0-20220520151302-bc2c85ada10a/go.mod h1:oPkhp1MJrh7nUepCBck5+mAzfO9JrbApNNgaTdGDITg=\ngolang.org/x/sys v0.0.0-20220722155257-8c9f86f7a55f/go.mod h1:oPkhp1MJrh7nUepCBck5+mAzfO9JrbApNNgaTdGDITg=\ngolang.org/x/sys v0.0.0-20220728004956-3c1f35247d10/go.mod h1:oPkhp1MJrh7nUepCBck5+mAzfO9JrbApNNgaTdGDITg=\ngolang.org/x/sys v0.0.0-20220811171246-fbc7d0a398ab/go.mod h1:oPkhp1MJrh7nUepCBck5+mAzfO9JrbApNNgaTdGDITg=\ngolang.org/x/sys v0.0.0-20220825204002-c680a09ffe64/go.mod h1:oPkhp1MJrh7nUepCBck5+mAzfO9JrbApNNgaTdGDITg=\ngolang.org/x/sys v0.5.0/go.mod h1:oPkhp1MJrh7nUepCBck5+mAzfO9JrbApNNgaTdGDITg=\ngolang.org/x/sys v0.6.0/go.mod h1:oPkhp1MJrh7nUepCBck5+mAzfO9JrbApNNgaTdGDITg=\ngolang.org/x/sys v0.12.0 h1:CM0HF96J0hcLAwsHPJZjfdNzs0gftsLfgKt57wWHJ0o=\ngolang.org/x/sys v0.12.0/go.mod h1:oPkhp1MJrh7nUepCBck5+mAzfO9JrbApNNgaTdGDITg=\ngolang.org/x/term v0.0.0-20201126162022-7de9c90e9dd1/go.mod h1:bj7SfCRtBDWHUb9snDiAeCFNEtKQo2Wmx5Cou7ajbmo=\ngolang.org/x/term v0.0.0-20210220032956-6a3ed077a48d/go.mod h1:bj7SfCRtBDWHUb9snDiAeCFNEtKQo2Wmx5Cou7ajbmo=\ngolang.org/x/term v0.0.0-20210927222741-03fcf44c2211/go.mod h1:jbD1KX2456YbFQfuXm/mYQcufACuNUgVhRMnK/tPxf8=\ngolang.org/x/term v0.0.0-20220722155259-a9ba230a4035/go.mod h1:jbD1KX2456YbFQfuXm/mYQcufACuNUgVhRMnK/tPxf8=\ngolang.org/x/term v0.5.0/go.mod h1:jMB1sMXY+tzblOD4FWmEbocvup2/aLOaQEp7JmGp78k=\ngolang.org/x/term v0.12.0 h1:/ZfYdc3zq+q02Rv9vGqTeSItdzZTSNDmfTi0mBAuidU=\ngolang.org/x/term v0.12.0/go.mod h1:owVbMEjm3cBLCHdkQu9b1opXd4ETQWc3BhuQGKgXgvU=\ngolang.org/x/text v0.3.0/go.mod h1:NqM8EUOU14njkJ3fqMW+pc6Ldnwhi/IjpwHt7yyuwOQ=\ngolang.org/x/text v0.3.3/go.mod h1:5Zoc/QRtKVWzQhOtBMvqHzDpF6irO9z98xDceosuGiQ=\ngolang.org/x/text v0.3.6/go.mod h1:5Zoc/QRtKVWzQhOtBMvqHzDpF6irO9z98xDceosuGiQ=\ngolang.org/x/text v0.3.7/go.mod h1:u+2+/6zg+i71rQMx5EYifcz6MCKuco9NR6JIITiCfzQ=\ngolang.org/x/text v0.7.0/go.mod h1:mrYo+phRRbMaCq/xk9113O4dZlRixOauAjOtrjsXDZ8=\ngolang.org/x/text v0.13.0 h1:ablQoSUd0tRdKxZewP80B+BaqeKJuVhuRxj/dkrun3k=\ngolang.org/x/text v0.13.0/go.mod h1:TvPlkZtksWOMsz7fbANvkp4WM8x/WCo/om8BMLbz+aE=\ngolang.org/x/tools v0.0.0-20180917221912-90fa682c2a6e/go.mod h1:n7NCudcB/nEzxVGmLbDWY5pfWTLqBcC2KZ6jyYvM4mQ=\ngolang.org/x/tools v0.0.0-20191119224855-298f0cb1881e/go.mod h1:b+2E5dAYhXwXZwtnZ6UAqBI28+e2cm9otk0dWdXHAEo=\ngolang.org/x/tools v0.1.12/go.mod h1:hNGJHUnrk76NpqgfD5Aqm5Crs+Hm0VOH/i9J2+nxYbc=\ngolang.org/x/tools v0.6.0/go.mod h1:Xwgl3UAJ/d3gWutnCtw505GrjyAbvKui8lOU390QaIU=\ngolang.org/x/xerrors v0.0.0-20190717185122-a985d3407aa7/go.mod h1:I/5z698sn9Ka8TeJc9MKroUUfqBBauWjQqLJ2OPfmY0=\ngolang.org/x/xerrors v0.0.0-20191204190536-9bdfabe68543/go.mod h1:I/5z698sn9Ka8TeJc9MKroUUfqBBauWjQqLJ2OPfmY0=\ngoogle.golang.org/genproto/googleapis/rpc v0.0.0-20230920204549-e6e6cdab5c13 h1:N3bU/SQDCDyD6R528GJ/PwW9KjYcJA3dgyH+MovAkIM=\ngoogle.golang.org/genproto/googleapis/rpc v0.0.0-20230920204549-e6e6cdab5c13/go.mod h1:KSqppvjFjtoCI+KGd4PELB0qLNxdJHRGqRI09mB6pQA=\ngoogle.golang.org/grpc v1.58.2 h1:SXUpjxeVF3FKrTYQI4f4KvbGD5u2xccdYdurwowix5I=\ngoogle.golang.org/grpc v1.58.2/go.mod h1:tgX3ZQDlNJGU96V6yHh1T/JeoBQ2TXdr43YbYSsCJk0=\ngoogle.golang.org/protobuf v1.26.0-rc.1/go.mod h1:jlhhOSvTdKEhbULTjvd4ARK9grFBp09yW+WbY/TyQbw=\ngoogle.golang.org/protobuf v1.26.0/go.mod h1:9q0QmTI4eRPtz6boOQmLYwt+qCgq0jsYwAQnmE0givc=\ngoogle.golang.org/protobuf v1.31.0 h1:g0LDEJHgrBl9N9r17Ru3sqWhkIx2NB67okBHPwC7hs8=\ngoogle.golang.org/protobuf v1.31.0/go.mod h1:HV8QOd/L58Z+nl8r43ehVNZIU/HEI6OcFqwMG9pJV4I=\ngopkg.in/check.v1 v0.0.0-20161208181325-20d25e280405 h1:yhCVgyC4o1eVCa2tZl7eS0r+SDo693bJlVdllGtEeKM=\ngopkg.in/check.v1 v0.0.0-20161208181325-20d25e280405/go.mod h1:Co6ibVJAznAaIkqp8huTwlJQCZ016jof/cbN4VW5Yz0=\ngopkg.in/yaml.v2 v2.4.0 h1:D8xgwECY7CYvx+Y2n4sBz93Jn9JRvxdiyyo8CTfuKaY=\ngopkg.in/yaml.v2 v2.4.0/go.mod h1:RDklbk79AGWmwhnvt/jBztapEOGDOx6ZbXqjP6csGnQ=\ngopkg.in/yaml.v3 v3.0.0-20200313102051-9f266ea9e77c/go.mod h1:K4uyk7z7BCEPqu6E+C64Yfv1cQ7kz7rIZviUmN+EgEM=\ngopkg.in/yaml.v3 v3.0.1 h1:fxVm/GzAzEWqLHuvctI91KS9hhNmmWOoWu0XTYJS7CA=\nhonnef.co/go/js/dom/v2 v2.0.0-20190526011328-ebc4cf92d81f/go.mod h1:H5R0jAIe6IchQE778FS2QcrNVgS4vPFb0HPb72n/IJI=\n"
        },
        {
          "name": "main.go",
          "type": "blob",
          "size": 23.6611328125,
          "content": "package main\n\nimport (\n\t_ \"embed\"\n\t\"encoding/json\"\n\t\"fmt\"\n\t\"image\"\n\t\"io\"\n\t\"math\"\n\t\"math/rand\"\n\t\"net\"\n\t\"net/http\"\n\t_ \"net/http/pprof\"\n\t\"os\"\n\t\"os/signal\"\n\t\"path/filepath\"\n\t\"runtime/debug\"\n\t\"strconv\"\n\t\"strings\"\n\t\"sync\"\n\t\"syscall\"\n\t\"time\"\n\n\t\"github.com/acarl005/stripansi\"\n\t\"github.com/gliderlabs/ssh\"\n\tterminal \"github.com/quackduck/term\"\n)\n\nvar (\n\tMainRoom                   = &Room{\"#main\", make([]*User, 0, 10), sync.RWMutex{}}\n\tRooms                      = map[string]*Room{MainRoom.name: MainRoom}\n\tBacklog                    []backlogMessage\n\tBans                       = make([]Ban, 0, 10)\n\tIDandIPsToTimesJoinedInMin = make(map[string]int, 10) // ban type has addr and id\n\tAntispamMessages           = make(map[string]int)\n\tTORIPs                     = make(map[string]bool)\n\n\tDevbot = Green.Paint(\"devbot\")\n)\n\nconst (\n\tmaxMsgLen = 5120\n)\n\ntype Ban struct {\n\tAddr string\n\tID   string\n}\n\ntype Room struct {\n\tname       string\n\tusers      []*User\n\tusersMutex sync.RWMutex\n}\n\n// User represents a user connected to the SSH server.\n// Exported fields represent ones saved to disk. (see also: User.savePrefs())\ntype User struct {\n\tName            string\n\tPrompt          string\n\tformattedPrompt string\n\tPronouns        []string\n\tBio             string\n\tsession         ssh.Session\n\tterm            *terminal.Terminal\n\n\troom      *Room\n\tmessaging *User // currently messaging this User in a DM\n\n\tBell          bool\n\tPingEverytime bool\n\tisBridge      bool\n\tIsMuted       bool\n\tFormatTime24  bool\n\n\tColor   string\n\tColorBG string\n\tid      string\n\taddr    string\n\n\twinWidth      int\n\tlastTimestamp time.Time\n\tjoinTime      time.Time\n\tlastInteract  time.Time\n\tTimezone      tz\n}\n\ntype tz struct {\n\t*time.Location\n}\n\nfunc (t *tz) UnmarshalJSON(b []byte) error {\n\tvar s string\n\tif err := json.Unmarshal(b, &s); err != nil {\n\t\treturn err\n\t}\n\tif s == \"\" { // empty string means timezone agnostic format\n\t\tt.Location = nil\n\t\treturn nil\n\t}\n\tloc, err := time.LoadLocation(s)\n\tif err != nil {\n\t\treturn err\n\t}\n\tt.Location = loc\n\treturn nil\n}\n\nfunc (t *tz) MarshalJSON() ([]byte, error) {\n\tif t.Location == nil {\n\t\treturn json.Marshal(\"\")\n\t}\n\treturn json.Marshal(t.Location.String())\n}\n\ntype backlogMessage struct {\n\ttimestamp  time.Time\n\tsenderName string\n\ttext       string\n}\n\n// TODO: have a web dashboard that shows logs\nfunc main() {\n\tgo func() {\n\t\terr := http.ListenAndServe(fmt.Sprintf(\":%d\", Config.ProfilePort), nil)\n\t\tif err != nil {\n\t\t\tLog.Println(err)\n\t\t}\n\t}()\n\treadBans()\n\tc := make(chan os.Signal, 2)\n\tsignal.Notify(c, os.Interrupt, syscall.SIGTERM, syscall.SIGHUP)\n\tgo func() {\n\t\t<-c\n\t\tfmt.Println(\"Shutting down...\")\n\t\tsaveBans()\n\t\ttime.AfterFunc(time.Second, func() {\n\t\t\tLog.Println(\"Broadcast taking too long, exiting server early.\")\n\t\t\tos.Exit(4)\n\t\t})\n\t\tfor _, r := range Rooms {\n\t\t\tr.broadcast(Devbot, \"Server going down! This is probably because it is being updated. Try joining back immediately.  \\n\"+\n\t\t\t\t\"If you still can't join, try joining back in 2 minutes. If you _still_ can't join, make an issue at github.com/quackduck/devzat/issues\")\n\t\t\tfor _, u := range r.users {\n\t\t\t\tu.savePrefs() //nolint:errcheck\n\t\t\t}\n\t\t}\n\t\tos.Exit(0)\n\t}()\n\n\t// read tor list from https://www.dan.me.uk/torlist/?exit\n\tresp, err := http.Get(\"https://www.dan.me.uk/torlist/?exit\")\n\tif err == nil {\n\t\tdefer resp.Body.Close()\n\t\tbody, err := io.ReadAll(resp.Body)\n\t\tif err != nil {\n\t\t\tLog.Println(err)\n\t\t}\n\t\tfor _, ip := range strings.Split(string(body), \"\\n\") {\n\t\t\tTORIPs[ip] = true\n\t\t}\n\t} else {\n\t\tLog.Println(err)\n\t}\n\n\tssh.Handle(func(s ssh.Session) {\n\t\tgo keepSessionAlive(s)\n\t\tu := newUser(s)\n\t\tif u == nil {\n\t\t\ts.Close()\n\t\t\treturn\n\t\t}\n\t\tdefer protectFromPanic()\n\t\tu.repl()\n\t})\n\n\tif Config.Private {\n\t\tLog.Printf(\"Starting a private Devzat server on port %d and profiling on port %d\\n Edit your config to change who's allowed entry.\", Config.Port, Config.ProfilePort)\n\t} else {\n\t\tLog.Printf(\"Starting a Devzat server on port %d and profiling on port %d\\n\", Config.Port, Config.ProfilePort)\n\t}\n\tgo getMsgsFromSlack()\n\tcheckKey(Config.KeyFile)\n\tif !Config.Private { // allow non-sshkey logins on a non-private server\n\t\tgo func() {\n\t\t\tfmt.Println(\"Also serving on port\", Config.AltPort)\n\t\t\terr := ssh.ListenAndServe(fmt.Sprintf(\":%d\", Config.AltPort), nil, ssh.HostKeyFile(Config.KeyFile))\n\t\t\tif err != nil {\n\t\t\t\tfmt.Println(err)\n\t\t\t}\n\t\t}()\n\t}\n\terr = ssh.ListenAndServe(fmt.Sprintf(\":%d\", Config.Port), nil, ssh.HostKeyFile(Config.KeyFile),\n\t\tssh.PublicKeyAuth(func(ctx ssh.Context, key ssh.PublicKey) bool {\n\t\t\treturn true // allow all keys, this lets us hash pubkeys later\n\t\t}),\n\t\tssh.WrapConn(func(s ssh.Context, conn net.Conn) net.Conn { // doesn't actually work for some reason?\n\t\t\tconn.(*net.TCPConn).SetKeepAlive(true)              //nolint:errcheck\n\t\t\tconn.(*net.TCPConn).SetKeepAlivePeriod(time.Minute) //nolint:errcheck\n\t\t\treturn conn\n\t\t}),\n\t)\n\tif err != nil {\n\t\tfmt.Println(err)\n\t}\n}\n\nfunc (r *Room) broadcast(senderName, msg string) {\n\tif msg == \"\" {\n\t\treturn\n\t}\n\tif Integrations.Slack != nil || Integrations.Discord != nil {\n\t\tvar toSendS string\n\t\tif senderName != \"\" {\n\t\t\tif Integrations.Slack != nil {\n\t\t\t\ttoSendS = \"[\" + r.name + \"] *\" + senderName + \"*: \" + msg\n\t\t\t}\n\t\t} else {\n\t\t\ttoSendS = \"[\" + r.name + \"] \" + msg\n\t\t}\n\t\tif Integrations.Slack != nil {\n\t\t\tselect {\n\t\t\tcase SlackChan <- toSendS:\n\t\t\tdefault:\n\t\t\t\tLog.Println(\"Overflow in Slack channel\")\n\t\t\t}\n\t\t}\n\t\tif Integrations.Discord != nil {\n\t\t\tselect {\n\t\t\tcase DiscordChan <- DiscordMsg{\n\t\t\t\tsenderName: senderName,\n\t\t\t\tmsg:        msg,\n\t\t\t\tchannel:    r.name,\n\t\t\t}:\n\t\t\tdefault:\n\t\t\t\tLog.Println(\"Overflow in Discord channel\")\n\t\t\t}\n\t\t}\n\t}\n\tr.broadcastNoBridges(senderName, msg)\n}\n\n// findMention finds mentions and colors them\nfunc (r *Room) findMention(msg string) string {\n\tif len(msg) == 0 {\n\t\treturn msg\n\t}\n\tmaxLen := 0\n\tindexMax := -1\n\n\tif msg[0] == '@' {\n\t\tfor i := range r.users {\n\t\t\trawName := stripansi.Strip(r.users[i].Name)\n\t\t\tif strings.HasPrefix(msg, \"@\"+rawName) {\n\t\t\t\tif len(rawName) > maxLen {\n\t\t\t\t\tmaxLen = len(rawName)\n\t\t\t\t\tindexMax = i\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\tif indexMax != -1 { // found a mention\n\t\t\treturn r.users[indexMax].Name + r.findMention(msg[maxLen+1:])\n\t\t}\n\t}\n\n\tposAt := strings.IndexByte(msg, '@')\n\tif posAt < 0 { // no mention\n\t\treturn msg\n\t}\n\tif posAt == 0 { // if the message starts with \"@\" but it isn't a valid mention, we don't want to create an infinite loop\n\t\treturn \"@\" + r.findMention(msg[1:])\n\t}\n\n\tif msg[posAt-1] == '\\\\' { // if the \"@\" is escaped\n\t\treturn msg[0:posAt-1] + \"@\" + r.findMention(msg[posAt+1:])\n\t}\n\n\treturn msg[0:posAt] + r.findMention(msg[posAt:])\n}\n\nfunc (r *Room) broadcastNoBridges(senderName, msg string) {\n\tif msg == \"\" {\n\t\treturn\n\t}\n\tmsg = r.findMention(strings.ReplaceAll(msg, \"@everyone\", Green.Paint(\"everyone\\a\")))\n\timgCache := make(map[string]image.Image, 1)\n\t//go func() {\n\t//r.usersMutex.RLock()\n\t//timeAtStart := time.Now()\n\tfor i := 0; i < len(r.users); i++ { // updates when new users join or old users leave. it is okay to read concurrently.\n\t\t//if time.Since(timeAtStart) > time.Second*3 {\n\t\t//\tgo r.users[i].writeln(senderName, msg)\n\t\t//} else {\n\t\tr.users[i].writelnWithImageCache(senderName, msg, imgCache)\n\t\t//}\n\t}\n\tdebug.FreeOSMemory()\n\t//runtime.GC()\n\t//r.usersMutex.RUnlock()\n\t//}()\n\tif r == MainRoom && len(Backlog) > 0 {\n\t\tBacklog = Backlog[1:]\n\t\tBacklog = append(Backlog, backlogMessage{time.Now(), senderName, msg + \"\\n\"})\n\t}\n}\n\nfunc autocompleteCallback(u *User, line string, pos int, key rune) (string, int, bool) {\n\tif key == '\\t' {\n\t\t// Autocomplete a username\n\n\t\t// Split the input string to look for @<name>\n\t\twords := strings.Fields(line)\n\n\t\ttoAdd := userMentionAutocomplete(u, words)\n\t\tif toAdd != \"\" {\n\t\t\treturn line + toAdd, pos + len(toAdd), true\n\t\t}\n\t\ttoAdd = roomAutocomplete(u, words)\n\t\tif toAdd != \"\" {\n\t\t\treturn line + toAdd, pos + len(toAdd), true\n\t\t}\n\t}\n\treturn \"\", pos, false\n}\n\nfunc userMentionAutocomplete(u *User, words []string) string {\n\tif len(words) < 1 {\n\t\treturn \"\"\n\t}\n\t// remove @, =, or =@ from the start of the last word\n\tlastWord := words[len(words)-1]\n\tif len(lastWord) > 1 && lastWord[0] == '=' && lastWord[1] == '@' {\n\t\tlastWord = lastWord[2:]\n\t} else if lastWord[0] == '@' || lastWord[0] == '=' {\n\t\tlastWord = lastWord[1:]\n\t} else { // No prefix match\n\t\treturn \"\"\n\t}\n\t// check the last word and see if it's trying to refer to a user\n\tfor i := range u.room.users {\n\t\tstrippedName := stripansi.Strip(u.room.users[i].Name)\n\t\ttoAdd := strings.TrimPrefix(strippedName, lastWord)\n\t\tif toAdd != strippedName { // there was a match, and some text got trimmed!\n\t\t\treturn toAdd + \" \"\n\t\t}\n\t}\n\treturn \"\"\n}\n\nfunc roomAutocomplete(_ *User, words []string) string {\n\t// trying to refer to a room?\n\tif len(words) > 0 && words[len(words)-1][0] == '#' {\n\t\t// don't slice the # off, since the room name includes it\n\t\tfor name := range Rooms {\n\t\t\ttoAdd := strings.TrimPrefix(name, words[len(words)-1])\n\t\t\tif toAdd != name { // there was a match, and some text got trimmed!\n\t\t\t\treturn toAdd + \" \"\n\t\t\t}\n\t\t}\n\t}\n\treturn \"\"\n}\n\nfunc newUser(s ssh.Session) *User {\n\tterm := terminal.NewTerminal(s, \"> \")\n\t_ = term.SetSize(10000, 10000) // disable any formatting done by term\n\tpty, winChan, isPty := s.Pty()\n\tw := pty.Window.Width\n\tif !isPty { // only support pty joins\n\t\tterm.Write([]byte(\"Devzat does not allow non-pty joins. What are you trying to pull here?\"))\n\t\treturn nil\n\t}\n\tif w <= 0 { // strange terminals\n\t\tw = 80\n\t}\n\n\thost, _, _ := net.SplitHostPort(s.RemoteAddr().String()) // definitely should not give an err\n\n\ttoHash := \"\"\n\n\tpubkey := s.PublicKey()\n\tif pubkey != nil {\n\t\ttoHash = string(pubkey.Marshal())\n\t} else { // If we can't get the public key fall back to the IP.\n\t\ttoHash = host\n\t}\n\n\tu := &User{\n\t\tName:          s.User(),\n\t\tPronouns:      []string{\"unset\"},\n\t\tsession:       s,\n\t\tterm:          term,\n\t\tColorBG:       \"bg-off\",\n\t\tBell:          true,\n\t\tBio:           \"(none set)\",\n\t\tid:            shasum(toHash),\n\t\taddr:          host,\n\t\twinWidth:      w,\n\t\tlastTimestamp: time.Now(),\n\t\tlastInteract:  time.Now(),\n\t\tjoinTime:      time.Now(),\n\t\troom:          MainRoom}\n\n\tgo func() {\n\t\tfor win := range winChan {\n\t\t\tif win.Width > 0 {\n\t\t\t\tu.winWidth = win.Width\n\t\t\t}\n\t\t}\n\t}()\n\n\tLog.Println(\"Connected \" + u.Name + \" [\" + u.id + \"]\")\n\n\tif bansContains(Bans, u.addr, u.id) || TORIPs[u.addr] {\n\t\tLog.Println(\"Rejected \" + u.Name + \" [\" + host + \"] (banned)\")\n\t\tu.writeln(Devbot, \"**You are banned**. If you feel this was a mistake, please reach out to the server admin. Include the following information: [ID \"+u.id+\"]\")\n\t\ts.Close()\n\t\treturn nil\n\t}\n\n\tif Config.Private {\n\t\t_, isOnAllowlist := Config.Allowlist[u.id]\n\t\t_, isAdmin := Config.Admins[u.id]\n\t\tif !(isAdmin || isOnAllowlist) {\n\t\t\tLog.Println(\"Rejected \" + u.Name + \" [\" + u.id + \"] (not on allowlist)\")\n\t\t\tu.writeln(Devbot, \"You are not on the allowlist of this private server. If this is a mistake, send your id (\"+u.id+\") to the admin so that they can add you.\")\n\t\t\ts.Close()\n\t\t\treturn nil\n\t\t}\n\t}\n\n\tIDandIPsToTimesJoinedInMin[u.addr]++\n\tIDandIPsToTimesJoinedInMin[u.id]++\n\ttime.AfterFunc(60*time.Second, func() {\n\t\tIDandIPsToTimesJoinedInMin[u.addr]--\n\t\tIDandIPsToTimesJoinedInMin[u.id]--\n\t})\n\tif IDandIPsToTimesJoinedInMin[u.addr] > 6 || IDandIPsToTimesJoinedInMin[u.id] > 6 {\n\t\tu.ban(\"\")\n\t\tMainRoom.broadcast(Devbot, u.Name+\" has been banned automatically. ID: \"+u.id)\n\t\treturn nil\n\t}\n\n\tclearCMD(\"\", u) // always clear the screen on connect\n\tholidaysCheck(u)\n\n\tif rand.Float64() <= 0.4 { // 40% chance of being a random color\n\t\tu.changeColor(\"random\") //nolint:errcheck // we know \"random\" is a valid color\n\t} else {\n\t\tu.changeColor(Styles[rand.Intn(len(Styles))].name) //nolint:errcheck // we know this is a valid color\n\t}\n\tif rand.Float64() <= 0.1 { // 10% chance of a random bg color\n\t\tu.changeColor(\"bg-random\") //nolint:errcheck // we know \"bg-random\" is a valid color\n\t}\n\n\tu.Prompt = \"\\\\u:\\\\S\"\n\ttimeoutChan := make(chan bool)\n\ttimedOut := false\n\tgo func() { // timeout to minimize inactive connections\n\t\terr := u.loadPrefs()\n\t\tif err != nil && !timedOut {\n\t\t\tLog.Println(\"Could not load user:\", err)\n\t\t\treturn\n\t\t}\n\t\tif timedOut {\n\t\t\treturn\n\t\t}\n\t\tif err = u.pickUsernameQuietly(stripansi.Strip(u.Name)); err != nil && !timedOut {\n\t\t\tLog.Println(err)\n\t\t\ts.Close()\n\t\t\ts = nil // marker so we know to exit\n\t\t}\n\t\ttimeoutChan <- true\n\t}()\n\n\tselect {\n\tcase <-time.After(time.Minute):\n\t\tLog.Println(\"Timeout for user\", stripansi.Strip(u.Name), \"with ID\", u.id)\n\t\ttimedOut = true\n\t\ts.Close()\n\t\treturn nil\n\tcase <-timeoutChan:\n\t\tif s == nil {\n\t\t\treturn nil\n\t\t}\n\t}\n\n\tif !Config.Private { // sensitive info might be shared on a private server\n\t\tvar lastStamp time.Time\n\t\tfor i := range Backlog {\n\t\t\tif Backlog[i].text == \"\" { // skip empty entries\n\t\t\t\tcontinue\n\t\t\t}\n\t\t\tif i == 0 || Backlog[i].timestamp.Sub(lastStamp) > time.Minute {\n\t\t\t\tlastStamp = Backlog[i].timestamp\n\t\t\t\tu.rWriteln(fmtTime(u, lastStamp))\n\t\t\t}\n\t\t\tu.writeln(Backlog[i].senderName, Backlog[i].text)\n\t\t}\n\t\tif time.Since(lastStamp) > time.Minute && u.Timezone.Location != nil {\n\t\t\tu.rWriteln(fmtTime(u, time.Now()))\n\t\t}\n\t}\n\n\tMainRoom.usersMutex.Lock()\n\tMainRoom.users = append(MainRoom.users, u)\n\tMainRoom.usersMutex.Unlock()\n\tgo sendCurrentUsersTwitterMessage()\n\n\tu.term.SetBracketedPasteMode(true) // experimental paste bracketing support\n\tterm.AutoCompleteCallback = func(line string, pos int, key rune) (string, int, bool) {\n\t\treturn autocompleteCallback(u, line, pos, key)\n\t}\n\n\tswitch len(MainRoom.users) - 1 {\n\tcase 0:\n\t\tu.writeln(\"\", Blue.Paint(\"Welcome to the chat. There are no more users\"))\n\tcase 1:\n\t\tu.writeln(\"\", Yellow.Paint(\"Welcome to the chat. There is one more user\"))\n\tdefault:\n\t\tu.writeln(\"\", Green.Paint(\"Welcome to the chat. There are\", strconv.Itoa(len(MainRoom.users)-1), \"more users\"))\n\t}\n\tMainRoom.broadcast(\"\", Green.Paint(\" --> \")+u.Name+\" has joined the chat\")\n\treturn u\n}\n\n// cleanupRoomInstant deletes a room if it's empty and isn't the main room\nfunc cleanupRoomInstant(r *Room) {\n\tif r != MainRoom && r != nil && len(r.users) == 0 {\n\t\tdelete(Rooms, r.name)\n\t}\n}\n\nvar cleanupMap = make(map[*Room]chan bool, 5)\n\nfunc cleanupRoom(r *Room) {\n\tif ch, ok := cleanupMap[r]; ok {\n\t\tch <- true // reset timer\n\t\treturn\n\t}\n\tgo func() {\n\t\tch := make(chan bool) // no buffer needed\n\t\tcleanupMap[r] = ch\n\t\ttimer := time.NewTimer(time.Hour * 24)\n\t\tfor {\n\t\t\tselect {\n\t\t\tcase <-ch: // need a reset?\n\t\t\t\tif !timer.Stop() {\n\t\t\t\t\t<-timer.C\n\t\t\t\t}\n\t\t\t\ttimer.Reset(time.Hour * 24)\n\t\t\t\t// no return, carry on to the next select\n\t\t\tcase <-timer.C:\n\t\t\t\tdelete(cleanupMap, r)\n\t\t\t\ttimer.Stop()\n\t\t\t\tcleanupRoomInstant(r)\n\t\t\t\treturn // done!\n\t\t\t}\n\t\t}\n\t}()\n}\n\n// Removes a User and prints a chat message\nfunc (u *User) close(msg string) {\n\tu.room.usersMutex.Lock()\n\tu.room.users = remove(u.room.users, u)\n\tu.room.usersMutex.Unlock()\n\tcleanupRoom(u.room)\n\tif u.isBridge {\n\t\treturn\n\t}\n\tif u.session == nil {\n\t\treturn\n\t}\n\tu.session.Close()\n\tu.session = nil\n\terr := u.savePrefs()\n\tif err != nil {\n\t\tLog.Println(err) // not much else we can do\n\t}\n\tif msg == \"\" {\n\t\treturn\n\t}\n\tif time.Since(u.joinTime) > time.Minute/2 {\n\t\tmsg += \". They were online for \" + printPrettyDuration(time.Since(u.joinTime))\n\t}\n\tu.room.broadcast(\"\", Red.Paint(\" <-- \")+msg)\n}\n\nfunc (u *User) ban(banner string) {\n\tif u.addr == \"\" && u.id == \"\" {\n\t\treturn\n\t}\n\tBans = append(Bans, Ban{u.addr, u.id})\n\tsaveBans()\n\tuid := u.id\n\tu.close(banner)\n\tfor i := range Rooms { // close all users that have this id (including this user)\n\t\tfor j := 0; j < len(Rooms[i].users); j++ {\n\t\t\tif Rooms[i].users[j].id == uid {\n\t\t\t\tRooms[i].users[j].close(\"\")\n\t\t\t\tj--\n\t\t\t}\n\t\t}\n\t}\n}\n\nfunc (u *User) writeln(senderName string, msg string) { u.writelnWithImageCache(senderName, msg, nil) }\n\nfunc (u *User) writelnWithImageCache(senderName string, msg string, cache map[string]image.Image) {\n\tif strings.Contains(msg, u.Name) { // is a ping\n\t\tmsg += \"\\a\"\n\t}\n\tmsg = strings.ReplaceAll(msg, `\\n`, \"\\n\")\n\tmsg = strings.ReplaceAll(msg, `\\`+\"\\n\", `\\n`) // let people escape newlines\n\tthisUserIsDMSender := strings.HasSuffix(senderName, \" <- \")\n\tif senderName != \"\" {\n\t\tif thisUserIsDMSender || strings.HasSuffix(senderName, \" -> \") { // TODO: kinda hacky DM detection\n\t\t\tmsg = strings.TrimSpace(mdRender(msg, lenString(senderName), u.winWidth, cache))\n\t\t\tmsg = senderName + msg\n\t\t\tif !thisUserIsDMSender {\n\t\t\t\tmsg += \"\\a\"\n\t\t\t}\n\t\t} else {\n\t\t\tmsg = strings.TrimSpace(mdRender(msg, lenString(senderName)+2, u.winWidth, cache))\n\t\t\tmsg = senderName + \": \" + msg\n\t\t}\n\t} else {\n\t\tmsg = strings.TrimSpace(mdRender(msg, 0, u.winWidth, cache)) // No sender\n\t}\n\tif time.Since(u.lastTimestamp) > time.Minute {\n\t\tu.lastTimestamp = time.Now()\n\t\tu.rWriteln(fmtTime(u, u.lastTimestamp))\n\t}\n\tif u.PingEverytime && senderName != u.Name && !thisUserIsDMSender {\n\t\tmsg += \"\\a\"\n\t}\n\tif !u.Bell {\n\t\tmsg = strings.ReplaceAll(msg, \"\\a\", \"\")\n\t}\n\t_, err := u.term.Write([]byte(msg + \"\\n\"))\n\tif err != nil {\n\t\tu.close(u.Name + \" has left the chat because of an error writing to their terminal: \" + err.Error())\n\t}\n}\n\n// Write to the right of the User's window\nfunc (u *User) rWriteln(msg string) {\n\tif u.winWidth-lenString(msg) > 0 {\n\t\tu.term.Write([]byte(strings.Repeat(\" \", u.winWidth-lenString(msg)) + msg + \"\\n\"))\n\t} else {\n\t\tu.term.Write([]byte(msg + \"\\n\"))\n\t}\n}\n\n// pickUsernameQuietly changes the User's username, broadcasting a name change notification if needed.\n// An error is returned if the username entered had a bad word or reading input failed.\nfunc (u *User) pickUsername(possibleName string) error {\n\toldName := u.Name\n\terr := u.pickUsernameQuietly(possibleName)\n\tif err != nil {\n\t\treturn err\n\t}\n\tif stripansi.Strip(u.Name) != stripansi.Strip(oldName) && stripansi.Strip(u.Name) != possibleName { // did the name change, and is it not what the User entered?\n\t\tu.room.broadcast(Devbot, oldName+\" is now called \"+u.Name)\n\t}\n\treturn nil\n}\n\n// pickUsernameQuietly is like pickUsername but does not broadcast a name change notification.\nfunc (u *User) pickUsernameQuietly(possibleName string) error {\n\tpossibleName = cleanName(possibleName)\n\tvar err error\n\tfor {\n\t\tif possibleName == \"\" || strings.HasPrefix(possibleName, \"#\") || possibleName == \"devbot\" || strings.HasPrefix(possibleName, \"@\") {\n\t\t\tu.writeln(\"\", \"Your username is invalid. Pick a different one:\")\n\t\t} else if otherUser, dup := userDuplicate(u.room, possibleName); dup {\n\t\t\tif otherUser == u {\n\t\t\t\tbreak // allow selecting the same name as before the user tried to change it\n\t\t\t}\n\t\t\tu.writeln(\"\", \"Your username is already in use. Pick a different one:\")\n\t\t} else { // valid name\n\t\t\tbreak\n\t\t}\n\n\t\tu.term.SetPrompt(\"> \")\n\t\tpossibleName, err = u.term.ReadLine()\n\t\tif err != nil {\n\t\t\treturn err\n\t\t}\n\t\tpossibleName = cleanName(possibleName)\n\t}\n\n\tpossibleName = rmBadWords(possibleName)\n\n\tu.Name, _ = applyColorToData(possibleName, u.Color, u.ColorBG) //nolint:errcheck // we haven't changed the color so we know it's valid\n\tu.formatPrompt()\n\treturn nil\n}\n\nfunc (u *User) displayPronouns() string {\n\tresult := \"\"\n\tfor i := 0; i < len(u.Pronouns); i++ {\n\t\tstr, _ := applyColorToData(u.Pronouns[i], u.Color, u.ColorBG)\n\t\tresult += \"/\" + str\n\t}\n\tif result == \"\" {\n\t\treturn result\n\t}\n\treturn result[1:]\n}\n\nfunc (u *User) savePrefs() error {\n\toldname := u.Name\n\tu.Name = stripansi.Strip(u.Name)\n\tdata, err := json.Marshal(u)\n\tu.Name = oldname\n\tif err != nil {\n\t\treturn err\n\t}\n\tsaveTo := filepath.Join(Config.DataDir, \"user-prefs\")\n\terr = os.MkdirAll(saveTo, 0755)\n\tif err != nil {\n\t\treturn err\n\t}\n\tsaveTo = filepath.Join(saveTo, u.id+\".json\")\n\terr = os.WriteFile(saveTo, data, 0644)\n\treturn err\n}\n\nfunc (u *User) loadPrefs() error {\n\tsave := filepath.Join(Config.DataDir, \"user-prefs\", u.id+\".json\")\n\n\tdata, err := os.ReadFile(save)\n\tif err != nil {\n\t\tif os.IsNotExist(err) { // new user, nothing saved yet\n\t\t\treturn nil\n\t\t}\n\t\treturn err\n\t}\n\n\toldUser := *u //nolint:govet // complains because of a lock copy. We may need that exact lock value later on\n\n\terr = json.Unmarshal(data, u) // won't overwrite private fields\n\tif err != nil {\n\t\treturn err\n\t}\n\n\tnewName := u.Name\n\tu.Name = oldUser.Name\n\n\terr = u.pickUsernameQuietly(newName)\n\tif err != nil {\n\t\treturn err\n\t}\n\terr = u.changeColor(u.Color)\n\tif err != nil {\n\t\treturn err\n\t}\n\terr = u.changeColor(u.ColorBG)\n\tif err != nil {\n\t\treturn err\n\t}\n\treturn nil\n}\n\nfunc (u *User) changeRoom(r *Room) {\n\tif u.room == r {\n\t\treturn\n\t}\n\tu.room.users = remove(u.room.users, u)\n\tu.room.broadcast(\"\", u.Name+\" is joining \"+Blue.Paint(r.name)) // tell the old room\n\tcleanupRoom(u.room)\n\tu.room = r\n\tif _, dup := userDuplicate(u.room, u.Name); dup {\n\t\tu.pickUsername(\"\") //nolint:errcheck // if reading input failed the next repl will err out\n\t}\n\tu.room.users = append(u.room.users, u)\n\tu.room.broadcast(\"\", Green.Paint(\" --> \")+u.Name+\" has joined \"+Blue.Paint(u.room.name))\n}\n\nfunc (u *User) formatPrompt() {\n\tu.formattedPrompt = \"\"\n\tlast_escaped := false\n\tfor _, c := range u.Prompt {\n\t\tif c == '\\\\' {\n\t\t\tlast_escaped = true\n\t\t} else if last_escaped {\n\t\t\tlast_escaped = false\n\t\t\tswitch c {\n\t\t\tcase 'u':\n\t\t\t\tu.formattedPrompt += u.Name\n\t\t\tcase 'w':\n\t\t\t\tu.formattedPrompt += copyColor(u.room.name, u.Name)\n\t\t\tcase 'W':\n\t\t\t\tif u.room.name == \"#main\" {\n\t\t\t\t\tu.formattedPrompt += copyColor(\"~\", u.Name)\n\t\t\t\t} else {\n\t\t\t\t\tu.formattedPrompt += copyColor(\"~/\"+u.room.name[1:], u.Name)\n\t\t\t\t}\n\t\t\tcase 't', 'T':\n\t\t\t\tu.formattedPrompt += fmtTime(u, time.Now())\n\t\t\tcase 'h', 'H':\n\t\t\t\tu.formattedPrompt += copyColor(\"devzat\", u.Name)\n\t\t\tcase 'S':\n\t\t\t\tu.formattedPrompt += \" \"\n\t\t\tcase '$':\n\t\t\t\tif auth(u) {\n\t\t\t\t\tu.formattedPrompt += \"#\"\n\t\t\t\t} else {\n\t\t\t\t\tu.formattedPrompt += \"$\"\n\t\t\t\t}\n\t\t\tdefault:\n\t\t\t\tu.formattedPrompt += string(c)\n\t\t\t}\n\t\t} else {\n\t\t\tu.formattedPrompt += string(c)\n\t\t}\n\t}\n\tu.showPrompt()\n}\n\nfunc (u *User) showPrompt() {\n\tu.term.SetPrompt(u.formattedPrompt)\n}\n\nfunc (u *User) repl() {\n\tfor {\n\t\tu.lastInteract = time.Now()\n\t\tline, err := u.term.ReadLine()\n\t\tif err == io.EOF {\n\t\t\tu.close(u.Name + \" has left the chat\")\n\t\t\treturn\n\t\t}\n\n\t\tline += \"\\n\"\n\t\thasNewlines := false\n\t\t//oldPrompt := u.Name + \": \"\n\t\tfor err == terminal.ErrPasteIndicator {\n\t\t\thasNewlines = true\n\t\t\t//u.term.SetPrompt(strings.Repeat(\" \", lenString(u.Name)+2))\n\t\t\tu.term.SetPrompt(\"\")\n\t\t\tadditionalLine := \"\"\n\t\t\tadditionalLine, err = u.term.ReadLine()\n\t\t\tadditionalLine = strings.ReplaceAll(additionalLine, `\\n`, `\\\\n`)\n\t\t\t//additionalLine = strings.ReplaceAll(additionalLine, \"\\t\", strings.Repeat(\" \", 8))\n\t\t\tline += additionalLine + \"\\n\"\n\t\t}\n\t\tif err != nil {\n\t\t\tLog.Println(u.Name, err)\n\t\t\tu.close(u.Name + \" has left the chat due to an error: \" + err.Error())\n\t\t\treturn\n\t\t}\n\t\tif len(line) > maxMsgLen { // limit msg len as early as possible.\n\t\t\tline = line[0:maxMsgLen]\n\t\t}\n\t\tline = strings.TrimSpace(line)\n\n\t\tu.showPrompt()\n\n\t\tif hasNewlines {\n\t\t\tcalculateLinesTaken(u, u.Name+\": \"+line, u.winWidth)\n\t\t} else {\n\t\t\tu.term.Write([]byte(strings.Repeat(\"\\033[A\\033[2K\", int(math.Ceil(float64(lenString(u.Name+line)+2)/(float64(u.winWidth))))))) // basically, ceil(length of line divided by term width)\n\t\t}\n\n\t\tif line == \"\" {\n\t\t\tcontinue\n\t\t}\n\n\t\tAntispamMessages[u.id]++\n\t\ttime.AfterFunc(15*time.Second, func() {\n\t\t\tAntispamMessages[u.id]--\n\t\t})\n\t\tif AntispamMessages[u.id] >= 30 {\n\t\t\tu.room.broadcast(Devbot, u.Name+\", stop spamming or you could get banned.\")\n\t\t}\n\t\tif AntispamMessages[u.id] >= 50 {\n\t\t\tif !bansContains(Bans, u.addr, u.id) {\n\t\t\t\tBans = append(Bans, Ban{u.addr, u.id})\n\t\t\t\tsaveBans()\n\t\t\t}\n\t\t\tu.writeln(Devbot, \"anti-spam triggered\")\n\t\t\tu.close(Red.Paint(u.Name + \" has been banned for spamming\"))\n\t\t\treturn\n\t\t}\n\t\trunCommands(line, u)\n\t}\n}\n\n// may contain a bug (\"may\" because it could be the terminal's fault)\nfunc calculateLinesTaken(u *User, s string, width int) {\n\ts = stripansi.Strip(s)\n\t//fmt.Println(\"`\"+s+\"`\", \"width\", width)\n\tpos := 0\n\t//lines := 1\n\tu.term.Write([]byte(\"\\033[A\\033[2K\"))\n\tcurrLine := \"\"\n\tfor _, c := range s {\n\t\tpos++\n\t\tcurrLine += string(c)\n\t\tif c == '\\t' {\n\t\t\tpos += 8\n\t\t}\n\t\tif c == '\\n' || pos > width {\n\t\t\tpos = 1\n\t\t\t//lines++\n\t\t\tu.term.Write([]byte(\"\\033[A\\033[2K\"))\n\t\t}\n\t\t//fmt.Println(string(c), \"`\"+currLine+\"`\", \"pos\", pos, \"lines\", lines)\n\t}\n\t//return lines\n}\n\n// bansContains reports if the addr or id is found in the bans list\nfunc bansContains(b []Ban, addr string, id string) bool {\n\tfor i := 0; i < len(b); i++ {\n\t\tif b[i].Addr == addr || b[i].ID == id {\n\t\t\treturn true\n\t\t}\n\t}\n\treturn false\n}\n"
        },
        {
          "name": "mainserver.yml",
          "type": "blob",
          "size": 2.7470703125,
          "content": "# This is the config file for the main server.\n# It is not intended to be used as a default by self-hosted servers but can serve as a reference.\n\nport: 22\nalt_port: 443\nprofile_port: 5555\nscrollback: 16 # the number of messages from #main to keep in memory to give context when a user joins\ndata_dir: devzat-data\nkey_file: devzat-sshkey\nintegration_config: devzat-creds.yml # the file itself is not committed into the repo for obvious reasons\ncensor: true # the internet is harsh...\nadmins:\n  1eab2de20e41abed903ab2f22e7ff56dc059666dbe2ebbce07a8afeece8d0424: 'Shok: school'\n  7f0ee4cba8c8d886d654820c4ea09090dc12be00746b9a64b73faab3f83a85c6: 'B Smith: hackclub, github.com/Merlin04'\n  09db0042df8c48488e034cd03dfd30dc61a7db35cd7bb8964cd246b958adc1b9: 'Arcade Wise: hackclub, github.com/l3gacyb3ta'\n  12a9f108e7420460864de3d46610f722e69c80b2ac2fb1e2ada34aa952bbd73e: 'jmw: github.com/ciearius'\n  ee64c24b21b966a02f63fd663984836892ff804865baab923b1acf67e09afa50: 'Emma Trzupek: t0rchedf3rn (RHS)'\n  41fb7ecb8c216491cbe682f2a4c2964db6a9297f74ae48f0ec8bece1089ffec3: 'Leo, gh: GrandWasTaken, added cause idk'\n  f9bd8abcb5f3a943dd5c70eb7eca17e0c9ab1b2bb57cb144aba2120057a6cb4f: 'elitedino: github.com/elitedino'\n  00e821d2572f2988c72528b8c90c5b03b062b2c67d6531c5f902b6676d8db814: '@epic: diglet'\n  03b1b4bb01e0fcffdf2a7e5329d933ffc1f441545b4109331748d6ecb214a770: '@epic: kratos'\n  6540eb5e10199f7ad7010b042347794b94f4b73fd45584913a8c0955343a075c: '@epic: kraken-v3-regular'\n  c90cf5ea8a9bf831a9024ecfd9876a7116a2382653a9ce84a6d80b4dcfa2f979: 'cole: github.com/ColeDrain'\n  decafbad1c0de8dbc6b5d9df7c70668e4afe251f9886d75e93ebd7f28c131bda: 'Arkaeriit: github.com/Arkaeriit'\n  2c8c25ed743b3266068e8cb688cf998874875b3bedb2fa91c9a7d4904ac64483: 'Ara Narula: hackclub'\n  f5c7f9826b6e143f6e9c3920767680f503f259570f121138b2465bb2b052a85d: 'Ella Xu: hackclub'\n  f466ac6b6be43ba8efbac8406a34cf68f6843f2b79119a82726e4ad6e770ec7d: 'electronoob: electronoob.com'\n  ee11ee9258594dd7aac18f1fa43d5d32482ec063c86fc3386a058540b4ccbe26: 'Ishan Goel: quackduck'\n  3a3534a3d4727957a7e22c05d751d8921ef4a667973bd6d864a40c8ba39b9680: 'PPTide: github.com/PPTide'\n  120d352818aef5c2115b32d497253bffc67d26b09e65e8b63ee80f0acc8a8458: 'CaenJones: github.com/CaenJones'\n  d31bbe3dc058a935e29019e59d0c39d1a0a869db9042959198967c1c7b308e6e: 'CaenJones: (server) github.com/CaenJones'\n  dfc419ee8fc1a9ec4c608ead49113872ee42d85637faf4d542d72f64415a51e2: 'Alex S: hackclub, github.com/ajs256'\n  6acb2173bfe514c32d06639d5c3cac833e8e5a7af608c462cd737cd535bedc4f: 'Ry Hatton, Purdue, github.com/1ryh'\n  bed8118812b901da0f3768a2cfd3307ef8ce3597d8bb2095f33bcfcb90da27c7: 'Lukas Krapukaitis, Purdue'\n  ae8adc2ba18946eedf14fd6d6e614ae9fab8432893057340ddde2bace139ad9e: 'WhiteFlames'\n  580b439b3b1682fc1e13d6f765c8e4e6ee769c7e790ef2caf6aca5a1d3fd691c: 'amber'\n"
        },
        {
          "name": "plugin",
          "type": "tree",
          "content": null
        },
        {
          "name": "rpc.go",
          "type": "blob",
          "size": 10.5009765625,
          "content": "package main\n\nimport (\n\t\"context\"\n\t\"crypto/rand\"\n\t\"encoding/base64\"\n\t\"encoding/json\"\n\t\"fmt\"\n\t\"io\"\n\t\"net\"\n\t\"os\"\n\t\"regexp\"\n\t\"strings\"\n\t\"sync\"\n\t\"time\"\n\n\t\"github.com/acarl005/stripansi\"\n\n\tpb \"devzat/plugin\"\n\n\t\"google.golang.org/grpc\"\n\t\"google.golang.org/grpc/codes\"\n\t\"google.golang.org/grpc/keepalive\"\n\t\"google.golang.org/grpc/metadata\"\n\t\"google.golang.org/grpc/status\"\n)\n\nvar (\n\tPluginCMDs = map[string]PluginCMD{}\n\tRPCCMDs    = []CMD{\n\t\t{\"plugins\", pluginsCMD, \"\", \"List plugin commands\"},\n\t}\n\tRPCCMDsRest = []CMD{\n\t\t{\"lstokens\", lsTokensCMD, \"\", \"List plugin token hashes and their data (admin)\"},\n\t\t{\"revoke\", revokeTokenCMD, \"<token hash>\", \"Revoke a plugin token (admin)\"},\n\t\t{\"grant\", grantTokenCMD, \"[user] [data]\", \"Grant a token and optionally send it to a user (admin)\"},\n\t}\n\tListenersNonMiddleware = make([]chan pb.MiddlewareChannelMessage, 0, 4)\n\tListenersMiddleware    = make([]chan pb.MiddlewareChannelMessage, 0, 4)\n\tTokens                 = make(map[string]string, 10)\n)\n\ntype pluginServer struct {\n\tpb.UnimplementedPluginServer\n\tlock sync.Mutex\n}\n\nfunc (s *pluginServer) RegisterListener(stream pb.Plugin_RegisterListenerServer) error {\n\ts.lock.Lock()\n\tLog.Println(\"[gRPC] Registering event listener\")\n\tinitialData, err := stream.Recv()\n\tif err == io.EOF {\n\t\treturn nil\n\t}\n\tif err != nil {\n\t\treturn err\n\t}\n\n\tlistener := initialData.GetListener()\n\tif listener == nil {\n\t\treturn status.Error(codes.InvalidArgument, \"First message must be a listener\")\n\t}\n\n\tisMiddleware := listener.Middleware != nil && *listener.Middleware\n\tisOnce := listener.Once != nil && *listener.Once\n\n\tvar regex *regexp.Regexp\n\tif listener.Regex != nil {\n\t\tregex, err = regexp.Compile(*listener.Regex)\n\t\tif err != nil {\n\t\t\treturn status.Error(codes.InvalidArgument, \"Invalid regex\")\n\t\t}\n\t}\n\n\tvar listenerList *[]chan pb.MiddlewareChannelMessage\n\n\tif isMiddleware {\n\t\tlistenerList = &ListenersMiddleware\n\t} else {\n\t\tlistenerList = &ListenersNonMiddleware\n\t}\n\n\tc := make(chan pb.MiddlewareChannelMessage)\n\t*listenerList = append(*listenerList, c)\n\n\ts.lock.Unlock()\n\tdefer func() {\n\t\t// Remove the channel from the list where the channel is equal to c\n\t\tfor i := range *listenerList {\n\t\t\tif (*listenerList)[i] == c {\n\t\t\t\t*listenerList = append((*listenerList)[:i], (*listenerList)[i+1:]...)\n\t\t\t\tbreak\n\t\t\t}\n\t\t}\n\t}()\n\n\tfor {\n\t\tmessage := <-c\n\n\t\t// If something goes wrong, make sure the goroutine sending the message doesn't block on waiting for a response\n\t\tsendNilResponse := func() {\n\t\t\tc <- &pb.ListenerClientData_Response{\n\t\t\t\tResponse: &pb.MiddlewareResponse{\n\t\t\t\t\tMsg: nil,\n\t\t\t\t},\n\t\t\t}\n\t\t}\n\n\t\t// If there's a regex and it doesn't match, don't send the message to the plugin\n\t\tif listener.Regex != nil && !regex.MatchString(message.(*pb.Event).Msg) {\n\t\t\tif isMiddleware {\n\t\t\t\tsendNilResponse()\n\t\t\t}\n\t\t\tcontinue\n\t\t}\n\n\t\terr = stream.Send(message.(*pb.Event))\n\t\tif err != nil {\n\t\t\tif isMiddleware {\n\t\t\t\tsendNilResponse()\n\t\t\t}\n\t\t\treturn err\n\t\t}\n\n\t\tif isMiddleware {\n\t\t\tmwRes, err := stream.Recv()\n\t\t\tif err != nil {\n\t\t\t\tsendNilResponse()\n\t\t\t\treturn err\n\t\t\t}\n\t\t\tswitch data := mwRes.Data.(type) {\n\t\t\tcase *pb.ListenerClientData_Listener:\n\t\t\t\tsendNilResponse()\n\t\t\t\treturn status.Error(codes.InvalidArgument, \"Middleware returned a listener instead of a response\")\n\t\t\tcase *pb.ListenerClientData_Response:\n\t\t\t\tc <- data\n\t\t\t}\n\t\t}\n\n\t\tif isOnce {\n\t\t\tbreak\n\t\t}\n\t}\n\treturn nil\n}\n\ntype PluginCMD struct {\n\targsInfo       string\n\tinfo           string\n\tinvocationChan chan *pb.CmdInvocation\n}\n\nfunc (s *pluginServer) RegisterCmd(def *pb.CmdDef, stream pb.Plugin_RegisterCmdServer) error {\n\ts.lock.Lock()\n\tLog.Print(\"[gRPC] Registering command with name \" + def.Name)\n\tPluginCMDs[def.Name] = PluginCMD{\n\t\targsInfo:       def.ArgsInfo,\n\t\tinfo:           def.Info,\n\t\tinvocationChan: make(chan *pb.CmdInvocation),\n\t}\n\ts.lock.Unlock()\n\tdefer delete(PluginCMDs, def.Name)\n\n\tfor {\n\t\tif err := stream.Send(<-PluginCMDs[def.Name].invocationChan); err != nil {\n\t\t\treturn err\n\t\t}\n\t}\n}\n\nfunc (s *pluginServer) SendMessage(ctx context.Context, msg *pb.Message) (*pb.MessageRes, error) {\n\ts.lock.Lock()\n\tdefer s.lock.Unlock()\n\tif msg.GetEphemeralTo() != \"\" {\n\t\tu, success := findUserByName(Rooms[msg.Room], *msg.EphemeralTo)\n\t\tif !success {\n\t\t\treturn nil, status.Error(codes.NotFound, \"Could not find user \"+*msg.EphemeralTo)\n\t\t}\n\t\tu.writeln(msg.GetFrom()+\" -> \", msg.Msg)\n\t} else {\n\t\tr := Rooms[msg.Room]\n\t\tif r == nil {\n\t\t\treturn nil, status.Error(codes.InvalidArgument, \"Room does not exist\")\n\t\t}\n\t\tr.broadcast(msg.GetFrom(), msg.Msg)\n\t}\n\treturn &pb.MessageRes{}, nil\n}\n\nfunc authorize(ctx context.Context) error {\n\tmd, ok := metadata.FromIncomingContext(ctx)\n\tif !ok {\n\t\treturn status.Error(codes.Unauthenticated, \"Missing metadata\")\n\t}\n\n\tvalues := md[\"authorization\"]\n\tif len(values) == 0 {\n\t\treturn status.Error(codes.Unauthenticated, \"Missing authorization header\")\n\t}\n\n\ttoken := strings.TrimPrefix(values[0], \"Bearer \")\n\n\tif Integrations.RPC.Key != \"\" && token == Integrations.RPC.Key {\n\t\treturn nil\n\t}\n\tif _, ok = Tokens[token]; !ok {\n\t\treturn status.Error(codes.Unauthenticated, \"Invalid authorization header\")\n\t}\n\treturn nil\n}\n\nfunc rpcInit() {\n\tif Integrations.RPC == nil {\n\t\treturn\n\t}\n\tMainCMDs = append(MainCMDs, RPCCMDs...)\n\tRestCMDs = append(RestCMDs, RPCCMDsRest...)\n\tinitTokens()\n\tgo func() {\n\t\tlis, err := net.Listen(\"tcp\", fmt.Sprintf(\":%d\", Integrations.RPC.Port))\n\t\tif err != nil {\n\t\t\tLog.Println(\"[gRPC] Failed to listen for plugin server:\", err)\n\t\t\treturn\n\t\t}\n\t\t// TODO: add TLS if configured\n\t\tgrpcServer := grpc.NewServer(\n\t\t\tgrpc.UnaryInterceptor(func(ctx context.Context, req interface{}, info *grpc.UnaryServerInfo, handler grpc.UnaryHandler) (interface{}, error) {\n\t\t\t\tif err := authorize(ctx); err != nil {\n\t\t\t\t\treturn nil, err\n\t\t\t\t}\n\t\t\t\treturn handler(ctx, req)\n\t\t\t}),\n\t\t\tgrpc.StreamInterceptor(func(srv interface{}, stream grpc.ServerStream, info *grpc.StreamServerInfo, handler grpc.StreamHandler) error {\n\t\t\t\tif err := authorize(stream.Context()); err != nil {\n\t\t\t\t\treturn err\n\t\t\t\t}\n\t\t\t\treturn handler(srv, stream)\n\t\t\t}),\n\t\t\tgrpc.KeepaliveParams(keepalive.ServerParameters{Time: time.Second * 10}),\n\t\t)\n\t\tpb.RegisterPluginServer(grpcServer, &pluginServer{})\n\t\tLog.Printf(\"[gRPC] Plugin server started on port %d\\n\", Integrations.RPC.Port)\n\t\tif err = grpcServer.Serve(lis); err != nil {\n\t\t\tLog.Println(\"[gRPC] Failed to serve:\", err)\n\t\t}\n\t}()\n}\n\nfunc runPluginCMDs(u *User, currCmd string, args string) (found bool) {\n\tif pluginCmd, ok := PluginCMDs[currCmd]; ok {\n\t\tpluginCmd.invocationChan <- &pb.CmdInvocation{\n\t\t\tRoom: u.room.name,\n\t\t\tFrom: stripansi.Strip(u.Name),\n\t\t\tArgs: args,\n\t\t}\n\t\treturn true\n\t}\n\treturn false\n}\n\n// Hook that is called when a user sends a message (not private DMs)\nfunc sendMessageToPlugins(line string, u *User) {\n\tif len(ListenersNonMiddleware) > 0 {\n\t\tfor _, l := range ListenersNonMiddleware {\n\t\t\tl <- &pb.Event{\n\t\t\t\tRoom: u.room.name,\n\t\t\t\tFrom: stripansi.Strip(u.Name),\n\t\t\t\tMsg:  line,\n\t\t\t}\n\t\t}\n\t}\n}\n\nvar middlewareLock = new(sync.Mutex)\n\nfunc getMiddlewareResult(u *User, line string) string {\n\tif Integrations.RPC == nil {\n\t\treturn line\n\t}\n\n\tmiddlewareLock.Lock()\n\tdefer middlewareLock.Unlock()\n\t// Middleware hook\n\tfor i := 0; i < len(ListenersMiddleware); i++ {\n\t\tListenersMiddleware[i] <- &pb.Event{\n\t\t\tRoom: u.room.name,\n\t\t\tFrom: stripansi.Strip(u.Name),\n\t\t\tMsg:  line,\n\t\t}\n\t\tif res := (<-ListenersMiddleware[i]).(*pb.ListenerClientData_Response).Response.Msg; res != nil {\n\t\t\tline = *res\n\t\t}\n\t}\n\treturn line\n}\n\nfunc pluginsCMD(_ string, u *User) {\n\tplugins := make([]CMD, 0, len(PluginCMDs))\n\tfor n, c := range PluginCMDs {\n\t\tplugins = append(plugins, CMD{\n\t\t\tname:     n,\n\t\t\tinfo:     c.info,\n\t\t\targsInfo: c.argsInfo,\n\t\t})\n\t}\n\tautogenerated := autogenCommands(plugins)\n\tif autogenerated == \"\" {\n\t\tautogenerated = \"   (no plugin commands are loaded)\"\n\t}\n\tu.room.broadcast(\"\", \"Plugin commands  \\n\"+autogenerated)\n}\n\nfunc initTokens() {\n\tf, err := os.Open(Config.DataDir + string(os.PathSeparator) + \"tokens.json\")\n\tif err != nil {\n\t\tif !os.IsNotExist(err) {\n\t\t\tLog.Println(\"Error reading tokens file:\", err)\n\t\t}\n\t\treturn\n\t}\n\tdefer f.Close()\n\tj, err := io.ReadAll(f)\n\tif err != nil {\n\t\tLog.Println(\"Error reading tokens file:\", err)\n\t\treturn\n\t}\n\n\terr = json.Unmarshal(j, &Tokens)\n\tif err != nil {\n\t\tvar s []struct { // old format\n\t\t\tToken string `json:\"token\"`\n\t\t\tData  string `json:\"data\"`\n\t\t}\n\t\terr = json.Unmarshal(j, &s)\n\t\tif err != nil {\n\t\t\tLog.Println(\"Error decoding tokens file:\", err)\n\t\t\treturn\n\t\t}\n\t\tLog.Println(\"Changing token file format\")\n\t\tfor i := range s {\n\t\t\tTokens[s[i].Token] = s[i].Data\n\t\t}\n\t\tf.Close()\n\t\tsaveTokens()\n\t}\n}\n\nfunc saveTokens() {\n\tf, err := os.Create(Config.DataDir + string(os.PathSeparator) + \"tokens.json\")\n\tif err != nil {\n\t\tLog.Println(err)\n\t}\n\tdefer f.Close()\n\tdata, err := json.Marshal(Tokens)\n\tif err != nil {\n\t\tLog.Println(\"Error encoding tokens file:\", err)\n\t}\n\t_, err = f.Write(data)\n\tif err != nil {\n\t\tLog.Println(\"Error writing tokens file:\", err)\n\t}\n}\n\nfunc lsTokensCMD(_ string, u *User) {\n\tif !auth(u) {\n\t\tu.room.broadcast(Devbot, \"Not authorized\")\n\t\treturn\n\t}\n\n\tif len(Tokens) == 0 {\n\t\tu.room.broadcast(Devbot, \"No tokens found.\")\n\t\treturn\n\t}\n\tmsg := \"Tokens:  \\n\"\n\tfmtString := \"%\" + fmt.Sprint(len(fmt.Sprint(len(Tokens)))) + \"d\"\n\ti := 1\n\tfor t := range Tokens {\n\t\tmsg += Cyan.Cyan(fmt.Sprintf(fmtString, i)) + \". \" + shasum(t) + \"\\t\" + Tokens[t] + \"  \\n\"\n\t\ti++\n\t}\n\tu.writeln(Devbot, msg)\n}\n\nfunc revokeTokenCMD(rest string, u *User) {\n\tif !auth(u) {\n\t\tu.room.broadcast(Devbot, \"Not authorized\")\n\t\treturn\n\t}\n\n\tif len(rest) == 0 {\n\t\tu.room.broadcast(Devbot, \"Please provide a sha256 hash of a token to revoke.\")\n\t\treturn\n\t}\n\tfor token := range Tokens {\n\t\tif shasum(token) == rest {\n\t\t\tdelete(Tokens, token)\n\t\t\tsaveTokens()\n\t\t\tu.room.broadcast(Devbot, \"Token revoked!\")\n\t\t\treturn\n\t\t}\n\t}\n\tu.room.broadcast(Devbot, \"Token not found.\")\n}\n\nfunc grantTokenCMD(rest string, u *User) {\n\tif !auth(u) {\n\t\tu.room.broadcast(Devbot, \"Not authorized\")\n\t\treturn\n\t}\n\n\ttoken, err := generateToken()\n\tif err != nil {\n\t\tu.room.broadcast(Devbot, \"Error generating token: \"+err.Error())\n\t\tLog.Println(err)\n\t\treturn\n\t}\n\n\tsplit := strings.Fields(rest)\n\tif len(split) > 0 && len(split[0]) > 0 && split[0][0] == '@' {\n\t\ttoUser, ok := findUserByName(u.room, split[0][1:])\n\t\tif ok {\n\t\t\ttoUser.writeln(Devbot, \"You have been granted a token: \"+token)\n\t\t} else {\n\t\t\tu.room.broadcast(Devbot, \"Who's that?\")\n\t\t\treturn\n\t\t}\n\t}\n\tTokens[token] = rest\n\tu.writeln(Devbot, \"Granted token: \"+token)\n\tsaveTokens()\n}\n\nfunc generateToken() (string, error) {\n\tb := make([]byte, 32)\n\t_, err := rand.Read(b)\n\tif err != nil {\n\t\treturn \"\", err\n\t}\n\ttoken := \"dvz@\" + base64.StdEncoding.EncodeToString(b)\n\t// check if it's already in use\n\tif _, ok := Tokens[token]; ok {\n\t\treturn generateToken()\n\t}\n\treturn token, nil\n}\n"
        },
        {
          "name": "slack.go",
          "type": "blob",
          "size": 2.0224609375,
          "content": "package main\n\nimport (\n\t\"crypto/sha1\"\n\t\"encoding/hex\"\n\t\"os\"\n\t\"strconv\"\n\t\"strings\"\n\n\t\"github.com/acarl005/stripansi\"\n\t\"github.com/quackduck/term\"\n\t\"github.com/slack-go/slack\"\n)\n\nvar (\n\tSlackChan  chan string\n\tSlackAPI   *slack.Client\n\tSlackRTM   *slack.RTM\n\tSlackBotID string\n)\n\nfunc getMsgsFromSlack() {\n\tif Integrations.Slack == nil {\n\t\treturn\n\t}\n\n\tgo SlackRTM.ManageConnection()\n\n\tuslack := new(User)\n\tuslack.isBridge = true\n\tdevnull, _ := os.OpenFile(os.DevNull, os.O_RDWR, 0)\n\tuslack.term = term.NewTerminal(devnull, \"\")\n\tuslack.room = MainRoom\n\tfor msg := range SlackRTM.IncomingEvents {\n\t\tswitch ev := msg.Data.(type) {\n\t\tcase *slack.MessageEvent:\n\t\t\tmsg := ev.Msg\n\t\t\ttext := strings.TrimSpace(msg.Text)\n\t\t\tif msg.SubType != \"\" {\n\t\t\t\tbreak // We're only handling normal messages.\n\t\t\t}\n\t\t\tu, _ := SlackAPI.GetUserInfo(msg.User)\n\t\t\tif u == nil || u.ID == SlackBotID {\n\t\t\t\tbreak\n\t\t\t}\n\t\t\th := sha1.Sum([]byte(u.ID))\n\t\t\ti, _ := strconv.ParseInt(hex.EncodeToString(h[:2]), 16, 0) // two bytes as an int\n\t\t\tname := strings.Fields(u.RealName)[0]\n\t\t\tuslack.Name = Yellow.Paint(Integrations.Slack.Prefix+\" \") + (Styles[int(i)%len(Styles)]).apply(name)\n\t\t\tif Integrations.Discord != nil {\n\t\t\t\tDiscordChan <- DiscordMsg{\n\t\t\t\t\tsenderName: Integrations.Slack.Prefix + \" \" + name,\n\t\t\t\t\tmsg:        text,\n\t\t\t\t\tchannel:    uslack.room.name,\n\t\t\t\t} // send this discord message to slack\n\t\t\t}\n\t\t\trunCommands(text, uslack)\n\t\tcase *slack.ConnectedEvent:\n\t\t\tSlackBotID = ev.Info.User.ID\n\t\t\tLog.Println(\"Connected to Slack with bot ID\", SlackBotID, \"as\", ev.Info.User.Name)\n\t\tcase *slack.InvalidAuthEvent:\n\t\t\tLog.Println(\"Invalid Slack authentication\")\n\t\t\treturn\n\t\t}\n\t}\n}\n\nfunc slackInit() { // called by init() in config.go\n\tif Integrations.Slack == nil {\n\t\treturn\n\t}\n\n\tSlackAPI = slack.New(Integrations.Slack.Token)\n\tSlackRTM = SlackAPI.NewRTM()\n\tSlackChan = make(chan string, 100)\n\tgo func() {\n\t\tfor msg := range SlackChan {\n\t\t\tmsg = strings.ReplaceAll(stripansi.Strip(msg), `\\n`, \"\\n\")\n\t\t\tSlackRTM.SendMessage(SlackRTM.NewOutgoingMessage(msg, Integrations.Slack.ChannelID))\n\t\t}\n\t}()\n}\n"
        },
        {
          "name": "twitter.go",
          "type": "blob",
          "size": 2.0517578125,
          "content": "package main\n\nimport (\n\t\"fmt\"\n\t\"strings\"\n\t\"time\"\n\n\t\"github.com/acarl005/stripansi\"\n\t\"github.com/dghubble/go-twitter/twitter\" //nolint:staticcheck // library deprecated\n\t\"github.com/dghubble/oauth1\"\n)\n\nvar (\n\tStartupTime = time.Now()\n\tClient      *twitter.Client\n\tAllowTweet  = true\n)\n\nfunc sendCurrentUsersTwitterMessage() {\n\tif Integrations.Twitter == nil {\n\t\treturn\n\t}\n\t// TODO: count all users in all rooms\n\tif len(MainRoom.users) == 0 {\n\t\treturn\n\t}\n\tif !AllowTweet {\n\t\treturn\n\t}\n\tAllowTweet = false\n\tusersSnapshot := append(make([]*User, 0, len(MainRoom.users)), MainRoom.users...)\n\tareUsersEqual := func(a []*User, b []*User) bool {\n\t\tif len(a) != len(b) {\n\t\t\treturn false\n\t\t}\n\t\tfor i := range a {\n\t\t\tif b[i] != a[i] {\n\t\t\t\treturn false\n\t\t\t}\n\t\t}\n\t\treturn true\n\t}\n\tgo func() {\n\t\ttime.Sleep(time.Second * 60)\n\t\tAllowTweet = true\n\t\tif !areUsersEqual(MainRoom.users, usersSnapshot) {\n\t\t\treturn\n\t\t}\n\t\tLog.Println(\"Sending twitter update\")\n\t\tnames := make([]string, 0, len(MainRoom.users))\n\t\tfor _, us := range MainRoom.users {\n\t\t\tnames = append(names, us.Name)\n\t\t}\n\t\tt, _, err := Client.Statuses.Update(\"People on Devzat rn: \"+stripansi.Strip(fmt.Sprint(names))+\"\\nJoin em with \\\"ssh devzat.hackclub.com\\\"\\nUptime: \"+printPrettyDuration(time.Since(StartupTime)), nil)\n\t\tif err != nil {\n\t\t\tif !strings.Contains(err.Error(), \"twitter: 187 Status is a duplicate.\") {\n\t\t\t\tLog.Println(\"Twitter error:\", err)\n\t\t\t}\n\t\t\tLog.Println(\"Got twitter err\", err)\n\t\t\treturn\n\t\t}\n\t\tMainRoom.broadcast(Devbot, \"https\\\\://twitter.com/\"+t.User.ScreenName+\"/status/\"+t.IDStr)\n\t}()\n}\n\nfunc twitterInit() { // called by init() in config.go\n\tif Integrations.Twitter == nil {\n\t\treturn\n\t}\n\n\tconfig := oauth1.NewConfig(Integrations.Twitter.ConsumerKey, Integrations.Twitter.ConsumerSecret)\n\ttoken := oauth1.NewToken(Integrations.Twitter.AccessToken, Integrations.Twitter.AccessTokenSecret)\n\thttpClient := config.Client(oauth1.NoContext, token)\n\tClient = twitter.NewClient(httpClient)\n\t_, _, err := Client.Accounts.VerifyCredentials(nil)\n\tif err != nil {\n\t\tLog.Println(\"Twitter auth failed:\", err)\n\t\tIntegrations.Twitter = nil\n\t}\n}\n"
        },
        {
          "name": "util.go",
          "type": "blob",
          "size": 15.560546875,
          "content": "package main\n\nimport (\n\t\"bytes\"\n\t\"crypto/ed25519\"\n\t\"crypto/sha256\"\n\t_ \"embed\"\n\t\"encoding/hex\"\n\t\"encoding/json\"\n\t\"encoding/pem\"\n\t\"fmt\"\n\t\"image\"\n\t\"io\"\n\t\"math\"\n\t\"math/rand\"\n\t\"net/http\"\n\t\"os\"\n\t\"runtime/debug\"\n\t\"strings\"\n\t\"text/tabwriter\"\n\t\"time\"\n\n\t\"github.com/acarl005/stripansi\"\n\t\"github.com/caarlos0/sshmarshal\"\n\t\"github.com/charmbracelet/glamour\"\n\t\"github.com/charmbracelet/glamour/ansi\"\n\t\"github.com/disintegration/imaging\"\n\t//\"github.com/eliukblau/pixterm/pkg/ansimage\"\n\t\"github.com/fatih/color\"\n\t\"github.com/gliderlabs/ssh\"\n\t//markdown \"github.com/quackduck/go-term-markdown\"\n\tcryptoSSH \"golang.org/x/crypto/ssh\"\n)\n\nvar (\n\tArt  = getASCIIArt()\n\tCMDs []*[]CMD // slice of pointers to slices of commands (this is so updates to sub-slices are reflected in the main slice even if append is used)\n)\n\nfunc init() {\n\tCMDs = []*[]CMD{&MainCMDs, &RestCMDs, &SecretCMDs}\n}\n\nfunc getCMD(name string) (CMD, bool) {\n\tfor _, cmds := range CMDs {\n\t\tif cmds == nil {\n\t\t\tLog.Println(\"nil slice in CMDs\") // should never happen\n\t\t\tcontinue\n\t\t}\n\t\tfor _, cmd := range *cmds {\n\t\t\tif cmd.name == name {\n\t\t\t\treturn cmd, true\n\t\t\t}\n\t\t}\n\t}\n\treturn CMD{}, false\n}\n\nfunc getASCIIArt() string {\n\tsep := string(os.PathSeparator)\n\tb, _ := os.ReadFile(Config.DataDir + sep + \"art.txt\")\n\tif b == nil {\n\t\treturn \"sorry, no art was found, please slap your developer and tell em to add a \" + Config.DataDir + sep + \"art.txt file\"\n\t}\n\treturn string(b)\n}\n\nfunc printUsersInRoom(r *Room) string {\n\tnames := \"\"\n\tadmins := \"\"\n\tfor _, us := range r.users {\n\t\tif auth(us) {\n\t\t\tadmins += us.Name + \" \"\n\t\t\tcontinue\n\t\t}\n\t\tnames += us.Name + \" \"\n\t}\n\tif len(names) > 0 {\n\t\tnames = names[:len(names)-1] // cut extra space at the end\n\t}\n\tnames = \"[\" + names + \"]\"\n\tif len(admins) > 0 {\n\t\tadmins = admins[:len(admins)-1]\n\t}\n\tadmins = \"[\" + admins + \"]\"\n\treturn names + \" Admins: \" + admins\n}\n\nfunc lenString(a string) int {\n\treturn len([]rune(stripansi.Strip(a)))\n}\n\nfunc autogenCommands(cmds []CMD) string {\n\tb := new(bytes.Buffer)\n\tw := tabwriter.NewWriter(b, 0, 0, 2, ' ', 0)\n\tfor _, cmd := range cmds {\n\t\tw.Write([]byte(\"   \" + Chalk.Bold(cmd.name) + \"\\t\" + cmd.argsInfo + \"\\t_\" + cmd.info + \"_  \\n\")) //nolint:errcheck // bytes.Buffer is never going to err out\n\t}\n\tw.Flush()\n\treturn b.String()\n}\n\n// check if a User is an admin\nfunc auth(u *User) bool {\n\t_, ok := Config.Admins[u.id]\n\treturn ok\n}\n\nfunc keepSessionAlive(s ssh.Session) {\n\tfor {\n\t\ttime.Sleep(time.Minute * 3)\n\t\t_, err := s.SendRequest(\"keepalive@devzat\", true, nil)\n\t\tif err != nil {\n\t\t\treturn\n\t\t}\n\t}\n}\n\nfunc protectFromPanic() {\n\tif i := recover(); i != nil {\n\t\tMainRoom.broadcast(Devbot, \"Slap the developers in the face for me, the server almost crashed, also tell them this: \"+fmt.Sprint(i)+\", stack: \"+string(debug.Stack()))\n\t}\n}\n\n// removes arrows, spaces and non-ascii-printable characters\nfunc cleanName(name string) string {\n\ts := \"\"\n\tname = strings.ReplaceAll(strings.TrimSpace(strings.Split(name, \"\\n\")[0]), // use one trimmed line\n\t\t\" \", \"-\")\n\tif len([]rune(name)) > 27 {\n\t\tname = string([]rune(name)[:27])\n\t}\n\tfor i := 0; i < len(name); i++ {\n\t\tif 33 <= name[i] && name[i] <= 126 { // ascii printables only: '!' to '~'\n\t\t\ts += string(name[i])\n\t\t}\n\t}\n\treturn s\n}\n\nfunc mdRender(a string, beforeMessageLen int, lineWidth int, imageCache map[string]image.Image) string {\n\tglamourStyle := glamour.DarkStyleConfig\n\tglamourStyle.Document.Color = nil\n\tglamourStyle.Document.Margin = nil\n\tglamourStyle.Image = ansi.StylePrimitive{Format: \"\\n<img>{{.text}}</img>\\n\"}\n\tglamourStyle.ImageText.Format = \"Image: {{.text}}\"\n\tglamourStyle.Table.StyleBlock.StylePrimitive.Prefix = \"\\x1b[0m\" // ansi reset: hack to stop space in front of table from being erased\n\tr, _ := glamour.NewTermRenderer(glamour.WithEmoji(), glamour.WithStyles(glamourStyle), glamour.WithWordWrap(lineWidth-beforeMessageLen), glamour.WithPreservedNewLines())\n\tmd, err := r.Render(a)\n\tif err != nil {\n\t\tMainRoom.broadcast(Devbot, err.Error())\n\t\treturn \"\"\n\t}\n\tmd = addLeftPad(strings.TrimSuffix(replaceImgs(md, lineWidth, imageCache), \"\\n\"), beforeMessageLen)\n\treturn md\n}\n\nfunc replaceImgs(md string, width int, cache map[string]image.Image) string {\n\tif !strings.Contains(md, \"<img>\") {\n\t\treturn md\n\t}\n\tstart := strings.Index(md, \"<img>\")\n\tend := strings.Index(md, \"</img>\")\n\tif end == -1 {\n\t\treturn md\n\t}\n\timgStart := start + 5\n\timgEnd := end\n\timgText := md[imgStart:imgEnd]\n\timgText = strings.ReplaceAll(strings.ReplaceAll(strings.TrimSpace(imgText), \"\\n\", \"\"), \" \", \"\")\n\n\tif img, ok := cache[imgText]; ok {\n\t\timgText = imgRender(img, width/2)\n\t\treturn replaceImgs(md[:start]+imgText+md[end+6:], width, cache)\n\t}\n\n\tclient := http.Client{Timeout: 5 * time.Second}\n\tres, err := client.Get(imgText)\n\tif err != nil {\n\t\treturn replaceImgs(md[:start]+imgText+\" (error fetching image)\"+md[end+6:], width, cache)\n\t}\n\tif res.StatusCode != http.StatusOK {\n\t\treturn replaceImgs(md[:start]+imgText+\"(error: http: \"+http.StatusText(res.StatusCode)+\")\"+md[end+6:], width, cache)\n\t}\n\tlimitReader := io.LimitReader(res.Body, 30*1024*1024) // 30 megabyte limit\n\t// https://github.com/golang/go/issues/12512#issuecomment-137981217\n\theader := new(bytes.Buffer)\n\tconfig, _, err := image.DecodeConfig(io.TeeReader(limitReader, header))\n\tif err != nil || config.Width > 4032*2 || config.Height > 3024*2 {\n\t\treturn replaceImgs(md[:start]+imgText+\" (invalid or too large to render)\"+md[end+6:], width, cache)\n\t}\n\timg, _, err := image.Decode(io.MultiReader(header, limitReader))\n\tif err != nil {\n\t\treturn replaceImgs(md[:start]+imgText+\" (error decoding image)\"+md[end+6:], width, cache)\n\t}\n\tif cache != nil {\n\t\tcache[imgText] = img\n\t}\n\timgText = imgRender(img, width/2)\n\n\treturn replaceImgs(md[:start]+imgText+md[end+6:], width, cache)\n}\n\nfunc imgRender(img image.Image, width int) string {\n\tvar builder strings.Builder\n\timg = imaging.Fit(img, width, math.MaxInt32, imaging.Lanczos)\n\tfor y := 0; y < img.Bounds().Dy(); y += 2 {\n\t\tfor x := 0; x < img.Bounds().Dx(); x++ {\n\t\t\tr1, g1, b1, _ := img.At(x, y).RGBA()\n\t\t\tr2, g2, b2, _ := img.At(x, y+1).RGBA()\n\t\t\tbuilder.WriteString(fmt.Sprintf(\"\\x1b[38;2;%d;%d;%dm\\x1b[48;2;%d;%d;%dmâ–€\", r1/256, g1/256, b1/256, r2/256, g2/256, b2/256))\n\t\t}\n\t\tbuilder.WriteString(\"\\x1b[0m\\n\")\n\t}\n\treturn builder.String()\n}\n\nfunc addLeftPad(a string, pad int) string {\n\tsplit := strings.Split(a, \"\\n\")\n\tfor i := 1; i < len(split); i++ { // skip first line\n\t\tsplit[i] = strings.Repeat(\" \", pad) + split[i]\n\t}\n\ta = strings.Join(split, \"\\n\")\n\treturn a\n}\n\n// Returns true and the User with the same name if the username is taken, false and nil otherwise\nfunc userDuplicate(r *Room, a string) (*User, bool) {\n\tfor i := range r.users {\n\t\tif stripansi.Strip(r.users[i].Name) == stripansi.Strip(a) {\n\t\t\treturn r.users[i], true\n\t\t}\n\t}\n\treturn nil, false\n}\n\nfunc saveBans() {\n\tf, err := os.Create(Config.DataDir + string(os.PathSeparator) + \"bans.json\")\n\tif err != nil {\n\t\tLog.Println(err)\n\t\treturn\n\t}\n\tdefer f.Close()\n\tj := json.NewEncoder(f)\n\tj.SetIndent(\"\", \"   \")\n\terr = j.Encode(Bans)\n\tif err != nil {\n\t\tMainRoom.broadcast(Devbot, \"error saving bans: \"+err.Error())\n\t\tLog.Println(err)\n\t\treturn\n\t}\n}\n\nfunc readBans() {\n\tf, err := os.Open(Config.DataDir + string(os.PathSeparator) + \"bans.json\")\n\tif err != nil {\n\t\tif !os.IsNotExist(err) {\n\t\t\tLog.Println(err)\n\t\t}\n\t\treturn\n\t}\n\tdefer f.Close()\n\terr = json.NewDecoder(f).Decode(&Bans)\n\tif err != nil {\n\t\tMainRoom.broadcast(Devbot, \"error reading bans: \"+err.Error())\n\t\tLog.Println(err)\n\t\treturn\n\t}\n}\n\nfunc findUserByName(r *Room, name string) (*User, bool) {\n\tr.usersMutex.RLock()\n\tdefer r.usersMutex.RUnlock()\n\tfor _, u := range r.users {\n\t\tif stripansi.Strip(u.Name) == name || \"@\"+stripansi.Strip(u.Name) == name {\n\t\t\treturn u, true\n\t\t}\n\t}\n\treturn nil, false\n}\n\nfunc remove(s []*User, a *User) []*User {\n\tfor j := range s {\n\t\tif s[j] == a { // https://github.com/golang/go/wiki/SliceTricks#delete\n\t\t\tcopy(s[j:], s[j+1:])\n\t\t\ts[len(s)-1] = nil\n\t\t\treturn s[:len(s)-1]\n\t\t}\n\t}\n\treturn s\n}\n\nfunc devbotChat(room *Room, line string) {\n\tif strings.Contains(line, \"devbot\") {\n\t\tif strings.HasPrefix(line, \"kick \") || strings.HasPrefix(line, \"ban \") { // devbot already replied in the command function\n\t\t\treturn\n\t\t}\n\t\tif strings.Contains(line, \"how are you\") || strings.Contains(line, \"how you\") {\n\t\t\tdevbotRespond(room, []string{\"How are _you_\",\n\t\t\t\t\"Good as always lol\",\n\t\t\t\t\"Ah the usual, solving quantum gravity :smile:\",\n\t\t\t\t\"Howdy?\",\n\t\t\t\t\"Thinking about intergalactic cows\",\n\t\t\t\t\"Could maths be different in other universes?\",\n\t\t\t\t\"\"}, 99)\n\t\t\treturn\n\t\t}\n\t\tif strings.Contains(line, \"thank\") {\n\t\t\tdevbotRespond(room, []string{\"you're welcome\",\n\t\t\t\t\"no problem\",\n\t\t\t\t\"yeah dw about it\",\n\t\t\t\t\":smile:\",\n\t\t\t\t\"no worries\",\n\t\t\t\t\"you're welcome man!\",\n\t\t\t\t\"lol\"}, 93)\n\t\t\treturn\n\t\t}\n\t\tif strings.Contains(line, \"good\") || strings.Contains(line, \"cool\") || strings.Contains(line, \"awesome\") || strings.Contains(line, \"amazing\") {\n\t\t\tdevbotRespond(room, []string{\"Thanks haha\", \":sunglasses:\", \":smile:\", \"lol\", \"haha\", \"Thanks lol\", \"yeeeeeeeee\"}, 93)\n\t\t\treturn\n\t\t}\n\t\tif strings.Contains(line, \"bad\") || strings.Contains(line, \"idiot\") || strings.Contains(line, \"stupid\") {\n\t\t\tdevbotRespond(room, []string{\"what an idiot, bullying a bot\", \":(\", \":angry:\", \":anger:\", \":cry:\", \"I'm in the middle of something okay\", \"shut up\", \"Run ./help, you need it.\"}, 60)\n\t\t\treturn\n\t\t}\n\t\tif strings.Contains(line, \"shut up\") {\n\t\t\tdevbotRespond(room, []string{\"NO YOU\", \"You shut up\", \"what an idiot, bullying a bot\"}, 90)\n\t\t\treturn\n\t\t}\n\t\tdevbotRespond(room, []string{\"Hi I'm devbot\", \"Hey\", \"HALLO :rocket:\", \"Yes?\", \"Devbot to the rescue!\", \":wave:\"}, 90)\n\t}\n\tif line == \"./help\" || line == \"/help\" || strings.Contains(line, \"help me\") {\n\t\tdevbotRespond(room, []string{\"Run help to get help!\",\n\t\t\t\"Looking for help?\",\n\t\t\t\"See available commands with cmds or see help with help :star:\"}, 100)\n\t}\n\tif line == \"easter\" {\n\t\tdevbotRespond(room, []string{\"eggs?\", \"bunny?\"}, 100)\n\t}\n\tif strings.Contains(line, \"rm -rf\") {\n\t\tdevbotRespond(room, []string{\"rm -rf you\", \"I've heard rm -rf / can really free up some space!\\n\\n you should try it on your computer\", \"evil\"}, 100)\n\t\treturn\n\t}\n\tif strings.Contains(line, \"where\") && strings.Contains(line, \"repo\") {\n\t\tdevbotRespond(room, []string{\"The repo's at github.com/quackduck/devzat!\", \":star: github.com/quackduck/devzat :star:\", \"# github.com/quackduck/devzat\"}, 100)\n\t}\n\tif strings.Contains(line, \"rocket\") || strings.Contains(line, \"spacex\") || strings.Contains(line, \"tesla\") {\n\t\tdevbotRespond(room, []string{\n\t\t\t\":rocket:\",\n\t\t\t\"I like rockets\",\n\t\t\t\"SpaceX\",\n\t\t\t\"Elon Musk sus\"}, 80)\n\t}\n\tif strings.Contains(line, \"elon\") {\n\t\tdevbotRespond(room, []string{\"When something is important enough, you do it even if the odds are not in your favor. - Elon\",\n\t\t\t\"I do think there is a lot of potential if you have a compelling product - Elon\",\n\t\t\t\"If you're trying to create a company, it's like baking a cake. You have to have all the ingredients in the right proportion. - Elon\",\n\t\t\t\"Patience is a virtue, and I'm learning patience. It's a tough lesson. - Elon\"}, 75)\n\t}\n\tif !strings.Contains(line, \"start\") && strings.Contains(line, \"star\") {\n\t\tdevbotRespond(room, []string{\"Someone say :star:?\",\n\t\t\t\"If you like Devzat, give it a star at github.com/quackduck/devzat!\",\n\t\t\t\":star: github.com/quackduck/devzat\", \":star:\"}, 90)\n\t}\n\tif strings.Contains(line, \"cool project\") || strings.Contains(line, \"this is cool\") || strings.Contains(line, \"this is so cool\") {\n\t\tdevbotRespond(room, []string{\"Thank you :slight_smile:!\",\n\t\t\t\" If you like Devzat, do give it a star at github.com/quackduck/devzat!\",\n\t\t\t\"Star Devzat here: github.com/quackduck/devzat\"}, 90)\n\t}\n}\n\nfunc devbotRespond(room *Room, messages []string, chance int) {\n\tif chance == 100 || chance > rand.Intn(100) {\n\t\tgo func() {\n\t\t\ttime.Sleep(time.Second / 2)\n\t\t\tpick := messages[rand.Intn(len(messages))]\n\t\t\troom.broadcast(Devbot, pick)\n\t\t}()\n\t}\n}\n\nfunc shasum(s string) string {\n\th := sha256.Sum256([]byte(s))\n\treturn hex.EncodeToString(h[:])\n}\n\nfunc holidaysCheck(u *User) {\n\tcurrentMonth := time.Now().Month()\n\ttoday := time.Now().Day()\n\n\ttype holiday struct {\n\t\tmonth time.Month\n\t\tday   int\n\t\tname  string\n\t\timage string\n\t}\n\n\tholidayList := []holiday{\n\t\t{time.February, 14, \"â¤ï¸ - Valentine's Day\", \"https://emojipedia-us.s3.dualstack.us-west-1.amazonaws.com/thumbs/240/apple/81/heavy-black-heart_2764.png\"},\n\t\t{time.March, 17, \"â˜˜ï¸ - St. Patrick's Day\", \"https://emojipedia-us.s3.dualstack.us-west-1.amazonaws.com/thumbs/240/apple/325/shamrock_2618-fe0f.png\"},\n\t\t{time.April, 22, \"ğŸŒ - Earth Day\", \"https://emojipedia-us.s3.dualstack.us-west-1.amazonaws.com/thumbs/240/apple/325/globe-showing-americas_1f30e.png\"},\n\t\t{time.May, 8, \"ğŸ‘© - Mother's Day\", \"https://emojipedia-us.s3.dualstack.us-west-1.amazonaws.com/thumbs/240/apple/325/woman_1f469.png\"},\n\t\t{time.June, 19, \"ğŸ‘¨ - Father's Day\", \"https://emojipedia-us.s3.dualstack.us-west-1.amazonaws.com/thumbs/240/apple/325/man_1f468.png\"},\n\t\t{time.September, 11, \"ğŸ‘´ - Grandparents' Day\", \"https://emojipedia-us.s3.dualstack.us-west-1.amazonaws.com/thumbs/240/apple/325/old-woman_1f475.png\"},\n\t\t{time.October, 31, \"ğŸƒ - Halloween\", \"https://emojipedia-us.s3.dualstack.us-west-1.amazonaws.com/thumbs/240/apple/325/jack-o-lantern_1f383.png\"},\n\t\t{time.December, 25, \"ğŸ… - Christmas\", \"https://emojipedia-us.s3.dualstack.us-west-1.amazonaws.com/thumbs/240/apple/325/santa-claus_1f385.png\"},\n\t\t{time.December, 31, \"ğŸ¾ - New Year's Eve\", \"https://emojipedia-us.s3.dualstack.us-west-1.amazonaws.com/thumbs/240/apple/325/bottle-with-popping-cork_1f37e.png\"},\n\t}\n\n\tfor _, h := range holidayList {\n\t\tif currentMonth == h.month && today == h.day {\n\t\t\tu.writeln(\"\", \"![\"+h.name+\"](\"+h.image+\")\")\n\t\t\ttime.Sleep(time.Second)\n\t\t\tclearCMD(\"\", u)\n\t\t\tbreak\n\t\t}\n\t}\n}\n\nfunc printPrettyDuration(d time.Duration) string {\n\ts := d.Round(time.Minute).String()\n\ts = s[:len(s)-2] // cut off \"0s\" at the end\n\tif s == \"\" {     // we cut off the seconds so if there's nothing in the string it means it was made of only seconds.\n\t\ts = \"< 1m\"\n\t}\n\treturn s\n}\n\nfunc fmtTime(u *User, lastStamp time.Time) string {\n\tif u.Timezone.Location == nil {\n\t\tdiff := lastStamp.Sub(u.joinTime)\n\t\tif diff < 0 {\n\t\t\treturn printPrettyDuration(-diff) + \" earlier\"\n\t\t}\n\t\treturn printPrettyDuration(diff) + \" in\"\n\t}\n\tif u.FormatTime24 {\n\t\treturn lastStamp.In(u.Timezone.Location).Format(\"15:04\")\n\t}\n\treturn lastStamp.In(u.Timezone.Location).Format(\"3:04\")\n}\n\n// Check if the private key is there and if it is not, try to create it.\nfunc checkKey(keyPath string) {\n\t_, err := os.Stat(keyPath)\n\tif err == nil {\n\t\t// Key exists, everything is fine and dandy.\n\t\treturn\n\t}\n\tif !os.IsNotExist(err) { // the error is not a not-exist error. i.e. the file exists but there's some other problem with it\n\t\tLog.Printf(\"Error while checking for SSH keys in [%v]: %v\\n\", keyPath, err)\n\t\treturn\n\t}\n\n\tLog.Printf(\"Generating new SSH server private key at %v\\n\", keyPath)\n\tprivkey, pubkey, err := genKey()\n\tif err != nil {\n\t\tLog.Printf(\"Error while generating keypair: %v\\n\", err)\n\t\treturn\n\t}\n\tprivkeyFile, err := os.Create(keyPath)\n\tif err != nil {\n\t\tLog.Printf(\"Error while creating a file for the private key: %v\\n\", err)\n\t\treturn\n\t}\n\tdefer privkeyFile.Close()\n\tblk, err := sshmarshal.MarshalPrivateKey(privkey, \"\")\n\tif err != nil {\n\t\tLog.Printf(\"Error while marshalling private key: %v\\n\", err)\n\t\treturn\n\t}\n\tif err := pem.Encode(privkeyFile, blk); err != nil {\n\t\tLog.Printf(\"Error while encoding private key: %v\\n\", err)\n\t\treturn\n\t}\n\tLog.Println(\"Keys successfully generated!\\nWhile the public key is not necessary for server operation, it may be useful to save it:\\n\" + color.YellowString(string(cryptoSSH.MarshalAuthorizedKey(pubkey))))\n}\n\nfunc genKey() (ed25519.PrivateKey, ssh.PublicKey, error) {\n\tpub, priv, err := ed25519.GenerateKey(nil)\n\tif err != nil {\n\t\treturn nil, nil, err\n\t}\n\tsshPubKey, err := cryptoSSH.NewPublicKey(pub)\n\tif err != nil {\n\t\treturn nil, nil, err\n\t}\n\treturn priv, sshPubKey, nil\n}\n"
        }
      ]
    }
  ]
}