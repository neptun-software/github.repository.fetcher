{
  "metadata": {
    "timestamp": 1736567033729,
    "page": 615,
    "hasNextPage": true,
    "endCursor": "Y3Vyc29yOjYyMA==",
    "completionStatus": "IN_PROGRESS"
  },
  "repositories": [
    {
      "nameWithOwner": "cortesi/modd",
      "stars": 2825,
      "defaultBranch": "master",
      "files": [
        {
          "name": ".gitignore",
          "type": "blob",
          "size": 0.02734375,
          "content": "tmp\n.DS_Store\n.idea\n.vscode\n"
        },
        {
          "name": ".travis.yml",
          "type": "blob",
          "size": 0.2431640625,
          "content": "language: go\n\nenv:\n    - GO111MODULE=on\n\ngo:\n    - 1.16\n\nos:\n    - linux\n    - osx\n    - windows\n\ninstall:\n    - go get -t -v ./...\n    - go install ./cmd/modd\n\nscript:\n    - go test -v -race ./...\n\nnotifications:\n    email:\n        - aldo@corte.si\n"
        },
        {
          "name": "CHANGELOG.md",
          "type": "blob",
          "size": 2.2080078125,
          "content": "# v0.8 - 21 January 2019\n\n* Improvements to display for restart backoff\n* Fix a race condition affecting daemon restart (Richard Musiol)\n* Dependency updates and build improvements\n\n\n# v0.7 - 26 July 2018\n\n* Modd now has a built-in shell interpreter, which is used to execute commands\n  by default. This means modd.conf files should now be fully portable.\n* Subprocess execution has been revamped. We now send signals to process groups\n  on all platforms, which fixes issues with runners that don't pass signals on\n  to children (notably `go run`).\n* Deprecate the `exec` shell variant. This is no longer needed now we have a\n  built-in shell.\n* Add support for PowerShell on all platforms.\n\n\n# v0.6 - 13 April 2018\n\n* Ensure that emitted relative paths start with \"./\"\n* Minor bugfixes and updates\n\n\n# v0.5 - 17 November 2017\n\n* Comprehensively reassess how we deal with paths and symlinks.\n* Add escaping for @ in commands.\n* Updates to docs and minor fixes\n\n\n# v0.4 - 28 September 2016\n\n* Add an \"indir\" block option to control the execution directory for a block.\n* Fix some formatting issues in notifications (thanks @stereosteve).\n\n\n# v0.3 - 8 April 2016\n\n* Modd no longer exits when there are script errors on first run. Instead,\nblocks with errors will be progressively started when there are applicable\nchanges.\n* +onchange option to prep commands tells modd skip execution on startup, and\nrun only when there's a detected change. (thanks Thomas B Homburg\n<thomas@homburg.dk>)\n* @shell magic variable to switch the shell used to execute commands. Current\noptions are \"bash\" and \"exec\". (thanks Daniel Theophanes\n<kardianos@gmail.com>)\n* Modd now uses an exponential backoff strategy for daemon restarts (Josh\nBleecher Snyder <josharian@gmail.com>)\n* Bugfix: Fix a format string issue that could cause some program output on the\nconsole to be corrupted. (thanks Yoav Alon <yoava333@gmail.com>)\n\n\n# v0.2 - 11 February 2016\n\n* Windows support - thanks to @mattn for getting the ball rolling\n* Fix a serious bug that prevented recursive watching on Linux\n* Show full, variable expanded commands in logs\n* Use slash-delimited paths throughout, even on Windows\n* Properly handle CRLF line endings in config files\n* Many, many small bugfixes and improvements\n"
        },
        {
          "name": "LICENSE",
          "type": "blob",
          "size": 1.0693359375,
          "content": "The MIT License (MIT)\n\nCopyright (c) 2015 Aldo Cortesi <aldo@corte.si>\n\nPermission is hereby granted, free of charge, to any person obtaining a copy\nof this software and associated documentation files (the \"Software\"), to deal\nin the Software without restriction, including without limitation the rights\nto use, copy, modify, merge, publish, distribute, sublicense, and/or sell\ncopies of the Software, and to permit persons to whom the Software is\nfurnished to do so, subject to the following conditions:\n\nThe above copyright notice and this permission notice shall be included in all\ncopies or substantial portions of the Software.\n\nTHE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\nIMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\nFITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\nAUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\nLIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\nOUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE\nSOFTWARE.\n"
        },
        {
          "name": "README.md",
          "type": "blob",
          "size": 15.1689453125,
          "content": "[![Travis Build Status](https://travis-ci.org/cortesi/modd.svg?branch=master)](https://travis-ci.org/cortesi/modd)\n\n\nModd is a developer tool that triggers commands and manages daemons in response\nto filesystem changes.\n\nIf you use modd, you should also look at\n[devd](https://github.com/cortesi/devd), a compact HTTP daemon for developers.\nDevd integrates with modd, allowing you to trigger in-browser livereload with\nmodd.\n\nThe repo contains a set of example *modd.conf* files that you can look at for a\nquick idea of what modd can do:\n\nExample                                      | Description\n-------------------------------------------- | -------\n[frontend.conf](./examples/frontend.conf)    | A front-end project with React + Browserify + Babel. Modd and devd replace many functions of Gulp/Grunt.\n[go.conf](./examples/go.conf)                | Live unit tests for Go.\n[python.conf](./examples/python.conf)        | Python + Redis, with devd managing livereload.\n\n\n\n# Install\n\nModd is a single binary with no external dependencies, released for OSX,\nWindows, Linux, FreeBSD, NetBSD and OpenBSD. Go to the [releases\npage](https://github.com/cortesi/modd/releases/latest), download the package for\nyour OS, and copy the binary to somewhere on your PATH.\n\nAlternatively, with Go 1.17+ installed, you can install `modd` directly using `go install`. Please note that CGO is required, so if you happen to have it disabled you will need to prepend the `CGO_ENABLED=1` environment variable.\n\n    $ go install github.com/cortesi/modd/cmd/modd@latest\n\n# Quick start\n\nPut this in a file called *modd.conf*:\n\n```\n**/*.go {\n    prep: go test @dirmods\n}\n```\n\nNow run modd like so:\n\n```\n$ modd\n```\n\nThe first time modd is run, it will run the tests of all Go modules. Whenever\nany file with the .go extension is modified, the \"go test\" command will be run\nonly on the enclosing module.\n\n\n# Details\n\nOn startup, modd looks for a file called *modd.conf* in the current directory.\nThis file has a simple but powerful syntax - one or more blocks of commands,\neach of which can be triggered on changes to files matching a set of file\npatterns. The *modd.conf* file is meant to be portable, and can safely be\nchecked into source repositories. Functionality that users will want to\ncustomize (like desktop notifications) is controlled through command-line\nflags.\n\nCommands have two flavors: **prep** commands that run and terminate (e.g.\ncompiling, running test suites or running linters), and **daemon** commands that\nrun and keep running (e.g databases or webservers). Daemons are sent a SIGHUP\n(by default) when their block is triggered, and are restarted if they ever exit.\n\nPrep commands are run in order of occurrence. If any prep command exits with an\nerror, execution of the current block is stopped immediately. If all prep\ncommands succeed, any daemons in the block are restarted, also in order of\noccurrence. If multiple blocks are triggered by the same set of changes, they\ntoo run in order, from top to bottom.\n\nHere's a modified version of the *modd.conf* file I use when hacking on devd.\nIt runs the test suite whenever a .go file changes, builds devd whenever a\nnon-test file is changed, and keeps a test instance running throughout.\n\n```\n**/*.go {\n    prep: go test @dirmods\n}\n\n# Exclude all test files of the form *_test.go\n**/*.go !**/*_test.go {\n    prep: go install ./cmd/devd\n    daemon +sigterm: devd -m ./tmp\n}\n```\n\nThe **@dirmods** variable expands to a properly escaped list of all directories\ncontaining changed files. When modd is first run, this includes all directories\ncontaining matching files. So, this means that modd will run all tests on\nstartup, and then subsequently run the tests only for the affected module\nwhenever there's a change. There's a corresponding **@mods** variable that\ncontains all changed files.\n\nNote the *+sigterm* flag to the daemon command. When devd receives a SIGHUP\n(the default signal sent by modd), it triggers a browser livereload, rather\nthan exiting. This is what you want when devd is being used to serve a web\nproject you're hacking on, but when developing devd _itself_, we actually want\nit to exit and restart to pick up changes. We therefore tell modd to send a\nSIGTERM to the daemon instead, which causes devd to exit and be restarted by\nmodd.\n\nBy default modd interprets commands using a [built-in POSIX-like\nshell](https://github.com/mvdan/sh). Some external shells are also supported,\nand can be used by setting `@shell` variable in your \"modd.conf\" file.\n\n\n# File watch patterns\n\nModd batches up changes until there is a lull in filesystem activity - this\nmeans that coherent processes like compilation and rendering that touch many\nfiles are likely to trigger commands only once. Patterns therefore match on a\nbatch of changed files - when the first match in a batch is seen, the block is\ntriggered.\n\nPatterns and the paths they match against are always in slash-delimited form,\neven on Windows. Paths are cleaned and normalised being matched, with redundant\ncomponents removed. If the path is within the current working directory, the\nnormalised path is relative to the current working directory, otherwise it is\nabsolute. One subtlety is that this means that a pattern like `./*.js` will\nnever match, because inbound paths will not have a leading `./` component - just\nuse `*.js` instead.\n\n\n## Quotes\n\nFile patterns can be naked or quoted strings. Quotes can be either single or\ndouble quotes, and the corresponding quote mark can be escaped with a backslash\nwithin the string:\n\n```\n\"**/foo\\\"bar\"\n```\n\n## Negation\n\nPatterns can be negated with a leading **!**. For quoted patterns, the\nexclamation mark goes outside of the quotes. So, this matches all files\nrecursively, bar those with a .html extension and those in the **docs**\ndirectory.\n\n```\n** !**/*.html !\"docs/**\"\n```\n\nNegations are applied after all positive patterns - that is, modd collects all\nfiles matching the positive patterns, then removes files matching the negation\npatterns.\n\n## Default ignore list\n\nCommon nuisance files like VCS directories, swap files, and so forth are\nignored by default. You can list the set of ignored patterns using the **-i**\nflag to the modd command. The default ignore patterns can be disabled using the\nspecial **+noignore** flag, like so:\n\n```\n.git/config +noignore {\n    prep: echo \"git config changed\"\n}\n```\n\n## Empty match pattern\n\nIf no match pattern is specified, prep commands run once only at startup, and\ndaemons are restarted if they exit, but won't ever be explicitly signalled to\nrestart by modd.\n\n```\n{\n    prep: echo hello\n}\n```\n\n## Symlinks\n\nModd does not implicitly traverse symlinks. To monitor a symlink, split the path\nspecification and the matching pattern, like this:\n\n```\nmydir/symlinkdir foo.* {\n    prep: echo changed\n}\n```\n\nBehind the scenes, we resolve the symlinked directory as if it was specified\ndirectly by the user. This means that if the symlink destination lies outside of\nthe current working directory, the resulting paths for matches, exclusions and\ncommands will be absolute.\n\n\n## Syntax\n\nFile patterns support the following syntax:\n\nTerm          | Meaning\n------------- | -------\n`*`           | any sequence of non-path-separators\n`**`          | any sequence of characters, including path separators\n`?`           | any single non-path-separator character\n`[class]`     | any single non-path-separator character against a class of characters\n`{alt1,...}`  | any of the comma-separated alternatives - to avoid conflict with the block specification, patterns with curly-braces should be enclosed in quotes\n\nAny character with a special meaning can be escaped with a backslash (`\\`).\nCharacter classes support the following:\n\nClass      | Meaning\n---------- | -------\n`[abc]`    | any character within the set\n`[a-z]`    | any character in the range\n`[^class]` | any character which does *not* match the class\n\n\n# Blocks\n\nEach file match pattern specification has an associated block, which is\nenclosed in curly brackets. Blocks contain commands and block-scoped options.\n\nSingle-line commands don't need to be quoted:\n\n```\nprep: echo \"I'm now rebuilding\" | tee /tmp/output\n```\n\nNewlines can be escaped with a backslash for multi-line commands:\n\n```\nprep: ls \\\n        -l \\\n        -a\n```\n\nYou can also enclose commands in single or double quotes, letting easily\nspecify compound, multi-statement commands. These can contain anything you'd\nnormally put in a shell script, and the same quoting and escaping conventions apply.\n\n```\nprep: \"\n    ls \\\n        -l \\\n        -a\n    echo \\\"hello again\\\"\n    echo \\\"hello yet again\\\"\n\"\n```\n\nWithin commands, the `@` character is treated specially, since it is the marker\nfor variable replacement. You can include a verbatim `@` symbol b escaping it\nwith a backslash, and backslashes preceding the `@` symbol can themselves be\nescaped recursively.\n\n```\n@foo = bar\n{\n    prep: echo \"@foo\"   # bar\n    prep: echo \"\\@foo\"  # @foo\n    prep: echo \"\\\\@foo\" # \\bar\n}\n```\n\n## Prep commands\n\nAll prep commands in a block are run in order before any daemons are restarted.\nIf any prep command exits with an error, execution stops.\n\nThe following variables are automatically generated for prep commands\n\nVariable      | Meaning\n------------- | -------\n@mods         | On first run, all files matching the block patterns. On subsequent change, a list of all modified files.\n@confdir      | The absolute path of the directory that contains the current modd config file.\n@dirmods      | On first run, all directories containing files matching the block patterns. On subsequent change, a list of all directories containing modified files.\n\nAll file names in variables are relative to the current directory, and\nshell-escaped for safety. All paths are in slash-delimited form on all\nplatforms.\n\nGiven a config file like this, modd will run *eslint* on all .js files when\nstarted, and then after that only run *eslint* on files if they change:\n\n```\n**/*.js {\n    prep: eslint @mods\n}\n```\n\nBy default, prep commands are executed on the initial run of modd. The\n`+onchange` option can be used to skip the initial run, and only execute when\nthere is a detected change.\n\n```\n*.go {\n\t# only trigger on file changes\n\tprep +onchange: go test\n}\n```\n\n\n## Daemon commands\n\nDaemons are executed on startup, and are restarted by modd whenever they exit.\nWhen a block containing a daemon command is triggered, modd sends a signal to\nthe daemon process group. If the signal causes the daemon to exit, it is\nimmediately restarted by modd - however, it's also common for daemons to do\nother useful things like reloading configuration in response to signals.\n\nThe default signal used is SIGHUP, but the signal can be controlled using\nmodifier flags, like so:\n\n```\ndaemon +sigterm: mydaemon --config ./foo.conf\n```\n\nThe following signals are supported: **sighup**, **sigterm**, **sigint**,\n**sigkill**, **sigquit**, **sigusr1**, **sigusr2**, **sigwinch**.\n\nSupport for signals on Windows is limited. The signal type is ignored, and all\ndaemons are stopped and restarted when a signal would normally be sent.\n\nThe following variables are automatically generated for prep commands\n\nVariable      | Meaning\n------------- | -------\n@confdir      | The absolute path of the directory that contains the current modd config file.\n\n\n## Controlling log headers\n\nModd outputs a short header on the terminal to show which command is responsible\nfor output. This header is calculated from the first non-whitespace line of the\ncommand - backslash escapes are removed from the end of the line, comment\ncharacters are removed from the beginning, and whitespace is stripped. Using the\nfact that the shell itself permits comments, you can completely control the log\ndisplay name.\n\n```\n{\n    # This will show as \"prep: mycommand\"\n    prep: \"\n        mycommand \\\n            --longoption 1 \\\n            --longoption 2\n    \"\n    # This will show as \"prep: daemon 1\"\n    prep: \"\n        # daemon 1\n        mycommand \\\n            --longoption 1 \\\n            --longoption 2\n    \"\n}\n```\n\n## Options\n\nThe only block option at the moment is **indir**, which controls the execution\ndirectory of a block. Modd will change to this directory before executing\ncommands and daemons, and change back to the previous directory afterwards.\n\nThe directory specification follows the same conventions as commands, and can\nbe enclosed in quotes to span multiple lines.\n\n```\n{\n    indir: ./my/directory\n    prep: ls\n}\n```\n\n\n# Variables\n\nVariables are declared as follows:\n\n```\n@variable = value\n```\n\nVariables can only be declared in the global scope (i.e. not inside blocks). All\nvalues are strings and follow the same semantics as commands - that is, they can\nhave escaped line endings, or be quoted strings. Variables are read once at\nstartup, and it is an error to re-declare a variable that already exists.\n\nYou can use variables in commands like so:\n\n```\n@dst = ./build/dst\n** {\n    prep: ls @dst\n}\n```\n\nThere is a special \"@shell\" variable that determines which shell is used to\nexecute commands. Valid values are `modd` (the default), `bash`, `sh` and\n`powershell`. This variable is set as follows:\n\n```\n@shell = bash\n```\n\nAvoid using the `@shell` variable if you can - using the built-in shell ensures\nthat `modd.conf` files remain portable across platforms.\n\n\n# Desktop Notifications\n\nWhen the **-n** flag is specified, modd sends anything sent to *stderr* from any\nprep command that exits abnormally to a desktop notifier. Since modd commands\nare shell scripts, you can redirect or manipulate output to entirely customise\nwhat gets sent to notifiers as needed.\n\nAt the moment, we support [Growl](http://growl.info/) on OSX, and\n[libnotify](https://launchpad.net/ubuntu/+source/libnotify) on Linux and other\nUnix systems.\n\n## Growl\n\nFor Growl to work, you will need Growl itself to be running, and have the\n**growlnotify** command installed. Growlnotify is an additional tool that you\ncan download from the official [Growl\nwebsite](http://growl.info/downloads.php).\n\n\n## Libnotify\n\nLibnotify is a general notification framework available on most Unix-like\nsystems. Modd uses the **notify-send** command to send notifications using\nlibnotify. You'll need to use your system package manager to install\n**libnotify**.\n\n\n# Colour output in process logs\n\nSome programs that have colourised output when run on the command-line don't\nemit colour when run under modd. Users might assume that modd is stripping the\ncolour from the command output, but that is not the case. Well-behaved terminal\nprograms check whether they are connected to a terminal, and if not, disable\ncolour codes in their own output. It is possible to trick a program into\nbelieving that a terminal is present through pseudo-terminal emulation, but this\nis complex and platform dependent and is not a good fit for a simple, reliable\ntool like modd.\n\nThis leaves users with two options:\n\n- Many tools that produce colour output also have a flag to force colour when no\n  terminal is detected, and many logging libraries with human-friendly output do\n  the same. The simplest solution is to work out how to force output and\n  explicitly specify this in your modd configuration.\n- There are platform-specific tools you can interpose between modd and the\n  subprocess to emulate a terminal. One example is\n  [unbuffer](https://linux.die.net/man/1/unbuffer) on Linux.\n\n\n# Development\n\nThe scripts used to build this package for distribution can be found\n[here](https://github.com/cortesi/godist).\n"
        },
        {
          "name": "cmd",
          "type": "tree",
          "content": null
        },
        {
          "name": "conf",
          "type": "tree",
          "content": null
        },
        {
          "name": "daemon.go",
          "type": "blob",
          "size": 4.1611328125,
          "content": "package modd\n\nimport (\n\t\"os\"\n\t\"os/exec\"\n\t\"sync\"\n\t\"time\"\n\n\t\"github.com/cortesi/modd/conf\"\n\t\"github.com/cortesi/modd/shell\"\n\t\"github.com/cortesi/modd/varcmd\"\n\t\"github.com/cortesi/termlog\"\n)\n\nconst (\n\t// MinRestart is the minimum amount of time between daemon restarts\n\tMinRestart = 500 * time.Millisecond\n\t// MulRestart is the exponential backoff multiplier applied when the daemon exits uncleanly\n\tMulRestart = 2\n\t// MaxRestart is the maximum amount of time between daemon restarts\n\tMaxRestart = 8 * time.Second\n)\n\n// A single daemon\ntype daemon struct {\n\tconf  conf.Daemon\n\tindir string\n\n\tex    *shell.Executor\n\tlog   termlog.Stream\n\tshell string\n\tstop  bool\n\tsync.Mutex\n}\n\nfunc (d *daemon) Run() {\n\tvar lastStart time.Time\n\tdelay := MinRestart\n\tfor d.stop != true {\n\t\tif delay > MinRestart {\n\t\t\td.log.Notice(\">> restart backoff... %dms\", delay/time.Millisecond)\n\t\t}\n\t\tif !lastStart.IsZero() {\n\t\t\ttime.Sleep(delay)\n\t\t}\n\t\td.log.Notice(\">> starting...\")\n\t\tlastStart = time.Now()\n\t\terr, pstate := d.ex.Run(d.log, false)\n\n\t\tif err != nil {\n\t\t\td.log.Shout(\"execution error: %s\", err)\n\t\t} else if pstate.Error != nil {\n\t\t\tif _, ok := pstate.Error.(*exec.ExitError); ok {\n\t\t\t\td.log.Warn(\"exited: %s\", pstate.ProcState)\n\t\t\t} else {\n\t\t\t\td.log.Shout(\"exited: %s\", err)\n\t\t\t}\n\t\t} else {\n\t\t\td.log.Warn(\"exited: %s\", pstate.ProcState)\n\t\t}\n\n\t\t// If we exited cleanly, or the process ran for > MaxRestart, we reset\n\t\t// the delay timer\n\t\tif time.Now().Sub(lastStart) > MaxRestart {\n\t\t\tdelay = MinRestart\n\t\t} else {\n\t\t\tdelay *= MulRestart\n\t\t\tif delay > MaxRestart {\n\t\t\t\tdelay = MaxRestart\n\t\t\t}\n\t\t}\n\t}\n}\n\n// Restart the daemon, or start it if it's not yet running\nfunc (d *daemon) Restart() {\n\td.Lock()\n\tdefer d.Unlock()\n\tif d.ex == nil {\n\t\tex, err := shell.NewExecutor(d.shell, d.conf.Command, d.indir)\n\t\tif err != nil {\n\t\t\td.log.Shout(\"Could not create executor: %s\", err)\n\t\t}\n\t\td.ex = ex\n\t\tgo d.Run()\n\t} else {\n\t\td.log.Notice(\">> sending signal %s\", d.conf.RestartSignal)\n\t\terr := d.ex.Signal(d.conf.RestartSignal)\n\t\tif err != nil {\n\t\t\td.log.Warn(\n\t\t\t\t\"failed to send %s signal to %s: %v\", d.conf.RestartSignal, d.conf.Command, err,\n\t\t\t)\n\t\t}\n\t}\n}\n\nfunc (d *daemon) Shutdown(sig os.Signal) error {\n\td.log.Notice(\">> stopping\")\n\td.stop = true\n\tif d.ex != nil {\n\t\treturn d.ex.Stop()\n\t}\n\treturn nil\n}\n\n// DaemonPen is a group of daemons in a single block, managed as a unit.\ntype DaemonPen struct {\n\tdaemons []*daemon\n\tsync.Mutex\n}\n\n// NewDaemonPen creates a new DaemonPen\nfunc NewDaemonPen(block conf.Block, vars map[string]string, log termlog.TermLog) (*DaemonPen, error) {\n\td := make([]*daemon, len(block.Daemons))\n\tfor i, dmn := range block.Daemons {\n\t\tvcmd := varcmd.VarCmd{Block: nil, Modified: nil, Vars: vars}\n\t\tfinalcmd, err := vcmd.Render(dmn.Command)\n\t\tif err != nil {\n\t\t\treturn nil, err\n\t\t}\n\t\tdmn.Command = finalcmd\n\t\tvar indir string\n\t\tif block.InDir != \"\" {\n\t\t\tindir = block.InDir\n\t\t} else {\n\t\t\tindir, err = os.Getwd()\n\t\t\tif err != nil {\n\t\t\t\treturn nil, err\n\t\t\t}\n\t\t}\n\t\tsh, err := shell.GetShellName(vars[shellVarName])\n\t\tif err != nil {\n\t\t\treturn nil, err\n\t\t}\n\n\t\td[i] = &daemon{\n\t\t\tconf:  dmn,\n\t\t\tlog:   log.Stream(niceHeader(\"daemon: \", dmn.Command)),\n\t\t\tshell: sh,\n\t\t\tindir: indir,\n\t\t}\n\t}\n\treturn &DaemonPen{daemons: d}, nil\n}\n\n// Restart all daemons in the pen, or start them if they're not running yet.\nfunc (dp *DaemonPen) Restart() {\n\tdp.Lock()\n\tdefer dp.Unlock()\n\tif dp.daemons != nil {\n\t\tfor _, d := range dp.daemons {\n\t\t\td.Restart()\n\t\t}\n\t}\n}\n\n// Shutdown all daemons in the pen\nfunc (dp *DaemonPen) Shutdown(sig os.Signal) {\n\tdp.Lock()\n\tdefer dp.Unlock()\n\tif dp.daemons != nil {\n\t\tfor _, d := range dp.daemons {\n\t\t\td.Shutdown(sig)\n\t\t}\n\t}\n}\n\n// DaemonWorld represents the entire world of daemons\ntype DaemonWorld struct {\n\tDaemonPens []*DaemonPen\n}\n\n// NewDaemonWorld creates a DaemonWorld\nfunc NewDaemonWorld(cnf *conf.Config, log termlog.TermLog) (*DaemonWorld, error) {\n\tdaemonPens := make([]*DaemonPen, len(cnf.Blocks))\n\tfor i, b := range cnf.Blocks {\n\t\td, err := NewDaemonPen(b, cnf.GetVariables(), log)\n\t\tif err != nil {\n\t\t\treturn nil, err\n\t\t}\n\t\tdaemonPens[i] = d\n\n\t}\n\treturn &DaemonWorld{daemonPens}, nil\n}\n\n// Shutdown all daemons with signal s\nfunc (dw *DaemonWorld) Shutdown(s os.Signal) {\n\tfor _, dp := range dw.DaemonPens {\n\t\tdp.Shutdown(s)\n\t}\n}\n"
        },
        {
          "name": "examples",
          "type": "tree",
          "content": null
        },
        {
          "name": "go.mod",
          "type": "blob",
          "size": 0.7197265625,
          "content": "module github.com/cortesi/modd\n\ngo 1.14\n\nrequire (\n\tgithub.com/alecthomas/template v0.0.0-20190718012654-fb15b899a751 // indirect\n\tgithub.com/alecthomas/units v0.0.0-20211218093645-b94a6e3cc137 // indirect\n\tgithub.com/cortesi/moddwatch v0.1.0\n\tgithub.com/cortesi/termlog v0.0.0-20210222042314-a1eec763abec\n\tgithub.com/fatih/color v1.13.0 // indirect\n\tgithub.com/google/go-cmp v0.5.9\n\tgithub.com/mattn/go-colorable v0.1.13 // indirect\n\tgithub.com/mattn/go-isatty v0.0.17 // indirect\n\tgithub.com/stretchr/testify v1.8.1 // indirect\n\tgolang.org/x/crypto v0.4.0 // indirect\n\tgolang.org/x/net v0.4.0 // indirect\n\tgopkg.in/alecthomas/kingpin.v2 v2.2.6\n\tgopkg.in/check.v1 v1.0.0-20201130134442-10cb98267c6c // indirect\n\tmvdan.cc/sh/v3 v3.6.0\n)\n"
        },
        {
          "name": "go.sum",
          "type": "blob",
          "size": 10.607421875,
          "content": "github.com/alecthomas/template v0.0.0-20190718012654-fb15b899a751 h1:JYp7IbQjafoB+tBA3gMyHYHrpOtNuDiK/uB5uXxq5wM=\ngithub.com/alecthomas/template v0.0.0-20190718012654-fb15b899a751/go.mod h1:LOuyumcjzFXgccqObfd/Ljyb9UuFJ6TxHnclSeseNhc=\ngithub.com/alecthomas/units v0.0.0-20211218093645-b94a6e3cc137 h1:s6gZFSlWYmbqAuRjVTiNNhvNRfY2Wxp9nhfyel4rklc=\ngithub.com/alecthomas/units v0.0.0-20211218093645-b94a6e3cc137/go.mod h1:OMCwj8VM1Kc9e19TLln2VL61YJF0x1XFtfdL4JdbSyE=\ngithub.com/bmatcuk/doublestar v1.3.4 h1:gPypJ5xD31uhX6Tf54sDPUOBXTqKH4c9aPY66CyQrS0=\ngithub.com/bmatcuk/doublestar v1.3.4/go.mod h1:wiQtGV+rzVYxB7WIlirSN++5HPtPlXEo9MEoZQC/PmE=\ngithub.com/cortesi/moddwatch v0.1.0 h1:+TSMuplhKlKEPKsdUXNHd67aCqew+et15dJvRCxMd1M=\ngithub.com/cortesi/moddwatch v0.1.0/go.mod h1:PFkhcmmwsRMQ76IMjKbaIIMcGQt7BSMtFOp+pA0B2eo=\ngithub.com/cortesi/termlog v0.0.0-20210222042314-a1eec763abec h1:v7D8uHsIKsyjfyhhNdY4qivqN558Ejiq+CDXiUljZ+4=\ngithub.com/cortesi/termlog v0.0.0-20210222042314-a1eec763abec/go.mod h1:10Fm2kasJmcKf1FSMQGSWb976sfR29hejNtfS9AydB4=\ngithub.com/creack/pty v1.1.9/go.mod h1:oKZEueFk5CKHvIhNR5MUki03XCEU+Q6VDXinZuGJ33E=\ngithub.com/creack/pty v1.1.18 h1:n56/Zwd5o6whRC5PMGretI4IdRLlmBXYNjScPaBgsbY=\ngithub.com/creack/pty v1.1.18/go.mod h1:MOBLtS5ELjhRRrroQr9kyvTxUAFNvYEK993ew/Vr4O4=\ngithub.com/davecgh/go-spew v1.1.0/go.mod h1:J7Y8YcW2NihsgmVo/mv3lAwl/skON4iLHjSsI+c5H38=\ngithub.com/davecgh/go-spew v1.1.1 h1:vj9j/u1bqnvCEfJOwUhtlOARqs3+rkHYY13jYWTU97c=\ngithub.com/davecgh/go-spew v1.1.1/go.mod h1:J7Y8YcW2NihsgmVo/mv3lAwl/skON4iLHjSsI+c5H38=\ngithub.com/fatih/color v1.10.0/go.mod h1:ELkj/draVOlAH/xkhN6mQ50Qd0MPOk5AAr3maGEBuJM=\ngithub.com/fatih/color v1.13.0 h1:8LOYc1KYPPmyKMuN8QV2DNRWNbLo6LZ0iLs8+mlH53w=\ngithub.com/fatih/color v1.13.0/go.mod h1:kLAiJbzzSOZDVNGyDpeOxJ47H46qBXwg5ILebYFFOfk=\ngithub.com/frankban/quicktest v1.14.4 h1:g2rn0vABPOOXmZUj+vbmUp0lPoXEMuhTpIluN0XL9UY=\ngithub.com/frankban/quicktest v1.14.4/go.mod h1:4ptaffx2x8+WTWXmUCuVU6aPUX1/Mz7zb5vbUoiM6w0=\ngithub.com/google/go-cmp v0.5.4/go.mod h1:v8dTdLbMG2kIc/vJvl+f65V22dbkXbowE6jgT/gNBxE=\ngithub.com/google/go-cmp v0.5.9 h1:O2Tfq5qg4qc4AmwVlvv0oLiVAGB7enBSJ2x2DqQFi38=\ngithub.com/google/go-cmp v0.5.9/go.mod h1:17dUlkBOakJ0+DkrSSNjCkIjxS6bF9zb3elmeNGIjoY=\ngithub.com/google/renameio/v2 v2.0.0/go.mod h1:BtmJXm5YlszgC+TD4HOEEUFgkJP3nLxehU6hfe7jRt4=\ngithub.com/kr/pretty v0.2.1/go.mod h1:ipq/a2n7PKx3OHsz4KJII5eveXtPO4qwEXGdVfWzfnI=\ngithub.com/kr/pretty v0.3.1 h1:flRD4NNwYAUpkphVc1HcthR4KEIFJ65n8Mw5qdRn3LE=\ngithub.com/kr/pretty v0.3.1/go.mod h1:hoEshYVHaxMs3cyo3Yncou5ZscifuDolrwPKZanG3xk=\ngithub.com/kr/pty v1.1.1/go.mod h1:pFQYn66WHrOpPYNljwOMqo10TkYh1fy3cYio2l3bCsQ=\ngithub.com/kr/text v0.1.0/go.mod h1:4Jbv+DJW3UT/LiOwJeYQe1efqtUx/iVham/4vfdArNI=\ngithub.com/kr/text v0.2.0 h1:5Nx0Ya0ZqY2ygV366QzturHI13Jq95ApcVaJBhpS+AY=\ngithub.com/kr/text v0.2.0/go.mod h1:eLer722TekiGuMkidMxC/pM04lWEeraHUUmBw8l2grE=\ngithub.com/mattn/go-colorable v0.1.8/go.mod h1:u6P/XSegPjTcexA+o6vUJrdnUu04hMope9wVRipJSqc=\ngithub.com/mattn/go-colorable v0.1.9/go.mod h1:u6P/XSegPjTcexA+o6vUJrdnUu04hMope9wVRipJSqc=\ngithub.com/mattn/go-colorable v0.1.13 h1:fFA4WZxdEF4tXPZVKMLwD8oUnCTTo08duU7wxecdEvA=\ngithub.com/mattn/go-colorable v0.1.13/go.mod h1:7S9/ev0klgBDR4GtXTXX8a3vIGJpMovkB8vQcUbaXHg=\ngithub.com/mattn/go-isatty v0.0.12/go.mod h1:cbi8OIDigv2wuxKPP5vlRcQ1OAZbq2CE4Kysco4FUpU=\ngithub.com/mattn/go-isatty v0.0.14/go.mod h1:7GGIvUiUoEMVVmxf/4nioHXj79iQHKdU27kJ6hsGG94=\ngithub.com/mattn/go-isatty v0.0.16/go.mod h1:kYGgaQfpe5nmfYZH+SKPsOc2e4SrIfOl2e/yFXSvRLM=\ngithub.com/mattn/go-isatty v0.0.17 h1:BTarxUcIeDqL27Mc+vyvdWYSL28zpIhv3RoTdsLMPng=\ngithub.com/mattn/go-isatty v0.0.17/go.mod h1:kYGgaQfpe5nmfYZH+SKPsOc2e4SrIfOl2e/yFXSvRLM=\ngithub.com/pkg/diff v0.0.0-20210226163009-20ebb0f2a09e/go.mod h1:pJLUxLENpZxwdsKMEsNbx1VGcRFpLqf3715MtcvvzbA=\ngithub.com/pmezard/go-difflib v1.0.0 h1:4DBwDE0NGyQoBHbLQYPwSUPoCMWR5BEzIk/f1lZbAQM=\ngithub.com/pmezard/go-difflib v1.0.0/go.mod h1:iKH77koFhYxTK1pcRnkKkqfTogsbg7gZNVY4sRDYZ/4=\ngithub.com/rjeczalik/notify v0.9.3 h1:6rJAzHTGKXGj76sbRgDiDcYj/HniypXmSJo1SWakZeY=\ngithub.com/rjeczalik/notify v0.9.3/go.mod h1:gF3zSOrafR9DQEWSE8TjfI9NkooDxbyT4UgRGKZA0lc=\ngithub.com/rogpeppe/go-internal v1.9.0 h1:73kH8U+JUqXU8lRuOHeVHaa/SZPifC7BkcraZVejAe8=\ngithub.com/rogpeppe/go-internal v1.9.0/go.mod h1:WtVeX8xhTBvf0smdhujwtBcq4Qrzq/fJaraNFVN+nFs=\ngithub.com/stretchr/objx v0.1.0/go.mod h1:HFkY916IF+rwdDfMAkV7OtwuqBVzrE8GR6GFx+wExME=\ngithub.com/stretchr/objx v0.4.0/go.mod h1:YvHI0jy2hoMjB+UWwv71VJQ9isScKT/TqJzVSSt89Yw=\ngithub.com/stretchr/objx v0.5.0/go.mod h1:Yh+to48EsGEfYuaHDzXPcE3xhTkx73EhmCGUpEOglKo=\ngithub.com/stretchr/testify v1.4.0/go.mod h1:j7eGeouHqKxXV5pUuKE4zz7dFj8WfuZ+81PSLYec5m4=\ngithub.com/stretchr/testify v1.7.1/go.mod h1:6Fq8oRcR53rry900zMqJjRRixrwX3KX962/h/Wwjteg=\ngithub.com/stretchr/testify v1.8.0/go.mod h1:yNjHg4UonilssWZ8iaSj1OCr/vHnekPRkoO+kdMU+MU=\ngithub.com/stretchr/testify v1.8.1 h1:w7B6lhMri9wdJUVmEZPGGhZzrYTPvgJArz7wNPgYKsk=\ngithub.com/stretchr/testify v1.8.1/go.mod h1:w2LPCIKwWwSfY2zedu0+kehJoqGctiVI29o6fzry7u4=\ngithub.com/yuin/goldmark v1.4.13/go.mod h1:6yULJ656Px+3vBD8DxQVa3kxgyrAnzto9xy5taEt/CY=\ngolang.org/x/crypto v0.0.0-20190308221718-c2843e01d9a2/go.mod h1:djNgcEr1/C05ACkg1iLfiJU5Ep61QUkGW8qpdssI0+w=\ngolang.org/x/crypto v0.0.0-20210220033148-5ea612d1eb83/go.mod h1:jdWPYTVW3xRLrWPugEBEK3UY2ZEsg3UU495nc5E+M+I=\ngolang.org/x/crypto v0.0.0-20210921155107-089bfa567519/go.mod h1:GvvjBRRGRdwPK5ydBHafDWAxML/pGHZbMvKqRZ5+Abc=\ngolang.org/x/crypto v0.4.0 h1:UVQgzMY87xqpKNgb+kDsll2Igd33HszWHFLmpaRMq/8=\ngolang.org/x/crypto v0.4.0/go.mod h1:3quD/ATkf6oY+rnes5c3ExXTbLc8mueNue5/DoinL80=\ngolang.org/x/mod v0.6.0-dev.0.20220419223038-86c51ed26bb4/go.mod h1:jJ57K6gSWd91VN4djpZkiMVwK6gcyfeH4XE8wZrZaV4=\ngolang.org/x/net v0.0.0-20190404232315-eb5bcb51f2a3/go.mod h1:t9HGtf8HONx5eT2rtn7q6eTqICYqUVnKs3thJo3Qplg=\ngolang.org/x/net v0.0.0-20190620200207-3b0461eec859/go.mod h1:z5CRVTTTmAJ677TzLLGU+0bjPO0LkuOLi4/5GtJWs/s=\ngolang.org/x/net v0.0.0-20210220033124-5f55cee0dc0d/go.mod h1:m0MpNAwzfU5UDzcl9v0D8zg8gWTRqZa9RBIspLL5mdg=\ngolang.org/x/net v0.0.0-20210226172049-e18ecbb05110/go.mod h1:m0MpNAwzfU5UDzcl9v0D8zg8gWTRqZa9RBIspLL5mdg=\ngolang.org/x/net v0.0.0-20220722155237-a158d28d115b/go.mod h1:XRhObCWvk6IyKnWLug+ECip1KBveYUHfp+8e9klMJ9c=\ngolang.org/x/net v0.3.0/go.mod h1:MBQ8lrhLObU/6UmLb4fmbmk5OcyYmqtbGd/9yIeKjEE=\ngolang.org/x/net v0.4.0 h1:Q5QPcMlvfxFTAPV0+07Xz/MpK9NTXu2VDUuy0FeMfaU=\ngolang.org/x/net v0.4.0/go.mod h1:MBQ8lrhLObU/6UmLb4fmbmk5OcyYmqtbGd/9yIeKjEE=\ngolang.org/x/sync v0.0.0-20190423024810-112230192c58/go.mod h1:RxMgew5VJxzue5/jJTE5uejpjVlOe/izrB70Jof72aM=\ngolang.org/x/sync v0.0.0-20220722155255-886fb9371eb4/go.mod h1:RxMgew5VJxzue5/jJTE5uejpjVlOe/izrB70Jof72aM=\ngolang.org/x/sync v0.1.0 h1:wsuoTGHzEhffawBOhz5CYhcrV4IdKZbEyZjBMuTp12o=\ngolang.org/x/sync v0.1.0/go.mod h1:RxMgew5VJxzue5/jJTE5uejpjVlOe/izrB70Jof72aM=\ngolang.org/x/sys v0.0.0-20180926160741-c2ed4eda69e7/go.mod h1:STP8DvDyc/dI5b8T5hshtkjS+E42TnysNCUPdjciGhY=\ngolang.org/x/sys v0.0.0-20190215142949-d0b11bdaac8a/go.mod h1:STP8DvDyc/dI5b8T5hshtkjS+E42TnysNCUPdjciGhY=\ngolang.org/x/sys v0.0.0-20191026070338-33540a1f6037/go.mod h1:h1NjWce9XRLGQEsW7wpKNCjG9DtNlClVuFLEZdDNbEs=\ngolang.org/x/sys v0.0.0-20200116001909-b77594299b42/go.mod h1:h1NjWce9XRLGQEsW7wpKNCjG9DtNlClVuFLEZdDNbEs=\ngolang.org/x/sys v0.0.0-20200223170610-d5e6a3e2c0ae/go.mod h1:h1NjWce9XRLGQEsW7wpKNCjG9DtNlClVuFLEZdDNbEs=\ngolang.org/x/sys v0.0.0-20201119102817-f84b799fce68/go.mod h1:h1NjWce9XRLGQEsW7wpKNCjG9DtNlClVuFLEZdDNbEs=\ngolang.org/x/sys v0.0.0-20210220050731-9a76102bfb43/go.mod h1:h1NjWce9XRLGQEsW7wpKNCjG9DtNlClVuFLEZdDNbEs=\ngolang.org/x/sys v0.0.0-20210615035016-665e8c7367d1/go.mod h1:oPkhp1MJrh7nUepCBck5+mAzfO9JrbApNNgaTdGDITg=\ngolang.org/x/sys v0.0.0-20210630005230-0f9fa26af87c/go.mod h1:oPkhp1MJrh7nUepCBck5+mAzfO9JrbApNNgaTdGDITg=\ngolang.org/x/sys v0.0.0-20220520151302-bc2c85ada10a/go.mod h1:oPkhp1MJrh7nUepCBck5+mAzfO9JrbApNNgaTdGDITg=\ngolang.org/x/sys v0.0.0-20220722155257-8c9f86f7a55f/go.mod h1:oPkhp1MJrh7nUepCBck5+mAzfO9JrbApNNgaTdGDITg=\ngolang.org/x/sys v0.0.0-20220811171246-fbc7d0a398ab/go.mod h1:oPkhp1MJrh7nUepCBck5+mAzfO9JrbApNNgaTdGDITg=\ngolang.org/x/sys v0.3.0/go.mod h1:oPkhp1MJrh7nUepCBck5+mAzfO9JrbApNNgaTdGDITg=\ngolang.org/x/sys v0.7.0 h1:3jlCCIQZPdOYu1h8BkNvLz8Kgwtae2cagcG/VamtZRU=\ngolang.org/x/sys v0.7.0/go.mod h1:oPkhp1MJrh7nUepCBck5+mAzfO9JrbApNNgaTdGDITg=\ngolang.org/x/term v0.0.0-20201117132131-f5c789dd3221/go.mod h1:Nr5EML6q2oocZ2LXRh80K7BxOlk5/8JxuGnuhpl+muw=\ngolang.org/x/term v0.0.0-20201126162022-7de9c90e9dd1/go.mod h1:bj7SfCRtBDWHUb9snDiAeCFNEtKQo2Wmx5Cou7ajbmo=\ngolang.org/x/term v0.0.0-20210220032956-6a3ed077a48d/go.mod h1:bj7SfCRtBDWHUb9snDiAeCFNEtKQo2Wmx5Cou7ajbmo=\ngolang.org/x/term v0.0.0-20210927222741-03fcf44c2211/go.mod h1:jbD1KX2456YbFQfuXm/mYQcufACuNUgVhRMnK/tPxf8=\ngolang.org/x/term v0.3.0 h1:qoo4akIqOcDME5bhc/NgxUdovd6BSS2uMsVjB56q1xI=\ngolang.org/x/term v0.3.0/go.mod h1:q750SLmJuPmVoN1blW3UFBPREJfb1KmY3vwxfr+nFDA=\ngolang.org/x/text v0.3.0/go.mod h1:NqM8EUOU14njkJ3fqMW+pc6Ldnwhi/IjpwHt7yyuwOQ=\ngolang.org/x/text v0.3.3/go.mod h1:5Zoc/QRtKVWzQhOtBMvqHzDpF6irO9z98xDceosuGiQ=\ngolang.org/x/text v0.3.7/go.mod h1:u+2+/6zg+i71rQMx5EYifcz6MCKuco9NR6JIITiCfzQ=\ngolang.org/x/text v0.5.0/go.mod h1:mrYo+phRRbMaCq/xk9113O4dZlRixOauAjOtrjsXDZ8=\ngolang.org/x/tools v0.0.0-20180917221912-90fa682c2a6e/go.mod h1:n7NCudcB/nEzxVGmLbDWY5pfWTLqBcC2KZ6jyYvM4mQ=\ngolang.org/x/tools v0.0.0-20191119224855-298f0cb1881e/go.mod h1:b+2E5dAYhXwXZwtnZ6UAqBI28+e2cm9otk0dWdXHAEo=\ngolang.org/x/tools v0.1.12/go.mod h1:hNGJHUnrk76NpqgfD5Aqm5Crs+Hm0VOH/i9J2+nxYbc=\ngolang.org/x/xerrors v0.0.0-20190717185122-a985d3407aa7/go.mod h1:I/5z698sn9Ka8TeJc9MKroUUfqBBauWjQqLJ2OPfmY0=\ngolang.org/x/xerrors v0.0.0-20191204190536-9bdfabe68543/go.mod h1:I/5z698sn9Ka8TeJc9MKroUUfqBBauWjQqLJ2OPfmY0=\ngopkg.in/alecthomas/kingpin.v2 v2.2.6 h1:jMFz6MfLP0/4fUyZle81rXUoxOBFi19VUFKVDOQfozc=\ngopkg.in/alecthomas/kingpin.v2 v2.2.6/go.mod h1:FMv+mEhP44yOT+4EoQTLFTRgOQ1FBLkstjWtayDeSgw=\ngopkg.in/check.v1 v0.0.0-20161208181325-20d25e280405/go.mod h1:Co6ibVJAznAaIkqp8huTwlJQCZ016jof/cbN4VW5Yz0=\ngopkg.in/check.v1 v1.0.0-20201130134442-10cb98267c6c h1:Hei/4ADfdWqJk1ZMxUNpqntNwaWcugrBjAiHlqqRiVk=\ngopkg.in/check.v1 v1.0.0-20201130134442-10cb98267c6c/go.mod h1:JHkPIbrfpd72SG/EVd6muEfDQjcINNoR0C8j2r3qZ4Q=\ngopkg.in/yaml.v2 v2.2.2/go.mod h1:hI93XBmqTisBFMUTm0b8Fm+jr3Dg1NNxqwp+5A1VGuI=\ngopkg.in/yaml.v3 v3.0.0-20200313102051-9f266ea9e77c/go.mod h1:K4uyk7z7BCEPqu6E+C64Yfv1cQ7kz7rIZviUmN+EgEM=\ngopkg.in/yaml.v3 v3.0.1 h1:fxVm/GzAzEWqLHuvctI91KS9hhNmmWOoWu0XTYJS7CA=\ngopkg.in/yaml.v3 v3.0.1/go.mod h1:K4uyk7z7BCEPqu6E+C64Yfv1cQ7kz7rIZviUmN+EgEM=\nmvdan.cc/editorconfig v0.2.0/go.mod h1:lvnnD3BNdBYkhq+B4uBuFFKatfp02eB6HixDvEz91C0=\nmvdan.cc/sh/v3 v3.6.0 h1:gtva4EXJ0dFNvl5bHjcUEvws+KRcDslT8VKheTYkbGU=\nmvdan.cc/sh/v3 v3.6.0/go.mod h1:U4mhtBLZ32iWhif5/lD+ygy1zrgaQhUu+XFy7C8+TTA=\n"
        },
        {
          "name": "modd.conf",
          "type": "blob",
          "size": 0.142578125,
          "content": "\n**/*.go {\n    prep: go test ./...\n    prep: go install ./cmd/modd\n    daemon: \"\n        #modd\n        cd test\n        modd -f mixed.conf\n    \"\n}\n"
        },
        {
          "name": "modd.go",
          "type": "blob",
          "size": 4.8740234375,
          "content": "package modd\n\nimport (\n\t\"fmt\"\n\t\"io/ioutil\"\n\t\"os\"\n\t\"os/signal\"\n\t\"path/filepath\"\n\t\"time\"\n\n\t\"github.com/cortesi/modd/conf\"\n\t\"github.com/cortesi/modd/notify\"\n\t\"github.com/cortesi/modd/shell\"\n\t\"github.com/cortesi/moddwatch\"\n\t\"github.com/cortesi/termlog\"\n)\n\n// Version is the modd release version\nconst Version = \"0.8\"\n\nconst lullTime = time.Millisecond * 100\n\nconst shellVarName = \"@shell\"\n\n// CommonExcludes is a list of commonly excluded files suitable for passing in\n// the excludes parameter to Watch - includes repo directories, temporary\n// files, and so forth.\nvar CommonExcludes = []string{\n\t// VCS\n\t\"**/.git/**\",\n\t\"**/.hg/**\",\n\t\"**/.svn/**\",\n\t\"**/.bzr/**\",\n\n\t// OSX\n\t\"**/.DS_Store/**\",\n\n\t// Temporary files\n\t\"**.tmp\",\n\t\"**~\",\n\t\"**#\",\n\t\"**.bak\",\n\t\"**.swp\",\n\t\"**.___jb_old___\",\n\t\"**.___jb_bak___\",\n\t\"**mage_output_file.go\",\n\n\t// Python\n\t\"**.py[cod]\",\n\n\t// Node\n\t\"**/node_modules/**\",\n}\n\n// ModRunner coordinates running the modd command\ntype ModRunner struct {\n\tLog        termlog.TermLog\n\tConfig     *conf.Config\n\tConfPath   string\n\tConfReload bool\n\tNotifiers  []notify.Notifier\n}\n\n// NewModRunner constructs a new ModRunner\nfunc NewModRunner(confPath string, log termlog.TermLog, notifiers []notify.Notifier, confreload bool) (*ModRunner, error) {\n\tmr := &ModRunner{\n\t\tLog:        log,\n\t\tConfPath:   confPath,\n\t\tConfReload: confreload,\n\t\tNotifiers:  notifiers,\n\t}\n\terr := mr.ReadConfig()\n\tif err != nil {\n\t\treturn nil, err\n\t}\n\treturn mr, nil\n}\n\n// ReadConfig parses the configuration file in ConfPath\nfunc (mr *ModRunner) ReadConfig() error {\n\tret, err := ioutil.ReadFile(mr.ConfPath)\n\tif err != nil {\n\t\treturn fmt.Errorf(\"Error reading config file %s: %s\", mr.ConfPath, err)\n\t}\n\tnewcnf, err := conf.Parse(mr.ConfPath, string(ret))\n\tif err != nil {\n\t\treturn fmt.Errorf(\"Error reading config file %s: %s\", mr.ConfPath, err)\n\t}\n\n\tif _, err := shell.GetShellName(newcnf.GetVariables()[shellVarName]); err != nil {\n\t\treturn err\n\t}\n\n\tnewcnf.CommonExcludes(CommonExcludes)\n\tmr.Config = newcnf\n\treturn nil\n}\n\n// PrepOnly runs all prep functions and exits\nfunc (mr *ModRunner) PrepOnly(initial bool) error {\n\tfor _, b := range mr.Config.Blocks {\n\t\terr := RunPreps(b, mr.Config.GetVariables(), nil, mr.Log, mr.Notifiers, initial)\n\t\tif err != nil {\n\t\t\treturn err\n\t\t}\n\t}\n\treturn nil\n}\n\nfunc (mr *ModRunner) runBlock(b conf.Block, mod *moddwatch.Mod, dpen *DaemonPen) {\n\tif b.InDir != \"\" {\n\t\tcurrentDir, err := os.Getwd()\n\t\tif err != nil {\n\t\t\tmr.Log.Shout(\"Error getting current working directory: %s\", err)\n\t\t\treturn\n\t\t}\n\t\terr = os.Chdir(b.InDir)\n\t\tif err != nil {\n\t\t\tmr.Log.Shout(\n\t\t\t\t\"Error changing to indir directory \\\"%s\\\": %s\",\n\t\t\t\tb.InDir,\n\t\t\t\terr,\n\t\t\t)\n\t\t\treturn\n\t\t}\n\t\tdefer func() {\n\t\t\terr := os.Chdir(currentDir)\n\t\t\tif err != nil {\n\t\t\t\tmr.Log.Shout(\"Error returning to original directory: %s\", err)\n\t\t\t}\n\t\t}()\n\t}\n\terr := RunPreps(\n\t\tb,\n\t\tmr.Config.GetVariables(),\n\t\tmod, mr.Log,\n\t\tmr.Notifiers,\n\t\tmod == nil,\n\t)\n\tif err != nil {\n\t\tif _, ok := err.(ProcError); !ok {\n\t\t\tmr.Log.Shout(\"Error running prep: %s\", err)\n\t\t}\n\t\treturn\n\t}\n\tdpen.Restart()\n}\n\nfunc (mr *ModRunner) trigger(root string, mod *moddwatch.Mod, dworld *DaemonWorld) {\n\tfor i, b := range mr.Config.Blocks {\n\t\tlmod := mod\n\t\tif lmod != nil {\n\t\t\tvar err error\n\t\t\tlmod, err = mod.Filter(root, b.Include, b.Exclude)\n\t\t\tif err != nil {\n\t\t\t\tmr.Log.Shout(\"Error filtering events: %s\", err)\n\t\t\t\tcontinue\n\t\t\t}\n\t\t\tif lmod.Empty() {\n\t\t\t\tcontinue\n\t\t\t}\n\t\t}\n\t\tmr.runBlock(b, lmod, dworld.DaemonPens[i])\n\t}\n}\n\n// Gives control of chan to caller\nfunc (mr *ModRunner) runOnChan(modchan chan *moddwatch.Mod, readyCallback func()) error {\n\tdworld, err := NewDaemonWorld(mr.Config, mr.Log)\n\tif err != nil {\n\t\treturn err\n\t}\n\tdefer dworld.Shutdown(os.Kill)\n\n\tc := make(chan os.Signal, 1)\n\tsignal.Notify(c, os.Interrupt, os.Kill)\n\tdefer signal.Reset(os.Interrupt, os.Kill)\n\tgo func() {\n\t\tdworld.Shutdown(<-c)\n\t\tos.Exit(0)\n\t}()\n\n\tipatts := mr.Config.IncludePatterns()\n\tif mr.ConfReload {\n\t\tipatts = append(ipatts, filepath.Dir(mr.ConfPath))\n\t}\n\n\tcurrentDir, err := os.Getwd()\n\tif err != nil {\n\t\treturn err\n\t}\n\t// FIXME: This takes a long time. We could start it in parallel with the\n\t// first process run in a goroutine\n\twatcher, err := moddwatch.Watch(currentDir, ipatts, []string{}, lullTime, modchan)\n\n\tif err != nil {\n\t\treturn fmt.Errorf(\"Error watching: %s\", err)\n\t}\n\tdefer watcher.Stop()\n\n\tmr.trigger(currentDir, nil, dworld)\n\tgo readyCallback()\n\tfor mod := range modchan {\n\t\tif mod == nil {\n\t\t\tbreak\n\t\t}\n\t\tif mr.ConfReload && mod.Has(mr.ConfPath) {\n\t\t\tmr.Log.Notice(\"Reloading config %s\", mr.ConfPath)\n\t\t\terr := mr.ReadConfig()\n\t\t\tif err != nil {\n\t\t\t\tmr.Log.Warn(\"%s\", err)\n\t\t\t\tcontinue\n\t\t\t} else {\n\t\t\t\treturn nil\n\t\t\t}\n\t\t}\n\t\tmr.Log.SayAs(\"debug\", \"Delta: \\n%s\", mod.String())\n\t\tmr.trigger(currentDir, mod, dworld)\n\t}\n\treturn nil\n}\n\n// Run is the top-level runner for modd\nfunc (mr *ModRunner) Run() error {\n\tfor {\n\t\tmodchan := make(chan *moddwatch.Mod, 1024)\n\t\terr := mr.runOnChan(modchan, func() {})\n\t\tif err != nil {\n\t\t\treturn err\n\t\t}\n\t}\n}\n"
        },
        {
          "name": "modd_test.go",
          "type": "blob",
          "size": 4.009765625,
          "content": "package modd\n\nimport (\n\t\"io/ioutil\"\n\t\"os\"\n\t\"path/filepath\"\n\t\"reflect\"\n\t\"strings\"\n\t\"testing\"\n\t\"time\"\n\n\t\"github.com/cortesi/modd/conf\"\n\t\"github.com/cortesi/modd/utils\"\n\t\"github.com/cortesi/moddwatch\"\n\t\"github.com/cortesi/termlog\"\n)\n\nconst timeout = 5 * time.Second\n\nfunc touch(p string) {\n\tp = filepath.FromSlash(p)\n\td := filepath.Dir(p)\n\terr := os.MkdirAll(d, 0777)\n\tif err != nil {\n\t\tpanic(err)\n\t}\n\n\tf, err := os.OpenFile(p, os.O_WRONLY|os.O_CREATE|os.O_APPEND, 0777)\n\tif err != nil {\n\t\tpanic(err)\n\t}\n\tif _, err := f.Write([]byte(\"teststring\")); err != nil {\n\t\tpanic(err)\n\t}\n\tif err := f.Close(); err != nil {\n\t\tpanic(err)\n\t}\n\tioutil.ReadFile(p)\n}\n\nfunc events(p string) []string {\n\tparts := []string{}\n\tfor _, p := range strings.Split(p, \"\\n\") {\n\t\tif strings.HasPrefix(p, \":\") {\n\t\t\tp = strings.TrimSpace(p)\n\t\t\tif !strings.HasSuffix(p, \":\") {\n\t\t\t\tparts = append(parts, strings.TrimSpace(p))\n\t\t\t}\n\t\t}\n\t}\n\treturn parts\n}\n\nfunc _testWatch(t *testing.T, modfunc func(), expected []string) {\n\tdefer utils.WithTempDir(t)()\n\n\terr := os.MkdirAll(\"a/inner\", 0777)\n\tif err != nil {\n\t\tt.Fatal(err)\n\t}\n\n\terr = os.MkdirAll(\"b\", 0777)\n\tif err != nil {\n\t\tt.Fatal(err)\n\t}\n\n\ttouch(\"a/initial\")\n\t// There's some race condition in rjeczalik/notify. If we don't wait a bit\n\t// here, we sometimes receive notifications for the change above even\n\t// though we haven't started the watcher.\n\ttime.Sleep(200 * time.Millisecond)\n\n\tconfTxt := `\n\t\t@shell = bash\n\n        ** {\n            prep +onchange: echo \":skipit:\" @mods\n            prep: echo \":all:\" @mods\n        }\n        a/* {\n            prep: echo \":a:\" @mods\n        }\n        b/* {\n            prep: echo \":b:\" @mods\n        }\n        a/**/*.xxx {\n            prep: echo \":c:\" @mods\n        }\n        a/direct {\n            prep: echo \":d:\" @mods\n        }\n        direct {\n            prep: echo \":e:\" @mods\n        }\n    `\n\tcnf, err := conf.Parse(\"test\", confTxt)\n\tif err != nil {\n\t\tt.Fatal(err)\n\t}\n\n\tlt := termlog.NewLogTest()\n\tmodchan := make(chan *moddwatch.Mod, 1024)\n\tcback := func() {\n\t\tstart := time.Now()\n\t\tmodfunc()\n\t\tfor {\n\t\t\tret := events(lt.String())\n\t\t\tif reflect.DeepEqual(ret, expected) {\n\t\t\t\tbreak\n\t\t\t}\n\t\t\tif time.Now().Sub(start) > timeout {\n\t\t\t\tt.Errorf(\"Expected\\n%#v\\nGot\\n%#v\", expected, ret)\n\t\t\t\tbreak\n\t\t\t}\n\t\t\ttime.Sleep(50 * time.Millisecond)\n\t\t}\n\t\tmodchan <- nil\n\t}\n\n\tmr := ModRunner{\n\t\tLog:    lt.Log,\n\t\tConfig: cnf,\n\t}\n\n\terr = mr.runOnChan(modchan, cback)\n\tif err != nil {\n\t\tt.Fatalf(\"runOnChan: %s\", err)\n\t}\n\tret := events(lt.String())\n\tif !reflect.DeepEqual(ret, expected) {\n\t\tt.Errorf(\"Expected\\n%#v\\nGot\\n%#v\", expected, ret)\n\t}\n}\n\nfunc TestWatch(t *testing.T) {\n\tt.Run(\n\t\t\"single\",\n\t\tfunc(t *testing.T) {\n\t\t\t_testWatch(\n\t\t\t\tt,\n\t\t\t\tfunc() { touch(\"a/touched\") },\n\t\t\t\t[]string{\n\t\t\t\t\t\":all: ./a/initial\",\n\t\t\t\t\t\":a: ./a/initial\",\n\t\t\t\t\t\":skipit: ./a/touched\",\n\t\t\t\t\t\":all: ./a/touched\",\n\t\t\t\t\t\":a: ./a/touched\",\n\t\t\t\t},\n\t\t\t)\n\t\t},\n\t)\n\tt.Run(\n\t\t\"double\",\n\t\tfunc(t *testing.T) {\n\t\t\t_testWatch(\n\t\t\t\tt,\n\t\t\t\tfunc() {\n\t\t\t\t\ttouch(\"a/touched\")\n\t\t\t\t\ttouch(\"b/touched\")\n\t\t\t\t},\n\t\t\t\t[]string{\n\t\t\t\t\t\":all: ./a/initial\",\n\t\t\t\t\t\":a: ./a/initial\",\n\t\t\t\t\t\":skipit: ./a/touched ./b/touched\",\n\t\t\t\t\t\":all: ./a/touched ./b/touched\",\n\t\t\t\t\t\":a: ./a/touched\",\n\t\t\t\t\t\":b: ./b/touched\",\n\t\t\t\t},\n\t\t\t)\n\t\t},\n\t)\n\tt.Run(\n\t\t\"inner\",\n\t\tfunc(t *testing.T) {\n\t\t\t_testWatch(\n\t\t\t\tt,\n\t\t\t\tfunc() {\n\t\t\t\t\ttouch(\"a/inner/touched.xxx\")\n\t\t\t\t},\n\t\t\t\t[]string{\n\t\t\t\t\t\":all: ./a/initial\",\n\t\t\t\t\t\":a: ./a/initial\",\n\t\t\t\t\t\":skipit: ./a/inner/touched.xxx\",\n\t\t\t\t\t\":all: ./a/inner/touched.xxx\",\n\t\t\t\t\t\":c: ./a/inner/touched.xxx\",\n\t\t\t\t},\n\t\t\t)\n\t\t},\n\t)\n\tt.Run(\n\t\t\"direct\",\n\t\tfunc(t *testing.T) {\n\t\t\t_testWatch(\n\t\t\t\tt,\n\t\t\t\tfunc() {\n\t\t\t\t\ttouch(\"a/direct\")\n\t\t\t\t},\n\t\t\t\t[]string{\n\t\t\t\t\t\":all: ./a/initial\",\n\t\t\t\t\t\":a: ./a/initial\",\n\t\t\t\t\t\":skipit: ./a/direct\",\n\t\t\t\t\t\":all: ./a/direct\",\n\t\t\t\t\t\":a: ./a/direct\",\n\t\t\t\t\t\":d: ./a/direct\",\n\t\t\t\t},\n\t\t\t)\n\t\t},\n\t)\n\tt.Run(\n\t\t\"rootdirect\",\n\t\tfunc(t *testing.T) {\n\t\t\t_testWatch(\n\t\t\t\tt,\n\t\t\t\tfunc() {\n\t\t\t\t\ttouch(\"direct\")\n\t\t\t\t},\n\t\t\t\t[]string{\n\t\t\t\t\t\":all: ./a/initial\",\n\t\t\t\t\t\":a: ./a/initial\",\n\t\t\t\t\t\":skipit: ./direct\",\n\t\t\t\t\t\":all: ./direct\",\n\t\t\t\t\t\":e: ./direct\",\n\t\t\t\t},\n\t\t\t)\n\t\t},\n\t)\n}\n"
        },
        {
          "name": "notify",
          "type": "tree",
          "content": null
        },
        {
          "name": "prep.go",
          "type": "blob",
          "size": 1.7958984375,
          "content": "package modd\n\nimport (\n\t\"time\"\n\n\t\"github.com/cortesi/modd/conf\"\n\t\"github.com/cortesi/modd/notify\"\n\t\"github.com/cortesi/modd/shell\"\n\t\"github.com/cortesi/modd/varcmd\"\n\t\"github.com/cortesi/moddwatch\"\n\t\"github.com/cortesi/termlog\"\n)\n\n// ProcError is a process error, possibly containing command output\ntype ProcError struct {\n\tshorttext string\n\tOutput    string\n}\n\nfunc (p ProcError) Error() string {\n\treturn p.shorttext\n}\n\n// RunProc runs a process to completion, sending output to log\nfunc RunProc(cmd string, shellMethod string, dir string, log termlog.Stream) error {\n\tlog.Header()\n\tex, err := shell.NewExecutor(shellMethod, cmd, dir)\n\tif err != nil {\n\t\treturn err\n\t}\n\tstart := time.Now()\n\terr, estate := ex.Run(log, true)\n\tif err != nil {\n\t\treturn err\n\t} else if estate.Error != nil {\n\t\tlog.Shout(\"%s\", estate.Error)\n\t\treturn ProcError{estate.Error.Error(), estate.ErrOutput}\n\t}\n\tlog.Notice(\">> done (%s)\", time.Since(start))\n\treturn nil\n}\n\n// RunPreps runs all commands in sequence. Stops if any command returns an error.\nfunc RunPreps(\n\tb conf.Block,\n\tvars map[string]string,\n\tmod *moddwatch.Mod,\n\tlog termlog.TermLog,\n\tnotifiers []notify.Notifier,\n\tinitial bool,\n) error {\n\tsh, err := shell.GetShellName(vars[shellVarName])\n\tif err != nil {\n\t\treturn err\n\t}\n\n\tvar modified []string\n\tif mod != nil {\n\t\tmodified = mod.All()\n\t}\n\n\tvcmd := varcmd.VarCmd{Block: &b, Modified: modified, Vars: vars}\n\tfor _, p := range b.Preps {\n\t\tcmd, err := vcmd.Render(p.Command)\n\t\tif initial && p.Onchange {\n\t\t\tlog.Say(niceHeader(\"skipping prep: \", cmd))\n\t\t\tcontinue\n\t\t}\n\t\tif err != nil {\n\t\t\treturn err\n\t\t}\n\t\terr = RunProc(cmd, sh, b.InDir, log.Stream(niceHeader(\"prep: \", cmd)))\n\t\tif err != nil {\n\t\t\tif pe, ok := err.(ProcError); ok {\n\t\t\t\tfor _, n := range notifiers {\n\t\t\t\t\tn.Push(\"modd error\", pe.Output, \"\")\n\t\t\t\t}\n\t\t\t}\n\t\t\treturn err\n\t\t}\n\t}\n\treturn nil\n}\n"
        },
        {
          "name": "proc.go",
          "type": "blob",
          "size": 1.0595703125,
          "content": "package modd\n\nimport (\n\t\"bufio\"\n\t\"io\"\n\t\"strings\"\n\t\"sync\"\n\n\t\"github.com/cortesi/termlog\"\n)\n\n// shortCommand shortens a command to a name we can use in a notification\n// header.\nfunc shortCommand(command string) string {\n\tret := command\n\tparts := strings.Split(command, \"\\n\")\n\tfor _, i := range parts {\n\t\ti = strings.TrimLeft(i, \" \\t#\")\n\t\ti = strings.TrimRight(i, \" \\t\\\\\")\n\t\tif i != \"\" {\n\t\t\tret = i\n\t\t\tbreak\n\t\t}\n\t}\n\treturn ret\n}\n\n// niceHeader tries to produce a nicer process name. We condense whitespace to\n// make commands split over multiple lines with indentation more legible, and\n// limit the line length to 80 characters.\nfunc niceHeader(preamble string, command string) string {\n\tpre := termlog.DefaultPalette.Timestamp.SprintFunc()(preamble)\n\tcommand = termlog.DefaultPalette.Header.SprintFunc()(shortCommand(command))\n\treturn pre + command\n}\n\nfunc logOutput(wg *sync.WaitGroup, fp io.ReadCloser, out func(string, ...interface{})) {\n\tdefer wg.Done()\n\tr := bufio.NewReader(fp)\n\tfor {\n\t\tline, _, err := r.ReadLine()\n\t\tif err != nil {\n\t\t\treturn\n\t\t}\n\t\tout(\"%s\", string(line))\n\t}\n}\n"
        },
        {
          "name": "proc_test.go",
          "type": "blob",
          "size": 0.5263671875,
          "content": "package modd\n\nimport \"testing\"\n\nvar shortCommandTests = []struct {\n\tcommand  string\n\texpected string\n}{\n\t{\"one\", \"one\"},\n\t{\"one\\ntwo\", \"one\"},\n\t{\"one\\\\\\ntwo\", \"one\"},\n\t{\"\\n\\none\\\\\\ntwo\", \"one\"},\n\t{\"\\n   \\none\\\\\\ntwo\", \"one\"},\n\n\t{\"# one\", \"one\"},\n\t{\"\\n\\n# one\\\\\\ntwo\", \"one\"},\n\t{\"\\n   \\n# one\\\\\\ntwo\", \"one\"},\n}\n\nfunc TestShortCommand(t *testing.T) {\n\tfor i, tst := range shortCommandTests {\n\t\tresult := shortCommand(tst.command)\n\t\tif result != tst.expected {\n\t\t\tt.Errorf(\"Test %d: expected\\n%q\\ngot\\n%q\", i, tst.expected, result)\n\t\t}\n\t}\n}\n"
        },
        {
          "name": "shell",
          "type": "tree",
          "content": null
        },
        {
          "name": "test",
          "type": "tree",
          "content": null
        },
        {
          "name": "utils",
          "type": "tree",
          "content": null
        },
        {
          "name": "varcmd",
          "type": "tree",
          "content": null
        }
      ]
    }
  ]
}