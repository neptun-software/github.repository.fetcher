{
  "metadata": {
    "timestamp": 1736568915768,
    "page": 133,
    "hasNextPage": false,
    "endCursor": "Y3Vyc29yOjEzNw==",
    "completionStatus": "IN_PROGRESS"
  },
  "repositories": [
    {
      "nameWithOwner": "ben1234560/k8s_PaaS",
      "stars": 5097,
      "defaultBranch": "master",
      "files": [
        {
          "name": ".DS_Store",
          "type": "blob",
          "size": 10.00390625,
          "content": null
        },
        {
          "name": ".gitattributes",
          "type": "blob",
          "size": 0.029296875,
          "content": "*.zip linguist-language=shell\n"
        },
        {
          "name": ".gitignore",
          "type": "blob",
          "size": 0.0302734375,
          "content": "\n.DS_Store\n.DS_Store\n.DS_Store\n"
        },
        {
          "name": "CONTRIBUTING.md",
          "type": "blob",
          "size": 0.33984375,
          "content": "## CONTRIBUTING\n\n1. [Fork on Github](https://github.com/ben1234560/k8s_PaaS/fork)\n2. Clone the forked repo: `git clone https://github.com/ben1234560/k8s_PaaS.git`\n3. Create a new branch, add some changes and commit: `git checkout -b new-branch`.\n4. Push the branch to Github: `git commit -am \"comments\"; git push`.\n5. File a Pull Request on Github."
        },
        {
          "name": "Features.md",
          "type": "blob",
          "size": 1.791015625,
          "content": "## Features\n\n![1584258151218](assets/1584258151218.png)\n\n- å¯¹åšçš„äº‹æƒ…è¿›è¡Œè¯´æ˜æ˜¯ä»€ä¹ˆï¼ˆWHATï¼‰ï¼Œä¸ºä»€ä¹ˆè¦åšï¼ˆWHYï¼‰\n\n![1584258268594](assets/1584258268594.png)\n\n- å¯¹ç›¸å…³æ–‡ä»¶è¿›è¡Œè§£æã€æŒ‡æ˜å“ªéƒ¨æœºå™¨æ“ä½œã€é…å›¾ï¼Œå¹¶åœ¨æ˜“å‡ºé”™ç‚¹æ·»åŠ è§£å†³åŠæ³•ã€‚\n\n![1584258427709](assets/1584258427709.png)\n\n- ä½¿ç”¨æ–‡ä»¶çš†æ˜¯å®˜æ–¹æ–‡ä»¶ï¼Œä¸”è½¯ä»¶åŒ…æœ‰å¯¹åº”æ–‡ä»¶ï¼Œé¿å…è¢«æ›´æ–°æˆ–å…¶å®ƒé—®é¢˜å¯¼è‡´æ— æ³•ä¸‹è½½ç­‰æƒ…å†µï¼Œç™¾åº¦äº‘https://pan.baidu.com/s/1arE2LdtAbcR80gmIQtIELw æå–ç ï¼šouy1ã€‚\n\n  ![1584272695417](assets/1584272695417.png)\n\n- æ— æ•°å‰äººéå†/å»ºè®¾ä»£ç ï¼Œä¸ºä»£ç å®Œæ•´æ€§ä¿é©¾æŠ¤èˆªï¼Œæ¬¢è¿ç»™æˆ‘ä»¬æä¾›ä½ çš„å»ºè®®ã€æ‰©å±•ã€æŠ¥é”™\n\n  ![1585471116118](assets/1585471116118.png)\n\n## Q&A\n\n- Q: æˆ‘çš„ç”µè„‘æ˜¯4æ ¸8Gèƒ½åšå—ï¼š\n  - A: 4æ ¸8Gèƒ½åšåˆ°dashboardå‰åï¼Œ4æ ¸16Gèƒ½åšåˆ°Jenkinså‰åï¼Œ8æ ¸24Gèƒ½åšåˆ°prometheuså‰åï¼Œå½“ç„¶å¯¹äºéƒ¨åˆ†åŒå­¦å¯èƒ½ä¸€å¼€å§‹å°±ä¹°ä¸ª8æ ¸32Gçš„æœºå™¨å¾ˆæµªè´¹ï¼Œä½ å¯ä»¥å…ˆç”¨ä½ çš„æœºå™¨åšåˆ°åšä¸åŠ¨å†ä¹°ï¼Œå› ä¸ºå‰æœŸå¾ˆå¤šä¸œè¥¿çœ‹ä¸æ‡‚ï¼Œå­¦ä¹ çš„è¿›åº¦ä¹Ÿæ˜¯æ¯”è¾ƒæ…¢ï¼Œè€Œä¸”æˆ‘å¼ºçƒˆå»ºè®®å„ä½å¦‚æœå¯ä»¥ä¸€å®šè¦åšåˆ°Jenkinsåé‡è£…ä¸€éã€‚\n- Q: æˆ‘æ˜¯æ–°æ‰‹å¯ä»¥å—\n  - A: åªè¦ä½ ä¼šç”¨ç”µè„‘å°±å¯ä»¥ï¼Œè‡³äºæ‡‚ä¸æ‡‚linuxæ‡‚ä¸æ‡‚å¼€å‘ï¼Œè¿™äº›éƒ½æ— å…³ç´§è¦\n- Q: ä¸€ç›´æŠ¥é”™æ‰¾ä¸åˆ°è§£å†³åŠæ³•æ€ä¹ˆåŠ\n  - A: åŠ ç¾¤ï¼ˆç¾¤äºŒç»´ç åœ¨ä¸»é¡µï¼‰æ‰¾æˆ‘ä»¬ï¼Œæœ‰å¾ˆå¤šçƒ­å¿ƒçš„ç¾¤å‹ã€‚æˆ–è€…ä½ å¯ä»¥é‡è£…ï¼Œå‰ææ˜¯ä½ ç¡®å®šä¸æ˜¯ä½ æ“ä½œçš„é—®é¢˜ï¼ˆPSï¼šæœºå™¨å‘½åå’Œé…ç½®å°½é‡è·Ÿæˆ‘çš„ä¸€æ ·ï¼Œä¸ç„¶å¾ˆéš¾ç»™ä½ æ‰¾ï¼‰\n- Q: åšå®Œäº†ä¸€éƒ¨åˆ†ä½†æ˜¯çœ‹ä¸æ‡‚ï¼Œå°±æ„Ÿè§‰è‡ªå·±åœ¨å¤åˆ¶ç²˜è´´\n  - A: æ‰€æœ‰çš„å­¦ä¹ éƒ½æ˜¯ä»å¤åˆ¶ç²˜è´´å¼€å§‹ï¼Œæ²¡æœ‰äººèƒ½çœ‹ä¸€éå°±ä»€ä¹ˆéƒ½æ‡‚ï¼ˆå½“ç„¶æ˜¯å› ä¸ºæˆ‘æ²¡è§è¿‡è¿™ç§äººï¼Œæˆ‘é‡åˆ°çš„å¤§éƒ¨åˆ†éƒ½æ˜¯æœ‰åŸºç¡€æ‰€ä»¥å­¦çš„å¿«ï¼‰\n\n"
        },
        {
          "name": "LICENSE",
          "type": "blob",
          "size": 1.0419921875,
          "content": "MIT License\n\nCopyright (c) 2020 ben1234560\n\nPermission is hereby granted, free of charge, to any person obtaining a copy\nof this software and associated documentation files (the \"Software\"), to deal\nin the Software without restriction, including without limitation the rights\nto use, copy, modify, merge, publish, distribute, sublicense, and/or sell\ncopies of the Software, and to permit persons to whom the Software is\nfurnished to do so, subject to the following conditions:\n\nThe above copyright notice and this permission notice shall be included in all\ncopies or substantial portions of the Software.\n\nTHE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\nIMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\nFITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\nAUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\nLIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\nOUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE\nSOFTWARE.\n"
        },
        {
          "name": "README.md",
          "type": "blob",
          "size": 28.755859375,
          "content": "# k8s_PaaS\n[![image](https://img.shields.io/badge/google-kubernetes-blue.svg)](https://kubernetes.io/) [![image](https://img.shields.io/badge/ctripcorp-apollo-gray.svg)](https://github.com/ctripcorp/apollo) [![image](https://img.shields.io/badge/CNCD-Spinnaker-skyblue.svg)](https://www.spinnaker.io/) [![image](https://img.shields.io/badge/JAVA-Jenkins-orange.svg)](https://jenkins.io/zh/) [![image](https://img.shields.io/badge/Git-Gitee-red.svg)](https://gitee.com) [![image](https://img.shields.io/badge/Git-GitLab-orange.svg)]() [![image](https://img.shields.io/badge/Apache-zookeeper-Crimson.svg)](http://zookeeper.apache.org/) [![image](https://img.shields.io/badge/used-Harbor-green.svg)](https://goharbor.io/)\n\n[![image](https://img.shields.io/badge/used-docker-blue.svg)](https://www.docker.com/) [![image](https://img.shields.io/badge/used-Prometheus-red.svg)](https://prometheus.io/) [![image](https://img.shields.io/badge/used-etcd-blue.svg)](https://etcd.io/) [![image](https://img.shields.io/badge/used-Grafana-orange.svg)](https://grafana.com)\n\nåŸºäºKubernetes(K8S)ä¸€æ­¥æ­¥éƒ¨ç½²æˆPaaS/DevOpsï¼ˆä¸€å¥—å®Œæ•´çš„è½¯ä»¶ç ”å‘å’Œéƒ¨ç½²å¹³å°ï¼‰â€”â€”æ•™ç¨‹/å­¦ä¹ ï¼ˆå®æˆ˜ä»£ç /æ¬¢è¿è®¨è®º/å¤§é‡æ³¨é‡Š/æ“ä½œé…å›¾ï¼‰ï¼Œä½ å°†ä¹ å¾—éƒ¨ç½²å¦‚ï¼šKubernetes(K8S)ã€dashboardã€Harborã€Jenkinsã€æœ¬åœ°gitlabã€Apolloæ¡†æ¶ã€promtheusã€grafanaã€spinnakerç­‰ã€‚\n\næ³¨é‡ŠåŠé…å›¾è¦†ç›–ç‡è¾¾80%ä»¥ä¸Šï¼Œæ—¨åœ¨å¸®åŠ©å¿«é€Ÿå…¥é—¨ã€‚\n\nå¹¶å°†å‘Šè¯‰ä½ ï¼šæ˜¯ä»€ä¹ˆï¼ˆWHATï¼‰ã€ä¸ºä»€ä¹ˆè¿™ä¹ˆåš(WHY)ã€æ€ä¹ˆåš(HOW)ã€‚\n\nå»ºè®®å­¦ä¹ æ—¶é•¿1ä¸ªæœˆ+ï¼Œæœ€ç»ˆå°†å®ç°ç‚¹ç‚¹ç‚¹ï¼ˆè‡ªåŠ¨åŒ–ï¼‰çš„å½¢å¼å°±èƒ½éƒ¨ç½²ä¸Šçº¿å¹¶ç»´æŠ¤ã€‚\n\n## PaaSæ¶æ„å›¾\n\n![K8S_PaaSæ¶æ„å›¾](assets/K8S_PaaSæ¶æ„å›¾.png)\n\n> æ©™è‰²æ¡†å†…è½¯ä»¶çš†éƒ¨ç½²åœ¨K8Sé›†ç¾¤ä¸­ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬å¯ä»¥éšæ—¶æ‰©å®¹ç¼©å®¹\n\n## <a href=\"https://github.com/ben1234560/k8s_PaaS/blob/master/Features.md\">Features</a>\n\n- å¯¹åšçš„äº‹æƒ…è¿›è¡Œè¯´æ˜æ˜¯ä»€ä¹ˆï¼ˆWHATï¼‰ï¼Œä¸ºä»€ä¹ˆè¦åšï¼ˆWHYï¼‰ã€‚\n- å¯¹ç›¸å…³æ–‡ä»¶è¿›è¡Œè§£æã€æŒ‡æ˜å“ªéƒ¨æœºå™¨æ“ä½œã€é…å›¾ï¼Œå¹¶åœ¨æ˜“å‡ºé”™ç‚¹æ·»åŠ è§£å†³åŠæ³•ã€‚ç¬¬äºŒç« ç”±äºé…ç½®å†…å®¹è¾ƒå¤šï¼Œå»ºè®®é…åˆ[check_tool](https://github.com/ben1234560/k8s_PaaS/tree/master/%E8%BD%AF%E4%BB%B6%E5%8C%85/check_tool)ä½¿ç”¨ã€‚\n- ä½¿ç”¨æ–‡ä»¶çš†æ˜¯å®˜æ–¹æ–‡ä»¶ï¼Œç›¸å…³è½¯ä»¶åŒ…æœ‰å¯¹åº”æ–‡ä»¶ï¼Œé¿å…è¢«æ›´æ–°æˆ–å…¶å®ƒé—®é¢˜å¯¼è‡´æ— æ³•ä¸‹è½½ç­‰æƒ…å†µï¼Œç™¾åº¦äº‘https://pan.baidu.com/s/1arE2LdtAbcR80gmIQtIELw æå–ç ï¼šouy1ã€‚\n- æ— æ•°å‰äººéå†/å»ºè®¾ä»£ç ï¼Œä¸ºä»£ç å®Œæ•´æ€§ä¿é©¾æŠ¤èˆªï¼Œæ¬¢è¿ç»™æˆ‘ä»¬æä¾›ä½ çš„å»ºè®®ã€æ‰©å±•ã€æŠ¥é”™ã€‚\n- æ•´ç†äº†å¤šäººé—®çš„4ä¸ªé—®é¢˜<a href=\"https://github.com/ben1234560/k8s_PaaS/blob/master/Features.md#qa\">Q&A</a>ï¼šé…ç½®åªæœ‰4æ ¸8Gå¤Ÿå—ï¼Œæ–°æ‰‹å¯ä»¥å—ï¼Œæ‰¾ä¸åˆ°æŠ¥é”™æ€ä¹ˆåŠï¼Œåšå®Œçœ‹ä¸æ‡‚æ€ä¹ˆåŠ\n- æ¨å‡ºå…¬æœ‰äº‘éƒ¨ç½²ç‰ˆæœ¬ï¼Œå¦‚[ç¬¬äºŒç« â€”â€”ä¼ä¸šéƒ¨ç½²å®æˆ˜_K8Sã€å…¬æœ‰äº‘ç‰ˆã€‘](https://github.com/ben1234560/k8s_PaaS/blob/master/%E7%AC%AC%E4%BA%8C%E7%AB%A0%E2%80%94%E2%80%94%E4%BC%81%E4%B8%9A%E9%83%A8%E7%BD%B2%E5%AE%9E%E6%88%98_K8S%E3%80%90%E5%85%AC%E6%9C%89%E4%BA%91%E7%89%88%E3%80%91.md)ã€‚è‡ªå·±ç”µè„‘èµ„æºç´§å¼ çš„å®Œå…¨å¯ä»¥ç”¨ï¼Œè€Œä¸”è´¹ç”¨ä¹Ÿä¾¿å®œ\n\n## å­¦ä¹ ç« èŠ‚ï¼š\n\n<ul>\n    <li><a href=\"https://github.com/ben1234560/k8s_PaaS/blob/master/%E7%AC%AC%E4%B8%80%E7%AB%A0%E2%80%94%E2%80%94Docker%EF%BC%88%E5%B7%B2%E7%86%9F%E6%82%89%E7%9A%84%E5%8F%AF%E4%BB%A5%E4%BB%8E%E7%AC%AC%E4%BA%8C%E7%AB%A0%E5%BC%80%E5%A7%8B%EF%BC%89.md\">ç¬¬ä¸€ç« â€”â€”Docker</a>\n    <ul>\n        <li><a href=\"https://github.com/ben1234560/k8s_PaaS/blob/master/%E7%AC%AC%E4%B8%80%E7%AB%A0%E2%80%94%E2%80%94Docker%EF%BC%88%E5%B7%B2%E7%86%9F%E6%82%89%E7%9A%84%E5%8F%AF%E4%BB%A5%E4%BB%8E%E7%AC%AC%E4%BA%8C%E7%AB%A0%E5%BC%80%E5%A7%8B%EF%BC%89.md#%E5%AE%89%E8%A3%85docker\">å®‰è£…Docker</a>\n      <li><a href=\"https://github.com/ben1234560/k8s_PaaS/blob/master/%E7%AC%AC%E4%B8%80%E7%AB%A0%E2%80%94%E2%80%94Docker%EF%BC%88%E5%B7%B2%E7%86%9F%E6%82%89%E7%9A%84%E5%8F%AF%E4%BB%A5%E4%BB%8E%E7%AC%AC%E4%BA%8C%E7%AB%A0%E5%BC%80%E5%A7%8B%EF%BC%89.md#%E5%BC%80%E5%90%AF%E6%88%91%E4%BB%AC%E7%9A%84%E7%AC%AC%E4%B8%80%E4%B8%AAdocker%E5%AE%B9%E5%99%A8\">å¼€å¯æˆ‘ä»¬çš„ç¬¬ä¸€ä¸ªdockerå®¹å™¨</a>\n      <li><a href=\"https://github.com/ben1234560/k8s_PaaS/blob/master/%E7%AC%AC%E4%B8%80%E7%AB%A0%E2%80%94%E2%80%94Docker%EF%BC%88%E5%B7%B2%E7%86%9F%E6%82%89%E7%9A%84%E5%8F%AF%E4%BB%A5%E4%BB%8E%E7%AC%AC%E4%BA%8C%E7%AB%A0%E5%BC%80%E5%A7%8B%EF%BC%89.md#dockerhub%E6%B3%A8%E5%86%8C%E8%87%AA%E5%B7%B1%E7%9A%84%E8%BF%9C%E7%A8%8B%E4%BB%93%E5%BA%93\">Dockerhubæ³¨å†Œï¼ˆè‡ªå·±çš„è¿œç¨‹ä»“åº“ï¼‰</a>\n      <li><a href=\"https://github.com/ben1234560/k8s_PaaS/blob/master/%E7%AC%AC%E4%B8%80%E7%AB%A0%E2%80%94%E2%80%94Docker%EF%BC%88%E5%B7%B2%E7%86%9F%E6%82%89%E7%9A%84%E5%8F%AF%E4%BB%A5%E4%BB%8E%E7%AC%AC%E4%BA%8C%E7%AB%A0%E5%BC%80%E5%A7%8B%EF%BC%89.md#docker%E9%95%9C%E5%83%8F%E7%AE%A1%E7%90%86%E5%AE%9E%E6%88%98\">Dockeré•œåƒç®¡ç†å®æˆ˜</a>\n      <li><a href=\"https://github.com/ben1234560/k8s_PaaS/blob/master/%E7%AC%AC%E4%B8%80%E7%AB%A0%E2%80%94%E2%80%94Docker%EF%BC%88%E5%B7%B2%E7%86%9F%E6%82%89%E7%9A%84%E5%8F%AF%E4%BB%A5%E4%BB%8E%E7%AC%AC%E4%BA%8C%E7%AB%A0%E5%BC%80%E5%A7%8B%EF%BC%89.md#docker%E9%95%9C%E5%83%8F%E7%AE%A1%E7%90%86%E5%AE%9E%E6%88%98\">dockerå®¹å™¨æ“ä½œ</a>\n      <li><a href=\"https://github.com/ben1234560/k8s_PaaS/blob/master/%E7%AC%AC%E4%B8%80%E7%AB%A0%E2%80%94%E2%80%94Docker%EF%BC%88%E5%B7%B2%E7%86%9F%E6%82%89%E7%9A%84%E5%8F%AF%E4%BB%A5%E4%BB%8E%E7%AC%AC%E4%BA%8C%E7%AB%A0%E5%BC%80%E5%A7%8B%EF%BC%89.md#dockerfile-%E7%BB%BC%E5%90%88%E5%AE%9E%E9%AA%8C\">dockerfile ç»¼åˆå®éªŒ</a>\n    </ul>\n  </li>\n    <li><a href=\"https://github.com/ben1234560/k8s_PaaS/blob/master/%E7%AC%AC%E4%BA%8C%E7%AB%A0%E2%80%94%E2%80%94%E4%BC%81%E4%B8%9A%E9%83%A8%E7%BD%B2%E5%AE%9E%E6%88%98_K8S.md\">ç¬¬äºŒç« â€”â€”ä¼ä¸šéƒ¨ç½²å®æˆ˜_K8S</a>\n<ul>\n  <li><a href=\"https://github.com/ben1234560/k8s_PaaS/blob/master/%E7%AC%AC%E4%BA%8C%E7%AB%A0%E2%80%94%E2%80%94%E4%BC%81%E4%B8%9A%E9%83%A8%E7%BD%B2%E5%AE%9E%E6%88%98_K8S.md#k8s%E5%89%8D%E7%BD%AE%E5%87%86%E5%A4%87%E5%B7%A5%E4%BD%9Cbind9%E5%AE%89%E8%A3%85%E9%83%A8%E7%BD%B2dns%E6%9C%8D%E5%8A%A1\">K8Så‰ç½®å‡†å¤‡å·¥ä½œâ€”â€”bind9å®‰è£…éƒ¨ç½²ï¼ˆDNSæœåŠ¡ï¼‰</a>\n  <li><a href=\"https://github.com/ben1234560/k8s_PaaS/blob/master/%E7%AC%AC%E4%BA%8C%E7%AB%A0%E2%80%94%E2%80%94%E4%BC%81%E4%B8%9A%E9%83%A8%E7%BD%B2%E5%AE%9E%E6%88%98_K8S.md#k8s%E5%89%8D%E7%BD%AE%E5%B7%A5%E4%BD%9C%E5%87%86%E5%A4%87%E7%AD%BE%E5%8F%91%E8%AF%81%E4%B9%A6%E7%8E%AF%E5%A2%83\">K8Så‰ç½®å·¥ä½œâ€”â€”å‡†å¤‡ç­¾å‘è¯ä¹¦ç¯å¢ƒ</a>\n  <li><a href=\"https://github.com/ben1234560/k8s_PaaS/blob/master/%E7%AC%AC%E4%BA%8C%E7%AB%A0%E2%80%94%E2%80%94%E4%BC%81%E4%B8%9A%E9%83%A8%E7%BD%B2%E5%AE%9E%E6%88%98_K8S.md#k8s%E5%89%8D%E7%BD%AE%E5%B7%A5%E4%BD%9C%E9%83%A8%E7%BD%B2docker%E7%8E%AF%E5%A2%83\">K8Så‰ç½®å·¥ä½œâ€”â€”éƒ¨ç½²dockerç¯å¢ƒ</a>\n  <li><a href=\"https://github.com/ben1234560/k8s_PaaS/blob/master/%E7%AC%AC%E4%BA%8C%E7%AB%A0%E2%80%94%E2%80%94%E4%BC%81%E4%B8%9A%E9%83%A8%E7%BD%B2%E5%AE%9E%E6%88%98_K8S.md#k8s%E5%89%8D%E7%BD%AE%E5%B7%A5%E4%BD%9C%E9%83%A8%E7%BD%B2harbor%E4%BB%93%E5%BA%93\">K8Så‰ç½®å·¥ä½œâ€”â€”éƒ¨ç½²harborä»“åº“</a>\n  <li><a href=\"https://github.com/ben1234560/k8s_PaaS/blob/master/%E7%AC%AC%E4%BA%8C%E7%AB%A0%E2%80%94%E2%80%94%E4%BC%81%E4%B8%9A%E9%83%A8%E7%BD%B2%E5%AE%9E%E6%88%98_K8S.md#%E5%AE%89%E8%A3%85%E9%83%A8%E7%BD%B2%E4%B8%BB%E6%8E%A7%E8%8A%82%E7%82%B9%E6%9C%8D%E5%8A%A1etcd\">å®‰è£…éƒ¨ç½²ä¸»æ§èŠ‚ç‚¹æœåŠ¡etcd</a>\n  <li><a href=\"https://github.com/ben1234560/k8s_PaaS/blob/master/%E7%AC%AC%E4%BA%8C%E7%AB%A0%E2%80%94%E2%80%94%E4%BC%81%E4%B8%9A%E9%83%A8%E7%BD%B2%E5%AE%9E%E6%88%98_K8S.md#%E9%83%A8%E7%BD%B2api-server%E9%9B%86%E7%BE%A4\">éƒ¨ç½²API-serveré›†ç¾¤</a>\n  <li><a href=\"https://github.com/ben1234560/k8s_PaaS/blob/master/%E7%AC%AC%E4%BA%8C%E7%AB%A0%E2%80%94%E2%80%94%E4%BC%81%E4%B8%9A%E9%83%A8%E7%BD%B2%E5%AE%9E%E6%88%98_K8S.md#%E5%AE%89%E8%A3%85%E9%83%A8%E7%BD%B2%E4%B8%BB%E6%8E%A7%E8%8A%82%E7%82%B9l4%E5%8F%8D%E4%BB%A3%E6%9C%8D%E5%8A%A1\">å®‰è£…éƒ¨ç½²ä¸»æ§èŠ‚ç‚¹L4åä»£æœåŠ¡</a>\n  <li><a href=\"https://github.com/ben1234560/k8s_PaaS/blob/master/%E7%AC%AC%E4%BA%8C%E7%AB%A0%E2%80%94%E2%80%94%E4%BC%81%E4%B8%9A%E9%83%A8%E7%BD%B2%E5%AE%9E%E6%88%98_K8S.md#%E5%AE%89%E8%A3%85%E9%83%A8%E7%BD%B2controller-manager%E8%8A%82%E7%82%B9%E6%8E%A7%E5%88%B6%E5%99%A8%E8%B0%83%E5%BA%A6%E5%99%A8%E6%9C%8D%E5%8A%A1\">å®‰è£…éƒ¨ç½²controller-managerï¼ˆèŠ‚ç‚¹æ§åˆ¶å™¨/è°ƒåº¦å™¨æœåŠ¡ï¼‰</a>\n  <li><a href=\"https://github.com/ben1234560/k8s_PaaS/blob/master/%E7%AC%AC%E4%BA%8C%E7%AB%A0%E2%80%94%E2%80%94%E4%BC%81%E4%B8%9A%E9%83%A8%E7%BD%B2%E5%AE%9E%E6%88%98_K8S.md#%E5%AE%89%E8%A3%85%E9%83%A8%E7%BD%B2%E8%BF%90%E7%AE%97%E8%8A%82%E7%82%B9%E6%9C%8D%E5%8A%A1kubelet\">å®‰è£…éƒ¨ç½²è¿ç®—èŠ‚ç‚¹æœåŠ¡</a>\n</ul>\n    <li><a href=\"https://github.com/ben1234560/k8s_PaaS/blob/master/%E7%AC%AC%E4%B8%89%E7%AB%A0%E2%80%94%E2%80%94k8s%E9%9B%86%E7%BE%A4.md\">ç¬¬ä¸‰ç« â€”â€”k8sé›†ç¾¤</a>\n    <ul>\n        <li><a href=\"https://github.com/ben1234560/k8s_PaaS/blob/master/%E7%AC%AC%E4%B8%89%E7%AB%A0%E2%80%94%E2%80%94k8s%E9%9B%86%E7%BE%A4.md#%E5%AE%89%E8%A3%85%E9%83%A8%E7%BD%B2flanneld\">å®‰è£…éƒ¨ç½²flanneld</a>\n      <li><a href=\"https://github.com/ben1234560/k8s_PaaS/blob/master/%E7%AC%AC%E4%B8%89%E7%AB%A0%E2%80%94%E2%80%94k8s%E9%9B%86%E7%BE%A4.md#flannel%E4%B9%8Bsnat%E8%A7%84%E5%88%99%E4%BC%98%E5%8C%96\">flannelä¹‹SNATè§„åˆ™ä¼˜åŒ–</a>\n      <li><a href=\"https://github.com/ben1234560/k8s_PaaS/blob/master/%E7%AC%AC%E4%B8%89%E7%AB%A0%E2%80%94%E2%80%94k8s%E9%9B%86%E7%BE%A4.md#%E5%AE%89%E8%A3%85%E9%83%A8%E7%BD%B2coredns%E6%9C%8D%E5%8A%A1%E5%8F%91%E7%8E%B0\">å®‰è£…éƒ¨ç½²corednsï¼ˆæœåŠ¡å‘ç°ï¼‰</a>\n      <li><a href=\"https://github.com/ben1234560/k8s_PaaS/blob/master/%E7%AC%AC%E4%B8%89%E7%AB%A0%E2%80%94%E2%80%94k8s%E9%9B%86%E7%BE%A4.md#k8s%E7%9A%84%E6%9C%8D%E5%8A%A1%E6%9A%B4%E9%9C%B2ingress\">K8Sçš„æœåŠ¡æš´éœ²ingress</a>\n    </ul>\n  </li>\n  <li><a href=\"https://github.com/ben1234560/k8s_PaaS/blob/master/%E7%AC%AC%E5%9B%9B%E7%AB%A0%E2%80%94%E2%80%94dashboard%E6%8F%92%E4%BB%B6%E5%8F%8Ak8s%E5%AE%9E%E6%88%98%E4%BA%A4%E4%BB%98.md\">ç¬¬å››ç« â€”â€”dashboardæ’ä»¶åŠk8så®æˆ˜äº¤ä»˜</a>\n    <ul>\n        <li><a href=\"https://github.com/ben1234560/k8s_PaaS/blob/master/%E7%AC%AC%E5%9B%9B%E7%AB%A0%E2%80%94%E2%80%94dashboard%E6%8F%92%E4%BB%B6%E5%8F%8Ak8s%E5%AE%9E%E6%88%98%E4%BA%A4%E4%BB%98.md#dashboard%E5%AE%89%E8%A3%85%E9%83%A8%E7%BD%B2\">dashboardå®‰è£…éƒ¨ç½²</a>\n      <li><a href=\"https://github.com/ben1234560/k8s_PaaS/blob/master/%E7%AC%AC%E5%9B%9B%E7%AB%A0%E2%80%94%E2%80%94dashboard%E6%8F%92%E4%BB%B6%E5%8F%8Ak8s%E5%AE%9E%E6%88%98%E4%BA%A4%E4%BB%98.md#k8s%E4%BB%AA%E8%A1%A8%E7%9B%98%E9%89%B4%E6%9D%83\">K8Sä»ªè¡¨ç›˜é‰´æƒ</a>\n      <li><a href=\"https://github.com/ben1234560/k8s_PaaS/blob/master/%E7%AC%AC%E5%9B%9B%E7%AB%A0%E2%80%94%E2%80%94dashboard%E6%8F%92%E4%BB%B6%E5%8F%8Ak8s%E5%AE%9E%E6%88%98%E4%BA%A4%E4%BB%98.md#dashboardheapster%E5%8F%AF%E4%B8%8D%E5%81%9A\">dashboardâ€”â€”heapster</a>\n      <li><a href=\"https://github.com/ben1234560/k8s_PaaS/blob/master/%E7%AC%AC%E5%9B%9B%E7%AB%A0%E2%80%94%E2%80%94dashboard%E6%8F%92%E4%BB%B6%E5%8F%8Ak8s%E5%AE%9E%E6%88%98%E4%BA%A4%E4%BB%98.md#k8s%E5%B9%B3%E6%BB%91%E5%8D%87%E7%BA%A7%E6%8A%80%E5%B7%A7\">K8Så¹³æ»‘å‡çº§æŠ€å·§</a>\n    </ul>\n  </li>\n  <li><a href=\"https://github.com/ben1234560/k8s_PaaS/blob/master/%E7%AC%AC%E4%BA%94%E7%AB%A0%E2%80%94%E2%80%94K8S%E7%BB%93%E5%90%88CI%26CD%E6%8C%81%E7%BB%AD%E4%BA%A4%E4%BB%98%E5%92%8C%E9%9B%86%E4%B8%AD%E7%AE%A1%E7%90%86%E9%85%8D%E7%BD%AE.md\">ç¬¬äº”ç« â€”â€”K8Sç»“åˆCI&CDæŒç»­äº¤ä»˜å’Œé›†ä¸­ç®¡ç†é…ç½®</a>\n    <ul>\n        <li><a href=\"https://github.com/ben1234560/k8s_PaaS/blob/master/%E7%AC%AC%E4%BA%94%E7%AB%A0%E2%80%94%E2%80%94K8S%E7%BB%93%E5%90%88CI%26CD%E6%8C%81%E7%BB%AD%E4%BA%A4%E4%BB%98%E5%92%8C%E9%9B%86%E4%B8%AD%E7%AE%A1%E7%90%86%E9%85%8D%E7%BD%AE.md#%E5%AE%89%E8%A3%85%E9%83%A8%E7%BD%B2zookeeper\">å®‰è£…éƒ¨ç½²zookeeper</a>\n        <li><a href=\"https://github.com/ben1234560/k8s_PaaS/blob/master/%E7%AC%AC%E4%BA%94%E7%AB%A0%E2%80%94%E2%80%94K8S%E7%BB%93%E5%90%88CI%26CD%E6%8C%81%E7%BB%AD%E4%BA%A4%E4%BB%98%E5%92%8C%E9%9B%86%E4%B8%AD%E7%AE%A1%E7%90%86%E9%85%8D%E7%BD%AE.md#%E5%AE%89%E8%A3%85%E9%83%A8%E7%BD%B2jenkins\">å®‰è£…éƒ¨ç½²Jenkins</a>\n        <li><a href=\"https://github.com/ben1234560/k8s_PaaS/blob/master/%E7%AC%AC%E4%BA%94%E7%AB%A0%E2%80%94%E2%80%94K8S%E7%BB%93%E5%90%88CI%26CD%E6%8C%81%E7%BB%AD%E4%BA%A4%E4%BB%98%E5%92%8C%E9%9B%86%E4%B8%AD%E7%AE%A1%E7%90%86%E9%85%8D%E7%BD%AE.md#%E5%AE%89%E8%A3%85maven\">å®‰è£…maven</a>\n        <li><a href=\"https://github.com/ben1234560/k8s_PaaS/blob/master/%E7%AC%AC%E4%BA%94%E7%AB%A0%E2%80%94%E2%80%94K8S%E7%BB%93%E5%90%88CI%26CD%E6%8C%81%E7%BB%AD%E4%BA%A4%E4%BB%98%E5%92%8C%E9%9B%86%E4%B8%AD%E7%AE%A1%E7%90%86%E9%85%8D%E7%BD%AE.md#%E5%88%B6%E4%BD%9Cdubbo%E5%BE%AE%E6%9C%8D%E5%8A%A1%E7%9A%84%E5%BA%95%E5%8C%85%E9%95%9C%E5%83%8F\">åˆ¶ä½œdubboå¾®æœåŠ¡çš„åº•åŒ…é•œåƒ</a>\n        <li><a href=\"https://github.com/ben1234560/k8s_PaaS/blob/master/%E7%AC%AC%E4%BA%94%E7%AB%A0%E2%80%94%E2%80%94K8S%E7%BB%93%E5%90%88CI%26CD%E6%8C%81%E7%BB%AD%E4%BA%A4%E4%BB%98%E5%92%8C%E9%9B%86%E4%B8%AD%E7%AE%A1%E7%90%86%E9%85%8D%E7%BD%AE.md#%E4%BD%BF%E7%94%A8jenkins%E6%8C%81%E7%BB%AD%E6%9E%84%E5%BB%BA%E4%BA%A4%E4%BB%98dubbo%E6%9C%8D%E5%8A%A1%E7%9A%84%E6%8F%90%E4%BE%9B%E8%80%85\">ä½¿ç”¨JenkinsæŒç»­æ„å»ºäº¤ä»˜dubboæœåŠ¡çš„æä¾›è€…</a>\n        <li><a href=\"https://github.com/ben1234560/k8s_PaaS/blob/master/%E7%AC%AC%E4%BA%94%E7%AB%A0%E2%80%94%E2%80%94K8S%E7%BB%93%E5%90%88CI%26CD%E6%8C%81%E7%BB%AD%E4%BA%A4%E4%BB%98%E5%92%8C%E9%9B%86%E4%B8%AD%E7%AE%A1%E7%90%86%E9%85%8D%E7%BD%AE.md#%E5%80%9F%E5%8A%A9blueocean%E6%8F%92%E4%BB%B6%E5%9B%9E%E9%A1%BEjenkins%E6%B5%81%E6%B0%B4%E7%BA%BF%E6%9E%84%E5%BB%BA%E5%8E%9F%E7%90%86\">å€ŸåŠ©BlueOceanæ’ä»¶å›é¡¾Jenkinsæµæ°´çº¿æ„å»ºåŸç†</a>\n        <li><a href=\"https://github.com/ben1234560/k8s_PaaS/blob/master/%E7%AC%AC%E4%BA%94%E7%AB%A0%E2%80%94%E2%80%94K8S%E7%BB%93%E5%90%88CI%26CD%E6%8C%81%E7%BB%AD%E4%BA%A4%E4%BB%98%E5%92%8C%E9%9B%86%E4%B8%AD%E7%AE%A1%E7%90%86%E9%85%8D%E7%BD%AE.md#%E4%BA%A4%E4%BB%98dubbo-monitor%E5%88%B0k8s%E9%9B%86%E7%BE%A4\">äº¤ä»˜dubbo-monitoråˆ°k8sé›†ç¾¤</a>\n        <li><a href=\"https://github.com/ben1234560/k8s_PaaS/blob/master/%E7%AC%AC%E4%BA%94%E7%AB%A0%E2%80%94%E2%80%94K8S%E7%BB%93%E5%90%88CI%26CD%E6%8C%81%E7%BB%AD%E4%BA%A4%E4%BB%98%E5%92%8C%E9%9B%86%E4%B8%AD%E7%AE%A1%E7%90%86%E9%85%8D%E7%BD%AE.md#%E5%AE%9E%E7%8E%B0dubbo%E9%9B%86%E7%BE%A4%E7%9A%84%E6%97%A5%E5%B8%B8%E7%BB%B4%E6%8A%A4\">å®ç°dubboé›†ç¾¤çš„æ—¥å¸¸ç»´æŠ¤</a>\n        <li><a href=\"https://github.com/ben1234560/k8s_PaaS/blob/master/%E7%AC%AC%E4%BA%94%E7%AB%A0%E2%80%94%E2%80%94K8S%E7%BB%93%E5%90%88CI%26CD%E6%8C%81%E7%BB%AD%E4%BA%A4%E4%BB%98%E5%92%8C%E9%9B%86%E4%B8%AD%E7%AE%A1%E7%90%86%E9%85%8D%E7%BD%AE.md#%E5%AE%9E%E6%88%98k8s%E9%9B%86%E7%BE%A4%E6%AF%81%E7%81%AD%E6%80%A7%E6%B5%8B%E8%AF%95\">å®æˆ˜K8Sé›†ç¾¤æ¯ç­æ€§æµ‹è¯•</a>\n    </ul>\n  </li>\n  <li><a href=\"https://github.com/ben1234560/k8s_PaaS/blob/master/%E7%AC%AC%E5%85%AD%E7%AB%A0%E2%80%94%E2%80%94%E5%9C%A8K8S%E4%B8%AD%E9%9B%86%E6%88%90Apollo%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83.md\">ç¬¬å…­ç« â€”â€”åœ¨K8Sä¸­é›†æˆApolloé…ç½®ä¸­å¿ƒ</a>\n    <ul>\n      <li><a href=\"https://github.com/ben1234560/k8s_PaaS/blob/master/%E7%AC%AC%E5%85%AD%E7%AB%A0%E2%80%94%E2%80%94%E5%9C%A8K8S%E4%B8%AD%E9%9B%86%E6%88%90Apollo%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83.md#configmap%E4%BD%BF%E7%94%A8%E8%AF%A6%E8%A7%A3\">configmapä½¿ç”¨è¯¦è§£</a>\n      <li><a href=\"https://github.com/ben1234560/k8s_PaaS/blob/master/%E7%AC%AC%E5%85%AD%E7%AB%A0%E2%80%94%E2%80%94%E5%9C%A8K8S%E4%B8%AD%E9%9B%86%E6%88%90Apollo%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83.md#%E4%BA%A4%E4%BB%98apollo-configservice%E5%88%B0k8s\">äº¤ä»˜Apollo-ConfigServiceåˆ°K8S</a>\n      <li><a href=\"https://github.com/ben1234560/k8s_PaaS/blob/master/%E7%AC%AC%E5%85%AD%E7%AB%A0%E2%80%94%E2%80%94%E5%9C%A8K8S%E4%B8%AD%E9%9B%86%E6%88%90Apollo%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83.md#apollo-configservice%E8%BF%9E%E6%8E%A5%E6%95%B0%E6%8D%AE%E5%BA%93ip%E5%88%86%E6%9E%90\">Apollo-ConfigServiceè¿æ¥æ•°æ®åº“IPåˆ†æ</a>\n      <li><a href=\"https://github.com/ben1234560/k8s_PaaS/blob/master/%E7%AC%AC%E5%85%AD%E7%AB%A0%E2%80%94%E2%80%94%E5%9C%A8K8S%E4%B8%AD%E9%9B%86%E6%88%90Apollo%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83.md#%E4%BA%A4%E4%BB%98apollo-portal%E5%89%8D%E6%95%B0%E6%8D%AE%E5%BA%93%E5%88%9D%E5%A7%8B%E5%8C%96\">äº¤ä»˜Apollo-Portalå‰ï¼Œæ•°æ®åº“åˆå§‹åŒ–</a>\n      <li><a href=\"https://github.com/ben1234560/k8s_PaaS/blob/master/%E7%AC%AC%E5%85%AD%E7%AB%A0%E2%80%94%E2%80%94%E5%9C%A8K8S%E4%B8%AD%E9%9B%86%E6%88%90Apollo%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83.md#%E5%88%B6%E4%BD%9Cportal%E7%9A%84docker%E9%95%9C%E5%83%8F%E5%B9%B6%E4%BA%A4%E4%BB%98\">åˆ¶ä½œPortalçš„dockeré•œåƒï¼Œå¹¶äº¤ä»˜</a>\n      <li><a href=\"https://github.com/ben1234560/k8s_PaaS/blob/master/%E7%AC%AC%E5%85%AD%E7%AB%A0%E2%80%94%E2%80%94%E5%9C%A8K8S%E4%B8%AD%E9%9B%86%E6%88%90Apollo%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83.md#dubbo%E6%9C%8D%E5%8A%A1%E6%8F%90%E4%BE%9B%E8%80%85%E8%BF%9E%E6%8E%A5apollo%E5%AE%9E%E6%88%98\">dubboæœåŠ¡æä¾›è€…è¿æ¥Apolloå®æˆ˜</a>\n      <li><a href=\"https://github.com/ben1234560/k8s_PaaS/blob/master/%E7%AC%AC%E5%85%AD%E7%AB%A0%E2%80%94%E2%80%94%E5%9C%A8K8S%E4%B8%AD%E9%9B%86%E6%88%90Apollo%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83.md#dubbo%E6%9C%8D%E5%8A%A1%E6%B6%88%E8%B4%B9%E8%80%85%E8%BF%9E%E6%8E%A5apollo%E5%AE%9E%E6%88%98\">dubboæœåŠ¡æ¶ˆè´¹è€…è¿æ¥Apolloå®æˆ˜</a>\n      <li><a href=\"https://github.com/ben1234560/k8s_PaaS/blob/master/%E7%AC%AC%E5%85%AD%E7%AB%A0%E2%80%94%E2%80%94%E5%9C%A8K8S%E4%B8%AD%E9%9B%86%E6%88%90Apollo%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83.md#%E5%AE%9E%E6%88%98apollo%E5%88%86%E7%8E%AF%E5%A2%83%E7%AE%A1%E7%90%86dubbo%E6%9C%8D%E5%8A%A1-%E4%BA%A4%E4%BB%98apollo-configservice\">å®æˆ˜Apolloåˆ†ç¯å¢ƒç®¡ç†dubboæœåŠ¡-äº¤ä»˜Apollo-configservice</a>\n      <li><a href=\"https://github.com/ben1234560/k8s_PaaS/blob/master/%E7%AC%AC%E5%85%AD%E7%AB%A0%E2%80%94%E2%80%94%E5%9C%A8K8S%E4%B8%AD%E9%9B%86%E6%88%90Apollo%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83.md#%E5%AE%9E%E6%88%98%E4%BD%BF%E7%94%A8apollo%E5%88%86%E7%8E%AF%E5%A2%83%E7%AE%A1%E7%90%86dubbo%E6%9C%8D%E5%8A%A1%E4%BA%A4%E4%BB%98apollo-portal%E5%92%8Cadminservice\">å®æˆ˜ä½¿ç”¨Apolloåˆ†ç¯å¢ƒç®¡ç†dubboæœåŠ¡â€”â€”äº¤ä»˜Apollo-portalå’Œadminservice</a>\n      <li><a href=\"https://github.com/ben1234560/k8s_PaaS/blob/master/%E7%AC%AC%E5%85%AD%E7%AB%A0%E2%80%94%E2%80%94%E5%9C%A8K8S%E4%B8%AD%E9%9B%86%E6%88%90Apollo%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83.md#%E5%AE%9E%E6%88%98%E5%8F%91%E5%B8%83dubbo%E8%BF%9E%E6%8E%A5apollo%E5%88%B0%E4%B8%8D%E5%90%8C%E7%8E%AF%E5%A2%83\">å®æˆ˜å‘å¸ƒdubboè¿æ¥Apolloåˆ°ä¸åŒç¯å¢ƒ</a>\n      <li><a href=\"https://github.com/ben1234560/k8s_PaaS/blob/master/%E7%AC%AC%E5%85%AD%E7%AB%A0%E2%80%94%E2%80%94%E5%9C%A8K8S%E4%B8%AD%E9%9B%86%E6%88%90Apollo%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83.md#%E5%AE%9E%E6%88%98%E6%BC%94%E7%A4%BA%E9%A1%B9%E7%9B%AE%E6%8F%90%E6%B5%8B%E5%8F%91%E7%89%88%E6%B5%81%E7%A8%8B\">å®æˆ˜æ¼”ç¤ºé¡¹ç›®ææµ‹ï¼Œå‘ç‰ˆæµç¨‹</a>\n    </ul>\n  </li>\n  <li><a href=\"https://github.com/ben1234560/k8s_PaaS/blob/master/%E7%AC%AC%E4%B8%83%E7%AB%A0%E2%80%94%E2%80%94Promtheus%E7%9B%91%E6%8E%A7k8s%E4%BC%81%E4%B8%9A%E7%BA%A7%E5%BA%94%E7%94%A8.md\">ç¬¬ä¸ƒç« â€”â€”Promtheusç›‘æ§k8sä¼ä¸šçº§åº”ç”¨</a>\n    <ul>\n      <li><a href=\"https://github.com/ben1234560/k8s_PaaS/blob/master/%E7%AC%AC%E4%B8%83%E7%AB%A0%E2%80%94%E2%80%94Promtheus%E7%9B%91%E6%8E%A7k8s%E4%BC%81%E4%B8%9A%E7%BA%A7%E5%BA%94%E7%94%A8.md#prometheus%E7%9B%91%E6%8E%A7%E8%BD%AF%E4%BB%B6%E6%A6%82%E8%BF%B0\">Prometheusç›‘æ§è½¯ä»¶æ¦‚è¿°</a>\n      <li><a href=\"https://github.com/ben1234560/k8s_PaaS/blob/master/%E7%AC%AC%E4%B8%83%E7%AB%A0%E2%80%94%E2%80%94Promtheus%E7%9B%91%E6%8E%A7k8s%E4%BC%81%E4%B8%9A%E7%BA%A7%E5%BA%94%E7%94%A8.md#%E4%BA%A4%E4%BB%98kube-state-metric\">äº¤ä»˜kube-state-metric</a>\n      <li><a href=\"https://github.com/ben1234560/k8s_PaaS/blob/master/%E7%AC%AC%E4%B8%83%E7%AB%A0%E2%80%94%E2%80%94Promtheus%E7%9B%91%E6%8E%A7k8s%E4%BC%81%E4%B8%9A%E7%BA%A7%E5%BA%94%E7%94%A8.md#%E4%BA%A4%E4%BB%98node-exporter\">äº¤ä»˜node-exporter</a>\n      <li><a href=\"https://github.com/ben1234560/k8s_PaaS/blob/master/%E7%AC%AC%E4%B8%83%E7%AB%A0%E2%80%94%E2%80%94Promtheus%E7%9B%91%E6%8E%A7k8s%E4%BC%81%E4%B8%9A%E7%BA%A7%E5%BA%94%E7%94%A8.md#%E4%BA%A4%E4%BB%98cadvisor\">äº¤ä»˜cadvisor</a>\n      <li><a href=\"https://github.com/ben1234560/k8s_PaaS/blob/master/%E7%AC%AC%E4%B8%83%E7%AB%A0%E2%80%94%E2%80%94Promtheus%E7%9B%91%E6%8E%A7k8s%E4%BC%81%E4%B8%9A%E7%BA%A7%E5%BA%94%E7%94%A8.md#%E4%BA%A4%E4%BB%98blackbox-exporter\">äº¤ä»˜blackbox-exporter</a>\n      <li><a href=\"https://github.com/ben1234560/k8s_PaaS/blob/master/%E7%AC%AC%E4%B8%83%E7%AB%A0%E2%80%94%E2%80%94Promtheus%E7%9B%91%E6%8E%A7k8s%E4%BC%81%E4%B8%9A%E7%BA%A7%E5%BA%94%E7%94%A8.md#%E5%AE%89%E8%A3%85%E9%83%A8%E7%BD%B2prometheus-server\">å®‰è£…éƒ¨ç½²Prometheus-server</a>\n      <li><a href=\"https://github.com/ben1234560/k8s_PaaS/blob/master/%E7%AC%AC%E4%B8%83%E7%AB%A0%E2%80%94%E2%80%94Promtheus%E7%9B%91%E6%8E%A7k8s%E4%BC%81%E4%B8%9A%E7%BA%A7%E5%BA%94%E7%94%A8.md#%E9%85%8D%E7%BD%AEprometheus%E7%9B%91%E6%8E%A7%E4%B8%9A%E5%8A%A1%E5%AE%B9%E5%99%A8\">é…ç½®Prometheusç›‘æ§ä¸šåŠ¡å®¹å™¨</a>\n      <li><a href=\"https://github.com/ben1234560/k8s_PaaS/blob/master/%E7%AC%AC%E4%B8%83%E7%AB%A0%E2%80%94%E2%80%94Promtheus%E7%9B%91%E6%8E%A7k8s%E4%BC%81%E4%B8%9A%E7%BA%A7%E5%BA%94%E7%94%A8.md#%E5%AE%89%E8%A3%85%E9%83%A8%E7%BD%B2%E9%85%8D%E7%BD%AEgrafana\">å®‰è£…éƒ¨ç½²é…ç½®Grafana</a>\n      <li><a href=\"https://github.com/ben1234560/k8s_PaaS/blob/master/%E7%AC%AC%E4%B8%83%E7%AB%A0%E2%80%94%E2%80%94Promtheus%E7%9B%91%E6%8E%A7k8s%E4%BC%81%E4%B8%9A%E7%BA%A7%E5%BA%94%E7%94%A8.md#%E5%AE%89%E8%A3%85%E9%83%A8%E7%BD%B2alertmanager\">å®‰è£…éƒ¨ç½²alertmanager</a>\n      <li><a href=\"https://github.com/ben1234560/k8s_PaaS/blob/master/%E7%AC%AC%E4%B8%83%E7%AB%A0%E2%80%94%E2%80%94Promtheus%E7%9B%91%E6%8E%A7k8s%E4%BC%81%E4%B8%9A%E7%BA%A7%E5%BA%94%E7%94%A8.md#%E6%B5%8B%E8%AF%95alertmanager%E6%8A%A5%E8%AD%A6%E5%8A%9F%E8%83%BD\">æµ‹è¯•alertmanageræŠ¥è­¦åŠŸèƒ½</a>\n      <li><a href=\"https://github.com/ben1234560/k8s_PaaS/blob/master/%E7%AC%AC%E4%B8%83%E7%AB%A0%E2%80%94%E2%80%94Promtheus%E7%9B%91%E6%8E%A7k8s%E4%BC%81%E4%B8%9A%E7%BA%A7%E5%BA%94%E7%94%A8.md#%E9%80%9A%E8%BF%87k8s%E9%83%A8%E7%BD%B2dubbo%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%8E%A5%E5%85%A5elk%E6%9E%B6%E6%9E%84\">é€šè¿‡K8Séƒ¨ç½²dubboå¾®æœåŠ¡æ¥å…¥ELKæ¶æ„</a>\n      <li><a href=\"https://github.com/ben1234560/k8s_PaaS/blob/master/%E7%AC%AC%E4%B8%83%E7%AB%A0%E2%80%94%E2%80%94Promtheus%E7%9B%91%E6%8E%A7k8s%E4%BC%81%E4%B8%9A%E7%BA%A7%E5%BA%94%E7%94%A8.md#%E5%88%B6%E4%BD%9Ctomcat%E5%AE%B9%E5%99%A8%E7%9A%84%E5%BA%95%E5%8C%85%E9%95%9C%E5%83%8F\">åˆ¶ä½œtomcatå®¹å™¨çš„åº•åŒ…é•œåƒ</a>\n      <li><a href=\"https://github.com/ben1234560/k8s_PaaS/blob/master/%E7%AC%AC%E4%B8%83%E7%AB%A0%E2%80%94%E2%80%94Promtheus%E7%9B%91%E6%8E%A7k8s%E4%BC%81%E4%B8%9A%E7%BA%A7%E5%BA%94%E7%94%A8.md#%E4%BA%A4%E4%BB%98tomcat%E5%BD%A2%E5%BC%8F%E7%9A%84dubbo%E6%9C%8D%E5%8A%A1%E6%B6%88%E8%B4%B9%E8%80%85%E5%88%B0k8s%E9%9B%86%E7%BE%A4\">äº¤ä»˜tomcatå½¢å¼çš„dubboæœåŠ¡æ¶ˆè´¹è€…åˆ°K8Sé›†ç¾¤</a>\n      <li><a href=\"https://github.com/ben1234560/k8s_PaaS/blob/master/%E7%AC%AC%E4%B8%83%E7%AB%A0%E2%80%94%E2%80%94Promtheus%E7%9B%91%E6%8E%A7k8s%E4%BC%81%E4%B8%9A%E7%BA%A7%E5%BA%94%E7%94%A8.md#%E4%BA%8C%E8%BF%9B%E5%88%B6%E5%AE%89%E8%A3%85%E9%83%A8%E7%BD%B2elasticsearch\">äºŒè¿›åˆ¶å®‰è£…éƒ¨ç½²elasticsearch</a>\n      <li><a href=\"https://github.com/ben1234560/k8s_PaaS/blob/master/%E7%AC%AC%E4%B8%83%E7%AB%A0%E2%80%94%E2%80%94Promtheus%E7%9B%91%E6%8E%A7k8s%E4%BC%81%E4%B8%9A%E7%BA%A7%E5%BA%94%E7%94%A8.md#%E5%AE%89%E8%A3%85%E9%83%A8%E7%BD%B2kafka%E5%92%8Ckafka-manager\">å®‰è£…éƒ¨ç½²kafkaå’Œkafka-manager</a>\n      <li><a href=\"https://github.com/ben1234560/k8s_PaaS/blob/master/%E7%AC%AC%E4%B8%83%E7%AB%A0%E2%80%94%E2%80%94Promtheus%E7%9B%91%E6%8E%A7k8s%E4%BC%81%E4%B8%9A%E7%BA%A7%E5%BA%94%E7%94%A8.md#%E5%88%B6%E4%BD%9Cfilebeat%E5%BA%95%E5%8C%85%E5%B9%B6%E6%8E%A5%E5%85%A5dubbo%E6%9C%8D%E5%8A%A1%E6%B6%88%E8%B4%B9%E8%80%85\">åˆ¶ä½œfilebeatåº•åŒ…å¹¶æ¥å…¥dubboæœåŠ¡æ¶ˆè´¹è€…</a>\n      <li><a href=\"https://github.com/ben1234560/k8s_PaaS/blob/master/%E7%AC%AC%E4%B8%83%E7%AB%A0%E2%80%94%E2%80%94Promtheus%E7%9B%91%E6%8E%A7k8s%E4%BC%81%E4%B8%9A%E7%BA%A7%E5%BA%94%E7%94%A8.md#%E9%83%A8%E7%BD%B2logstash%E9%95%9C%E5%83%8F\">éƒ¨ç½²logstashé•œåƒ</a>\n      <li><a href=\"https://github.com/ben1234560/k8s_PaaS/blob/master/%E7%AC%AC%E4%B8%83%E7%AB%A0%E2%80%94%E2%80%94Promtheus%E7%9B%91%E6%8E%A7k8s%E4%BC%81%E4%B8%9A%E7%BA%A7%E5%BA%94%E7%94%A8.md#%E4%BA%A4%E4%BB%98kibana%E5%88%B0k8s%E9%9B%86%E7%BE%A4\">äº¤ä»˜kibanaåˆ°K8Sé›†ç¾¤</a>\n      <li><a href=\"https://github.com/ben1234560/k8s_PaaS/blob/master/%E7%AC%AC%E4%B8%83%E7%AB%A0%E2%80%94%E2%80%94Promtheus%E7%9B%91%E6%8E%A7k8s%E4%BC%81%E4%B8%9A%E7%BA%A7%E5%BA%94%E7%94%A8.md#%E8%AF%A6%E8%A7%A3kibana%E7%94%9F%E4%BA%A7%E5%AE%9E%E8%B7%B5%E6%96%B9%E6%B3%95\">è¯¦è§£Kibanaç”Ÿäº§å®è·µæ–¹æ³•</a>\n    </ul>\n  </li>\n  <li><a href=\"https://github.com/ben1234560/k8s_PaaS/blob/master/%E7%AC%AC%E5%85%AB%E7%AB%A0%E2%80%94%E2%80%94spinnaker%E9%83%A8%E7%BD%B2%E4%B8%8E%E5%BA%94%E7%94%A8.md\">ç¬¬å…«ç« â€”â€”spinakeréƒ¨ç½²ä¸åº”ç”¨</a>\n    <ul>\n      <li><a href=\"https://github.com/ben1234560/k8s_PaaS/blob/master/%E7%AC%AC%E5%85%AB%E7%AB%A0%E2%80%94%E2%80%94spinnaker%E9%83%A8%E7%BD%B2%E4%B8%8E%E5%BA%94%E7%94%A8.md#%E9%83%A8%E7%BD%B2spinnaker%E7%9A%84amory%E5%8F%91%E8%A1%8C%E7%89%88\">éƒ¨ç½²Spinnakerçš„Amoryå‘è¡Œç‰ˆ</a>\n      <li><a href=\"https://github.com/ben1234560/k8s_PaaS/blob/master/%E7%AC%AC%E5%85%AB%E7%AB%A0%E2%80%94%E2%80%94spinnaker%E9%83%A8%E7%BD%B2%E4%B8%8E%E5%BA%94%E7%94%A8.md#%E5%AE%89%E8%A3%85%E9%83%A8%E7%BD%B2redis\">å®‰è£…éƒ¨ç½²redis</a>\n      <li><a href=\"https://github.com/ben1234560/k8s_PaaS/blob/master/%E7%AC%AC%E5%85%AB%E7%AB%A0%E2%80%94%E2%80%94spinnaker%E9%83%A8%E7%BD%B2%E4%B8%8E%E5%BA%94%E7%94%A8.md#%E5%AE%89%E8%A3%85%E9%83%A8%E7%BD%B2clouddriver\">å®‰è£…éƒ¨ç½²clouddriver</a>\n      <li><a href=\"https://github.com/ben1234560/k8s_PaaS/blob/master/%E7%AC%AC%E5%85%AB%E7%AB%A0%E2%80%94%E2%80%94spinnaker%E9%83%A8%E7%BD%B2%E4%B8%8E%E5%BA%94%E7%94%A8.md#%E5%AE%89%E8%A3%85%E9%83%A8%E7%BD%B2spinnaker%E5%85%B6%E4%BD%99%E7%BB%84%E4%BB%B6\">å®‰è£…éƒ¨ç½²spinnakerå…¶ä½™ç»„ä»¶</a>\n      <li><a href=\"https://github.com/ben1234560/k8s_PaaS/blob/master/%E7%AC%AC%E5%85%AB%E7%AB%A0%E2%80%94%E2%80%94spinnaker%E9%83%A8%E7%BD%B2%E4%B8%8E%E5%BA%94%E7%94%A8.md#%E4%BD%BF%E7%94%A8spinnaker%E7%BB%93%E5%90%88jenkins%E6%9E%84%E5%BB%BA%E9%95%9C%E5%83%8F\">ä½¿ç”¨spinnakerç»“åˆJenkinsæ„å»ºé•œåƒ</a>\n      <li><a href=\"https://github.com/ben1234560/k8s_PaaS/blob/master/%E7%AC%AC%E5%85%AB%E7%AB%A0%E2%80%94%E2%80%94spinnaker%E9%83%A8%E7%BD%B2%E4%B8%8E%E5%BA%94%E7%94%A8.md#%E4%BD%BF%E7%94%A8spinnaker%E9%85%8D%E7%BD%AEdubbo%E6%9C%8D%E5%8A%A1%E6%8F%90%E4%BE%9B%E8%80%85%E5%8F%91%E5%B8%83%E8%87%B3k8s\">ä½¿ç”¨spinnakeré…ç½®dubboæœåŠ¡æä¾›è€…å‘å¸ƒè‡³K8S</a>\n      <li><a href=\"https://github.com/ben1234560/k8s_PaaS/blob/master/%E7%AC%AC%E5%85%AB%E7%AB%A0%E2%80%94%E2%80%94spinnaker%E9%83%A8%E7%BD%B2%E4%B8%8E%E5%BA%94%E7%94%A8.md#%E4%BD%BF%E7%94%A8spinnaker%E9%85%8D%E7%BD%AEdubbo%E6%9C%8D%E5%8A%A1%E6%B6%88%E8%B4%B9%E8%80%85%E5%88%B0k8s\">ä½¿ç”¨spinnakeré…ç½®dubboæœåŠ¡æ¶ˆè´¹è€…åˆ°K8S</a>\n      <li><a href=\"https://github.com/ben1234560/k8s_PaaS/blob/master/%E7%AC%AC%E5%85%AB%E7%AB%A0%E2%80%94%E2%80%94spinnaker%E9%83%A8%E7%BD%B2%E4%B8%8E%E5%BA%94%E7%94%A8.md#%E6%A8%A1%E6%8B%9F%E7%94%9F%E4%BA%A7%E4%B8%8A%E4%BB%A3%E7%A0%81%E8%BF%AD%E4%BB%A3\">æ¨¡æ‹Ÿç”Ÿäº§ä¸Šä»£ç è¿­ä»£</a>\n    </ul>\n  </li>\n  <li><a href=\"https://github.com/ben1234560/k8s_PaaS/blob/master/%E7%BB%88%E7%AB%A0%E2%80%94%E2%80%94%E5%B8%B8%E7%94%A8%E6%93%8D%E4%BD%9C%E5%91%BD%E4%BB%A4%E5%8F%8A%E7%9B%B8%E5%85%B3%E6%96%B9%E6%A1%88.md\">ç»ˆç« â€”â€”å¸¸ç”¨æ“ä½œå‘½ä»¤åŠç›¸å…³æ–¹æ¡ˆ</a>\n  </li>\n</ul>\n\n\n\n\n##### èµ„æ–™å‚è€ƒï¼š\n\n[æ·±å…¥å‰–ækubernetes](https://time.geekbang.org/column/intro/116)ä¹Ÿå¯ä»¥[å…è´¹ä¸‹è½½ï¼ˆåœ¨Dockerç« èŠ‚æœ€ä¸‹é¢ï¼‰](https://github.com/ben1234560/k8s_PaaS/blob/master/%E7%AC%AC%E4%B8%80%E7%AB%A0%E2%80%94%E2%80%94Docker%EF%BC%88%E5%B7%B2%E7%86%9F%E6%82%89%E7%9A%84%E5%8F%AF%E4%BB%A5%E4%BB%8E%E7%AC%AC%E4%BA%8C%E7%AB%A0%E5%BC%80%E5%A7%8B%EF%BC%89.md#docker%E9%83%A8%E5%88%86%E5%AE%8C%E7%BB%93)\n\n[è€ç”·å­©æ•™è‚²K8Så®¹å™¨äº‘æ¶æ„å¸ˆ1æœŸ](https://www.luffycity.com/home)\n\n## äº’åŠ©ç¾¤\n\nQQç¾¤å·ï¼š676040917ï¼ˆç¾¤æœªå›çš„ï¼Œè¯·ä¸€å®šè¦æIssuesæˆ–è€…å‘é‚®ä»¶ç»™ä½œè€…ï¼‰\n\n<div align='left'>\n    <img src=\"assets/1637049717005.png\" alt=\"qq_group\" style=\"max-width: 100%;\">\n</div>\nç¾¤å†…ç¦æ­¢ä¸€åˆ‡å¹¿å‘Šï¼Œåªä¸ºè§£å†³é—®é¢˜è€Œå­˜åœ¨ã€‚\n\n\n\n## è´¡çŒ®è€…\n\næ¬¢è¿å‚ä¸è´¡çŒ®å’Œå®Œå–„å†…å®¹ï¼Œè´¡çŒ®æ–¹æ³•å‚è€ƒ[CONTRIBUTING](https://github.com/ben1234560/k8s_PaaS/blob/master/CONTRIBUTING.md)ã€‚æ„Ÿè°¢æ‰€æœ‰çš„è´¡çŒ®è€…ï¼Œè´¡çŒ®åˆ—è¡¨è§[contributors](https://github.com/ben1234560/k8s_PaaS/graphs/contributors)ã€‚\n\nå¦å¤–ï¼Œæ„Ÿè°¢ä¸€ç›´åœ¨ç¾¤é‡Œæä¾›å»ºè®®å’Œè§£ç­”çš„ä¼™ä¼´ä»¬ï¼Œæ„Ÿè°¢å¤§å®¶æ— ç§çš„å¼€æºç²¾ç¥ğŸ‘ğŸ‘ğŸ‘\n\n\n\n## è¯´æ˜\n\n<a href=\"https://hellogithub.com/repository/f6b4d10a91384d2ca6cd6285a9d3bc60\" target=\"_blank\"><img src=\"https://api.hellogithub.com/v1/widgets/recommend.svg?rid=f6b4d10a91384d2ca6cd6285a9d3bc60&claim_uid=2jDLrGaINM0CKfO\" alt=\"Featuredï½œHelloGitHub\" style=\"width: 250px; height: 54px;\" width=\"250\" height=\"54\" /></a>\n\n<p> æœ¬ä¸“é¢˜å¹¶ä¸ç”¨äºå•†ä¸šç”¨é€”ï¼Œè½¬è½½è¯·æ³¨æ˜æœ¬ä¸“é¢˜åœ°å€ï¼Œå¦‚æœ‰ä¾µæƒï¼Œè¯·åŠ¡å¿…é‚®ä»¶é€šçŸ¥ä½œè€…ã€‚\n<p> æœ¬äººæ°´å¹³æœ‰é™ï¼Œæ–‡å­—ä»£ç éš¾å…æœ‰é—æ¼é”™è¯¯çš„åœ°æ–¹ï¼Œæœ›ä¸åèµæ•™ï¼Œä¸‡åˆ†æ„Ÿè°¢ã€‚\n<p> Emailï¼š909336740@qq.com\n<p> PSï¼šçœ‹åˆ°ç‚¹èµå¾ˆå¼€å¿ƒï¼Œè°¢è°¢ğŸ˜Š\n\n"
        },
        {
          "name": "assets",
          "type": "tree",
          "content": null
        },
        {
          "name": "åŸç†åŠæºç è§£æ",
          "type": "tree",
          "content": null
        },
        {
          "name": "ç¬¬ä¸€ç« â€”â€”Dockerï¼ˆå·²ç†Ÿæ‚‰çš„å¯ä»¥ä»ç¬¬äºŒç« å¼€å§‹ï¼‰.md",
          "type": "blob",
          "size": 13.33203125,
          "content": "## ç¬¬ä¸€ç« â€”â€”Dockerï¼ˆå·²ç†Ÿæ‚‰çš„å¯ä»¥ä»ç¬¬äºŒç« å¼€å§‹ï¼‰\n\n### å®‰è£…Docker\n\n> **WHAT**ï¼šå¯ä»¥è®©å¼€å‘è€…æ‰“åŒ…ä»–ä»¬çš„åº”ç”¨ä»¥åŠä¾èµ–åŒ…åˆ°ä¸€ä¸ªè½»é‡çº§ã€å¯ç§»æ¤çš„å®¹å™¨ä¸­ï¼Œç„¶åå‘å¸ƒåˆ°ä»»ä½•æµè¡Œçš„ Linux æœºå™¨ä¸Šï¼Œä¹Ÿå¯ä»¥å®ç°è™šæ‹ŸåŒ–ï¼Œä¸‰ä¸ªæ ¸å¿ƒæ¦‚å¿µï¼šé•œåƒã€å®¹å™¨ã€ä»“åº“\n>\n> - å¿«é€Ÿï¼Œä¸€è‡´åœ°äº¤ä»˜æ‚¨çš„åº”ç”¨ç¨‹åº\n>   - å…è®¸å¼€å‘äººå‘˜ä½¿ç”¨æ‚¨æä¾›çš„åº”ç”¨ç¨‹åºæˆ–æœåŠ¡çš„æœ¬åœ°å®¹å™¨åœ¨æ ‡å‡†åŒ–ç¯å¢ƒä¸­å·¥ä½œï¼Œä»è€Œç®€åŒ–äº†å¼€å‘çš„ç”Ÿå‘½å‘¨æœŸ\n> - å“åº”å¼éƒ¨ç½²å’Œæ‰©å±•\n>   - åŸºäºå®¹å™¨çš„å¹³å°ï¼Œå…è®¸é«˜åº¦å¯ç§»æ¤çš„å·¥ä½œè´Ÿè½½ï¼Œå¯ç§»æ¤æ€§å’Œè½»é‡çº§çš„ç‰¹æ€§ï¼Œå®æ—¶æ‰©å±•æˆ–æ‹†é™¤åº”ç”¨ç¨‹åºå’ŒæœåŠ¡\n> - åœ¨åŒä¸€ç¡¬ä»¶ä¸Šè¿è¡Œæ›´å¤šå·¥ä½œè´Ÿè½½\n>   - éå¸¸é€‚åˆäºé«˜å¯†åº¦ç¯å¢ƒä»¥åŠä¸­å°å‹éƒ¨ç½²ï¼Œè€Œæ‚¨å¯ä»¥ç”¨æ›´å°‘çš„èµ„æºåšæ›´å¤šçš„äº‹æƒ…\n> - è¿™é‡Œæ¨èæˆ‘è®¤ä¸ºè®²çš„å¾ˆä¸é”™çš„ä¸€ç¯‡æ–‡ç« https://blog.csdn.net/deng624796905/article/details/86493330\n>\n> **WHY**ï¼šdockerçš„ä¸€ä¸ªæ ¸å¿ƒå°±æ˜¯å®¹å™¨ï¼ˆæ²™ç®±ï¼‰ï¼Œåœ¨å¼€å‘ç¯å¢ƒå¼€å‘çš„ä»£ç ï¼Œåˆ°æµ‹è¯•ç¯å¢ƒéœ€è¦è°ƒæ•´ï¼Œåˆ°é¢„ç”Ÿäº§ç¯å¢ƒä¹Ÿéœ€è¦è°ƒæ•´ï¼Œåˆ°ç”Ÿäº§ç¯å¢ƒæ›´åŠ éœ€è¦è°ƒæ•´ï¼Œè€Œæˆ‘ä»¬æƒ³è¦çš„æ˜¯ä¸€æ¬¡éƒ¨ç½²åˆ°å¤„è¿è¡Œï¼Œè¿™å°±æ˜¯ä¸ºä»€ä¹ˆä½¿ç”¨dockerã€‚\n>\n> **åŸç†/æºç è§£æ**ï¼š[å®¹å™¨æ˜¯æ€ä¹ˆéš”ç¦»çš„](https://github.com/ben1234560/k8s_PaaS/blob/master/%E5%8E%9F%E7%90%86%E5%8F%8A%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/Docker%E5%9F%BA%E7%A1%80.md#%E5%AE%B9%E5%99%A8%E6%98%AF%E6%80%8E%E4%B9%88%E9%9A%94%E7%A6%BB%E7%9A%84)\n>\n> æ¨èä¹¦ç±ï¼šæ·±å…¥å‰–ækubernetesï¼ˆä¹¦ç±ï¼‰ï¼Œä½ ä¹Ÿå¯ä»¥å»ä¸‹è½½å…è´¹çš„https://pan.baidu.com/s/1gWAQUVsqs1AdMPvRuaEtNA æå–ç ï¼šq0ht\n\nç¯å¢ƒï¼šcentos7.6ï¼Œ2æ ¸2Gå†…å­˜ï¼ˆ1C2Gå³å¯ï¼‰\n\n> å¦‚æœä½ éœ€è¦7.6çš„é•œåƒå’Œxshellå¯ä»¥å»ç½‘ä¸Šä¸‹è½½æˆ–è€…æˆ‘æä¾›çš„åŒ…https://pan.baidu.com/s/1mkIzua1XQmew240XBbvuFA æå–ç ï¼š7p6hã€‚å½“ç„¶å¦‚æœä½ ä¸‹è½½7.6é•œåƒåŒ…æ¯”è¾ƒæ…¢ï¼Œæƒ³å…ˆä¸Šæ‰‹åšä¸€ä¸‹ï¼Œå¯ä»¥è”ç³»æˆ‘QQï¼š909336740å¼€ä¸€ä¸ª**å…è´¹**çš„æœåŠ¡å™¨ï¼ˆäººæ•°è¿‡å¤šï¼Œå·²æ— ï¼‰\n\n~~~\n# æŸ¥çœ‹æœºå™¨ä¿¡æ¯ï¼Œå†…æ ¸ç‰ˆæœ¬å¿…é¡»æ˜¯3.8ä»¥ä¸Š\n~]# uname -a\n#outï¼š Linux VM_0_5_centos 3.10.0-957.21.3.el7.x86_64 #1 SMP Tue Jun 18 16:35:19 UTC 2019 x86_64 x86_64 x86_64 GNU/Linux\n~]# cat /etc/redhat-release \n#outï¼š CentOS Linux release 7.6.1810 (Core) \n# å…³é—­é˜²ç«å¢™\n~]# getenforce\n#outï¼š Disabled\n~]# systemctl stop firewalld\n# æŸ¥çœ‹å†…å­˜å¤§å°\n~]# free -m\n~~~\n\n> **uname**ï¼šå¯æ˜¾ç¤ºç”µè„‘åŠæ“ä½œç³»ç»Ÿçš„ç›¸å…³ä¿¡æ¯ï¼Œ-a/-allï¼šæ˜¾ç¤ºå…¨éƒ¨ä¿¡æ¯\n>\n> **cat**ï¼šç”¨äºè¿æ¥æ–‡ä»¶å¹¶æ‰“å°å†…å®¹åˆ°é¡µé¢ï¼ˆæ‰“å°æœ‰ä¸¤ç§æƒ…å†µï¼Œä¸€ç§æ˜¯æ— æ‰§è¡Œå†…å®¹æ‰€ä»¥å°±æ˜¯æŸ¥çœ‹ï¼Œæœ‰æ‰§è¡Œå†…å®¹åˆ™å˜æˆæ‰§è¡Œé‡Œé¢çš„å†…å®¹ï¼‰\n>\n> **getenforce**ï¼šæŸ¥çœ‹é˜²ç«å¢™ä¿¡æ¯ï¼ŒDisabledä¸ºå…³é—­æ¨¡å¼\n>\n> **systemctl**ï¼šç”¨äºç®¡ç†ç³»ç»Ÿï¼Œstopï¼šåœæ­¢æŸä¸ªæœåŠ¡\n>\n> **free**ï¼šç”¨äºæ˜¾ç¤ºå†…å­˜çŠ¶æ€ï¼Œ-mï¼šä»¥MBä¸ºå•ä½æ˜¾ç¤ºå†…å­˜ä½¿ç”¨æƒ…å†µ\n\n![1578539634672](assets/1578539634672.png)\n\n~~~\n# æŸ¥çœ‹ç½‘ç»œï¼Œå¹¶å®‰è£…å¿…è¦ç»„ä»¶\n~]# ping baidu.com\n# æ³¨æ„ï¼Œä½ çš„æœ¬åœ°æºå¾—æ˜¯åˆ æ‰çš„ï¼Œä¸€èˆ¬æ˜¯æ²¡æœ‰çš„\n# rm /etc/yum.repos.d/local.repo\n~]#curl -o /etc/yum.repos.d/CentOS-Base.repo http://mirrors.aliyun.com/repo/Centos-7.repo\n~]# yum install epel-release -y\n# å®‰è£…dockeråŒ…\n~]# yum list docker --show-duplicates\n~]# yum install -y yum-utils\n~]# yum-config-manager --add-repo http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo\n~]# yum list docker-ce --show-duplicates\n~]# yum install -y docker-ce\n#outï¼š...Complete!\n~~~\n\n> **ping**ï¼šæ‰§è¡ŒpingæŒ‡ä»¤ä¼šä½¿ç”¨ICMPä¼ è¾“åè®®ï¼Œå‘å‡ºè¦æ±‚å›åº”çš„ä¿¡æ¯ï¼Œè‹¥è¿œç«¯ä¸»æœºçš„ç½‘ç»œåŠŸèƒ½æ²¡æœ‰é—®é¢˜ï¼Œå°±ä¼šå›åº”è¯¥ä¿¡æ¯ï¼Œå› è€Œå¾—çŸ¥è¯¥ä¸»æœºè¿ä½œæ­£å¸¸\n>\n> **rm** ï¼šå‘½ä»¤ç”¨äºåˆ é™¤ä¸€ä¸ªæ–‡ä»¶æˆ–è€…ç›®å½•ã€‚\n>\n> **curl**ï¼šæ”¯æŒæ–‡ä»¶çš„ä¸Šä¼ å’Œä¸‹è½½ï¼Œæ˜¯ç»¼åˆä¼ è¾“å·¥å…·\n>\n> **yum**ï¼šæä¾›äº†æŸ¥æ‰¾ã€å®‰è£…ã€åˆ é™¤æŸä¸€ä¸ªã€ä¸€ç»„ç”šè‡³å…¨éƒ¨è½¯ä»¶åŒ…çš„å‘½ä»¤ï¼Œ\n>\n> - **install**ï¼šå®‰è£…\n>\n> - **-y**ï¼šå®‰è£…è¿‡ç¨‹çš„æç¤ºé€‰æ‹©å…¨éƒ¨ä¸º\"yes\"\n\n![1578540090773](assets/1578540090773.png)\n\n~~~\n# è®¾ä¸ºå¼€æœºå¯åŠ¨ï¼Œå¯åŠ¨å¹¶ä¿®æ”¹ç›¸å…³é…ç½®\n~]# systemctl enable docker\n~]# systemctl start docker\n~]# vi /etc/docker/daemon.json\n{\n  \"data-root\": \"/data/docker\",\n  \"storage-driver\": \"overlay2\",\n  \"insecure-registries\": [\"registry.access.redhat.com\",\"quay.io\"],\n  \"registry-mirrors\": [\"https://q2gr04ke.mirror.aliyuncs.com\"],\n  \"bip\": \"172.7.5.1/24\",\n  \"exec-opts\": [\"native.cgroupdriver=systemd\"],\n  \"live-restore\": true\n}\n\n# é‡å¯dockerè®©é…ç½®ç”Ÿæ•ˆ\n~]# systemctl reset-failed docker.service\n~]# systemctl start docker.service\n~]# systemctl restart docker\n# å¦‚æœå¤±è´¥äº†ï¼Œsystemctl status dockeræŸ¥çœ‹æŠ¥é”™ä¿¡æ¯\n~]# docker info\n~~~\n\n> **daemon.json**æ–‡ä»¶å†…å®¹è§£æï¼š\n>\n> - graphï¼šdockerçš„å·¥ä½œç›®å½•ï¼Œdockerä¼šåœ¨ä¸‹é¢ç”Ÿæˆä¸€å¤§å †æ–‡ä»¶\n> - storage-driverï¼š å­˜å‚¨é©±åŠ¨\n> - insecure-registriesï¼šç§æœ‰ä»“åº“\n> - registry-mirrorsï¼šå›½å†…åŠ é€Ÿæº\n> - bipï¼šdockerå®¹å™¨åœ°å€ï¼ˆipçš„ä¸­é—´ä¸¤ä½å’Œæˆ‘ç°åœ¨çš„å¤–ç½‘129.204.217.99çš„åä¸¤ä½æœ‰å¯¹ç…§å…³ç³»ï¼Œæ–¹ä¾¿å‡ºé—®é¢˜äº†å¿«é€Ÿå®šä½åœ¨å“ªä¸ªå®¿ä¸»æœºï¼Œä½†æ˜¯æˆ‘è¿™é‡Œæ²¡æ”¹ï¼‰\n> - live-restroreï¼šå®¹å™¨å¼•æ“æ­»æ‰çš„äº‹æƒ…ï¼Œèµ·æ¥çš„dockeræ˜¯å¦ç»§ç»­æ´»ç€\n>\n> systemctl statusï¼šæŸ¥çœ‹æœåŠ¡ä¿¡æ¯\n>\n> docker infoï¼šæŸ¥çœ‹dockerä¿¡æ¯\n\nå®Œæˆ\n\n\n\n### å¼€å¯æˆ‘ä»¬çš„ç¬¬ä¸€ä¸ªdockerå®¹å™¨\n\n~~~\n~]# docker run hello-world\n# dockeræ˜¯å…¸å‹çš„CSæ¶æ„\n~~~\n\n> **docker run**ï¼šåˆ›å»ºä¸€ä¸ªæ–°çš„å®¹å™¨å¹¶è¿è¡Œï¼Œç°åœ¨æœ¬åœ°æ˜¯æ²¡æœ‰é•œåƒçš„ï¼Œä½†æ˜¯å®ƒä¼šè‡ªåŠ¨æ‹‰å–ç½‘ä¸Šçš„ï¼Œå¦‚ä¸‹å›¾ï¼š\n>\n> - è¯­æ³•ï¼šdocker run [OPTIONS] IMAGE [COMMAND] [ARG...]\n\n![1578550425609](assets/1578550425609.png)\n\n![1578550749282](assets/1578550749282.png)\n\n> ä¸Šå›¾ä¸ºdockerå®¹å™¨å’Œæœ¬åœ°ä»“åº“ã€è¿œç¨‹ä»“åº“çš„å…³ç³»\n\n~~~\né•œåƒå¸¸è§„ç»“æ„å¦‚ä¸‹ï¼š\n${registry_name}/${repository_name}/${image_name}:${tag_name}\nä¾‹å¦‚ï¼š\ndocker.io/library/alipine:3.10.1\n~~~\n\nå®Œæˆ\n\n\n\n### Dockerhubæ³¨å†Œï¼ˆè‡ªå·±çš„è¿œç¨‹ä»“åº“ï¼‰\n\n![1578551639317](assets/1578551639317.png)\n\n~~~\n# ç™»å½•ä½ çš„è¿œç¨‹ä»“åº“\n~]# docker login docker.io\n# ä½ çš„ç™»å½•ä¿¡æ¯åœ¨è¿™é‡Œ\n~]# cat /root/.docker/config.json\n~~~\n\n> å¤ä¹ ï¼š\n>\n> - catï¼šç”¨äºè¿æ¥æ–‡ä»¶å¹¶æ‰“å°å†…å®¹åˆ°é¡µé¢\n\n![1578551787380](assets/1578551787380.png)\n\nå®Œæˆ\n\n\n\n### Dockeré•œåƒç®¡ç†å®æˆ˜\n\n~~~\n~]# docker search alpine\n~]# docker pull alpine\n~]# docker pull alpine:3.10.3\n~]# docker pull alpine:3.10.1\n~~~\n\n> **docker pull**ï¼šä»é•œåƒä»“åº“ä¸­æ‹‰å–æˆ–è€…æ›´æ–°æŒ‡å®šé•œåƒ\n>\n> - è¯­æ³•ï¼š**docker pull [OPTIONS] NAME[:TAG|@DIGEST]**\n\n![1578551972565](assets/1578551972565.png)\n\n![1578552027321](assets/1578552027321.png)\n\n~~~\n~]# docker images\n~]# docker image ls\n~]# docker tag 965ea09ff2eb docker.io/909336740/alpine:v3.10.3\n~~~\n\n> **docker images/docker image ls :** åˆ—å‡ºæœ¬åœ°é•œåƒ\n>\n> **docker tag**ï¼šæ ‡è®°æœ¬åœ°é•œåƒï¼Œå°†å…¶å½’å…¥æŸä¸€ä»“åº“\n>\n> - è¯­æ³•ï¼šdocker tag [OPTIONS] IMAGE[:TAG] [REGISTRYHOST/][USERNAME/]NAME[:TAG]\n\n![1578552367676](assets/1578552367676.png)\n\n~~~\n~]# docker push docker.io/909336740/alpine:v3.10.3\n~~~\n\n> **docker push**ï¼šå°†æœ¬åœ°çš„é•œåƒä¸Šä¼ åˆ°é•œåƒä»“åº“,è¦å…ˆç™»é™†åˆ°é•œåƒä»“åº“ï¼Œå¸¦ç‰ˆæœ¬å·\n>\n> - è¯­æ³•ï¼šdocker push [OPTIONS] NAME[:TAG]\n\n~~~\n~]# docker rmi 965ea09ff2eb\n~]# docker rmi -f 965ea09ff2eb\n# docker pull 909336740/alpine æ‹‰å–è‡ªå·±è¿œç¨‹ä»“åº“é•œåƒ\n~~~\n\n> **docker rmi**ï¼šåˆ é™¤æœ¬åœ°ä¸€ä¸ªæˆ–å¤šä¸ªé•œåƒ\n>\n> - **-f**ï¼šå¼ºåˆ¶åˆ é™¤\n\n![1578552844322](assets/1578552844322.png)\n\n![1578553221639](assets/1578553221639.png)\n\n~~~\n# é•œåƒä¸ç®¡å¤šå¤§ï¼Œå®é™…çº¿ä¸Šåªä¼šæ”¹å˜å˜åŠ¨çš„éƒ¨åˆ†ï¼Œå¹¶ä¸ä¼šå…¨éƒ¨æ›¿æ¢ï¼Œæ‰€ä»¥ä¸éœ€è¦æ‹…å¿ƒé€Ÿåº¦é—®é¢˜ï¼Œåªæœ‰é¦–æ¬¡æ¯”è¾ƒæ…¢\n~~~\n\nå®Œæˆ\n\n\n\n### dockerå®¹å™¨åŸºæœ¬æ“ä½œ\n\n~~~\n# å…¨éƒ¨æœ‰è®°å½•çš„å®¹å™¨è¿›ç¨‹\n~]# docker ps -a\n# å­˜æ´»çš„å®¹å™¨è¿›ç¨‹\n~]# docker ps\n# å¯åŠ¨å®¹å™¨ï¼ˆè¿è¡Œå®¹å™¨ï¼‰\n~]# docker run [options] image[command]\n# è¿‡æ»¤å‡ºå…¨éƒ¨å·²ç»é€€å‡ºçš„å®¹å™¨å¹¶åˆ æ‰\n~]# for i in `docker ps -a|grep -i exit|awk '{print $1}'`;do docker rm -f $i;done\n# æŸ¥çœ‹æ—¥å¿—ï¼Œ-fï¼šè·Ÿè¸ªæ—¥å¿—è¾“å‡ºï¼Œå³æ˜¯å¤¯ä½ï¼Œå¯ä»¥æŒ‰ctrl+c\n~]# docker logs -f <å®¹å™¨id>\n~~~\n\n> **Ctrl+c:** å¼ºåˆ¶ä¸­æ–­ç¨‹åºçš„æ‰§è¡Œ\n>\n> **Ctrl+z:** å°†ä»»åŠ¡ä¸­æ–­,ä½†æ˜¯æ­¤ä»»åŠ¡å¹¶æ²¡æœ‰ç»“æŸ,ä»–ä»ç„¶åœ¨è¿›ç¨‹ä¸­ä»–åªæ˜¯ç»´æŒæŒ‚èµ·çš„çŠ¶æ€\n\n### dockerå®¹å™¨é«˜çº§æ“ä½œ\n\næ˜ å°„ç«¯å£\n\n- docker run -p å®¹å™¨å¤–ç«¯å£:å®¹å™¨å†…ç«¯å£\n\næŒ‚è½½æ•°æ®å·\n\n- docker run -v å®¹å™¨å¤–ç›®å½•:å®¹å™¨å†…ç›®å½•\n\nä¼ é€’ç¯å¢ƒå˜é‡\n\n- docker run -e ç¯å¢ƒå˜é‡key:ç¯å¢ƒå˜é‡value\n\næŸ¥çœ‹å†…å®¹\n\n- docker inspect <å®¹å™¨id>\n\nå®¹å™¨å†…å®‰è£…è½¯ä»¶ï¼ˆå·¥å…·ï¼‰\n\n- yum/apt-get/aptç­‰\n\n~~~\n# æ˜ å°„ç«¯å£\n~]# docker pull nginx:1.12.2\n~]# docker images\n~]# docker tag 4037a5562b03 909336740/nginx:v1.12.2\n~]# docker push 909336740/nginx:v1.12.2\n~]# docker images\n~]# docker run --rm --name mynginx -d -p81:80 909336740/nginx:v1.12.2\n# æŸ¥çœ‹æ˜¯å¦èµ·æ¥äº†\n~]# docker ps -a \n~]# netstat -luntp|grep 81\n~]# curl 127.0.0.1:81\n~]# docker \n~~~\n\n> **docker run**: \n>\n> - **--rm** ï¼šç”¨å®Œå³åˆ \n> - **--name**ï¼šæŒ‡å®šåå­—\n> - **-d**ï¼šæ”¾åˆ°åå°ï¼Œéäº¤äº’å¼çš„\n> - **-p81:80**ï¼šæ˜ å°„ç«¯å£ï¼Œå®¿ä¸»æœºè·‘81ç«¯å£ï¼Œå®¹å™¨ï¼ˆnginxï¼‰è·‘80ç«¯å£\n>\n> **docker push**ï¼šæ¨é€åˆ°æˆ‘ä»¬çš„è¿œç¨‹ä»“åº“ï¼ˆå…¬ç½‘ï¼‰\n>\n> **netstat -luntp**ï¼šç”¨äºæ˜¾ç¤º tcp,udp çš„ç«¯å£å’Œè¿›ç¨‹ç­‰ç›¸å…³æƒ…å†µ\n>\n> **|grep**ï¼šè¿‡æ»¤ç®¡é“\n\n~~~\n# æŒ‚è½½æ•°æ®å·\n~]# mkdir html\n~]# cd html/\nhtml]# wget www.baidu.com -O index.html\n~]# docker run -d --rm --name nginx_with_baidu -d -p82:80 -v/root/html:/usr/share/nginx/html 909336740/nginx:v1.12.2\n~]# docker exec -ti nginx_with_baidu /bin/bash\n:/# cd /usr/share/nginx/htm/\n:/htm# ls\n# out: index.html\n:/# curl\n# out:bash: curl:command not found\n:/# tee /etc/apt/sources.list << EOF\ndeb http://mirrors.163.com/debian/ jessie main non-free contrib\ndeb http://mirrors.163.com/debian/ jessie-updates main non-free contrib\nEOF\n:/# apt-get update && apt-get install curl -y\n:/# curl -k https://www.baidu.com\n:/# exit\n~]# docker ps -a\n# æŠŠè¿™ä¸ªå®¹å™¨pushåˆ°è¿œç¨‹ä»åº“ï¼Œåé¢ä¼šç”¨åˆ°\n~]# docker commit -p 60c24fa9c6ff 909336740/nginx:curl\n~]# docker push 909336740/nginx:curl\n~~~\n\n> **-v**ï¼šæŒ‚è½½æ•°æ®å·ï¼Œ/root/htmlä¸ºå®¿ä¸»æœºçš„æ•°æ®å·ï¼Œ/usr/share...ä¸ºå®¹å™¨çš„æ•°æ®å·\n\n![1582086653233](assets/1582086653233.png)\n\n![1578558054990](assets/1578558054990.png)\n\nå®Œæˆ\n\n\n\n### dockerfile\n\n> **WHAT**ï¼šé€šè¿‡æŒ‡ä»¤ç¼–æ’é•œåƒï¼Œå¸®ä½ è‡ªåŠ¨åŒ–çš„æ„å»ºé•œåƒ\n\n4ç»„æ ¸å¿ƒçš„DockerfileæŒ‡ä»¤\n\n- USER/WORKDIRæŒ‡ä»¤\n- ADD/EXPOSEæŒ‡ä»¤\n- RUN/ENVæŒ‡ä»¤\n- CMD/ENTRYPOINTæŒ‡ä»¤\n\n### dockerfile ç»¼åˆå®éªŒ\n\n> è¿è¡Œä¸€ä¸ªdockerå®¹å™¨ï¼Œåœ¨æµè§ˆå™¨æ‰“å¼€demo.od.comèƒ½è®¿é—®ç™¾åº¦é¦–é¡µ\n\n~~~\n\n~]# mkdir /data/dockerfile\n~]# vi /data/dockerfile/Dockerfile\nFROM 909336740/nginx:v1.12.2\nUSER root\nENV WWW /usr/share/nginx/html\nENV CONF /etc/nginx/conf.d\nRUN /bin/cp /usr/share/zoneinfo/Asia/Shanghai /etc/localtime &&\\ \n    echo 'Asia/Shanghai' >/etc/timezone\nWORKDIR $WWW\nADD index.html $WWW/index.html\nADD demo.od.com.conf $CONF/demo.od.com.conf\nEXPOSE 80\nCMD [\"nginx\",\"-g\",\"daemon off;\"]\n~~~\n\n> **vi**: ç¼–è¾‘æ–‡æœ¬\n>\n> **FROM**ï¼šä»å“ªé‡Œå¯¼å…¥\n>\n> **USER**ï¼šç”¨ä»€ä¹ˆç”¨æˆ·èµ·\n>\n> **ENV**ï¼šè®¾ç½®ç¯å¢ƒå˜é‡\n>\n> **RUN**ï¼š ä¿®æ”¹æ—¶åŒºæˆä¸­å›½æ—¶åŒº'Asia/Shanghai'\n>\n> **WORKDIR**ï¼šæŒ‡å®šå·¥ä½œç›®å½•ï¼Œè¿™é‡ŒæŒ‡å®šçš„æ˜¯ä¹‹å‰ENVæŒ‡å®šçš„WWW ç›®å½•ï¼Œå³æ˜¯/usr/share/nginx/html\n>\n> **ADD**ï¼šæ·»åŠ æŒ‡å®šçš„ä¸œè¥¿è¿›å»\n>\n> **EXPOSE**ï¼šæš´éœ²ç«¯å£\n>\n> **CMD**ï¼šæŒ‡ä»¤çš„é¦–è¦ç›®çš„åœ¨äºä¸ºå¯åŠ¨çš„å®¹å™¨æŒ‡å®šé»˜è®¤è¦è¿è¡Œçš„ç¨‹åºï¼Œç¨‹åºè¿è¡Œç»“æŸï¼Œå®¹å™¨ä¹Ÿå°±ç»“æŸ\n\n~~~\ndockerfile]# vi demo.od.com.conf\nserver {\n   listen 80;\n   server_name demo.od.com;\n\n   root /usr/share/nginx/html;\n}\n\ndockerfile]# ll\ndockerfile]# wget www.baidu.com -O index.html\ndockerfile]# docker build . -t 909336740/nginx:baidu\ndockerfile]# docker run --rm -p80:80 909336740/nginx:baidu\n~~~\n\n> **ll**ï¼šæ˜¾ç¤ºå½“å‰ç›®å½•çš„æ–‡ä»¶\n>\n> **wget**ï¼šä¸‹è½½æ–‡ä»¶å·¥å…·\n>\n> - **-O**ï¼šå¹¶å°†æ–‡æ¡£å†™å…¥åé¢æŒ‡å®šçš„æ–‡ä»¶ï¼ˆè¿™é‡Œæ˜¯index.htmlï¼‰\n\n![1578565889942](assets/1578565889942.png)\n\n![1578564445681](assets/1578564445681.png)\n\n![1578563551095](assets/1578563551095.png)\n\n![1578563657846](assets/1578563657846.png)\n\næ²¡æœ‰ä¿å­˜æƒé™çš„å‚è€ƒè¿™ä¸ªhttps://jingyan.baidu.com/article/624e7459b194f134e8ba5a8e.html\n\nè®¿é—®[demo.od.com](demo.od.com)\n\n![1578564376367](assets/1578564376367.png)\n\nå®Œæˆ\n\n\n\n### dockerfileå››ç§ç½‘ç»œç±»å‹\n\n- Bridge contaunerï¼ˆNATï¼‰   æ¡¥æ¥å¼ç½‘ç»œæ¨¡å¼(é»˜è®¤)\n- None(Close) container   å°é—­å¼ç½‘ç»œæ¨¡å¼ï¼Œä¸ä¸ºå®¹å™¨é…ç½®ç½‘ç»œ\n- Host(open) container   å¼€æ”¾å¼ç½‘ç»œæ¨¡å¼ï¼Œå’Œå®¿ä¸»æœºå…±äº«ç½‘ç»œ\n- Container(join) container   è”åˆæŒ‚è½½å¼ç½‘ç»œæ¨¡å¼ï¼Œå’Œå…¶ä»–å®¹å™¨å…±äº«ç½‘ç»œ\n\n> ç”¨ä»€ä¹ˆç±»å‹çš„ç½‘ç»œè¦æ ¹æ®æˆ‘ä»¬çš„ä¸šåŠ¡å»å†³å®š\n\n\n\n### Dockeréƒ¨åˆ†å®Œç»“\n\n> **åŸç†/æºç è§£æï¼š**\n>\n> - [è™šæ‹Ÿæœºå’Œå®¹å™¨çš„å¯¹æ¯”å›¾](https://github.com/ben1234560/k8s_PaaS/blob/master/%E5%8E%9F%E7%90%86%E5%8F%8A%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/Docker%E5%9F%BA%E7%A1%80.md#%E8%99%9A%E6%8B%9F%E6%9C%BA%E5%92%8C%E5%AE%B9%E5%99%A8%E7%9A%84%E5%AF%B9%E6%AF%94%E5%9B%BE)\n> - [æ·±å…¥ç†è§£å®¹å™¨é•œåƒ](https://github.com/ben1234560/k8s_PaaS/blob/master/%E5%8E%9F%E7%90%86%E5%8F%8A%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/Docker%E5%9F%BA%E7%A1%80.md#%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3%E5%AE%B9%E5%99%A8%E9%95%9C%E5%83%8F)\n\næ­å–œä½ å·²ç»å®Œæˆäº†dockerçš„éƒ¨åˆ†ï¼Œå½“ç„¶ï¼Œä½ ä¹Ÿè®¸è¿˜æ˜¯äº‘é‡Œé›¾é‡Œï¼Œä¸ç”¨æ‹…å¿ƒï¼Œåç»­æˆ‘ä»¬ä¼šç»§ç»­ç”¨åˆ°è¿™äº›å†…å®¹ï¼Œå¦‚æœä½ å¯¹dockerçš„å†å²ã€æºç ç­‰è§£ææœ‰å…´è¶£ï¼Œæ¨èä¹¦ç±ï¼šæ·±å…¥å‰–ækubernetesï¼ˆä¹¦ç±ï¼‰ï¼Œä½ ä¹Ÿå¯ä»¥å»ä¸‹è½½å…è´¹çš„https://pan.baidu.com/s/1gWAQUVsqs1AdMPvRuaEtNA æå–ç ï¼šq0ht\n\n"
        },
        {
          "name": "ç¬¬ä¸ƒç« â€”â€”Promtheusç›‘æ§k8sä¼ä¸šçº§åº”ç”¨.md",
          "type": "blob",
          "size": 82.5546875,
          "content": "## ç¬¬ä¸ƒç« â€”â€”Promtheusç›‘æ§k8sä¼ä¸šçº§åº”ç”¨\n\n##### å‰è¨€ï¼š\n\n> é…ç½®æ˜¯ç‹¬ç«‹äºç¨‹åºçš„å¯é…å˜é‡ï¼ŒåŒä¸€ä»½ç¨‹åºåœ¨ä¸åŒé…ç½®ä¸‹ä¼šæœ‰ä¸åŒçš„è¡Œä¸ºã€‚\n\n##### äº‘åŸç”Ÿï¼ˆCloud Nativeï¼‰ç¨‹åºçš„ç‰¹ç‚¹ï¼š\n\n> - ç¨‹åºçš„é…ç½®ï¼Œé€šè¿‡è®¾ç½®ç¯å¢ƒå˜äº†ä¼ é€’åˆ°å®¹å™¨å†…éƒ¨\n> - ç¨‹åºçš„é…ç½®ï¼Œé€šè¿‡ç¨‹åºå¯åŠ¨å‚æ•°é…ç½®ç”Ÿæ•ˆ\n> - ç¨‹åºçš„é…ç½®ï¼Œé€šè¿‡é›†ä¸­åœ¨é…ç½®ä¸­å¿ƒè¿›è¡Œç»Ÿä¸€æ¢äº†ï¼ˆCRUDï¼‰\n\n##### Devopså·¥ç¨‹å¸ˆåº”è¯¥åšä»€ä¹ˆï¼Ÿ\n\n> - å®¹å™¨åŒ–å…¬å¸è‡ªç ”çš„åº”ç”¨ç¨‹åºï¼ˆé€šè¿‡Dockerè¿›è¡ŒäºŒæ¬¡å°è£…ï¼‰\n> - æ¨åŠ¨å®¹å™¨åŒ–åº”ç”¨ï¼Œè½¬å˜ä¸ºäº‘åŸç”Ÿåº”ç”¨ï¼ˆä¸€æ¬¡æ„å»ºï¼Œåˆ°å¤„ä½¿ç”¨ï¼‰\n> - ä½¿ç”¨å®¹å™¨ç¼–æ’æ¡†æ¶ï¼ˆkubernetesï¼‰ï¼Œåˆç†ã€è§„èŒƒã€ä¸“ä¸šçš„ç¼–æ’ä¸šåŠ¡å®¹å™¨\n\n\n\n### Prometheusç›‘æ§è½¯ä»¶æ¦‚è¿°\n\n> å¼€æºç›‘æ§å‘Šè­¦è§£å†³æ–¹æ¡ˆï¼Œ[æ¨èæ–‡ç« ](https://www.jianshu.com/p/60a50539243a)\n>\n> å½“ç„¶ä¸€æ—¶åŠä¼šä½ å¯èƒ½æ²¡é‚£ä¹ˆå¿«çš„å»ç†è§£ï¼Œé‚£å°±è·Ÿæˆ‘ä»¬å…ˆåšä¸‹å»ä½ å°±ä¼šæ…¢æ…¢ç†è§£ä»€ä¹ˆæ˜¯æ—¶é—´åºåˆ—æ•°æ®\n>\n> [https://github.com/prometheus](https://github.com/prometheus)\n>\n> [https://prometheus.io](https://prometheus.io)\n\n#### Prometheusçš„ç‰¹ç‚¹ï¼š\n\n- å¤šç»´æ•°æ®æ¨¡å‹ï¼šç”±åº¦é‡åç§°å’Œé”®å€¼å¯¹æ ‡è¯†çš„æ—¶é—´åºåˆ—æ•°æ®\n- å†…ç½®æ—¶é—´åºåˆ—æ•°æ®åº“ï¼šTSDB\n- promQLï¼šä¸€ç§çµæ´»çš„æŸ¥è¯¢è¯­è¨€ï¼Œå¯ä»¥åˆ©ç”¨å¤šç»´æ•°æ®å®Œæˆå¤æ‚æŸ¥è¯¢\n- åŸºäºHTTPçš„pullï¼ˆæ‹‰å–ï¼‰æ–¹å¼é‡‡é›†æ—¶é—´åºåˆ—æ•°æ®\n- åŒæ—¶æ”¯æŒPushGatewayç»„ä»¶æ”¶é›†æ•°æ®\n- é€šè¿‡æœåŠ¡å‘ç°æˆ–é™æ€é…ç½®å‘ç°ç›®æ ‡\n- æ”¯æŒä½œä¸ºæ•°æ®æºæ¥å…¥Grafana\n\n##### æˆ‘ä»¬å°†ä½¿ç”¨çš„å®˜æ–¹æ¶æ„å›¾\n\n![1582697010557](assets/1582697010557.png)\n\n> **Prometheus Server**ï¼šæœåŠ¡æ ¸å¿ƒç»„ä»¶ï¼Œé€šè¿‡pull metricsä» Exporter æ‹‰å–å’Œå­˜å‚¨ç›‘æ§æ•°æ®,å¹¶æä¾›ä¸€å¥—çµæ´»çš„æŸ¥è¯¢è¯­è¨€ï¼ˆPromQLï¼‰ã€‚\n>\n> **pushgateway**ï¼šç±»ä¼¼ä¸€ä¸ªä¸­è½¬ç«™ï¼ŒPrometheusçš„serverç«¯åªä¼šä½¿ç”¨pullæ–¹å¼æ‹‰å–æ•°æ®ï¼Œä½†æ˜¯æŸäº›èŠ‚ç‚¹å› ä¸ºæŸäº›åŸå› åªèƒ½ä½¿ç”¨pushæ–¹å¼æ¨é€æ•°æ®ï¼Œé‚£ä¹ˆå®ƒå°±æ˜¯ç”¨æ¥æ¥æ”¶pushè€Œæ¥çš„æ•°æ®å¹¶æš´éœ²ç»™Prometheusçš„serveræ‹‰å–çš„ä¸­è½¬ç«™ï¼Œè¿™é‡Œæˆ‘ä»¬ä¸åšå®ƒã€‚\n>\n> **Exporters/Jobs**ï¼šè´Ÿè´£æ”¶é›†ç›®æ ‡å¯¹è±¡ï¼ˆhost, containerâ€¦ï¼‰çš„æ€§èƒ½æ•°æ®ï¼Œå¹¶é€šè¿‡ HTTP æ¥å£ä¾› Prometheus Server è·å–ã€‚\n>\n> **Service Discovery**ï¼šæœåŠ¡å‘ç°ï¼ŒPrometheusæ”¯æŒå¤šç§æœåŠ¡å‘ç°æœºåˆ¶ï¼šæ–‡ä»¶ï¼ŒDNSï¼ŒConsul,Kubernetes,OpenStack,EC2ç­‰ç­‰ã€‚åŸºäºæœåŠ¡å‘ç°çš„è¿‡ç¨‹å¹¶ä¸å¤æ‚ï¼Œé€šè¿‡ç¬¬ä¸‰æ–¹æä¾›çš„æ¥å£ï¼ŒPrometheusæŸ¥è¯¢åˆ°éœ€è¦ç›‘æ§çš„Targetåˆ—è¡¨ï¼Œç„¶åè½®è®­è¿™äº›Targetè·å–ç›‘æ§æ•°æ®ã€‚\n>\n> **Alertmanager**ï¼šä» Prometheus server ç«¯æ¥æ”¶åˆ° alerts åï¼Œä¼šè¿›è¡Œå»é™¤é‡å¤æ•°æ®ï¼Œåˆ†ç»„ï¼Œå¹¶è·¯ç”±åˆ°å¯¹æ–¹çš„æ¥å—æ–¹å¼ï¼Œå‘å‡ºæŠ¥è­¦ã€‚å¸¸è§çš„æ¥æ”¶æ–¹å¼æœ‰ï¼šç”µå­é‚®ä»¶ï¼Œpagerduty ç­‰ã€‚\n>\n> **UIé¡µé¢çš„ä¸‰ç§æ–¹æ³•**ï¼š\n>\n> - Prometheus web UIï¼šè‡ªå¸¦çš„ï¼ˆä¸æ€ä¹ˆå¥½ç”¨ï¼‰\n> - Grafanaï¼šç¾è§‚ã€å¼ºå¤§çš„å¯è§†åŒ–ç›‘æ§æŒ‡æ ‡å±•ç¤ºå·¥å…· \n> - API clientsï¼šè‡ªå·±å¼€å‘çš„ç›‘æ§å±•ç¤ºå·¥å…·\n>\n> **å·¥ä½œæµç¨‹**ï¼šPrometheus Serverå®šæœŸä»é…ç½®å¥½çš„Exporters/Jobsä¸­æ‹‰metricsï¼Œæˆ–è€…æ¥ç€pushgatewayå‘è¿‡æ¥çš„metricsï¼Œæˆ–è€…å…¶å®ƒçš„metricsï¼Œæ”¶é›†å®Œåè¿è¡Œå®šä¹‰å¥½çš„alert.rulesï¼ˆè¿™ä¸ªæ–‡ä»¶åé¢ä¼šè®²åˆ°ï¼‰ï¼Œè®°å½•æ—¶é—´åºåˆ—æˆ–è€…å‘Alertmanageræ¨é€è­¦æŠ¥ã€‚æ›´å¤šäº†è§£<a href=\"https://github.com/ben1234560/k8s_PaaS/blob/master/%E5%8E%9F%E7%90%86%E5%8F%8A%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/Kubernetes%E7%9B%B8%E5%85%B3%E7%94%9F%E6%80%81.md#prometheusmetrics-server%E4%B8%8Ekubernetes%E7%9B%91%E6%8E%A7%E4%BD%93%E7%B3%BB\">Prometheusã€Metrics Serverä¸Kubernetesç›‘æ§ä½“ç³»</a>\n\n##### å’Œzabbixcå¯¹æ¯”\n\n| Prometheus                                                   | Zabbix                                                       |\n| ------------------------------------------------------------ | ------------------------------------------------------------ |\n| åç«¯ç”¨golangå¼€å‘ï¼ŒK8Sä¹Ÿæ˜¯goå¼€å‘                              | åç«¯ç”¨Cå¼€å‘ï¼Œç•Œé¢ç”¨PHPå¼€å‘                                   |\n| æ›´é€‚åˆäº‘ç¯å¢ƒçš„ç›‘æ§ï¼Œå°¤å…¶æ˜¯å¯¹K8Sæœ‰ç€æ›´å¥½çš„æ”¯æŒ                | æ›´é€‚åˆç›‘æ§ç‰©ç†æœºï¼Œè™šæ‹Ÿæœºç¯å¢ƒ                                 |\n| ç›‘æ§æ•°æ®å­˜å‚¨åœ¨åŸºäºæ—¶é—´åºåˆ—çš„æ•°æ®åº“å†…ï¼Œä¾¿äºå¯¹å·²æœ‰æ•°æ®è¿›è¡Œæ–°çš„èšåˆ | ç›‘æ§æ•°æ®å­˜å‚¨åœ¨å…³ç³»å‹æ•°æ®åº“å†…ï¼Œå¦‚MySQLï¼Œå¾ˆéš¾ä»ç°æœ‰æ•°æ®ä¸­æ‰©å±•ç»´åº¦ |\n| è‡ªèº«ç•Œé¢ç›¸å¯¹è¾ƒå¼±ï¼Œå¾ˆå¤šé…ç½®éœ€è¦ä¿®æ”¹é…ç½®æ–‡ä»¶ï¼Œä½†å¯ä»¥å€Ÿç”±Grafanaå‡ºå›¾ | å›¾å½¢åŒ–ç•Œé¢ç›¸å¯¹æ¯”è¾ƒæˆç†Ÿ                                       |\n| æ”¯æŒæ›´å¤§çš„é›†ç¾¤è§„æ¨¡ï¼Œé€Ÿåº¦ä¹Ÿæ›´å¿«                               | é›†ç¾¤è§„æ¨¡ä¸Šçº¿ä¸º10000ä¸ªèŠ‚ç‚¹                                    |\n| 2015å¹´åå¼€å§‹å¿«é€Ÿå‘å±•ï¼Œç¤¾åŒºæ´»è·ƒï¼Œä½¿ç”¨åœºæ™¯è¶Šæ¥è¶Šå¤š             | å‘å±•å®é™…æ›´é•¿ï¼Œå¯¹äºå¾ˆå¤šç›‘æ§åœºæ™¯ï¼Œéƒ½æœ‰ç°æˆçš„è§£å†³æ–¹æ¡ˆ           |\n\nç”±äºèµ„æºé—®é¢˜ï¼Œæˆ‘å·²ç»æŠŠä¸ç”¨çš„æœåŠ¡å…³æ‰äº†\n\n![1583464421747](assets/1583464421747.png)\n\n![1583464533840](assets/1583464533840.png)\n\n![1583465087708](assets/1583465087708.png)\n\n\n\n### äº¤ä»˜kube-state-metric\n\n> **WHAT**ï¼šä¸ºprometheusé‡‡é›†k8sèµ„æºæ•°æ®çš„exporterï¼Œèƒ½å¤Ÿé‡‡é›†ç»å¤§å¤šæ•°k8så†…ç½®èµ„æºçš„ç›¸å…³æ•°æ®ï¼Œä¾‹å¦‚podã€deployã€serviceç­‰ç­‰ã€‚åŒæ—¶å®ƒä¹Ÿæä¾›è‡ªå·±çš„æ•°æ®ï¼Œä¸»è¦æ˜¯èµ„æºé‡‡é›†ä¸ªæ•°å’Œé‡‡é›†å‘ç”Ÿçš„å¼‚å¸¸æ¬¡æ•°ç»Ÿè®¡\n\nhttps://quay.io/repository/coreos/kube-state-metrics?tab=tags\n\n~~~~\n# 200æœºå™¨ï¼Œä¸‹è½½åŒ…ï¼š\n~]# docker pull quay.io/coreos/kube-state-metrics:v1.5.0\n~]# docker images|grep kube-state\n~]# docker tag 91599517197a harbor.od.com/public/kube-state-metrics:v1.5.0\n~]# docker push harbor.od.com/public/kube-state-metrics:v1.5.0\n~~~~\n\n![1583394715770](assets/1583394715770.png)\n\n~~~~shell\n# 200æœºå™¨ï¼Œå‡†å¤‡èµ„æºé…ç½®æ¸…å•ï¼š\n~]# mkdir /data/k8s-yaml/kube-state-metrics\n~]# cd /data/k8s-yaml/kube-state-metrics\nkube-state-metrics]# vi rbac.yaml\napiVersion: v1\nkind: ServiceAccount\nmetadata:\n  labels:\n    addonmanager.kubernetes.io/mode: Reconcile\n    kubernetes.io/cluster-service: \"true\"\n  name: kube-state-metrics\n  namespace: kube-system\n---\napiVersion: rbac.authorization.k8s.io/v1\nkind: ClusterRole\nmetadata:\n  labels:\n    addonmanager.kubernetes.io/mode: Reconcile\n    kubernetes.io/cluster-service: \"true\"\n  name: kube-state-metrics\nrules:\n- apiGroups:\n  - \"\"\n  resources:\n  - configmaps\n  - secrets\n  - nodes\n  - pods\n  - services\n  - resourcequotas\n  - replicationcontrollers\n  - limitranges\n  - persistentvolumeclaims\n  - persistentvolumes\n  - namespaces\n  - endpoints\n  verbs:\n  - list\n  - watch\n- apiGroups:\n  - policy\n  resources:\n  - poddisruptionbudgets\n  verbs:\n  - list\n  - watch\n- apiGroups:\n  - extensions\n  resources:\n  - daemonsets\n  - deployments\n  - replicasets\n  verbs:\n  - list\n  - watch\n- apiGroups:\n  - apps\n  resources:\n  - statefulsets\n  verbs:\n  - list\n  - watch\n- apiGroups:\n  - batch\n  resources:\n  - cronjobs\n  - jobs\n  verbs:\n  - list\n  - watch\n- apiGroups:\n  - autoscaling\n  resources:\n  - horizontalpodautoscalers\n  verbs:\n  - list\n  - watch\n---\napiVersion: rbac.authorization.k8s.io/v1\nkind: ClusterRoleBinding\nmetadata:\n  labels:\n    addonmanager.kubernetes.io/mode: Reconcile\n    kubernetes.io/cluster-service: \"true\"\n  name: kube-state-metrics\nroleRef:\n  apiGroup: rbac.authorization.k8s.io\n  kind: ClusterRole\n  name: kube-state-metrics\nsubjects:\n- kind: ServiceAccount\n  name: kube-state-metrics\n  namespace: kube-system\n\nkube-state-metrics]# vi dp.yaml\napiVersion: extensions/v1beta1\nkind: Deployment\nmetadata:\n  annotations:\n    deployment.kubernetes.io/revision: \"2\"\n  labels:\n    grafanak8sapp: \"true\"\n    app: kube-state-metrics\n  name: kube-state-metrics\n  namespace: kube-system\nspec:\n  selector:\n    matchLabels:\n      grafanak8sapp: \"true\"\n      app: kube-state-metrics\n  strategy:\n    rollingUpdate:\n      maxSurge: 25%\n      maxUnavailable: 25%\n    type: RollingUpdate\n  template:\n    metadata:\n      labels:\n        grafanak8sapp: \"true\"\n        app: kube-state-metrics\n    spec:\n      containers:\n      - name: kube-state-metrics\n        image: harbor.od.com/public/kube-state-metrics:v1.5.0\n        imagePullPolicy: IfNotPresent\n        ports:\n        - containerPort: 8080\n          name: http-metrics\n          protocol: TCP\n        readinessProbe:\n          failureThreshold: 3\n          httpGet:\n            path: /healthz\n            port: 8080\n            scheme: HTTP\n          initialDelaySeconds: 5\n          periodSeconds: 10\n          successThreshold: 1\n          timeoutSeconds: 5\n      serviceAccountName: kube-state-metrics\n~~~~\n\n![1583396103539](assets/1583396103539.png)\n\n~~~~\n# åº”ç”¨æ¸…å•ï¼Œ22æœºå™¨ï¼š\n~]# kubectl apply -f http://k8s-yaml.od.com/kube-state-metrics/rbac.yaml\n~]# kubectl apply -f http://k8s-yaml.od.com/kube-state-metrics/dp.yaml\n# æŸ¥è¯¢kube-metricsæ˜¯å¦æ­£å¸¸å¯åŠ¨ï¼Œcurlå“ªä¸ªæ˜¯åœ¨dashboardé‡Œçœ‹åˆ°çš„\n~]# curl 172.7.21.8:8080/healthz\n# out:ok\n# è¯¥å‘½ä»¤æ˜¯æŸ¥çœ‹å–å‡ºæ¥çš„ä¿¡æ¯\n~]# curl 172.7.21.8:8080/metric\n~~~~\n\n![1583396394541](assets/1583396394541.png)\n\n![1583396300678](assets/1583396300678.png)\n\nå®Œæˆ\n\n\n\n### äº¤ä»˜node-exporter\n\n> **WHAT:** ç”¨æ¥ç›‘æ§è¿ç®—èŠ‚ç‚¹ä¸Šçš„å®¿ä¸»æœºçš„èµ„æºä¿¡æ¯ï¼Œéœ€è¦éƒ¨ç½²åˆ°æ‰€æœ‰è¿ç®—èŠ‚ç‚¹\n\n[node-exporterå®˜æ–¹dockerhubåœ°å€](https://hub.docker.com/r/prom/node-exporter)\n\n~~~\n# 200æœºå™¨ï¼Œä¸‹è½½é•œåƒå¹¶å‡†å¤‡èµ„æºé…ç½®æ¸…å•ï¼š\n~]# docker pull prom/node-exporter:v0.15.0\n~]# docker images|grep node-exporter\n~]# docker tag 12d51ffa2b22 harbor.od.com/public/node-exporter:v0.15.0\n~]# docker push harbor.od.com/public/node-exporter:v0.15.0\n~]# mkdir /data/k8s-yaml/node-exporter/\n~]# cd /data/k8s-yaml/node-exporter/\nnode-exporter]# vi ds.yaml\nkind: DaemonSet\napiVersion: extensions/v1beta1\nmetadata:\n  name: node-exporter\n  namespace: kube-system\n  labels:\n    daemon: \"node-exporter\"\n    grafanak8sapp: \"true\"\nspec:\n  selector:\n    matchLabels:\n      daemon: \"node-exporter\"\n      grafanak8sapp: \"true\"\n  template:\n    metadata:\n      name: node-exporter\n      labels:\n        daemon: \"node-exporter\"\n        grafanak8sapp: \"true\"\n    spec:\n      volumes:\n      - name: proc\n        hostPath: \n          path: /proc\n          type: \"\"\n      - name: sys\n        hostPath:\n          path: /sys\n          type: \"\"\n      containers:\n      - name: node-exporter\n        image: harbor.od.com/public/node-exporter:v0.15.0\n        imagePullPolicy: IfNotPresent\n        args:\n        - --path.procfs=/host_proc\n        - --path.sysfs=/host_sys\n        ports:\n        - name: node-exporter\n          hostPort: 9100\n          containerPort: 9100\n          protocol: TCP\n        volumeMounts:\n        - name: sys\n          readOnly: true\n          mountPath: /host_sys\n        - name: proc\n          readOnly: true\n          mountPath: /host_proc\n      hostNetwork: true\n~~~\n\n\n\n~~~\n# 22æœºå™¨ï¼Œåº”ç”¨ï¼š\n# å…ˆçœ‹ä¸€ä¸‹å®¿ä¸»æœºæœ‰æ²¡æœ‰9100ç«¯å£ï¼Œå‘ç°ä»€ä¹ˆéƒ½æ²¡æœ‰\n~]# netstat -luntp|grep 9100\n~]# kubectl apply -f http://k8s-yaml.od.com/node-exporter/ds.yaml\n# åˆ›å»ºå®Œå†çœ‹ç«¯å£ï¼Œå¯èƒ½å¯åŠ¨çš„æ…¢äº›ï¼Œæˆ‘æ˜¯åˆ·äº†3æ¬¡æ‰æœ‰\n~]# netstat -luntp|grep 9100\n~]# curl localhost:9100\n# è¯¥å‘½ä»¤æ˜¯æŸ¥çœ‹å–å‡ºæ¥çš„ä¿¡æ¯\n~]# curl localhost:9100/metrics\n~~~\n\n![1583396713104](assets/1583396713104.png)\n\n![1583396743927](assets/1583396743927.png)\n\nå®Œæˆ\n\n\n\n### äº¤ä»˜cadvisor\n\n> **WHAT**ï¼š ç”¨æ¥ç›‘æ§å®¹å™¨å†…éƒ¨ä½¿ç”¨èµ„æºçš„ä¿¡æ¯\n\n[cadvisorå®˜æ–¹dockerhubé•œåƒ](https://hub.docker.com/r/google/cadvisor/tags)\n\n~~~\n# 200æœºå™¨ï¼Œä¸‹è½½é•œåƒï¼š\n~]# docker pull google/cadvisor:v0.28.3\n~]# docker images|grep cadvisor\n~]# docker tag 75f88e3ec33 harbor.od.com/public/cadvisor:v0.28.3\n~]# docker push harbor.od.com/public/cadvisor:v0.28.3\n~]# mkdir /data/k8s-yaml/cadvisor/\n~]# cd /data/k8s-yaml/cadvisor/\ncadvisor]# vi ds.yaml\napiVersion: apps/v1\nkind: DaemonSet\nmetadata:\n  name: cadvisor\n  namespace: kube-system\n  labels:\n    app: cadvisor\nspec:\n  selector:\n    matchLabels:\n      name: cadvisor\n  template:\n    metadata:\n      labels:\n        name: cadvisor\n    spec:\n      hostNetwork: true\n      tolerations:\n      - key: node-role.kubernetes.io/master\n        effect: NoExecute\n      containers:\n      - name: cadvisor\n        image: harbor.od.com/public/cadvisor:v0.28.3\n        imagePullPolicy: IfNotPresent\n        volumeMounts:\n        - name: rootfs\n          mountPath: /rootfs\n          readOnly: true\n        - name: var-run\n          mountPath: /var/run\n        - name: sys\n          mountPath: /sys\n          readOnly: true\n        - name: docker\n          mountPath: /var/lib/docker\n          readOnly: true\n        ports:\n          - name: http\n            containerPort: 4194\n            protocol: TCP\n        readinessProbe:\n          tcpSocket:\n            port: 4194\n          initialDelaySeconds: 5\n          periodSeconds: 10\n        args:\n          - --housekeeping_interval=10s\n          - --port=4194\n      terminationGracePeriodSeconds: 30\n      volumes:\n      - name: rootfs\n        hostPath:\n          path: /\n      - name: var-run\n        hostPath:\n          path: /var/run\n      - name: sys\n        hostPath:\n          path: /sys\n      - name: docker\n        hostPath:\n          path: /data/docker\n~~~\n\n![1583457963534](assets/1583457963534.png)\n\n> æ­¤æ—¶æˆ‘ä»¬çœ‹åˆ°å¤§å¤šæ•°èŠ‚ç‚¹éƒ½è¿è¡Œåœ¨21æœºå™¨ä¸Šï¼Œæˆ‘ä»¬äººä¸ºçš„è®©podè°ƒåº¦åˆ°22æœºå™¨ï¼ˆå½“ç„¶å³ä½¿ä½ çš„å¤§å¤šæ•°èŠ‚ç‚¹éƒ½è¿è¡Œåœ¨22æœºå™¨ä¸Šä¹Ÿæ²¡å…³ç³»ï¼‰\n\n[^tolerations]: å¯äººä¸ºå½±å“è°ƒåº¦ç­–ç•¥çš„æ–¹æ³•ã€‚ä¸ºä»€ä¹ˆéœ€è¦å®ƒï¼škube-scheduleæ˜¯ä¸»æ§èŠ‚ç‚¹çš„ç­–ç•¥ï¼Œæœ‰é¢„é€‰èŠ‚ç‚¹å’Œä¼˜é€‰èŠ‚ç‚¹çš„ç­–ç•¥ï¼Œä½†å¾€å¾€ç”Ÿæ´»ä¸­è°ƒåº¦ç­–ç•¥å¯èƒ½ä¸æ˜¯æˆ‘ä»¬æƒ³è¦çš„ã€‚\n[^tolerations-key]: æ˜¯å¦è°ƒåº¦çš„æ˜¯æŸèŠ‚ç‚¹ï¼Œæ±¡ç‚¹å¯ä»¥æœ‰å¤šä¸ª\n[^tolerations-effect-NoExecute]: å®¹å¿NoExecuteï¼Œå…¶å®ƒçš„ä¸å®¹å¿ï¼ˆå¦‚ï¼šNoScheduleç­‰ï¼‰ï¼Œå³å¦‚è¿‡èŠ‚ç‚¹ä¸Šçš„æ±¡ç‚¹ä¸æ˜¯NoExecuteï¼Œå°±ä¸è°ƒåº¦åˆ°è¯¥èŠ‚ç‚¹ä¸Šï¼Œå¦‚æœæ˜¯ï¼Œå°±å¯ä»¥è°ƒåº¦ã€‚åä¹‹ï¼Œå¦‚æœæ˜¯NoScheduleï¼Œé‚£ä¹ˆèŠ‚ç‚¹ä¸Šçš„æ±¡ç‚¹å¦‚æœæ˜¯NoScheduleåˆ™å¯ä»¥å®¹å™¨ï¼Œå¦‚æœä¸æ˜¯ï¼Œåˆ™ä¸å¯ä»¥ã€‚\n\n> å¯äººä¸ºå½±å“K8Sè°ƒåº¦ç­–ç•¥çš„ä¸‰ç§æ–¹æ³•ï¼š\n>\n> - æ±¡ç‚¹ã€å®¹å¿æ–¹æ³•ï¼š\n>   - æ±¡ç‚¹ï¼šè¿ç®—èŠ‚ç‚¹nodeä¸Šçš„æ±¡ç‚¹ï¼ˆå…ˆåœ¨è¿ç®—èŠ‚ç‚¹ä¸Šæ‰“æ ‡ç­¾ç­‰ kubectl taint nodes node1 key1=value1:NoScheduleï¼‰ï¼Œæ±¡ç‚¹å¯ä»¥æœ‰å¤šä¸ª\n>   - å®¹å¿åº¦ï¼špodæ˜¯å¦èƒ½å¤Ÿå®¹å¿æ±¡ç‚¹\n>   - å‚è€ƒ[kuberneteså®˜ç½‘](https:kubernetes.io/zh/docs/concepts/configuration/taint-and-toleration/)\n> - nodeNameï¼šè®©Podè¿è¡Œå†æŒ‡å®šçš„nodeä¸Š\n> - nodeSelectorï¼šé€šè¿‡æ ‡ç­¾é€‰æ‹©å™¨ï¼Œè®©Podè¿è¡Œå†æŒ‡å®šçš„ä¸€ç±»nodeä¸Š\n\n~~~\n# ç»™21æœºå™¨æ‰“ä¸ªæ±¡ç‚¹ï¼Œ22æœºå™¨ï¼š\n~]# kubectl taint node hdss7-21.host.com node-role.kubernetes.io/master=master:NoSchedule\n~~~\n\n![1581470696125](assets/1581470696125.png)\n\n![1583458119938](assets/1583458119938.png)\n\n~~~\n# 21/22ä¸¤ä¸ªæœºå™¨ï¼Œä¿®æ”¹è½¯è¿æ¥ï¼š\n~]# mount -o remount,rw /sys/fs/cgroup/\n~]# ln -s /sys/fs/cgroup/cpu,cpuacct /sys/fs/cgroup/cpuacct,cpu\n~]# ls -l /sys/fs/cgroup/\n~~~\n\n> **mount -o remount, rw /sys/fs/cgroup**ï¼šé‡æ–°ä»¥å¯è¯»å¯å†™çš„æ–¹å¼æŒ‚è½½ä¸ºå·²ç»æŒ‚è½½/sys/fs/cgroup\n>\n> **ln -s**ï¼šåˆ›å»ºå¯¹åº”çš„è½¯é“¾æ¥\n>\n> **ls -l**ï¼šæ˜¾ç¤ºä¸éšè—çš„æ–‡ä»¶ä¸æ–‡ä»¶å¤¹çš„è¯¦ç»†ä¿¡æ¯\n\n![1583458181722](assets/1583458181722.png)\n\n~~~\n# 22æœºå™¨ï¼Œåº”ç”¨èµ„æºæ¸…å•ï¼š\n~]# kubectl apply -f http://k8s-yaml.od.com/cadvisor/ds.yaml\n~]# kubectl get pods -n kube-system -o wide\n~~~\n\nåªæœ‰22æœºå™¨ä¸Šæœ‰ï¼Œè·Ÿæˆ‘ä»¬é¢„æœŸä¸€æ ·\n\n![1583458264404](assets/1583458264404.png)\n\n~~~\n# 21æœºå™¨ï¼Œæˆ‘ä»¬åˆ æ‰æ±¡ç‚¹ï¼š\n~]# kubectl taint node hdss7-21.host.com node-role.kubernetes.io/master-\n# out: node/hdss7-21.host.com untainted\n~~~\n\nçœ‹dashboardï¼Œæ±¡ç‚¹å·²ç»æ²¡äº†\n\n![1583458299094](assets/1583458299094.png)\n\nåœ¨å»Podsçœ‹ï¼Œæ±¡ç‚¹æ²¡äº†ï¼Œpodå°±è‡ªåŠ¨èµ·æ¥äº†\n\n![1583458316885](assets/1583458316885.png)\n\nå®Œæˆ\n\nå†ä¿®æ”¹ä¸‹\n\n![1583458394302](assets/1583458394302.png)\n\n\n\n\n\n### äº¤ä»˜blackbox-exporter\n\n> **WHAT**ï¼šç›‘æ§ä¸šåŠ¡å®¹å™¨å­˜æ´»æ€§\n\n~~~\n# 200æœºå™¨ï¼Œä¸‹è½½é•œåƒ\n~]# docker pull prom/blackbox-exporter:v0.15.1\n~]# docker images|grep blackbox-exporter\n~]# docker tag 81b70b6158be harbor.od.com/public/blackbox-exporter:v0.15.1\n~]# docker push harbor.od.com/public/blackbox-exporter:v0.15.1\n~]# mkdir /data/k8s-yaml/blackbox-exporter\n~]# cd /data/k8s-yaml/blackbox-exporter\nblackbox-exporter]# vi cm.yaml\napiVersion: v1\nkind: ConfigMap\nmetadata:\n  labels:\n    app: blackbox-exporter\n  name: blackbox-exporter\n  namespace: kube-system\ndata:\n  blackbox.yml: |-\n    modules:\n      http_2xx:\n        prober: http\n        timeout: 2s\n        http:\n          valid_http_versions: [\"HTTP/1.1\", \"HTTP/2\"]\n          valid_status_codes: [200,301,302]\n          method: GET\n          preferred_ip_protocol: \"ip4\"\n      tcp_connect:\n        prober: tcp\n        timeout: 2s\n\nblackbox-exporter]# vi dp.yaml\nkind: Deployment\napiVersion: extensions/v1beta1\nmetadata:\n  name: blackbox-exporter\n  namespace: kube-system\n  labels:\n    app: blackbox-exporter\n  annotations:\n    deployment.kubernetes.io/revision: 1\nspec:\n  replicas: 1\n  selector:\n    matchLabels:\n      app: blackbox-exporter\n  template:\n    metadata:\n      labels:\n        app: blackbox-exporter\n    spec:\n      volumes:\n      - name: config\n        configMap:\n          name: blackbox-exporter\n          defaultMode: 420\n      containers:\n      - name: blackbox-exporter\n        image: harbor.od.com/public/blackbox-exporter:v0.15.1\n        imagePullPolicy: IfNotPresent\n        args:\n        - --config.file=/etc/blackbox_exporter/blackbox.yml\n        - --log.level=info\n        - --web.listen-address=:9115\n        ports:\n        - name: blackbox-port\n          containerPort: 9115\n          protocol: TCP\n        resources:\n          limits:\n            cpu: 200m\n            memory: 256Mi\n          requests:\n            cpu: 100m\n            memory: 50Mi\n        volumeMounts:\n        - name: config\n          mountPath: /etc/blackbox_exporter\n        readinessProbe:\n          tcpSocket:\n            port: 9115\n          initialDelaySeconds: 5\n          timeoutSeconds: 5\n          periodSeconds: 10\n          successThreshold: 1\n          failureThreshold: 3\n\nblackbox-exporter]# vi svc.yaml\nkind: Service\napiVersion: v1\nmetadata:\n  name: blackbox-exporter\n  namespace: kube-system\nspec:\n  selector:\n    app: blackbox-exporter\n  ports:\n    - name: blackbox-port\n      protocol: TCP\n      port: 9115\n\nblackbox-exporter]# vi ingress.yaml\napiVersion: extensions/v1beta1\nkind: Ingress\nmetadata:\n  name: blackbox-exporter\n  namespace: kube-system\nspec:\n  rules:\n  - host: blackbox.od.com\n    http:\n      paths:\n      - path: /\n        backend:\n          serviceName: blackbox-exporter\n          servicePort: blackbox-port\n~~~\n\n![1583460099035](assets/1583460099035.png)\n\n~~~\n# 11æœºå™¨ï¼Œè§£æåŸŸåï¼š\n~]# vi /var/named/od.com.zone\nserial å‰æ»šä¸€ä½\nblackbox           A    10.4.7.10\n\n~]# systemctl restart named\n# 22æœºå™¨\n~]# dig -t A blackbox.od.com @192.168.0.2 +short\n# out: 10.4.7.10\n~~~\n\n![1583460226033](assets/1583460226033.png)\n\n~~~\n# 22æœºå™¨ï¼Œåº”ç”¨ï¼š\n~]# kubectl apply -f http://k8s-yaml.od.com/blackbox-exporter/cm.yaml\n~]# kubectl apply -f http://k8s-yaml.od.com/blackbox-exporter/dp.yaml\n~]# kubectl apply -f http://k8s-yaml.od.com/blackbox-exporter/svc.yaml\n~]# kubectl apply -f http://k8s-yaml.od.com/blackbox-exporter/ingress.yaml\n~~~\n\n![1583460413279](assets/1583460413279.png)\n\n[blackbox.od.com](blackbox.od.com)\n\n![1583460433145](assets/1583460433145.png)\n\nå®Œæˆ\n\n\n\n### å®‰è£…éƒ¨ç½²Prometheus-server\n\n> **WHAT**ï¼šæœåŠ¡æ ¸å¿ƒç»„ä»¶ï¼Œé€šè¿‡pull metricsä» Exporter æ‹‰å–å’Œå­˜å‚¨ç›‘æ§æ•°æ®,å¹¶æä¾›ä¸€å¥—çµæ´»çš„æŸ¥è¯¢è¯­è¨€ï¼ˆPromQLï¼‰\n\n[prometheus-serverå®˜ç½‘dockeråœ°å€](https://hub.docker.com/r/prom/prometheus)\n\n~~~~\n# 200æœºå™¨ï¼Œå‡†å¤‡é•œåƒã€èµ„æºæ¸…å•ï¼š\n~]# docker pull prom/prometheus:v2.14.0\n~]# docker images|grep prometheus\n~]# docker tag 7317640d555e harbor.od.com/infra/prometheus:v2.14.0\n~]# docker push harbor.od.com/infra/prometheus:v2.14.0\n~]# mkdir /data/k8s-yaml/prometheus\n~]# cd /data/k8s-yaml/prometheus\nprometheus]# vi rbac.yaml\napiVersion: v1\nkind: ServiceAccount\nmetadata:\n  labels:\n    addonmanager.kubernetes.io/mode: Reconcile\n    kubernetes.io/cluster-service: \"true\"\n  name: prometheus\n  namespace: infra\n---\napiVersion: rbac.authorization.k8s.io/v1\nkind: ClusterRole\nmetadata:\n  labels:\n    addonmanager.kubernetes.io/mode: Reconcile\n    kubernetes.io/cluster-service: \"true\"\n  name: prometheus\nrules:\n- apiGroups:\n  - \"\"\n  resources:\n  - nodes\n  - nodes/metrics\n  - services\n  - endpoints\n  - pods\n  verbs:\n  - get\n  - list\n  - watch\n- apiGroups:\n  - \"\"\n  resources:\n  - configmaps\n  verbs:\n  - get\n- nonResourceURLs:\n  - /metrics\n  verbs:\n  - get\n---\napiVersion: rbac.authorization.k8s.io/v1\nkind: ClusterRoleBinding\nmetadata:\n  labels:\n    addonmanager.kubernetes.io/mode: Reconcile\n    kubernetes.io/cluster-service: \"true\"\n  name: prometheus\nroleRef:\n  apiGroup: rbac.authorization.k8s.io\n  kind: ClusterRole\n  name: prometheus\nsubjects:\n- kind: ServiceAccount\n  name: prometheus\n  namespace: infra\n\nprometheus]# vi dp.yaml\napiVersion: extensions/v1beta1\nkind: Deployment\nmetadata:\n  annotations:\n    deployment.kubernetes.io/revision: \"5\"\n  labels:\n    name: prometheus\n  name: prometheus\n  namespace: infra\nspec:\n  progressDeadlineSeconds: 600\n  replicas: 1\n  revisionHistoryLimit: 7\n  selector:\n    matchLabels:\n      app: prometheus\n  strategy:\n    rollingUpdate:\n      maxSurge: 1\n      maxUnavailable: 1\n    type: RollingUpdate\n  template:\n    metadata:\n      labels:\n        app: prometheus\n    spec:\n      containers:\n      - name: prometheus\n        image: harbor.od.com/infra/prometheus:v2.14.0\n        imagePullPolicy: IfNotPresent\n        command:\n        - /bin/prometheus\n        args:\n        - --config.file=/data/etc/prometheus.yml\n        - --storage.tsdb.path=/data/prom-db\n        - --storage.tsdb.min-block-duration=10m\n        - --storage.tsdb.retention=72h\n        ports:\n        - containerPort: 9090\n          protocol: TCP\n        volumeMounts:\n        - mountPath: /data\n          name: data\n        resources:\n          requests:\n            cpu: \"1000m\"\n            memory: \"1.5Gi\"\n          limits:\n            cpu: \"2000m\"\n            memory: \"3Gi\"\n      imagePullSecrets:\n      - name: harbor\n      securityContext:\n        runAsUser: 0\n      serviceAccountName: prometheus\n      volumes:\n      - name: data\n        nfs:\n          server: hdss7-200\n          path: /data/nfs-volume/prometheus\n\nprometheus]# vi svc.yaml\napiVersion: v1\nkind: Service\nmetadata:\n  name: prometheus\n  namespace: infra\nspec:\n  ports:\n  - port: 9090\n    protocol: TCP\n    targetPort: 9090\n  selector:\n    app: prometheus\n\nprometheus]# vi ingress.yaml\napiVersion: extensions/v1beta1\nkind: Ingress\nmetadata:\n  annotations:\n    kubernetes.io/ingress.class: traefik\n  name: prometheus\n  namespace: infra\nspec:\n  rules:\n  - host: prometheus.od.com\n    http:\n      paths:\n      - path: /\n        backend:\n          serviceName: prometheus\n          servicePort: 9090\n\n# å‡†å¤‡prometheusçš„é…ç½®æ–‡ä»¶ï¼š\nprometheus]# mkdir /data/nfs-volume/prometheus\nprometheus]# cd /data/nfs-volume/prometheus\nprometheus]# mkdir {etc,prom-db}\nprometheus]# cd etc/\netc]# cp /opt/certs/ca.pem .\netc]# cp -a /opt/certs/client.pem .\netc]# cp -a /opt/certs/client-key.pem .\netc]# prometheus.yml\nglobal:\n  scrape_interval:     15s\n  evaluation_interval: 15s\nscrape_configs:\n- job_name: 'etcd'\n  tls_config:\n    ca_file: /data/etc/ca.pem\n    cert_file: /data/etc/client.pem\n    key_file: /data/etc/client-key.pem\n  scheme: https\n  static_configs:\n  - targets:\n    - '10.4.7.12:2379'\n    - '10.4.7.21:2379'\n    - '10.4.7.22:2379'\n- job_name: 'kubernetes-apiservers'\n  kubernetes_sd_configs:\n  - role: endpoints\n  scheme: https\n  tls_config:\n    ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt\n  bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token\n  relabel_configs:\n  - source_labels: [__meta_kubernetes_namespace, __meta_kubernetes_service_name, __meta_kubernetes_endpoint_port_name]\n    action: keep\n    regex: default;kubernetes;https\n- job_name: 'kubernetes-pods'\n  kubernetes_sd_configs:\n  - role: pod\n  relabel_configs:\n  - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_scrape]\n    action: keep\n    regex: true\n  - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_path]\n    action: replace\n    target_label: __metrics_path__\n    regex: (.+)\n  - source_labels: [__address__, __meta_kubernetes_pod_annotation_prometheus_io_port]\n    action: replace\n    regex: ([^:]+)(?::\\d+)?;(\\d+)\n    replacement: $1:$2\n    target_label: __address__\n  - action: labelmap\n    regex: __meta_kubernetes_pod_label_(.+)\n  - source_labels: [__meta_kubernetes_namespace]\n    action: replace\n    target_label: kubernetes_namespace\n  - source_labels: [__meta_kubernetes_pod_name]\n    action: replace\n    target_label: kubernetes_pod_name\n- job_name: 'kubernetes-kubelet'\n  kubernetes_sd_configs:\n  - role: node\n  relabel_configs:\n  - action: labelmap\n    regex: __meta_kubernetes_node_label_(.+)\n  - source_labels: [__meta_kubernetes_node_name]\n    regex: (.+)\n    target_label: __address__\n    replacement: ${1}:10255\n- job_name: 'kubernetes-cadvisor'\n  kubernetes_sd_configs:\n  - role: node\n  relabel_configs:\n  - action: labelmap\n    regex: __meta_kubernetes_node_label_(.+)\n  - source_labels: [__meta_kubernetes_node_name]\n    regex: (.+)\n    target_label: __address__\n    replacement: ${1}:4194\n- job_name: 'kubernetes-kube-state'\n  kubernetes_sd_configs:\n  - role: pod\n  relabel_configs:\n  - action: labelmap\n    regex: __meta_kubernetes_pod_label_(.+)\n  - source_labels: [__meta_kubernetes_namespace]\n    action: replace\n    target_label: kubernetes_namespace\n  - source_labels: [__meta_kubernetes_pod_name]\n    action: replace\n    target_label: kubernetes_pod_name\n  - source_labels: [__meta_kubernetes_pod_label_grafanak8sapp]\n    regex: .*true.*\n    action: keep\n  - source_labels: ['__meta_kubernetes_pod_label_daemon', '__meta_kubernetes_pod_node_name']\n    regex: 'node-exporter;(.*)'\n    action: replace\n    target_label: nodename\n- job_name: 'blackbox_http_pod_probe'\n  metrics_path: /probe\n  kubernetes_sd_configs:\n  - role: pod\n  params:\n    module: [http_2xx]\n  relabel_configs:\n  - source_labels: [__meta_kubernetes_pod_annotation_blackbox_scheme]\n    action: keep\n    regex: http\n  - source_labels: [__address__, __meta_kubernetes_pod_annotation_blackbox_port,  __meta_kubernetes_pod_annotation_blackbox_path]\n    action: replace\n    regex: ([^:]+)(?::\\d+)?;(\\d+);(.+)\n    replacement: $1:$2$3\n    target_label: __param_target\n  - action: replace\n    target_label: __address__\n    replacement: blackbox-exporter.kube-system:9115\n  - source_labels: [__param_target]\n    target_label: instance\n  - action: labelmap\n    regex: __meta_kubernetes_pod_label_(.+)\n  - source_labels: [__meta_kubernetes_namespace]\n    action: replace\n    target_label: kubernetes_namespace\n  - source_labels: [__meta_kubernetes_pod_name]\n    action: replace\n    target_label: kubernetes_pod_name\n- job_name: 'blackbox_tcp_pod_probe'\n  metrics_path: /probe\n  kubernetes_sd_configs:\n  - role: pod\n  params:\n    module: [tcp_connect]\n  relabel_configs:\n  - source_labels: [__meta_kubernetes_pod_annotation_blackbox_scheme]\n    action: keep\n    regex: tcp\n  - source_labels: [__address__, __meta_kubernetes_pod_annotation_blackbox_port]\n    action: replace\n    regex: ([^:]+)(?::\\d+)?;(\\d+)\n    replacement: $1:$2\n    target_label: __param_target\n  - action: replace\n    target_label: __address__\n    replacement: blackbox-exporter.kube-system:9115\n  - source_labels: [__param_target]\n    target_label: instance\n  - action: labelmap\n    regex: __meta_kubernetes_pod_label_(.+)\n  - source_labels: [__meta_kubernetes_namespace]\n    action: replace\n    target_label: kubernetes_namespace\n  - source_labels: [__meta_kubernetes_pod_name]\n    action: replace\n    target_label: kubernetes_pod_name\n- job_name: 'traefik'\n  kubernetes_sd_configs:\n  - role: pod\n  relabel_configs:\n  - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_scheme]\n    action: keep\n    regex: traefik\n  - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_path]\n    action: replace\n    target_label: __metrics_path__\n    regex: (.+)\n  - source_labels: [__address__, __meta_kubernetes_pod_annotation_prometheus_io_port]\n    action: replace\n    regex: ([^:]+)(?::\\d+)?;(\\d+)\n    replacement: $1:$2\n    target_label: __address__\n  - action: labelmap\n    regex: __meta_kubernetes_pod_label_(.+)\n  - source_labels: [__meta_kubernetes_namespace]\n    action: replace\n    target_label: kubernetes_namespace\n  - source_labels: [__meta_kubernetes_pod_name]\n    action: replace\n    target_label: kubernetes_pod_name\n~~~~\n\n> **cp -a**ï¼šåœ¨å¤åˆ¶ç›®å½•æ—¶ä½¿ç”¨ï¼Œå®ƒä¿ç•™é“¾æ¥ã€æ–‡ä»¶å±æ€§ï¼Œå¹¶å¤åˆ¶ç›®å½•ä¸‹çš„æ‰€æœ‰å†…å®¹\n\n![1583461823355](assets/1583461823355.png)\n\n~~~\n# 11æœºå™¨ï¼Œ è§£æåŸŸåï¼Œæœ‰ingresså°±æœ‰é¡µé¢å°±éœ€è¦è§£æï¼š\n~]# vi /var/named/od.com.zone\nserial å‰æ»šä¸€ä½\nprometheus         A    10.4.7.10\n\n~]# systemctl restart named\n~]# dig -t A prometheus.od.com @10.4.7.11 +short\n# out:10.4.7.10\n~~~\n\n![1582704423890](assets/1582704423890.png)\n\n~~~\n# 22æœºå™¨ï¼Œåº”ç”¨é…ç½®æ¸…å•ï¼š\n~]# kubectl apply -f http://k8s-yaml.od.com/prometheus/rbac.yaml\n~]# kubectl apply -f http://k8s-yaml.od.com/prometheus/dp.yaml\n~]# kubectl apply -f http://k8s-yaml.od.com/prometheus/svc.yaml\n~]# kubectl apply -f http://k8s-yaml.od.com/prometheus/ingress.yaml\n~~~\n\n![1583461941453](assets/1583461941453.png)\n\n![1583462134250](assets/1583462134250.png)\n\n[prometheus.od.com](prometheus.od.com)\n\n> è¿™å°±æ˜¯Prometheusè‡ªå¸¦çš„UIé¡µé¢ï¼Œç°åœ¨ä½ å°±çŸ¥é“ä¸ºä»€ä¹ˆæˆ‘ä»¬éœ€è¦Grafanaæ¥æ›¿ä»£äº†ï¼Œå¦‚æœä½ è¿˜ä¸æ¸…æ¥šï¼Œç­‰ä¸‹çœ‹Grafanaçš„é¡µé¢ä½ å°±çŸ¥é“äº†\n\n![1583462164465](assets/1583462164465.png)\n\n![1583462217169](assets/1583462217169.png)\n\nå®Œæˆ\n\n\n\n### é…ç½®Prometheusç›‘æ§ä¸šåŠ¡å®¹å™¨\n\n##### å…ˆé…ç½®traefik\n\n![1583462282296](assets/1583462282296.png)\n\n~~~\n# Edit a Daemon Setï¼Œæ·»åŠ ä»¥ä¸‹å†…å®¹ï¼Œè®°å¾—ç»™ä¸Šé¢åŠ é€—å·:\n\"annotations\": {\n  \"prometheus_io_scheme\": \"traefik\",\n  \"prometheus_io_path\": \"/metrics\",\n  \"prometheus_io_port\": \"8080\"\n}\n# ç›´æ¥åŠ è¿›å»updateï¼Œä¼šè‡ªåŠ¨å¯¹é½ \n~~~\n\n![1583462379871](assets/1583462379871.png)\n\nåˆ æ‰ä¸¤ä¸ªå¯¹åº”çš„podè®©å®ƒé‡å¯\n\n![1583462451073](assets/1583462451073.png)\n\n~~~\n# 22æœºå™¨ï¼ŒæŸ¥çœ‹ä¸‹ï¼Œå¦‚æœèµ·ä¸æ¥å°±ç”¨å‘½ä»¤è¡Œçš„æ–¹å¼å¼ºåˆ¶åˆ é™¤ï¼š\n~]# kubectl get pods -n kube-system\n~]# kubectl delete pods traefik-ingress-g26kw -n kube-system --force --grace-period=0\n~~~\n\n![1583462566364](assets/1583462566364.png)\n\nå¯åŠ¨æˆåŠŸåï¼Œå»PrometheusæŸ¥çœ‹\n\nåˆ·æ–°åï¼Œå¯ä»¥çœ‹åˆ°æ˜¯traefik2/2ï¼Œå·²ç»æœ‰äº†\n\n![1583462600531](assets/1583462600531.png)\n\nå®Œæˆ\n\n\n\n##### blackbox\n\næˆ‘ä»¬èµ·ä¸€ä¸ªdubbo-serviceï¼Œä¹‹å‰æˆ‘ä»¬æœ€ååšçš„æ˜¯Apolloçš„ç‰ˆæœ¬ï¼Œç°åœ¨æˆ‘ä»¬çš„Apolloå·²ç»å…³äº†ï¼ˆå› ä¸ºæ¶ˆè€—èµ„æºï¼‰ï¼Œç°åœ¨éœ€è¦èµ·æ›´æ—©ä¹‹å‰ä¸æ˜¯Apolloçš„ç‰ˆæœ¬ã€‚\n\næˆ‘ä»¬å»harboré‡Œé¢æ‰¾\n\n![1583465190219](assets/1583465190219.png)\n\n> æˆ‘çš„Apolloçš„ç‰ˆæœ¬å¯èƒ½æ¯”ä½ çš„å¤šä¸€ä¸ªï¼Œä¸ç”¨åœ¨æ„ï¼Œé‚£æ˜¯åšå®éªŒå¼„çš„\n\nä¿®æ”¹ç‰ˆæœ¬ä¿¡æ¯\n\n![1583466214230](assets/1583466214230.png)\n\n![1583466251914](assets/1583466251914.png)\n\nåœ¨æŠŠscaleæ”¹æˆ1\n\n![1583466284890](assets/1583466284890.png)\n\næŸ¥çœ‹PODçš„LOGSæ—¥å¿—\n\n![1583466310189](assets/1583466310189.png)\n\nç¿»é¡µæŸ¥çœ‹ï¼Œå·²ç»å¯åŠ¨\n\n![1583466328146](assets/1583466328146.png)\n\nå¦‚ä½•ç›‘æ§å­˜æ´»æ€§ï¼Œåªéœ€è¦ä¿®æ”¹é…ç½®\n\n![1584699708597](assets/1584699708597.png)\n\n~~~\n# Edit a Deploymentï¼ˆTCPï¼‰ï¼Œæ·»åŠ ä»¥ä¸‹å†…å®¹\n\"annotations\": {\n  \"blackbox_port\": \"20880\",\n  \"blackbox_scheme\": \"tcp\"\n}\n# ç›´æ¥åŠ è¿›å»updateï¼Œä¼šè‡ªåŠ¨å¯¹é½ \n~~~\n\n![1583466938931](assets/1583466938931.png)\n\nUPDATEåï¼Œå·²ç»runningèµ·æ¥äº†\n\n![1583467301614](assets/1583467301614.png)\n\n[prometheus.od.com](prometheus.od.com)åˆ·æ–°ï¼Œè‡ªåŠ¨å‘ç°ä¸šåŠ¡\n\n![1583466979716](assets/1583466979716.png)\n\n[blackbox.od.com](blackbox.od.com) åˆ·æ–°\n\n![1583467331128](assets/1583467331128.png)\n\nåŒæ ·çš„ï¼Œæˆ‘ä»¬æŠŠdubbo-consumerä¹Ÿå¼„è¿›æ¥\n\nå…ˆå»harboræ‰¾ä¸€ä¸ªä¸æ˜¯Apolloçš„ç‰ˆæœ¬ï¼ˆä¸ºä»€ä¹ˆè¦ç”¨ä¸æ˜¯Apolloçš„ç‰ˆæœ¬å‰é¢å·²ç»è¯´äº†ï¼‰\n\n![1583503611435](assets/1583503611435.png)\n\nä¿®æ”¹ç‰ˆæœ¬ä¿¡æ¯ï¼Œå¹¶æ·»åŠ annotations\n\n~~~\n# Edit a Deployment(http)ï¼Œæ·»åŠ ä»¥ä¸‹å†…å®¹ï¼Œè®°å¾—å‰é¢çš„é€—å·\n\"annotations\":{\n  \"blackbox_path\": \"/hello?name=health\",\n  \"blackbox_port\": \"8080\",\n  \"blackbox_scheme\": \"http\"\n}\n# ç›´æ¥åŠ è¿›å»updateï¼Œä¼šè‡ªåŠ¨å¯¹é½ \n~~~\n\n![1583503670313](assets/1583503670313.png)\n\n![1583504095794](assets/1583504095794.png)\n\nUPDATEåï¼ŒæŠŠscaleæ”¹æˆ1\n\n![1583503796291](assets/1583503796291.png)\n\nç¡®ä¿èµ·æ¥äº†\n\n![1583503811855](assets/1583503811855.png)\n\n![1583503829457](assets/1583503829457.png)\n\n[prometheus.od.com](prometheus.od.com)åˆ·æ–°ï¼Œè‡ªåŠ¨å‘ç°ä¸šåŠ¡\n\n![1583503935815](assets/1583503935815.png)\n\n[blackbox.od.com](blackbox.od.com) åˆ·æ–°\n\n![1583504112078](assets/1583504112078.png)\n\n\n\n### å®‰è£…éƒ¨ç½²é…ç½®Grafana\n\n> **WHAT**ï¼šç¾è§‚ã€å¼ºå¤§çš„å¯è§†åŒ–ç›‘æ§æŒ‡æ ‡å±•ç¤ºå·¥å…· \n>\n> **WHY**ï¼šç”¨æ¥ä»£æ›¿prometheusåŸç”ŸUIç•Œé¢\n\n~~~\n# 200æœºå™¨ï¼Œå‡†å¤‡é•œåƒã€èµ„æºé…ç½®æ¸…å•ï¼š\n~]# docker pull grafana/grafana:5.4.2\n~]# docker images|grep grafana\n~]# docker tag 6f18ddf9e552 harbor.od.com/infra/grafana:v5.4.2\n~]# docker push harbor.od.com/infra/grafana:v5.4.2\n~]# mkdir /data/k8s-yaml/grafana/ /data/nfs-volume/grafana\n~]# cd /data/k8s-yaml/grafana/\ngrafana]# vi rbac.yaml\napiVersion: rbac.authorization.k8s.io/v1\nkind: ClusterRole\nmetadata:\n  labels:\n    addonmanager.kubernetes.io/mode: Reconcile\n    kubernetes.io/cluster-service: \"true\"\n  name: grafana\nrules:\n- apiGroups:\n  - \"*\"\n  resources:\n  - namespaces\n  - deployments\n  - pods\n  verbs:\n  - get\n  - list\n  - watch\n---\napiVersion: rbac.authorization.k8s.io/v1\nkind: ClusterRoleBinding\nmetadata:\n  labels:\n    addonmanager.kubernetes.io/mode: Reconcile\n    kubernetes.io/cluster-service: \"true\"\n  name: grafana\nroleRef:\n  apiGroup: rbac.authorization.k8s.io\n  kind: ClusterRole\n  name: grafana\nsubjects:\n- kind: User\n  name: k8s-node\n\ngrafana]# vi dp.yaml\napiVersion: extensions/v1beta1\nkind: Deployment\nmetadata:\n  labels:\n    app: grafana\n    name: grafana\n  name: grafana\n  namespace: infra\nspec:\n  progressDeadlineSeconds: 600\n  replicas: 1\n  revisionHistoryLimit: 7\n  selector:\n    matchLabels:\n      name: grafana\n  strategy:\n    rollingUpdate:\n      maxSurge: 1\n      maxUnavailable: 1\n    type: RollingUpdate\n  template:\n    metadata:\n      labels:\n        app: grafana\n        name: grafana\n    spec:\n      containers:\n      - name: grafana\n        image: harbor.od.com/infra/grafana:v5.4.2\n        imagePullPolicy: IfNotPresent\n        ports:\n        - containerPort: 3000\n          protocol: TCP\n        volumeMounts:\n        - mountPath: /var/lib/grafana\n          name: data\n      imagePullSecrets:\n      - name: harbor\n      securityContext:\n        runAsUser: 0\n      volumes:\n      - nfs:\n          server: hdss7-200\n          path: /data/nfs-volume/grafana\n        name: data\n\ngrafana]# vi svc.yaml\napiVersion: v1\nkind: Service\nmetadata:\n  name: grafana\n  namespace: infra\nspec:\n  ports:\n  - port: 3000\n    protocol: TCP\n    targetPort: 3000\n  selector:\n    app: grafana\n\ngrafana]# vi ingress.yaml\napiVersion: extensions/v1beta1\nkind: Ingress\nmetadata:\n  name: grafana\n  namespace: infra\nspec:\n  rules:\n  - host: grafana.od.com\n    http:\n      paths:\n      - path: /\n        backend:\n          serviceName: grafana\n          servicePort: 3000\n\n~~~\n\n![1583504719781](assets/1583504719781.png)\n\n~~~\n# 11æœºå™¨ï¼Œè§£æåŸŸå:\n~]# vi /var/named/od.com.zone\nserial å‰æ»šä¸€ä½\n\ngrafana            A    10.4.7.10\n~]# systemctl restart named\n~]# ping grafana.od.com\n~~~\n\n![1582705048800](assets/1582705048800.png)\n\n~~~~\n# 22æœºå™¨ï¼Œåº”ç”¨é…ç½®æ¸…å•ï¼š\n~]# kubectl apply -f http://k8s-yaml.od.com/grafana/rbac.yaml\n~]# kubectl apply -f http://k8s-yaml.od.com/grafana/dp.yaml\n~]# kubectl apply -f http://k8s-yaml.od.com/grafana/svc.yaml\n~]# kubectl apply -f http://k8s-yaml.od.com/grafana/ingress.yaml\n~~~~\n\n![1583504865941](assets/1583504865941.png)\n\n[grafana.od.com](grafana.od.com)\n\né»˜è®¤è´¦æˆ·å’Œå¯†ç éƒ½æ˜¯admin\n\nä¿®æ”¹å¯†ç ï¼šadmin123\n\n![1583504898029](assets/1583504898029.png)\n\nä¿®æ”¹é…ç½®ï¼Œä¿®æ”¹å¦‚ä¸‹å›¾\n\n![1583505029816](assets/1583505029816.png)\n\n##### è£…æ’ä»¶\n\nè¿›å…¥å®¹å™¨\n\n![1583505097409](assets/1583505097409.png)\n\n~~~\n# ç¬¬ä¸€ä¸ªï¼škubenetes App\ngrafana# grafana-cli plugins install grafana-kubernetes-app\n# ç¬¬äºŒä¸ªï¼šClock Pannel\ngrafana# grafana-cli plugins install grafana-clock-panel\n# ç¬¬ä¸‰ä¸ªï¼šPie Chart\ngrafana# grafana-cli plugins install grafana-piechart-panel\n# ç¬¬å››ä¸ªï¼šD3Gauge\ngrafana# grafana-cli plugins install briangann-gauge-panel\n# ç¬¬äº”ä¸ªï¼šDiscrete\ngrafana# grafana-cli plugins install natel-discrete-panel\n~~~\n\n![1583505305939](assets/1583505305939.png)\n\nè£…å®Œåï¼Œå¯ä»¥åœ¨200æœºå™¨æŸ¥çœ‹\n\n~~~\n# 200æœºå™¨ï¼š\ncd /data/nfs-volume/grafana/plugins/\nplugins]# ll\n~~~\n\n![1583505462177](assets/1583505462177.png)\n\nåˆ æ‰è®©å®ƒé‡å¯\n\n![1583505490948](assets/1583505490948.png)\n\né‡å¯å®Œæˆå\n\n\n\næŸ¥çœ‹[grafana.od.com](grafana.od.com)ï¼Œåˆšåˆšå®‰è£…çš„5ä¸ªæ’ä»¶éƒ½åœ¨é‡Œé¢äº†ï¼ˆè®°å¾—æ£€æŸ¥æ˜¯å¦åœ¨é‡Œé¢äº†ï¼‰\n\n![1583505547061](assets/1583505547061.png)\n\n##### æ·»åŠ æ•°æ®æºï¼šAdd data source\n\n![1583505581557](assets/1583505581557.png)\n\n![1583505600031](assets/1583505600031.png)\n\n~~~\n# å¡«å…¥å‚æ•°ï¼š\nURL:http://prometheus.od.com\nTLS Client Authâœ”    With CA Certâœ”\n~~~\n\n![1583505840252](assets/1583505840252.png)\n\n~~~\n# å¡«å…¥å‚æ•°å¯¹åº”çš„pemå‚æ•°ï¼š\n# 200æœºå™¨æ‹¿caç­‰ï¼š\n~]# cat /opt/certs/ca.pem\n~]# cat /opt/certs/client.pem\n~]# cat /opt/certs/client-key.pem\n~~~\n\n![1583505713033](assets/1583505713033.png)\n\n![1583505856093](assets/1583505856093.png)\n\nä¿å­˜\n\nç„¶åæˆ‘ä»¬å»é…ç½®pluginsé‡Œé¢çš„kubernetes\n\n![1583505923109](assets/1583505923109.png)\n\n![1583505938700](assets/1583505938700.png)\n\nå³ä¾§å°±å¤šäº†ä¸ªæŒ‰é’®ï¼Œç‚¹å‡»è¿›å»\n\n![1583505969865](assets/1583505969865.png)\n\n~~~\n# æŒ‰å‚æ•°å¡«å…¥ï¼š\nName:myk8s\nURL:https://10.4.7.10:7443\nAccess:Server\nTLS Client Authâœ”    With CA Certâœ”\n~~~\n\n![1583506058483](assets/1583506058483.png)\n\n~~~\n# å¡«å…¥å‚æ•°ï¼š\n# 200æœºå™¨æ‹¿caç­‰ï¼š\n~]# cat /opt/certs/ca.pem\n~]# cat /opt/certs/client.pem\n~]# cat /opt/certs/client-key.pem\n~~~\n\n![1583506131529](assets/1583506131529.png)\n\nsaveåå†ç‚¹å‡»å³ä¾§æ¡†çš„å›¾æ ‡ï¼Œå¹¶ç‚¹å‡»Name\n\n![1583506163546](assets/1583506163546.png)\n\nå¯èƒ½æŠ“å–æ•°æ®çš„æ—¶é—´ä¼šç¨å¾®æ…¢äº›ï¼ˆä¸¤åˆ†é’Ÿå·¦å³ï¼‰\n\n![1583506184293](assets/1583506184293.png)\n\n![1583506503213](assets/1583506503213.png)\n\nç‚¹å‡»å³ä¸Šè§’çš„K8s Clusterï¼Œé€‰æ‹©ä½ è¦çœ‹çš„ä¸œè¥¿\n\n![1583506545308](assets/1583506545308.png)\n\nç”±äºK8s Containeré‡Œé¢æ•°æ®ä¸å…¨ï¼Œå¦‚ä¸‹å›¾\n\n![1583506559069](assets/1583506559069.png)\n\næˆ‘ä»¬æ”¹ä¸‹ï¼ŒæŠŠClusteråˆ äº†\n\n![1583506631392](assets/1583506631392.png)\n\n![1583506645982](assets/1583506645982.png)\n\ncontainerä¹Ÿåˆ äº†\n\n![1583506675876](assets/1583506675876.png)\n\ndeploymentä¹Ÿåˆ äº†\n\n![1583506695618](assets/1583506695618.png)\n\nnodeä¹Ÿåˆ äº†\n\n![1583506709705](assets/1583506709705.png)\n\n![1583506730713](assets/1583506730713.png)\n\n![1583506744138](assets/1583506744138.png)\n\næŠŠæˆ‘ç»™ä½ å‡†å¤‡çš„dashboardçš„jsonæ–‡ä»¶importè¿›æ¥\n\n![1583543092886](assets/1583543092886.png)\n\n![1583543584476](assets/1583543584476.png)\n\n![1583543602130](assets/1583543602130.png)\n\nç”¨åŒæ ·çš„æ–¹æ³•æŠŠnodeã€deploymentã€clusterã€containerè¿™4ä¸ªåˆ†åˆ«importè¿›æ¥\n\n![1583543698727](assets/1583543698727.png)\n\nå¯ä»¥éƒ½çœ‹ä¸€ä¸‹ï¼Œå·²ç»æ­£å¸¸äº†\n\nç„¶åæŠŠetcdã€genericã€traefikä¹Ÿimportè¿›æ¥\n\n![1583543809740](assets/1583543809740.png)\n\n![1583543831830](assets/1583543831830.png)\n\nè¿˜æœ‰å¦å¤–ä¸€ç§importçš„æ–¹æ³•ï¼ˆä½¿ç”¨å®˜ç½‘çš„ï¼‰ï¼š\n\n[grafanaå®˜ç½‘](https://grafana.com/grafana/dashboards)\n\næ‰¾ä¸€ä¸ªåˆ«äººå†™å¥½çš„ç‚¹è¿›å»\n\n![1584241883144](assets/1584241883144.png)\n\nè¿™ä¸ªç¼–å·å¯ä»¥ç›´æ¥ç”¨\n\n![1584241903882](assets/1584241903882.png)\n\nå¦‚ä¸‹å›¾ï¼Œæˆ‘ä»¬è£…blackboxçš„ç¼–å·æ˜¯9965\n\n![1584242072703](assets/1584242072703.png)\n\n![1584242093513](assets/1584242093513.png)\n\næŠŠåå­—å’ŒPrometheusä¿®æ”¹ä¸€ä¸‹\n\n![1584242164621](assets/1584242164621.png)\n\næˆ–è€…ï¼Œä½ ä¹Ÿå¯ä»¥ç”¨æˆ‘ä¸Šä¼ çš„ï¼ˆæˆ‘ç”¨çš„æ˜¯7587ï¼‰\n\n![1583543931644](assets/1583543931644.png)\n\nä½ å¯ä»¥ä¸¤ä¸ªéƒ½ç”¨ï¼Œè‡ªå·±åšå¯¹æ¯”ï¼Œéƒ½ç•™ç€ä¹Ÿå¯ä»¥ï¼Œå°±æ˜¯å ä¸€äº›èµ„æº\n\nJMX\n\n![1583544009027](assets/1583544009027.png)\n\nè¿™ä¸ªé‡Œé¢è¿˜ä»€ä¹ˆéƒ½æ²¡æœ‰\n\n![1583544017606](assets/1583544017606.png)\n\n\n\n#### æŠŠDubboå¾®æœåŠ¡æ•°æ®å¼„åˆ°Grafana\n\ndubbo-service\n\n![1583544062372](assets/1583544062372.png)\n\n~~~\n# Edit a Daemon Setï¼Œæ·»åŠ ä»¥ä¸‹å†…å®¹ï¼Œæ³¨æ„ç»™ä¸Šä¸€è¡ŒåŠ é€—å·\n  \"prometheus_io_scrape\": \"true\",\n  \"prometheus_io_port\": \"12346\",\n  \"prometheus_io_path\": \"/\"\n# ç›´æ¥åŠ è¿›å»updateï¼Œä¼šè‡ªåŠ¨å¯¹é½ï¼Œ\n~~~\n\n![1583544144136](assets/1583544144136.png)\n\ndubbo-consumer\n\n![1583544157268](assets/1583544157268.png)\n\n~~~\n# Edit a Daemon Setï¼Œæ·»åŠ ä»¥ä¸‹å†…å®¹ï¼Œæ³¨æ„ç»™ä¸Šä¸€è¡ŒåŠ é€—å·\n  \"prometheus_io_scrape\": \"true\",\n  \"prometheus_io_port\": \"12346\",\n  \"prometheus_io_path\": \"/\"\n# ç›´æ¥åŠ è¿›å»updateï¼Œä¼šè‡ªåŠ¨å¯¹é½ï¼Œ\n~~~\n\n![1583544192459](assets/1583544192459.png)\n\nåˆ·æ–°JMXï¼ˆå¯èƒ½æœ‰ç‚¹æ…¢ï¼Œæˆ‘ç­‰äº†1åˆ†é’Ÿæ‰å‡ºæ¥serviceï¼Œæˆ‘æœºå™¨ä¸è¡Œäº†ï¼‰\n\n![1583544446817](assets/1583544446817.png)\n\nå®Œæˆ\n\n> æ­¤æ—¶ä½ å¯ä»¥æ„Ÿå—åˆ°ï¼ŒGrafanaæ˜æ˜¾æ¯”K8Sè‡ªå¸¦çš„UIç•Œé¢æ›´åŠ äººæ€§åŒ–\n\n\n\n### å®‰è£…éƒ¨ç½²alertmanager\n\n> **WHAT**ï¼š ä» Prometheus server ç«¯æ¥æ”¶åˆ° alerts åï¼Œä¼šè¿›è¡Œå»é™¤é‡å¤æ•°æ®ï¼Œåˆ†ç»„ï¼Œå¹¶è·¯ç”±åˆ°å¯¹æ–¹çš„æ¥å—æ–¹å¼ï¼Œå‘å‡ºæŠ¥è­¦ã€‚å¸¸è§çš„æ¥æ”¶æ–¹å¼æœ‰ï¼šç”µå­é‚®ä»¶ï¼Œpagerduty ç­‰ã€‚\n>\n> **WHY**ï¼šä½¿å¾—ç³»ç»Ÿçš„è­¦å‘Šéšæ—¶è®©æˆ‘ä»¬çŸ¥é“\n\n~~~\n# 200æœºå™¨ï¼Œå‡†å¤‡é•œåƒã€èµ„æºæ¸…å•ï¼š\n~]# mkdir /data/k8s-yaml/alertmanager\n~]# cd /data/k8s-yaml/alertmanager\nalertmanager]# docker pull docker.io/prom/alertmanager:v0.14.0\n# æ³¨æ„ï¼Œè¿™é‡Œä½ å¦‚æœä¸ç”¨14ç‰ˆæœ¬å¯èƒ½ä¼šæŠ¥é”™\nalertmanager]# docker images|grep alert\nalertmanager]# docker tag 23744b2d645c harbor.od.com/infra/alertmanager:v0.14.0\nalertmanager]# docker push harbor.od.com/infra/alertmanager:v0.14.0\n# æ³¨æ„ä¸‹é¢è®°å¾—ä¿®æ”¹æˆä½ è‡ªå·±çš„é‚®ç®±ç­‰ä¿¡æ¯ï¼Œè¿˜æœ‰ä¸­æ–‡æ³¨é‡Šå¯ä»¥åˆ æ‰\nalertmanager]# vi cm.yaml\napiVersion: v1\nkind: ConfigMap\nmetadata:\n  name: alertmanager-config\n  namespace: infra\ndata:\n  config.yml: |-\n    global:\n      # åœ¨æ²¡æœ‰æŠ¥è­¦çš„æƒ…å†µä¸‹å£°æ˜ä¸ºå·²è§£å†³çš„æ—¶é—´\n      resolve_timeout: 5m\n      # é…ç½®é‚®ä»¶å‘é€ä¿¡æ¯\n      smtp_smarthost: 'smtp.163.com:25'\n      smtp_from: 'ben909336740@163.com'\n      smtp_auth_username: 'ben909336740@163.com'\n      smtp_auth_password: 'xxxxxx'\n      smtp_require_tls: false\n    # æ‰€æœ‰æŠ¥è­¦ä¿¡æ¯è¿›å…¥åçš„æ ¹è·¯ç”±ï¼Œç”¨æ¥è®¾ç½®æŠ¥è­¦çš„åˆ†å‘ç­–ç•¥\n    route:\n      # è¿™é‡Œçš„æ ‡ç­¾åˆ—è¡¨æ˜¯æ¥æ”¶åˆ°æŠ¥è­¦ä¿¡æ¯åçš„é‡æ–°åˆ†ç»„æ ‡ç­¾ï¼Œä¾‹å¦‚ï¼Œæ¥æ”¶åˆ°çš„æŠ¥è­¦ä¿¡æ¯é‡Œé¢æœ‰è®¸å¤šå…·æœ‰ cluster=A å’Œ alertname=LatncyHigh è¿™æ ·çš„æ ‡ç­¾çš„æŠ¥è­¦ä¿¡æ¯å°†ä¼šæ‰¹é‡è¢«èšåˆåˆ°ä¸€ä¸ªåˆ†ç»„é‡Œé¢\n      group_by: ['alertname', 'cluster']\n      # å½“ä¸€ä¸ªæ–°çš„æŠ¥è­¦åˆ†ç»„è¢«åˆ›å»ºåï¼Œéœ€è¦ç­‰å¾…è‡³å°‘group_waitæ—¶é—´æ¥åˆå§‹åŒ–é€šçŸ¥ï¼Œè¿™ç§æ–¹å¼å¯ä»¥ç¡®ä¿æ‚¨èƒ½æœ‰è¶³å¤Ÿçš„æ—¶é—´ä¸ºåŒä¸€åˆ†ç»„æ¥è·å–å¤šä¸ªè­¦æŠ¥ï¼Œç„¶åä¸€èµ·è§¦å‘è¿™ä¸ªæŠ¥è­¦ä¿¡æ¯ã€‚\n      group_wait: 30s\n\n      # å½“ç¬¬ä¸€ä¸ªæŠ¥è­¦å‘é€åï¼Œç­‰å¾…'group_interval'æ—¶é—´æ¥å‘é€æ–°çš„ä¸€ç»„æŠ¥è­¦ä¿¡æ¯ã€‚\n      group_interval: 5m\n\n      # å¦‚æœä¸€ä¸ªæŠ¥è­¦ä¿¡æ¯å·²ç»å‘é€æˆåŠŸäº†ï¼Œç­‰å¾…'repeat_interval'æ—¶é—´æ¥é‡æ–°å‘é€ä»–ä»¬\n      repeat_interval: 5m\n\n      # é»˜è®¤çš„receiverï¼šå¦‚æœä¸€ä¸ªæŠ¥è­¦æ²¡æœ‰è¢«ä¸€ä¸ªrouteåŒ¹é…ï¼Œåˆ™å‘é€ç»™é»˜è®¤çš„æ¥æ”¶å™¨\n      receiver: default\n\n    receivers:\n    - name: 'default'\n      email_configs:\n      - to: '909336740@qq.com'\n        send_resolved: true\n\nalertmanager]# vi dp.yaml\napiVersion: extensions/v1beta1\nkind: Deployment\nmetadata:\n  name: alertmanager\n  namespace: infra\nspec:\n  replicas: 1\n  selector:\n    matchLabels:\n      app: alertmanager\n  template:\n    metadata:\n      labels:\n        app: alertmanager\n    spec:\n      containers:\n      - name: alertmanager\n        image: harbor.od.com/infra/alertmanager:v0.14.0\n        args:\n          - \"--config.file=/etc/alertmanager/config.yml\"\n          - \"--storage.path=/alertmanager\"\n        ports:\n        - name: alertmanager\n          containerPort: 9093\n        volumeMounts:\n        - name: alertmanager-cm\n          mountPath: /etc/alertmanager\n      volumes:\n      - name: alertmanager-cm\n        configMap:\n          name: alertmanager-config\n      imagePullSecrets:\n      - name: harbor\n\nalertmanager]# vi svc.yaml\napiVersion: v1\nkind: Service\nmetadata:\n  name: alertmanager\n  namespace: infra\nspec:\n  selector: \n    app: alertmanager\n  ports:\n    - port: 80\n      targetPort: 9093\n~~~\n\n![1583547933312](assets/1583547933312.png)\n\n~~~\n# 22æœºå™¨ï¼Œåº”ç”¨æ¸…å•ï¼š\n~]# kubectl apply -f http://k8s-yaml.od.com/alertmanager/cm.yaml\n~]# kubectl apply -f http://k8s-yaml.od.com/alertmanager/dp.yaml\n~]# kubectl apply -f http://k8s-yaml.od.com/alertmanager/svc.yaml\n~~~\n\n![1583545326722](assets/1583545326722.png)\n\n![1583545352951](assets/1583545352951.png)\n\n~~~\n# 200æœºå™¨ï¼Œé…ç½®æŠ¥è­¦è§„åˆ™ï¼š\n~]# vi /data/nfs-volume/prometheus/etc/rules.yml\ngroups:\n- name: hostStatsAlert\n  rules:\n  - alert: hostCpuUsageAlert\n    expr: sum(avg without (cpu)(irate(node_cpu{mode!='idle'}[5m]))) by (instance) > 0.85\n    for: 5m\n    labels:\n      severity: warning\n    annotations:\n      summary: \"{{ $labels.instance }} CPU usage above 85% (current value: {{ $value }}%)\"\n  - alert: hostMemUsageAlert\n    expr: (node_memory_MemTotal - node_memory_MemAvailable)/node_memory_MemTotal > 0.85\n    for: 5m\n    labels:\n      severity: warning\n    annotations:\n      summary: \"{{ $labels.instance }} MEM usage above 85% (current value: {{ $value }}%)\"\n  - alert: OutOfInodes\n    expr: node_filesystem_free{fstype=\"overlay\",mountpoint =\"/\"} / node_filesystem_size{fstype=\"overlay\",mountpoint =\"/\"} * 100 < 10\n    for: 5m\n    labels:\n      severity: warning\n    annotations:\n      summary: \"Out of inodes (instance {{ $labels.instance }})\"\n      description: \"Disk is almost running out of available inodes (< 10% left) (current value: {{ $value }})\"\n  - alert: OutOfDiskSpace\n    expr: node_filesystem_free{fstype=\"overlay\",mountpoint =\"/rootfs\"} / node_filesystem_size{fstype=\"overlay\",mountpoint =\"/rootfs\"} * 100 < 10\n    for: 5m\n    labels:\n      severity: warning\n    annotations:\n      summary: \"Out of disk space (instance {{ $labels.instance }})\"\n      description: \"Disk is almost full (< 10% left) (current value: {{ $value }})\"\n  - alert: UnusualNetworkThroughputIn\n    expr: sum by (instance) (irate(node_network_receive_bytes[2m])) / 1024 / 1024 > 100\n    for: 5m\n    labels:\n      severity: warning\n    annotations:\n      summary: \"Unusual network throughput in (instance {{ $labels.instance }})\"\n      description: \"Host network interfaces are probably receiving too much data (> 100 MB/s) (current value: {{ $value }})\"\n  - alert: UnusualNetworkThroughputOut\n    expr: sum by (instance) (irate(node_network_transmit_bytes[2m])) / 1024 / 1024 > 100\n    for: 5m\n    labels:\n      severity: warning\n    annotations:\n      summary: \"Unusual network throughput out (instance {{ $labels.instance }})\"\n      description: \"Host network interfaces are probably sending too much data (> 100 MB/s) (current value: {{ $value }})\"\n  - alert: UnusualDiskReadRate\n    expr: sum by (instance) (irate(node_disk_bytes_read[2m])) / 1024 / 1024 > 50\n    for: 5m\n    labels:\n      severity: warning\n    annotations:\n      summary: \"Unusual disk read rate (instance {{ $labels.instance }})\"\n      description: \"Disk is probably reading too much data (> 50 MB/s) (current value: {{ $value }})\"\n  - alert: UnusualDiskWriteRate\n    expr: sum by (instance) (irate(node_disk_bytes_written[2m])) / 1024 / 1024 > 50\n    for: 5m\n    labels:\n      severity: warning\n    annotations:\n      summary: \"Unusual disk write rate (instance {{ $labels.instance }})\"\n      description: \"Disk is probably writing too much data (> 50 MB/s) (current value: {{ $value }})\"\n  - alert: UnusualDiskReadLatency\n    expr: rate(node_disk_read_time_ms[1m]) / rate(node_disk_reads_completed[1m]) > 100\n    for: 5m\n    labels:\n      severity: warning\n    annotations:\n      summary: \"Unusual disk read latency (instance {{ $labels.instance }})\"\n      description: \"Disk latency is growing (read operations > 100ms) (current value: {{ $value }})\"\n  - alert: UnusualDiskWriteLatency\n    expr: rate(node_disk_write_time_ms[1m]) / rate(node_disk_writes_completedl[1m]) > 100\n    for: 5m\n    labels:\n      severity: warning\n    annotations:\n      summary: \"Unusual disk write latency (instance {{ $labels.instance }})\"\n      description: \"Disk latency is growing (write operations > 100ms) (current value: {{ $value }})\"\n- name: http_status\n  rules:\n  - alert: ProbeFailed\n    expr: probe_success == 0\n    for: 1m\n    labels:\n      severity: error\n    annotations:\n      summary: \"Probe failed (instance {{ $labels.instance }})\"\n      description: \"Probe failed (current value: {{ $value }})\"\n  - alert: StatusCode\n    expr: probe_http_status_code <= 199 OR probe_http_status_code >= 400\n    for: 1m\n    labels:\n      severity: error\n    annotations:\n      summary: \"Status Code (instance {{ $labels.instance }})\"\n      description: \"HTTP status code is not 200-399 (current value: {{ $value }})\"\n  - alert: SslCertificateWillExpireSoon\n    expr: probe_ssl_earliest_cert_expiry - time() < 86400 * 30\n    for: 5m\n    labels:\n      severity: warning\n    annotations:\n      summary: \"SSL certificate will expire soon (instance {{ $labels.instance }})\"\n      description: \"SSL certificate expires in 30 days (current value: {{ $value }})\"\n  - alert: SslCertificateHasExpired\n    expr: probe_ssl_earliest_cert_expiry - time()  <= 0\n    for: 5m\n    labels:\n      severity: error\n    annotations:\n      summary: \"SSL certificate has expired (instance {{ $labels.instance }})\"\n      description: \"SSL certificate has expired already (current value: {{ $value }})\"\n  - alert: BlackboxSlowPing\n    expr: probe_icmp_duration_seconds > 2\n    for: 5m\n    labels:\n      severity: warning\n    annotations:\n      summary: \"Blackbox slow ping (instance {{ $labels.instance }})\"\n      description: \"Blackbox ping took more than 2s (current value: {{ $value }})\"\n  - alert: BlackboxSlowRequests\n    expr: probe_http_duration_seconds > 2 \n    for: 5m\n    labels:\n      severity: warning\n    annotations:\n      summary: \"Blackbox slow requests (instance {{ $labels.instance }})\"\n      description: \"Blackbox request took more than 2s (current value: {{ $value }})\"\n  - alert: PodCpuUsagePercent\n    expr: sum(sum(label_replace(irate(container_cpu_usage_seconds_total[1m]),\"pod\",\"$1\",\"container_label_io_kubernetes_pod_name\", \"(.*)\"))by(pod) / on(pod) group_right kube_pod_container_resource_limits_cpu_cores *100 )by(container,namespace,node,pod,severity) > 80\n    for: 5m\n    labels:\n      severity: warning\n    annotations:\n      summary: \"Pod cpu usage percent has exceeded 80% (current value: {{ $value }}%)\"\n\n# åœ¨æœ€åé¢æ·»åŠ å¦‚ä¸‹å†…å®¹\n~]# vi /data/nfs-volume/prometheus/etc/prometheus.yml\nalerting:\n  alertmanagers:\n    - static_configs:\n        - targets: [\"alertmanager\"]\nrule_files:\n - \"/data/etc/rules.yml\"\n~~~\n\n> ![1583545590235](assets/1583545590235.png)\n>\n> **rules.ymlæ–‡ä»¶**ï¼šè¿™ä¸ªæ–‡ä»¶å°±æ˜¯æŠ¥è­¦è§„åˆ™\n>\n> è¿™æ—¶å€™å¯ä»¥é‡å¯Prometheusçš„podï¼Œä½†ç”Ÿäº§å•†å› ä¸ºPrometheuså¤ªåºå¤§ï¼Œåˆ æ‰å®¹æ˜“æ‹–å®é›†ç¾¤ï¼Œæ‰€ä»¥æˆ‘ä»¬ç”¨å¦å¤–ä¸€ç§æ–¹æ³•ï¼Œå¹³æ»‘åŠ è½½ï¼ˆPrometheusæ”¯æŒï¼‰ï¼š\n\n~~~\n# 21æœºå™¨ï¼Œå› ä¸ºæˆ‘ä»¬èµ·çš„Prometheusæ˜¯åœ¨21æœºå™¨ï¼Œå¹³æ»‘åŠ è½½:\n~]# ps aux|grep prometheus\n~]# kill -SIGHUP 1488\n~~~\n\n![1583545718137](assets/1583545718137.png)\n\n![1583545762475](assets/1583545762475.png)\n\n> è¿™æ—¶å€™æŠ¥è­¦è§„åˆ™å°±éƒ½æœ‰äº†\n>\n\n\n\n### æµ‹è¯•alertmanageræŠ¥è­¦åŠŸèƒ½\n\nå…ˆæŠŠå¯¹åº”çš„ä¸¤ä¸ªé‚®ç®±çš„stmpéƒ½æ‰“å¼€\n\n![1583721318338](assets/1583721318338.png)\n\n![1583721408460](assets/1583721408460.png)\n\næˆ‘ä»¬æµ‹è¯•ä¸€ä¸‹ï¼ŒæŠŠdubbo-serviceåœäº†ï¼Œè¿™æ ·consumerå°±ä¼šæŠ¥é”™\n\næŠŠserviceçš„scaleæ”¹æˆ0\n\n![1583545840349](assets/1583545840349.png)\n\n[blackbox.od.com](blackbox.od.com)æŸ¥çœ‹ï¼Œå·²ç»failureäº†\n\n![1583545937643](assets/1583545937643.png)\n\n[prometheus.od.com.alerts](prometheus.od.com.alerts)æŸ¥çœ‹ï¼Œä¸¤ä¸ªå˜çº¢äº†ï¼ˆä¸€å¼€å§‹æ˜¯å˜é»„ï¼‰\n\n![1583548102650](assets/1583548102650.png)\n\n![1583545983131](assets/1583545983131.png)\n\nè¿™æ—¶å€™å¯ä»¥åœ¨163é‚®ç®±çœ‹åˆ°å·²å‘é€çš„æŠ¥è­¦\n\n![1583721856162](assets/1583721856162.png)\n\nQQé‚®ç®±æ”¶åˆ°æŠ¥è­¦\n\n![1583721899076](assets/1583721899076.png)\n\nå®Œæˆï¼ˆserviceçš„scaleè®°å¾—æ”¹å›1ï¼‰\n\n> å…³äºrules.ymlï¼šæŠ¥è­¦ä¸èƒ½é”™æŠ¥ä¹Ÿä¸èƒ½æ¼æŠ¥ï¼Œåœ¨å®é™…åº”ç”¨ä¸­ï¼Œæˆ‘ä»¬éœ€è¦ä¸æ–­çš„ä¿®æ”¹rulesçš„è§„åˆ™ï¼Œä»¥æ¥è´´è¿‘æˆ‘ä»¬å…¬å¸çš„å®é™…éœ€æ±‚ã€‚\n\n\n\n#### èµ„æºä¸è¶³æ—¶ï¼Œå¯å…³é—­éƒ¨åˆ†éå¿…è¦èµ„æº\n\n~~~\n# 22æœºå™¨ï¼Œä¹Ÿå¯ä»¥ç”¨dashboardæ“ä½œï¼š\n~]# kubectl scale deployment grafana --replicas=0 -n infra\n# out : deployment.extensions/grafana scaled\n~]# kubectl scale deployment alertmanager --replicas=0 -n infra\n# out : deployment.extensions/alertmanager scaled\n~]# kubectl scale deployment prometheus --replicas=0 -n infra\n# out : deployment.extensions/prometheus scaled\n~~~\n\n\n\n### é€šè¿‡K8Séƒ¨ç½²dubboå¾®æœåŠ¡æ¥å…¥ELKæ¶æ„\n\n> **WHAT**ï¼šELKæ˜¯ä¸‰ä¸ªå¼€æºè½¯ä»¶çš„ç¼©å†™ï¼Œåˆ†åˆ«æ˜¯ï¼š\n>\n> - Eâ€”â€”ElasticSearchï¼šåˆ†å¸ƒå¼æœç´¢å¼•æ“ï¼Œæä¾›æœé›†ã€åˆ†æã€å­˜å‚¨æ•°æ®ä¸‰å¤§åŠŸèƒ½ã€‚\n> - Lâ€”â€”LogStashï¼šå¯¹æ—¥å¿—çš„æœé›†ã€åˆ†æã€è¿‡æ»¤æ—¥å¿—çš„å·¥å…·ï¼Œæ”¯æŒå¤§é‡çš„æ•°æ®è·å–æ–¹å¼ã€‚\n> - Kâ€”â€”Kibanaï¼šä¸º Logstash å’Œ ElasticSearch æä¾›çš„æ—¥å¿—åˆ†æå‹å¥½çš„ Web ç•Œé¢ï¼Œå¯ä»¥å¸®åŠ©æ±‡æ€»ã€åˆ†æå’Œæœç´¢é‡è¦æ•°æ®æ—¥å¿—ã€‚\n> - è¿˜æœ‰æ–°å¢çš„FileBeatï¼ˆæµå¼æ—¥å¿—æ”¶é›†å™¨ï¼‰ï¼šè½»é‡çº§çš„æ—¥å¿—æ”¶é›†å¤„ç†å·¥å…·ï¼Œå ç”¨èµ„æºå°‘ï¼Œé€‚åˆäºåœ¨å„ä¸ªæœåŠ¡å™¨ä¸Šæœé›†æ—¥å¿—åä¼ è¾“ç»™Logstashï¼Œå®˜æ–¹ä¹Ÿæ¨èæ­¤å·¥å…·ï¼Œç”¨æ¥æ›¿ä»£éƒ¨åˆ†åŸæœ¬Logstashçš„å·¥ä½œã€‚[æ”¶é›†æ—¥å¿—çš„å¤šç§æ–¹å¼åŠåŸç†](https://github.com/ben1234560/k8s_PaaS/blob/master/%E5%8E%9F%E7%90%86%E5%8F%8A%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/Kubernetes%E7%9B%B8%E5%85%B3%E7%94%9F%E6%80%81.md#%E6%97%A5%E5%BF%97%E6%94%B6%E9%9B%86%E4%B8%8E%E7%AE%A1%E7%90%86)\n>\n> **WHY**ï¼š éšç€å®¹å™¨ç¼–æ’çš„è¿›è¡Œï¼Œä¸šåŠ¡å®¹å™¨åœ¨ä¸æ–­çš„è¢«åˆ›å»ºã€æ‘§æ¯ã€è¿ç§»ã€æ‰©å®¹ç¼©å®¹ç­‰ï¼Œé¢å¯¹å¦‚æ­¤æµ·é‡çš„æ•°æ®ï¼Œåˆåˆ†å¸ƒåœ¨å„ä¸ªä¸åŒçš„åœ°æ–¹ï¼Œæˆ‘ä»¬ä¸å¯èƒ½ç”¨ä¼ ç»Ÿçš„æ–¹æ³•ç™»å½•åˆ°æ¯å°æœºå™¨çœ‹ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦å»ºç«‹ä¸€å¥—é›†ä¸­çš„æ–¹æ³•ã€‚æˆ‘ä»¬éœ€è¦è¿™æ ·ä¸€å¥—æ—¥å¿—æ‰‹æœºã€åˆ†æçš„ç³»ç»Ÿï¼š\n>\n> - æ”¶é›†â€”â€”é‡‡é›†å¤šç§æ¥æºçš„æ—¥å¿—æ•°æ®ï¼ˆæµå¼æ—¥å¿—æ”¶é›†å™¨ï¼‰\n> - ä¼ è¾“â€”â€”ç¨³å®šçš„æŠŠæ—¥å¿—æ•°æ®ä¼ è¾“åˆ°ä¸­å¤®ç³»ç»Ÿï¼ˆæ¶ˆæ¯é˜Ÿåˆ—ï¼‰\n> - å­˜å‚¨â€”â€”å°†æ—¥å¿—ä»¥ç»“æ„åŒ–æ•°æ®çš„å½¢å¼å­˜å‚¨èµ·æ¥ï¼ˆæœç´¢å¼•æ“ï¼‰\n> - åˆ†æâ€”â€”æ”¯æŒæ–¹ä¾¿çš„åˆ†æã€æ£€ç´¢ç­‰ï¼Œæœ‰GUIç®¡ç†ç³»ç»Ÿï¼ˆå‰ç«¯ï¼‰\n> - è­¦å‘Šâ€”â€”æä¾›é”™è¯¯æŠ¥å‘Šï¼Œç›‘æ§æœºåˆ¶ï¼ˆç›‘æ§å·¥å…·ï¼‰\n>\n> #### è¿™å°±æ˜¯ELK\n\n#### ELK Stackæ¦‚è¿°\n\n![1581729929995](assets/1581729929995.png)\n\n> **c1/c2**ï¼šcontainerï¼ˆå®¹å™¨ï¼‰çš„ç¼©å†™\n>\n> **filebeat**ï¼šæ”¶é›†ä¸šåŠ¡å®¹å™¨çš„æ—¥å¿—ï¼ŒæŠŠcå’Œfilebeatæ”¾åœ¨ä¸€ä¸ªpodé‡Œè®©ä»–ä»¬ä¸€èµ·è·‘ï¼Œè¿™æ ·è€¦åˆå°±ç´§äº†\n>\n> **kafka**ï¼šé«˜ååé‡çš„[åˆ†å¸ƒå¼](https://baike.baidu.com/item/%E5%88%86%E5%B8%83%E5%BC%8F/19276232)å‘å¸ƒè®¢é˜…æ¶ˆæ¯ç³»ç»Ÿï¼Œå®ƒå¯ä»¥å¤„ç†æ¶ˆè´¹è€…åœ¨ç½‘ç«™ä¸­çš„æ‰€æœ‰åŠ¨ä½œæµæ•°æ®ã€‚filebeatæ”¶é›†æ•°æ®ä»¥Topicå½¢å¼å‘å¸ƒåˆ°kafkaã€‚\n>\n> **Topic**ï¼šKafkaæ•°æ®å†™å…¥æ“ä½œçš„åŸºæœ¬å•å…ƒ\n>\n> **logstash**ï¼šå–kafkaé‡Œçš„topicï¼Œç„¶åå†å¾€ElasticSearchä¸Šä¼ ï¼ˆå¼‚æ­¥è¿‡ç¨‹ï¼Œå³åˆå–åˆä¼ ï¼‰\n>\n> **index-pattern**ï¼šæŠŠæ•°æ®æŒ‰ç¯å¢ƒåˆ†ï¼ˆæŒ‰prodå’Œteståˆ†ï¼‰ï¼Œå¹¶ä¼ åˆ°kibana\n>\n> **kibana**ï¼šå±•ç¤ºæ•°æ®\n\n\n\n### åˆ¶ä½œtomcatå®¹å™¨çš„åº•åŒ…é•œåƒ\n\n> å°è¯•ç”¨tomcatçš„æ–¹å¼ï¼Œå› ä¸ºå¾ˆå¤šå…¬å¸è€é¡¹ç›®éƒ½æ˜¯ç”¨tomcatè·‘èµ·æ¥ï¼Œä¹‹å‰æˆ‘ä»¬ç”¨çš„æ˜¯springboot\n\n[tomcatå®˜ç½‘](tomcat.apache.org)\n\n![1583558092305](assets/1583558092305.png)\n\n~~~\n# 200 æœºå™¨ï¼š\ncd /opt/src/\n# ä½ ä¹Ÿå¯ä»¥ç›´æ¥ç”¨æˆ‘ä¸Šä¼ çš„ï¼Œå› ä¸ºç‰ˆæœ¬ä¸€ç›´åœ¨å˜ï¼Œä¹‹å‰çš„ç‰ˆæœ¬ä½ æ˜¯ä¸‹è½½ä¸ä¸‹æ¥çš„ï¼Œå¦‚ä½•æŸ¥çœ‹æ–°ç‰ˆæœ¬å¦‚ä¸Šå›¾\nsrc]# wget https://archive.apache.org/dist/tomcat/tomcat-8/v8.5.51/bin/apache-tomcat-8.5.51.tar.gz\nsrc]# mkdir /data/dockerfile/tomcat\nsrc]# tar xfv  apache-tomcat-8.5.51.tar.gz -C /data/dockerfile/tomcat\nsrc]# cd /data/dockerfile/tomcat\n# é…ç½®tomcat-å…³é—­AJPç«¯å£\ntomcat]# vi apache-tomcat-8.5.51/conf/server.xml\n# æ‰¾åˆ°AJPï¼Œæ³¨é‡Šæ‰ç›¸åº”çš„ä¸€è¡Œï¼Œç»“æœå¦‚ä¸‹å›¾ï¼Œ8.5.51æ˜¯å·²ç»è‡ªåŠ¨æ³¨é‡Šæ‰çš„\n~~~\n\n![1583558364369](assets/1583558364369.png)\n\n~~~\n# 200æœºå™¨ï¼Œåˆ æ‰ä¸éœ€è¦çš„æ—¥å¿—ï¼š\ntomcat]# vi apache-tomcat-8.5.51/conf/logging.properties\n# åˆ æ‰3managerï¼Œ4host-managerçš„handlersï¼Œå¹¶æ³¨é‡Šæ‰ç›¸å…³çš„ï¼Œç»“æœå¦‚ä¸‹å›¾\n# æ—¥å¿—çº§åˆ«æ”¹æˆINFO\n~~~\n\n![1583558487445](assets/1583558487445.png)\n\n![1583558525033](assets/1583558525033.png)\n\n![1583558607700](assets/1583558607700.png)\n\n~~~\n# 200æœºå™¨ï¼Œå‡†å¤‡Dockerfileï¼š\ntomcat]# vi Dockerfile\nFrom harbor.od.com/public/jre:8u112\nRUN /bin/cp /usr/share/zoneinfo/Asia/Shanghai /etc/localtime &&\\ \n    echo 'Asia/Shanghai' >/etc/timezone\nENV CATALINA_HOME /opt/tomcat\nENV LANG zh_CN.UTF-8\nADD apache-tomcat-8.5.51/ /opt/tomcat\nADD config.yml /opt/prom/config.yml\nADD jmx_javaagent-0.3.1.jar /opt/prom/jmx_javaagent-0.3.1.jar\nWORKDIR /opt/tomcat\nADD entrypoint.sh /entrypoint.sh\nCMD [\"/entrypoint.sh\"]\n\ntomcat]# vi config.yml\n---\nrules:\n  - pattern: '-*'\n\ntomcat]# wget https://repo1.maven.org/maven2/io/prometheus/jmx/jmx_prometheus_javaagent/0.3.1/jmx_prometheus_javaagent-0.3.1.jar -O jmx_javaagent-0.3.1.jar\ntomcat]# vi entrypoint.sh\n#!/bin/bash\nM_OPTS=\"-Duser.timezone=Asia/Shanghai -javaagent:/opt/prom/jmx_javaagent-0.3.1.jar=$(hostname -i):${M_PORT:-\"12346\"}:/opt/prom/config.yml\"\nC_OPTS=${C_OPTS}\nMIN_HEAP=${MIN_HEAP:-\"128m\"}\nMAX_HEAP=${MAX_HEAP:-\"128m\"}\nJAVA_OPTS=${JAVA_OPTS:-\"-Xmn384m -Xss256k -Duser.timezone=GMT+08  -XX:+DisableExplicitGC -XX:+UseConcMarkSweepGC -XX:+UseParNewGC -XX:+CMSParallelRemarkEnabled -XX:+UseCMSCompactAtFullCollection -XX:CMSFullGCsBeforeCompaction=0 -XX:+CMSClassUnloadingEnabled -XX:LargePageSizeInBytes=128m -XX:+UseFastAccessorMethods -XX:+UseCMSInitiatingOccupancyOnly -XX:CMSInitiatingOccupancyFraction=80 -XX:SoftRefLRUPolicyMSPerMB=0 -XX:+PrintClassHistogram  -Dfile.encoding=UTF8 -Dsun.jnu.encoding=UTF8\"}\nCATALINA_OPTS=\"${CATALINA_OPTS}\"\nJAVA_OPTS=\"${M_OPTS} ${C_OPTS} -Xms${MIN_HEAP} -Xmx${MAX_HEAP} ${JAVA_OPTS}\"\nsed -i -e \"1a\\JAVA_OPTS=\\\"$JAVA_OPTS\\\"\" -e \"1a\\CATALINA_OPTS=\\\"$CATALINA_OPTS\\\"\" /opt/tomcat/bin/catalina.sh\n\ncd /opt/tomcat && /opt/tomcat/bin/catalina.sh run 2>&1 >> /opt/tomcat/logs/stdout.log\n\ntomcat]# chmod u+x entrypoint.sh\ntomcat]# ll\ntomcat]# docker build . -t harbor.od.com/base/tomcat:v8.5.51\ntomcat]# docker push harbor.od.com/base/tomcat:v8.5.51\n~~~\n\n> **Dockerfileæ–‡ä»¶è§£æ**ï¼š\n>\n> - FROMï¼šé•œåƒåœ°å€\n> - RUNï¼šä¿®æ”¹æ—¶åŒº\n> - ENVï¼šè®¾ç½®ç¯å¢ƒå˜é‡ï¼ŒæŠŠtomcatè½¯ä»¶æ”¾åˆ°optä¸‹\n> - ENVï¼šè®¾ç½®ç¯å¢ƒå˜é‡ï¼Œå­—ç¬¦é›†ç”¨zh_CN.UTF-8\n> - ADDï¼šæŠŠapache-tomcat-8.5.50åŒ…æ”¾åˆ°/opt/tomcatä¸‹\n> - ADDï¼šè®©promeåŸºäºæ–‡ä»¶çš„è‡ªåŠ¨å‘ç°æœåŠ¡ï¼Œè¿™ä¸ªå¯ä»¥ä¸è¦ï¼Œå› ä¸ºæ²¡åœ¨ç”¨prome\n> - ADDï¼šæŠŠjmx_javaagent-0.3.1.jaråŒ…æ”¾åˆ°/opt/...ä¸‹ï¼Œç”¨æ¥ä¸“é—¨æ”¶é›†jvmçš„exportï¼Œèƒ½æä¾›ä¸€ä¸ªhttpçš„æ¥å£\n> - WORKDIRï¼šå·¥ä½œç›®å½•\n> - ADDï¼šç§»åŠ¨æ–‡ä»¶\n> - CMDï¼šè¿è¡Œæ–‡ä»¶\n\n![1583559245639](assets/1583559245639.png)\n\nå®Œæˆ\n\n\n\n### äº¤ä»˜tomcatå½¢å¼çš„dubboæœåŠ¡æ¶ˆè´¹è€…åˆ°K8Sé›†ç¾¤\n\næ”¹é€ ä¸‹dubbo-demo-webé¡¹ç›®\n\nç”±äºæ˜¯tomcatï¼Œæˆ‘ä»¬éœ€è¦å¤šå»ºä¸€æ¡Jenkinsæµæ°´çº¿\n\n![1583559296196](assets/1583559296196.png)\n\n![1583559325853](assets/1583559325853.png)\n\n![1583559348560](assets/1583559348560.png)\n\n1\n\n![1583559819045](assets/1583559819045.png)\n\n2\n\n![1583559830860](assets/1583559830860.png)\n\n3\n\n![1583559838755](assets/1583559838755.png)\n\n4\n\n![1583559908506](assets/1583559908506.png)\n\n5\n\n![1583559948318](assets/1583559948318.png)\n\n6\n\n![1583559958558](assets/1583559958558.png)\n\n7\n\n![1583559972282](assets/1583559972282.png)\n\n8\n\n![1583559985561](assets/1583559985561.png)\n\n9\n\n![1583560000469](assets/1583560000469.png)\n\n10\n\n![1583560009300](assets/1583560009300.png)\n\n11\n\n![1583560038370](assets/1583560038370.png)\n\n~~~shell\n# å°†å¦‚ä¸‹å†…å®¹å¡«å…¥pipelineï¼š\npipeline {\n  agent any \n    stages {\n    stage('pull') { //get project code from repo \n      steps {\n        sh \"git clone ${params.git_repo} ${params.app_name}/${env.BUILD_NUMBER} && cd ${params.app_name}/${env.BUILD_NUMBER} && git checkout ${params.git_ver}\"\n        }\n    }\n    stage('build') { //exec mvn cmd\n      steps {\n        sh \"cd ${params.app_name}/${env.BUILD_NUMBER}  && /var/jenkins_home/maven-${params.maven}/bin/${params.mvn_cmd}\"\n      }\n    }\n    stage('unzip') { //unzip  target/*.war -c target/project_dir\n      steps {\n        sh \"cd ${params.app_name}/${env.BUILD_NUMBER} && cd ${params.target_dir} && mkdir project_dir && unzip *.war -d ./project_dir\"\n      }\n    }\n    stage('image') { //build image and push to registry\n      steps {\n        writeFile file: \"${params.app_name}/${env.BUILD_NUMBER}/Dockerfile\", text: \"\"\"FROM harbor.od.com/${params.base_image}\nADD ${params.target_dir}/project_dir /opt/tomcat/webapps/${params.root_url}\"\"\"\n        sh \"cd  ${params.app_name}/${env.BUILD_NUMBER} && docker build -t harbor.od.com/${params.image_name}:${params.git_ver}_${params.add_tag} . && docker push harbor.od.com/${params.image_name}:${params.git_ver}_${params.add_tag}\"\n      }\n    }\n  }\n}\n~~~\n\n![1583560082441](assets/1583560082441.png)\n\nsave\n\nç‚¹å‡»æ„å»º\n\n![1583560122560](assets/1583560122560.png)\n\n~~~\n# å¡«å…¥æŒ‡å®šå‚æ•°ï¼Œæˆ‘çš„gitteeæ˜¯æœ‰tomcatçš„ç‰ˆæœ¬çš„ï¼Œä¸‹é¢æˆ‘ä¾æ—§ç”¨çš„æ˜¯gitlab\napp_name:       dubbo-demo-web\nimage_name:     app/dubbo-demo-web\ngit_repo:       http://gitlab.od.com:10000/909336740/dubbo-demo-web.git\ngit_ver:        tomcat\nadd_tag:        20200214_1300\nmvn_dir:        ./\ntarget_dir:     ./dubbo-client/target\nmvn_cmd:        mvn clean package -Dmaven.test.skip=true\nbase_image:     base/tomcat:v8.5.51\nmaven:          3.6.1-8u232\nroot_url:       ROOT\n# ç‚¹å‡»Buildè¿›è¡Œæ„å»ºï¼Œç­‰å¾…æ„å»ºå®Œæˆ\n~~~\n\n![1583561544404](assets/1583561544404.png)\n\nbuildæˆåŠŸå\n\n\n\nä¿®æ”¹ç‰ˆæœ¬ä¿¡æ¯ï¼Œåˆ æ‰20880ï¼Œå¦‚ä¸‹å›¾ï¼Œç„¶åupdate\n\n![1583630633310](assets/1583630633310.png)\n\n![1583630769979](assets/1583630769979.png)\n\næµè§ˆå™¨è¾“å…¥[demo-test.od.com/hello?name=tomcat](demo-test.od.com/hello?name=tomcat)\n\n![1583630984480](assets/1583630984480.png)\n\nå®Œæˆ\n\næŸ¥çœ‹dashboardé‡Œçš„podé‡Œ\n\n![1583631035074](assets/1583631035074.png)\n\n![1583631074816](assets/1583631074816.png)\n\n> è¿™äº›å°±æ˜¯æˆ‘ä»¬è¦æ”¶é›†çš„æ—¥å¿—ï¼Œæ”¶åˆ°ELK\n\n\n\n### äºŒè¿›åˆ¶å®‰è£…éƒ¨ç½²elasticsearch\n\n> æˆ‘ä»¬è¿™é‡Œåªéƒ¨ä¸€ä¸ªesçš„èŠ‚ç‚¹ï¼Œå› ä¸ºæˆ‘ä»¬ä¸»è¦æ˜¯äº†è§£æ•°æ®æµçš„æ–¹å¼\n>\n\n[å®˜ç½‘ä¸‹è½½åŒ…](https://www.elastic.co/downloads/past-releases/elasticsearch-6-8-6)å³é”®å¤åˆ¶é“¾æ¥\n\n![1581667412370](assets/1581667412370.png)\n\n~~~\n# 12æœºå™¨ï¼š\n~]# cd /opt/src/\nsrc]# wget https://artifacts.elastic.co/downloads/elasticsearch/elasticsearch-6.8.6.tar.gz\nsrc]# tar xfv elasticsearch-6.8.6.tar.gz -C /opt\nsrc]# ln -s /opt/elasticsearch-6.8.6/ /opt/elasticsearch\nsrc]# cd /opt/elasticsearch\n# é…ç½®\nelasticsearch]# mkdir -p /data/elasticsearch/{data,logs}\n# ä¿®æ”¹ä»¥ä¸‹å†…å®¹\nelasticsearch]# vi config/elasticsearch.yml\ncluster.name: es.od.com\nnode.name: hdss7-12.host.com\npath.data: /data/elasticsearch/data\npath.logs: /data/elasticsearch/logs\nbootstrap.memory_lock: true\nnetwork.host: 10.4.7.12\nhttp.port: 9200\n\n# ä¿®æ”¹ä»¥ä¸‹å†…å®¹\nelasticsearch]# vi config/jvm.options\n-Xms512m\n-Xmx512m\n\n# åˆ›å»ºæ™®é€šç”¨æˆ·\nelasticsearch]# useradd -s /bin/bash -M es\nelasticsearch]# chown -R es.es /opt/elasticsearch-6.8.6/\nelasticsearch]# chown -R es.es /data/elasticsearch/\n# æ–‡ä»¶æè¿°ç¬¦\nelasticsearch]# vi /etc/security/limits.d/es.conf\nes hard nofile 65536\nes soft fsize unlimited\nes hard memlock unlimited\nes soft memlock unlimited\n\n# è°ƒæ•´å†…æ ¸å‚æ•°\nelasticsearch]# sysctl -w vm.max_map_count=262144\nelasticsearch]# echo \"vm.max_map_count=262144\" >> /etc/sysctl.conf\nelasticsearch]# sysctl -p\n# å¯åŠ¨\nelasticsearch]# su -c \"/opt/elasticsearch/bin/elasticsearch -d\" es\nelasticsearch]# netstat -luntp|grep 9200\n# è°ƒæ•´ESæ—¥å¿—æ¨¡æ¿\nelasticsearch]# curl -H \"Content-Type:application/json\" -XPUT http://10.4.7.12:9200/_template/k8s -d '{\n  \"template\" : \"k8s*\",\n  \"index_patterns\": [\"k8s*\"],  \n  \"settings\": {\n    \"number_of_shards\": 5,\n    \"number_of_replicas\": 0\n  }\n}'\n~~~\n\n![1583631650876](assets/1583631650876.png)\n\n> å®Œæˆï¼Œä½ çœ‹æˆ‘æ•²è¿™ä¹ˆå¤šéå°±çŸ¥é“è¦ç­‰\n\n\n\n### å®‰è£…éƒ¨ç½²kafkaå’Œkafka-manager\n\n[å®˜ç½‘](https://kafka.apache.org)\n\n> åškafkaçš„æ—¶å€™ä¸å»ºè®®ç”¨è¶…è¿‡2.2.0çš„ç‰ˆæœ¬\n>\n\n~~~\n# 11æœºå™¨ï¼š\ncd /opt/src/\nsrc]# wget https://archive.apache.org/dist/kafka/2.2.0/kafka_2.12-2.2.0.tgz\nsrc]# tar xfv kafka_2.12-2.2.0.tgz -C /opt/\nsrc]# ln -s /opt/kafka_2.12-2.2.0/ /opt/kafka\nsrc]# cd /opt/kafka\nkafka]# ll\n~~~\n\n![1583632474778](assets/1583632474778.png)\n\n~~~\n# 11æœºå™¨ï¼Œé…ç½®ï¼š\nkafka]# mkdir -pv /data/kafka/logs\n# ä¿®æ”¹ä»¥ä¸‹é…ç½®ï¼Œå…¶ä¸­zkæ˜¯ä¸å˜çš„ï¼Œæœ€ä¸‹é¢ä¸¤è¡Œåˆ™æ–°å¢åˆ°å°¾éƒ¨\n# listenersè¿™ä¸ªé…ç½®å»ºè®®å†™æˆIP:9092,æœ‰äº›è€ç‰ˆæœ¬çš„kafaä¸å†™é»˜è®¤æ˜¯localhost,ä¼šå¯¼è‡´filebeatè¯†åˆ«kafkaåœ°å€é”™è¯¯\nkafka]# vi config/server.properties\nlisteners=PLAINTEXT://10.4.7.11:9092\nlog.dirs=/data/kafka/logs\nzookeeper.connect=localhost:2181\nlog.flush.interval.messages=10000\nlog.flush.interval.ms=1000\ndelete.topic.enable=true\nhost.name=hdss7-11.host.com\n~~~\n\n![1583632595085](assets/1583632595085.png)\n\n~~~\n# 11æœºå™¨ï¼Œå¯åŠ¨ï¼š\nkafka]# bin/kafka-server-start.sh -daemon config/server.properties\nkafka]# ps aux|grep kafka\nkafka]# netstat -luntp|grep 80711\n~~~\n\n![1583632747263](assets/1583632747263.png)\n\n![1583632764359](assets/1583632764359.png)\n\n##### éƒ¨ç½²kafka-manager\n\n~~~\n# 200æœºå™¨ï¼Œåˆ¶ä½œdockerï¼š\n~]# mkdir /data/dockerfile/kafka-manager\n~]# cd /data/dockerfile/kafka-manager\nkafka-manager]# vi Dockerfile \nFROM hseeberger/scala-sbt\n\nENV ZK_HOSTS=10.4.7.11:2181 \\\n     KM_VERSION=2.0.0.2\n\nRUN mkdir -p /tmp && \\\n    cd /tmp && \\\n    wget https://github.com/yahoo/kafka-manager/archive/${KM_VERSION}.tar.gz && \\\n    tar xxf ${KM_VERSION}.tar.gz && \\\n    cd /tmp/kafka-manager-${KM_VERSION} && \\\n    sbt clean dist && \\\n    unzip  -d / ./target/universal/kafka-manager-${KM_VERSION}.zip && \\\n    rm -fr /tmp/${KM_VERSION} /tmp/kafka-manager-${KM_VERSION}\n\nWORKDIR /kafka-manager-${KM_VERSION}\n\nEXPOSE 9000\nENTRYPOINT [\"./bin/kafka-manager\",\"-Dconfig.file=conf/application.conf\"]\n\n# å› ä¸ºå¤§ï¼Œbuildè¿‡ç¨‹æ¯”è¾ƒæ…¢ï¼Œä¹Ÿæ¯”è¾ƒå®¹æ˜“å¤±è´¥ï¼Œ20åˆ†é’Ÿå·¦å³ï¼Œ\nkafka-manager]# docker build . -t harbor.od.com/infra/kafka-manager:v2.0.0.2\n# buildä¸€ç›´å¤±è´¥å°±ç”¨æˆ‘åšå¥½çš„ï¼Œä¸è·Ÿä½ çš„æœºå™¨ä¹Ÿå¾—æ˜¯10.4.7.11ç­‰ï¼Œå› ä¸ºdockerfileé‡Œé¢å·²ç»å†™æ­»äº†\n# kafka-manager]# docker pull 909336740/kafka-manager:v2.0.0.2\n# kafka-manager]# docker tag 29badab5ea08 harbor.od.com/infra/kafka-manager:v2.0.0.2\nkafka-manager]# docker images|grep kafka\nkafka-manager]# docker push harbor.od.com/infra/kafka-manager:v2.0.0.2\n~~~\n\n![1583635072663](assets/1583635072663.png)\n\n~~~\n# 200æœºå™¨ï¼Œé…ç½®èµ„æºæ¸…å•ï¼š\nmkdir /data/k8s-yaml/kafka-manager\ncd /data/k8s-yaml/kafka-manager\nkafka-manager]# vi dp.yaml\nkind: Deployment\napiVersion: extensions/v1beta1\nmetadata:\n  name: kafka-manager\n  namespace: infra\n  labels: \n    name: kafka-manager\nspec:\n  replicas: 1\n  selector:\n    matchLabels: \n      app: kafka-manager\n  strategy:\n    type: RollingUpdate\n    rollingUpdate: \n      maxUnavailable: 1\n      maxSurge: 1\n  revisionHistoryLimit: 7\n  progressDeadlineSeconds: 600\n  template:\n    metadata:\n      labels: \n        app: kafka-manager\n    spec:\n      containers:\n      - name: kafka-manager\n        image: harbor.od.com/infra/kafka-manager:v2.0.0.2\n        imagePullPolicy: IfNotPresent\n        ports:\n        - containerPort: 9000\n          protocol: TCP\n        env:\n        - name: ZK_HOSTS\n          value: zk1.od.com:2181\n        - name: APPLICATION_SECRET\n          value: letmein\n      imagePullSecrets:\n      - name: harbor\n      terminationGracePeriodSeconds: 30\n      securityContext: \n        runAsUser: 0\n\nkafka-manager]# vi svc.yaml\nkind: Service\napiVersion: v1\nmetadata: \n  name: kafka-manager\n  namespace: infra\nspec:\n  ports:\n  - protocol: TCP\n    port: 9000\n    targetPort: 9000\n  selector: \n    app: kafka-manager\n\nkafka-manager]# vi ingress.yaml\nkind: Ingress\napiVersion: extensions/v1beta1\nmetadata: \n  name: kafka-manager\n  namespace: infra\nspec:\n  rules:\n  - host: km.od.com\n    http:\n      paths:\n      - path: /\n        backend: \n          serviceName: kafka-manager\n          servicePort: 9000\n~~~\n\n![1583635130773](assets/1583635130773.png)\n\n~~~\n# 11æœºå™¨ï¼Œè§£æåŸŸåï¼š\n~]# vi /var/named/od.com.zone\nserial å‰æ»šä¸€ä½\n\nkm                 A    10.4.7.10\n~]# systemctl restart named\n~]# dig -t A km.od.com @10.4.7.11 +short\n# out:10.4.7.10\n~~~\n\n![1583635171353](assets/1583635171353.png)\n\n~~~\n# 22æœºå™¨ï¼Œåº”ç”¨èµ„æºï¼š\n~]# kubectl apply -f http://k8s-yaml.od.com/kafka-manager/dp.yaml\n~]# kubectl apply -f http://k8s-yaml.od.com/kafka-manager/svc.yaml\n~]# kubectl apply -f http://k8s-yaml.od.com/kafka-manager/ingress.yaml\n~~~\n\n![1583635645699](assets/1583635645699.png)\n\næ–‡ä»¶å¤§å¯èƒ½èµ·ä¸æ¥ï¼Œéœ€è¦å¤šæ‹‰å‡ æ¬¡ï¼ˆå½“ç„¶ä½ çš„èµ„æºé…ç½®é«˜åº”è¯¥æ˜¯æ²¡é—®é¢˜çš„ï¼‰\n\n![1581673449530](assets/1581673449530.png)\n\nå¯åŠ¨æˆåŠŸåæµè§ˆå™¨è¾“å…¥[km.od.com](km.od.com)\n\n![1583635710991](assets/1583635710991.png)\n\n![1583635777584](assets/1583635777584.png)\n\nå¡«å®Œä¸Šé¢ä¸‰ä¸ªå€¼åå°±å¯ä»¥ä¸‹æ‹‰saveäº†\n\nç‚¹å‡»\n\n![1583635809826](assets/1583635809826.png)\n\n![1583635828160](assets/1583635828160.png)\n\n![1583635897650](assets/1583635897650.png)\n\nå®Œæˆ\n\n\n\n### åˆ¶ä½œfilebeatåº•åŒ…å¹¶æ¥å…¥dubboæœåŠ¡æ¶ˆè´¹è€…\n\n[Filebeatå®˜ç½‘](https://www.elastic.co/downloads/beats/filebeat)\n\nä¸‹è½½æŒ‡çº¹\n\n![1583636131189](assets/1583636131189.png)\n\næ‰“å¼€åå¤åˆ¶ï¼Œåé¢çš„ä¸éœ€è¦å¤åˆ¶\n\n![1583636252938](assets/1583636252938.png)\n\nå¼€å§‹å‰ï¼Œè¯·ç¡®ä¿ä½ çš„è¿™äº›æœåŠ¡éƒ½æ˜¯èµ·æ¥çš„\n\n![1583636282215](assets/1583636282215.png)\n\n~~~\n# 200æœºå™¨ï¼Œå‡†å¤‡é•œåƒï¼Œèµ„æºé…ç½®æ¸…å•ï¼š\nmkdir /data/dockerfile/filebeat\n~]# cd /data/dockerfile/filebeat\n# åˆšåˆšå¤åˆ¶çš„æŒ‡çº¹æ›¿ä»£åˆ°ä¸‹é¢çš„FILEBEAT_SHA1æ¥ï¼Œä½ ç”¨çš„æ˜¯ä»€ä¹ˆç‰ˆæœ¬FILEBEAT_VERSIONå°±ç”¨ä»€ä¹ˆç‰ˆæœ¬ï¼Œæ›´æ–°çš„å¾ˆå¿«ï¼Œæˆ‘ä¹‹å‰ç”¨çš„æ˜¯5.1ç°åœ¨å·²ç»æ˜¯6.1äº†\nfilebeat]# vi Dockerfile\nFROM debian:jessie\n\nENV FILEBEAT_VERSION=7.6.1 \\\n    FILEBEAT_SHA1=887edb2ab255084ef96dbc4c7c047bfa92dad16f263e23c0fcc80120ea5aca90a3a7a44d4783ba37b135dac76618971272a591ab4a24997d8ad40c7bc23ffabf\n\nRUN set -x && \\\n  apt-get update && \\\n  apt-get install -y wget && \\\n  wget https://artifacts.elastic.co/downloads/beats/filebeat/filebeat-${FILEBEAT_VERSION}-linux-x86_64.tar.gz -O /opt/filebeat.tar.gz && \\\n  cd /opt && \\\n  echo \"${FILEBEAT_SHA1}  filebeat.tar.gz\" | sha512sum -c - && \\\n  tar xzvf filebeat.tar.gz && \\\n  cd filebeat-* && \\\n  cp filebeat /bin && \\\n  cd /opt && \\\n  rm -rf filebeat* && \\\n  apt-get purge -y wget && \\\n  apt-get autoremove -y && \\\n  apt-get clean && rm -rf /var/lib/apt/lists/* /tmp/* /var/tmp/*\n\nCOPY docker-entrypoint.sh /\nENTRYPOINT [\"/docker-entrypoint.sh\"]\n\nfilebeat]# vi docker-entrypoint.sh\n#!/bin/bash\n\nENV=${ENV:-\"test\"}\nPROJ_NAME=${PROJ_NAME:-\"no-define\"}\nMULTILINE=${MULTILINE:-\"^\\d{2}\"}\n\ncat > /etc/filebeat.yaml << EOF\nfilebeat.inputs:\n- type: log\n  fields_under_root: true\n  fields:\n    topic: logm-${PROJ_NAME}\n  paths:\n    - /logm/*.log\n    - /logm/*/*.log\n    - /logm/*/*/*.log\n    - /logm/*/*/*/*.log\n    - /logm/*/*/*/*/*.log\n  scan_frequency: 120s\n  max_bytes: 10485760\n  multiline.pattern: '$MULTILINE'\n  multiline.negate: true\n  multiline.match: after\n  multiline.max_lines: 100\n- type: log\n  fields_under_root: true\n  fields:\n    topic: logu-${PROJ_NAME}\n  paths:\n    - /logu/*.log\n    - /logu/*/*.log\n    - /logu/*/*/*.log\n    - /logu/*/*/*/*.log\n    - /logu/*/*/*/*/*.log\n    - /logu/*/*/*/*/*/*.log\noutput.kafka:\n  hosts: [\"10.4.7.11:9092\"]\n  topic: k8s-fb-$ENV-%{[topic]}\n  version: 2.0.0\n  required_acks: 0\n  max_message_bytes: 10485760\nEOF\n\nset -xe\n\n# If user don't provide any command\n# Run filebeat\nif [[ \"$1\" == \"\" ]]; then\n     exec filebeat  -c /etc/filebeat.yaml \nelse\n    # Else allow the user to run arbitrarily commands like bash\n    exec \"$@\"\nfi\n\nfilebeat]# chmod u+x docker-entrypoint.sh\nfilebeat]# docker build . -t harbor.od.com/infra/filebeat:v7.6.1\n# buildå¯èƒ½ä¼šå¤±è´¥å¾ˆå¤šæ¬¡ï¼Œæˆ‘æœ€é•¿çš„æ˜¯7æ¬¡ï¼Œä¸‹é¢æœ‰ç›¸å…³æŠ¥é”™\nfilebeat]# docker images|grep filebeat\nfilebeat]# docker push harbor.od.com/infra/filebeat:v7.6.1\n# åˆ æ‰åŸæ¥çš„å†…å®¹å…¨éƒ¨ç”¨æ–°çš„ï¼Œä½¿ç”¨çš„ä¸¤ä¸ªé•œåƒå¯¹åº”ä¸Šä½ è‡ªå·±çš„é•œåƒ\nfilebeat]# vi /data/k8s-yaml/test/dubbo-demo-consumer/dp.yaml\nkind: Deployment\napiVersion: extensions/v1beta1\nmetadata:\n  name: dubbo-demo-consumer\n  namespace: test\n  labels: \n    name: dubbo-demo-consumer\nspec:\n  replicas: 1\n  selector:\n    matchLabels: \n      name: dubbo-demo-consumer\n  template:\n    metadata:\n      labels: \n        app: dubbo-demo-consumer\n        name: dubbo-demo-consumer\n    spec:\n      containers:\n      - name: dubbo-demo-consumer\n        image: harbor.od.com/app/dubbo-demo-web:tomcat_200307_1410\n        imagePullPolicy: IfNotPresent\n        ports:\n        - containerPort: 8080\n          protocol: TCP\n        env:\n        - name: C_OPTS\n          value: -Denv=fat -Dapollo.meta=http://apollo-configservice:8080\n        volumeMounts:\n        - mountPath: /opt/tomcat/logs\n          name: logm\n      - name: filebeat\n        image: harbor.od.com/infra/filebeat:v7.6.1\n        imagePullPolicy: IfNotPresent\n        env:\n        - name: ENV\n          value: test\n        - name: PROJ_NAME\n          value: dubbo-demo-web\n        volumeMounts:\n        - mountPath: /logm\n          name: logm\n      volumes:\n      - emptyDir: {}\n        name: logm\n      imagePullSecrets:\n      - name: harbor\n      restartPolicy: Always\n      terminationGracePeriodSeconds: 30\n      securityContext: \n        runAsUser: 0\n      schedulerName: default-scheduler\n  strategy:\n    type: RollingUpdate\n    rollingUpdate: \n      maxUnavailable: 1\n      maxSurge: 1\n  revisionHistoryLimit: 7\n  progressDeadlineSeconds: 600\n~~~\n\n> ç›¸å…³æŠ¥é”™ï¼ˆå…¶å®ƒé—®é¢˜åŸºæœ¬éƒ½æ˜¯ç½‘ç»œä¸ç¨³å®šçš„é—®é¢˜ï¼‰ï¼š![1583639164435](assets/1583639164435.png)\n>\n> å› ä¸ºä½ ç”¨çš„æŒ‡çº¹ä¸æ˜¯è‡ªå·±çš„ï¼Œæˆ–è€…ç‰ˆæœ¬æ²¡å†™å¯¹ã€‚\n>\n> **dp.yamlæ–‡ä»¶è§£æ**ï¼š    spec-containersä¸‹æœ‰ä¸¤ä¸ªnameï¼Œå¯¹åº”çš„ä¸¤ä¸ªå®¹å™¨ï¼Œè¿™å°±æ˜¯è¾¹è½¦æ¨¡å¼ï¼ˆsidecarï¼‰ã€‚\n\n~~~\n# 22æœºå™¨ï¼Œåº”ç”¨èµ„æºæ¸…å•ï¼š\n~]# kubectl apply -f http://k8s-yaml.od.com/test/dubbo-demo-consumer/dp.yaml\n#out: deployment.extensions/dubbo-demo-consumer configured\n~]# kubectl get pods -n test\n~~~\n\n![1583640124995](assets/1583640124995.png)\n\næœºå™¨åœ¨21æœºå™¨\n\n![1583640217181](assets/1583640217181.png)\n\n~~~\n# æŸ¥çœ‹filebeatæ—¥å¿—ï¼Œ21æœºå™¨ï¼š\n~]# docker ps -a|grep consumer\n~]# docker exec -ti a6adcd6e83b3 bash\n:/# cd /logm\n:/#/logm# ls\n:/#/logm# cd ..\n# è¿™ä¸ªlogï¼Œæ˜¯ä½ æ¯ä¸€æ¬¡åˆ·æ–°demoé¡µé¢éƒ½ä¼šæœ‰æ•°æ®ï¼Œä½ æŠŠå®ƒå¤¯åœ¨è¿™é‡Œ\n:/# tail -fn 200 /logm/stdout.log\n# æ—¥å¿—å°±éƒ½åœ¨è¿™é‡Œäº†\n~~~\n\n![1583640393605](assets/1583640393605.png)\n\n~~~\n# æµè§ˆå™¨è¾“å…¥ï¼šdemo-test.com/hello?name=tomcat\n~~~\n\n![1583640365512](assets/1583640365512.png)\n\nåˆ·æ–°ä¸Šé¢çš„é¡µé¢ï¼Œå»21æœºå™¨çœ‹log\n\n![1583640316947](assets/1583640316947.png)\n\n[åˆ·æ–°km.od.com/clusters/kafka-od/topics](km.od.com/clusters/kafka-od/topics)\n\n![1583640444719](assets/1583640444719.png)\n\nå®Œæˆ\n\n\n\n### éƒ¨ç½²logstashé•œåƒ\n\n~~~\n# 200æœºå™¨ï¼Œå‡†å¤‡é•œåƒã€èµ„æºæ¸…å•ï¼š\n# logstashçš„ç‰ˆæœ¬éœ€è¦å’Œesçš„ç‰ˆæœ¬ä¸€æ ·ï¼Œ11æœºå™¨cd /opt/ç›®å½•ä¸‹å³å¯æŸ¥çœ‹åˆ°\n~]# docker pull logstash:6.8.6\n~]# docker images|grep logstash\n~]# docker tag d0a2dac51fcb harbor.od.com/infra/logstash:v6.8.6\n~]# docker push harbor.od.com/infra/logstash:v6.8.6\n~]# mkdir /etc/logstash\n~]# vi /etc/logstash/logstash-test.conf\ninput {\n  kafka {\n    bootstrap_servers => \"10.4.7.11:9092\"\n    client_id => \"10.4.7.200\"\n    consumer_threads => 4\n    group_id => \"k8s_test\"\n    topics_pattern => \"k8s-fb-test-.*\"\n  }\n}\n\nfilter {\n  json {\n    source => \"message\"\n  }\n}\n\noutput {\n  elasticsearch {\n    hosts => [\"10.4.7.12:9200\"]\n    index => \"k8s-test-%{+YYYY.MM.DD}\"\n  }\n}\n\n~]# vi /etc/logstash/logstash-prod.conf\ninput {\n  kafka {\n    bootstrap_servers => \"10.4.7.11:9092\"\n    client_id => \"10.4.7.200\"\n    consumer_threads => 4\n    group_id => \"k8s_prod\"\n    topics_pattern => \"k8s-fb-prod-.*\"\n  }\n}\n\nfilter {\n  json {\n    source => \"message\"\n  }\n}\n\noutput {\n  elasticsearch {\n    hosts => [\"10.4.7.12:9200\"]\n    index => \"k8s-prod-%{+YYYY.MM.DD}\"\n  }\n}\n\n# å¯åŠ¨\n~]# docker run -d --name logstash-test -v /etc/logstash:/etc/logstash harbor.od.com/infra/logstash:v6.8.6 -f /etc/logstash/logstash-test.conf\n~]# docker ps -a|grep logstash\n~~~\n\n[^:%s/test/prod/g]: åœ¨viå‘½ä»¤è¡Œè¾“å…¥å·¦è¾¹å†…å®¹ï¼Œå³å¯å°†æ–‡æœ¬é‡Œé¢å¾—testå…¨éƒ¨æ¢æˆprod\n\n![1583651857160](assets/1583651857160.png)\n\næˆ‘ä»¬åˆ·æ–°demoé¡µé¢è®©kafkaé‡Œé¢æ›´æ–°äº›æ—¥å¿—\n\n![1583651874243](assets/1583651874243.png)\n\næœ‰æ—¥å¿—äº†\n\n![1583651931546](assets/1583651931546.png)\n\n~~~\n# 200æœºå™¨ï¼ŒéªŒè¯ESç´¢å¼•ï¼ˆå¯èƒ½æ¯”è¾ƒæ…¢ï¼‰ï¼š\n~]# curl http://10.4.7.12:9200/_cat/indices?v\n~~~\n\n![1583652168302](assets/1583652168302.png)\n\n> è¿™ä¸ªååº”æœ‰ç‚¹æ…¢ï¼Œæˆ‘ç­‰äº†å¿«ä¸‰åˆ†é’Ÿ\n\nå®Œæˆ\n\n\n\n### äº¤ä»˜kibanaåˆ°K8Sé›†ç¾¤\n\n> ä¸ºä»€ä¹ˆç”¨kibanaï¼šå½“ç„¶è¿ç»´å¯ä»¥ç›´æ¥åœ¨dashboardé‡Œexecè¿›å»ï¼Œç„¶åå‘½ä»¤è¡Œçœ‹æƒ…å†µï¼Œä½†æ˜¯å¼€å‘æˆ–è€…æµ‹è¯•ä¸è¡Œï¼Œé‚£æ˜¯æœºå¯†çš„ï¼Œæˆ‘ä»¬å¾—è¦ä¸€ä¸ªé¡µé¢ä¾›ä»–ä»¬ä½¿ç”¨ï¼Œä½¿ç”¨éœ€è¦kibanaã€‚\n\n~~~\n~]# docker pull kibana:6.8.6\n~]# docker images|grep kibana\n~]# docker tag adfab5632ef4 harbor.od.com/infra/kibana:v6.8.6\n~]# docker push harbor.od.com/infra/kibana:v6.8.6\n~]# mkdir /data/k8s-yaml/kibana\n~]# cd /data/k8s-yaml/kibana/\nkibana]# vi dp.yaml\nkind: Deployment\napiVersion: extensions/v1beta1\nmetadata:\n  name: kibana\n  namespace: infra\n  labels: \n    name: kibana\nspec:\n  replicas: 1\n  selector:\n    matchLabels: \n      name: kibana\n  template:\n    metadata:\n      labels: \n        app: kibana\n        name: kibana\n    spec:\n      containers:\n      - name: kibana\n        image: harbor.od.com/infra/kibana:v6.8.6\n        imagePullPolicy: IfNotPresent\n        ports:\n        - containerPort: 5601\n          protocol: TCP\n        env:\n        - name: ELASTICSEARCH_URL\n          value: http://10.4.7.12:9200\n      imagePullSecrets:\n      - name: harbor\n      securityContext: \n        runAsUser: 0\n  strategy:\n    type: RollingUpdate\n    rollingUpdate: \n      maxUnavailable: 1\n      maxSurge: 1\n  revisionHistoryLimit: 7\n  progressDeadlineSeconds: 600\n\nkibana]# vi svc.yaml\nkind: Service\napiVersion: v1\nmetadata: \n  name: kibana\n  namespace: infra\nspec:\n  ports:\n  - protocol: TCP\n    port: 5601\n    targetPort: 5601\n  selector: \n    app: kibana\n\nkibana]# vi ingress.yaml\nkind: Ingress\napiVersion: extensions/v1beta1\nmetadata: \n  name: kibana\n  namespace: infra\nspec:\n  rules:\n  - host: kibana.od.com\n    http:\n      paths:\n      - path: /\n        backend: \n          serviceName: kibana\n          servicePort: 5601\n~~~\n\n![1583652777163](assets/1583652777163.png)\n\n~~~\n# 11æœºå™¨ï¼Œè§£æåŸŸåï¼š\n~]# vi /var/named/od.com.zone\nserial å‰æ»šä¸€ä½\nkibana             A    10.4.7.10\n\n~]# systemctl restart named\n~]# dig -t A kibana.od.com @10.4.7.11 +short\n~~~\n\n![1583652835822](assets/1583652835822.png)\n\n~~~\n# 22æœºå™¨ï¼ˆ21æœºå™¨è¿˜å¤¯ç€logï¼‰ï¼Œåº”ç”¨èµ„æºæ¸…å•ï¼š\n~]# kubectl apply -f http://k8s-yaml.od.com/kibana/dp.yaml\n~]# kubectl apply -f http://k8s-yaml.od.com/kibana/svc.yaml\n~]# kubectl apply -f http://k8s-yaml.od.com/kibana/ingress.yaml\n~]# kubectl get pods -n infra\n~~~\n\n![1583653095099](assets/1583653095099.png)\n\n[kibana.od.com](kibana.od.com)\n\n> æˆ‘ç”¨çš„ä½é…8C32Gï¼Œæœºå™¨å¿«è·‘ä¸åŠ¨äº†ï¼Œè¿˜ä¼šæ˜¾ç¤ºservice not yet\n\n![1581735655839](assets/1581735655839.png)\n\n![1583653403755](assets/1583653403755.png)\n\n> ç‚¹å®Œå¯èƒ½ä¼šè½¬åœˆè½¬å¾ˆä¹…\n\n![1583654044637](assets/1583654044637.png)\n\n![1583654055784](assets/1583654055784.png)\n\nå»åˆ›å»º\n\n![1583653710404](assets/1583653710404.png)\n\n![1583653734639](assets/1583653734639.png)\n\n![1583653767919](assets/1583653767919.png)\n\nåˆ›å»ºåï¼Œä½ å°±èƒ½çœ‹åˆ°æ—¥å¿—\n\n![1583654148342](assets/1583654148342.png)\n\næŠŠprodé‡Œçš„configserviceå’Œadminä¾æ¬¡èµ·æ¥\n\n![1583654217058](assets/1583654217058.png)\n\n~~~\n# 200æœºå™¨ï¼š\ncd /data/k8s-yaml/prod/dubbo-demo-consumer/\ndubbo-demo-consumer]# cp ../../test/dubbo-demo-consumer/dp.yaml .\n# y\n# ä¿®æ”¹namespaceä¸ºprodï¼Œfatæ”¹æˆproï¼Œhttpåœ°å€ä¹Ÿæ”¹äº†\ndubbo-demo-consumer]# vi dp.yaml\n~~~\n\n![1583654303335](assets/1583654303335.png)\n\n![1583654391353](assets/1583654391353.png)\n\n[config-prod.od.com](config-prod.od.com)\n\n![1583654579273](assets/1583654579273.png)\n\nå®Œæˆ\n\n\n\n### è¯¦è§£Kibanaç”Ÿäº§å®è·µæ–¹æ³•\n\næŸ¥çœ‹ç¯å¢ƒæƒ…å†µ\n\nç¡®è®¤Eurekaæœ‰configå’Œadmin\n\n![1583654579273](assets/1583654579273.png)\n\nç¡®è®¤Apolloé‡Œæœ‰ä¸¤ä¸ªç¯å¢ƒ\n\n![1583654655665](assets/1583654655665.png)\n\nç¡®è®¤å®Œåï¼Œæˆ‘ä»¬å…ˆæŠŠserviceèµ·æ¥\n\n![1583654706752](assets/1583654706752.png)\n\nç„¶ååˆ°consumerï¼Œconsumeréœ€è¦æ¥æ—¥å¿—\n\n~~~~\n# 22æœºå™¨ï¼š\n~]# kubectl apply -f http://k8s-yaml.od.com/prod/dubbo-demo-consumer/dp.yaml\n~]# kubectl get pods -n prod\n~~~~\n\n![1583654764653](assets/1583654764653.png)\n\n~~~\n# 200æœºå™¨ï¼š\n# å¯åŠ¨\n~]# docker run -d --name logstash-prod -v /etc/logstash:/etc/logstash harbor.od.com/infra/logstash:v6.8.6 -f /etc/logstash/logstash-prod.conf\n~]# docker ps -a|grep logstash\n# curlä¸€ä¸‹ï¼Œè¿™æ—¶å€™è¿˜åªæœ‰test\n~]# curl http://10.4.7.12:9200/_cat/indices?v\n~~~\n\n![1583654862812](assets/1583654862812.png)\n\n~~~\n# è®¿é—®æµè§ˆå™¨demo-prod.od.com/hello?name=prod\n~~~\n\n![1583654914493](assets/1583654914493.png)\n\næˆ‘ä»¬çœ‹ä¸€ä¸‹è°ƒåº¦åˆ°å“ªä¸ªèŠ‚ç‚¹äº†\n\n![1583654962325](assets/1583654962325.png)\n\n~~~\n# è°ƒåº¦åˆ°21èŠ‚ç‚¹ï¼Œæˆ‘ä»¬å»21èŠ‚ç‚¹çœ‹ä¸€ä¸‹ï¼š\n~]# docker ps -a|grep consumer\n~]# docker exec -ti 094e68c795b0 bash\n:/# cd /logm\n:/logm# ls\n:/logm# tail -fn 200 stdout.log\n~~~\n\n![1583655033176](assets/1583655033176.png)\n\nå¤¯ä½\n\n![1583655055686](assets/1583655055686.png)\n\nå»[http://km.od.com](http://km.od.com/)\n\n![1583655088618](assets/1583655088618.png)\n\n![1583655114357](assets/1583655114357.png)\n\n![1583655130583](assets/1583655130583.png)\n\nå·²ç»æœ‰prodäº†\n\n~~~\n# 200æœºå™¨ï¼Œcurlçš„æ—¶å€™å¯èƒ½è¦ç­‰ä¸€ä¸‹æ‰æœ‰ï¼ˆå¯ä»¥å»å¤šåˆ·ä¸€ä¸‹ç½‘é¡µäº§ç”Ÿæ—¥å¿—ï¼‰ï¼š\n~]# curl http://10.4.7.12:9200/_cat/indices?v\n~~~\n\n![1583655264326](assets/1583655264326.png)\n\nå»kibanaé…ä¸€ä¸‹\n\n![1583655369240](assets/1583655369240.png)\n\n![1583655383868](assets/1583655383868.png)\n\n##### å¦‚ä½•ä½¿ç”¨kibana\n\næ—¶é—´é€‰æ‹©\n\n![1583655477179](assets/1583655477179.png)\n\n![1583655509551](assets/1583655509551.png)\n\n> testæ²¡ç”¨æ•°æ®çš„ç‚¹ä¸‹è¿™ä¸ªå°±æœ‰äº†ï¼Œå¹³å¸¸ç”¨çš„æœ€å¤šçš„ä¹Ÿæ˜¯todayï¼Œåé¢çªç„¶æ²¡æ•°æ®äº†ä½ å°±å¯ä»¥åˆ·æ–°æˆ–è€…ç‚¹æ—¶é—´ï¼Œç‰¹åˆ«æ˜¯é…ç½®å·®çš„åŒå­¦\n>\n> ![1583655706547](assets/1583655706547.png)\n\nç¯å¢ƒé€‰æ‹©å™¨\n\n![1583655530032](assets/1583655530032.png)\n\nå…³é”®å­—é€‰æ‹©å™¨\n\nå…ˆæŠŠmessageé¡¶ä¸Šæ¥ï¼Œè¿˜æœ‰log.file.pathã€hostname\n\n![1583655759010](assets/1583655759010.png)\n\næˆ‘ä»¬å…ˆåˆ¶é€ ä¸€äº›é”™è¯¯ï¼ŒæŠŠservice scaleæˆ0\n\n![1583655838132](assets/1583655838132.png)\n\nç„¶ååˆ·æ–°ä¸€ä¸‹é¡µé¢ï¼Œè®©å®ƒæŠ¥é”™ï¼Œè®°å¾—æ˜¯testç¯å¢ƒ\n\n![1583655858792](assets/1583655858792.png)\n\næœexceptionå…³é”®å­—ï¼Œå¹¶å¯å±•å¼€\n\n![1583655981692](assets/1583655981692.png)\n\n![1583656009350](assets/1583656009350.png)\n\nç°åœ¨consumeræ—¥å¿—å·²ç»å®Œæˆäº†ï¼Œè®°å¾—æŠŠserviceçš„podè¿˜åŸï¼Œå¹¶åˆ æ‰consumerçš„podè®©å®ƒé‡å¯\n\n\n\n#### è¯¾å¤–ä½œä¸šï¼ˆä¸æ˜¯ä¸€å®šè¦å®Œæˆï¼Œä½†æ˜¯ä½ åšäº†æˆ‘åšçš„è¿™äº›ï¼‰\n\nconsumeræ—¥å¿—å·²ç»å®Œæˆï¼Œè¿˜å¯ä»¥åšserviceæ—¥å¿—\n\n~~~\n# 200æœºå™¨ï¼š\n# ä¿®æ”¹ä¸€ä¸‹å†…å®¹\n~]# cd  /data/dockerfile/jre8/\n# ä¿®æ”¹ä»¥ä¸‹å†…å®¹\njre8]# vi entrypoint.sh\nexec java -jar ${M_OPTS} ${C_OPTS} ${JAR_BALL} 2>&1 >> /opt/logs/stdout.log\n\njre8]# docker build . -t harbor.od.com/base/jre8:8u112_with_logs\njre8]# docker push harbor.od.com/base/jre8:8u112_with_logs\n~~~\n\n![1584067987917](assets/1584067987917.png)\n\n![1581752521087](assets/1581752521087.png)\n\nå»ä¿®æ”¹ä¸€ä¸‹JenkinsåŠ ä¸€ä¸ªåº•åŒ…\n\n![1584237876688](assets/1584237876688.png)\n\n![1584237900572](assets/1584237900572.png)\n\n![1584237947516](assets/1584237947516.png)\n\nä¸‹é¢å°±è¦ä½ æ¥ç€åšäº†\n\n"
        },
        {
          "name": "ç¬¬ä¸‰ç« â€”â€”k8sé›†ç¾¤.md",
          "type": "blob",
          "size": 25.9658203125,
          "content": "## ç¬¬ä¸‰ç« â€”â€”k8sé›†ç¾¤\n\n> æˆ‘ä»¬æ¥å›é¡¾ä¸€ä¸‹å¹¶å­¦ä¹ ä¸€äº›å¿…è¦çŸ¥è¯†\n\n[k8sä¸­æ–‡ç¤¾åŒºdocs.kubernetes.org.cn](http://docs.kubernetes.org.cn/)\n\n##### K8Sæ ¸å¿ƒèµ„æºç®¡ç†æ–¹æ³•\n\n~~~\n# ä»»æ„æœºå™¨(æˆ‘æ˜¯åœ¨21)\n# æŸ¥çœ‹åç§°ç©ºé—´\n~]# kubectl get namespace\n~]# kubectl get ns\n~~~\n\n![1579073760060](assets/1579073760060.png)\n\n~~~\n# ä»»æ„æœºå™¨(æˆ‘æ˜¯åœ¨21)\n~]# kubectl get all [-n default]\n~]# kubectl create ns app\n# å¢\n~]# kubectl create ns app\n# åˆ \n~]# kubectl delete namespace app\n# æŸ¥\n~]# kubectl get ns\n# åˆ›å»ºdeploymentèµ„æº\nkubectl create deployment nginx-dp --image=harbor.od.com/public/nginx:v1.7.9 -n kube-public\n# æŸ¥æŒ‡å®šç©ºé—´\n~]# kubectl get deploy -n kube-public\n~]# kubectl get pods -o wide -n kube-public\n~]# kubectl describe deployment nginx-dp -n kube-public\n\n# è¿›å…¥podèµ„æº\n21 ~]# kubectl get pods -n kube-public\n21 ~]# kubectl exec -ti nginx-dp-5dfc689474-9zt9r /bin/bash -n kube-public\n~~~\n\n> **kubectl get deploy**ï¼šè¿™é‡Œçš„deployæ˜¯å®¹å™¨ç±»å‹ï¼Œdeployä¹Ÿæ˜¯deployment\n>\n> **kubectl exec**ï¼šè¿›å…¥å®¹å™¨\n>\n> - -tï¼šå°†æ ‡å‡†è¾“å…¥æ§åˆ¶å°ä½œä¸ºå®¹å™¨çš„æ§åˆ¶å°è¾“å…¥\n> - -iï¼šå°†æ§åˆ¶å°è¾“å…¥å‘é€åˆ°å®¹å™¨\n> - ä¸€èˆ¬æ˜¯è¿èµ·æ¥ç”¨-itï¼Œåé¢å¸¦çš„æ˜¯getå‡ºæ¥çš„å®¹å™¨å\n> - /bin/bashï¼šç»ˆç«¯æ¨¡å¼\n\n![1579075596641](assets/1579075596641.png)\n\n~~~\n# åˆ é™¤podèµ„æºï¼ˆé‡å¯ï¼‰ï¼Œpodæ§åˆ¶å™¨é¢„æœŸä½ æœ‰ä¸€ä¸ªpodï¼Œæ‰€ä»¥ä½ åˆ æ‰å°±ä¼šé‡å¯ï¼Œåé¢forceæ˜¯å¼ºåˆ¶åˆ é™¤\n21 ~]# kubectl delete pod nginx-dp-5dfc689474-gtfvv -n kube-public [--force --grace-period=0]\n# åˆ æ‰deploy\n21 ~]# kubectl delete deploy nginx-dp -n kube-public\n# æŸ¥çœ‹\n21 ~]# kubectl get all -n kube-public\n~~~\n\n![1579076172922](assets/1579076172922.png)\n\n##### ç®¡ç†serviceèµ„æº\n\n~~~\n# 21æœºå™¨\n# åˆ›å»º\n~]# kubectl create deployment nginx-dp --image=harbor.od.com/public/nginx:v1.7.9 -n kube-public\n~]# kubectl get all -n kube-public\n# æš´éœ²ç«¯å£\n~]# kubectl expose deployment nginx-dp --port=80 -n kube-public\n~]# kubectl get all -n kube-public -o wide\n~~~\n\n> **kubectl expose**ï¼šæš´éœ²ç«¯å£ï¼Œåé¢çš„--port=80 æŒ‡çš„æ˜¯æš´éœ²80ç«¯å£\n\n![1579077073962](assets/1579077073962.png)\n\n~~~\n# å»22æœºå™¨\n~]# curl 192.168.81.37\n~]# ipvsadm -Ln\n~~~\n\n![1579077146418](assets/1579077146418.png)\n\n![1579077275447](assets/1579077275447.png)\n\n~~~\n# åšæˆä¸¤ä»½ä»£ç†æœåŠ¡å™¨,22æœºå™¨\n~]# kubectl scale deployment nginx-dp --replicas=2 -n kube-public\n~]# ipvsadm -Ln\n~~~\n\n> **kubectl scaleï¼š**    æ‰©å®¹æˆ–ç¼©å®¹ Deploymentç­‰ä¸­Podæ•°é‡\n>\n> - --replicas=2ï¼šæŠŠPodæ•°é‡æ”¹ä¸º2ï¼Œå³å¦‚æœä¹‹å‰æ˜¯1åˆ™æ‰©å®¹å˜æˆ2ï¼Œå¦‚æœä¹‹å‰æ˜¯3åˆ™ç¼©å®¹å˜æˆ2\n\nå¯ä»¥çœ‹åˆ°ä¸‹é¢çš„Podå·²ç»å˜æˆäº†ä¸¤ä¸ªï¼Œè€Œä¸Šå›¾æ˜¯åªæœ‰ä¸€ä¸ªçš„\n\n![1579077403598](assets/1579077403598.png)\n\n~~~\n# è·å–èµ„æºé…ç½®æ¸…å•ï¼Œ21æœºå™¨\n~]# kubectl get pods -n kube-public\n~]# kubectl get pods nginx-dp-5dfc689474-788xp -o yaml -n kube-public\n# è§£é‡Šæ€ä¹ˆç”¨\n~]# kubectl explain service.metadata\n~~~\n\n> èµ„æºæ¸…å•çš„å†…å®¹è§£é‡Šç”±äºå¤ªå¤šï¼Œè¿™é‡Œå°±ä¸åšè§£æäº†ï¼Œæ„Ÿå…´è¶£çš„æœ‹å‹å¯ä»¥ç½‘ä¸Šæœä¸‹\n\n![1579079365291](assets/1579079365291.png)\n\n~~~\n# å£°æ˜å¼ã€21æœºå™¨ï¼š\n~]# vi nginx-ds-svc.yaml\napiVersion: v1\nkind: Service\nmetadata:\n  labels:\n    app: nginx-ds\n  name: nginx-ds\n  namespace: default\nspec:\n  ports:\n  - port: 80\n    protocol: TCP\n    targetPort: 80\n  selector:\n    app: nginx-ds\n  sessionAffinity: None\n  type: ClusterIP\n  \n~]# kubectl create -f nginx-ds-svc.yaml\n# out: service/nginx-ds created\n~]# kubectl get svc -n default\n~]# kubectl get svc nginx-ds -o yaml\n~~~\n\n![1579079818058](assets/1579079818058.png)\n\n~~~\n# ä¿®æ”¹èµ„æºï¼Œåœ¨çº¿æ–¹å¼ï¼š\n~]# kubectl edit svc nginx-ds\n~]# kubectl get svc\n# ç¦»çº¿ï¼šåˆ äº†å†æ‰“å¼€ï¼Œç¦»çº¿ä¿®æ”¹æœ‰è®°å½•\n# åˆ é™¤èµ„æº,å®éªŒï¼ŒæŒ‰ç…§ä»¥ä¸‹æ–¹æ³•æ˜¯æ— æ³•åˆ é™¤çš„~å»æ‰¾ä¸€ä¸‹å§\n# é™ˆè¿°å¼\n~]# kubectl delete -f nginx-ds\n# å£°æ˜å¼\n~]# kubectl delete -f nginx-dp-svc.yaml \n~~~\n\n> å½“ç„¶åˆ ä¸äº†ä¹Ÿæ— æ‰€è°“\n\n![1579085057843](assets/1579085057843.png)\n\nå›é¡¾å®Œæˆ\n\n\n\n### å®‰è£…éƒ¨ç½²flanneld\n\n> **WHAT**ï¼šé€šè¿‡ç»™æ¯å°å®¿ä¸»æœºåˆ†é…ä¸€ä¸ªå­ç½‘çš„æ–¹å¼ä¸ºå®¹å™¨æä¾›è™šæ‹Ÿç½‘ç»œï¼ˆè¦†ç›–ç½‘ç»œï¼‰ï¼Œè¯¥ç½‘ç»œä¸­çš„ç»“ç‚¹å¯ä»¥çœ‹ä½œé€šè¿‡è™šæ‹Ÿæˆ–é€»è¾‘é“¾è·¯è€Œè¿æ¥èµ·æ¥çš„\n>\n> **WHY**ï¼šæˆ‘ä»¬ç”Ÿäº§ä¸Šçš„é›†ç¾¤å®¿ä¸»æœº/å®¹å™¨ä¹‹é—´å¿…é¡»æ˜¯äº’é€šçš„ï¼Œå› ä¸ºåªæœ‰äº’é€šæ‰èƒ½å½¢æˆé›†ç¾¤ï¼Œè¦æ˜¯é›†ç¾¤é—´çš„å®¿ä¸»æœºå’Œå®¹å™¨éƒ½ä¸äº’é€šï¼Œé‚£å°±æ²¡æœ‰åšé›†ç¾¤çš„å¿…è¦äº†\n\n~~~\n# ä½ å¯ä»¥åšå¦‚ä¸‹å°è¯•ï¼Œ21æœºå™¨ï¼š\n~]# kubectl get pods -o wide\n~]# ping 172.7.21.2\n~]# ping 172.7.22.2\n~~~\n\n![1579141174992](assets/1579141174992.png)\n\n> ä½ å¯ä»¥å‘ç°ï¼Œä¸¤ä¸ªå®¹å™¨çš„å®¿ä¸»æœºä¹‹é—´æ˜¯ä¸äº’é€šçš„ï¼Œæ›´åˆ«è¯´è¿›å…¥å®¹å™¨é‡Œé¢äº†ã€‚ï¼ˆå½“ç„¶ping10.4.7.22æ˜¯æ²¡é—®é¢˜çš„ï¼‰\n>\n> è¿™æ—¶å€™æˆ‘ä»¬å°±éœ€è¦CNIç½‘ç»œæ’ä»¶ï¼ŒCNIæœ€ä¸»è¦çš„åŠŸèƒ½æ˜¯å®ç°PODèµ„æºèƒ½å¤Ÿè·¨å®¿ä¸»æœºè¿›è¡Œé€šä¿¡ï¼Œå½“ç„¶CNIç½‘ç»œæ’ä»¶æœ‰å¾ˆå¤šç§ï¼Œå¦‚Flannelã€Calicoç­‰ï¼Œè€ŒFlannelæ˜¯ç›®å‰å¸‚åœºä¸Šæœ€ä¸ºç«çƒ­çš„\n\n~~~~\n# 21/22æœºå™¨ï¼š\n~]# cd /opt/src/\nsrc]# wget https://github.com/coreos/flannel/releases/download/v0.11.0/flannel-v0.11.0-linux-amd64.tar.gz\nsrc]# mkdir /opt/flannel-v0.11.0\nsrc]# tar xf flannel-v0.11.0-linux-amd64.tar.gz -C /opt/flannel-v0.11.0/\nsrc]# ln -s /opt/flannel-v0.11.0/ /opt/flannel\nsrc]# cd /opt/flannel\nflannel]# ll\n# out:æ€»ç”¨é‡ 34436\nflannel]# mkdir cert\nflannel]# cd cert/\ncert]# scp hdss7-200:/opt/certs/ca.pem . \ncert]# scp hdss7-200:/opt/certs/client.pem .\ncert]# scp hdss7-200:/opt/certs/client-key.pem .\ncert]# cd ..\n# æ³¨æ„æœºå™¨åï¼Œéœ€è¦æ”¹ä¸€å¤„ï¼šSUBNET=172.7.21.1/24ï¼Œéœ€è¦æ”¹æˆSUBNET=172.7.22.1/24\nflannel]# vi subnet.env\nFLANNEL_NETWORK=172.7.0.0/16\nFLANNEL_SUBNET=172.7.21.1/24\nFLANNEL_MTU=1500\nFLANNEL_IPMASQ=false\n\n~~~~\n\n![1579144065680](assets/1579144065680.png)\n\n~~~\n# 21/22æœºå™¨,æ³¨æ„ï¼Œæˆ‘çš„ç½‘ç»œæ˜¯eth0ï¼Œæ–°ç‰ˆçš„æ˜¯ens33ï¼Œå¦‚æœæ˜¯ens33ï¼Œåˆ™éœ€è¦æ”¹ifaceï¼Œå…¶å®ƒéœ€è¦æ”¹ä¸€å¤„æœºå™¨åï¼šip=10.4.7.21\nflannel]# vi flanneld.sh\n#!/bin/sh\n./flanneld \\\n  --public-ip=10.4.7.21 \\\n  --etcd-endpoints=https://10.4.7.12:2379,https://10.4.7.21:2379,https://10.4.7.22:2379 \\\n  --etcd-keyfile=./cert/client-key.pem \\\n  --etcd-certfile=./cert/client.pem \\\n  --etcd-cafile=./cert/ca.pem \\\n  --iface=eth0 \\\n  --subnet-file=./subnet.env \\\n  --healthz-port=2401\n  \nflannel]# chmod +x flanneld.sh\nflannel]# mkdir -p /data/logs/flanneld\nflannel]# cd /opt/etcd\n# ä¸‹é¢è¿™ä¸€æ­¥åœ¨ä¸€éƒ¨æœºå™¨ä¸Šæ‰§è¡Œå³å¯ï¼Œåªéœ€æ‰§è¡Œä¸€æ¬¡ï¼Œæˆ‘åœ¨21æœºå™¨åšçš„ï¼š\netcd]# ./etcdctl set /coreos.com/network/config '{\"Network\": \"172.7.0.0/16\", \"Backend\": {\"Type\": \"host-gw\"}}'\netcd]# ./etcdctl get /coreos.com/network/config\n# out:{\"Network\": \"172.7.0.0/16\", \"Backend\": {\"Type\": \"host-gw\"}}\n\n# æœ‰ä¸€å¤„è¦ä¿®æ”¹ï¼Œ21/22æœºå™¨ï¼šflanneld-7-21]\netcd]# vi /etc/supervisord.d/flannel.ini\n[program:flanneld-7-21]\ncommand=/opt/flannel/flanneld.sh                             ; the program (relative uses PATH, can take args)\nnumprocs=1                                                   ; number of processes copies to start (def 1)\ndirectory=/opt/flannel                                       ; directory to cwd to before exec (def no cwd)\nautostart=true                                               ; start at supervisord start (default: true)\nautorestart=true                                             ; retstart at unexpected quit (default: true)\nstartsecs=30                                                 ; number of secs prog must stay running (def. 1)\nstartretries=3                                               ; max # of serial start failures (default 3)\nexitcodes=0,2                                                ; 'expected' exit codes for process (default 0,2)\nstopsignal=QUIT                                              ; signal used to kill process (default TERM)\nstopwaitsecs=10                                              ; max num secs to wait b4 SIGKILL (default 10)\nuser=root                                                    ; setuid to this UNIX account to run the program\nredirect_stderr=true                                         ; redirect proc stderr to stdout (default false)\nstdout_logfile=/data/logs/flanneld/flanneld.stdout.log       ; stderr log path, NONE for none; default AUTO\nstdout_logfile_maxbytes=64MB                                 ; max # logfile bytes b4 rotation (default 50MB)\nstdout_logfile_backups=4                                     ; # of stdout logfile backups (default 10)\nstdout_capture_maxbytes=1MB                                  ; number of bytes in 'capturemode' (default 0)\nstdout_events_enabled=false                                  ; emit events on stdout writes (default false)\n\netcd]# supervisorctl update\netcd]# supervisorctl status\n# æŸ¥çœ‹ç»†èŠ‚ä¿¡æ¯\netcd]# tail -fn 200 /data/logs/flanneld/flanneld.stdout.log \n# ä¸¤éƒ¨æœºå™¨å®Œæˆåï¼Œåœ¨21å’Œ22æœºå™¨pingå¯¹æ–¹ï¼Œå·²ç»å¯ä»¥pingé€š\n~~~\n\n![1579147672612](assets/1579147672612.png)\n\nå®Œæˆ\n\nflannelåŸç†ï¼šæ·»åŠ é™æ€è·¯ç”±ï¼ˆå‰ææ¡ä»¶ï¼Œå¿…é¡»å¤„åœ¨åŒä¸€ç½‘å…³ä¹‹ä¸‹ï¼‰\n\nåˆ©ç”¨10.4.7.xæœ¬æ¥äº’é€šçš„å‰æï¼Œ172å…ˆå»æ‰¾10å†è½¬åˆ°å…¶ä¸‹é¢çš„172ï¼Œå½¢æˆäº’é€š\n\n![1582269815607](assets/1582269815607.png)\n\n> å†æ¬¡å¤ä¹ ä¸€éï¼Œ10çš„21æœºå™¨å¯¹åº”çš„172çš„21ï¼Œè¿™æ ·æ–¹ä¾¿çŸ¥é“é‚£äº›podåœ¨é‚£äº›æœºå™¨ä¸Š\n\n\n\n### flannelä¹‹SNATè§„åˆ™ä¼˜åŒ–\n\n> **WHAT**ï¼šä½¿å¾—å®¹å™¨ä¹‹é—´çš„é€æ˜è®¿é—®\n>\n> **WHY**ï¼šè§£å†³ä¸¤å®¿ä¸»æœºå®¹å™¨ä¹‹é—´çš„é€æ˜è®¿é—®ï¼Œå¦‚ä¸è¿›è¡Œä¼˜åŒ–ï¼Œå®¹å™¨ä¹‹é—´çš„è®¿é—®ï¼Œæ—¥å¿—è®°å½•ä¸ºå®¿ä¸»æœºçš„IPåœ°å€\n\n~~~\n# æŠŠnginx:curlæ‹‰ä¸‹æ¥ï¼Œ21æœºå™¨\n~]# docker login docker.io/909336740/nginx:curl\n~]# docker pull 909336740/nginx:curl\n~]# docker images|grep curl\n~]# docker tag 34736e20b17b harbor.od.com/public/nginx:curl\n~]# docker login harbor.od.com\n~]# docker push harbor.od.com/public/nginx:curl\n~~~\n\n![1579152363774](assets/1579152363774.png)\n\n~~~\n# æ”¹ä»¥ä¸‹å†…å®¹ï¼Œ21æœºå™¨ï¼š\ncd\n~]# vi nginx-ds.yaml\nimage: harbor.od.com/public/nginx:curl\n~]# kubectl apply -f nginx-ds.yaml\n~]# kubectl get pods\n# åˆ æ‰ä¸¤ä¸ªpodè®©å®ƒä»¬è‡ªåŠ¨é‡å¯ä»¥ä¾¿åº”ç”¨æ–°é•œåƒ\n~]# kubectl delete pod nginx-ds-5nhq6\n# out:pod \"nginx-ds-5nhq6\" deleted\n~]# kubectl delete pod nginx-ds-cfjvn\n#out:pod \"nginx-ds-cfjvn\" deleted\n~]# kubectl get pods -o wide\n~~~\n\n![1579152725660](assets/1579152725660.png)\n\n~~~\n# 21æœºå™¨ï¼š\n~]# kubectl exec -ti nginx-ds-6nmbr /bin/bash\n6nmbr:/# curl 172.7.22.2\n# æ³¨æ„è¿™ä¸ªpodæ˜¯èµ·åœ¨äº†22ç½‘ç»œäº†ï¼Œå¦‚æœç½‘æ®µæ²¡æœ‰åœ¨22ä¸Šï¼Œå°±curl 172.7.22.2ï¼Œåªè¦æœ‰welcomeçš„ç½‘é¡µå›åº”å³å¯ï¼Œè€Œä¸”logæ—¥å¿—ä¹Ÿæœ‰\n\n# 22æœºå™¨\netcd]# kubectl get pods -o wide\netcd]# kubectl logs -f nginx-ds-drrkt\n~~~\n\n> **kubectl logs -f**ï¼šæŸ¥çœ‹Podæ—¥å¿—\n\n![1579154925882](assets/1579154925882.png)\n\n![1579155042838](assets/1579155042838.png)\n\nç¡®è®¤å¯åŠ¨æ­£å¸¸\n\n~~~\n# 21æœºå™¨ï¼š\n~]# iptables-save |grep -i postrouting\n~~~\n\n![1582271259863](assets/1582271259863.png)\n\n> **iptablesï¼š**\n>\n> - `è¯­æ³•ï¼šiptables [-t è¡¨å] é€‰é¡¹ [é“¾å] [æ¡ä»¶] [-j æ§åˆ¶ç±»å‹]`\n> - **-A**ï¼šåœ¨è§„åˆ™é“¾çš„æœ«å°¾åŠ å…¥æ–°è§„åˆ™\n> - **-s**ï¼šåŒ¹é…æ¥æºåœ°å€IP/MASKï¼ŒåŠ å¹å·\"!\"è¡¨ç¤ºé™¤è¿™ä¸ªIPå¤–\n> - **-o**ï¼šåŒ¹é…ä»è¿™å—ç½‘å¡æµå‡ºçš„æ•°æ®\n> - **MASQUERADE**ï¼šåŠ¨æ€ä¼ªè£…ï¼Œèƒ½å¤Ÿè‡ªåŠ¨çš„å¯»æ‰¾å¤–ç½‘åœ°å€å¹¶æ”¹ä¸ºå½“å‰æ­£ç¡®çš„å¤–ç½‘IPåœ°å€\n> - ä¸Šé¢çº¢æ¡†å†…çš„å¯ä»¥ç†è§£ä¸ºï¼šå¦‚æœæ˜¯172.7.21.0/24æ®µçš„dockerçš„ipï¼Œç½‘ç»œå‘åŒ…ä¸ä»docker0æ¡¥è®¾å¤‡å‡ºæˆ˜çš„ï¼Œå°±è¿›è¡ŒSNATè½¬æ¢ï¼Œè€Œæˆ‘ä»¬éœ€è¦çš„æ˜¯å¦‚æœå‡ºç½‘çš„åœ°å€æ˜¯172.7.21.0/24æˆ–è€…172.7.0.0/16ç½‘ç»œï¼ˆè¿™æ˜¯dockerçš„å¤§ç½‘ç»œï¼‰ï¼Œå°±ä¸è¦åšæºåœ°å€NATè½¬æ¢ï¼Œå› ä¸ºæˆ‘ä»¬é›†ç¾¤å†…éƒ¨éœ€è¦å¦è¯šç›¸è§ï¼Œè‡ªå·±äººä¸éœ€è¦ä¼ªè£…ã€‚\n\n~~~\n# 21/22æœºå™¨ï¼Œæˆ‘ä»¬å¼€å§‹æ”¹ï¼š\n~]# yum install iptables-services -y\n~]# systemctl start iptables\n~]# systemctl enable iptables\n# åˆ æ‰å¯¹åº”çš„è§„åˆ™ï¼Œä»¥ä¸‹éœ€è¦å¯¹åº”æœºå™¨ï¼Œä¸€å¤„ä¿®æ”¹ï¼š-s 172.7.21\n~]# iptables -t nat -D POSTROUTING -s 172.7.21.0/24 ! -o docker0 -j MASQUERADE\n# æ·»åŠ å¯¹åº”çš„è§„åˆ™ï¼Œä»¥ä¸‹éœ€è¦å¯¹åº”æœºå™¨ï¼Œä¸€å¤„ä¿®æ”¹ï¼š-s 172.7.21\n~]# iptables -t nat -I POSTROUTING -s 172.7.21.0/24 ! -d 172.7.0.0/16 ! -o docker0 -j MASQUERADE\n# ä¸Šé¢è¿™æ¡è§„åˆ™å¯ä»¥ç†è§£ä¸ºï¼šåªæœ‰å‡ºç½‘åœ°å€ä¸æ˜¯172.7.21.0/24æˆ–è€…172.7.0.0/16ï¼Œç½‘ç»œå‘åŒ…ä¸ä»docker0æ¡¥è®¾å¤‡å‡ºæˆ˜çš„ï¼Œæ‰åšSNATè½¬æ¢\n~]# iptables-save |grep -i postrouting\n~]# iptables-save > /etc/sysconfig/iptables\n# 21æœºå™¨curl22ï¼Œ22æœºå™¨curl21\n~]# kubectl exec -ti nginx-ds-6nmbr /bin/bash\n6nmbr:/# curl 172.7.22.2\n\n### ç›¸å…³æŠ¥é”™\n# å¦‚æœæŠ¥é”™ï¼šcurl: (7) Failed to connect to 172.7.22.2 port 80: No route to host\n# åˆ™æ‰§è¡Œä»¥ä¸‹æ“ä½œï¼Œåœ¨åˆ æ‰ä¸¤å°æœºå™¨21/22çš„iptablesçš„rejectï¼Œä¸¤è¾¹åŒæ—¶æ‰§è¡Œ\n~]# iptables-save|grep -i reject\n~]# iptables -t filter -D [åå­—]\n~]# iptables-save > /etc/sysconfig/iptables\n###\n~~~\n\n> **iptablesï¼š**\n>\n> - `è¯­æ³•ï¼šiptables [-t è¡¨å] é€‰é¡¹ [é“¾å] [æ¡ä»¶] [-j æ§åˆ¶ç±»å‹]`\n> - -Dï¼šåˆ é™¤æŸä¸€æ¡è§„åˆ™\n> - -Iï¼šåœ¨è§„åˆ™é“¾çš„å¤´éƒ¨åŠ å…¥æ–°è§„åˆ™\n> - -sï¼šåŒ¹é…æ¥æºåœ°å€IP/MASKï¼ŒåŠ å¹å·\"!\"è¡¨ç¤ºé™¤è¿™ä¸ªIPå¤–\n> - -dï¼šåŒ¹é…ç›®æ ‡åœ°å€\n> - -oï¼šåŒ¹é…ä»è¿™å—ç½‘å¡æµå‡ºçš„æ•°æ®\n> - MASQUERADEï¼šåŠ¨æ€ä¼ªè£…ï¼Œèƒ½å¤Ÿè‡ªåŠ¨çš„å¯»æ‰¾å¤–ç½‘åœ°å€å¹¶æ”¹ä¸ºå½“å‰æ­£ç¡®çš„å¤–ç½‘IPåœ°å€\n\n![1579157014119](assets/1579157014119.png)\n\næˆåŠŸå›¾ï¼Œåœ¨22ä¸Šå·²ç»å¯ä»¥æ˜ç¡®çš„çœ‹åˆ°å¯¹æ–¹æ˜¯172.7.21.2äº†ï¼Œåœ¨21ä¸Šå¯ä»¥çœ‹åˆ°å¯¹æ–¹æ˜¯172çš„22ï¼š\n\n![1579157196199](assets/1579157196199.png)\n\n![1579157441471](assets/1579157441471.png)\n\nå®Œæˆ\n\n\n\n### å®‰è£…éƒ¨ç½²corednsï¼ˆæœåŠ¡å‘ç°ï¼‰ï¼š\n\n> **WHAT**ï¼šæœåŠ¡ï¼ˆåº”ç”¨ï¼‰ä¹‹é—´ç›¸äº’å®šä½çš„è¿‡ç¨‹\n>\n> **WHYï¼š**\n>\n> - æœåŠ¡å‘ç°å¯¹åº”çš„åœºæ™¯ï¼š\n>   - æœåŠ¡ï¼ˆåº”ç”¨ï¼‰çš„åŠ¨æ€æ€§æŠ¢\n>   - æœåŠ¡ï¼ˆåº”ç”¨ï¼‰æ›´æ–°å‘å¸ƒé¢‘ç¹\n>   - æœåŠ¡ï¼ˆåº”ç”¨ï¼‰æ”¯æŒè‡ªåŠ¨ä¼¸ç¼©\n>\n> - kuberntesä¸­çš„æ‰€æœ‰podéƒ½æ˜¯åŸºäºServiceåŸŸåè§£æåï¼Œå†è´Ÿè½½å‡è¡¡åˆ†å‘åˆ°serviceåç«¯çš„å„ä¸ªpodæœåŠ¡ä¸­ï¼ŒPODçš„IPæ˜¯ä¸æ–­å˜åŒ–çš„ã€‚å¦‚ä½•è§£å†³ï¼š\n>   - æŠ½è±¡å‡ºServiceèµ„æºï¼Œé€šè¿‡æ ‡ç­¾é€‰æ‹©å™¨ï¼Œå…³è”ä¸€ç»„POD\n>   - æŠ½è±¡å‡ºé›†ç¾¤ç½‘ç»œï¼Œé€šè¿‡å›ºå®šçš„â€œé›†ç¾¤IPâ€ï¼Œä½¿æœåŠ¡æ¥å…¥ç‚¹å›ºå®š\n> - å¦‚ä½•ç®¡ç†Serviceèµ„æºçš„â€œåç§°â€å’Œâ€œé›†ç¾¤ç½‘ç»œIPâ€\n>   - æˆ‘ä»¬å‰é¢åšäº†ä¼ ç»Ÿçš„DNSæ¨¡å‹ï¼šhdss7-21.host.com -> 10.4.7.21\n>   - é‚£ä¹ˆæˆ‘ä»¬å¯ä»¥åœ¨K8Sé‡Œåšè¿™æ ·çš„æ¨¡å‹ï¼šnginx-ds -> 192.168.0.1\n\n~~~\n# ç°åœ¨æˆ‘ä»¬è¦å¼€å§‹ç”¨äº¤ä»˜å®¹å™¨æ–¹å¼äº¤ä»˜æœåŠ¡ï¼ˆéäºŒè¿›åˆ¶ï¼‰ï¼Œè¿™ä¹Ÿæ˜¯ä»¥åæœ€å¸¸ç”¨çš„æ–¹å¼\n# 200æœºå™¨\ncerts]# cd /etc/nginx/conf.d/\nconf.d]# vi /etc/nginx/conf.d/k8s-yaml.od.com.conf\nserver {\n    listen       80;\n    server_name  k8s-yaml.od.com;\n\n    location / {\n        autoindex on;\n        default_type text/plain;\n        root /data/k8s-yaml;\n    }\n}\n\nconf.d]# mkdir /data/k8s-yaml\nconf.d]# nginx -t\nconf.d]# nginx -s reload\n~~~\n\n\n\n~~~\n# 11æœºå™¨ï¼Œè§£æåŸŸåï¼š\n~]# vi /var/named/od.com.zone\nserial å‰æ»šä¸€ä½\n# æœ€ä¸‹é¢æ·»åŠ è¿™ä¸ªç½‘æ®µï¼Œä»¥åä¹Ÿéƒ½æ˜¯åœ¨æœ€ä¸‹é¢æ·»åŠ ï¼Œåé¢æˆ‘å°±åŠ è¿™ä¸ªæ³¨é‡Šäº†\nk8s-yaml           A    10.4.7.200\n\n~]# systemctl restart named\n~]# dig -t A k8s-yaml.od.com @10.4.7.11 +short\n# outï¼š10.4.7.200\n~~~\n\n> **dig -t A**ï¼šæŒ‡çš„æ˜¯æ‰¾DNSé‡Œæ ‡è®°ä¸ºAçš„ç›¸å…³è®°å½•ï¼Œ@ç”¨ä»€ä¹ˆæœºå™¨IPè®¿é—®ï¼Œ+shortæ˜¯åªè¿”å›IP\n\n![1579158143760](assets/1579158143760.png)\n\n~~~\n# 200æœºå™¨\nconf.d]# cd /data/k8s-yaml/\nk8s-yaml]# mkdir coredns\n~~~\n\n[k8s-yaml.od.com](k8s-yaml.od.com)\n\n![1579158360896](assets/1579158360896.png)\n\n~~~~\n# 200æœºå™¨ï¼Œä¸‹è½½corednsé•œåƒï¼š\ncd /data/k8s-yaml/\nk8s-yaml]# docker pull coredns/coredns:1.6.1\nk8s-yaml]# docker images|grep coredns\nk8s-yaml]# docker tag c0f6e815079e harbor.od.com/public/coredns:v1.6.1\nk8s-yaml]# docker push !$\n~~~~\n\n> è¿™é‡Œæˆ‘ä»¬éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œä»»ä½•æˆ‘ç”¨åˆ°çš„é•œåƒéƒ½ä¼šæ¨åˆ°æˆ‘çš„æœ¬åœ°ç§æœ‰ä»“åº“ï¼ŒåŸå› å‰é¢ä¹Ÿè¯´äº†ï¼Œ1ã€æ˜¯ä¸ºäº†ç”¨çš„æ—¶å€™é€Ÿåº¦å¿«ä¿è¯ä¸å‡ºç°ç½‘ç»œé—®é¢˜ï¼Œ2ã€ä¿è¯ç‰ˆæœ¬æ˜¯åŒæ ·çš„ç‰ˆæœ¬ï¼Œè€Œä¸æ˜¯çªç„¶è¢«åˆ«äººä¿®æ”¹äº†\n>\n> **docker push !$**ï¼špushä¸Šä¸€ä¸ªé•œåƒçš„åå­—\n\n~~~\n# 200æœºå™¨ï¼Œå‡†å¤‡èµ„æºé…ç½®æ¸…å•ï¼š\ncd /data/k8s-yaml/coredns\ncoredns]# vi rbac.yaml\napiVersion: v1\nkind: ServiceAccount\nmetadata:\n  name: coredns\n  namespace: kube-system\n  labels:\n      kubernetes.io/cluster-service: \"true\"\n      addonmanager.kubernetes.io/mode: Reconcile\n---\napiVersion: rbac.authorization.k8s.io/v1\nkind: ClusterRole\nmetadata:\n  labels:\n    kubernetes.io/bootstrapping: rbac-defaults\n    addonmanager.kubernetes.io/mode: Reconcile\n  name: system:coredns\nrules:\n- apiGroups:\n  - \"\"\n  resources:\n  - endpoints\n  - services\n  - pods\n  - namespaces\n  verbs:\n  - list\n  - watch\n---\napiVersion: rbac.authorization.k8s.io/v1\nkind: ClusterRoleBinding\nmetadata:\n  annotations:\n    rbac.authorization.kubernetes.io/autoupdate: \"true\"\n  labels:\n    kubernetes.io/bootstrapping: rbac-defaults\n    addonmanager.kubernetes.io/mode: EnsureExists\n  name: system:coredns\nroleRef:\n  apiGroup: rbac.authorization.k8s.io\n  kind: ClusterRole\n  name: system:coredns\nsubjects:\n- kind: ServiceAccount\n  name: coredns\n  namespace: kube-system\n  \ncoredns]# vi cm.yaml\napiVersion: v1\nkind: ConfigMap\nmetadata:\n  name: coredns\n  namespace: kube-system\ndata:\n  Corefile: |\n    .:53 {\n        errors\n        log\n        health\n        ready\n        kubernetes cluster.local 192.168.0.0/16\n        forward . 10.4.7.11\n        cache 30\n        loop\n        reload\n        loadbalance\n       }\n       \ncoredns]# vi dp.yaml\napiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: coredns\n  namespace: kube-system\n  labels:\n    k8s-app: coredns\n    kubernetes.io/name: \"CoreDNS\"\nspec:\n  replicas: 1\n  selector:\n    matchLabels:\n      k8s-app: coredns\n  template:\n    metadata:\n      labels:\n        k8s-app: coredns\n    spec:\n      priorityClassName: system-cluster-critical\n      serviceAccountName: coredns\n      containers:\n      - name: coredns\n        image: harbor.od.com/public/coredns:v1.6.1\n        args:\n        - -conf\n        - /etc/coredns/Corefile\n        volumeMounts:\n        - name: config-volume\n          mountPath: /etc/coredns\n        ports:\n        - containerPort: 53\n          name: dns\n          protocol: UDP\n        - containerPort: 53\n          name: dns-tcp\n          protocol: TCP\n        - containerPort: 9153\n          name: metrics\n          protocol: TCP\n        livenessProbe:\n          httpGet:\n            path: /health\n            port: 8080\n            scheme: HTTP\n          initialDelaySeconds: 60\n          timeoutSeconds: 5\n          successThreshold: 1\n          failureThreshold: 5\n      dnsPolicy: Default\n      volumes:\n        - name: config-volume\n          configMap:\n            name: coredns\n            items:\n            - key: Corefile\n              path: Corefile\n              \ncoredns]# vi svc.yaml\napiVersion: v1\nkind: Service\nmetadata:\n  name: coredns\n  namespace: kube-system\n  labels:\n    k8s-app: coredns\n    kubernetes.io/cluster-service: \"true\"\n    kubernetes.io/name: \"CoreDNS\"\nspec:\n  selector:\n    k8s-app: coredns\n  clusterIP: 192.168.0.2\n  ports:\n  - name: dns\n    port: 53\n    protocol: UDP\n  - name: dns-tcp\n    port: 53\n  - name: metrics\n    port: 9153\n    protocol: TCP\n~~~\n\n\n\n~~~~\n# 21æœºå™¨ï¼Œåº”ç”¨èµ„æºé…ç½®æ¸…å•ï¼ˆé™ˆè¿°å¼ï¼‰ï¼š\n~]# kubectl apply -f http://k8s-yaml.od.com/coredns/rbac.yaml\n~]# kubectl apply -f http://k8s-yaml.od.com/coredns/cm.yaml\n~]# kubectl apply -f http://k8s-yaml.od.com/coredns/dp.yaml\n~]# kubectl apply -f http://k8s-yaml.od.com/coredns/svc.yaml\n~]# kubectl get all -n kube-system\n~~~~\n\n![1579159195207](assets/1579159195207.png)\n\n> **CLUSTER-IPä¸ºä»€ä¹ˆæ˜¯192.168.0.2**ï¼šå› ä¸ºæˆ‘ä»¬ä¹‹å‰å·²ç»å†™æ­»äº†è¿™æ˜¯æˆ‘ä»¬dnsçš„ç»Ÿä¸€æ¥å…¥ç‚¹\n>\n> ![1582278638665](assets/1582278638665.png)\n\n~~~\n# 21æœºå™¨ï¼Œæµ‹è¯•ï¼ˆæˆ‘çš„å·²ç»å­˜åœ¨äº†ï¼Œä¸è¿‡ä¸å½±å“ï¼‰ï¼š\n~]# kubectl create deployment nginx-dp --image=harbor.od.com/public/nginx:v1.7.9 -n kube-public\n~]# kubectl expose deployment nginx-dp --port=80 -n kube-public\n~]# kubectl get svc -n kube-public\n~]# dig -t A nginx-dp.kube-public.svc.cluster.local. @192.168.0.2 +short\n# outï¼š192.168.81.37\n~~~\n\n> **dig -t A**ï¼šæŒ‡çš„æ˜¯æ‰¾DNSé‡Œæ ‡è®°ä¸ºAçš„ç›¸å…³è®°å½•ï¼Œ@ç”¨ä»€ä¹ˆæœºå™¨IPè®¿é—®ï¼Œ+shortæ˜¯åªè¿”å›IP\n\n![1579161063657](assets/1579161063657.png)\n\nå®Œæˆé›†ç¾¤â€œå†…â€è¢«è‡ªåŠ¨å‘ç°\n\n\n\n### K8Sçš„æœåŠ¡æš´éœ²ingress\n\n> **WHAT**ï¼šK8S APIçš„æ ‡å‡†èµ„æºç±»å‹ä¹‹ä¸€ï¼Œä¹Ÿæ˜¯æ ¸å¿ƒèµ„æºï¼Œå®ƒæ˜¯åŸºäºåŸŸåå’ŒURLè·¯å¾„ï¼ŒæŠŠç”¨æˆ·çš„è¯·æ±‚è½¬å‘è‡³æŒ‡å®šServiceèµ„æºçš„è§„åˆ™\n>\n> - å°†é›†ç¾¤å¤–éƒ¨çš„è¯·æ±‚æµé‡ï¼Œè½¬å‘è‡³é›†ç¾¤å†…éƒ¨ï¼Œä»è€Œå®ç°â€œæœåŠ¡æš´éœ²â€\n> - nginx + goè„šæœ¬\n>\n> **WHY**ï¼šä¸Šé¢å®ç°äº†æœåŠ¡åœ¨é›†ç¾¤â€œå†…â€è¢«è‡ªåŠ¨å‘ç°ï¼Œé‚£ä¹ˆéœ€è¦ä½¿å¾—æœåŠ¡åœ¨é›†ç¾¤â€œå¤–â€è¢«ä½¿ç”¨å’Œè®¿é—®ï¼Œå¸¸è§„çš„ä¸¤ç§æ–¹æ³•ï¼š\n>\n> - ä½¿ç”¨NodePortå‹çš„service\n>   - æ— æ³•ä½¿ç”¨kube-proxyçš„ipvsæ¨¡å‹ï¼Œåªèƒ½ä½¿ç”¨iptablesæ¨¡å‹\n> - ä½¿ç”¨ingressèµ„æº\n>   - åªèƒ½è°ƒåº¦å¹¶æš´éœ²7è¹­åº”ç”¨ï¼Œç‰¹æŒ‡httpå’Œhttpsåè®®\n\n##### ä»¥trafikerä¸ºä¾‹\n\n> **WHAT**ï¼šä¸ºäº†è®©éƒ¨ç½²å¾®æœåŠ¡æ›´åŠ ä¾¿æ·è€Œè¯ç”Ÿçš„ç°ä»£HTTPåå‘ä»£ç†ã€è´Ÿè½½å‡è¡¡å·¥å…·ã€‚\n>\n> **WHY**ï¼šå¯ä»¥ç›‘å¬ä½ çš„æœåŠ¡å‘ç°/åŸºç¡€æ¶æ„ç»„ä»¶çš„ç®¡ç†APIï¼Œå¹¶ä¸”æ¯å½“ä½ çš„å¾®æœåŠ¡è¢«æ·»åŠ ã€ç§»é™¤ã€æ€æ­»æˆ–æ›´æ–°éƒ½ä¼šè¢«æ„ŸçŸ¥ï¼Œå¹¶ä¸”å¯ä»¥è‡ªåŠ¨ç”Ÿæˆå®ƒä»¬çš„é…ç½®æ–‡ä»¶\n\n~~~\n# 200æœºå™¨ï¼Œéƒ¨ç½²traefikerï¼ˆingressæ§åˆ¶å™¨ï¼‰\ncd /data/k8s-yaml/\nk8s-yaml]# mkdir traefik\nk8s-yaml]# cd traefik/\ntraefik]# docker pull traefik:v1.7.2-alpine\ntraefik]# docker images|grep traefik\ntraefik]# docker tag add5fac61ae5 harbor.od.com/public/traefik:v1.7.2\ntraefik]# docker push harbor.od.com/public/traefik:v1.7.2\n~~~\n\n> å¤ä¹ ï¼šmkdir åˆ›å»ºç›®å½•ã€cd ç§»åŠ¨åˆ°å…¶å®ƒç›®å½•ã€\n>\n> docker pull ä¸‹è½½é•œåƒã€docker tag æ‰“æ ‡ç­¾ã€docker push ä¸Šä¼ åˆ°ä»“åº“\n\n~~~\n# 200æœºå™¨ï¼Œå‡†å¤‡èµ„æºé…ç½®æ¸…å•(4ä¸ªyaml)ï¼š\ntraefik]# vi rbac.yaml\napiVersion: v1\nkind: ServiceAccount\nmetadata:\n  name: traefik-ingress-controller\n  namespace: kube-system\n---\napiVersion: rbac.authorization.k8s.io/v1beta1\nkind: ClusterRole\nmetadata:\n  name: traefik-ingress-controller\nrules:\n  - apiGroups:\n      - \"\"\n    resources:\n      - services\n      - endpoints\n      - secrets\n    verbs:\n      - get\n      - list\n      - watch\n  - apiGroups:\n      - extensions\n    resources:\n      - ingresses\n    verbs:\n      - get\n      - list\n      - watch\n---\nkind: ClusterRoleBinding\napiVersion: rbac.authorization.k8s.io/v1beta1\nmetadata:\n  name: traefik-ingress-controller\nroleRef:\n  apiGroup: rbac.authorization.k8s.io\n  kind: ClusterRole\n  name: traefik-ingress-controller\nsubjects:\n- kind: ServiceAccount\n  name: traefik-ingress-controller\n  namespace: kube-system\n\ntraefik]# vi ds.yaml\napiVersion: extensions/v1beta1\nkind: DaemonSet\nmetadata:\n  name: traefik-ingress\n  namespace: kube-system\n  labels:\n    k8s-app: traefik-ingress\nspec:\n  template:\n    metadata:\n      labels:\n        k8s-app: traefik-ingress\n        name: traefik-ingress\n    spec:\n      serviceAccountName: traefik-ingress-controller\n      terminationGracePeriodSeconds: 60\n      containers:\n      - image: harbor.od.com/public/traefik:v1.7.2\n        name: traefik-ingress\n        ports:\n        - name: controller\n          containerPort: 80\n          hostPort: 81\n        - name: admin-web\n          containerPort: 8080\n        securityContext:\n          capabilities:\n            drop:\n            - ALL\n            add:\n            - NET_BIND_SERVICE\n        args:\n        - --api\n        - --kubernetes\n        - --logLevel=INFO\n        - --insecureskipverify=true\n        - --kubernetes.endpoint=https://10.4.7.10:7443\n        - --accesslog\n        - --accesslog.filepath=/var/log/traefik_access.log\n        - --traefiklog\n        - --traefiklog.filepath=/var/log/traefik.log\n        - --metrics.prometheus\n\t\t\ntraefik]# vi svc.yaml\nkind: Service\napiVersion: v1\nmetadata:\n  name: traefik-ingress-service\n  namespace: kube-system\nspec:\n  selector:\n    k8s-app: traefik-ingress\n  ports:\n    - protocol: TCP\n      port: 80\n      name: controller\n    - protocol: TCP\n      port: 8080\n      name: admin-web\n\t  \ntraefik]# vi ingress.yaml\napiVersion: extensions/v1beta1\nkind: Ingress\nmetadata:\n  name: traefik-web-ui\n  namespace: kube-system\n  annotations:\n    kubernetes.io/ingress.class: traefik\nspec:\n  rules:\n  - host: traefik.od.com\n    http:\n      paths:\n      - path: /\n        backend:\n          serviceName: traefik-ingress-service\n          servicePort: 8080\n~~~\n\n> æ¯æ¬¡æœ‰ingressæ—¶ï¼Œæˆ‘ä»¬ç¬¬ä¸€ååº”å°±æ˜¯è¦å»è§£æåŸŸå\n>\n> è¿™é‡Œä¸ºä»€ä¹ˆæˆ‘ä»¬éƒ½å¯ä»¥æŠŠä»€ä¹ˆéƒ½ä¸¢åˆ°80ç«¯å£ï¼Œæ˜¯å› ä¸ºç°åœ¨å·²ç»æ˜¯Podäº†ï¼Œå·²ç»éš”ç¦»äº†ï¼Œæ— æ‰€è°“ä½ ç”¨ä»€ä¹ˆç«¯å£\n\n~~~\n# 21/22ä»»æ„æœºå™¨ï¼ˆæˆ‘ç”¨çš„22ï¼‰ï¼Œåº”ç”¨èµ„æºé…ç½®æ¸…å•ï¼š\n~]# kubectl apply -f http://k8s-yaml.od.com/traefik/rbac.yaml\n~]# kubectl apply -f http://k8s-yaml.od.com/traefik/ds.yaml\n~]# kubectl apply -f http://k8s-yaml.od.com/traefik/svc.yaml\n~]# kubectl apply -f http://k8s-yaml.od.com/traefik/ingress.yaml\n# ä¸‹é¢é‡å¯dockeræœåŠ¡è¦åœ¨21/22èŠ‚ç‚¹éƒ½æ‰§è¡Œï¼Œå¦åˆ™ä¼šæœ‰ä¸€ä¸ªèµ·ä¸æ¥\n~]# systemctl restart docker.service\n~]# kubectl get pods -n kube-system\n~]# netstat -luntp|grep 81\n~~~\n\n![1579165378812](assets/1579165378812.png)\n\n~~~\n# 11/12æœºå™¨ï¼Œåšåä»£ï¼š\n~]# vi /etc/nginx/conf.d/od.com.conf\nupstream default_backend_traefik {\n    server 10.4.7.21:81    max_fails=3 fail_timeout=10s;\n    server 10.4.7.22:81    max_fails=3 fail_timeout=10s;\n}\nserver {\n    server_name *.od.com;\n  \n    location / {\n        proxy_pass http://default_backend_traefik;\n        proxy_set_header Host       $http_host;\n        proxy_set_header x-forwarded-for $proxy_add_x_forwarded_for;\n    }\n}\n\n~]# nginx -t\n~]# nginx -s reload\n\n# 11æœºå™¨,è§£æåŸŸåï¼š\n~]# vi /var/named/od.com.zone \nå‰æ»šserial\ntraefik            A    10.4.7.10\n\n~]# systemctl restart named\n~~~\n\n> **nginx -t**ï¼šæ£€æŸ¥nginx.confæ–‡ä»¶æœ‰æ²¡æœ‰è¯­æ³•é”™è¯¯\n>\n> **nginx -s reload**ï¼šä¸éœ€è¦é‡å¯nginxçš„çƒ­é…ç½®\n\n![1579167500955](assets/1579167500955.png)\n\n[è®¿é—®traefik.od.com](traefik.od.com)\n\n![1579167546083](assets/1579167546083.png)\n\nå®Œæˆ\n\n##### ç”¨æˆ·è®¿é—®æµç¨‹ï¼š\n\nå½“ç”¨æˆ·è¾“å…¥traefik.od.comæ—¶ï¼Œè¢«dnsè§£æåˆ°10.4.7.10ï¼Œè€Œ10åˆ™åœ¨11ä¸Šï¼Œå»æ‰¾L7å±‚æœåŠ¡ï¼Œè€Œåä»£é…ç½®çš„od.com.confï¼Œåˆ™æ˜¯å°†*.od.comæ— å·®åˆ«çš„æŠ›ç»™äº†ingressï¼Œingressåˆ™é€šè¿‡noteselectæ‰¾åˆ°pod\n\n![1584961721898](assets/1584961721898.png)\n\nå†å›é¡¾ä¸Šé¢çš„æ¶æ„å›¾ï¼Œæˆ‘ä»¬å·²ç»å…¨éƒ¨å®‰è£…éƒ¨ç½²å®Œã€‚\n\næ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°±è¦å¼€å§‹å®‰è£…éƒ¨ç½²K8Sçš„å‘¨è¾¹ç”Ÿæ€ï¼Œä½¿å…¶æˆä¸ºä¸€ä¸ª**çœŸæ­£çš„PaaSæœåŠ¡**\n\n<a href=\"https://github.com/ben1234560/k8s_PaaS/blob/master/%E5%8E%9F%E7%90%86%E5%8F%8A%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/Kubernetes%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5.md#kubernetes%E6%8A%80%E8%83%BD%E5%9B%BE%E8%B0%B1\">kubernetesæŠ€èƒ½å›¾è°±</a>\n\n"
        },
        {
          "name": "ç¬¬äºŒç« â€”â€”ä¼ä¸šéƒ¨ç½²å®æˆ˜_K8S.md",
          "type": "blob",
          "size": 68.826171875,
          "content": "## ç¬¬äºŒç« â€”â€”ä¼ä¸šéƒ¨ç½²å®æˆ˜_K8S\n\nå…¬æœ‰äº‘ç‰ˆï¼š[ç¬¬äºŒç« â€”â€”ä¼ä¸šéƒ¨ç½²å®æˆ˜_K8Sã€å…¬æœ‰äº‘ç‰ˆã€‘](https://github.com/ben1234560/k8s_PaaS/blob/master/%E7%AC%AC%E4%BA%8C%E7%AB%A0%E2%80%94%E2%80%94%E4%BC%81%E4%B8%9A%E9%83%A8%E7%BD%B2%E5%AE%9E%E6%88%98_K8S%E3%80%90%E5%85%AC%E6%9C%89%E4%BA%91%E7%89%88%E3%80%91.md)\n\n**ç”±äºç¬¬äºŒç« éœ€è¦é…ç½®çš„å†…å®¹è¾ƒå¤šï¼Œä¸å°‘æ–°åŒå­¦å¡åœ¨è¿™é‡Œã€‚å»ºè®®é…åˆä½¿ç”¨[è½¯ä»¶åŒ…é‡Œçš„check_tool](https://github.com/ben1234560/k8s_PaaS/tree/master/%E8%BD%AF%E4%BB%B6%E5%8C%85/check_tool)è¾¹æ£€æŸ¥ï¼Œè¾¹éƒ¨ç½²**\n\n##### å‰è¨€ï¼šå¦‚æœä½ æ˜¯æ–°æ‰‹ï¼Œæœºå™¨çš„åå­—åŠå„ç§è´¦æˆ·å¯†ç ä¸€å®šè¦å’Œæˆ‘çš„ä¸€æ ·ï¼Œå…ˆå­¦ä¸€éï¼Œå†è‡ªå·±æ”¹\n\n> **WHAT**ï¼šç”¨äºç®¡ç†äº‘å¹³å°ä¸­å¤šä¸ªä¸»æœºä¸Šçš„å®¹å™¨åŒ–çš„åº”ç”¨ï¼ŒKubernetesçš„ç›®æ ‡æ˜¯è®©éƒ¨ç½²å®¹å™¨åŒ–çš„åº”ç”¨ç®€å•å¹¶ä¸”é«˜æ•ˆï¼ˆpowerfulï¼‰,Kubernetesæä¾›äº†åº”ç”¨éƒ¨ç½²ï¼Œè§„åˆ’ï¼Œæ›´æ–°ï¼Œç»´æŠ¤çš„ä¸€ç§æœºåˆ¶\n>\n> **WHY**ï¼šä¸ºä»€ä¹ˆä½¿ç”¨å®ƒï¼Œå› ä¸ºå®ƒæ˜¯ç®¡ç†dockerå®¹å™¨æœ€ä¸»æµçš„ç¼–æ’å·¥å…·\n\n- Pod\n  - Podæ˜¯K8Sé‡Œèƒ½å¤Ÿè¢«è¿è¡Œçš„æœ€å°çš„é€»è¾‘å•å…ƒï¼ˆåŸå­å•å…ƒï¼‰\n  - 1ä¸ªPodé‡Œé¢å¯ä»¥è¿è¡Œå¤šä¸ªå®¹å™¨ï¼Œå®ƒä»¬å…±äº«UTS+NET+IPCåç§°ç©ºé—´\n  - å¯ä»¥æŠŠPodç†è§£æˆè±Œè±†èšï¼Œè€ŒåŒä¸€Podå†…çš„æ¯ä¸ªå®¹å™¨æ˜¯ä¸€é¢—é¢—è±Œè±†\n  - ä¸€ä¸ªPodé‡Œè¿è¡Œå¤šä¸ªå®¹å™¨ï¼Œåˆå«è¾¹è½¦ï¼ˆSideCarï¼‰æ¨¡å¼\n- Podæ§åˆ¶å™¨ï¼ˆå…³äºæ›´å¤š<a href=\"https://github.com/ben1234560/k8s_PaaS/blob/master/%E5%8E%9F%E7%90%86%E5%8F%8A%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/Kubernetes%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5.md#%E5%88%9D%E8%AF%86pod\">åˆè¯†Pod</a>ï¼‰\n  - Podæ§åˆ¶å™¨æ˜¯Podå¯åŠ¨çš„ä¸€ç§æ¨¡æ¿ï¼Œç”¨æ¥ä¿è¯åœ¨K8Sé‡Œå¯åŠ¨çš„Podå§‹ç»ˆæŒ‰ç…§äººä»¬çš„é¢„æœŸè¿è¡Œï¼ˆå‰¯æœ¬æ•°ã€ç”Ÿå‘½å‘¨æœŸã€å¥åº·çŠ¶æ€æ£€æŸ¥...ï¼‰\n  - Podå†…æä¾›äº†ä¼—å¤šçš„Podæ§åˆ¶å™¨ï¼Œå¸¸ç”¨çš„æœ‰ä»¥ä¸‹å‡ ç§ï¼š\n    - Deployment\n    - DaemonSet\n    - ReplicaSet\n    - StatefulSet\n    - Job\n    - Cronjob\n- Name\n  - ç”±äºK8Så†…éƒ¨ï¼Œä½¿ç”¨â€œèµ„æºâ€æ¥å®šä¹‰æ¯ä¸€ç§é€»è¾‘æ¦‚å¿µï¼ˆåŠŸèƒ½ï¼‰ï¼Œæ•…æ¯ç§â€œèµ„æºâ€ï¼Œéƒ½åº”è¯¥æœ‰è‡ªå·±çš„â€œåç§°â€\n  - â€œèµ„æºâ€æœ‰apiç‰ˆæœ¬ï¼ˆapiVersionï¼‰ç±»åˆ«ï¼ˆkindï¼‰ã€å…ƒæ•°æ®ï¼ˆmetadataï¼‰ã€å®šä¹‰æ¸…å•ï¼ˆspecï¼‰ã€çŠ¶æ€ï¼ˆstatusï¼‰ç­‰é…ç½®ä¿¡æ¯\n  - â€œåç§°â€é€šå¸¸å®šä¹‰åœ¨â€œèµ„æºâ€çš„â€œå…ƒæ•°æ®â€ä¿¡æ¯é‡Œ\n- <a href=\"https://github.com/ben1234560/k8s_PaaS/blob/master/%E5%8E%9F%E7%90%86%E5%8F%8A%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/Docker%E5%9F%BA%E7%A1%80.md#%E5%85%B3%E4%BA%8Enamespace\">namespace</a>\n  - éšç€é¡¹ç›®å¢å¤šã€äººå‘˜å¢åŠ ã€é›†ç¾¤è§„æ¨¡çš„æ‰©å¤§ï¼Œéœ€è¦ä¸€ç§èƒ½å¤Ÿéš”ç¦»K8Så†…å„ç§â€œèµ„æºâ€çš„æ–¹æ³•ï¼Œè¿™å°±æ˜¯åç§°ç©ºé—´\n  - åç§°ç©ºé—´å¯ä»¥ç†è§£ä¸ºK8Så†…éƒ¨çš„è™šæ‹Ÿé›†ç¾¤ç»„\n  - ä¸åŒåç§°ç©ºé—´å†…çš„â€œèµ„æºâ€åç§°å¯ä»¥ç›¸åŒï¼Œç›¸åŒåç§°ç©ºé—´å†…çš„åŒç§â€œèµ„æºâ€ã€â€œåç§°â€ä¸èƒ½ç›¸åŒ\n  - åˆç†çš„ä½¿ç”¨K8Såç§°ç©ºé—´ï¼Œä½¿å¾—é›†ç¾¤ç®¡ç†å‘˜èƒ½å¤Ÿæ›´å¥½çš„å¯¹äº¤ä»˜åˆ°K8Sé‡Œçš„æœåŠ¡è¿›è¡Œåˆ†ç±»ç®¡ç†å’Œæµè§ˆ\n  - K8Så†…é»˜è®¤å­˜åœ¨çš„åç§°ç©ºé—´æœ‰ï¼šdefaultã€kube-systemã€kube-public\n  - æŸ¥è¯¢K8Sé‡Œç‰¹å®šâ€œèµ„æºâ€è¦å¸¦ä¸Šç›¸åº”çš„åç§°ç©ºé—´\n- Label\n  - æ ‡ç­¾æ˜¯K8Sç‰¹è‰²çš„ç®¡ç†æ–¹å¼ï¼Œä¾¿äºåˆ†ç±»ç®¡ç†èµ„æºå¯¹è±¡\n  - ä¸€ä¸ªæ ‡ç­¾å¯ä»¥å¯¹åº”å¤šä¸ªèµ„æºï¼Œä¸€ä¸ªèµ„æºä¹Ÿå¯ä»¥æœ‰å¤šä¸ªæ ‡ç­¾ï¼Œå®ƒä»¬æ˜¯å¤šå¯¹å¤šçš„å…³ç³»\n  - ä¸€ä¸ªèµ„æºæ‹¥æœ‰å¤šä¸ªæ ‡ç­¾ï¼Œå¯ä»¥å®ç°ä¸åŒç»´åº¦çš„ç®¡ç†\n  - æ ‡ç­¾çš„ç»„æˆï¼škey=value\n  - ä¸æ ‡ç­¾ç±»ä¼¼çš„ï¼Œè¿˜æœ‰ä¸€ç§â€œæ³¨è§£â€ï¼ˆannotationsï¼‰\n- Labelé€‰æ‹©å™¨\n  - ç»™èµ„æºæ‰“ä¸Šæ ‡ç­¾åï¼Œå¯ä»¥ä½¿ç”¨æ ‡ç­¾é€‰æ‹©å™¨è¿‡æ»¤æŒ‡å®šçš„æ ‡ç­¾\n  - æ ‡ç­¾é€‰æ‹©å™¨ç›®å‰æœ‰ä¸¤ä¸ªï¼šåŸºäºç­‰å€¼å…³ç³»ï¼ˆç­‰äºã€ä¸ç­‰äºï¼‰å’ŒåŸºäºé›†åˆå…³ç³»ï¼ˆå±äºã€ä¸å±äºã€å­˜åœ¨ï¼‰\n  - è®¸å¤šèµ„æºæ”¯æŒå†…åµŒæ ‡ç­¾é€‰æ‹©å™¨å­—æ®µ\n    - matchLabels\n    - matchExpressions\n- Service\n  - åœ¨K8Sçš„ä¸–ç•Œé‡Œï¼Œè™½ç„¶æ¯ä¸ªPodéƒ½ä¼šè¢«åˆ†é…ä¸€ä¸ªå•ç‹¬çš„IPåœ°å€ï¼Œä½†è¿™ä¸ªIPåœ°å€ä¼šéšç€Podçš„é”€æ¯è€Œæ¶ˆå¤±\n  - Serviceï¼ˆæœåŠ¡ï¼‰å°±æ˜¯ç”¨æ¥è§£å†³è¿™ä¸ªé—®é¢˜çš„æ ¸å¿ƒæ¦‚å¿µ\n  - ä¸€ä¸ªServiceå¯ä»¥çœ‹ä½œä¸€ç»„æä¾›ç›¸åŒæœåŠ¡çš„Podçš„å¯¹å¤–è®¿é—®æ¥å£\n  - Serviceä½œç”¨ä¸å“ªäº›Podæ˜¯é€šè¿‡æ ‡ç­¾é€‰æ‹©å™¨æ¥å®šä¹‰çš„\n- Ingress\n  - Ingressæ˜¯K8Sé›†ç¾¤é‡Œå·¥ä½œåœ¨OSIç½‘ç»œå‚è€ƒæ¨¡å‹ä¸‹ï¼Œç¬¬7å±‚çš„åº”ç”¨ï¼Œå¯¹å¤–æš´éœ²çš„æ¥å£\n  - Serviceåªèƒ½è¿›è¡ŒL4æµé‡è°ƒåº¦ï¼Œè¡¨ç°å½¢å¼æ˜¯ip+port\n  - Ingressåˆ™å¯ä»¥è°ƒåº¦ä¸åŒä¸šåŠ¡åŸŸã€ä¸åŒURLè®¿é—®è·¯å¾„çš„ä¸šåŠ¡æµé‡\n\nç®€å•ç†è§£ï¼šPodå¯è¿è¡Œçš„åŸå­ï¼Œnameå®šä¹‰åå­—ï¼Œnamespaceåç§°ç©ºé—´ï¼ˆæ”¾ä¸€å †åå­—ï¼‰ï¼Œlabelæ ‡ç­¾ï¼ˆå¦å¤–çš„åå­—ï¼‰ï¼Œserviceæä¾›æœåŠ¡ï¼Œingressé€šä¿¡\n\n### K8Sæ¶æ„å›¾ï¼ˆå¹¶éä¼ ç»Ÿæ„ä¹‰ä¸Šçš„PaaSæœåŠ¡ï¼Œè€Œæ˜¯IaaSæœåŠ¡ï¼‰\n\n![1582188308711](assets/1582188308711.png)\n\n> **kubectl**ï¼šKubernetesé›†ç¾¤çš„å‘½ä»¤è¡Œæ¥å£\n>\n> **API Server**ï¼šçš„æ ¸å¿ƒåŠŸèƒ½æ˜¯å¯¹æ ¸å¿ƒå¯¹è±¡ï¼ˆä¾‹å¦‚ï¼šPodï¼ŒServiceï¼ŒRCï¼‰çš„å¢åˆ æ”¹æŸ¥æ“ä½œï¼ŒåŒæ—¶ä¹Ÿæ˜¯é›†ç¾¤å†…æ¨¡å—ä¹‹é—´æ•°æ®äº¤æ¢çš„æ¢çº½\n>\n> **Etcd**ï¼šåŒ…å«åœ¨ APIServer ä¸­ï¼Œç”¨æ¥å­˜å‚¨èµ„æºä¿¡æ¯\n>\n> **Controller Manager **ï¼šè´Ÿè´£ç»´æŠ¤é›†ç¾¤çš„çŠ¶æ€ï¼Œæ¯”å¦‚æ•…éšœæ£€æµ‹ã€è‡ªåŠ¨æ‰©å±•ã€æ»šåŠ¨æ›´æ–°ç­‰\n>\n> **Scheduler**ï¼šè´Ÿè´£èµ„æºçš„è°ƒåº¦ï¼ŒæŒ‰ç…§é¢„å®šçš„è°ƒåº¦ç­–ç•¥å°†Podè°ƒåº¦åˆ°ç›¸åº”çš„æœºå™¨ä¸Šã€‚å¯ä»¥é€šè¿‡è¿™äº›æœ‰æ›´æ·±çš„äº†è§£ï¼š\n>\n> - <a href=\"https://github.com/ben1234560/k8s_PaaS/blob/master/%E5%8E%9F%E7%90%86%E5%8F%8A%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/Kubernetes%E8%B0%83%E5%BA%A6%E6%9C%BA%E5%88%B6.md\">Kubernetesè°ƒåº¦æœºåˆ¶</a>\n> - <a href=\"https://github.com/ben1234560/k8s_PaaS/blob/master/%E5%8E%9F%E7%90%86%E5%8F%8A%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/Kubernetes%E8%B0%83%E5%BA%A6%E6%9C%BA%E5%88%B6.md#kubernetes%E7%9A%84%E8%B5%84%E6%BA%90%E6%A8%A1%E5%9E%8B%E4%B8%8E%E8%B5%84%E6%BA%90%E7%AE%A1%E7%90%86\">Kubernetesçš„èµ„æºæ¨¡å‹ä¸èµ„æºç®¡ç†</a>\n> - <a href=\"https://github.com/ben1234560/k8s_PaaS/blob/master/%E5%8E%9F%E7%90%86%E5%8F%8A%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/Kubernetes%E8%B0%83%E5%BA%A6%E6%9C%BA%E5%88%B6.md#kubernetes%E9%BB%98%E8%AE%A4%E7%9A%84%E8%B0%83%E5%BA%A6%E7%AD%96%E7%95%A5\">Kubernetesé»˜è®¤çš„è°ƒåº¦ç­–ç•¥</a>\n> - <a href=\"https://github.com/ben1234560/k8s_PaaS/blob/master/%E5%8E%9F%E7%90%86%E5%8F%8A%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/Kubernetes%E8%B0%83%E5%BA%A6%E6%9C%BA%E5%88%B6.md#%E8%B0%83%E5%BA%A6%E5%99%A8%E7%9A%84%E4%BC%98%E5%85%88%E7%BA%A7%E4%B8%8E%E5%BC%BA%E5%88%B6%E6%9C%BA%E5%88%B6\">è°ƒåº¦å™¨çš„ä¼˜å…ˆçº§ä¸å¼ºåˆ¶æœºåˆ¶</a>\n>\n> **kube-proxy**ï¼šè´Ÿè´£ä¸ºServiceæä¾›clusterå†…éƒ¨çš„æœåŠ¡å‘ç°å’Œè´Ÿè½½å‡è¡¡\n>\n> **Kubelet**ï¼šåœ¨Kubernetesä¸­ï¼Œåº”ç”¨å®¹å™¨å½¼æ­¤æ˜¯éš”ç¦»çš„ï¼Œå¹¶ä¸”ä¸è¿è¡Œå…¶çš„ä¸»æœºä¹Ÿæ˜¯éš”ç¦»çš„ï¼Œè¿™æ˜¯å¯¹åº”ç”¨è¿›è¡Œç‹¬ç«‹è§£è€¦ç®¡ç†çš„å…³é”®ç‚¹ã€‚[Kubeletå·¥ä½œåŸç†è§£æ](https://github.com/ben1234560/k8s_PaaS/blob/master/%E5%8E%9F%E7%90%86%E5%8F%8A%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/Kubernetes%E8%B0%83%E5%BA%A6%E6%9C%BA%E5%88%B6.md#kubelet)\n>\n> **Node**ï¼šè¿è¡Œå®¹å™¨åº”ç”¨ï¼Œç”±Masterç®¡ç†\n\n### æˆ‘ä»¬éƒ¨ç½²çš„K8Sæ¶æ„å›¾\n\n![1584700891603](assets/1584700891603.png)\n\n> å¯ä»¥ç®€å•ç†è§£æˆï¼š\n>\n> 11æœºå™¨ï¼šåå‘ä»£ç†\n>\n> 12æœºå™¨ï¼šåå‘ä»£ç†\n>\n> 21æœºå™¨ï¼šä¸»æ§+è¿ç®—èŠ‚ç‚¹ï¼ˆå³æœåŠ¡ç¾¤éƒ½æ˜¯è·‘åœ¨21å’Œ22ä¸Šï¼‰\n>\n> 22æœºå™¨ï¼šä¸»æ§+è¿ç®—èŠ‚ç‚¹ï¼ˆç”Ÿäº§ä¸Šæˆ‘ä»¬ä¼šæŠŠä¸»æ§å’Œè¿ç®—åˆ†å¼€ï¼‰\n>\n> 200æœºå™¨ï¼šè¿ç»´ä¸»æœºï¼ˆæ”¾å„ç§æ–‡ä»¶èµ„æºï¼‰\n>\n> è¿™æ ·æ§èŠ‚ç‚¹æœ‰ä¸¤ä¸ªï¼Œè¿ç®—èŠ‚ç‚¹æœ‰ä¸¤ä¸ªï¼Œå°±æ˜¯å°å‹çš„åˆ†å¸ƒå¼ï¼Œç°åœ¨ä½ å¯èƒ½æ²¡åŠæ³•ç†è§£è¿™äº›å†…å®¹ï¼Œæˆ‘ä»¬æ¥ç€åšä¸‹å»ï¼Œæ…¢æ…¢çš„ï¼Œä½ å°±ç†è§£äº†\n\n\n\n### å®éªŒæœºå™¨å®‰è£…è¯¦è§£\n\nå‡†å¤‡ä¸€å°8C64Gçš„æœºå™¨ï¼Œæˆ‘ä»¬å°†å®ƒåˆ†æˆ5ä¸ªèŠ‚ç‚¹ï¼Œå¦‚ä¸‹å›¾\n\n> å¦‚æœä½ çš„æœºå™¨èµ„æºç´§å¼ ï¼Œè¯·ä½¿ç”¨å…¬æœ‰äº‘ç‰ˆï¼š[ç¬¬äºŒç« â€”â€”ä¼ä¸šéƒ¨ç½²å®æˆ˜_K8Sã€å…¬æœ‰äº‘ç‰ˆã€‘](https://github.com/ben1234560/k8s_PaaS/blob/master/%E7%AC%AC%E4%BA%8C%E7%AB%A0%E2%80%94%E2%80%94%E4%BC%81%E4%B8%9A%E9%83%A8%E7%BD%B2%E5%AE%9E%E6%88%98_K8S%E3%80%90%E5%85%AC%E6%9C%89%E4%BA%91%E7%89%88%E3%80%91.md)\n\n|      | æ•´ä½“  | 11æœºå™¨ | 12æœºå™¨ | 21æœºå™¨ | 22æœºå™¨ | 200æœºå™¨ |\n| ---- | ----- | ------ | ------ | ------ | ------ | ------- |\n| ä½é… | 4C32G | 2C2G   | 2C2G   | 2C8G   | 2C8G   | 2C2G    |\n| æ ‡é… | 8C64G | 2C4G   | 2C4G   | 2C16G  | 2C16G  | 2C2G    |\n\n> å¦‚æœä½ çš„ç”µè„‘æ˜¯4C16Gçš„ï¼ˆä¸€èˆ¬ç¬”è®°æœ¬éƒ½æœ‰çš„ï¼‰ï¼Œä½ å¯ä»¥å…ˆç”¨ä½ çš„ç”µè„‘å°è¯•åšè¿™ä¸ªPaaSæœåŠ¡ï¼Œåšåˆ°Jenkinsçš„æ—¶å€™å°±å·²ç»å¾ˆå¡äº†ï¼Œåˆ°æ—¶å€™ä½ å†ä¹°æœåŠ¡å™¨ä¹Ÿæ¯”è¾ƒçœé’±ï¼Œå‰æœŸæˆ‘è¿˜æ˜¯å¸Œæœ›å„ä½èƒ½åœ¨ç†è§£ä¸ŠèŠ±äº›æ—¶é—´ï¼Œæ…¢æ…¢çš„æ“ä½œï¼Œå¦åˆ™æŠ¥é”™éƒ½ä¸çŸ¥é“æ€ä¹ˆè§£å†³\n\nå…³äºæ€ä¹ˆåˆ¶ä½œè™šæ‹Ÿæœºå¹¶è¿æ¥NATç½‘å¹¶è¿æ¥shell\n\nè®¾ç½®NATï¼ˆè¿™æ ·æ‰å¯ä»¥ç›´æ¥åœ¨ç”µè„‘æµè§ˆå™¨è®¿é—®åˆ°ï¼‰ï¼Œå¦‚å›¾ï¼š\n\n![1578637492550](assets/1578637492550.png)\n\n![1578637749475](assets/1578637749475.png)\n\nä½¿ç”¨æˆ‘çš„é•œåƒåŒ…æˆ–è€…ä»»æ„7.6ä»¥ä¸Šç‰ˆæœ¬çš„centosï¼ˆè¿™ä¸ªå·¥å…·æ˜¯VMware Workstation Proï¼‰\n\n> 7.6é•œåƒç½‘ä¸Šèµ„æºå°‘ï¼Œè¿™é‡Œæä¾›ä¸€ä¸ªï¼šhttps://pan.baidu.com/s/1mkIzua1XQmew240XBbvuFA æå–ç ï¼š7p6h ã€‚æ³¨æ„ï¼šé•œåƒåŒ…çš„networkæ˜¯ens33ï¼Œæˆ‘ç”¨çš„æ˜¯eth0ï¼Œä¸‹é¢ä½ å°±çŸ¥é“åœ¨å“ªç”¨äº†ï¼Œä½ ä¹Ÿå¯ä»¥æ”¹æˆè·Ÿæˆ‘ä¸€æ ·ï¼Œè¿™æ˜¯ç™¾åº¦ç»éªŒhttps://jingyan.baidu.com/article/17bd8e524c76a285ab2bb8ff.html\n\n> virtualbox ä¹Ÿæ˜¯å¯ä»¥çš„, ç½‘ç»œæ¨¡å¼ä¸ä»…ä»…é™äºnat, æœ¬äººè¯•è¿‡æ¡¥æ¥æ¨¡å¼, ä¹Ÿæ˜¯å¯ä»¥çš„, å¹¶ä¸”å®¿ä¸»æœºå¯ä»¥æŠŠDNSæŒ‡å®šä¸ºè‡ªå·±çš„è™šæ‹Ÿæœº11åœ°å€,è¿™æ ·åœ¨å®¿ä¸»æœºè®¿é—®harborçš„æ—¶å€™å°±ä¸ç”¨å†™hostsæ–‡ä»¶äº†\n\n![1583025768982](assets/1583025768982.png)\n\n![1578645849482](assets/1578645849482.png)\n\n![1582876384254](assets/1582876384254.png)\n\nä½ç½®è‡ªå·±å­˜æ”¾åœ¨ä¸€ä¸ªæ¯”è¾ƒå¤§çš„ä½ç½®ï¼Œæˆ‘æ˜¯æ”¾åœ¨äº†Gç›˜\n\n![1578645877869](assets/1578645877869.png)\n\n![1578645884437](assets/1578645884437.png)\n\n![1578645890203](assets/1578645890203.png)\n\nè¿æ¥è¿›å»åï¼Œåˆ°Linuxå®‰è£…é¡µé¢ï¼ˆå¯ä»¥æŸ¥ç½‘ä¸Šçš„ï¼‰ï¼Œå®‰è£…minimalè®¾ç½®å¥½rootå³å¯ã€‚\n\nç„¶åå†æ‰“å¼€ï¼Œæ­¤æ—¶pingæ˜¯pingä¸é€šçš„ï¼Œä¸éœ€è¦ç®¡\n\nå³é”®æ¨¡æ¿æœº->ç®¡ç†->å…‹éš†->ä¸‹ä¸€æ­¥->ä¸‹ä¸€æ­¥ï¼ˆè™šæ‹Ÿæœºå½“å‰çŠ¶æ€ï¼‰->ä¸‹ä¸€æ­¥ï¼ˆåˆ›å»ºé“¾æ¥å…‹éš†ï¼‰ä¸‹ä¸€æ­¥->å®Œæˆï¼ˆæ”¹å¥½ï¼‰\n\n![1580368269935](assets/1580368269935.png)\n\nå¼€å¯æ­¤è™šæ‹Ÿæœºï¼Œæˆ‘åˆ›å»ºäº†5å°æœºå™¨äº†ï¼ˆç”¨çš„è‡ªå·±ç”µè„‘4C16Gï¼‰\n\n![1578638975964](assets/1578638975964.png)\n\n![1578814673242](assets/1578814673242.png)\n\n~~~\n# å…¨éƒ¨æœºå™¨ï¼Œè®¾ç½®åå­—ï¼Œ11æ˜¯hdss7-11,12æ˜¯hdss7-12,ä»¥æ­¤ç±»æ¨\n~]# hostnamectl set-hostname hdss7-11.host.com\n~]# exit\n# ä¸‹é¢çš„ä¿®æ”¹ï¼Œ11æœºå™¨å¯¹åº”11ï¼Œ12å¯¹åº”12ï¼Œä»¥æ­¤ç±»æ¨\n~]# vi /etc/sysconfig/network-scripts/ifcfg-eth0\n...ä¿®æ”¹å¦‚ä¸‹å›¾\n\n~]# systemctl restart network\n~]# ping baidu.com\n~~~\n\n> **ifcfg-eth0**ï¼šæœ‰äº›äººçš„æœºå™¨å¯èƒ½æ˜¯ifcfg-esn33ï¼Œè‡ªå·±æ³¨æ„å³å¯\n>\n> **systemctl restart**ï¼šé‡å¯æŸä¸ªæœåŠ¡\n>\n> **ping**ï¼šç”¨äºæµ‹è¯•ç½‘ç»œè¿æ¥é‡çš„ç¨‹åº\n\n![1580370529295](assets/1580370529295.png)\n\n![1578648756641](assets/1578648756641.png)\n\nä¹Ÿæœ‰è¿™ç§çš„ã€‚ï¼ˆè´¡çŒ®è€…ï¼š<https://github.com/d00522>ï¼‰DNS é…ç½®æˆ254ä¸è¡Œå°±é‡å¯æœºå™¨ï¼Œ é…æˆ8.8.8.8æˆ–114.114.114.114ã€‚\n\n![1582957189687](assets/1582957189687.png)\n\nç„¶ååœ¨xshellè®¿é—®idå³å¯ï¼Œå¦‚å›¾\n\n[xshellä¸‹è½½](https://xshell.en.softonic.com/download)\n\n> å½“ç„¶æˆ‘ä¹Ÿæœ‰æä¾›è½¯ä»¶åŒ…ï¼šhttps://pan.baidu.com/s/1mkIzua1XQmew240XBbvuFA æå–ç ï¼š7p6h ã€‚é‡Œé¢è¿˜æœ‰Xftpï¼Œæ˜¯ç”¨æ¥è¿›è¡Œæœ¬åœ°ç”µè„‘å’Œè™šæ‹Ÿæœºçš„æ–‡ä»¶ä¼ è¾“\n\n![1578655333674](assets/1578655333674.png)\n\n~~~\n# æŸ¥çœ‹enforceæ˜¯å¦å…³é—­ï¼Œç¡®ä¿disabledçŠ¶æ€ï¼Œå½“ç„¶å¯èƒ½æ²¡æœ‰è¿™ä¸ªå‘½ä»¤\n~]# getenforce\n# å¦‚æœä¸ä¸ºdisabledï¼Œéœ€è¦vim /etc/selinux/configï¼Œå°†SELINUX=åæ”¹ä¸ºdisabledåé‡å¯å³å¯\n# æŸ¥çœ‹å†…æ ¸ç‰ˆæœ¬ï¼Œç¡®ä¿åœ¨3.8ä»¥ä¸Šç‰ˆæœ¬\n~]# uname -a\n# å…³é—­å¹¶ç¦æ­¢firewalldè‡ªå¯\n~]# systemctl stop firewalld\n~]# systemctl disable firewalld\n# å®‰è£…epelæºåŠç›¸å…³å·¥å…·\n~]# yum install epel-release -y\n~]# yum install wget net-tools telnet tree nmap sysstat lrzsz dos2unix bind-utils -y\n~~~\n\n> **uname**:æ˜¾ç¤ºç³»ç»Ÿä¿¡æ¯\n>\n> - **-a/-all**ï¼šæ˜¾ç¤ºå…¨éƒ¨\n>\n> **yum**ï¼šæä¾›äº†æŸ¥æ‰¾ã€å®‰è£…ã€åˆ é™¤æŸä¸€ä¸ªã€ä¸€ç»„ç”šè‡³å…¨éƒ¨è½¯ä»¶åŒ…çš„å‘½ä»¤\n>\n> - **install**ï¼šå®‰è£…\n> - **-y**ï¼šå½“å®‰è£…è¿‡ç¨‹æç¤ºé€‰æ‹©å…¨éƒ¨ä¸º\"yes\"\n\n\n\n### K8Så‰ç½®å‡†å¤‡å·¥ä½œâ€”â€”bind9å®‰è£…éƒ¨ç½²ï¼ˆDNSæœåŠ¡ï¼‰\n\n> **WHAT**ï¼šDNSï¼ˆåŸŸåç³»ç»Ÿï¼‰è¯´ç™½äº†ï¼Œå°±æ˜¯æŠŠä¸€ä¸ªåŸŸå’ŒIPåœ°å€åšäº†ä¸€ä¸‹ç»‘å®šï¼Œå¦‚ä½ åœ¨é‡Œæœºå™¨é‡Œé¢è¾“å…¥ nslookup www.qq.comï¼Œå‡ºæ¥çš„Addressæ˜¯ä¸€å †IPï¼ŒIPæ˜¯ä¸å®¹æ˜“è®°çš„ï¼Œæ‰€ä»¥DNSè®©IPå’ŒåŸŸååšä¸€ä¸‹ç»‘å®šï¼Œè¿™æ ·ä½ è¾“å…¥åŸŸåå°±å¯ä»¥äº†\n>\n> **WHY**ï¼šæˆ‘ä»¬è¦ç”¨ingressï¼Œåœ¨K8Sé‡Œè¦åš7å±‚è°ƒåº¦ï¼Œè€Œä¸”æ— è®ºå¦‚ä½•éƒ½è¦ç”¨åŸŸåï¼ˆå¦‚ä¹‹å‰çš„é‚£ä¸ªç™¾åº¦é¡µé¢çš„åŸŸåï¼Œé‚£ä¸ªæ˜¯hostçš„æ–¹å¼ï¼‰ï¼Œä½†æ˜¯é—®é¢˜æ˜¯æˆ‘ä»¬æ€ä¹ˆç»™K8Sé‡Œçš„å®¹å™¨ç»‘hostï¼Œæ‰€ä»¥æˆ‘ä»¬å¿…é¡»åšä¸€ä¸ªDNSï¼Œç„¶åå®¹å™¨æœä»æˆ‘ä»¬çš„DNSè§£æè°ƒåº¦\n\n~~~\n# åœ¨11æœºå™¨ï¼š\n~]# yum install bind -y\n~]# rpm -qa bind\n# out: bind-9.11.4-9.P2.el7.x86_64\n# é…ç½®ä¸»é…ç½®æ–‡ä»¶ï¼Œ11æœºå™¨\n~]# vi /etc/named.conf\nlisten-on port 53 { 10.4.7.11; };  # åŸæœ¬æ˜¯127.0.0.1\n# listen-on-v6 port 53 { ::1; };  # éœ€è¦åˆ æ‰\nallow-query     { any; };  # åŸæœ¬æ˜¯locall\nforwarders      { 10.4.7.254; };  #å¦å¤–æ·»åŠ çš„\ndnssec-enable no;  # åŸæœ¬æ˜¯yes\ndnssec-validation no;  # åŸæœ¬æ˜¯yes\n\n# æ£€æŸ¥ä¿®æ”¹æƒ…å†µï¼Œæ²¡æœ‰æŠ¥é”™å³å¯ï¼ˆå³æ²¡æœ‰ä¿¡æ¯ï¼‰\n~]# named-checkconf\n~~~\n\n> **rpm**ï¼šè½¯ä»¶åŒ…ç®¡ç†å™¨\n>\n> - **-qa**ï¼šæŸ¥çœ‹å·²å®‰è£…çš„æ‰€æœ‰è½¯ä»¶åŒ…\n>\n> **rpmå’Œyumå®‰è£…çš„åŒºåˆ«**ï¼šå‰è€…ä¸æ£€æŸ¥ç›¸ä¾æ€§é—®é¢˜ï¼Œåè€…æ£€æŸ¥ï¼ˆå³ç›¸å…³ä¾èµ–åŒ…ï¼‰\n>\n> **named.confæ–‡ä»¶å†…å®¹è§£æï¼š**\n>\n> - **listen-on**ï¼šç›‘å¬ç«¯å£ï¼Œæ”¹ä¸ºç›‘å¬åœ¨å†…ç½‘ï¼Œè¿™æ ·å…¶å®ƒæœºå™¨ä¹Ÿå¯ä»¥ç”¨\n> - **allow-query**ï¼šå“ªäº›å®¢æˆ·ç«¯èƒ½é€šè¿‡è‡ªå»ºçš„DNSæŸ¥\n> - **forwarders**ï¼šä¸Šçº§DNSæ˜¯ä»€ä¹ˆ\n\n![1580372858987](assets/1580372858987.png)\n\n~~~\n# 11æœºå™¨ï¼Œç»éªŒï¼šä¸»æœºåŸŸä¸€å®šå¾—è·Ÿä¸šåŠ¡æ˜¯ä¸€ç‚¹å…³ç³»éƒ½æ²¡æœ‰ï¼Œå¦‚host.comï¼Œè€Œä¸šåŠ¡ç”¨çš„æ˜¯od.comï¼Œå› ä¸ºä¸šåŠ¡éšæ—¶å¯èƒ½å˜\n# åŒºåŸŸé…ç½®æ–‡ä»¶ï¼ŒåŠ åœ¨æœ€ä¸‹é¢\n~]# vi /etc/named.rfc1912.zones\nzone \"host.com\" IN {\n        type  master;\n        file  \"host.com.zone\";\n        allow-update { 10.4.7.11; };\n};\n\nzone \"od.com\" IN {\n        type  master;\n        file  \"od.com.zone\";\n        allow-update { 10.4.7.11; };\n};\n\n~~~\n\n![1578818520796](assets/1578818520796.png)\n\n~~~\n# 11æœºå™¨ï¼š\n# æ³¨æ„serialè¡Œçš„æ—¶é—´ï¼Œä»£è¡¨ä»Šå¤©çš„æ—¶é—´+ç¬¬ä¸€æ¡è®°å½•ï¼š20200112+01\n7-11 ~]# vi /var/named/host.com.zone\n$ORIGIN host.com.\n$TTL 600\t; 10 minutes\n@       IN SOA\tdns.host.com. dnsadmin.host.com. (\n\t\t\t\t2020011201 ; serial\n\t\t\t\t10800      ; refresh (3 hours)\n\t\t\t\t900        ; retry (15 minutes)\n\t\t\t\t604800     ; expire (1 week)\n\t\t\t\t86400      ; minimum (1 day)\n\t\t\t\t)\n\t\t\tNS   dns.host.com.\n$TTL 60\t; 1 minute\ndns                A    10.4.7.11\nHDSS7-11           A    10.4.7.11\nHDSS7-12           A    10.4.7.12\nHDSS7-21           A    10.4.7.21\nHDSS7-22           A    10.4.7.22\nHDSS7-200          A    10.4.7.200\n\n7-11 ~]# vi /var/named/od.com.zone\n$ORIGIN od.com.\n$TTL 600\t; 10 minutes\n@   \t\tIN SOA\tdns.od.com. dnsadmin.od.com. (\n\t\t\t\t2020011201 ; serial\n\t\t\t\t10800      ; refresh (3 hours)\n\t\t\t\t900        ; retry (15 minutes)\n\t\t\t\t604800     ; expire (1 week)\n\t\t\t\t86400      ; minimum (1 day)\n\t\t\t\t)\n\t\t\t\tNS   dns.od.com.\n$TTL 60\t; 1 minute\ndns                A    10.4.7.11\n\n# çœ‹ä¸€ä¸‹æœ‰æ²¡æœ‰æŠ¥é”™\n7-11 ~]# named-checkconf\n7-11 ~]# systemctl start named\n7-11 ~]# systemctl enable named\n7-11 ~]# netstat -luntp|grep 53\n~~~\n\n> **TTL 600**ï¼šæŒ‡å®šIPåŒ…è¢«è·¯ç”±å™¨ä¸¢å¼ƒä¹‹å‰å…è®¸é€šè¿‡çš„æœ€å¤§ç½‘æ®µæ•°é‡\n>\n> - **10 minutes**ï¼šè¿‡æœŸæ—¶é—´10åˆ†é’Ÿ\n>\n> **SOA**ï¼šä¸€ä¸ªåŸŸæƒå¨è®°å½•çš„ç›¸å…³ä¿¡æ¯ï¼Œåé¢æœ‰5ç»„å‚æ•°åˆ†åˆ«è®¾å®šäº†è¯¥åŸŸç›¸å…³éƒ¨åˆ†\n>\n> - **dnsadmin.od.com.**  ä¸€ä¸ªå‡çš„é‚®ç®±\n> - **serial**ï¼šè®°å½•çš„æ—¶é—´\n>\n> **$ORIGIN**ï¼šå³ä¸‹åˆ—çš„åŸŸåè‡ªåŠ¨è¡¥å……od.comï¼Œå¦‚dnsï¼Œå¤–é¢çœ‹æ¥æ˜¯dns.od.com\n>\n> **netstat -luntp**ï¼šæ˜¾ç¤º tcp,udp çš„ç«¯å£å’Œè¿›ç¨‹ç­‰ç›¸å…³æƒ…å†µ\n\n![1578819148759](assets/1578819148759.png)\n\n~~~\n# 11æœºå™¨ï¼Œæ£€æŸ¥ä¸»æœºåŸŸæ˜¯å¦è§£æ\n7-11 ~]# dig -t A hdss7-21.host.com @10.4.7.11 +short\n# é…ç½®linuxå®¢æˆ·ç«¯å’Œwinå®¢æˆ·ç«¯éƒ½èƒ½ä½¿ç”¨è¿™ä¸ªæœåŠ¡ï¼Œä¿®æ”¹\n7-11 ~]# vi /etc/sysconfig/network-scripts/ifcfg-eth0\nDNS1=10.4.7.11\n7-11 ~]# systemctl restart network\n7-11 ~]# ping www.baidu.com\n7-11 ~]# ping hdss7-21.host.com\n~~~\n\n> **dig -t A**ï¼šæŒ‡çš„æ˜¯æ‰¾DNSé‡Œæ ‡è®°ä¸ºAçš„ç›¸å…³è®°å½•ï¼Œè€Œåé¢ä¼šå¸¦ä¸Šç›¸å…³çš„åŸŸï¼Œå¦‚ä¸Šé¢çš„hdss7-21.host.comï¼Œä¸ºä»€ä¹ˆå¤–é¢é…äº†HDSS7-21åé¢è¿˜ä¼šè‡ªåŠ¨æ¥ä¸Š.host.comå°±æ˜¯å› ä¸º$ORIGINï¼Œåé¢åˆ™æ˜¯å¯¹åº”çš„IP\n>\n> - **+short**ï¼šè¡¨ç¤ºåªè¿”å›IP\n\n![1578819653445](assets/1578819653445.png)\n\n~~~\n# åœ¨æ‰€æœ‰æœºå™¨æ·»åŠ search... ï¼Œå³å¯ä½¿ç”¨çŸ­åŸŸåï¼ˆæˆ‘çš„æ˜¯è‡ªå¸¦çš„ï¼‰\n~]# vi /etc/resolv.conf\n~]# ping hdss7-200\n~~~\n\n![1578820746390](assets/1578820746390.png)\n\n~~~\n# åœ¨é11æœºå™¨ä¸Šï¼Œå…¨éƒ¨æ”¹æˆ11\n~]# vi /etc/sysconfig/network-scripts/ifcfg-eth0\nDNS1=10.4.7.11\n\n~]# systemctl restart network\n# è¯•ä¸‹ç½‘ç»œæ˜¯å¦æ­£å¸¸\n~]# ping baidu.com\n# å…¶å®ƒæœºå™¨å°è¯•ping7-11æœºå™¨\n7-12 ~]# ping hdss7-11.host.com\n~~~\n\n> è®©å…¶å®ƒæœºå™¨çš„DNSå…¨éƒ¨æ”¹æˆ11æœºå™¨çš„å¥½å¤„æ˜¯ï¼Œå…¨éƒ¨çš„æœºå™¨è®¿é—®å¤–ç½‘å°±åªæœ‰é€šè¿‡11ç«¯å£ï¼Œæ›´å¥½æ§åˆ¶\n\n![1578820642420](assets/1578820642420.png)\n\n~~~\n# ä¿®æ”¹windowç½‘ç»œï¼Œå¹¶ping\n~~~\n\n![1578821485560](assets/1578821485560.png)\n\n![1578821522239](assets/1578821522239.png)\n\n~~~\n# pingä¸äº†çš„ï¼Œä¿®æ”¹ä»¥ä¸‹é…ç½®\n~~~\n\n![1578821813984](assets/1578821813984.png)\n\nå®Œæˆ\n\n\n\n### K8Så‰ç½®å·¥ä½œâ€”â€”å‡†å¤‡ç­¾å‘è¯ä¹¦ç¯å¢ƒ\n\n> **WHAT**ï¼š è¯ä¹¦ï¼Œå¯ä»¥ç”¨æ¥å®¡è®¡ä¹Ÿå¯ä»¥ä¿éšœå®‰å…¨ï¼Œk8Sç»„ä»¶å¯åŠ¨çš„æ—¶å€™ï¼Œåˆ™éœ€è¦æœ‰å¯¹åº”çš„è¯ä¹¦ï¼Œè¯ä¹¦çš„è¯¦è§£ä½ ä¹Ÿå¯ä»¥åœ¨ç½‘ä¸Šæœåˆ°ï¼Œè¿™é‡Œå°±ä¸ç»†ç»†è¯´æ˜äº†\n>\n> **WHY**ï¼šå½“ç„¶æ˜¯ä¸ºäº†è®©æˆ‘ä»¬çš„ç»„ä»¶èƒ½æ­£å¸¸è¿è¡Œ\n\n~~~\n# cfsslæ–¹å¼åšè¯ä¹¦ï¼Œéœ€è¦ä¸‰ä¸ªè½¯ä»¶ï¼ŒæŒ‰ç…§æˆ‘ä»¬çš„æ¶æ„å›¾ï¼Œæˆ‘ä»¬éƒ¨ç½²åœ¨200æœºå™¨:\n200 ~]# wget https://pkg.cfssl.org/R1.2/cfssl_linux-amd64 -O /usr/bin/cfssl\n200 ~]# wget https://pkg.cfssl.org/R1.2/cfssljson_linux-amd64 -O /usr/bin/cfssl-json\n200 ~]# wget https://pkg.cfssl.org/R1.2/cfssl-certinfo_linux-amd64 -O /usr/bin/cfssl-certinfo\n200 ~]# chmod +x /usr/bin/cfssl*\n200 ~]# which cfssl\n200 ~]# which cfssl-json\n200 ~]# which cfssl-certinfo\n~~~\n\n> **wget**ï¼šä»ç½‘ç»œä¸Šè‡ªåŠ¨ä¸‹è½½æ–‡ä»¶çš„è‡ªç”±å·¥å…·\n>\n> **chmod**ï¼šç»™å¯¹åº”çš„æ–‡ä»¶æ·»åŠ æƒé™ï¼ˆ[èœé¸Ÿæ•™ç¨‹](https://www.runoob.com/linux/linux-comm-chmod.html)ï¼‰\n>\n> - **+x**ï¼šç»™å½“å‰ç”¨æˆ·å¢åŠ å¯æ‰§è¡Œè¯¥æ–‡ä»¶çš„æƒé™\n>\n> **which**ï¼šæŸ¥çœ‹ç›¸åº”çš„ä¸œè¥¿åœ¨å“ªé‡Œ\n\n![1578822242531](assets/1578822242531.png)\n\n~~~\n200 ~]# cd /opt/\nopt]# mkdir certs\nopt]# cd certs/\ncerts]# vi ca-csr.json\n{\n    \"CN\": \"ben123123\",\n    \"hosts\": [\n    ],\n    \"key\": {\n        \"algo\": \"rsa\",\n        \"size\": 2048\n    },\n    \"names\": [\n        {\n            \"C\": \"CN\",\n            \"ST\": \"beijing\",\n            \"L\": \"beijing\",\n            \"O\": \"od\",\n            \"OU\": \"ops\"\n        }\n    ],\n    \"ca\": {\n        \"expiry\": \"1752000h\"\n    }\n}\ncerts]# cfssl gencert -initca ca-csr.json | cfssl-json -bare ca\ncerts]# cat ca.pem\n# å¦‚æœä½ è¿™æ—¶å€™æ˜¾ç¤ºæ®µé”™è¯¯æˆ–è€…jsoné”™è¯¯ï¼Œå°±æ˜¯ä¹‹å‰å…‹éš†è™šæ‹Ÿæœºçš„æ—¶å€™200æœºå™¨åœ°å€å’Œåˆ«çš„æœºå™¨åœ°å€é‡å å†²çªäº†ï¼Œéœ€è¦é‡å»º200è™šæ‹Ÿæœº\n~~~\n\n> **cd **ï¼šåˆ‡æ¢å½“å‰å·¥ä½œç›®å½•åˆ° dirName\n>\n> - è¯­æ³•ï¼šcd [dirName]\n>\n> **mkdir**ï¼šå»ºç«‹åç§°ä¸º dirName ä¹‹å­ç›®å½•\n>\n> - è¯­æ³•ï¼šmkdir [-p] dirName\n> - **-p:** ç¡®ä¿ç›®å½•å­˜åœ¨ï¼Œä¸å­˜åœ¨åˆ™å»ºä¸€ä¸ªï¼Œå¦‚mkdir empty/empty1/empty2\n>\n> **cfssl**ï¼šè¯ä¹¦å·¥å…·\n>\n> - gencertï¼šç”Ÿæˆçš„æ„æ€\n>\n> **ca-csr.jsonè§£æï¼š**\n>\n> - CNï¼šCommon Nameï¼Œæµè§ˆå™¨ä½¿ç”¨è¯¥å­—æ®µéªŒè¯ç½‘å€æ˜¯å¦åˆæ³•ï¼Œä¸€èˆ¬å†™åŸŸåï¼Œéå¸¸é‡è¦\n> - STï¼šStateï¼Œçœ\n> - Lï¼šLocalityï¼Œåœ°åŒº\n> - Oï¼šOrganization Nameï¼Œç»„ç»‡åç§°\n> - OUï¼šOrganization Unit Nameï¼Œç»„ç»‡å•ä½åç§°\n>\n> <a href=\"https://github.com/ben1234560/k8s_PaaS/blob/master/%E5%8E%9F%E7%90%86%E5%8F%8A%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/Kubernetes%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5.md#pod%E4%B8%AD%E5%87%A0%E4%B8%AA%E9%87%8D%E8%A6%81%E5%AD%97%E6%AE%B5%E7%9A%84%E5%90%AB%E4%B9%89%E5%92%8C%E7%94%A8%E6%B3%95\">Podä¸­å‡ ä¸ªé‡è¦å­—æ®µçš„å«ä¹‰å’Œç”¨æ³•</a>\n\n![1578822598528](assets/1578822598528.png)\n\n\n\n### K8Så‰ç½®å·¥ä½œâ€”â€”éƒ¨ç½²dockerç¯å¢ƒ\n\n> **WHAT**ï¼šæ˜¯ä¸€ä¸ªå¼€æºçš„åº”ç”¨å®¹å™¨å¼•æ“ï¼Œè®©å¼€å‘è€…å¯ä»¥æ‰“åŒ…ä»–ä»¬çš„åº”ç”¨ä»¥åŠä¾èµ–åŒ…åˆ°ä¸€ä¸ªå¯ç§»æ¤çš„é•œåƒä¸­ï¼Œç„¶åå‘å¸ƒåˆ°ä»»ä½•æµè¡Œçš„ Linuxæˆ–Windows æœºå™¨ä¸Šï¼Œä¹Ÿå¯ä»¥å®ç°è™šæ‹ŸåŒ–ã€‚\n>\n> **WHY**ï¼šPodé‡Œé¢å°±æ˜¯ç”±æ•°ä¸ªdockerå®¹å™¨ç»„æˆï¼ŒPodæ˜¯è±Œè±†èšï¼Œdockerå®¹å™¨æ˜¯é‡Œé¢çš„è±†å­ã€‚\n\n~~~\n# å¦‚æˆ‘ä»¬æ¶æ„å›¾æ‰€ç¤ºï¼Œè¿ç®—èŠ‚ç‚¹æ˜¯21/22æœºå™¨ï¼ˆæ²¡æœ‰dockeråˆ™æ— æ³•è¿è¡Œpodï¼‰ï¼Œè¿ç»´ä¸»æœºæ˜¯200æœºå™¨ï¼ˆæ²¡æœ‰dockeråˆ™æ²¡åŠæ³•ä¸‹è½½dockerå­˜å…¥ç§æœ‰ä»“åº“ï¼‰ï¼Œæ‰€ä»¥åœ¨ä¸‰å°æœºå™¨å®‰è£…ï¼ˆ21/22/200ï¼‰\n~]# curl -fsSL https://get.docker.com | bash -s docker --mirror Aliyun\n# ä¸Šé¢çš„ä¸‹è½½å¯èƒ½ç½‘ç»œæœ‰é—®é¢˜ï¼Œéœ€è¦å¤šè¯•å‡ æ¬¡ï¼Œè¿™äº›éƒ¨ç½²æˆ‘å·²ç»ä¸åŒæœºå™¨è¯•è¿‡å¾ˆå¤šæ¬¡äº†\n~]# mkdir -p /data/docker /etc/docker\n# # æ³¨æ„ï¼Œ172.7.21.1ï¼Œè¿™é‡Œå¾—21æ˜¯æŒ‡åœ¨hdss7-21å¾—æœºå™¨ï¼Œå¦‚æœæ˜¯22å¾—æœºå™¨ï¼Œå°±æ˜¯172.7.22.1ï¼Œå…±ä¸€å¤„éœ€è¦æ”¹æœºå™¨åï¼š\"bip\": \"172.7.21.1/24\"\n~]# vi /etc/docker/daemon.json\n{\n  \"data-root\": \"/data/docker\",\n  \"storage-driver\": \"overlay2\",\n  \"insecure-registries\": [\"registry.access.redhat.com\",\"quay.io\",\"harbor.od.com\"],\n  \"registry-mirrors\": [\"https://q2gr04ke.mirror.aliyuncs.com\"],\n  \"bip\": \"172.7.21.1/24\",\n  \"exec-opts\": [\"native.cgroupdriver=systemd\"],\n  \"live-restore\": true\n}\n\n~]# systemctl start docker\n~]# docker version\n~]# docker ps -a\n~~~\n\n> **mkdir -pï¼š**å‰é¢æœ‰è®²åˆ°è¿‡ï¼ˆä¸Šä¸€çº§ç›®å½•æ²¡æœ‰åˆ™åˆ›å»ºï¼‰ï¼Œè€Œè¿™æ¬¡åé¢å¸¦äº†ä¸¤ä¸ªç›®å½•ï¼Œæ„æ€æ˜¯åŒæ—¶åˆ›å»ºä¸¤ä¸ªç›®å½•\n>\n> **daemon.jsonï¼š**ä¸ºä»€ä¹ˆé…aliyuncsçš„ç¯å¢ƒï¼Œæ˜¯å› ä¸ºé»˜è®¤æ˜¯è¿æ¥åˆ°å¤–ç½‘çš„ï¼Œé€Ÿåº¦æ¯”è¾ƒæ…¢ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥ç›´æ¥ä½¿ç”¨å›½å†…çš„é˜¿é‡Œäº‘é•œåƒæºï¼Œå½“ç„¶è¿˜æœ‰è…¾è®¯äº‘ç­‰\n>\n> **docker versionï¼š**æŸ¥çœ‹dockerçš„ç‰ˆæœ¬\n>\n> **daemon.jsonè§£æï¼š**é‡ç‚¹è¯´ä¸€ä¸‹è¿™ä¸ªä¸ºä»€ä¹ˆ10.4.7.21æœºå™¨å¯¹åº”ç€172.7.21.1/24ï¼Œè¿™é‡Œå¯ä»¥çœ‹åˆ°10çš„21å¯¹åº”å¾—æ˜¯172çš„21ï¼Œè¿™æ ·åšçš„å¥½å¤„å°±æ˜¯ï¼Œå½“ä½ çš„podå‡ºç°é—®é¢˜æ—¶ï¼Œä½ å¯ä»¥é©¬ä¸Šå®šä½åˆ°æ˜¯åœ¨å“ªå°æœºå™¨å‡ºç°çš„é—®é¢˜ï¼Œæ˜¯21è¿˜æ˜¯22è¿˜æ˜¯å…¶å®ƒçš„ï¼Œè¿™ç‚¹åœ¨ç”Ÿäº§ä¸Šéå¸¸é‡è¦ï¼Œæœ‰æ—¶å€™ä½ çš„dashboardï¼ˆåé¢ä¼šå®‰è£…ï¼‰å®•æ‰äº†ï¼Œä½ æ²¡åŠæ³•åªèƒ½å»æœºå™¨æ‰¾ï¼Œè€Œè¿™æ—¶å€™ä½ åˆæ‰¾ä¸åˆ°çš„æ—¶å€™ï¼Œä½ è€æ¿ä¼šæ‹¿ä½ ç¥­å¤©çš„\n\n![1578826534378](assets/1578826534378.png)\n\n\n\n### K8Så‰ç½®å·¥ä½œâ€”â€”éƒ¨ç½²harborä»“åº“\n\n> **WHAT **ï¼šharborä»“åº“æ˜¯å¯ä»¥éƒ¨ç½²åˆ°æœ¬åœ°çš„ç§æœ‰ä»“åº“ï¼Œä¹Ÿå°±æ˜¯ä½ å¯ä»¥æŠŠé•œåƒæ¨åˆ°è¿™ä¸ªä»“åº“ï¼Œç„¶åéœ€è¦ç”¨çš„æ—¶å€™å†ä¸‹è½½ä¸‹æ¥ï¼Œè¿™æ ·çš„å¥½å¤„æ˜¯ï¼š1ã€ä¸‹è½½é€Ÿåº¦å¿«ï¼Œç”¨åˆ°çš„æ—¶å€™èƒ½é©¬ä¸Šä¸‹è½½ä¸‹æ¥2ã€ä¸ç”¨æ‹…å¿ƒé•œåƒæ”¹åŠ¨æˆ–è€…ä¸‹æ¶ç­‰ã€‚\n>\n> **WHY**ï¼šå› ä¸ºæˆ‘ä»¬çš„éƒ¨ç½²K8Sæ¶‰åŠåˆ°å¾ˆå¤šé•œåƒï¼Œåˆ¶ä½œç›¸å…³åŒ…çš„æ—¶å€™å¦‚æœç½‘é€Ÿé—®é¢˜ä¼šå¯¼è‡´å¤±è´¥é‡æ¥ï¼Œè€Œä¸”æˆ‘ä»¬åœ¨å…¬å¸é‡Œä¹Ÿä¼šå»ºè‡ªå·±çš„ä»“åº“ï¼Œæ‰€ä»¥å¿…é¡»æŒ‰ç…§harborä»“åº“\n\n~~~\n# å¦‚æ¶æ„å›¾ï¼Œæˆ‘ä»¬å®‰è£…åœ¨200æœºå™¨ï¼š\n200 ~]# mkdir /opt/src  && cd /opt/src\n# å¯ä»¥å»è¿™ä¸ªåœ°å€ä¸‹è½½ï¼Œä¹Ÿå¯ä»¥ç›´æ¥ç”¨æˆ‘ç”¨çš„è½¯ä»¶åŒ…\nhttps://github.com/goharbor/harbor/releases/tag/v1.8.3\n200 src]# wget https://storage.googleapis.com/harbor-releases/release-1.8.0/harbor-offline-installer-v1.8.3.tgz\n7-200 src]# tar xf harbor-offline-installer-v1.8.3.tgz -C /opt/\n~~~\n\n> **tag**ï¼šå¯ä»¥åŠ å…¥ï¼Œè§£å¼€å¤‡ä»½æ–‡ä»¶å†…çš„æ–‡ä»¶\n>\n> - **x**ï¼šè§£å‹\n> - **f**ï¼š ä½¿ç”¨æ¡£æ¡ˆåå­—\n> - **-C**ï¼šåˆ‡æ¢åˆ°æŒ‡å®šçš„ç›®å½•\n> - æ•´æ¡å‘½ä»¤åˆèµ·æ¥å°±æ˜¯ï¼ŒæŠŠtgzæ–‡ä»¶ä»¥tgzæ–‡ä»¶åä¸ºåå­—è§£å‹åˆ°optç›®å½•ä¸‹ï¼Œå¹¶ä¿å­˜tgzæ–‡ä»¶åŸæ ·\n>\n> **å…³äºç‰ˆæœ¬**ï¼šä¸€èˆ¬äººéƒ½æ˜¯å–œæ¬¢ç”¨æ¯”è¾ƒæ–°çš„ç‰ˆæœ¬ï¼Œæˆ‘ä»¬å½“ç„¶ä¹Ÿæ”¯æŒæ¯”è¾ƒæ–°çš„ç‰ˆæœ¬ï¼Œä½†å¯¹äºå…¬å¸è€Œå·²ï¼Œç¨³å®šæ˜¯æœ€è¦ç´§çš„ï¼Œv1.8.3æ˜¯ç”¨çš„æ¯”è¾ƒç¨³å®šçš„ç‰ˆæœ¬ï¼Œè€Œåç»­çš„å„ä¸ªç»„ä»¶ä¹Ÿä¼šæœ‰æ›´åŠ æ–°çš„ç‰ˆæœ¬ï¼Œä½ å¯ä»¥å°è¯•æ–°ç‰ˆæœ¬ï¼Œä½†æœ‰äº›ç”±äºå…¼å®¹é—®é¢˜ä¸èƒ½ç”¨æ–°çš„ï¼Œåç»­é‚£äº›ä¸èƒ½ç”¨æˆ‘ä¼šæ ‡è®°æ¸…æ¥šã€‚\n\n~~~\n# 200æœºå™¨ï¼š\n200 src]# cd /opt/\n200 opt]# mv harbor/ harbor-v1.8.3\n200 opt]# ln -s /opt/harbor-v1.8.3/ /opt/harbor\n200 opt]# cd harbor\n200 harbor]# ll\n200 harbor]# vi harbor.yml\nhostname: harbor.od.com  # åŸreg.mydomain.com\nhttp:\n  port: 180  # åŸ80\ndata_volume: /data/harbor\nlocation: /data/harbor/logs\n\n200 harbor]# mkdir -p /data/harbor/logs\n200 harbor]# yum install docker-compose -y\n200 harbor]# rpm -qa docker-compose\n# out: docker-compose-1.18.0-4.el7.noarch\n200 harbor]# ./install.sh\n~~~\n\n> **æç¤º**ï¼šharbor v2.3.3ç‰ˆæœ¬å®‰è£…ä¹Ÿéœ€è¦å°†httpsç›¸å…³çš„é…ç½®æ³¨é‡Šæ‰\n>\n> å¦‚å›¾#https:\n>\n> ![1635775214057](assets/1635775214057.png)\n>\n> æ„Ÿè°¢@https://github.com/xinzhuxiansheng\n>\n> **mv**ï¼šä¸ºæ–‡ä»¶æˆ–ç›®å½•æ”¹åã€æˆ–å°†æ–‡ä»¶æˆ–ç›®å½•ç§»å…¥å…¶å®ƒä½ç½®ã€‚\n>\n> - è¿™é‡Œçš„å‘½ä»¤æ˜¯æœ‰æ–œæ çš„ï¼Œæ‰€ä»¥æ˜¯ç§»åŠ¨åˆ°æŸä¸ªç›®å½•ä¸‹\n>\n> **ln**ï¼šä¸ºæŸä¸€ä¸ªæ–‡ä»¶åœ¨å¦å¤–ä¸€ä¸ªä½ç½®å»ºç«‹ä¸€ä¸ªåŒæ­¥çš„é“¾æ¥\n>\n> - `è¯­æ³•:ln [å‚æ•°][æºæ–‡ä»¶æˆ–ç›®å½•][ç›®æ ‡æ–‡ä»¶æˆ–ç›®å½•]`\n> - `**-sï¼š**è½¯è¿æ¥ï¼Œå¯ä»¥å¯¹æ•´ä¸ªç›®å½•è¿›è¡Œé“¾æ¥`\n>\n> **harbor.ymlè§£æï¼š**\n>\n> - portä¸ºä»€ä¹ˆæ”¹æˆ180ï¼šå› ä¸ºåé¢æˆ‘ä»¬è¦è£…nginxï¼Œnginxç”¨çš„80ï¼Œæ‰€ä»¥è¦æŠŠå®ƒä»¬é”™å¼€\n> - data_volumeï¼šæ•°æ®å·ï¼Œå³dockeré•œåƒæ”¾åœ¨å“ªé‡Œ\n> - locationï¼šæ—¥å¿—æ–‡ä»¶\n> - **./install.sh**ï¼šå¯åŠ¨shellè„šæœ¬\n\n![1578830348081](assets/1578830348081.png)\n\n~~~\n# 200æœºå™¨ï¼š\n200 harbor]# docker-compose ps\n200 harbor]# docker ps -a\n200 harbor]# yum install nginx -y\n\n###ç›¸å…³æŠ¥é”™é—®é¢˜ï¼š\nyumçš„æ—¶å€™æŠ¥ï¼š/var/run/yum.pid å·²è¢«é”å®šï¼ŒPID ä¸º 1610 çš„å¦ä¸€ä¸ªç¨‹åºæ­£åœ¨è¿è¡Œã€‚\nå¦å¤–ä¸€ä¸ªç¨‹åºé”å®šäº† yumï¼›ç­‰å¾…å®ƒé€€å‡ºâ€¦â€¦\nç½‘ä¸Šç»Ÿä¸€çš„è§£å†³åŠæ³•ï¼šç›´æ¥åœ¨ç»ˆç«¯è¿è¡Œ rm -f /var/run/yum.pid å°†è¯¥æ–‡ä»¶åˆ é™¤ï¼Œç„¶åå†æ¬¡è¿è¡Œyumã€‚\n###\n\n200 harbor]# vi /etc/nginx/conf.d/harbor.od.com.conf\nserver {\n    listen       80;\n    server_name  harbor.od.com;\n\n    client_max_body_size 1000m;\n\n    location / {\n        proxy_pass http://127.0.0.1:180;\n    }\n}\n\n200 harbor]# nginx -t\n200 harbor]# systemctl start nginx\n200 harbor]# systemctl enable nginx\n~~~\n\n> **nginx -t**ï¼šæµ‹è¯•*nginx*.confé…ç½®æ–‡ä»¶ä¸­æ˜¯å¦å­˜åœ¨è¯­æ³•é”™è¯¯\n>\n> **systemctl enable nginx**ï¼šå¼€æœºè‡ªåŠ¨å¯åŠ¨\n\n~~~\n# åœ¨11æœºå™¨è§£æåŸŸåï¼š\n~]# vi /var/named/od.com.zone\n# æ³¨æ„serialå‰æ»šä¸€ä¸ªåºå·\n# æœ€ä¸‹é¢æ·»åŠ åŸŸå\nharbor             A    10.4.7.200\n~]# systemctl restart named\n~]# dig -t A harbor.od.com +short\n# out:10.4.7.200\n~~~\n\n![1578830904937](assets/1578830904937.png)\n\n~~~\n# 200æœºå™¨ä¸Šcurlï¼š\nharbor]# curl harbor.od.com\n~~~\n\n> æ³¨æ„ï¼š\n>\n> getenforceå¾—æ˜¯å…³é—­çŠ¶æ€ï¼Œè€Œä¸æ˜¯enforcingï¼Œå¦åˆ™ä¼šæŠ¥502\n> æš‚æ—¶å…³é—­setenforce 0\n> æ°¸ä¹…å…³é—­ï¼Œæ”¹é…ç½®æ–‡ä»¶ vi /etc/selinux/config\n> SELINUX=disabled\n\n![1578831047079](assets/1578831047079.png)\n\n[è®¿é—®harbo.od.com](harbor.od.com)\n\n![1578831134362](assets/1578831134362.png)\n\n~~~\nè´¦å·ï¼šadmin\nå¯†ç ï¼šHarbor12345\næ–°å»ºä¸€ä¸ªpublicå…¬å¼€é¡¹ç›®\n~~~\n\n![1578831458247](assets/1578831458247.png)\n\n~~~\n# 200æœºå™¨ï¼Œå°è¯•ä¸‹æ˜¯å¦èƒ½pushæˆåŠŸåˆ°harborä»“åº“\nharbor]# docker pull nginx:1.7.9\nharbor]# docker images|grep 1.7.9\nharbor]# docker tag 84581e99d807 harbor.od.com/public/nginx:v1.7.9\nharbor]# docker login harbor.od.com\nè´¦å·ï¼šadmin\nå¯†ç ï¼šHarbor12345\nharbor]# docker push harbor.od.com/public/nginx:v1.7.9\n# æŠ¥é”™ï¼šå¦‚æœå‘ç°ç™»å½•ä¸ä¸Šå»äº†ï¼Œè¿‡ä¸€é˜µå­å†ç™»å½•å³å¯ï¼Œå¤§çº¦5åˆ†é’Ÿå·¦å³\n~~~\n\n![1578832524891](assets/1578832524891.png)\n\næˆåŠŸï¼Œæ­¤æ—¶ä½ å·²æˆåŠŸå»ºç«‹äº†è‡ªå·±çš„æœ¬åœ°ç§æœ‰ä»“åº“\n\n\n\n### å®‰è£…éƒ¨ç½²ä¸»æ§èŠ‚ç‚¹æœåŠ¡etcd\n\n> æ³¨æ„, ä¸€å®šè¦åŒæ­¥æ¯ä¸ªè™šæ‹Ÿæœºçš„æ—¶é—´, æ—¶åŒºå’Œæ—¶é—´è¦ä¿æŒä¸€è‡´, å¯ä»¥é€šè¿‡ä»¥ä¸‹çš„å‘½ä»¤æ¥æ“ä½œ, æœ€å¥½æ‰€æœ‰çš„è™šæ‹Ÿæœºéƒ½æ‰§è¡Œä¸€æ¬¡, æœ€å¥½çš„æ–¹æ³•æ˜¯å†™è¿›`/etc/rc.local`ä¸­\n\n  ```bash\n  timedatectl set-timezone Asia/Shanghai\n  timedatectl set-ntp true\n  ```\n\n> **WHAT**ï¼šä¸€ä¸ªé«˜å¯ç”¨å¼ºä¸€è‡´æ€§çš„æœåŠ¡å‘ç°å­˜å‚¨ä»“åº“ï¼Œå…³äºæœåŠ¡å‘ç°ï¼Œå…¶æœ¬è´¨å°±æ˜¯çŸ¥é“äº†é›†ç¾¤ä¸­æ˜¯å¦æœ‰è¿›ç¨‹åœ¨ç›‘å¬udpå’Œtcpç«¯å£ï¼ˆå¦‚ä¸Šé¢éƒ¨ç½²çš„harborå°±æ˜¯ç›‘å¬180ç«¯å£ï¼‰ï¼Œå¹¶ä¸”é€šè¿‡åå­—å°±å¯ä»¥æŸ¥æ‰¾å’Œè¿æ¥ã€‚\n>\n> - **ä¸€ä¸ªå¼ºä¸€è‡´æ€§ã€é«˜å¯ç”¨çš„æœåŠ¡å­˜å‚¨ç›®å½•**ï¼šåŸºäºRaftç®—æ³•çš„etcdå¤©ç”Ÿå°±æ˜¯è¿™æ ·\n> - **ä¸€ç§æ³¨å†ŒæœåŠ¡å’Œç›‘æ§æœåŠ¡å¥åº·çŠ¶æ€çš„æœºåˆ¶**ï¼šåœ¨etcdä¸­æ³¨å†ŒæœåŠ¡ï¼Œå¹¶ä¸”å¯¹æ³¨å†Œçš„æœåŠ¡è®¾ç½®`key TTL`ï¼ˆTTLä¸Šé¢æœ‰è®²åˆ°ï¼‰ï¼Œå®šæ—¶ä¿æŒæœåŠ¡çš„å¿ƒè·³ä»¥è¾¾åˆ°ç›‘æ§å¥åº·çŠ¶æ€çš„æ•ˆæœ\n> - **ä¸€ç§æŸ¥æ‰¾å’Œè¿æ¥æœåŠ¡çš„æœºåˆ¶**ï¼šé€šè¿‡åœ¨etcdæŒ‡å®šçš„ä¸»é¢˜ä¸‹æ³¨å†Œçš„æœåŠ¡ä¹Ÿèƒ½åœ¨å¯¹åº”çš„ä¸»é¢˜ä¸‹æŸ¥æ‰¾åˆ°ï¼Œä¸ºäº†ç¡®ä¿è¿æ¥ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨æ¯ä¸ªæœåŠ¡æœºå™¨ä¸Šéƒ½éƒ¨ç½²ä¸€ä¸ªProxyæ¨¡å¼çš„etcdï¼Œè¿™æ ·å°±å¯ä»¥ç¡®ä¿èƒ½è®¿é—®etcdé›†ç¾¤çš„æœåŠ¡éƒ½èƒ½äº’ç›¸è¿æ¥\n>\n> **WHY**ï¼šæˆ‘ä»¬éœ€è¦è®©æœåŠ¡å¿«é€Ÿé€æ˜åœ°æ¥å…¥åˆ°è®¡ç®—é›†ç¾¤ä¸­ï¼Œè®©å…±äº«é…ç½®ä¿¡æ¯å¿«é€Ÿè¢«é›†ç¾¤ä¸­çš„æ‰€æœ‰æœºå™¨å‘ç°\n\nçœ‹æˆ‘ä»¬çš„ç»“æ„å›¾ï¼Œå¯ä»¥çœ‹åˆ°æˆ‘ä»¬åœ¨12/21/22æœºå™¨éƒ½éƒ¨ç½²äº†etcd\n\n![1584701032598](assets/1584701032598.png)\n\n~~~\n# æˆ‘ä»¬å¼€å§‹åˆ¶ä½œè¯ä¹¦ï¼Œ200æœºå™¨ï¼š\ncerts]# cd /opt/certs/\ncerts]# vi /opt/certs/ca-config.json\n{\n    \"signing\": {\n        \"default\": {\n            \"expiry\": \"1752000h\"\n        },\n        \"profiles\": {\n            \"server\": {\n                \"expiry\": \"1752000h\",\n                \"usages\": [\n                    \"signing\",\n                    \"key encipherment\",\n                    \"server auth\"\n                ]\n            },\n            \"client\": {\n                \"expiry\": \"1752000h\",\n                \"usages\": [\n                    \"signing\",\n                    \"key encipherment\",\n                    \"client auth\"\n                ]\n            },\n            \"peer\": {\n                \"expiry\": \"1752000h\",\n                \"usages\": [\n                    \"signing\",\n                    \"key encipherment\",\n                    \"server auth\",\n                    \"client auth\"\n                ]\n            }\n        }\n    }\n}\n\ncerts]# vi etcd-peer-csr.json\n{\n    \"CN\": \"k8s-etcd\",\n    \"hosts\": [\n        \"10.4.7.11\",\n        \"10.4.7.12\",\n        \"10.4.7.21\",\n        \"10.4.7.22\"\n    ],\n    \"key\": {\n        \"algo\": \"rsa\",\n        \"size\": 2048\n    },\n    \"names\": [\n        {\n            \"C\": \"CN\",\n            \"ST\": \"beijing\",\n            \"L\": \"beijing\",\n            \"O\": \"od\",\n            \"OU\": \"ops\"\n        }\n    ]\n}\n\ncerts]# cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=peer etcd-peer-csr.json |cfssl-json -bare etcd-peer\ncerts]# ll\n~~~\n\n> å…³äºè¿™äº›jsonæ–‡ä»¶æ˜¯æ€ä¹ˆå†™å‡ºæ¥çš„ï¼Œç­”æ¡ˆï¼šå®˜ç½‘æŠ„çš„ç„¶åä¿®æ”¹ï¼Œè¿™äº›æ²¡ä»€ä¹ˆé‡è¦çš„ä½ ä¹Ÿä¸éœ€è¦å¤ªåœ¨æ„ï¼Œåé¢é‡è¦çš„ä¼šè¯´æ˜æ˜¯ä»å“ªé‡ŒæŠ„å‡ºæ¥çš„\n>\n> **ca-config.jsonè§£æï¼š**\n>\n> - expiryï¼šæœ‰æ•ˆæœŸä¸º200å¹´\n> - profiles-serverï¼šå¯åŠ¨serverçš„æ—¶å€™éœ€è¦é…ç½®è¯ä¹¦\n> - profiles-clientï¼šclientå»è¿æ¥serverçš„æ—¶å€™éœ€è¦è¯ä¹¦\n> - profiles-peerï¼šåŒå‘è¯ä¹¦ï¼ŒæœåŠ¡ç«¯æ‰¾å®¢æˆ·ç«¯éœ€è¦è¯ä¹¦ï¼Œå®¢æˆ·ç«¯æ‰¾æœåŠ¡ç«¯éœ€è¦è¯ä¹¦\n>\n> **etcd-peer-csrè§£æï¼š**\n>\n> - hostsï¼šetcdæœ‰å¯èƒ½éƒ¨ç½²åˆ°å“ªäº›ç»„ä»¶çš„IPéƒ½è¦å¡«è¿›æ¥\n>\n> **cfssl gencert**ï¼šç”Ÿæˆè¯ä¹¦\n\n![1578833436255](assets/1578833436255.png)\n\n~~~\n# 12/21/22æœºå™¨ï¼Œå®‰è£…etcdï¼š\n~]# mkdir /opt/src\n~]# cd /opt/src/\n# åˆ›å»ºç”¨æˆ·\nsrc]# useradd -s /sbin/nologin -M etcd\nsrc]# id etcd\n\n# åˆ°GitHubä¸‹è½½æˆ–è€…ç›´æ¥ç”¨æˆ‘ç»™å¾—å®‰è£…åŒ… https://github.com/etcd-io/etcd/releases/tag/v3.1.20ï¼Œç™¾åº¦äº‘https://pan.baidu.com/s/1arE2LdtAbcR80gmIQtIELw æå–ç ï¼šouy1\nsrc]# wget https://github.com/etcd-io/etcd/releases/download/v3.1.20/etcd-v3.1.20-linux-amd64.tar.gz\nsrc]# tar xf etcd-v3.1.20-linux-amd64.tar.gz -C /opt\nsrc]# cd /opt\nopt]# mv etcd-v3.1.20-linux-amd64/ etcd-v3.1.20\nopt]# ln -s /opt/etcd-v3.1.20/ /opt/etcd\nopt]# cd etcd\n~~~\n\n> **tag**ï¼šå¯ä»¥åŠ å…¥ï¼Œè§£å¼€å¤‡ä»½æ–‡ä»¶å†…çš„æ–‡ä»¶\n>\n> - **x**ï¼šè§£å‹\n> - **f** ï¼šä½¿ç”¨æ¡£æ¡ˆåå­—\n> - **-C**ï¼šåˆ‡æ¢åˆ°æŒ‡å®šçš„ç›®å½•\n> - æ•´æ¡å‘½ä»¤åˆèµ·æ¥å°±æ˜¯ï¼ŒæŠŠtgzæ–‡ä»¶ä»¥tgzæ–‡ä»¶åä¸ºåå­—è§£å‹åˆ°optç›®å½•ä¸‹ï¼Œå¹¶ä¿å­˜tgzæ–‡ä»¶åŸæ ·\n>\n> **ln**ï¼šä¸ºæŸä¸€ä¸ªæ–‡ä»¶åœ¨å¦å¤–ä¸€ä¸ªä½ç½®å»ºç«‹ä¸€ä¸ªåŒæ­¥çš„é“¾æ¥\n>\n> - `è¯­æ³•:ln [å‚æ•°][æºæ–‡ä»¶æˆ–ç›®å½•][ç›®æ ‡æ–‡ä»¶æˆ–ç›®å½•]`\n> - **-s**ï¼šè½¯è¿æ¥ï¼Œå¯ä»¥å¯¹æ•´ä¸ªç›®å½•è¿›è¡Œé“¾æ¥\n>\n> **useradd**ï¼šå»ºç«‹ç”¨æˆ·å¸å·\n>\n> **-s**ï¼šæŒ‡å®šç”¨æˆ·ç™»å…¥åæ‰€ä½¿ç”¨çš„shell\n>\n> **-M**ï¼šä¸è¦è‡ªåŠ¨å»ºç«‹ç”¨æˆ·çš„ç™»å…¥ç›®å½•\n\n![1578833934325](assets/1578833934325.png)\n\n~~~\n# 12/21/22æœºå™¨ï¼š\netcd]# mkdir -p /opt/etcd/certs /data/etcd /data/logs/etcd-server\netcd]# cd certs/\ncerts]# scp hdss7-200:/opt/certs/ca.pem .\n# è¾“å…¥200è™šæœºå¯†ç \ncerts]# scp hdss7-200:/opt/certs/etcd-peer.pem .\ncerts]# scp hdss7-200:/opt/certs/etcd-peer-key.pem .\ncerts]# cd ..\n# æ³¨æ„ï¼Œå¦‚æœæ˜¯21æœºå™¨ï¼Œè¿™ä¸‹é¢å¾—12éƒ½å¾—æ”¹æˆ21ï¼Œinitial-clusteråˆ™æ˜¯å…¨éƒ¨æœºå™¨éƒ½æœ‰ä¸éœ€è¦æ”¹ï¼Œä¸€å…±5å¤„ï¼šetcd-server-7-12ã€listen-peer-urlsåã€client-urlsåã€advertise-peer-urlsåã€advertise-client-urlså\netcd]# vi /opt/etcd/etcd-server-startup.sh\n#!/bin/sh\n./etcd --name etcd-server-7-12 \\\n       --data-dir /data/etcd/etcd-server \\\n       --listen-peer-urls https://10.4.7.12:2380 \\\n       --listen-client-urls https://10.4.7.12:2379,http://127.0.0.1:2379 \\\n       --quota-backend-bytes 8000000000 \\\n       --initial-advertise-peer-urls https://10.4.7.12:2380 \\\n       --advertise-client-urls https://10.4.7.12:2379,http://127.0.0.1:2379 \\\n       --initial-cluster  etcd-server-7-12=https://10.4.7.12:2380,etcd-server-7-21=https://10.4.7.21:2380,etcd-server-7-22=https://10.4.7.22:2380 \\\n       --ca-file ./certs/ca.pem \\\n       --cert-file ./certs/etcd-peer.pem \\\n       --key-file ./certs/etcd-peer-key.pem \\\n       --client-cert-auth  \\\n       --trusted-ca-file ./certs/ca.pem \\\n       --peer-ca-file ./certs/ca.pem \\\n       --peer-cert-file ./certs/etcd-peer.pem \\\n       --peer-key-file ./certs/etcd-peer-key.pem \\\n       --peer-client-cert-auth \\\n       --peer-trusted-ca-file ./certs/ca.pem \\\n       --log-output stdout\n\netcd]# chmod +x etcd-server-startup.sh\netcd]# chown -R etcd.etcd /opt/etcd-v3.1.20/\netcd]# chown -R etcd.etcd /data/etcd/\netcd]# chown -R etcd.etcd /data/logs/etcd-server/\netcd]# ll\n~~~\n\n> **scp**ï¼šç”¨äº *Linux* ä¹‹é—´å¤åˆ¶æ–‡ä»¶å’Œç›®å½•\n>\n> **chmod**ï¼šæ·»åŠ æƒé™\n>\n> - **+x**ï¼šç»™å½“å‰ç”¨æˆ·æ·»åŠ å¯æ‰§è¡Œè¯¥æ–‡ä»¶çš„æƒé™æƒé™\n>\n> **chown**ï¼šæŒ‡å®šæ–‡ä»¶çš„æ‹¥æœ‰è€…æ”¹ä¸ºæŒ‡å®šçš„ç”¨æˆ·æˆ–ç»„\n>\n> - **-R**ï¼šå¤„ç†æŒ‡å®šç›®å½•ä»¥åŠå…¶å­ç›®å½•ä¸‹çš„æ‰€æœ‰æ–‡ä»¶\n> - è¿™é‡Œå³æ˜¯æŠŠ/opt/etcd...ç­‰çš„æ‹¥æœ‰è€…ç»™etcdç”¨æˆ·\n>\n> **ll**ï¼šåˆ—å‡ºæƒé™ã€å¤§å°ã€åç§°ç­‰ä¿¡æ¯\n\n![1578834563843](assets/1578834563843.png)\n\n~~~\n# 12/21/22æœºå™¨ï¼Œæˆ‘ä»¬åŒæ—¶éœ€è¦supervisorï¼ˆå®ˆæŠ¤è¿›ç¨‹å·¥å…·ï¼‰æ¥ç¡®ä¿etcdæ˜¯å¯åŠ¨çš„ï¼Œåé¢è¿˜ä¼šä¸æ–­ç”¨åˆ°ï¼š\netcd]# yum install supervisor -y\netcd]# systemctl start supervisord\netcd]# systemctl enable supervisord\n# æ³¨æ„ä¿®æ”¹ä¸‹é¢å¾—7-12ï¼Œå¯¹åº”ä¸Šæœºå™¨ï¼Œå¦‚21æœºå™¨å°±æ˜¯7-21ï¼Œä¸€å…±ä¸€å¤„ï¼š[program:etcd-server-7-12]\netcd]# vi /etc/supervisord.d/etcd-server.ini\n[program:etcd-server-7-12]\ncommand=/opt/etcd/etcd-server-startup.sh                        ; the program (relative uses PATH, can take args)\nnumprocs=1                                                      ; number of processes copies to start (def 1)\ndirectory=/opt/etcd                                             ; directory to cwd to before exec (def no cwd)\nautostart=true                                                  ; start at supervisord start (default: true)\nautorestart=true                                                ; retstart at unexpected quit (default: true)\nstartsecs=30                                                    ; number of secs prog must stay running (def. 1)\nstartretries=3                                                  ; max # of serial start failures (default 3)\nexitcodes=0,2                                                   ; 'expected' exit codes for process (default 0,2)\nstopsignal=QUIT                                                 ; signal used to kill process (default TERM)\nstopwaitsecs=10                                                 ; max num secs to wait b4 SIGKILL (default 10)\nuser=etcd                                                       ; setuid to this UNIX account to run the program\nredirect_stderr=true                                            ; redirect proc stderr to stdout (default false)\nstdout_logfile=/data/logs/etcd-server/etcd.stdout.log           ; stdout log path, NONE for none; default AUTO\nstdout_logfile_maxbytes=64MB                                    ; max # logfile bytes b4 rotation (default 50MB)\nstdout_logfile_backups=4                                        ; # of stdout logfile backups (default 10)\nstdout_capture_maxbytes=1MB                                     ; number of bytes in 'capturemode' (default 0)\nstdout_events_enabled=false                                     ; emit events on stdout writes (default false)\n\netcd]# supervisorctl update\n# outï¼šetcd-server-7-21: added process group\netcd]# supervisorctl status\n# out: etcd-server-7-12                 RUNNING   pid 16582, uptime 0:00:59\netcd]# netstat -luntp|grep etcd\n# å¿…é¡»æ˜¯ç›‘å¬äº†2379å’Œ2380è¿™ä¸¤ä¸ªç«¯å£æ‰ç®—æˆåŠŸ\n~~~\n\n> **systemctl enable**ï¼šå¼€æœºå¯åŠ¨\n>\n> **update**ï¼šæ›´æ–°\n>\n> **netstat -luntpï¼š**æŸ¥çœ‹ç«¯å£å’Œè¿›ç¨‹æƒ…å†µ\n>\n> ç°åœ¨ä½ å¯ä»¥æ„Ÿè§‰åˆ°ï¼Œsupervisorå®ˆæŠ¤è¿›ç¨‹ä¹Ÿä»…ä»…æ˜¯ä½ é…å¥½iniæ–‡ä»¶å³å¯\n\n![1578834944148](assets/1578834944148.png)\n\n~~~\n# ä»»æ„èŠ‚ç‚¹ï¼ˆ12/21/22ï¼‰æ£€æµ‹é›†ç¾¤å¥åº·çŠ¶æ€çš„ä¸¤ç§æ–¹æ³•\n22 etcd]# ./etcdctl cluster-health\n22 etcd]# ./etcdctl member list\n~~~\n\n![1578836465329](assets/1578836465329.png)\n\n> è¿™é‡Œä½ å†å“ªä¸ªæœºå™¨å…ˆupdateï¼Œå“ªä¸ªæœºå™¨å°±æ˜¯leader\n\nå®Œæˆ\n\n\n\n### éƒ¨ç½²API-serveré›†ç¾¤\n\n[kuberneteså®˜ç½‘](https://github.com/kubernetes/kubernetes)\n\næ ¹æ®æ¶æ„å›¾ï¼Œæˆ‘ä»¬æŠŠè¿ç®—èŠ‚ç‚¹éƒ¨ç½²åœ¨21å’Œ22æœºå™¨\n\n![1584701070750](assets/1584701070750.png)\n\n~~~\n# 21/22æœºå™¨\netcd]# cd /opt/src/\n# å¯ä»¥å»å®˜ç½‘ä¸‹è½½ä¹Ÿå¯ä»¥ç”¨æˆ‘çš„åŒ…ï¼Œç™¾åº¦äº‘ç›˜https://pan.baidu.com/s/1arE2LdtAbcR80gmIQtIELw æå–ç ï¼šouy1\nsrc]# wget https://dl.k8s.io/v1.15.2/kubernetes-server-linux-amd64.tar.gz\nsrc]# mv kubernetes-server-linux-amd64.tar.gz kubernetes-server-linux-amd64-v1.15.2.tar.gz\n\nsrc]# tar xf kubernetes-server-linux-amd64-v1.15.2.tar.gz -C /opt/\nsrc]# cd /opt\nopt]# mv kubernetes/ kubernetes-v1.15.2\nopt]# ln -s /opt/kubernetes-v1.15.2/ /opt/kubernetes\nopt]# cd kubernetes\n# åˆ æ‰ä¸éœ€è¦çš„æ–‡ä»¶\nkubernetes]# rm -rf kubernetes-src.tar.gz\nkubernetes]# cd server/bin\nbin]# rm -f *.tar\nbin]# rm -f *_tag\nbin]# ll\n~~~\n\n> **tar xf -C**ï¼šè§£å‹åˆ°æŸä¸ªæ–‡ä»¶å¤¹\n>\n> **mv**ï¼šç§»åŠ¨åˆ°å“ªé‡Œ\n>\n> **ln -s**ï¼šå»ºç«‹è½¯è¿æ¥\n>\n> **rm**ï¼šåˆ é™¤ä¸€ä¸ªæ–‡ä»¶æˆ–è€…ç›®å½•\n>\n> - **-r**ï¼šå°†ç›®å½•åŠä»¥ä¸‹ä¹‹æ¡£æ¡ˆäº¦é€ä¸€åˆ é™¤\n> - **-f**ï¼šç›´æ¥åˆ é™¤ï¼Œæ— éœ€é€ä¸€ç¡®è®¤ï¼ˆä½ å¯ä»¥è¯•è¯•å…ˆä¸åŠ -få»åˆ é™¤ï¼‰\n> - åŠ èµ·æ¥å°±æ˜¯å¼ºåˆ¶åˆ é™¤\n>\n> ***.tar**ï¼š è¿™é‡Œçš„*çš„æ„æ€æ˜¯æ¨¡ç³Šæ³•ï¼Œå³åªè¦ä½ çš„ç»“å°¾æ˜¯.tarçš„éƒ½åŒ¹é…ä¸ŠåŠ ä¸Šrmï¼Œå°±æ˜¯æŠŠæ‰€æœ‰.tarç»“å°¾çš„æ–‡ä»¶éƒ½åˆ é™¤\n\n![1578837147305](assets/1578837147305.png)\n\n~~~\n# ç­¾å‘clientè¯ä¹¦ï¼Œ200æœºå™¨ï¼š\n200 certs]# vi client-csr.json\n{\n    \"CN\": \"k8s-node\",\n    \"hosts\": [\n    ],\n    \"key\": {\n        \"algo\": \"rsa\",\n        \"size\": 2048\n    },\n    \"names\": [\n        {\n            \"C\": \"CN\",\n            \"ST\": \"beijing\",\n            \"L\": \"beijing\",\n            \"O\": \"od\",\n            \"OU\": \"ops\"\n        }\n    ]\n}\n\n200 certs]#  cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=client client-csr.json |cfssl-json -bare client\n200 certs]# ll\n~~~\n\n![1578837306831](assets/1578837306831.png)\n\n~~~\n# ç»™API-serveråšè¯ä¹¦ï¼Œ200æœºå™¨\n200 certs]# vi apiserver-csr.json\n{\n    \"CN\": \"k8s-apiserver\",\n    \"hosts\": [\n        \"127.0.0.1\",\n        \"192.168.0.1\",\n        \"kubernetes.default\",\n        \"kubernetes.default.svc\",\n        \"kubernetes.default.svc.cluster\",\n        \"kubernetes.default.svc.cluster.local\",\n        \"10.4.7.10\",\n        \"10.4.7.21\",\n        \"10.4.7.22\",\n        \"10.4.7.23\"\n    ],\n    \"key\": {\n        \"algo\": \"rsa\",\n        \"size\": 2048\n    },\n    \"names\": [\n        {\n            \"C\": \"CN\",\n            \"ST\": \"beijing\",\n            \"L\": \"beijing\",\n            \"O\": \"od\",\n            \"OU\": \"ops\"\n        }\n    ]\n}\n\n200 certs]# cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=server apiserver-csr.json |cfssl-json -bare apiserver\n200 certs]# ll\n~~~\n\n![1578837423919](assets/1578837423919.png)\n\n~~~\n# 21/22æœºå™¨ï¼š\ncd /opt/kubernetes/server/bin\nbin]# mkdir cert\nbin]# cd cert/\n# æŠŠè¯ä¹¦è€ƒè¿‡æ¥\ncert]# scp hdss7-200:/opt/certs/ca.pem .\ncert]# scp hdss7-200:/opt/certs/ca-key.pem .\ncert]# scp hdss7-200:/opt/certs/client-key.pem .\ncert]# scp hdss7-200:/opt/certs/client.pem .\ncert]# scp hdss7-200:/opt/certs/apiserver.pem .\ncert]# scp hdss7-200:/opt/certs/apiserver-key.pem .\n~~~\n\n> **scp**ï¼šç”¨äº *Linux* ä¹‹é—´å¤åˆ¶æ–‡ä»¶å’Œç›®å½•\n\n![1578837706422](assets/1578837706422.png)\n\n~~~\n# 21/22æœºå™¨ï¼š\ncert]# ll\n# å…±6ä¸ª\næ€»ç”¨é‡ 24\n-rw-------. 1 root root 1679 1æœˆ  12 22:01 apiserver-key.pem\n-rw-r--r--. 1 root root 1598 1æœˆ  12 22:01 apiserver.pem\n-rw-------. 1 root root 1679 1æœˆ  12 22:00 ca-key.pem\n-rw-r--r--. 1 root root 1346 1æœˆ  12 22:00 ca.pem\n-rw-------. 1 root root 1679 1æœˆ  12 22:01 client-key.pem\n-rw-r--r--. 1 root root 1363 1æœˆ  12 22:00 client.pem\n~~~\n\n~~~\n# 21/22æœºå™¨ï¼š\ncd /opt/kubernetes/server/bin\nbin]# mkdir conf\nbin]# cd conf/\nconf]# vi audit.yaml\napiVersion: audit.k8s.io/v1beta1 # This is required.\nkind: Policy\n# Don't generate audit events for all requests in RequestReceived stage.\nomitStages:\n  - \"RequestReceived\"\nrules:\n  # Log pod changes at RequestResponse level\n  - level: RequestResponse\n    resources:\n    - group: \"\"\n      # Resource \"pods\" doesn't match requests to any subresource of pods,\n      # which is consistent with the RBAC policy.\n      resources: [\"pods\"]\n  # Log \"pods/log\", \"pods/status\" at Metadata level\n  - level: Metadata\n    resources:\n    - group: \"\"\n      resources: [\"pods/log\", \"pods/status\"]\n\n  # Don't log requests to a configmap called \"controller-leader\"\n  - level: None\n    resources:\n    - group: \"\"\n      resources: [\"configmaps\"]\n      resourceNames: [\"controller-leader\"]\n\n  # Don't log watch requests by the \"system:kube-proxy\" on endpoints or services\n  - level: None\n    users: [\"system:kube-proxy\"]\n    verbs: [\"watch\"]\n    resources:\n    - group: \"\" # core API group\n      resources: [\"endpoints\", \"services\"]\n\n  # Don't log authenticated requests to certain non-resource URL paths.\n  - level: None\n    userGroups: [\"system:authenticated\"]\n    nonResourceURLs:\n    - \"/api*\" # Wildcard matching.\n    - \"/version\"\n\n  # Log the request body of configmap changes in kube-system.\n  - level: Request\n    resources:\n    - group: \"\" # core API group\n      resources: [\"configmaps\"]\n    # This rule only applies to resources in the \"kube-system\" namespace.\n    # The empty string \"\" can be used to select non-namespaced resources.\n    namespaces: [\"kube-system\"]\n\n  # Log configmap and secret changes in all other namespaces at the Metadata level.\n  - level: Metadata\n    resources:\n    - group: \"\" # core API group\n      resources: [\"secrets\", \"configmaps\"]\n\n  # Log all other resources in core and extensions at the Request level.\n  - level: Request\n    resources:\n    - group: \"\" # core API group\n    - group: \"extensions\" # Version of group should NOT be included.\n\n  # A catch-all rule to log all other requests at the Metadata level.\n  - level: Metadata\n    # Long-running requests like watches that fall under this rule will not\n    # generate an audit event in RequestReceived.\n    omitStages:\n      - \"RequestReceived\"\n      \nconf]# cd ..\nbin]# vi /opt/kubernetes/server/bin/kube-apiserver.sh\n#!/bin/bash\n./kube-apiserver \\\n  --apiserver-count 2 \\\n  --audit-log-path /data/logs/kubernetes/kube-apiserver/audit-log \\\n  --audit-policy-file ./conf/audit.yaml \\\n  --authorization-mode RBAC \\\n  --client-ca-file ./cert/ca.pem \\\n  --requestheader-client-ca-file ./cert/ca.pem \\\n  --enable-admission-plugins NamespaceLifecycle,LimitRanger,ServiceAccount,DefaultStorageClass,DefaultTolerationSeconds,MutatingAdmissionWebhook,ValidatingAdmissionWebhook,ResourceQuota \\\n  --etcd-cafile ./cert/ca.pem \\\n  --etcd-certfile ./cert/client.pem \\\n  --etcd-keyfile ./cert/client-key.pem \\\n  --etcd-servers https://10.4.7.12:2379,https://10.4.7.21:2379,https://10.4.7.22:2379 \\\n  --service-account-key-file ./cert/ca-key.pem \\\n  --service-cluster-ip-range 192.168.0.0/16 \\\n  --service-node-port-range 3000-29999 \\\n  --target-ram-mb=1024 \\\n  --kubelet-client-certificate ./cert/client.pem \\\n  --kubelet-client-key ./cert/client-key.pem \\\n  --log-dir  /data/logs/kubernetes/kube-apiserver \\\n  --tls-cert-file ./cert/apiserver.pem \\\n  --tls-private-key-file ./cert/apiserver-key.pem \\\n  --v 2\n  \nbin]# chmod +x kube-apiserver.sh\n# ä¸€å¤„ä¿®æ”¹ï¼š[program:kube-apiserver-7-21]\nbin]# vi /etc/supervisord.d/kube-apiserver.ini\n[program:kube-apiserver-7-21]\ncommand=/opt/kubernetes/server/bin/kube-apiserver.sh            ; the program (relative uses PATH, can take args)\nnumprocs=1                                                      ; number of processes copies to start (def 1)\ndirectory=/opt/kubernetes/server/bin                            ; directory to cwd to before exec (def no cwd)\nautostart=true                                                  ; start at supervisord start (default: true)\nautorestart=true                                                ; retstart at unexpected quit (default: true)\nstartsecs=30                                                    ; number of secs prog must stay running (def. 1)\nstartretries=3                                                  ; max # of serial start failures (default 3)\nexitcodes=0,2                                                   ; 'expected' exit codes for process (default 0,2)\nstopsignal=QUIT                                                 ; signal used to kill process (default TERM)\nstopwaitsecs=10                                                 ; max num secs to wait b4 SIGKILL (default 10)\nuser=root                                                       ; setuid to this UNIX account to run the program\nredirect_stderr=true                                            ; redirect proc stderr to stdout (default false)\nstdout_logfile=/data/logs/kubernetes/kube-apiserver/apiserver.stdout.log        ; stderr log path, NONE for none; default AUTO\nstdout_logfile_maxbytes=64MB                                    ; max # logfile bytes b4 rotation (default 50MB)\nstdout_logfile_backups=4                                        ; # of stdout logfile backups (default 10)\nstdout_capture_maxbytes=1MB                                     ; number of bytes in 'capturemode' (default 0)\nstdout_events_enabled=false                                     ; emit events on stdout writes (default false)\n\nbin]# mkdir -p /data/logs/kubernetes/kube-apiserver\nbin]# supervisorctl update\n# æŸ¥çœ‹21/22ä¸¤å°æœºå™¨æ˜¯å¦è·‘èµ·æ¥äº†ï¼Œå¯èƒ½æ¯”è¾ƒæ…¢åœ¨startingï¼Œç­‰10ç§’\nbin]# supervisorctl status\n~~~\n\n> **mkdir -p**ï¼šåˆ›å»ºç›®å½•ï¼Œæ²¡æœ‰ä¸Šä¸€çº§ç›®å½•åˆ™åˆ›å»º\n>\n> **supervisorctl update**ï¼šæ›´æ–°supervisorctl\n>\n> **audit.yamlè§£æï¼š**\n>\n> - å¯ä»¥å‚è€ƒè¿™ç¯‡æ–‡ç« [ç‚¹å‡»è·³è½¬](https://www.baidu.com/link?url=tFECOG31lKlcqDWeAZGF1VyjhzVAN9vUKHKEKKw5G8y0AC8MKpJxSZeL647MIFdw&wd=&eqid=dafe84b80019e4a3000000065e51d2e2)ï¼Œå½“ç„¶è¿™é‡Œçš„audit.yamlå¯èƒ½ä¼šæœ‰äº›ä¸ä¸€æ ·ï¼Œä½†æ˜¯æˆ‘ä»¬åé¢ç”¨åˆ°çš„yamlæ–‡ä»¶å°±å¾ˆç›¸ä¼¼äº†\n\n![1578839161494](assets/1578839161494.png)\n\n> <a href=\"https://github.com/ben1234560/k8s_PaaS/blob/master/%E5%8E%9F%E7%90%86%E5%8F%8A%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/Kubernetes%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5.md#pod%E7%9A%84%E5%87%A0%E7%A7%8D%E7%8A%B6%E6%80%81\">Podçš„å‡ ç§çŠ¶æ€</a>\n\nå®Œæˆ\n\n\n\n### å®‰è£…éƒ¨ç½²ä¸»æ§èŠ‚ç‚¹L4åä»£æœåŠ¡\n\næ ¹æ®æˆ‘ä»¬æ¶æ„å›¾ï¼Œåœ¨11/12æœºå™¨ä¸Šåšåä»£\n\n![1584701103579](assets/1584701103579.png)\n\nå®‰è£…nginxæ—¶å¦ä¸€ä¸ªæ³¨æ„äº‹é¡¹ <a href=\"https://github.com/ben1234560/k8s_PaaS/issues/16\">ç‚¹å‡»é“¾æ¥Â Â </a>\n\nï¼ˆæ„Ÿè°¢ https://github.com/nangongchengfeng/ï¼‰\n\n~~~\n# 11/12æœºå™¨\n~]# yum install nginx nginx-mod-stream -y\n# æ·»åŠ åœ¨æœ€ä¸‹é¢\n~]# vi /etc/nginx/nginx.conf\nstream {\n    upstream kube-apiserver {\n        server 10.4.7.21:6443     max_fails=3 fail_timeout=30s;\n        server 10.4.7.22:6443     max_fails=3 fail_timeout=30s;\n    }\n    server {\n        listen 7443;\n        proxy_connect_timeout 2s;\n        proxy_timeout 900s;\n        proxy_pass kube-apiserver;\n    }\n}\n\n~]# nginx -t\n~]# systemctl start nginx\n~]# systemctl enable nginx\n~]# yum install keepalived -y\n# keepalived ç›‘æ§ç«¯å£è„šæœ¬\n~]# vi /etc/keepalived/check_port.sh\n#!/bin/bash\nCHK_PORT=$1\nif [ -n \"$CHK_PORT\" ];then\n        PORT_PROCESS=`ss -lnt|grep $CHK_PORT|wc -l`\n        if [ $PORT_PROCESS -eq 0 ];then\n                echo \"Port $CHK_PORT Is Not Used,End.\"\n                exit 1\n        fi\nelse\n        echo \"Check Port Cant Be Empty!\"\nfi\n\n~]# chmod +x /etc/keepalived/check_port.sh\n~~~\n\n> ç”±äº7443ç«¯å£æœªç›‘å¬ï¼ŒNginx å¯åŠ¨æŠ¥ [emerg] bind() failedçš„å¯ä»¥å‚è€ƒ[è¿™ä¸ªæ–¹æ³•](https://blog.csdn.net/RunSnail2018/article/details/81185138)ï¼ˆæ„Ÿè°¢https://gitee.com/wangming91/ï¼‰\n>\n> **yum install -y**ï¼šå®‰è£…å¹¶è‡ªåŠ¨yes\n>\n> **nginx -t**ï¼šç¡®å®šnginx.confæœ‰æ²¡æœ‰è¯­æ³•é”™è¯¯\n>\n> **systemctl start**ï¼šå¯åŠ¨æœåŠ¡\n>\n> **systemctl enable**ï¼šå¼€æœºè‡ªå¯\n\n~~~\n# ä»…ä»¥ä¸‹åˆ†ä¸»ä»æ“ä½œï¼š\n# æŠŠåŸæœ‰å†…å®¹éƒ½åˆ æ‰ï¼Œå‘½ä»¤è¡Œå¿«é€ŸæŒ‰æ‰“å‡ºdG\n# æ³¨æ„ï¼Œä¸‹é¢çš„vrrp_instanceä¸‹çš„interfaceï¼Œæˆ‘çš„æœºå™¨æ˜¯eth0é…ç½®äº†ç½‘å¡ï¼Œæœ‰çš„ç‰ˆæœ¬æ˜¯ens33é…ç½®ç½‘å¡ï¼Œå¯ä»¥ç”¨ifconfigæŸ¥çœ‹ï¼Œç¬¬ä¸€è¡Œå°±æ˜¯ï¼Œå¦‚æœä½ æ˜¯ens33ï¼Œæ”¹è¿™ä¸ªinterface ens33\n# keepalived ä¸»ï¼ˆå³11æœºå™¨ï¼‰:\n11 ~]# vi /etc/keepalived/keepalived.conf\n! Configuration File for keepalived\n\nglobal_defs {\n   router_id 10.4.7.11\n\n}\n\nvrrp_script chk_nginx {\n    script \"/etc/keepalived/check_port.sh 7443\"\n    interval 2\n    weight -20\n}\n\nvrrp_instance VI_1 {\n    state MASTER\n    interface eth0\n    virtual_router_id 251\n    priority 100\n    advert_int 1\n    mcast_src_ip 10.4.7.11\n    nopreempt\n\n    authentication {\n        auth_type PASS\n        auth_pass 11111111\n    }\n    track_script {\n         chk_nginx\n    }\n    virtual_ipaddress {\n        10.4.7.10\n    }\n}\n\nkeepalivedä»ï¼ˆå³12æœºå™¨ï¼‰:\n12 ~]# vi /etc/keepalived/keepalived.conf\n! Configuration File for keepalived\nglobal_defs {\n\trouter_id 10.4.7.12\n}\nvrrp_script chk_nginx {\n\tscript \"/etc/keepalived/check_port.sh 7443\"\n\tinterval 2\n\tweight -20\n}\nvrrp_instance VI_1 {\n\tstate BACKUP\n\tinterface eth0\n\tvirtual_router_id 251\n\tmcast_src_ip 10.4.7.12\n\tpriority 90\n\tadvert_int 1\n\tauthentication {\n\t\tauth_type PASS\n\t\tauth_pass 11111111\n\t}\n\ttrack_script {\n\t\tchk_nginx\n\t}\n\tvirtual_ipaddress {\n\t\t10.4.7.10\n\t}\n}\n~~~\n\n\n\n~~~\n# 11/12æœºå™¨\n~]# systemctl start keepalived\n~]# systemctl enable keepalived\n# åœ¨11æœºå™¨\n11 ~]# ip add\n~~~\n\n![1578840833339](assets/1578840833339.png)\n\n#### å°å®éªŒï¼ˆå¯ä¸åšï¼‰ï¼š\n\n~~~\n# å®éªŒ(å¯ä¸åš)ï¼šåœ¨11æœºå™¨å…³æ‰nginx\n11 ~]# nginx -s stop\n11 ~]# netstat -luntp|grep 7443\n# ä»£ç†ä¼šè·‘åˆ°12æœºå™¨\n~~~\n\n![1578841077321](assets/1578841077321.png)\n\n~~~\n11 ~]# nginx\n11 ~]# netstat -luntp|grep 744\n# å†èµ·æ¥ï¼Œä½†ä¹Ÿä¸ä¼šè·‘å›æ¥ï¼Œå› ä¸ºæˆ‘ä»¬é…ç½®äº†\n~~~\n\n![1578841192980](assets/1578841192980.png)\n\n~~~\n# 11/12æœºå™¨æ‰§è¡Œï¼š\n~]# systemctl restart keepalived\n# 11æœºå™¨ï¼š\n~]# ip add\n~~~\n\n> ç”Ÿäº§ä¸­ï¼Œäººå·¥ç¡®å®šæœºå™¨æ²¡é—®é¢˜äº†ï¼Œå†æ‰‹åŠ¨å›æ¥\n\n![1578841301006](assets/1578841301006.png)\n\nå®Œæˆ\n\n\n\n### å®‰è£…éƒ¨ç½²controller-managerï¼ˆèŠ‚ç‚¹æ§åˆ¶å™¨/è°ƒåº¦å™¨æœåŠ¡ï¼‰\n\nè®©æˆ‘ä»¬å†æ¬å‡ºæˆ‘ä»¬çš„æ¶æ„å›¾\n\n![1584701137068](assets/1584701137068.png)\n\n~~~\n# 21/22æœºå™¨ï¼š\nbin]# vi /opt/kubernetes/server/bin/kube-controller-manager.sh\n#!/bin/sh\n./kube-controller-manager \\\n  --cluster-cidr 172.7.0.0/16 \\\n  --leader-elect true \\\n  --log-dir /data/logs/kubernetes/kube-controller-manager \\\n  --master http://127.0.0.1:8080 \\\n  --service-account-private-key-file ./cert/ca-key.pem \\\n  --service-cluster-ip-range 192.168.0.0/16 \\\n  --root-ca-file ./cert/ca.pem \\\n  --v 2\n\nbin]# chmod +x /opt/kubernetes/server/bin/kube-controller-manager.sh\nbin]# mkdir -p /data/logs/kubernetes/kube-controller-manager\n# æ³¨æ„22æœºå™¨ï¼Œä¸‹é¢è¦æ”¹æˆ7-22ï¼Œä¸€å¤„ä¿®æ”¹ï¼šmanager-7-21]\nbin]# vi /etc/supervisord.d/kube-conntroller-manager.ini\n[program:kube-controller-manager-7-21]\ncommand=/opt/kubernetes/server/bin/kube-controller-manager.sh                     ; the program (relative uses PATH, can take args)\nnumprocs=1                                                                        ; number of processes copies to start (def 1)\ndirectory=/opt/kubernetes/server/bin                                              ; directory to cwd to before exec (def no cwd)\nautostart=true                                                                    ; start at supervisord start (default: true)\nautorestart=true                                                                  ; retstart at unexpected quit (default: true)\nstartsecs=30                                                                      ; number of secs prog must stay running (def. 1)\nstartretries=3                                                                    ; max # of serial start failures (default 3)\nexitcodes=0,2                                                                     ; 'expected' exit codes for process (default 0,2)\nstopsignal=QUIT                                                                   ; signal used to kill process (default TERM)\nstopwaitsecs=10                                                                   ; max num secs to wait b4 SIGKILL (default 10)\nuser=root                                                                         ; setuid to this UNIX account to run the program\nredirect_stderr=true                                                              ; redirect proc stderr to stdout (default false)\nstdout_logfile=/data/logs/kubernetes/kube-controller-manager/controller.stdout.log  ; stderr log path, NONE for none; default AUTO\nstdout_logfile_maxbytes=64MB                                                      ; max # logfile bytes b4 rotation (default 50MB)\nstdout_logfile_backups=4                                                          ; # of stdout logfile backups (default 10)\nstdout_capture_maxbytes=1MB                                                       ; number of bytes in 'capturemode' (default 0)\nstdout_events_enabled=false                                                       ; emit events on stdout writes (default false)\n\nbin]# supervisorctl update\nbin]# vi /opt/kubernetes/server/bin/kube-scheduler.sh\n#!/bin/sh\n./kube-scheduler \\\n  --leader-elect  \\\n  --log-dir /data/logs/kubernetes/kube-scheduler \\\n  --master http://127.0.0.1:8080 \\\n  --v 2\n  \nbin]# chmod +x /opt/kubernetes/server/bin/kube-scheduler.sh\nbin]# mkdir -p /data/logs/kubernetes/kube-scheduler\n# æ³¨æ„æ”¹æœºå™¨å·ï¼Œä¸€å¤„ä¿®æ”¹ï¼šscheduler-7-21]\nbin]# vi /etc/supervisord.d/kube-scheduler.ini\n[program:kube-scheduler-7-21]\ncommand=/opt/kubernetes/server/bin/kube-scheduler.sh                     ; the program (relative uses PATH, can take args)\nnumprocs=1                                                               ; number of processes copies to start (def 1)\ndirectory=/opt/kubernetes/server/bin                                     ; directory to cwd to before exec (def no cwd)\nautostart=true                                                           ; start at supervisord start (default: true)\nautorestart=true                                                         ; retstart at unexpected quit (default: true)\nstartsecs=30                                                             ; number of secs prog must stay running (def. 1)\nstartretries=3                                                           ; max # of serial start failures (default 3)\nexitcodes=0,2                                                            ; 'expected' exit codes for process (default 0,2)\nstopsignal=QUIT                                                          ; signal used to kill process (default TERM)\nstopwaitsecs=10                                                          ; max num secs to wait b4 SIGKILL (default 10)\nuser=root                                                                ; setuid to this UNIX account to run the program\nredirect_stderr=true                                                     ; redirect proc stderr to stdout (default false)\nstdout_logfile=/data/logs/kubernetes/kube-scheduler/scheduler.stdout.log ; stderr log path, NONE for none; default AUTO\nstdout_logfile_maxbytes=64MB                                             ; max # logfile bytes b4 rotation (default 50MB)\nstdout_logfile_backups=4                                                 ; # of stdout logfile backups (default 10)\nstdout_capture_maxbytes=1MB                                              ; number of bytes in 'capturemode' (default 0)\nstdout_events_enabled=false                                              ; emit events on stdout writes (default false)\n\nbin]# supervisorctl update\nbin]# supervisorctl status\n# èµ·æ¥äº†4ä¸ª\nbin]# ln -s /opt/kubernetes/server/bin/kubectl /usr/bin/kubectl\n# æŸ¥çœ‹é›†ç¾¤å¥åº·æƒ…å†µï¼Œ21/22æœºå™¨ï¼š\nbin]# kubectl get cs\n~~~\n\n> **ln -s**ï¼šå»ºç«‹è½¯é“¾æ¥\n>\n> **supervisorctl status**ï¼šæŸ¥çœ‹supervisorçš„æƒ…å†µ\n>\n> **supervisorctl update**ï¼šæ›´æ–°supervisor\n>\n> **kubectl get**ï¼šè·å–åˆ—å‡ºä¸€ä¸ªæˆ–å¤šä¸ªèµ„æºçš„ä¿¡æ¯\n>\n> - ä¸Šé¢ä¸€æ¡å‘½ä»¤çš„æ„æ€æ˜¯ï¼š    åˆ—å‡ºæ‰€æœ‰csä¿¡æ¯\n\n![1578842317467](assets/1578842317467.png)\n\nå®Œæˆ\n\n\n\n### å®‰è£…éƒ¨ç½²è¿ç®—èŠ‚ç‚¹æœåŠ¡ï¼ˆkubeletï¼‰\n\n~~~\n# ç­¾å‘è¯ä¹¦ï¼Œ200æœºå™¨\n200 certs]# vi kubelet-csr.json\n{\n    \"CN\": \"k8s-kubelet\",\n    \"hosts\": [\n    \"127.0.0.1\",\n    \"10.4.7.10\",\n    \"10.4.7.21\",\n    \"10.4.7.22\",\n    \"10.4.7.23\",\n    \"10.4.7.24\",\n    \"10.4.7.25\",\n    \"10.4.7.26\",\n    \"10.4.7.27\",\n    \"10.4.7.28\"\n    ],\n    \"key\": {\n        \"algo\": \"rsa\",\n        \"size\": 2048\n    },\n    \"names\": [\n        {\n            \"C\": \"CN\",\n            \"ST\": \"beijing\",\n            \"L\": \"beijing\",\n            \"O\": \"od\",\n            \"OU\": \"ops\"\n        }\n    ]\n}\n\n200 certs]# cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=server kubelet-csr.json | cfssl-json -bare kubelet\n200 certs]# ll\n~~~\n\n> **kubelet-csr-hosts**ï¼šæŠŠæ‰€æœ‰å¯èƒ½ç”¨åˆ°çš„IPéƒ½æ”¾è¿›æ¥\n\n![1580436431973](assets/1580436431973.png)\n\n~~~\n# åˆ†å‘è¯ä¹¦ï¼Œ21/22æœºå™¨\ncert]# cd /opt/kubernetes/server/bin/cert/\ncert]# scp hdss7-200:/opt/certs/kubelet.pem .\ncert]# scp hdss7-200:/opt/certs/kubelet-key.pem .\n\n# 21æœºå™¨ï¼š\ncert]# cd ../conf/\nconf]# kubectl config set-cluster myk8s \\\n  --certificate-authority=/opt/kubernetes/server/bin/cert/ca.pem \\\n  --embed-certs=true \\\n  --server=https://10.4.7.10:7443 \\\n  --kubeconfig=kubelet.kubeconfig\n\nconf]# kubectl config set-credentials k8s-node \\\n  --client-certificate=/opt/kubernetes/server/bin/cert/client.pem \\\n  --client-key=/opt/kubernetes/server/bin/cert/client-key.pem \\\n  --embed-certs=true \\\n  --kubeconfig=kubelet.kubeconfig \n\nconf]# kubectl config set-context myk8s-context \\\n  --cluster=myk8s \\\n  --user=k8s-node \\\n  --kubeconfig=kubelet.kubeconfig\n\nconf]# kubectl config use-context myk8s-context --kubeconfig=kubelet.kubeconfig\n#out: Switched to context \"myk8s-context\".\n# åšæƒé™æˆæƒï¼Œæ¨èæ–‡ç« https://www.jianshu.com/p/9991f189495f\nconf]# vi k8s-node.yaml\napiVersion: rbac.authorization.k8s.io/v1\nkind: ClusterRoleBinding\nmetadata:\n  name: k8s-node\nroleRef:\n  apiGroup: rbac.authorization.k8s.io\n  kind: ClusterRole\n  name: system:node\nsubjects:\n- apiGroup: rbac.authorization.k8s.io\n  kind: User\n  name: k8s-node\n  \nconf]# kubectl create -f k8s-node.yaml\nconf]# kubectl get clusterrolebinding k8s-node -o yaml\n\n# 22æœºå™¨ï¼Œå¤åˆ¶21æœºå™¨å³å¯\ncert]# cd ../conf/\nconf]# scp hdss7-21:/opt/kubernetes/server/bin/conf/kubelet.kubeconfig .\n~~~\n\n> **scp**ï¼šç”¨äº *Linux* ä¹‹é—´å¤åˆ¶æ–‡ä»¶å’Œç›®å½•\n>\n> **kubectl create -f**  ï¼šé€šè¿‡é…ç½®æ–‡ä»¶åæˆ–stdinåˆ›å»ºä¸€ä¸ªé›†ç¾¤èµ„æºå¯¹è±¡\n>\n> **kubectl get ... -o ...**  ï¼šåˆ—å‡ºPodä»¥åŠè¿è¡ŒPodèŠ‚ç‚¹ä¿¡æ¯ï¼ˆä½ å¯ä»¥è¯•ä¸‹ä¸åŠ -oå’ŒåŠ -oçš„åŒºåˆ«ï¼‰\n\n![1580436621354](assets/1580436621354.png)\n\n~~~\n# å‡†å¤‡pauseåŸºç¡€é•œåƒï¼Œ200æœºå™¨ï¼š\ncerts]# docker pull kubernetes/pause\ncerts]# docker images|grep pause\ncerts]# docker tag f9d5de079539 harbor.od.com/public/pause:latest\ncerts]# docker push harbor.od.com/public/pause:latest\n~~~\n\n> **docker pull**ï¼šä¸‹è½½é•œåƒ\n>\n> **docker images**ï¼šåˆ—å‡ºæ‰€æœ‰çš„é•œåƒ\n>\n> - è¿™é‡ŒåŠ ä¸Š|grep ç®¡é“ç¬¦æ˜¯ä¸ºäº†è¿‡æ»¤å‡ºæ¥pauseé•œåƒ\n>\n> **docker tag**ï¼šç»™é•œåƒæ‰“åå­—\n>\n> **docker push**ï¼šå°†é•œåƒæ¨é€åˆ°æŒ‡å®šçš„ä»“åº“\n\n~~~\n# 21/21æœºå™¨ï¼Œæ³¨æ„ä¿®æ”¹ä¸»æœºåï¼Œæœ‰ä¸€å¤„éœ€è¦æ”¹ï¼šhdss7-21\nbin]# vi /opt/kubernetes/server/bin/kubelet.sh\n#!/bin/sh\n./kubelet \\\n  --anonymous-auth=false \\\n  --cgroup-driver systemd \\\n  --cluster-dns 192.168.0.2 \\\n  --cluster-domain cluster.local \\\n  --runtime-cgroups=/systemd/system.slice \\\n  --kubelet-cgroups=/systemd/system.slice \\\n  --fail-swap-on=\"false\" \\\n  --client-ca-file ./cert/ca.pem \\\n  --tls-cert-file ./cert/kubelet.pem \\\n  --tls-private-key-file ./cert/kubelet-key.pem \\\n  --hostname-override hdss7-21.host.com \\\n  --image-gc-high-threshold 20 \\\n  --image-gc-low-threshold 10 \\\n  --kubeconfig ./conf/kubelet.kubeconfig \\\n  --log-dir /data/logs/kubernetes/kube-kubelet \\\n  --pod-infra-container-image harbor.od.com/public/pause:latest \\\n  --root-dir /data/kubelet\n  \nconf]# cd /opt/kubernetes/server/bin\nbin]# mkdir -p /data/logs/kubernetes/kube-kubelet /data/kubelet\nbin]# chmod +x kubelet.sh\n# æœ‰ä¸€å¤„è¦ä¿®æ”¹ï¼škube-kubelet-7-21]\nbin]# vi /etc/supervisord.d/kube-kubelet.ini\n[program:kube-kubelet-7-21]\ncommand=/opt/kubernetes/server/bin/kubelet.sh     ; the program (relative uses PATH, can take args)\nnumprocs=1                                        ; number of processes copies to start (def 1)\ndirectory=/opt/kubernetes/server/bin              ; directory to cwd to before exec (def no cwd)\nautostart=true                                    ; start at supervisord start (default: true)\nautorestart=true              \t\t          ; retstart at unexpected quit (default: true)\nstartsecs=30                                      ; number of secs prog must stay running (def. 1)\nstartretries=3                                    ; max # of serial start failures (default 3)\nexitcodes=0,2                                     ; 'expected' exit codes for process (default 0,2)\nstopsignal=QUIT                                   ; signal used to kill process (default TERM)\nstopwaitsecs=10                                   ; max num secs to wait b4 SIGKILL (default 10)\nuser=root                                         ; setuid to this UNIX account to run the program\nredirect_stderr=true                              ; redirect proc stderr to stdout (default false)\nstdout_logfile=/data/logs/kubernetes/kube-kubelet/kubelet.stdout.log   ; stderr log path, NONE for none; default AUTO\nstdout_logfile_maxbytes=64MB                      ; max # logfile bytes b4 rotation (default 50MB)\nstdout_logfile_backups=4                          ; # of stdout logfile backups (default 10)\nstdout_capture_maxbytes=1MB                       ; number of bytes in 'capturemode' (default 0)\nstdout_events_enabled=false                       ; emit events on stdout writes (default false)\n\nbin]# supervisorctl update\nbin]# supervisorctl status\nbin]# kubectl get nodes\n# ç»™æ ‡ç­¾,21/22éƒ½ç»™ä¸Šmaster,node\nbin]# kubectl label node hdss7-21.host.com node-role.kubernetes.io/master=\nbin]# kubectl label node hdss7-21.host.com node-role.kubernetes.io/node=\nbin]# kubectl label node hdss7-22.host.com node-role.kubernetes.io/master=\nbin]# kubectl label node hdss7-22.host.com node-role.kubernetes.io/node=\nbin]# kubectl get nodes\n~~~\n\n![1579071142869](assets/1579071142869.png)\n\nå®Œæˆ\n\n\n\n### å®‰è£…éƒ¨ç½²è¿ç®—èŠ‚ç‚¹æœåŠ¡ï¼ˆkube-proxyï¼‰\n\n~~~\n# ç­¾å‘è¯ä¹¦è¯·æ±‚æ–‡ä»¶ï¼Œ200ï¼š\n200 certs]# vi kube-proxy-csr.json\n{\n    \"CN\": \"system:kube-proxy\",\n    \"key\": {\n        \"algo\": \"rsa\",\n        \"size\": 2048\n    },\n    \"names\": [\n        {\n            \"C\": \"CN\",\n            \"ST\": \"beijing\",\n            \"L\": \"beijing\",\n            \"O\": \"od\",\n            \"OU\": \"ops\"\n        }\n    ]\n}\n\n200 certs]# cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=client kube-proxy-csr.json |cfssl-json -bare kube-proxy-client\n~~~\n\n![1580437266613](assets/1580437266613.png)\n\n~~~\n# åˆ†å‘è¯ä¹¦ï¼Œ21/22æœºå™¨ï¼š\ncd /opt/kubernetes/server/bin/cert\ncert]# scp hdss7-200:/opt/certs/kube-proxy-client.pem .\ncert]# scp hdss7-200:/opt/certs/kube-proxy-client-key.pem .\ncd ../conf/\n# 21æœºå™¨ï¼š\nconf]# kubectl config set-cluster myk8s \\\n  --certificate-authority=/opt/kubernetes/server/bin/cert/ca.pem \\\n  --embed-certs=true \\\n  --server=https://10.4.7.10:7443 \\\n  --kubeconfig=kube-proxy.kubeconfig\n\nconf]# kubectl config set-credentials kube-proxy \\\n  --client-certificate=/opt/kubernetes/server/bin/cert/kube-proxy-client.pem \\\n  --client-key=/opt/kubernetes/server/bin/cert/kube-proxy-client-key.pem \\\n  --embed-certs=true \\\n  --kubeconfig=kube-proxy.kubeconfig\n\nconf]# kubectl config set-context myk8s-context \\\n  --cluster=myk8s \\\n  --user=kube-proxy \\\n  --kubeconfig=kube-proxy.kubeconfig\n\nconf]# kubectl config use-context myk8s-context --kubeconfig=kube-proxy.kubeconfig\n\n# 22æœºå™¨\nconf]# scp hdss7-21:/opt/kubernetes/server/bin/conf/kube-proxy.kubeconfig .\n\n\n# 21/22æœºå™¨ï¼š\ncd\n~]# lsmod |grep ip_vs\n~]# vi ipvs.sh\n#!/bin/bash\nipvs_mods_dir=\"/usr/lib/modules/$(uname -r)/kernel/net/netfilter/ipvs\"\nfor i in $(ls $ipvs_mods_dir|grep -o \"^[^.]*\")\ndo\n  /sbin/modinfo -F filename $i &>/dev/null\n  if [ $? -eq 0 ];then\n    /sbin/modprobe $i\n  fi\ndone\n\n~]# chmod +x ipvs.sh\n~]# ./ipvs.sh\n~]# lsmod |grep ip_vs\n~~~\n\n> **lsmod**ï¼šæ˜¾ç¤ºå·²è½½å…¥ç³»ç»Ÿçš„æ¨¡å—\n>\n> - åé¢å¸¦çš„ç®¡é“ç¬¦åˆ™æ˜¯è¿‡æ»¤å‡ºip_vsæ¥\n>\n> **chmod +x**ï¼šç»™æ–‡ä»¶æ·»åŠ æ‰§è¡Œæƒé™\n>\n> **./ipvs.sh**ï¼šè¿è¡Œæ–‡ä»¶\n\n![1578846381651](assets/1578846381651.png)\n\n~~~\n# 21/22æœºå™¨ï¼š\n~]#cd /opt/kubernetes/server/bin/\n# æ³¨æ„ä¿®æ”¹å¯¹åº”çš„æœºå™¨ipï¼Œæœ‰ä¸€å¤„ä¿®æ”¹ï¼šhdss7-21\nbin]# vi /opt/kubernetes/server/bin/kube-proxy.sh\n#!/bin/sh\n./kube-proxy \\\n  --cluster-cidr 172.7.0.0/16 \\\n  --hostname-override hdss7-21.host.com \\\n  --proxy-mode=ipvs \\\n  --ipvs-scheduler=nq \\\n  --kubeconfig ./conf/kube-proxy.kubeconfig\n  \nbin]# chmod +x kube-proxy.sh\nbin]# mkdir -p /data/logs/kubernetes/kube-proxy\n# æ³¨æ„æœºå™¨IPï¼Œæœ‰ä¸€å¤„ä¿®æ”¹ï¼škube-proxy-7-21]\nbin]# vi /etc/supervisord.d/kube-proxy.ini\n[program:kube-proxy-7-21]\ncommand=/opt/kubernetes/server/bin/kube-proxy.sh                     ; the program (relative uses PATH, can take args)\nnumprocs=1                                                           ; number of processes copies to start (def 1)\ndirectory=/opt/kubernetes/server/bin                                 ; directory to cwd to before exec (def no cwd)\nautostart=true                                                       ; start at supervisord start (default: true)\nautorestart=true                                                     ; retstart at unexpected quit (default: true)\nstartsecs=30                                                         ; number of secs prog must stay running (def. 1)\nstartretries=3                                                       ; max # of serial start failures (default 3)\nexitcodes=0,2                                                        ; 'expected' exit codes for process (default 0,2)\nstopsignal=QUIT                                                      ; signal used to kill process (default TERM)\nstopwaitsecs=10                                                      ; max num secs to wait b4 SIGKILL (default 10)\nuser=root                                                            ; setuid to this UNIX account to run the program\nredirect_stderr=true                                                 ; redirect proc stderr to stdout (default false)\nstdout_logfile=/data/logs/kubernetes/kube-proxy/proxy.stdout.log     ; stderr log path, NONE for none; default AUTO\nstdout_logfile_maxbytes=64MB                                         ; max # logfile bytes b4 rotation (default 50MB)\nstdout_logfile_backups=4                                             ; # of stdout logfile backups (default 10)\nstdout_capture_maxbytes=1MB                                          ; number of bytes in 'capturemode' (default 0)\nstdout_events_enabled=false                                          ; emit events on stdout writes (default false)\n\nbin]# supervisorctl update\nbin]# yum install ipvsadm -y\nbin]# ipvsadm -Ln\nbin]# kubectl get svc\n~~~\n\n> **ipvsadm**ï¼šç”¨äºè®¾ç½®ã€ç»´æŠ¤å’Œæ£€æŸ¥Linuxå†…æ ¸ä¸­è™šæ‹ŸæœåŠ¡å™¨åˆ—è¡¨çš„*å‘½ä»¤*\n>\n> **ipvsadm -Ln** ï¼šæŸ¥çœ‹å½“å‰é…ç½®çš„è™šæ‹ŸæœåŠ¡å’Œå„ä¸ªRSçš„æƒé‡\n\n![1578846997119](assets/1578846997119.png)\n\n~~~\n# éªŒè¯ä¸€ä¸‹é›†ç¾¤ï¼Œ21æœºå™¨(åœ¨ä»»æ„èŠ‚ç‚¹æœºå™¨ï¼Œæˆ‘é€‰çš„æ˜¯21)ï¼š\ncd\n~]# vi /root/nginx-ds.yaml\napiVersion: extensions/v1beta1\nkind: DaemonSet\nmetadata:\n  name: nginx-ds\nspec:\n  template:\n    metadata:\n      labels:\n        app: nginx-ds\n    spec:\n      containers:\n      - name: my-nginx\n        image: harbor.od.com/public/nginx:v1.7.9\n        ports:\n        - containerPort: 80\n        \n~]# kubectl create -f nginx-ds.yaml\n# outï¼šdaemonset.extensions/nginx-ds created\n~]# kubectl get pods -o wide\n# ä»¥ä¸‹æ˜¯æˆåŠŸçš„çŠ¶æ€ï¼Œåœ¨21/22æœºå™¨éƒ½å¯ä»¥æŸ¥åˆ°\n~~~\n\n> **æ³¨æ„ï¼Œå¦‚æœä½ çš„podçš„wide22çš„ä¹Ÿåœ¨21ä¸Šæˆ–è€…ç±»ä¼¼æƒ…å†µï¼Œé‚£å°±æ˜¯ä½ çš„vi /etc/docker/daemon.jsonæ²¡æ”¹å¥½æœºå™¨åï¼Œéœ€è¦é‡æ–°åšè¿‡å…¨éƒ¨æœºå™¨**\n>\n> **kubectl create -f**  ï¼šé€šè¿‡é…ç½®æ–‡ä»¶åæˆ–stdinåˆ›å»ºä¸€ä¸ªé›†ç¾¤èµ„æºå¯¹è±¡\n>\n> **kubectl get ... -o wide**ï¼šæ˜¾ç¤ºç½‘ç»œæƒ…å†µ\n>\n> **nginx-ds.yamlè§£æï¼š**\n>\n> - å¯ä»¥å‚è€ƒè¿™ç¯‡æ–‡ç« [ç‚¹å‡»è·³è½¬](https://www.baidu.com/link?url=tFECOG31lKlcqDWeAZGF1VyjhzVAN9vUKHKEKKw5G8y0AC8MKpJxSZeL647MIFdw&wd=&eqid=dafe84b80019e4a3000000065e51d2e2)ï¼Œè¿™é‡Œçš„nginx-ds.yamlå»ºè®®è‡ªå·±æ‰‹æ•²ä¸€éï¼Œæ•²çš„åŒæ—¶è¦çŸ¥é“è‡ªå·±æ•²çš„æ˜¯ä»€ä¹ˆï¼Œè®°ä½ï¼Œyamlè¯­æ³•ä¸å…è®¸ä½¿ç”¨Tabé”®ï¼Œåªå…è®¸ç©ºæ ¼\n\n![1578847257509](assets/1578847257509.png)\n\næ­å–œ:tada::tada::tada:\n\næ­¤æ—¶ä½ å·²ç»éƒ¨ç½²å¥½K8Sé›†ç¾¤ï¼å½“ç„¶åªæœ‰é›†ç¾¤è¿˜è¿œè¿œä¸å¤Ÿï¼Œæˆ‘ä»¬è¿˜éœ€è¦æ›´å¤šçš„ä¸œè¥¿æ‰èƒ½ç»„æˆæˆ‘ä»¬çš„PaaSæœåŠ¡ï¼Œä¼‘æ¯ä¸€ä¸‹ç»§ç»­äº«å—å®ƒ:smiley:\n\n"
        },
        {
          "name": "ç¬¬äºŒç« â€”â€”ä¼ä¸šéƒ¨ç½²å®æˆ˜_K8Sã€å…¬æœ‰äº‘ç‰ˆã€‘.md",
          "type": "blob",
          "size": 84.2958984375,
          "content": "## ç¬¬äºŒç« â€”â€”ä¼ä¸šéƒ¨ç½²å®æˆ˜_K8Sã€å…¬æœ‰äº‘ç‰ˆã€‘\n\n### å‰è¨€ï¼ˆæ¨èä½¿ç”¨[æ ‡å‡†ç‰ˆ](https://github.com/ben1234560/k8s_PaaS/blob/master/%E7%AC%AC%E4%BA%8C%E7%AB%A0%E2%80%94%E2%80%94%E4%BC%81%E4%B8%9A%E9%83%A8%E7%BD%B2%E5%AE%9E%E6%88%98_K8S.md)ï¼Œå› ä¸ºå¤šæ¬¡é€‚é…è¿‡åç»­å†…å®¹ï¼‰ï¼š\n\næ³¨ï¼šå…¬æœ‰äº‘ç‰ˆæœªæµ‹è¯•æ˜¯å¦é€‚é…ç¬¬ä¸‰ç« å¾€åå†…å®¹ï¼Œç†è®ºä¸Šæ˜¯å®Œå…¨å¯è¡Œçš„ã€‚\n\n**è€ƒè™‘åˆ°éƒ¨åˆ†åŒå­¦æœºå™¨é…ç½®å¹¶æ— æ³•æ»¡è¶³å¤šå¼€VMwareï¼Œè¿™é‡Œæ¨å‡ºå…¬æœ‰äº‘ç‰ˆæœ¬ï¼ˆä»¥é˜¿é‡Œäº‘ä¸ºä¾‹ï¼‰ã€‚å¿…é¡»æœ‰æ¢¯å­ï¼ˆvpn/ç¿»å¢™ï¼‰**\n\n> **WHYï¼š**ä¸ºä»€ä¹ˆè¦æœ‰æ¢¯å­ï¼Œåé¢æˆ‘ä»¬ä¼šåˆ›å»ºä¸€äº›ç½‘ç«™ï¼Œè€Œå›½å†…åŸŸäº‘æœåŠ¡å™¨åˆ›å»ºçš„ç½‘ç«™éœ€è¦ICPå¤‡æ¡ˆï¼Œæ¯æ¬¡å¤‡æ¡ˆéƒ½éœ€è¦ç­‰å®¡æ‰¹éå¸¸éº»çƒ¦ã€‚è€Œå›½å¤–åŸŸäº‘æœåŠ¡å™¨åˆ›å»ºçš„ç½‘ç«™åˆ™ä¸éœ€è¦å¤‡æ¡ˆï¼Œç”¨èµ·æ¥éå¸¸èˆ’æœã€‚\n>\n> <img src=\"assets/WX20230511-145214@2x.png\" alt=\"image-ICPFiling\" style=\"zoom:25%;\" />\n>\n> **HOWï¼š**æ¢¯å­æ¨èlestvpn(éå¹¿å‘Šï¼Œè¿™ä¸ªä¸€ä¸ªæœˆè¦40å¤šrmbï¼Œèƒ½é€‰ä»£ç†åœ°å€æˆ‘å› ä¸ºä¹Ÿç”¨chatGPTæ‰€ä»¥å¼€äº†ï¼Œæœ‰æ›´ä¾¿å®œçš„ä¸€å®šè¦æ¨èæˆ‘ğŸ˜­ï¼Œmac/windowéƒ½æµ‹è¿‡å¯ä»¥ç”¨)\n>\n> ä¸‹è½½é“¾æ¥ï¼ˆæ¨èä½¿ç”¨æµè§ˆå™¨è®¿é—®ï¼‰ï¼šhttps://bitbucket.org/letsgogo/letsgogo_19/src/master/README.md \n>\n> å¤‡ç”¨é“¾æ¥ï¼ˆæ¨èä½¿ç”¨æµè§ˆå™¨è®¿é—®ï¼‰ï¼šhttps://github.com/LetsGo666/LetsGo_4\n>\n> å®‰è£…åæ‰“å¼€å¡«å†™æˆ‘çš„IDï¼š118149732 ä½ è¿˜èƒ½å¤šå¾—3å¤©ä¼šå‘˜ï¼ï¼ˆå¯ä»¥è·Ÿæœ‹å‹äº’ç›¸æ¨èäº’ç›¸å¾—å…è´¹å¤©æ•°ï¼‰\n\n\n\n**ç”±äºç¬¬äºŒç« éœ€è¦é…ç½®çš„å†…å®¹è¾ƒå¤šï¼Œä¸å°‘æ–°åŒå­¦å¡åœ¨è¿™é‡Œã€‚å»ºè®®é…åˆä½¿ç”¨[è½¯ä»¶åŒ…é‡Œçš„check_tool](https://github.com/ben1234560/k8s_PaaS/tree/master/%E8%BD%AF%E4%BB%B6%E5%8C%85/check_tool)è¾¹æ£€æŸ¥ï¼Œè¾¹éƒ¨ç½²**\n\n##### å¦‚æœä½ æ˜¯æ–°æ‰‹ï¼Œæœºå™¨çš„åå­—åŠå„ç§è´¦æˆ·å¯†ç ä¸€å®šè¦å’Œæˆ‘çš„ä¸€æ ·ï¼Œå…ˆå­¦ä¸€éï¼Œå†è‡ªå·±æ”¹\n\n> **WHAT**ï¼šç”¨äºç®¡ç†äº‘å¹³å°ä¸­å¤šä¸ªä¸»æœºä¸Šçš„å®¹å™¨åŒ–çš„åº”ç”¨ï¼ŒKubernetesçš„ç›®æ ‡æ˜¯è®©éƒ¨ç½²å®¹å™¨åŒ–çš„åº”ç”¨ç®€å•å¹¶ä¸”é«˜æ•ˆï¼ˆpowerfulï¼‰,Kubernetesæä¾›äº†åº”ç”¨éƒ¨ç½²ï¼Œè§„åˆ’ï¼Œæ›´æ–°ï¼Œç»´æŠ¤çš„ä¸€ç§æœºåˆ¶\n>\n> **WHY**ï¼šä¸ºä»€ä¹ˆä½¿ç”¨å®ƒï¼Œå› ä¸ºå®ƒæ˜¯ç®¡ç†dockerå®¹å™¨æœ€ä¸»æµçš„ç¼–æ’å·¥å…·\n\n- Pod\n  - Podæ˜¯K8Sé‡Œèƒ½å¤Ÿè¢«è¿è¡Œçš„æœ€å°çš„é€»è¾‘å•å…ƒï¼ˆåŸå­å•å…ƒï¼‰\n  - 1ä¸ªPodé‡Œé¢å¯ä»¥è¿è¡Œå¤šä¸ªå®¹å™¨ï¼Œå®ƒä»¬å…±äº«UTS+NET+IPCåç§°ç©ºé—´\n  - å¯ä»¥æŠŠPodç†è§£æˆè±Œè±†èšï¼Œè€ŒåŒä¸€Podå†…çš„æ¯ä¸ªå®¹å™¨æ˜¯ä¸€é¢—é¢—è±Œè±†\n  - ä¸€ä¸ªPodé‡Œè¿è¡Œå¤šä¸ªå®¹å™¨ï¼Œåˆå«è¾¹è½¦ï¼ˆSideCarï¼‰æ¨¡å¼\n- Podæ§åˆ¶å™¨ï¼ˆå…³äºæ›´å¤š<a href=\"https://github.com/ben1234560/k8s_PaaS/blob/master/%E5%8E%9F%E7%90%86%E5%8F%8A%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/Kubernetes%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5.md#%E5%88%9D%E8%AF%86pod\">åˆè¯†Pod</a>ï¼‰\n  - Podæ§åˆ¶å™¨æ˜¯Podå¯åŠ¨çš„ä¸€ç§æ¨¡æ¿ï¼Œç”¨æ¥ä¿è¯åœ¨K8Sé‡Œå¯åŠ¨çš„Podå§‹ç»ˆæŒ‰ç…§äººä»¬çš„é¢„æœŸè¿è¡Œï¼ˆå‰¯æœ¬æ•°ã€ç”Ÿå‘½å‘¨æœŸã€å¥åº·çŠ¶æ€æ£€æŸ¥...ï¼‰\n  - Podå†…æä¾›äº†ä¼—å¤šçš„Podæ§åˆ¶å™¨ï¼Œå¸¸ç”¨çš„æœ‰ä»¥ä¸‹å‡ ç§ï¼š\n    - Deployment\n    - DaemonSet\n    - ReplicaSet\n    - StatefulSet\n    - Job\n    - Cronjob\n- Name\n  - ç”±äºK8Så†…éƒ¨ï¼Œä½¿ç”¨â€œèµ„æºâ€æ¥å®šä¹‰æ¯ä¸€ç§é€»è¾‘æ¦‚å¿µï¼ˆåŠŸèƒ½ï¼‰ï¼Œæ•…æ¯ç§â€œèµ„æºâ€ï¼Œéƒ½åº”è¯¥æœ‰è‡ªå·±çš„â€œåç§°â€\n  - â€œèµ„æºâ€æœ‰apiç‰ˆæœ¬ï¼ˆapiVersionï¼‰ç±»åˆ«ï¼ˆkindï¼‰ã€å…ƒæ•°æ®ï¼ˆmetadataï¼‰ã€å®šä¹‰æ¸…å•ï¼ˆspecï¼‰ã€çŠ¶æ€ï¼ˆstatusï¼‰ç­‰é…ç½®ä¿¡æ¯\n  - â€œåç§°â€é€šå¸¸å®šä¹‰åœ¨â€œèµ„æºâ€çš„â€œå…ƒæ•°æ®â€ä¿¡æ¯é‡Œ\n- <a href=\"https://github.com/ben1234560/k8s_PaaS/blob/master/%E5%8E%9F%E7%90%86%E5%8F%8A%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/Docker%E5%9F%BA%E7%A1%80.md#%E5%85%B3%E4%BA%8Enamespace\">namespace</a>\n  - éšç€é¡¹ç›®å¢å¤šã€äººå‘˜å¢åŠ ã€é›†ç¾¤è§„æ¨¡çš„æ‰©å¤§ï¼Œéœ€è¦ä¸€ç§èƒ½å¤Ÿéš”ç¦»K8Så†…å„ç§â€œèµ„æºâ€çš„æ–¹æ³•ï¼Œè¿™å°±æ˜¯åç§°ç©ºé—´\n  - åç§°ç©ºé—´å¯ä»¥ç†è§£ä¸ºK8Så†…éƒ¨çš„è™šæ‹Ÿé›†ç¾¤ç»„\n  - ä¸åŒåç§°ç©ºé—´å†…çš„â€œèµ„æºâ€åç§°å¯ä»¥ç›¸åŒï¼Œç›¸åŒåç§°ç©ºé—´å†…çš„åŒç§â€œèµ„æºâ€ã€â€œåç§°â€ä¸èƒ½ç›¸åŒ\n  - åˆç†çš„ä½¿ç”¨K8Såç§°ç©ºé—´ï¼Œä½¿å¾—é›†ç¾¤ç®¡ç†å‘˜èƒ½å¤Ÿæ›´å¥½çš„å¯¹äº¤ä»˜åˆ°K8Sé‡Œçš„æœåŠ¡è¿›è¡Œåˆ†ç±»ç®¡ç†å’Œæµè§ˆ\n  - K8Så†…é»˜è®¤å­˜åœ¨çš„åç§°ç©ºé—´æœ‰ï¼šdefaultã€kube-systemã€kube-public\n  - æŸ¥è¯¢K8Sé‡Œç‰¹å®šâ€œèµ„æºâ€è¦å¸¦ä¸Šç›¸åº”çš„åç§°ç©ºé—´\n- Label\n  - æ ‡ç­¾æ˜¯K8Sç‰¹è‰²çš„ç®¡ç†æ–¹å¼ï¼Œä¾¿äºåˆ†ç±»ç®¡ç†èµ„æºå¯¹è±¡\n  - ä¸€ä¸ªæ ‡ç­¾å¯ä»¥å¯¹åº”å¤šä¸ªèµ„æºï¼Œä¸€ä¸ªèµ„æºä¹Ÿå¯ä»¥æœ‰å¤šä¸ªæ ‡ç­¾ï¼Œå®ƒä»¬æ˜¯å¤šå¯¹å¤šçš„å…³ç³»\n  - ä¸€ä¸ªèµ„æºæ‹¥æœ‰å¤šä¸ªæ ‡ç­¾ï¼Œå¯ä»¥å®ç°ä¸åŒç»´åº¦çš„ç®¡ç†\n  - æ ‡ç­¾çš„ç»„æˆï¼škey=value\n  - ä¸æ ‡ç­¾ç±»ä¼¼çš„ï¼Œè¿˜æœ‰ä¸€ç§â€œæ³¨è§£â€ï¼ˆannotationsï¼‰\n- Labelé€‰æ‹©å™¨\n  - ç»™èµ„æºæ‰“ä¸Šæ ‡ç­¾åï¼Œå¯ä»¥ä½¿ç”¨æ ‡ç­¾é€‰æ‹©å™¨è¿‡æ»¤æŒ‡å®šçš„æ ‡ç­¾\n  - æ ‡ç­¾é€‰æ‹©å™¨ç›®å‰æœ‰ä¸¤ä¸ªï¼šåŸºäºç­‰å€¼å…³ç³»ï¼ˆç­‰äºã€ä¸ç­‰äºï¼‰å’ŒåŸºäºé›†åˆå…³ç³»ï¼ˆå±äºã€ä¸å±äºã€å­˜åœ¨ï¼‰\n  - è®¸å¤šèµ„æºæ”¯æŒå†…åµŒæ ‡ç­¾é€‰æ‹©å™¨å­—æ®µ\n    - matchLabels\n    - matchExpressions\n- Service\n  - åœ¨K8Sçš„ä¸–ç•Œé‡Œï¼Œè™½ç„¶æ¯ä¸ªPodéƒ½ä¼šè¢«åˆ†é…ä¸€ä¸ªå•ç‹¬çš„IPåœ°å€ï¼Œä½†è¿™ä¸ªIPåœ°å€ä¼šéšç€Podçš„é”€æ¯è€Œæ¶ˆå¤±\n  - Serviceï¼ˆæœåŠ¡ï¼‰å°±æ˜¯ç”¨æ¥è§£å†³è¿™ä¸ªé—®é¢˜çš„æ ¸å¿ƒæ¦‚å¿µ\n  - ä¸€ä¸ªServiceå¯ä»¥çœ‹ä½œä¸€ç»„æä¾›ç›¸åŒæœåŠ¡çš„Podçš„å¯¹å¤–è®¿é—®æ¥å£\n  - Serviceä½œç”¨ä¸å“ªäº›Podæ˜¯é€šè¿‡æ ‡ç­¾é€‰æ‹©å™¨æ¥å®šä¹‰çš„\n- Ingress\n  - Ingressæ˜¯K8Sé›†ç¾¤é‡Œå·¥ä½œåœ¨OSIç½‘ç»œå‚è€ƒæ¨¡å‹ä¸‹ï¼Œç¬¬7å±‚çš„åº”ç”¨ï¼Œå¯¹å¤–æš´éœ²çš„æ¥å£\n  - Serviceåªèƒ½è¿›è¡ŒL4æµé‡è°ƒåº¦ï¼Œè¡¨ç°å½¢å¼æ˜¯ip+port\n  - Ingressåˆ™å¯ä»¥è°ƒåº¦ä¸åŒä¸šåŠ¡åŸŸã€ä¸åŒURLè®¿é—®è·¯å¾„çš„ä¸šåŠ¡æµé‡\n\nç®€å•ç†è§£ï¼šPodå¯è¿è¡Œçš„åŸå­ï¼Œnameå®šä¹‰åå­—ï¼Œnamespaceåç§°ç©ºé—´ï¼ˆæ”¾ä¸€å †åå­—ï¼‰ï¼Œlabelæ ‡ç­¾ï¼ˆå¦å¤–çš„åå­—ï¼‰ï¼Œserviceæä¾›æœåŠ¡ï¼Œingressé€šä¿¡\n\n### K8Sæ¶æ„å›¾ï¼ˆå¹¶éä¼ ç»Ÿæ„ä¹‰ä¸Šçš„PaaSæœåŠ¡ï¼Œè€Œæ˜¯IaaSæœåŠ¡ï¼‰\n\n![1582188308711](assets/1582188308711.png)\n\n> **kubectl**ï¼šKubernetesé›†ç¾¤çš„å‘½ä»¤è¡Œæ¥å£\n>\n> **API Server**ï¼šçš„æ ¸å¿ƒåŠŸèƒ½æ˜¯å¯¹æ ¸å¿ƒå¯¹è±¡ï¼ˆä¾‹å¦‚ï¼šPodï¼ŒServiceï¼ŒRCï¼‰çš„å¢åˆ æ”¹æŸ¥æ“ä½œï¼ŒåŒæ—¶ä¹Ÿæ˜¯é›†ç¾¤å†…æ¨¡å—ä¹‹é—´æ•°æ®äº¤æ¢çš„æ¢çº½\n>\n> **Etcd**ï¼šåŒ…å«åœ¨ APIServer ä¸­ï¼Œç”¨æ¥å­˜å‚¨èµ„æºä¿¡æ¯\n>\n> **Controller Manager **ï¼šè´Ÿè´£ç»´æŠ¤é›†ç¾¤çš„çŠ¶æ€ï¼Œæ¯”å¦‚æ•…éšœæ£€æµ‹ã€è‡ªåŠ¨æ‰©å±•ã€æ»šåŠ¨æ›´æ–°ç­‰\n>\n> **Scheduler**ï¼šè´Ÿè´£èµ„æºçš„è°ƒåº¦ï¼ŒæŒ‰ç…§é¢„å®šçš„è°ƒåº¦ç­–ç•¥å°†Podè°ƒåº¦åˆ°ç›¸åº”çš„æœºå™¨ä¸Šã€‚å¯ä»¥é€šè¿‡è¿™äº›æœ‰æ›´æ·±çš„äº†è§£ï¼š\n>\n> - <a href=\"https://github.com/ben1234560/k8s_PaaS/blob/master/%E5%8E%9F%E7%90%86%E5%8F%8A%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/Kubernetes%E8%B0%83%E5%BA%A6%E6%9C%BA%E5%88%B6.md\">Kubernetesè°ƒåº¦æœºåˆ¶</a>\n> - <a href=\"https://github.com/ben1234560/k8s_PaaS/blob/master/%E5%8E%9F%E7%90%86%E5%8F%8A%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/Kubernetes%E8%B0%83%E5%BA%A6%E6%9C%BA%E5%88%B6.md#kubernetes%E7%9A%84%E8%B5%84%E6%BA%90%E6%A8%A1%E5%9E%8B%E4%B8%8E%E8%B5%84%E6%BA%90%E7%AE%A1%E7%90%86\">Kubernetesçš„èµ„æºæ¨¡å‹ä¸èµ„æºç®¡ç†</a>\n> - <a href=\"https://github.com/ben1234560/k8s_PaaS/blob/master/%E5%8E%9F%E7%90%86%E5%8F%8A%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/Kubernetes%E8%B0%83%E5%BA%A6%E6%9C%BA%E5%88%B6.md#kubernetes%E9%BB%98%E8%AE%A4%E7%9A%84%E8%B0%83%E5%BA%A6%E7%AD%96%E7%95%A5\">Kubernetesé»˜è®¤çš„è°ƒåº¦ç­–ç•¥</a>\n> - <a href=\"https://github.com/ben1234560/k8s_PaaS/blob/master/%E5%8E%9F%E7%90%86%E5%8F%8A%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/Kubernetes%E8%B0%83%E5%BA%A6%E6%9C%BA%E5%88%B6.md#%E8%B0%83%E5%BA%A6%E5%99%A8%E7%9A%84%E4%BC%98%E5%85%88%E7%BA%A7%E4%B8%8E%E5%BC%BA%E5%88%B6%E6%9C%BA%E5%88%B6\">è°ƒåº¦å™¨çš„ä¼˜å…ˆçº§ä¸å¼ºåˆ¶æœºåˆ¶</a>\n>\n> **kube-proxy**ï¼šè´Ÿè´£ä¸ºServiceæä¾›clusterå†…éƒ¨çš„æœåŠ¡å‘ç°å’Œè´Ÿè½½å‡è¡¡\n>\n> **Kubelet**ï¼šåœ¨Kubernetesä¸­ï¼Œåº”ç”¨å®¹å™¨å½¼æ­¤æ˜¯éš”ç¦»çš„ï¼Œå¹¶ä¸”ä¸è¿è¡Œå…¶çš„ä¸»æœºä¹Ÿæ˜¯éš”ç¦»çš„ï¼Œè¿™æ˜¯å¯¹åº”ç”¨è¿›è¡Œç‹¬ç«‹è§£è€¦ç®¡ç†çš„å…³é”®ç‚¹ã€‚[Kubeletå·¥ä½œåŸç†è§£æ](https://github.com/ben1234560/k8s_PaaS/blob/master/%E5%8E%9F%E7%90%86%E5%8F%8A%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/Kubernetes%E8%B0%83%E5%BA%A6%E6%9C%BA%E5%88%B6.md#kubelet)\n>\n> **Node**ï¼šè¿è¡Œå®¹å™¨åº”ç”¨ï¼Œç”±Masterç®¡ç†\n\n### æˆ‘ä»¬éƒ¨ç½²çš„K8Sæ¶æ„å›¾\n\n![1584700891603](assets/1584700891603.png)\n\n> å¯ä»¥ç®€å•ç†è§£æˆï¼š\n>\n> 11æœºå™¨ï¼šåå‘ä»£ç†\n>\n> 12æœºå™¨ï¼šåå‘ä»£ç†\n>\n> 21æœºå™¨ï¼šä¸»æ§+è¿ç®—èŠ‚ç‚¹ï¼ˆå³æœåŠ¡ç¾¤éƒ½æ˜¯è·‘åœ¨21å’Œ22ä¸Šï¼‰\n>\n> 22æœºå™¨ï¼šä¸»æ§+è¿ç®—èŠ‚ç‚¹ï¼ˆç”Ÿäº§ä¸Šæˆ‘ä»¬ä¼šæŠŠä¸»æ§å’Œè¿ç®—åˆ†å¼€ï¼‰\n>\n> 200æœºå™¨ï¼šè¿ç»´ä¸»æœºï¼ˆæ”¾å„ç§æ–‡ä»¶èµ„æºï¼‰\n>\n> è¿™æ ·æ§èŠ‚ç‚¹æœ‰ä¸¤ä¸ªï¼Œè¿ç®—èŠ‚ç‚¹æœ‰ä¸¤ä¸ªï¼Œå°±æ˜¯å°å‹çš„åˆ†å¸ƒå¼ï¼Œç°åœ¨ä½ å¯èƒ½æ²¡åŠæ³•ç†è§£è¿™äº›å†…å®¹ï¼Œæˆ‘ä»¬æ¥ç€åšä¸‹å»ï¼Œæ…¢æ…¢çš„ï¼Œä½ å°±ç†è§£äº†\n>\n> è¿™æ˜¯ç†è®ºä¸Šçš„æ¶æ„ï¼Œè€ƒè™‘åˆ°å…¬æœ‰äº‘å¯¹ç½‘ç»œçš„é™åˆ¶ç­‰é—®é¢˜ï¼ˆå¦‚ipv6ä¸èƒ½éšæ„å¢åŠ ï¼‰ï¼Œ21ã€22æœºå™¨ä¹Ÿä¼šè¿½åŠ åå‘ä»£ç†ã€‚\n\n### å®éªŒæœºå™¨å®‰è£…è¯¦è§£\n\næˆ‘ä»¬å°†ç”³è¯·5ä¸ªèŠ‚ç‚¹ï¼Œå¦‚ä¸‹å›¾\n\n|      | æ•´ä½“  | 11æœºå™¨ | 12æœºå™¨ | 21æœºå™¨ | 22æœºå™¨ | 200æœºå™¨ |\n| ---- | ----- | ------ | ------ | ------ | ------ | ------- |\n| ä½é… | 4C32G | 2C2G   | 2C2G   | 2C8G   | 2C8G   | 2C2G    |\n| æ ‡é… | 8C64G | 2C4G   | 2C4G   | 2C16G  | 2C16G  | 2C2G    |\n\n> ä½é…èƒ½å¤Ÿæ»¡è¶³Jenkinsä¹‹å‰çš„å†…å®¹ï¼Œåšåˆ°Jenkinsçš„æ—¶å€™å°±å·²ç»å¾ˆå¡äº†ï¼Œåˆ°æ—¶å€™å†è¿½åŠ è´­ä¹°æ–°çš„é…ç½®ï¼Œå½“ç„¶ä¹Ÿå¯ä»¥ç›´æ¥è´­ä¹°æ ‡é…ï¼Œå‰æœŸæˆ‘è¿˜æ˜¯å¸Œæœ›å„ä½èƒ½åœ¨ç†è§£ä¸ŠèŠ±äº›æ—¶é—´ï¼Œæ…¢æ…¢çš„æ“ä½œï¼Œå¦åˆ™æŠ¥é”™éƒ½ä¸çŸ¥é“æ€ä¹ˆè§£å†³\n\n### å¦‚ä½•è´­ä¹°å…¬æœ‰äº‘æœºå™¨ï¼ˆä»¥é˜¿é‡Œäº‘ä¸ºä¾‹ï¼‰\n\n> æ³¨ï¼šæœªé€‰çš„åˆ™æ˜¯é»˜è®¤é€‰é¡¹ã€‚\n\nå¦‚ä¸‹å›¾ï¼Œé€‰æ‹©â€œè‡ªå®šä¹‰è´­ä¹°â€ã€â€œæŠ¢å å¼å®ä¾‹â€ï¼ˆè¿™é‡Œä½¿ç”¨æŠ¢å å¼å³å¯/çœé’±ï¼Œæ‹…å¿ƒè¢«å›æ”¶çš„å¯ä»¥é€‰æ‹©æŒ‰é‡ä»˜è´¹ï¼‰ã€â€œæ–°åŠ å¡â€æˆ–å…¶å®ƒå¤–ç½‘æœåŠ¡å™¨åœ°åŸŸï¼ˆå¤–ç½‘æœåŠ¡å™¨ï¼Œæ–¹ä¾¿åç»­ä½¿ç”¨ç½‘ç«™ç­‰æ—¶ä¸éœ€è¦å¤‡æ¡ˆ/æœ€å¥½å‡†å¤‡ä¸ªæ¢¯å­ï¼Œä½œä¸ºä¸€ä¸ªç¨‹åºå‘˜æ¢¯å­æ˜¯å¿…å¤‡çš„ï¼‰ã€â€œå¯ç”¨åŒºâ€ï¼ˆå¿…é¡»é€‰æ‹©å…¶ä¸­ä¸€ä¸ªå¦‚æˆ‘é€‰çš„å¯ç”¨åŒºBï¼Œä¸èƒ½éšæœºåˆ†é…ï¼Œå¦åˆ™å¤šå°æœºå™¨çš„å†…ç½‘ipä¸ä¸€è‡´ï¼‰\n\n![image-è´­ä¹°äº‘æœåŠ¡å™¨](assets/WX20230511-144757@2x.png)\n\n> **WHYï¼š**ä¸ºä»€ä¹ˆé€‰æ–°åŠ å¡ï¼Œå› ä¸ºæˆ‘çš„æ¢¯å­å¯ä»¥åˆ°æ–°åŠ å¡ï¼Œä½ é€‰ä½ èƒ½ä»£ç†çš„å¤–ç½‘åœ°å€å³å¯\n>\n> <img src=\"assets/WX20230511-150425@2x.png\" alt=\"image-æ¢¯å­ä»£ç†åœ°å€\" style=\"zoom:33%;\" align=\"left\"/>\n\né€‰æ‹©â€œå…±äº«å‹â€ï¼ˆä¹Ÿå¯ä»¥é€‰æ‹©é€šç”¨å‹ï¼Œå…±äº«å‹ä¼šæ›´ä¾¿å®œï¼‰ã€é€‰æ‹©2æ ¸8Gå†…å­˜çš„é…ç½®ï¼Œ\n\n![image-é€‰æ‹©æœºå™¨é…ç½®](assets/WX20230511-150009@2x.png)\n\né€‰æ‹©CentOSï¼Œ7.6ç‰ˆæœ¬\n\n![image-é€‰æ‹©ç³»ç»Ÿç‰ˆæœ¬](assets/WX20230511-150553@2x.png)\n\nç½‘ç»œåˆ†é…å…¬ç½‘IPv4åœ°å€ï¼Œé»˜è®¤é€‰æ‹©ï¼Œå…¶å®ƒä¸å˜ï¼Œè¿™æ ·åˆ›å»ºä¸‹æ¥çš„æœåŠ¡å™¨æ˜¯å…¬ç”¨åŒä¸€å®‰å…¨ç»„é…ç½®ï¼Œå¦‚æœé’±å…è®¸çš„è¯æŠŠç½‘é€Ÿå¼€åˆ°æœ€å¤§\n\né€‰æ‹©â€œè‡ªå®šä¹‰å¯†ç â€œï¼Œå»ºè®®è®¾ç½®ç›¸å¯¹å¤æ‚çš„å¯†ç ï¼Œå¦‚åŒ…å«å¤§å°å†™ï¼Œå¦åˆ™å®¹æ˜“è¢«æ”»ç ´ä½¿ç”¨\n\n![image-è‡ªå®šä¹‰å¯†ç ](assets/WX20230511-150737@2x.png)\n\næœ€ç»ˆè®¢å•å†…å®¹ï¼Œæ³¨æ„æ˜¯5å°2C8Gï¼Œä¸€å°æ—¶ä»…éœ€0.2\n\n![image-ç»“ç®—é¡µé¢](assets/WX20230511-150820@2x.png)\n\nè´­ä¹°å®Œæˆåçš„å†…å®¹ï¼Œå»ºè®®ç»™æ¯ä¸ªå®ä¾‹è®¾ç½®èŠ‚ç‚¹å«ä¹‰ï¼Œå¦‚ä¸‹å›¾çš„k8s_11ã€k8s_12\n\n![image-å®ä¾‹åˆ—è¡¨](/Users/xueweiguo/Desktop/GitHub/k8s_PaaS/assets/WX20230511-151455@2x.png)\n\nå¦‚ä¸‹æ˜¯æˆ‘çš„å†…ç½‘åŠèŠ‚ç‚¹å¯¹åº”æƒ…å†µ\n\n> |        | 11æœºå™¨         | 12æœºå™¨         | 21æœºå™¨         | 22æœºå™¨         | 200æœºå™¨        |\n> | ------ | -------------- | -------------- | -------------- | -------------- | -------------- |\n> | å†…ç½‘ip | 172.27.139.122 | 172.27.139.119 | 172.27.139.118 | 172.27.139.120 | 172.27.139.121 |\n>\n> å¯ä»¥çœ‹åˆ°ç½‘æ®µåœ¨172.27.139.0/254ï¼Œæˆ‘çš„11æœºå™¨å†…ç½‘ipæ˜¯172.27.139.122ï¼Œåç»­å°†ä¼šæŒç»­ç”¨åˆ°ï¼Œä½ éœ€è¦å¡«æˆä½ è‡ªå·±çš„11æœºå™¨å†…ç½‘ip\n\n### æœºå™¨å‰æœŸå‡†å¤‡\n\nä½¿ç”¨xshellæˆ–è€…è‡ªé€‰çš„shellè¿æ¥å·¥å…·ï¼Œ[xshellä¸‹è½½](https://xshell.en.softonic.com/download)\n\n> å½“ç„¶æˆ‘ä¹Ÿæœ‰æä¾›è½¯ä»¶åŒ…ï¼šhttps://pan.baidu.com/s/1mkIzua1XQmew240XBbvuFA æå–ç ï¼š7p6h ã€‚é‡Œé¢è¿˜æœ‰Xftpï¼Œæ˜¯ç”¨æ¥è¿›è¡Œæœ¬åœ°ç”µè„‘å’Œè™šæ‹Ÿæœºçš„æ–‡ä»¶ä¼ è¾“\n\n~~~\n# å…¨éƒ¨æœºå™¨ï¼ŒæŸ¥çœ‹enforceæ˜¯å¦å…³é—­ï¼Œç¡®ä¿disabledçŠ¶æ€ï¼Œå½“ç„¶å¯èƒ½æ²¡æœ‰è¿™ä¸ªå‘½ä»¤\n~]# getforce\n# æŸ¥çœ‹å†…æ ¸ç‰ˆæœ¬ï¼Œç¡®ä¿åœ¨3.8ä»¥ä¸Šç‰ˆæœ¬\n~]# uname -a\n# å…³é—­firewalld\n~]# systemctl stop firewalld\n# å®‰è£…epelæºåŠç›¸å…³å·¥å…·\n~]# yum install epel-release wget net-tools telnet tree nmap sysstat lrzsz dos2unix bind-utils yum-utils ntpd -y\n# æ£€æŸ¥æ˜¯å¦å®‰è£…æˆåŠŸ\n~]# rpm -q epel-release wget net-tools telnet tree nmap sysstat lrzsz dos2unix bind-utils yum-utils ntpd\n# out:\nepel-release-7-14.noarch\nwget-1.14-18.el7_6.1.x86_64\nnet-tools-2.0-0.25.20131004git.el7.x86_64\ntelnet-0.17-66.el7.x86_64\ntree-1.6.0-10.el7.x86_64\nnmap-6.40-19.el7.x86_64\nsysstat-10.1.5-20.el7_9.x86_64\nlrzsz-0.12.20-36.el7.x86_64\ndos2unix-6.0.3-7.el7.x86_64\nbind-utils-9.11.4-26.P2.el7_9.13.x86_64\nyum-utils-1.1.31-54.el7_8.noarch\n~~~\n\n> **uname**:æ˜¾ç¤ºç³»ç»Ÿä¿¡æ¯\n>\n> - **-a/-all**ï¼šæ˜¾ç¤ºå…¨éƒ¨\n>\n> **yum**ï¼šæä¾›äº†æŸ¥æ‰¾ã€å®‰è£…ã€åˆ é™¤æŸä¸€ä¸ªã€ä¸€ç»„ç”šè‡³å…¨éƒ¨è½¯ä»¶åŒ…çš„å‘½ä»¤\n>\n> - **install**ï¼šå®‰è£…\n> - **-y**ï¼šå½“å®‰è£…è¿‡ç¨‹æç¤ºé€‰æ‹©å…¨éƒ¨ä¸º\"yes\"\n\n<img src=\"assets/WX20230511-152710@2x.png\">\n\nåç»­ä»£ç†åï¼Œyumå®‰è£…ä¼šå‡ºç°ç½‘ç»œç­‰é—®é¢˜ï¼Œä¸ºäº†å‡å°‘å¤„ç†çš„æ—¶é—´ï¼Œæˆ‘ä»¬æå‰ä¸‹è½½\n\n~~~\n# å…¨éƒ¨æœºå™¨ï¼Œå®‰è£…åç»­éœ€è¦çš„æœåŠ¡å·¥å…·ï¼Œä¸å¯åŠ¨åˆ™ä¸ä¼šæœ‰å½±å“ï¼ˆæˆ‘å°±ä¸åŒºåˆ†æ¯ä¸ªæœºå™¨æ‰€éœ€çš„äº†ï¼Œåé¢ä¼šçœ‹åˆ°ï¼‰\n# è¿½åŠ dockerçš„repoæº\n~]# yum-config-manager --add-repo http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo\n# å®‰è£…åç»­æ‰€éœ€çš„è½¯ä»¶åŒ…\n~]# yum install supervisor docker-compose nginx nginx-mod-stream supervisor keepalived deltarpm docker-ce ipvsadm -y\n# æ£€æŸ¥å®‰è£…æƒ…å†µ\n~]# rpm -q supervisor docker-compose nginx nginx-mod-stream ipvsadm \n# out:\nsupervisor keepalived deltarpm docker-ce\nsupervisor-3.4.0-1.el7.noarch\ndocker-compose-1.18.0-4.el7.noarch\nnginx-1.20.1-10.el7.x86_64\nnginx-mod-stream-1.20.1-10.el7.x86_64\nsupervisor-3.4.0-1.el7.noarch\nkeepalived-1.3.5-19.el7.x86_64\ndeltarpm-3.6-3.el7.x86_64\ndocker-ce-23.0.6-1.el7.x86_64\n~~~\n\nåç»­ç« èŠ‚éœ€è¦ç”¨åˆ°çš„ï¼ˆå¯åç»­å†è£…ï¼‰\n\n~~~\n# å…¨éƒ¨æœºå™¨\n# ç¬¬ä¸‰ç« \n~]# yum install -y iptables-services\n# ç¬¬å››ç« \n~]# yum install -y openssl\n# ç¬¬äº”ç« \n~]# yum install -y java-1.8.0-openjdk*\n~]# yum install curl policycoreutils openssh-server openssh-clients policycoreutils-python -y\n\n# å…¨éƒ¨ä¸€èµ·ä¸‹è½½\n~]# yum install -y iptables-services openssl policycoreutils openssh-server openssh-clients policycoreutils-python java-1.8.0-openjdk*\n# æ£€æŸ¥å®‰è£…æƒ…å†µ\n~]# rpm -q iptables-services openssl java-1.8.0-openjdk-javadoc-zip java-1.8.0-openjdk-headless java-1.8.0-openjdk-devel java-1.8.0-openjdk-src java-1.8.0-openjdk-accessibility java-1.8.0-openjdk-demo java-1.8.0-openjdk java-1.8.0-openjdk-javadoc curl policycoreutils openssh-server openssh-clients policycoreutils-python\n~~~\n\né…ç½®æœºå™¨ååŠç½‘ç»œ\n\n~~~\n# å…¨éƒ¨æœºå™¨ï¼Œè®¾ç½®åå­—ï¼Œ11æ˜¯hdss7-11,12æ˜¯hdss7-12,ä»¥æ­¤ç±»æ¨\n~]# hostnamectl set-hostname hdss7-11.host.com\n~]# exit\n# ä¸‹é¢çš„ä¿®æ”¹ï¼Œ11æœºå™¨å¯¹åº”11æœºå™¨çš„å†…ç½‘ipï¼Œ12å¯¹åº”12æœºå™¨çš„å†…ç½‘ipï¼Œä»¥æ­¤ç±»æ¨å…±ä¸¤å¤„ï¼šIPADDRã€GATEWAY\n~]# vi /etc/sysconfig/network-scripts/ifcfg-eth0\nDEVICE=eth0\nBOOTPROTO=dhcp\nONBOOT=yes\nIPADDR=172.27.139.122\nGATEWAY=172.27.139.254\nNETMASK=255.255.255.0\nTYPE=Ethernet\nPROXY_METHOD=none\nBROWSER_ONLY=no\nDEFROUTE=yes\nIPV4_FAILURE_FATAL=no\nIPV6INIT=yes\nIPV6_AUTOCONF=yes\nIPV6_DEFROUTE=yes\nIPV6_FAILURE_FATAL=no\nIPV6_ADDR_GEN_MODE=stable-privacy\nNAME=eth0\nDEVICE=eth0\nIPV6_PEERNDS=yes\nIPV6_PEERROUTES=yes\nIPV6_PRIUACY=no\n\n~]# systemctl restart network\n# ç»“æŸpingå‘½ä»¤ç”¨ctrl+c(control+c)ï¼Œç”¨äºå‘é€ä¸­æ–­ä¿¡å·ç»™å½“å‰æ­£åœ¨è¿è¡Œçš„è¿›ç¨‹\n~]# ping baidu.com\n~~~\n\n> **ifcfg-eth0**ï¼šæœ‰äº›äººçš„æœºå™¨å¯èƒ½æ˜¯ifcfg-esn33ã€‚ä½¿ç”¨ifconfigæŸ¥çœ‹ï¼Œå‘½ä»¤è¾“å‡ºä¸­æ¯ä¸ªç½‘å¡æ¥å£éƒ½æœ‰ä¸€ä¸ªåç§°ï¼Œä¾‹å¦‚ \"eth0\"ã€\"ens33\" ç­‰\n>\n> **systemctl restart**ï¼šé‡å¯æŸä¸ªæœåŠ¡\n>\n> **ping**ï¼šç”¨äºæµ‹è¯•ç½‘ç»œè¿æ¥é‡çš„ç¨‹åº\n>\n> å…¬æœ‰äº‘ï¼ˆé˜¿é‡Œï¼‰çš„ifcfg-eth0åŸå†…å®¹å¦‚ä¸‹ï¼š\n>\n> DEVICE=eth0\n> BOOTPROTO=dhcp\n> ONBOOT=yes\n\n<img src=\"assets/WX20230511-152352@2x.png\" >\n\n\n\n### K8Så‰ç½®å‡†å¤‡å·¥ä½œâ€”â€”bind9å®‰è£…éƒ¨ç½²ï¼ˆDNSæœåŠ¡ï¼‰\n\n> **WHAT**ï¼šDNSï¼ˆåŸŸåç³»ç»Ÿï¼‰è¯´ç™½äº†ï¼Œå°±æ˜¯æŠŠä¸€ä¸ªåŸŸå’ŒIPåœ°å€åšäº†ä¸€ä¸‹ç»‘å®šï¼Œå¦‚ä½ åœ¨é‡Œæœºå™¨é‡Œé¢è¾“å…¥ nslookup www.qq.comï¼Œå‡ºæ¥çš„Addressæ˜¯ä¸€å †IPï¼ŒIPæ˜¯ä¸å®¹æ˜“è®°çš„ï¼Œæ‰€ä»¥DNSè®©IPå’ŒåŸŸååšä¸€ä¸‹ç»‘å®šï¼Œè¿™æ ·ä½ è¾“å…¥åŸŸåå°±å¯ä»¥äº†\n>\n> **WHY**ï¼šæˆ‘ä»¬è¦ç”¨ingressï¼Œåœ¨K8Sé‡Œè¦åš7å±‚è°ƒåº¦ï¼Œè€Œä¸”æ— è®ºå¦‚ä½•éƒ½è¦ç”¨åŸŸåï¼ˆå¦‚ä¹‹å‰çš„é‚£ä¸ªç™¾åº¦é¡µé¢çš„åŸŸåï¼Œé‚£ä¸ªæ˜¯hostçš„æ–¹å¼ï¼‰ï¼Œä½†æ˜¯é—®é¢˜æ˜¯æˆ‘ä»¬æ€ä¹ˆç»™K8Sé‡Œçš„å®¹å™¨ç»‘hostï¼Œæ‰€ä»¥æˆ‘ä»¬å¿…é¡»åšä¸€ä¸ªDNSï¼Œç„¶åå®¹å™¨æœä»æˆ‘ä»¬çš„DNSè§£æè°ƒåº¦\n\n~~~\n# åœ¨11æœºå™¨ï¼š\n~]# yum install bind -y\n~]# rpm -qa bind\n# out: bind-9.11.4-9.P2.el7.x86_64\n# é…ç½®ä¸»é…ç½®æ–‡ä»¶ï¼Œ11æœºå™¨\n~]# vi /etc/named.conf\nlisten-on port 53 { 172.27.139.122; };  # åŸæœ¬æ˜¯127.0.0.1ï¼Œæˆ‘çš„11å†…ç½‘ipæ˜¯172.29.238.166ï¼Œä½ å¡«ä½ çš„11å†…ç½‘ip\n# listen-on-v6 port 53 { ::1; };  # éœ€è¦åˆ æ‰\nallow-query     { any; };  # åŸæœ¬æ˜¯localhost\nforwarders      { 172.27.139.254; };  #å¦å¤–æ·»åŠ çš„\ndnssec-enable no;  # åŸæœ¬æ˜¯yes\ndnssec-validation no;  # åŸæœ¬æ˜¯yes\n\n# æ£€æŸ¥ä¿®æ”¹æƒ…å†µï¼Œæ²¡æœ‰æŠ¥é”™å³å¯ï¼ˆå³æ²¡æœ‰ä¿¡æ¯ï¼‰\n~]# named-checkconf\n~~~\n\n> **rpm**ï¼šè½¯ä»¶åŒ…ç®¡ç†å™¨\n>\n> - **-qa**ï¼šæŸ¥çœ‹å·²å®‰è£…çš„æ‰€æœ‰è½¯ä»¶åŒ…\n>\n> **rpmå’Œyumå®‰è£…çš„åŒºåˆ«**ï¼šå‰è€…ä¸æ£€æŸ¥ç›¸ä¾æ€§é—®é¢˜ï¼Œåè€…æ£€æŸ¥ï¼ˆå³ç›¸å…³ä¾èµ–åŒ…ï¼‰\n>\n> **named.confæ–‡ä»¶å†…å®¹è§£æï¼š**\n>\n> - **listen-on**ï¼šç›‘å¬ç«¯å£ï¼Œæ”¹ä¸ºç›‘å¬åœ¨å†…ç½‘ï¼Œè¿™æ ·å…¶å®ƒæœºå™¨ä¹Ÿå¯ä»¥ç”¨\n> - **allow-query**ï¼šå“ªäº›å®¢æˆ·ç«¯èƒ½é€šè¿‡è‡ªå»ºçš„DNSæŸ¥\n> - **forwarders**ï¼šä¸Šçº§DNSæ˜¯ä»€ä¹ˆ\n\n<img src=\"assets/WX20230511-153237@2x.png\"  />\n\n\n\n~~~\n# 11æœºå™¨ï¼Œç»éªŒï¼šä¸»æœºåŸŸä¸€å®šå¾—è·Ÿä¸šåŠ¡æ˜¯ä¸€ç‚¹å…³ç³»éƒ½æ²¡æœ‰ï¼Œå¦‚host.comï¼Œè€Œä¸šåŠ¡ç”¨çš„æ˜¯od.comï¼Œå› ä¸ºä¸šåŠ¡éšæ—¶å¯èƒ½å˜\n# åŒºåŸŸé…ç½®æ–‡ä»¶ï¼ŒåŠ åœ¨æœ€ä¸‹é¢ï¼Œéœ€è¦ä¿®æ”¹ä¸¤å¤„ï¼šallow-updateä¸º11æœºå™¨ip\n~]# vi /etc/named.rfc1912.zones\nzone \"host.com\" IN {\n        type  master;\n        file  \"host.com.zone\";\n        allow-update { 172.27.139.122; };\n};\n\nzone \"od.com\" IN {\n        type  master;\n        file  \"od.com.zone\";\n        allow-update { 172.27.139.122; };\n};\n\n~~~\n\n<img src=\"assets/WX20230511-153512@2x.png\" >\n\n> **æ³¨æ„ï¼š**å½“é…ç½®11æœºå™¨å†…ç½‘ipåï¼Œè¯¥æœºå™¨åº”ä¿å­˜è¿è¡ŒçŠ¶æ€ï¼Œé‡å¯åå…¶å®ƒæœºå™¨å¯èƒ½æ— æ³•è¿æ¥å¤–ç½‘ã€‚@https://github.com/xinzhuxianshengæ„Ÿè°¢å»ºè®®ï¼\n\né…ç½®åŸŸåè§£æçš„ç›¸å…³ä¿¡æ¯\n\n~~~\n# 11æœºå™¨ï¼š\n# æ³¨æ„serialè¡Œçš„æ—¶é—´ï¼Œä»£è¡¨ä»Šå¤©çš„æ—¶é—´+ç¬¬ä¸€æ¡è®°å½•ï¼š20230511+01ï¼Œéœ€è¦ä¿®æ”¹serialã€å„ä¸ªipã€\n7-11 ~]# vi /var/named/host.com.zone\n$ORIGIN host.com.\n$TTL 600\t; 10 minutes\n@       IN SOA\tdns.host.com. dnsadmin.host.com. (\n\t\t\t\t2023051101 ; serial\n\t\t\t\t10800      ; refresh (3 hours)\n\t\t\t\t900        ; retry (15 minutes)\n\t\t\t\t604800     ; expire (1 week)\n\t\t\t\t86400      ; minimum (1 day)\n\t\t\t\t)\n\t\t\tNS   dns.host.com.\n$TTL 60\t; 1 minute\ndns                A    172.27.139.122\nHDSS7-11           A    172.27.139.122\nHDSS7-12           A    172.27.139.119\nHDSS7-21           A    172.27.139.118\nHDSS7-22           A    172.27.139.120\nHDSS7-200          A    172.27.139.121\n\n7-11 ~]# vi /var/named/od.com.zone\n$ORIGIN od.com.\n$TTL 600\t; 10 minutes\n@   \t\tIN SOA\tdns.od.com. dnsadmin.od.com. (\n\t\t\t\t2023051101 ; serial\n\t\t\t\t10800      ; refresh (3 hours)\n\t\t\t\t900        ; retry (15 minutes)\n\t\t\t\t604800     ; expire (1 week)\n\t\t\t\t86400      ; minimum (1 day)\n\t\t\t\t)\n\t\t\t\tNS   dns.od.com.\n$TTL 60\t; 1 minute\ndns                A    172.27.139.122\n\n# çœ‹ä¸€ä¸‹æœ‰æ²¡æœ‰æŠ¥é”™\n7-11 ~]# named-checkconf\n7-11 ~]# systemctl start named\n7-11 ~]# netstat -luntp|grep 53\n~~~\n\n> **TTL 600**ï¼šæŒ‡å®šIPåŒ…è¢«è·¯ç”±å™¨ä¸¢å¼ƒä¹‹å‰å…è®¸é€šè¿‡çš„æœ€å¤§ç½‘æ®µæ•°é‡\n>\n> - **10 minutes**ï¼šè¿‡æœŸæ—¶é—´10åˆ†é’Ÿ\n>\n> **SOA**ï¼šä¸€ä¸ªåŸŸæƒå¨è®°å½•çš„ç›¸å…³ä¿¡æ¯ï¼Œåé¢æœ‰5ç»„å‚æ•°åˆ†åˆ«è®¾å®šäº†è¯¥åŸŸç›¸å…³éƒ¨åˆ†\n>\n> - **dnsadmin.od.com.**  ä¸€ä¸ªå‡çš„é‚®ç®±\n> - **serial**ï¼šè®°å½•çš„æ—¶é—´\n>\n> **$ORIGIN**ï¼šå³ä¸‹åˆ—çš„åŸŸåè‡ªåŠ¨è¡¥å……od.comï¼Œå¦‚dnsï¼Œå¤–é¢çœ‹æ¥æ˜¯dns.od.com\n>\n> **netstat -luntp**ï¼šæ˜¾ç¤º tcp,udp çš„ç«¯å£å’Œè¿›ç¨‹ç­‰ç›¸å…³æƒ…å†µ\n\n<img src=\"assets/WX20230511-153817@2x.png\" />\n\n~~~\n# 11æœºå™¨ï¼Œæ£€æŸ¥ä¸»æœºåŸŸæ˜¯å¦è§£æ\n7-11 ~]# dig -t A hdss7-21.host.com @172.27.139.122 +short\n# out: 172.27.139.118\n# é…ç½®æœåŠ¡å™¨èƒ½ä½¿ç”¨è¿™ä¸ªé…ç½®ï¼Œåœ¨æœ€ä¸‹é¢è¿½åŠ 11æœºå™¨çš„å†…ç½‘ip\n7-11 ~]# vi /etc/sysconfig/network-scripts/ifcfg-eth0\nDNS1=172.27.139.122\n7-11 ~]# systemctl restart network\n# é‡å¯ç½‘ç»œåï¼Œé©¬ä¸Špingå¯èƒ½æ— æ³•è¿æ¥ï¼Œéœ€è¦ç­‰ä¸ªåç§’é’Ÿ\n7-11 ~]# ping baidu.com\n7-11 ~]# ping hdss7-21.host.com\n~~~\n\n> **dig -t A**ï¼šæŒ‡çš„æ˜¯æ‰¾DNSé‡Œæ ‡è®°ä¸ºAçš„ç›¸å…³è®°å½•ï¼Œè€Œåé¢ä¼šå¸¦ä¸Šç›¸å…³çš„åŸŸï¼Œå¦‚ä¸Šé¢çš„hdss7-21.host.comï¼Œä¸ºä»€ä¹ˆå¤–é¢é…äº†HDSS7-21åé¢è¿˜ä¼šè‡ªåŠ¨æ¥ä¸Š.host.comå°±æ˜¯å› ä¸º$ORIGINï¼Œåé¢åˆ™æ˜¯å¯¹åº”çš„IP\n>\n> - **+short**ï¼šè¡¨ç¤ºåªè¿”å›IP\n\n<img src=\"assets/WX20230511-154100@2x.png\" />\n\n~~~\n# åœ¨é11æœºå™¨ä¸Šï¼Œæœ€ä¸‹é¢è¿½åŠ dns1=11æœºå™¨å†…ç½‘ip\n~]# vi /etc/sysconfig/network-scripts/ifcfg-eth0\nDNS1=172.27.139.122\n\n~]# systemctl restart network\n# è¯•ä¸‹ç½‘ç»œæ˜¯å¦æ­£å¸¸\n~]# ping baidu.com\n# å…¶å®ƒæœºå™¨å°è¯•ping7-11æœºå™¨æˆ–200æœºå™¨ç­‰ä»»æ„æœºå™¨ï¼Œè¿™æ—¶å€™çŸ­åŸŸåæ˜¯å¯ä»¥ä½¿ç”¨äº†\n7-12 ~]# ping hdss7-11.host.com\n7-12 ~]# ping hdss7-200.host.com\n~~~\n\n> è®©å…¶å®ƒæœºå™¨çš„DNSå…¨éƒ¨æ”¹æˆ11æœºå™¨çš„å¥½å¤„æ˜¯ï¼Œå…¨éƒ¨çš„æœºå™¨è®¿é—®å¤–ç½‘å°±åªæœ‰é€šè¿‡11ç«¯å£ï¼Œæ›´å¥½æ§åˆ¶\n\n<img src=\"assets/WX20230511-154412@2x.png\"  />\n\næœºå™¨å‡†å¤‡å·¥ä½œå®Œæˆ:tada:\n\n\n\n### K8Så‰ç½®å·¥ä½œâ€”â€”å‡†å¤‡ç­¾å‘è¯ä¹¦ç¯å¢ƒ\n\n> **WHAT**ï¼š è¯ä¹¦ï¼Œå¯ä»¥ç”¨æ¥å®¡è®¡ä¹Ÿå¯ä»¥ä¿éšœå®‰å…¨ï¼Œk8Sç»„ä»¶å¯åŠ¨çš„æ—¶å€™ï¼Œåˆ™éœ€è¦æœ‰å¯¹åº”çš„è¯ä¹¦ï¼Œè¯ä¹¦çš„è¯¦è§£ä½ ä¹Ÿå¯ä»¥åœ¨ç½‘ä¸Šæœåˆ°ï¼Œè¿™é‡Œå°±ä¸ç»†ç»†è¯´æ˜äº†\n>\n> **WHY**ï¼šå½“ç„¶æ˜¯ä¸ºäº†è®©æˆ‘ä»¬çš„ç»„ä»¶èƒ½æ­£å¸¸è¿è¡Œ\n\n~~~\n# cfsslæ–¹å¼åšè¯ä¹¦ï¼Œéœ€è¦ä¸‰ä¸ªè½¯ä»¶ï¼ˆå¦‚æœç½‘ç»œæ— æ³•è¿é€šï¼Œåˆ™å‚è€ƒä¸‹é¢æˆ‘å·²ä¸‹è½½å¥½çš„è½¯ä»¶åŒ…ï¼‰ï¼ŒæŒ‰ç…§æˆ‘ä»¬çš„æ¶æ„å›¾ï¼Œæˆ‘ä»¬éƒ¨ç½²åœ¨200æœºå™¨:\n200 ~]# wget https://pkg.cfssl.org/R1.2/cfssl_linux-amd64 -O /usr/bin/cfssl\n200 ~]# wget https://pkg.cfssl.org/R1.2/cfssljson_linux-amd64 -O /usr/bin/cfssl-json\n200 ~]# wget https://pkg.cfssl.org/R1.2/cfssl-certinfo_linux-amd64 -O /usr/bin/cfssl-certinfo\n200 ~]# chmod +x /usr/bin/cfssl*\n200 ~]# which cfssl\n200 ~]# which cfssl-json\n200 ~]# which cfssl-certinfo\n~~~\n\n> **wget**ï¼šä»ç½‘ç»œä¸Šè‡ªåŠ¨ä¸‹è½½æ–‡ä»¶çš„è‡ªç”±å·¥å…·\n>\n> **chmod**ï¼šç»™å¯¹åº”çš„æ–‡ä»¶æ·»åŠ æƒé™ï¼ˆ[èœé¸Ÿæ•™ç¨‹](https://www.runoob.com/linux/linux-comm-chmod.html)ï¼‰\n>\n> - **+x**ï¼šç»™å½“å‰ç”¨æˆ·å¢åŠ å¯æ‰§è¡Œè¯¥æ–‡ä»¶çš„æƒé™\n>\n> **which**ï¼šæŸ¥çœ‹ç›¸åº”çš„ä¸œè¥¿åœ¨å“ªé‡Œ\n\n##### æŠ¥é”™ï¼šwgetæŠ¥é”™ç½‘ç»œé—®é¢˜\n\n~~~\n# é’ˆå¯¹ä¸‹è½½cfsslç½‘ç»œæ— æ³•è¿é€šçš„æƒ…å†µï¼Œç™¾åº¦äº‘https://pan.baidu.com/s/1arE2LdtAbcR80gmIQtIELw æå–ç ï¼šouy1ã€‚æ‰¾åˆ°åä¸ºâ€ç¬¬äºŒç« æ¶‰åŠçš„è½¯ä»¶åŒ…â€œä¸­çš„cfsslçš„3ä¸ªæ–‡ä»¶ï¼Œä¸Šä¼ åˆ°/rootç›®å½•ä¸‹\n200 ~]# cp cfssl_linux-amd64 /usr/bin/cfssl\n200 ~]# cp cfssljson_linux-amd64 /usr/bin/cfssl-json\n200 ~]# cp cfssl-certinfo_linux-amd64 /usr/bin/cfssl-certinfo\n200 ~]# chmod +x /usr/bin/cfssl*\n200 ~]# which cfssl\n200 ~]# which cfssl-json\n200 ~]# which cfssl-certinfo\n~~~\n\n<img src=\"assets/WX20230511-155452@2x.png\" />\n\n\n\n~~~\n200 ~]# mkdir /opt/certs\n200 ~]# cd /opt/certs\ncerts]# vi ca-csr.json\n{\n    \"CN\": \"ben123123\",\n    \"hosts\": [\n    ],\n    \"key\": {\n        \"algo\": \"rsa\",\n        \"size\": 2048\n    },\n    \"names\": [\n        {\n            \"C\": \"CN\",\n            \"ST\": \"beijing\",\n            \"L\": \"beijing\",\n            \"O\": \"od\",\n            \"OU\": \"ops\"\n        }\n    ],\n    \"ca\": {\n        \"expiry\": \"1752000h\"\n    }\n}\ncerts]# cfssl gencert -initca ca-csr.json | cfssl-json -bare ca\ncerts]# cat ca.pem\n# å¦‚æœä½ è¿™æ—¶å€™æ˜¾ç¤ºæ®µé”™è¯¯æˆ–è€…jsoné”™è¯¯ï¼Œå°±æ˜¯ä¹‹å‰å…‹éš†è™šæ‹Ÿæœºçš„æ—¶å€™200æœºå™¨åœ°å€å’Œåˆ«çš„æœºå™¨åœ°å€é‡å å†²çªäº†ï¼Œéœ€è¦é‡å»º200è™šæ‹Ÿæœº\n~~~\n\n> **cd **ï¼šåˆ‡æ¢å½“å‰å·¥ä½œç›®å½•åˆ° dirName\n>\n> - è¯­æ³•ï¼šcd [dirName]\n>\n> **mkdir**ï¼šå»ºç«‹åç§°ä¸º dirName ä¹‹å­ç›®å½•\n>\n> - è¯­æ³•ï¼šmkdir [-p] dirName\n> - **-p:** ç¡®ä¿ç›®å½•å­˜åœ¨ï¼Œä¸å­˜åœ¨åˆ™å»ºä¸€ä¸ªï¼Œå¦‚mkdir empty/empty1/empty2\n>\n> **cfssl**ï¼šè¯ä¹¦å·¥å…·\n>\n> - gencertï¼šç”Ÿæˆçš„æ„æ€\n>\n> **ca-csr.jsonè§£æï¼š**\n>\n> - CNï¼šCommon Nameï¼Œæµè§ˆå™¨ä½¿ç”¨è¯¥å­—æ®µéªŒè¯ç½‘å€æ˜¯å¦åˆæ³•ï¼Œä¸€èˆ¬å†™åŸŸåï¼Œéå¸¸é‡è¦\n> - STï¼šStateï¼Œçœ\n> - Lï¼šLocalityï¼Œåœ°åŒº\n> - Oï¼šOrganization Nameï¼Œç»„ç»‡åç§°\n> - OUï¼šOrganization Unit Nameï¼Œç»„ç»‡å•ä½åç§°\n>\n> <a href=\"https://github.com/ben1234560/k8s_PaaS/blob/master/%E5%8E%9F%E7%90%86%E5%8F%8A%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/Kubernetes%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5.md#pod%E4%B8%AD%E5%87%A0%E4%B8%AA%E9%87%8D%E8%A6%81%E5%AD%97%E6%AE%B5%E7%9A%84%E5%90%AB%E4%B9%89%E5%92%8C%E7%94%A8%E6%B3%95\">Podä¸­å‡ ä¸ªé‡è¦å­—æ®µçš„å«ä¹‰å’Œç”¨æ³•</a>\n\n<img src=\"assets/WX20230511-155653@2x.png\" />\n\n\n\n### K8Så‰ç½®å·¥ä½œâ€”â€”éƒ¨ç½²dockerç¯å¢ƒ\n\n> **WHAT**ï¼šæ˜¯ä¸€ä¸ªå¼€æºçš„åº”ç”¨å®¹å™¨å¼•æ“ï¼Œè®©å¼€å‘è€…å¯ä»¥æ‰“åŒ…ä»–ä»¬çš„åº”ç”¨ä»¥åŠä¾èµ–åŒ…åˆ°ä¸€ä¸ªå¯ç§»æ¤çš„é•œåƒä¸­ï¼Œç„¶åå‘å¸ƒåˆ°ä»»ä½•æµè¡Œçš„ Linuxæˆ–Windows æœºå™¨ä¸Šï¼Œä¹Ÿå¯ä»¥å®ç°è™šæ‹ŸåŒ–ã€‚\n>\n> **WHY**ï¼šPodé‡Œé¢å°±æ˜¯ç”±æ•°ä¸ªdockerå®¹å™¨ç»„æˆï¼ŒPodæ˜¯è±Œè±†èšï¼Œdockerå®¹å™¨æ˜¯é‡Œé¢çš„è±†å­ã€‚\n\n~~~\n# å¦‚æˆ‘ä»¬æ¶æ„å›¾æ‰€ç¤ºï¼Œè¿ç®—èŠ‚ç‚¹æ˜¯21/22æœºå™¨ï¼ˆæ²¡æœ‰dockeråˆ™æ— æ³•è¿è¡Œpodï¼‰ï¼Œè¿ç»´ä¸»æœºæ˜¯200æœºå™¨ï¼ˆæ²¡æœ‰dockeråˆ™æ²¡åŠæ³•ä¸‹è½½dockerå­˜å…¥ç§æœ‰ä»“åº“ï¼‰ï¼Œæ‰€ä»¥åœ¨ä¸‰å°æœºå™¨å®‰è£…ï¼ˆ21/22/200ï¼‰\n# è¿™ä¸ªå‰é¢å·²ç»å®‰è£… curl -fsSL https://get.docker.com | bash -s docker --mirror Aliyun\n# ä¸Šé¢çš„ä¸‹è½½å¯èƒ½ç½‘ç»œæœ‰é—®é¢˜ï¼Œéœ€è¦å¤šè¯•å‡ æ¬¡ï¼Œè¿™äº›éƒ¨ç½²æˆ‘å·²ç»ä¸åŒæœºå™¨è¯•è¿‡å¾ˆå¤šæ¬¡äº†ï¼Œå®åœ¨ä¸è¡Œçš„ä½¿ç”¨ä¸‹é¢æä¾›çš„æŠ¥é”™è§£å†³æ–¹æ³•ã€‚\n~]# mkdir -p /data/docker /etc/docker\n# # æ³¨æ„ï¼Œ172.7.21.1ï¼Œè¿™é‡Œå¾—21æ˜¯æŒ‡åœ¨hdss7-21å¾—æœºå™¨ï¼Œå¦‚æœæ˜¯22å¾—æœºå™¨ï¼Œå°±æ˜¯172.7.22.1ï¼Œå…±ä¸€å¤„éœ€è¦æ”¹æœºå™¨åï¼š\"bip\": \"172.7.21.1/24\"\n~]# vi /etc/docker/daemon.json\n{\n  \"data-root\": \"/data/docker\",\n  \"storage-driver\": \"overlay2\",\n  \"insecure-registries\": [\"registry.access.redhat.com\",\"quay.io\",\"harbor.od.com\"],\n  \"registry-mirrors\": [\"https://q2gr04ke.mirror.aliyuncs.com\"],\n  \"bip\": \"172.7.21.1/24\",\n  \"exec-opts\": [\"native.cgroupdriver=systemd\"],\n  \"live-restore\": true\n}\n\n~]# systemctl start docker\n~]# docker version\n~]# docker ps -a\n~~~\n\n> **mkdir -pï¼š**å‰é¢æœ‰è®²åˆ°è¿‡ï¼ˆä¸Šä¸€çº§ç›®å½•æ²¡æœ‰åˆ™åˆ›å»ºï¼‰ï¼Œè€Œè¿™æ¬¡åé¢å¸¦äº†ä¸¤ä¸ªç›®å½•ï¼Œæ„æ€æ˜¯åŒæ—¶åˆ›å»ºä¸¤ä¸ªç›®å½•\n>\n> **daemon.jsonï¼š**ä¸ºä»€ä¹ˆé…aliyuncsçš„ç¯å¢ƒï¼Œæ˜¯å› ä¸ºé»˜è®¤æ˜¯è¿æ¥åˆ°å¤–ç½‘çš„ï¼Œé€Ÿåº¦æ¯”è¾ƒæ…¢ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥ç›´æ¥ä½¿ç”¨å›½å†…çš„é˜¿é‡Œäº‘é•œåƒæºï¼Œå½“ç„¶è¿˜æœ‰è…¾è®¯äº‘ç­‰\n>\n> **docker versionï¼š**æŸ¥çœ‹dockerçš„ç‰ˆæœ¬\n>\n> **daemon.jsonè§£æï¼š**é‡ç‚¹è¯´ä¸€ä¸‹è¿™ä¸ªä¸ºä»€ä¹ˆ10.4.7.21æœºå™¨å¯¹åº”ç€172.7.21.1/24ï¼Œè¿™é‡Œå¯ä»¥çœ‹åˆ°10çš„21å¯¹åº”å¾—æ˜¯172çš„21ï¼Œè¿™æ ·åšçš„å¥½å¤„å°±æ˜¯ï¼Œå½“ä½ çš„podå‡ºç°é—®é¢˜æ—¶ï¼Œä½ å¯ä»¥é©¬ä¸Šå®šä½åˆ°æ˜¯åœ¨å“ªå°æœºå™¨å‡ºç°çš„é—®é¢˜ï¼Œæ˜¯21è¿˜æ˜¯22è¿˜æ˜¯å…¶å®ƒçš„ï¼Œè¿™ç‚¹åœ¨ç”Ÿäº§ä¸Šéå¸¸é‡è¦ï¼Œæœ‰æ—¶å€™ä½ çš„dashboardï¼ˆåé¢ä¼šå®‰è£…ï¼‰å®•æ‰äº†ï¼Œä½ æ²¡åŠæ³•åªèƒ½å»æœºå™¨æ‰¾ï¼Œè€Œè¿™æ—¶å€™ä½ åˆæ‰¾ä¸åˆ°çš„æ—¶å€™ï¼Œä½ è€æ¿ä¼šæ‹¿ä½ ç¥­å¤©çš„\n\n##### æŠ¥é”™ï¼šcurl -fsSL https://get.docker.com | bash -s docker --mirror Aliyun\n\næŠ¥é”™ä¿¡æ¯ï¼š\n\n```bash\nhttp://mirrors.cloud.aliyuncs.com/centos/7/updates/x86_64/Packages/libxml2-2.9.1-6.el7_9.6.x86_64.rpm: [Errno 14] curl#6 - \"Could not resolve host: mirrors.cloud.aliyuncs.com; Unknown error\"\nTrying other mirror.\n\nError downloading packages:\n  libxml2-2.9.1-6.el7_9.6.x86_64: [Errno 256] No more mirrors to try.\n  python-kitchen-1.1.1-5.el7.noarch: [Errno 256] No more mirrors to try.\n  yum-utils-1.1.31-54.el7_8.noarch: [Errno 256] No more mirrors to try.\n  python-chardet-2.2.1-3.el7.noarch: [Errno 256] No more mirrors to try.\n  libxml2-python-2.9.1-6.el7_9.6.x86_64: [Errno 256] No more mirrors to try.\n```\n\n\n\nåŸå› ï¼šyumæºå‡ºç°é—®é¢˜\n\nè§£å†³æ–¹æ³•ï¼š\n\n~~~\nmv /etc/yum.repos.d/epel.repo /etc/yum.repos.d/epel.repo.bak\ncurl -o /etc/yum.repos.d/CentOS-Base.repo http://mirrors.aliyun.com/repo/Centos-7.repo  # è¿™ä¸€æ­¥å¿…é¡»æˆåŠŸï¼Œæ²¡æˆåŠŸçš„å†æ‰§è¡Œä¸€éå³å¯\nyum update -y  # è¿™ä¸€æ­¥è€—æ—¶è¾ƒé•¿\nyum install epel-release -y\nyum install -y yum-utils\nyum-config-manager --add-repo http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo\nyum install -y docker-ce\n~~~\n\n<img src=\"assets/WX20230511-162032@2x.png\" />\n\n\n\n### K8Så‰ç½®å·¥ä½œâ€”â€”éƒ¨ç½²harborä»“åº“\n\n> **WHAT **ï¼šharborä»“åº“æ˜¯å¯ä»¥éƒ¨ç½²åˆ°æœ¬åœ°çš„ç§æœ‰ä»“åº“ï¼Œä¹Ÿå°±æ˜¯ä½ å¯ä»¥æŠŠé•œåƒæ¨åˆ°è¿™ä¸ªä»“åº“ï¼Œç„¶åéœ€è¦ç”¨çš„æ—¶å€™å†ä¸‹è½½ä¸‹æ¥ï¼Œè¿™æ ·çš„å¥½å¤„æ˜¯ï¼š1ã€ä¸‹è½½é€Ÿåº¦å¿«ï¼Œç”¨åˆ°çš„æ—¶å€™èƒ½é©¬ä¸Šä¸‹è½½ä¸‹æ¥2ã€ä¸ç”¨æ‹…å¿ƒé•œåƒæ”¹åŠ¨æˆ–è€…ä¸‹æ¶ç­‰ã€‚\n>\n> **WHY**ï¼šå› ä¸ºæˆ‘ä»¬çš„éƒ¨ç½²K8Sæ¶‰åŠåˆ°å¾ˆå¤šé•œåƒï¼Œåˆ¶ä½œç›¸å…³åŒ…çš„æ—¶å€™å¦‚æœç½‘é€Ÿé—®é¢˜ä¼šå¯¼è‡´å¤±è´¥é‡æ¥ï¼Œè€Œä¸”æˆ‘ä»¬åœ¨å…¬å¸é‡Œä¹Ÿä¼šå»ºè‡ªå·±çš„ä»“åº“ï¼Œæ‰€ä»¥å¿…é¡»æŒ‰ç…§harborä»“åº“\n\n~~~\n# å¦‚æ¶æ„å›¾ï¼Œæˆ‘ä»¬å®‰è£…åœ¨200æœºå™¨ï¼š\n200 ~]# mkdir /opt/src  && cd /opt/src\n# å¯ä»¥å»è¿™ä¸ªåœ°å€ä¸‹è½½ï¼Œä¹Ÿå¯ä»¥ç›´æ¥ç”¨æˆ‘ç”¨çš„è½¯ä»¶åŒ…\nhttps://github.com/goharbor/harbor/releases/tag/v1.8.3\n200 src]# wget https://storage.googleapis.com/harbor-releases/release-1.8.0/harbor-offline-installer-v1.8.3.tgz\n7-200 src]# tar xf harbor-offline-installer-v1.8.3.tgz -C /opt/\n~~~\n\n> **tag**ï¼šå¯ä»¥åŠ å…¥ï¼Œè§£å¼€å¤‡ä»½æ–‡ä»¶å†…çš„æ–‡ä»¶\n>\n> - **x**ï¼šè§£å‹\n> - **f**ï¼š ä½¿ç”¨æ¡£æ¡ˆåå­—\n> - **-C**ï¼šåˆ‡æ¢åˆ°æŒ‡å®šçš„ç›®å½•\n> - æ•´æ¡å‘½ä»¤åˆèµ·æ¥å°±æ˜¯ï¼ŒæŠŠtgzæ–‡ä»¶ä»¥tgzæ–‡ä»¶åä¸ºåå­—è§£å‹åˆ°optç›®å½•ä¸‹ï¼Œå¹¶ä¿å­˜tgzæ–‡ä»¶åŸæ ·\n>\n> **å…³äºç‰ˆæœ¬**ï¼šä¸€èˆ¬äººéƒ½æ˜¯å–œæ¬¢ç”¨æ¯”è¾ƒæ–°çš„ç‰ˆæœ¬ï¼Œæˆ‘ä»¬å½“ç„¶ä¹Ÿæ”¯æŒæ¯”è¾ƒæ–°çš„ç‰ˆæœ¬ï¼Œä½†å¯¹äºå…¬å¸è€Œå·²ï¼Œç¨³å®šæ˜¯æœ€è¦ç´§çš„ï¼Œv1.8.3æ˜¯ç”¨çš„æ¯”è¾ƒç¨³å®šçš„ç‰ˆæœ¬ï¼Œè€Œåç»­çš„å„ä¸ªç»„ä»¶ä¹Ÿä¼šæœ‰æ›´åŠ æ–°çš„ç‰ˆæœ¬ï¼Œä½ å¯ä»¥å°è¯•æ–°ç‰ˆæœ¬ï¼Œä½†æœ‰äº›ç”±äºå…¼å®¹é—®é¢˜ä¸èƒ½ç”¨æ–°çš„ï¼Œåç»­é‚£äº›ä¸èƒ½ç”¨æˆ‘ä¼šæ ‡è®°æ¸…æ¥šã€‚\n\n~~~\n# 200æœºå™¨ï¼š\n200 src]# cd /opt/\n200 opt]# mv harbor/ harbor-v1.8.3\n200 opt]# ln -s /opt/harbor-v1.8.3/ /opt/harbor\n200 opt]# cd harbor\n200 harbor]# ll\n# ä¿®æ”¹åŸŸåã€ç«¯å£ã€æŒ‚è½½å·åŠæ—¥å¿—å­˜æ”¾åœ°å€\n200 harbor]# vi harbor.yml  # å¦‚æœè¿™é‡Œæ˜¯ç”¨çš„2.8.0ç‰ˆæœ¬ï¼Œåˆ™éœ€è¦cp harbor.yml.tmpl harbor.yml\nhostname: harbor.od.com  # åŸreg.mydomain.com\nhttp:\n  port: 180  # åŸ80\ndata_volume: /data/harbor\nlocation: /data/harbor/logs\n\n200 harbor]# mkdir -p /data/harbor/logs\n# è¿™ä¸ªå‰é¢å·²ç»å®‰è£… yum install docker-compose -y\n200 harbor]# rpm -qa docker-compose\n# out: docker-compose-1.18.0-4.el7.noarch\n# yum install docker-compose åŒ…æ— æ³•ä¸‹è½½çš„ï¼Œå¯ä»¥æŸ¥çœ‹ä¸‹é¢æä¾›çš„æŠ¥é”™è§£å†³æ–¹æ³•\n200 harbor]# ./install.sh\n~~~\n\n> **æç¤º**ï¼šharbor v2.3.3ç‰ˆæœ¬å®‰è£…ä¹Ÿéœ€è¦å°†httpsç›¸å…³çš„é…ç½®æ³¨é‡Šæ‰\n>\n> å¦‚å›¾#https:\n>\n> ![1635775214057](assets/1635775214057.png)\n>\n> æ„Ÿè°¢@https://github.com/xinzhuxiansheng\n>\n> **mv**ï¼šä¸ºæ–‡ä»¶æˆ–ç›®å½•æ”¹åã€æˆ–å°†æ–‡ä»¶æˆ–ç›®å½•ç§»å…¥å…¶å®ƒä½ç½®ã€‚\n>\n> - è¿™é‡Œçš„å‘½ä»¤æ˜¯æœ‰æ–œæ çš„ï¼Œæ‰€ä»¥æ˜¯ç§»åŠ¨åˆ°æŸä¸ªç›®å½•ä¸‹\n>\n> **ln**ï¼šä¸ºæŸä¸€ä¸ªæ–‡ä»¶åœ¨å¦å¤–ä¸€ä¸ªä½ç½®å»ºç«‹ä¸€ä¸ªåŒæ­¥çš„é“¾æ¥\n>\n> - `è¯­æ³•:ln [å‚æ•°][æºæ–‡ä»¶æˆ–ç›®å½•][ç›®æ ‡æ–‡ä»¶æˆ–ç›®å½•]`\n> - `**-sï¼š**è½¯è¿æ¥ï¼Œå¯ä»¥å¯¹æ•´ä¸ªç›®å½•è¿›è¡Œé“¾æ¥`\n>\n> **harbor.ymlè§£æï¼š**\n>\n> - portä¸ºä»€ä¹ˆæ”¹æˆ180ï¼šå› ä¸ºåé¢æˆ‘ä»¬è¦è£…nginxï¼Œnginxç”¨çš„80ï¼Œæ‰€ä»¥è¦æŠŠå®ƒä»¬é”™å¼€\n> - data_volumeï¼šæ•°æ®å·ï¼Œå³dockeré•œåƒæ”¾åœ¨å“ªé‡Œ\n> - locationï¼šæ—¥å¿—æ–‡ä»¶\n> - **./install.sh**ï¼šå¯åŠ¨shellè„šæœ¬\n\n##### æŠ¥é”™ï¼šyum install docker-compose -yæŠ¥é”™No package docker-compose available.\n\nä½¿ç”¨æˆ‘æä¾›çš„å®˜æ–¹è½¯ä»¶åŒ…ï¼ˆæ”¾åœ¨ç™¾åº¦ç½‘ç›˜ï¼‰ï¼Œæ”¾åˆ°harborè·¯å¾„ä¸‹\n\n~~~sh\n200 harbor]# sudo cp docker-compose-Linux-x86_64 /usr/local/bin/docker-compose\n200 harbor]# sudo chmod +x /usr/local/bin/docker-compose\n200 harbor]# docker-compose --version\n# out: docker-compose version 1.29.2, build 5becea4c\n200 harbor]# ./install.sh\n~~~\n\n<img src=\"assets/WX20230511-165532@2x.png\" />\n\n<img src=\"assets/WX20230511-165640@2x.png\" />\n\n\n\n~~~\n# 200æœºå™¨ï¼š\n200 harbor]# docker-compose ps\n# out:\n      Name                     Command               State             Ports          \n--------------------------------------------------------------------------------------\nharbor-core         /harbor/start.sh                 Up                               \nharbor-db           /entrypoint.sh postgres          Up      5432/tcp                 \nharbor-jobservice   /harbor/start.sh                 Up                               \nharbor-log          /bin/sh -c /usr/local/bin/ ...   Up      127.0.0.1:1514->10514/tcp\nharbor-portal       nginx -g daemon off;             Up      80/tcp                   \nnginx               nginx -g daemon off;             Up      0.0.0.0:180->80/tcp      \nredis               docker-entrypoint.sh redis ...   Up      6379/tcp                 \nregistry            /entrypoint.sh /etc/regist ...   Up      5000/tcp                 \nregistryctl         /harbor/start.sh                 Up \n200 harbor]# docker ps -a\n# è¿™ä¸ªå‰é¢å·²ç»å®‰è£… yum install nginx -y  # æŠ¥é”™çš„å‚è€ƒä¸‹é¢æŠ¥é”™å¯¹åº”çš„è§£å†³æ–¹æ³•\n\n###ç›¸å…³æŠ¥é”™é—®é¢˜ï¼š\nyumçš„æ—¶å€™æŠ¥ï¼š/var/run/yum.pid å·²è¢«é”å®šï¼ŒPID ä¸º 1610 çš„å¦ä¸€ä¸ªç¨‹åºæ­£åœ¨è¿è¡Œã€‚\nå¦å¤–ä¸€ä¸ªç¨‹åºé”å®šäº† yumï¼›ç­‰å¾…å®ƒé€€å‡ºâ€¦â€¦\nç½‘ä¸Šç»Ÿä¸€çš„è§£å†³åŠæ³•ï¼šç›´æ¥åœ¨ç»ˆç«¯è¿è¡Œ rm -f /var/run/yum.pid å°†è¯¥æ–‡ä»¶åˆ é™¤ï¼Œç„¶åå†æ¬¡è¿è¡Œyumã€‚\n###\n~~~\n\n##### æŠ¥é”™ï¼šyum install nginx -yæ²¡æœ‰å¯¹åº”åŒ…\n\n~~~\n200 ~]# yum install nginx -y\nLoaded plugins: fastestmirror\nLoading mirror speeds from cached hostfile\n * base: mirrors.aliyun.com\n * extras: mirrors.aliyun.com\n * updates: mirrors.aliyun.com\nNo package nginx available.\nError: Nothing to do\n~~~\n\nè§£å†³æ–¹æ³•\n\n~~~\n# ç¼–å†™nginx.repo\n200 harbor]# sudo vi /etc/yum.repos.d/nginx.repo\n[nginx]\nname=nginx repo\nbaseurl=http://nginx.org/packages/centos/7/$basearch/\ngpgcheck=0\nenabled=1\n\n# ä¿å­˜é€€å‡ºåå³å¯å®‰è£…nginxäº†\n200 harbor]# sudo yum install nginx -y\n~~~\n\n\n\nè§£å†³å®Œæ¥ç€èµ°\n\n~~~\n200 harbor]# vi /etc/nginx/conf.d/harbor.od.com.conf\nserver {\n    listen       80;\n    server_name  harbor.od.com;\n\n    client_max_body_size 1000m;\n\n    location / {\n        proxy_pass http://127.0.0.1:180;\n    }\n}\n\n200 harbor]# nginx -t\n200 harbor]# systemctl start nginx\n200 harbor]# systemctl enable nginx\n~~~\n\n> **nginx -t**ï¼šæµ‹è¯•*nginx*.confé…ç½®æ–‡ä»¶ä¸­æ˜¯å¦å­˜åœ¨è¯­æ³•é”™è¯¯\n>\n> **systemctl enable nginx**ï¼šå¼€æœºè‡ªåŠ¨å¯åŠ¨\n\nè¿½åŠ åŸŸåè§£æ\n\n~~~\n# åœ¨11æœºå™¨è§£æåŸŸåï¼ŒIPä½¿ç”¨200æœºå™¨çš„IPï¼š\n~]# vi /var/named/od.com.zone\n# æ³¨æ„serialå‰æ»šä¸€ä¸ªåºå·\n# æœ€ä¸‹é¢æ·»åŠ åŸŸå\nharbor             A    172.27.139.121\n~]# systemctl restart named\n~]# dig -t A harbor.od.com +short\n# out:172.29.238.162\n~~~\n\n<img src=\"assets/WX20230511-163252@2x.png\" />\n\n~~~\n# 200æœºå™¨ä¸Šcurlï¼š\nharbor]# curl harbor.od.com\n~~~\n\n> æ³¨æ„ï¼š\n>\n> getenforceå¾—æ˜¯å…³é—­çŠ¶æ€ï¼Œè€Œä¸æ˜¯enforcingï¼Œå¦åˆ™ä¼šæŠ¥502\n> æš‚æ—¶å…³é—­setenforce 0\n> æ°¸ä¹…å…³é—­ï¼Œæ”¹é…ç½®æ–‡ä»¶ vi /etc/selinux/config\n> SELINUX=disabled\n\n<img src=\"assets/WX20230511-163549@2x.png\"/>\n\nå…¬æœ‰äº‘çš„å®‰å…¨ç»„æ·»åŠ tcp 180ç«¯å£æƒé™\n\n<img src=\"assets/WX20230511-164140@2x.png\" />\n\nåœ¨æœ¬æœºï¼ˆwindow/macï¼‰hostsï¼Œåœ¨æ–‡ä»¶æœ«å°¾æ·»åŠ æ–°çš„ DNS åŸŸåè§£æï¼ˆç¡®ä¿èƒ½telneté€šï¼‰ï¼Œå¦‚ï¼š\n\n~~~\nå…¬ç½‘ip harbo.od.com  # å…¬ç½‘ipå¯¹åº”200æœºå™¨çš„å…¬ç½‘ip\n~~~\n\n[è®¿é—®harbor.od.com:180](harbor.od.com:180)\n\n<img src=\"assets/WX20230511-190408@2x.png\"  />\n\n<img src=\"assets/WX20230512-095227@2x.png\"  />\n\n~~~\nè´¦å·ï¼šadmin\nå¯†ç ï¼šHarbor12345\næ–°å»ºä¸€ä¸ªpublicå…¬å¼€é¡¹ç›®ï¼Œç™»é™†æŠ¥é”™è¯·å‚è€ƒä¸‹é¢çš„æŠ¥é”™è§£å†³æ–¹æ³•ï¼Œä¸€èˆ¬æ˜¯ç½‘ç»œé—®é¢˜ï¼Œå¦‚æœæ¥å£æ–¹å¼ä¹Ÿæ— æ³•è§£å†³ï¼Œç›´æ¥é‡è£…æ›´å¿«\n~~~\n\n![1578831458247](assets/1578831458247.png)\n\n~~~\n# 200æœºå™¨ï¼Œå°è¯•ä¸‹æ˜¯å¦èƒ½pushæˆåŠŸåˆ°harborä»“åº“\nharbor]# docker pull nginx:1.7.9\nharbor]# docker images|grep 1.7.9\nharbor]# docker tag 84581e99d807 harbor.od.com/public/nginx:v1.7.9\nharbor]# docker login harbor.od.com\nè´¦å·ï¼šadmin\nå¯†ç ï¼šHarbor12345\nharbor]# docker push harbor.od.com/public/nginx:v1.7.9\n# æŠ¥é”™ï¼šå¦‚æœå‘ç°ç™»å½•ä¸ä¸Šå»äº†ï¼Œè¿‡ä¸€é˜µå­å†ç™»å½•å³å¯ï¼Œå¤§çº¦5åˆ†é’Ÿå·¦å³\n~~~\n\n![1578832524891](assets/1578832524891.png)\n\n##### æŠ¥é”™ï¼šç”¨æ­£ç¡®çš„adminåŠå¯†ç ä»æç¤ºå¯†ç é”™è¯¯\n\næ’æŸ¥ï¼šcat /data/harbor/logs/* |grep -i erro\n\né‡æ–°å®‰è£…ä¸€æ¬¡harboræˆ–ç›´æ¥ç”¨å‘½ä»¤è¡Œæ“ä½œåˆ›å»ºpublic\n\n~~~\n# é’ˆå¯¹1.8.2ç‰ˆæœ¬ï¼Œæ–°ç‰ˆæœ¬éœ€è¦æ–°ç‰ˆæœ¬çš„æ“ä½œæŒ‡ä»¤ï¼Œéƒ¨ç½²åapiæ§åˆ¶ä¸­å¿ƒåœ¨è¿™é‡Œhttp://harbor.od.com:180/devcenter\n# åˆ›å»ºpublic\n~]curl -u \"admin:Harbor12345\" -X POST \"http://harbor.od.com/api/projects\" -H \"Content-Type: application/json\" -d '{\"project_name\":\"public\",\"metadata\":{\"public\":\"true\"}}'\n# ç¡®è®¤æ˜¯å¦åˆ›å»ºæˆåŠŸ\n~]curl -u \"admin:Harbor12345\" -X GET \"http://harbor.od.com/api/projects\"\n~~~\n\n<img src=\"assets/WX20230511-191809@2x.png\"  />\n\næ£€æŸ¥æ¨é€nginxæ˜¯å¦æˆåŠŸ\n\n~~~\n# å¿…é¡»å·²ç»ä¸‹è½½å¥½jqäº†ï¼Œyum install jq -y\n# è·å–publicçš„idï¼Œä¸€èˆ¬æ˜¯2\ncurl -u \"admin:Harbor12345\" -X GET \"http://harbor.od.com/api/projects?name=public\" | jq '.[0].project_id'\n# ä½¿ç”¨id=2è¿›è¡Œapiæ¥å£çš„è°ƒç”¨\ncurl -u \"admin:Harbor12345\" -X GET \"http://harbor.od.com/api/repositories?project_id=2\" | jq '.[].name'\n~~~\n\næˆåŠŸï¼Œæ­¤æ—¶ä½ å·²æˆåŠŸå»ºç«‹äº†è‡ªå·±çš„æœ¬åœ°ç§æœ‰ä»“åº“:tada:ï¼Œæˆ–è®¸ä½ ä¼šè€ƒè™‘å»ºç«‹è‡ªå·±çš„ç‹¬ç«‹ç«™ï¼Œenjoy!\n\n\n\n### å®‰è£…éƒ¨ç½²ä¸»æ§èŠ‚ç‚¹æœåŠ¡etcd\n\n> æ³¨æ„, ä¸€å®šè¦åŒæ­¥æ¯ä¸ªè™šæ‹Ÿæœºçš„æ—¶é—´, æ—¶åŒºå’Œæ—¶é—´è¦ä¿æŒä¸€è‡´, å¯ä»¥é€šè¿‡ä»¥ä¸‹çš„å‘½ä»¤æ¥æ“ä½œ, æœ€å¥½æ‰€æœ‰çš„è™šæ‹Ÿæœºéƒ½æ‰§è¡Œä¸€æ¬¡, æœ€å¥½çš„æ–¹æ³•æ˜¯å†™è¿›`/etc/rc.local`ä¸­\n\n  ```bash\ntimedatectl set-timezone Asia/Shanghai\ntimedatectl set-ntp true\n  ```\n\n> **WHAT**ï¼šä¸€ä¸ªé«˜å¯ç”¨å¼ºä¸€è‡´æ€§çš„æœåŠ¡å‘ç°å­˜å‚¨ä»“åº“ï¼Œå…³äºæœåŠ¡å‘ç°ï¼Œå…¶æœ¬è´¨å°±æ˜¯çŸ¥é“äº†é›†ç¾¤ä¸­æ˜¯å¦æœ‰è¿›ç¨‹åœ¨ç›‘å¬udpå’Œtcpç«¯å£ï¼ˆå¦‚ä¸Šé¢éƒ¨ç½²çš„harborå°±æ˜¯ç›‘å¬180ç«¯å£ï¼‰ï¼Œå¹¶ä¸”é€šè¿‡åå­—å°±å¯ä»¥æŸ¥æ‰¾å’Œè¿æ¥ã€‚\n>\n> - **ä¸€ä¸ªå¼ºä¸€è‡´æ€§ã€é«˜å¯ç”¨çš„æœåŠ¡å­˜å‚¨ç›®å½•**ï¼šåŸºäºRaftç®—æ³•çš„etcdå¤©ç”Ÿå°±æ˜¯è¿™æ ·\n> - **ä¸€ç§æ³¨å†ŒæœåŠ¡å’Œç›‘æ§æœåŠ¡å¥åº·çŠ¶æ€çš„æœºåˆ¶**ï¼šåœ¨etcdä¸­æ³¨å†ŒæœåŠ¡ï¼Œå¹¶ä¸”å¯¹æ³¨å†Œçš„æœåŠ¡è®¾ç½®`key TTL`ï¼ˆTTLä¸Šé¢æœ‰è®²åˆ°ï¼‰ï¼Œå®šæ—¶ä¿æŒæœåŠ¡çš„å¿ƒè·³ä»¥è¾¾åˆ°ç›‘æ§å¥åº·çŠ¶æ€çš„æ•ˆæœ\n> - **ä¸€ç§æŸ¥æ‰¾å’Œè¿æ¥æœåŠ¡çš„æœºåˆ¶**ï¼šé€šè¿‡åœ¨etcdæŒ‡å®šçš„ä¸»é¢˜ä¸‹æ³¨å†Œçš„æœåŠ¡ä¹Ÿèƒ½åœ¨å¯¹åº”çš„ä¸»é¢˜ä¸‹æŸ¥æ‰¾åˆ°ï¼Œä¸ºäº†ç¡®ä¿è¿æ¥ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨æ¯ä¸ªæœåŠ¡æœºå™¨ä¸Šéƒ½éƒ¨ç½²ä¸€ä¸ªProxyæ¨¡å¼çš„etcdï¼Œè¿™æ ·å°±å¯ä»¥ç¡®ä¿èƒ½è®¿é—®etcdé›†ç¾¤çš„æœåŠ¡éƒ½èƒ½äº’ç›¸è¿æ¥\n>\n> **WHY**ï¼šæˆ‘ä»¬éœ€è¦è®©æœåŠ¡å¿«é€Ÿé€æ˜åœ°æ¥å…¥åˆ°è®¡ç®—é›†ç¾¤ä¸­ï¼Œè®©å…±äº«é…ç½®ä¿¡æ¯å¿«é€Ÿè¢«é›†ç¾¤ä¸­çš„æ‰€æœ‰æœºå™¨å‘ç°\n\nçœ‹æˆ‘ä»¬çš„ç»“æ„å›¾ï¼Œå¯ä»¥çœ‹åˆ°æˆ‘ä»¬åœ¨12/21/22æœºå™¨éƒ½éƒ¨ç½²äº†etcd\n\n![1584701032598](assets/1584701032598.png)\n\n~~~\n# æˆ‘ä»¬å¼€å§‹åˆ¶ä½œè¯ä¹¦ï¼Œ200æœºå™¨ï¼š\ncerts]# cd /opt/certs/\ncerts]# vi /opt/certs/ca-config.json\n{\n    \"signing\": {\n        \"default\": {\n            \"expiry\": \"1752000h\"\n        },\n        \"profiles\": {\n            \"server\": {\n                \"expiry\": \"1752000h\",\n                \"usages\": [\n                    \"signing\",\n                    \"key encipherment\",\n                    \"server auth\"\n                ]\n            },\n            \"client\": {\n                \"expiry\": \"1752000h\",\n                \"usages\": [\n                    \"signing\",\n                    \"key encipherment\",\n                    \"client auth\"\n                ]\n            },\n            \"peer\": {\n                \"expiry\": \"1752000h\",\n                \"usages\": [\n                    \"signing\",\n                    \"key encipherment\",\n                    \"server auth\",\n                    \"client auth\"\n                ]\n            }\n        }\n    }\n}\n\n# ä¸‹é¢hostsæ·»åŠ 11ã€12ã€21ã€22æœºå™¨çš„å†…ç½‘ip\ncerts]# vi etcd-peer-csr.json\n{\n    \"CN\": \"k8s-etcd\",\n    \"hosts\": [\n        \"172.27.139.122\",\n        \"172.27.139.119\",\n        \"172.27.139.118\",\n        \"172.27.139.120\"\n    ],\n    \"key\": {\n        \"algo\": \"rsa\",\n        \"size\": 2048\n    },\n    \"names\": [\n        {\n            \"C\": \"CN\",\n            \"ST\": \"beijing\",\n            \"L\": \"beijing\",\n            \"O\": \"od\",\n            \"OU\": \"ops\"\n        }\n    ]\n}\n\ncerts]# cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=peer etcd-peer-csr.json |cfssl-json -bare etcd-peer\ncerts]# ll\n~~~\n\n> å…³äºè¿™äº›jsonæ–‡ä»¶æ˜¯æ€ä¹ˆå†™å‡ºæ¥çš„ï¼Œç­”æ¡ˆï¼šå®˜ç½‘æŠ„çš„ç„¶åä¿®æ”¹ï¼Œè¿™äº›æ²¡ä»€ä¹ˆé‡è¦çš„ä½ ä¹Ÿä¸éœ€è¦å¤ªåœ¨æ„ï¼Œåé¢é‡è¦çš„ä¼šè¯´æ˜æ˜¯ä»å“ªé‡ŒæŠ„å‡ºæ¥çš„\n>\n> **ca-config.jsonè§£æï¼š**\n>\n> - expiryï¼šæœ‰æ•ˆæœŸä¸º200å¹´\n> - profiles-serverï¼šå¯åŠ¨serverçš„æ—¶å€™éœ€è¦é…ç½®è¯ä¹¦\n> - profiles-clientï¼šclientå»è¿æ¥serverçš„æ—¶å€™éœ€è¦è¯ä¹¦\n> - profiles-peerï¼šåŒå‘è¯ä¹¦ï¼ŒæœåŠ¡ç«¯æ‰¾å®¢æˆ·ç«¯éœ€è¦è¯ä¹¦ï¼Œå®¢æˆ·ç«¯æ‰¾æœåŠ¡ç«¯éœ€è¦è¯ä¹¦\n>\n> **etcd-peer-csrè§£æï¼š**\n>\n> - hostsï¼šetcdæœ‰å¯èƒ½éƒ¨ç½²åˆ°å“ªäº›ç»„ä»¶çš„IPéƒ½è¦å¡«è¿›æ¥\n>\n> **cfssl gencert**ï¼šç”Ÿæˆè¯ä¹¦\n\n<img src=\"assets/WX20230512-100209@2x.png\"  />\n\n~~~\n# 12/21/22æœºå™¨ï¼Œå®‰è£…etcdï¼š\n~]# mkdir /opt/src\n~]# cd /opt/src/\n# åˆ›å»ºç”¨æˆ·\nsrc]# useradd -s /sbin/nologin -M etcd\nsrc]# id etcd\n\n# åˆ°GitHubä¸‹è½½æˆ–è€…ç›´æ¥ç”¨æˆ‘ç»™å¾—å®‰è£…åŒ… https://github.com/etcd-io/etcd/releases/tag/v3.1.20ï¼Œç™¾åº¦äº‘https://pan.baidu.com/s/1arE2LdtAbcR80gmIQtIELw æå–ç ï¼šouy1\nsrc]# wget https://github.com/etcd-io/etcd/releases/download/v3.1.20/etcd-v3.1.20-linux-amd64.tar.gz\nsrc]# tar xf etcd-v3.1.20-linux-amd64.tar.gz -C /opt\nsrc]# cd /opt\nopt]# mv etcd-v3.1.20-linux-amd64/ etcd-v3.1.20\nopt]# ln -s /opt/etcd-v3.1.20/ /opt/etcd\nopt]# cd etcd\n~~~\n\n> **tag**ï¼šå¯ä»¥åŠ å…¥ï¼Œè§£å¼€å¤‡ä»½æ–‡ä»¶å†…çš„æ–‡ä»¶\n>\n> - **x**ï¼šè§£å‹\n> - **f** ï¼šä½¿ç”¨æ¡£æ¡ˆåå­—\n> - **-C**ï¼šåˆ‡æ¢åˆ°æŒ‡å®šçš„ç›®å½•\n> - æ•´æ¡å‘½ä»¤åˆèµ·æ¥å°±æ˜¯ï¼ŒæŠŠtgzæ–‡ä»¶ä»¥tgzæ–‡ä»¶åä¸ºåå­—è§£å‹åˆ°optç›®å½•ä¸‹ï¼Œå¹¶ä¿å­˜tgzæ–‡ä»¶åŸæ ·\n>\n> **ln**ï¼šä¸ºæŸä¸€ä¸ªæ–‡ä»¶åœ¨å¦å¤–ä¸€ä¸ªä½ç½®å»ºç«‹ä¸€ä¸ªåŒæ­¥çš„é“¾æ¥\n>\n> - `è¯­æ³•:ln [å‚æ•°][æºæ–‡ä»¶æˆ–ç›®å½•][ç›®æ ‡æ–‡ä»¶æˆ–ç›®å½•]`\n> - **-s**ï¼šè½¯è¿æ¥ï¼Œå¯ä»¥å¯¹æ•´ä¸ªç›®å½•è¿›è¡Œé“¾æ¥\n>\n> **useradd**ï¼šå»ºç«‹ç”¨æˆ·å¸å·\n>\n> **-s**ï¼šæŒ‡å®šç”¨æˆ·ç™»å…¥åæ‰€ä½¿ç”¨çš„shell\n>\n> **-M**ï¼šä¸è¦è‡ªåŠ¨å»ºç«‹ç”¨æˆ·çš„ç™»å…¥ç›®å½•\n\n<img src=\"assets/WX20230511-194515@2x.png\"  />\n\n~~~\n# 12/21/22æœºå™¨ï¼š\netcd]# mkdir -p /opt/etcd/certs /data/etcd /data/logs/etcd-server\netcd]# cd certs/\ncerts]# scp hdss7-200:/opt/certs/ca.pem .\n# è¾“å…¥200è™šæœºå¯†ç \ncerts]# scp hdss7-200:/opt/certs/etcd-peer*.pem .\ncerts]# cd ..\n# 3å°æœºå™¨ï¼Œå¦‚æœæ˜¯21æœºå™¨ï¼Œè¿™ä¸‹é¢å¾—12éƒ½å¾—æ”¹æˆ21ï¼Œå¯¹åº”çš„ipæ¢æˆ21çš„å†…ç½‘ipï¼Œinitial-clusteråˆ™æ˜¯å…¨éƒ¨æœºå™¨éƒ½æœ‰ä¸éœ€è¦æ”¹ï¼Œä¸€å…±5å¤„ï¼šetcd-server-7-12ã€listen-peer-urlsåã€client-urlsåã€advertise-peer-urlsåã€advertise-client-urlsåï¼Œå¯ä»¥ç”¨:%s/æ—§ip/æ–°ip/gå‘½ä»¤è¿›è¡Œæ‰¹é‡æ›´æ¢(é€€å‡ºinsertåç²˜è´´)\netcd]# vi /opt/etcd/etcd-server-startup.sh\n#!/bin/sh\n./etcd --name etcd-server-7-12 \\\n       --data-dir /data/etcd/etcd-server \\\n       --listen-peer-urls https://172.27.139.119:2380 \\\n       --listen-client-urls https://172.27.139.119:2379,http://127.0.0.1:2379 \\\n       --quota-backend-bytes 8000000000 \\\n       --initial-advertise-peer-urls https://172.27.139.119:2380 \\\n       --advertise-client-urls https://172.27.139.119:2379,http://127.0.0.1:2379 \\\n       --initial-cluster  etcd-server-7-12=https://172.27.139.119:2380,etcd-server-7-21=https://172.27.139.118:2380,etcd-server-7-22=https://172.27.139.120:2380 \\\n       --ca-file ./certs/ca.pem \\\n       --cert-file ./certs/etcd-peer.pem \\\n       --key-file ./certs/etcd-peer-key.pem \\\n       --client-cert-auth  \\\n       --trusted-ca-file ./certs/ca.pem \\\n       --peer-ca-file ./certs/ca.pem \\\n       --peer-cert-file ./certs/etcd-peer.pem \\\n       --peer-key-file ./certs/etcd-peer-key.pem \\\n       --peer-client-cert-auth \\\n       --peer-trusted-ca-file ./certs/ca.pem \\\n       --log-output stdout\n\netcd]# chmod +x etcd-server-startup.sh\netcd]# chown -R etcd.etcd /opt/etcd-v3.1.20/\netcd]# chown -R etcd.etcd /data/etcd/\netcd]# chown -R etcd.etcd /data/logs/etcd-server/\netcd]# ll\n~~~\n\n> **scp**ï¼šç”¨äº *Linux* ä¹‹é—´å¤åˆ¶æ–‡ä»¶å’Œç›®å½•\n>\n> **å¸¦***ï¼šè¡¨ç¤ºæ¨¡ç³ŠåŒ¹é…ä»»æ„å†…å®¹\n>\n> **chmod**ï¼šæ·»åŠ æƒé™\n>\n> - **+x**ï¼šç»™å½“å‰ç”¨æˆ·æ·»åŠ å¯æ‰§è¡Œè¯¥æ–‡ä»¶çš„æƒé™æƒé™\n>\n> **chown**ï¼šæŒ‡å®šæ–‡ä»¶çš„æ‹¥æœ‰è€…æ”¹ä¸ºæŒ‡å®šçš„ç”¨æˆ·æˆ–ç»„\n>\n> - **-R**ï¼šå¤„ç†æŒ‡å®šç›®å½•ä»¥åŠå…¶å­ç›®å½•ä¸‹çš„æ‰€æœ‰æ–‡ä»¶\n> - è¿™é‡Œå³æ˜¯æŠŠ/opt/etcd...ç­‰çš„æ‹¥æœ‰è€…ç»™etcdç”¨æˆ·\n>\n> **ll**ï¼šåˆ—å‡ºæƒé™ã€å¤§å°ã€åç§°ç­‰ä¿¡æ¯\n\n<img src=\"assets/WX20230512-105320@2x.png\"  />\n\n~~~\n# 12/21/22æœºå™¨ï¼Œæˆ‘ä»¬åŒæ—¶éœ€è¦supervisorï¼ˆå®ˆæŠ¤è¿›ç¨‹å·¥å…·ï¼‰æ¥ç¡®ä¿etcdæ˜¯å¯åŠ¨çš„ï¼Œåé¢è¿˜ä¼šä¸æ–­ç”¨åˆ°ï¼š\n# è¿™ä¸ªæˆ‘ä»¬å‰é¢å·²ç»è£…äº† yum install supervisor -y\netcd]# systemctl start supervisord\netcd]# systemctl enable supervisord\n# æ³¨æ„ä¿®æ”¹ä¸‹é¢å¾—7-12ï¼Œå¯¹åº”ä¸Šæœºå™¨ï¼Œå¦‚21æœºå™¨å°±æ˜¯7-21ï¼Œä¸€å…±ä¸€å¤„ï¼š[program:etcd-server-7-12]\netcd]# vi /etc/supervisord.d/etcd-server.ini\n[program:etcd-server-7-12]\ncommand=/opt/etcd/etcd-server-startup.sh                        ; the program (relative uses PATH, can take args)\nnumprocs=1                                                      ; number of processes copies to start (def 1)\ndirectory=/opt/etcd                                             ; directory to cwd to before exec (def no cwd)\nautostart=true                                                  ; start at supervisord start (default: true)\nautorestart=true                                                ; retstart at unexpected quit (default: true)\nstartsecs=30                                                    ; number of secs prog must stay running (def. 1)\nstartretries=3                                                  ; max # of serial start failures (default 3)\nexitcodes=0,2                                                   ; 'expected' exit codes for process (default 0,2)\nstopsignal=QUIT                                                 ; signal used to kill process (default TERM)\nstopwaitsecs=10                                                 ; max num secs to wait b4 SIGKILL (default 10)\nuser=etcd                                                       ; setuid to this UNIX account to run the program\nredirect_stderr=true                                            ; redirect proc stderr to stdout (default false)\nstdout_logfile=/data/logs/etcd-server/etcd.stdout.log           ; stdout log path, NONE for none; default AUTO\nstdout_logfile_maxbytes=64MB                                    ; max # logfile bytes b4 rotation (default 50MB)\nstdout_logfile_backups=4                                        ; # of stdout logfile backups (default 10)\nstdout_capture_maxbytes=1MB                                     ; number of bytes in 'capturemode' (default 0)\nstdout_events_enabled=false                                     ; emit events on stdout writes (default false)\n\netcd]# supervisorctl update\n# outï¼šetcd-server-7-21: added process group\netcd]# supervisorctl status\n# out: etcd-server-7-12                 RUNNING   pid 16582, uptime 0:00:59\netcd]# netstat -luntp|grep etcd\n# å¿…é¡»æ˜¯ç›‘å¬äº†2379å’Œ2380è¿™ä¸¤ä¸ªç«¯å£æ‰ç®—æˆåŠŸ\ntcp        0      0 172.27.139.119:2379     0.0.0.0:*               LISTEN      14903/./etcd        \ntcp        0      0 127.0.0.1:2379          0.0.0.0:*               LISTEN      14903/./etcd        \ntcp        0      0 172.27.139.119:2380     0.0.0.0:*               LISTEN      14903/./etcd \n~~~\n\n> **systemctl enable**ï¼šå¼€æœºå¯åŠ¨\n>\n> **update**ï¼šæ›´æ–°\n>\n> **netstat -luntpï¼š**æŸ¥çœ‹ç«¯å£å’Œè¿›ç¨‹æƒ…å†µ\n>\n> ç°åœ¨ä½ å¯ä»¥æ„Ÿè§‰åˆ°ï¼Œsupervisorå®ˆæŠ¤è¿›ç¨‹ä¹Ÿä»…ä»…æ˜¯ä½ é…å¥½iniæ–‡ä»¶å³å¯\n\n~~~\n# ä»»æ„èŠ‚ç‚¹ï¼ˆ12/21/22ï¼‰æ£€æµ‹é›†ç¾¤å¥åº·çŠ¶æ€çš„ä¸¤ç§æ–¹æ³•\n22 etcd]# ./etcdctl cluster-health\n22 etcd]# ./etcdctl member list\n~~~\n\n<img src=\"assets/WX20230512-154055@2x.png\"  />\n\n> è¿™é‡Œä½ å†å“ªä¸ªæœºå™¨å…ˆupdateï¼Œå“ªä¸ªæœºå™¨å°±æ˜¯leader\n\nå®Œæˆ\n\n\n\n### éƒ¨ç½²API-serveré›†ç¾¤\n\n[kuberneteså®˜ç½‘](https://github.com/kubernetes/kubernetes)\n\næ ¹æ®æ¶æ„å›¾ï¼Œæˆ‘ä»¬æŠŠè¿ç®—èŠ‚ç‚¹éƒ¨ç½²åœ¨21å’Œ22æœºå™¨\n\n![1584701070750](assets/1584701070750.png)\n\n~~~\n# 21/22æœºå™¨\netcd]# cd /opt/src/\n# å¯ä»¥å»å®˜ç½‘ä¸‹è½½ä¹Ÿå¯ä»¥ç”¨æˆ‘çš„åŒ…ï¼Œç™¾åº¦äº‘ç›˜https://pan.baidu.com/s/1arE2LdtAbcR80gmIQtIELw æå–ç ï¼šouy1\nsrc]# wget https://dl.k8s.io/v1.15.2/kubernetes-server-linux-amd64.tar.gz\nsrc]# mv kubernetes-server-linux-amd64.tar.gz kubernetes-server-linux-amd64-v1.15.2.tar.gz\n\nsrc]# tar xf kubernetes-server-linux-amd64-v1.15.2.tar.gz -C /opt/\nsrc]# cd /opt\nopt]# mv kubernetes/ kubernetes-v1.15.2\nopt]# ln -s /opt/kubernetes-v1.15.2/ /opt/kubernetes\nopt]# cd kubernetes\n# åˆ æ‰ä¸éœ€è¦çš„æ–‡ä»¶\nkubernetes]# rm -rf kubernetes-src.tar.gz\nkubernetes]# cd server/bin\nbin]# rm -f *.tar\nbin]# rm -f *_tag\nbin]# ll\n~~~\n\n> **tar xf -C**ï¼šè§£å‹åˆ°æŸä¸ªæ–‡ä»¶å¤¹\n>\n> **mv**ï¼šç§»åŠ¨åˆ°å“ªé‡Œ\n>\n> **ln -s**ï¼šå»ºç«‹è½¯è¿æ¥\n>\n> **rm**ï¼šåˆ é™¤ä¸€ä¸ªæ–‡ä»¶æˆ–è€…ç›®å½•\n>\n> - **-r**ï¼šå°†ç›®å½•åŠä»¥ä¸‹ä¹‹æ¡£æ¡ˆäº¦é€ä¸€åˆ é™¤\n> - **-f**ï¼šç›´æ¥åˆ é™¤ï¼Œæ— éœ€é€ä¸€ç¡®è®¤ï¼ˆä½ å¯ä»¥è¯•è¯•å…ˆä¸åŠ -få»åˆ é™¤ï¼‰\n> - åŠ èµ·æ¥å°±æ˜¯å¼ºåˆ¶åˆ é™¤\n>\n> ***.tar**ï¼š è¿™é‡Œçš„*çš„æ„æ€æ˜¯æ¨¡ç³Šæ³•ï¼Œå³åªè¦ä½ çš„ç»“å°¾æ˜¯.tarçš„éƒ½åŒ¹é…ä¸ŠåŠ ä¸Šrmï¼Œå°±æ˜¯æŠŠæ‰€æœ‰.tarç»“å°¾çš„æ–‡ä»¶éƒ½åˆ é™¤\n\n<img src=\"assets/WX20230512-113733@2x.png\"  />\n\n~~~\n# 200æœºå™¨ï¼Œç­¾å‘clientè¯ä¹¦ï¼š\n200 ~]# cd /opt/certs/\n200 certs]# vi client-csr.json\n{\n    \"CN\": \"k8s-node\",\n    \"hosts\": [\n    ],\n    \"key\": {\n        \"algo\": \"rsa\",\n        \"size\": 2048\n    },\n    \"names\": [\n        {\n            \"C\": \"CN\",\n            \"ST\": \"beijing\",\n            \"L\": \"beijing\",\n            \"O\": \"od\",\n            \"OU\": \"ops\"\n        }\n    ]\n}\n\n200 certs]#  cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=client client-csr.json |cfssl-json -bare client\n200 certs]# ll\n~~~\n\n<img src=\"assets/WX20230512-133747@2x.png\" />\n\n~~~\n# 200æœºå™¨ï¼Œç»™API-serveråšè¯ä¹¦ï¼Œå…¶ä¸­\"127.0.0.1\"å’Œ\"192.168.0.1\"ä¸å˜ï¼Œä¸‹é¢4ä¸ªipåˆ†åˆ«æ˜¯å½“å‰ç½‘æ®µ.10åšè™šæ‹Ÿvipã€21æœºå™¨ipã€22æœºå™¨ipä»¥åŠé¢„ç•™çš„23æœºå™¨ipï¼ˆåç»­å¦‚æœéœ€è¦åˆ™æ‰©å®¹ï¼Œä¹Ÿå¯ä»¥ä¸å¡«ï¼‰\n200 certs]# vi apiserver-csr.json\n{\n    \"CN\": \"k8s-apiserver\",\n    \"hosts\": [\n        \"127.0.0.1\",\n        \"192.168.0.1\",\n        \"kubernetes.default\",\n        \"kubernetes.default.svc\",\n        \"kubernetes.default.svc.cluster\",\n        \"kubernetes.default.svc.cluster.local\",\n        \"172.27.139.10\",\n        \"172.27.139.118\",\n        \"172.27.139.120\",\n        \"172.27.139.123\"\n    ],\n    \"key\": {\n        \"algo\": \"rsa\",\n        \"size\": 2048\n    },\n    \"names\": [\n        {\n            \"C\": \"CN\",\n            \"ST\": \"beijing\",\n            \"L\": \"beijing\",\n            \"O\": \"od\",\n            \"OU\": \"ops\"\n        }\n    ]\n}\n\n200 certs]# cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=server apiserver-csr.json |cfssl-json -bare apiserver\n200 certs]# ll\n~~~\n\n> è¯·ç¡®ä¿ä½œä¸ºè™šæ‹Ÿvip172.27.139.10å¹¶ä¸çœŸå®å­˜åœ¨ï¼Œping 172.27.139.10åº”è¯¥æ˜¯ä¸é€šçš„\n\n<img src=\"assets/WX20230512-141539@2x.png\"  />\n\n~~~\n# 21/22æœºå™¨ï¼š\ncd /opt/kubernetes/server/bin\nbin]# mkdir cert\nbin]# cd cert/\n# æŠŠè¯ä¹¦è€ƒè¿‡æ¥ï¼Œä¸€å…±6ä¸ª\ncert]# scp hdss7-200:/opt/certs/c*.pem .\ncert]# scp hdss7-200:/opt/certs/apiserver*.pem .\n~~~\n\n> **scp**ï¼šç”¨äº *Linux* ä¹‹é—´å¤åˆ¶æ–‡ä»¶å’Œç›®å½•\n>\n> **å¸¦***ï¼šè¡¨ç¤ºæ¨¡ç³ŠåŒ¹é…ä»»æ„å†…å®¹\n\n~~~\n# 21/22æœºå™¨ï¼š\ncert]# ll\ntotal 24\n-rw------- 1 root root 1675 May 12 14:22 apiserver-key.pem\n-rw-r--r-- 1 root root 1602 May 12 14:22 apiserver.pem\n-rw------- 1 root root 1679 May 12 14:24 ca-key.pem\n-rw-r--r-- 1 root root 1346 May 12 14:24 ca.pem\n-rw------- 1 root root 1675 May 12 14:24 client-key.pem\n-rw-r--r-- 1 root root 1367 May 12 14:24 client.pem\ncert]# pwd\n/opt/kubernetes/server/bin/cert\n~~~\n\n~~~\n# 21/22æœºå™¨ï¼š\ncd /opt/kubernetes/server/bin\nbin]# mkdir conf\nbin]# cd conf/\nconf]# vi audit.yaml\napiVersion: audit.k8s.io/v1beta1 # This is required.\nkind: Policy\n# Don't generate audit events for all requests in RequestReceived stage.\nomitStages:\n  - \"RequestReceived\"\nrules:\n  # Log pod changes at RequestResponse level\n  - level: RequestResponse\n    resources:\n    - group: \"\"\n      # Resource \"pods\" doesn't match requests to any subresource of pods,\n      # which is consistent with the RBAC policy.\n      resources: [\"pods\"]\n  # Log \"pods/log\", \"pods/status\" at Metadata level\n  - level: Metadata\n    resources:\n    - group: \"\"\n      resources: [\"pods/log\", \"pods/status\"]\n\n  # Don't log requests to a configmap called \"controller-leader\"\n  - level: None\n    resources:\n    - group: \"\"\n      resources: [\"configmaps\"]\n      resourceNames: [\"controller-leader\"]\n\n  # Don't log watch requests by the \"system:kube-proxy\" on endpoints or services\n  - level: None\n    users: [\"system:kube-proxy\"]\n    verbs: [\"watch\"]\n    resources:\n    - group: \"\" # core API group\n      resources: [\"endpoints\", \"services\"]\n\n  # Don't log authenticated requests to certain non-resource URL paths.\n  - level: None\n    userGroups: [\"system:authenticated\"]\n    nonResourceURLs:\n    - \"/api*\" # Wildcard matching.\n    - \"/version\"\n\n  # Log the request body of configmap changes in kube-system.\n  - level: Request\n    resources:\n    - group: \"\" # core API group\n      resources: [\"configmaps\"]\n    # This rule only applies to resources in the \"kube-system\" namespace.\n    # The empty string \"\" can be used to select non-namespaced resources.\n    namespaces: [\"kube-system\"]\n\n  # Log configmap and secret changes in all other namespaces at the Metadata level.\n  - level: Metadata\n    resources:\n    - group: \"\" # core API group\n      resources: [\"secrets\", \"configmaps\"]\n\n  # Log all other resources in core and extensions at the Request level.\n  - level: Request\n    resources:\n    - group: \"\" # core API group\n    - group: \"extensions\" # Version of group should NOT be included.\n\n  # A catch-all rule to log all other requests at the Metadata level.\n  - level: Metadata\n    # Long-running requests like watches that fall under this rule will not\n    # generate an audit event in RequestReceived.\n    omitStages:\n      - \"RequestReceived\"\n      \nconf]# cd ..\n# ä¸‹é¢æœ‰3å¤„ipéœ€è¦æ”¹ï¼Œ--etcd-serversåˆ†åˆ«æ”¹æˆ12ã€21ã€22æœºå™¨çš„IP\nbin]# vi /opt/kubernetes/server/bin/kube-apiserver.sh\n#!/bin/bash\n./kube-apiserver \\\n  --apiserver-count 2 \\\n  --audit-log-path /data/logs/kubernetes/kube-apiserver/audit-log \\\n  --audit-policy-file ./conf/audit.yaml \\\n  --authorization-mode RBAC \\\n  --client-ca-file ./cert/ca.pem \\\n  --requestheader-client-ca-file ./cert/ca.pem \\\n  --enable-admission-plugins NamespaceLifecycle,LimitRanger,ServiceAccount,DefaultStorageClass,DefaultTolerationSeconds,MutatingAdmissionWebhook,ValidatingAdmissionWebhook,ResourceQuota \\\n  --etcd-cafile ./cert/ca.pem \\\n  --etcd-certfile ./cert/client.pem \\\n  --etcd-keyfile ./cert/client-key.pem \\\n  --etcd-servers https://172.27.139.119:2379,https://172.27.139.118:2379,https://172.27.139.120:2379 \\\n  --service-account-key-file ./cert/ca-key.pem \\\n  --service-cluster-ip-range 192.168.0.0/16 \\\n  --service-node-port-range 3000-29999 \\\n  --target-ram-mb=1024 \\\n  --kubelet-client-certificate ./cert/client.pem \\\n  --kubelet-client-key ./cert/client-key.pem \\\n  --log-dir  /data/logs/kubernetes/kube-apiserver \\\n  --tls-cert-file ./cert/apiserver.pem \\\n  --tls-private-key-file ./cert/apiserver-key.pem \\\n  --v 2\n  \nbin]# chmod +x kube-apiserver.sh\n# ä¸€å¤„ä¿®æ”¹ï¼š[program:kube-apiserver-7-21]ï¼Œ22æœºå™¨åˆ™æ”¹æˆ7-22\nbin]# vi /etc/supervisord.d/kube-apiserver.ini\n[program:kube-apiserver-7-21]\ncommand=/opt/kubernetes/server/bin/kube-apiserver.sh            ; the program (relative uses PATH, can take args)\nnumprocs=1                                                      ; number of processes copies to start (def 1)\ndirectory=/opt/kubernetes/server/bin                            ; directory to cwd to before exec (def no cwd)\nautostart=true                                                  ; start at supervisord start (default: true)\nautorestart=true                                                ; retstart at unexpected quit (default: true)\nstartsecs=30                                                    ; number of secs prog must stay running (def. 1)\nstartretries=3                                                  ; max # of serial start failures (default 3)\nexitcodes=0,2                                                   ; 'expected' exit codes for process (default 0,2)\nstopsignal=QUIT                                                 ; signal used to kill process (default TERM)\nstopwaitsecs=10                                                 ; max num secs to wait b4 SIGKILL (default 10)\nuser=root                                                       ; setuid to this UNIX account to run the program\nredirect_stderr=true                                            ; redirect proc stderr to stdout (default false)\nstdout_logfile=/data/logs/kubernetes/kube-apiserver/apiserver.stdout.log        ; stderr log path, NONE for none; default AUTO\nstdout_logfile_maxbytes=64MB                                    ; max # logfile bytes b4 rotation (default 50MB)\nstdout_logfile_backups=4                                        ; # of stdout logfile backups (default 10)\nstdout_capture_maxbytes=1MB                                     ; number of bytes in 'capturemode' (default 0)\nstdout_events_enabled=false                                     ; emit events on stdout writes (default false)\n\nbin]# mkdir -p /data/logs/kubernetes/kube-apiserver\nbin]# supervisorctl update\n# æŸ¥çœ‹21/22ä¸¤å°æœºå™¨æ˜¯å¦è·‘èµ·æ¥äº†ï¼Œå¯èƒ½æ¯”è¾ƒæ…¢åœ¨STARTINGï¼Œç­‰10ç§’\nbin]# supervisorctl status\n~~~\n\n> **mkdir -p**ï¼šåˆ›å»ºç›®å½•ï¼Œæ²¡æœ‰ä¸Šä¸€çº§ç›®å½•åˆ™åˆ›å»º\n>\n> **supervisorctl update**ï¼šæ›´æ–°supervisorctl\n>\n> **audit.yamlè§£æï¼š**\n>\n> - å¯ä»¥å‚è€ƒè¿™ç¯‡æ–‡ç« [ç‚¹å‡»è·³è½¬](https://www.baidu.com/link?url=tFECOG31lKlcqDWeAZGF1VyjhzVAN9vUKHKEKKw5G8y0AC8MKpJxSZeL647MIFdw&wd=&eqid=dafe84b80019e4a3000000065e51d2e2)ï¼Œå½“ç„¶è¿™é‡Œçš„audit.yamlå¯èƒ½ä¼šæœ‰äº›ä¸ä¸€æ ·ï¼Œä½†æ˜¯æˆ‘ä»¬åé¢ç”¨åˆ°çš„yamlæ–‡ä»¶å°±å¾ˆç›¸ä¼¼äº†\n\n<img src=\"assets/WX20230512-143347@2x.png\"  />\n\n> <a href=\"https://github.com/ben1234560/k8s_PaaS/blob/master/%E5%8E%9F%E7%90%86%E5%8F%8A%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/Kubernetes%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5.md#pod%E7%9A%84%E5%87%A0%E7%A7%8D%E7%8A%B6%E6%80%81\">Podçš„å‡ ç§çŠ¶æ€</a>\n\nå®Œæˆ\n\n\n\n### å®‰è£…éƒ¨ç½²ä¸»æ§èŠ‚ç‚¹L4åä»£æœåŠ¡\n\næ ¹æ®æˆ‘ä»¬æ¶æ„å›¾ï¼Œåœ¨11/12æœºå™¨ä¸Šåšåä»£\n\n![1584701103579](assets/1584701103579.png)\n\nå®‰è£…nginxæ—¶å¦ä¸€ä¸ªæ³¨æ„äº‹é¡¹ <a href=\"https://github.com/ben1234560/k8s_PaaS/issues/16\">ç‚¹å‡»é“¾æ¥Â Â </a>\n\nï¼ˆæ„Ÿè°¢ https://github.com/nangongchengfeng/ï¼‰\n\n~~~\n# 11/12æœºå™¨åŠ21/22æœºå™¨ï¼ˆè€ƒè™‘åˆ°å…¬æœ‰äº‘çš„ç½‘ç»œæƒ…å†µï¼Œæˆ‘ä»¬å°†21/22æœºå™¨åŒæ—¶ä¹Ÿä½œä¸ºå¤‡åä»£èŠ‚ç‚¹ï¼‰\n# è¿™ä¸ªå‰é¢å·²ç»å®‰è£… yum install nginx nginx-mod-stream -y\n# æ·»åŠ åœ¨æœ€ä¸‹é¢ï¼Œserverå¤„éœ€è¦æ”¹æˆè‡ªå·±çš„21ã€22æœºå™¨IP\n~]# vi /etc/nginx/nginx.conf\nstream {\n    upstream kube-apiserver {\n        server 172.27.139.118:6443     max_fails=3 fail_timeout=30s;\n        server 172.27.139.120:6443     max_fails=3 fail_timeout=30s;\n    }\n    server {\n        listen 7443;\n        proxy_connect_timeout 2s;\n        proxy_timeout 900s;\n        proxy_pass kube-apiserver;\n    }\n}\n\n~]# nginx -t\n~]# systemctl start nginx\n~]# systemctl enable nginx\n\n# è¿™ä¸ªå‰é¢å·²ç»å®‰è£… yum install keepalived -y\n# keepalived ç›‘æ§ç«¯å£è„šæœ¬\n~]# vi /etc/keepalived/check_port.sh\n#!/bin/bash\nCHK_PORT=$1\nif [ -n \"$CHK_PORT\" ];then\n        PORT_PROCESS=`ss -lnt|grep $CHK_PORT|wc -l`\n        if [ $PORT_PROCESS -eq 0 ];then\n                echo \"Port $CHK_PORT Is Not Used,End.\"\n                exit 1\n        fi\nelse\n        echo \"Check Port Cant Be Empty!\"\nfi\n\n~]# chmod +x /etc/keepalived/check_port.sh\n~~~\n\n> ç”±äº7443ç«¯å£æœªç›‘å¬ï¼ŒNginx å¯åŠ¨æŠ¥ [emerg] bind() failedçš„å¯ä»¥å‚è€ƒ[è¿™ä¸ªæ–¹æ³•](https://blog.csdn.net/RunSnail2018/article/details/81185138)ï¼ˆæ„Ÿè°¢https://gitee.com/wangming91/ï¼‰\n>\n> ä¸Šè¿°ä»£ç è§£æï¼š`upstream` å—ï¼šå®šä¹‰äº†åä¸º `kube-apiserver` çš„ä¸Šæ¸¸æœåŠ¡å™¨ç»„ã€‚åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œè¯¥ç»„ç”±ä¸¤ä¸ªæœåŠ¡å™¨ç»„æˆï¼ŒæŒ‡å®šäº†ä¸Šæ¸¸æœåŠ¡å™¨çš„ IP åœ°å€å’Œç«¯å£ã€‚`server` å—ï¼šå®šä¹‰äº†ä¸€ä¸ªä»£ç†æœåŠ¡å™¨ï¼Œå®ƒç›‘å¬æœ¬åœ°ç«¯å£ `7443`ï¼Œå¹¶å°†è¯·æ±‚ä»£ç†åˆ°ä¸Šæ¸¸æœåŠ¡å™¨ç»„ `kube-apiserver`\n>\n> é€šè¿‡è¿™ä¸ªé…ç½®ï¼Œå½“æœ‰è¯·æ±‚å‘é€åˆ°ä»£ç†æœåŠ¡å™¨çš„ `7443` ç«¯å£æ—¶ï¼ŒNginx å°†ä¼šå°†è¯·æ±‚è½¬å‘åˆ° `kube-apiserver` ä¸Šæ¸¸æœåŠ¡å™¨ç»„ä¸­çš„ä¸€ä¸ªæœåŠ¡å™¨ä¸Šè¿›è¡Œå¤„ç†ã€‚è¿™å¯ä»¥ç”¨äºä»£ç†å’Œè´Ÿè½½å‡è¡¡å¯¹ `kube-apiserver` çš„è¯·æ±‚ã€‚\n>\n> **yum install -y**ï¼šå®‰è£…å¹¶è‡ªåŠ¨yes\n>\n> **nginx -t**ï¼šç¡®å®šnginx.confæœ‰æ²¡æœ‰è¯­æ³•é”™è¯¯\n>\n> **systemctl start**ï¼šå¯åŠ¨æœåŠ¡\n>\n> **systemctl enable**ï¼šå¼€æœºè‡ªå¯\n\n~~~\n# ä»…ä»¥ä¸‹åˆ†ä¸»ä»æ“ä½œï¼š\n# æŠŠåŸæœ‰å†…å®¹éƒ½åˆ æ‰ï¼Œå‘½ä»¤è¡Œå¿«é€ŸæŒ‰æ‰“å‡ºdG\n# æ³¨æ„ï¼Œä¸‹é¢çš„vrrp_instanceä¸‹çš„interfaceï¼Œæˆ‘çš„æœºå™¨æ˜¯eth0é…ç½®äº†ç½‘å¡ï¼Œæœ‰çš„ç‰ˆæœ¬æ˜¯ens33é…ç½®ç½‘å¡ï¼Œå¯ä»¥ç”¨ifconfigæŸ¥çœ‹ï¼Œç¬¬ä¸€è¡Œå°±æ˜¯ï¼Œå¦‚æœä½ æ˜¯ens33ï¼Œæ”¹è¿™ä¸ªinterface ens33\n# keepalived ä¸»ï¼ˆå³11æœºå™¨ï¼‰ï¼Œä¿®æ”¹router_idã€mcast_src_ipä¸¤å¤„ä¸º11æœºå™¨çš„ipï¼Œä¿®æ”¹virtual_ipaddressä¸ºè™šæ‹Ÿvip 10:\n11 ~]# vi /etc/keepalived/keepalived.conf\n! Configuration File for keepalived\n\nglobal_defs {\n   router_id 172.27.139.122\n\n}\n\nvrrp_script chk_nginx {\n    script \"/etc/keepalived/check_port.sh 7443\"\n    interval 2\n    weight -20\n}\n\nvrrp_instance VI_1 {\n    state MASTER\n    interface eth0\n    virtual_router_id 251\n    priority 100\n    advert_int 1\n    mcast_src_ip 172.27.139.122\n    nopreempt\n\n    authentication {\n        auth_type PASS\n        auth_pass 11111111\n    }\n    track_script {\n         chk_nginx\n    }\n    virtual_ipaddress {\n        172.27.139.10\n    }\n}\n\n# keepalivedä»ï¼ˆå³12/21/22æœºå™¨ï¼‰ï¼Œä¿®æ”¹router_idã€mcast_src_ipä¸¤å¤„ä¸º12æˆ–21æˆ–22æœºå™¨çš„ipï¼Œä¿®æ”¹virtual_ipaddressä¸ºè™šæ‹Ÿvip 10:\n12/21/22 ~]# vi /etc/keepalived/keepalived.conf\n! Configuration File for keepalived\nglobal_defs {\n\trouter_id 172.27.139.119\n}\nvrrp_script chk_nginx {\n\tscript \"/etc/keepalived/check_port.sh 7443\"\n\tinterval 2\n\tweight -20\n}\nvrrp_instance VI_1 {\n\tstate BACKUP\n\tinterface eth0\n\tvirtual_router_id 251\n\tmcast_src_ip 172.27.139.119\n\tpriority 90\n\tadvert_int 1\n\tauthentication {\n\t\tauth_type PASS\n\t\tauth_pass 11111111\n\t}\n\ttrack_script {\n\t\tchk_nginx\n\t}\n\tvirtual_ipaddress {\n\t\t172.27.139.10\n\t}\n}\n~~~\n\nå¯åŠ¨keepalived\n\n~~~\n# 11/12/21/22æœºå™¨\n~]# systemctl start keepalived\n~]# systemctl enable keepalived\n# åœ¨11/12/21/22æœºå™¨\n11 ~]# ip add\n~~~\n\n<img src=\"assets/WX20230512-144506@2x.png\" />\n\nç¡®ä¿21/22æœºå™¨èƒ½å¤Ÿtelneté€šè™šæ‹Ÿvip 10çš„7443ç«¯å£\n\n~~~\n21 ~]# telnet 172.27.139.10 7443\nTrying 172.27.139.10...\nConnected to 172.27.139.10.\nEscape character is '^]'.\n\n22 ~]# telnet 172.27.139.10 7443\nTrying 172.27.139.10...\nConnected to 172.27.139.10.\nEscape character is '^]'.\n~~~\n\nå®Œæˆ\n\n\n\n### å®‰è£…éƒ¨ç½²controller-managerï¼ˆèŠ‚ç‚¹æ§åˆ¶å™¨/è°ƒåº¦å™¨æœåŠ¡ï¼‰\n\nè®©æˆ‘ä»¬å†æ¬å‡ºæˆ‘ä»¬çš„æ¶æ„å›¾\n\n![1584701137068](assets/1584701137068.png)\n\n~~~\n# 21/22æœºå™¨ï¼š\nbin]# vi /opt/kubernetes/server/bin/kube-controller-manager.sh\n#!/bin/sh\n./kube-controller-manager \\\n  --cluster-cidr 172.7.0.0/16 \\\n  --leader-elect true \\\n  --log-dir /data/logs/kubernetes/kube-controller-manager \\\n  --master http://127.0.0.1:8080 \\\n  --service-account-private-key-file ./cert/ca-key.pem \\\n  --service-cluster-ip-range 192.168.0.0/16 \\\n  --root-ca-file ./cert/ca.pem \\\n  --v 2\n\nbin]# chmod +x /opt/kubernetes/server/bin/kube-controller-manager.sh\nbin]# mkdir -p /data/logs/kubernetes/kube-controller-manager\n# æ³¨æ„22æœºå™¨ï¼Œä¸‹é¢è¦æ”¹æˆ7-22ï¼Œä¸€å¤„ä¿®æ”¹ï¼šmanager-7-21]\nbin]# vi /etc/supervisord.d/kube-conntroller-manager.ini\n[program:kube-controller-manager-7-21]\ncommand=/opt/kubernetes/server/bin/kube-controller-manager.sh                     ; the program (relative uses PATH, can take args)\nnumprocs=1                                                                        ; number of processes copies to start (def 1)\ndirectory=/opt/kubernetes/server/bin                                              ; directory to cwd to before exec (def no cwd)\nautostart=true                                                                    ; start at supervisord start (default: true)\nautorestart=true                                                                  ; retstart at unexpected quit (default: true)\nstartsecs=30                                                                      ; number of secs prog must stay running (def. 1)\nstartretries=3                                                                    ; max # of serial start failures (default 3)\nexitcodes=0,2                                                                     ; 'expected' exit codes for process (default 0,2)\nstopsignal=QUIT                                                                   ; signal used to kill process (default TERM)\nstopwaitsecs=10                                                                   ; max num secs to wait b4 SIGKILL (default 10)\nuser=root                                                                         ; setuid to this UNIX account to run the program\nredirect_stderr=true                                                              ; redirect proc stderr to stdout (default false)\nstdout_logfile=/data/logs/kubernetes/kube-controller-manager/controller.stdout.log  ; stderr log path, NONE for none; default AUTO\nstdout_logfile_maxbytes=64MB                                                      ; max # logfile bytes b4 rotation (default 50MB)\nstdout_logfile_backups=4                                                          ; # of stdout logfile backups (default 10)\nstdout_capture_maxbytes=1MB                                                       ; number of bytes in 'capturemode' (default 0)\nstdout_events_enabled=false                                                       ; emit events on stdout writes (default false)\n\nbin]# supervisorctl update\nbin]# vi /opt/kubernetes/server/bin/kube-scheduler.sh\n#!/bin/sh\n./kube-scheduler \\\n  --leader-elect  \\\n  --log-dir /data/logs/kubernetes/kube-scheduler \\\n  --master http://127.0.0.1:8080 \\\n  --v 2\n  \nbin]# chmod +x /opt/kubernetes/server/bin/kube-scheduler.sh\nbin]# mkdir -p /data/logs/kubernetes/kube-scheduler\n# æ³¨æ„æ”¹æœºå™¨å·ï¼Œä¸€å¤„ä¿®æ”¹ï¼šscheduler-7-21]\nbin]# vi /etc/supervisord.d/kube-scheduler.ini\n[program:kube-scheduler-7-21]\ncommand=/opt/kubernetes/server/bin/kube-scheduler.sh                     ; the program (relative uses PATH, can take args)\nnumprocs=1                                                               ; number of processes copies to start (def 1)\ndirectory=/opt/kubernetes/server/bin                                     ; directory to cwd to before exec (def no cwd)\nautostart=true                                                           ; start at supervisord start (default: true)\nautorestart=true                                                         ; retstart at unexpected quit (default: true)\nstartsecs=30                                                             ; number of secs prog must stay running (def. 1)\nstartretries=3                                                           ; max # of serial start failures (default 3)\nexitcodes=0,2                                                            ; 'expected' exit codes for process (default 0,2)\nstopsignal=QUIT                                                          ; signal used to kill process (default TERM)\nstopwaitsecs=10                                                          ; max num secs to wait b4 SIGKILL (default 10)\nuser=root                                                                ; setuid to this UNIX account to run the program\nredirect_stderr=true                                                     ; redirect proc stderr to stdout (default false)\nstdout_logfile=/data/logs/kubernetes/kube-scheduler/scheduler.stdout.log ; stderr log path, NONE for none; default AUTO\nstdout_logfile_maxbytes=64MB                                             ; max # logfile bytes b4 rotation (default 50MB)\nstdout_logfile_backups=4                                                 ; # of stdout logfile backups (default 10)\nstdout_capture_maxbytes=1MB                                              ; number of bytes in 'capturemode' (default 0)\nstdout_events_enabled=false                                              ; emit events on stdout writes (default false)\n\nbin]# supervisorctl update\nbin]# supervisorctl status\netcd-server-7-21                 RUNNING   pid 14765, uptime 4:30:28\nkube-apiserver-7-21              RUNNING   pid 16088, uptime 0:53:15\nkube-controller-manager-7-21     RUNNING   pid 18734, uptime 0:01:56\nkube-scheduler-7-21              RUNNING   pid 18958, uptime 0:00:47\n\nbin]# ln -s /opt/kubernetes/server/bin/kubectl /usr/bin/kubectl\n# æŸ¥çœ‹é›†ç¾¤å¥åº·æƒ…å†µï¼Œ21/22æœºå™¨ï¼š\nbin]# kubectl get cs\nNAME                 STATUS    MESSAGE              ERROR\nscheduler            Healthy   ok                   \ncontroller-manager   Healthy   ok                   \netcd-2               Healthy   {\"health\": \"true\"}   \netcd-1               Healthy   {\"health\": \"true\"}   \netcd-0               Healthy   {\"health\": \"true\"} \n~~~\n\n> **ln -s**ï¼šå»ºç«‹è½¯é“¾æ¥\n>\n> **supervisorctl status**ï¼šæŸ¥çœ‹supervisorçš„æƒ…å†µ\n>\n> **supervisorctl update**ï¼šæ›´æ–°supervisor\n>\n> **kubectl get**ï¼šè·å–åˆ—å‡ºä¸€ä¸ªæˆ–å¤šä¸ªèµ„æºçš„ä¿¡æ¯\n>\n> - ä¸Šé¢ä¸€æ¡å‘½ä»¤çš„æ„æ€æ˜¯ï¼š    åˆ—å‡ºæ‰€æœ‰csä¿¡æ¯\n\nå®Œæˆ\n\n\n\n### å®‰è£…éƒ¨ç½²è¿ç®—èŠ‚ç‚¹æœåŠ¡ï¼ˆkubeletï¼‰\n\n~~~\n# 200æœºå™¨ï¼Œç­¾å‘è¯ä¹¦ï¼Œå°†è™šæ‹Ÿvip10ï¼Œ21ã€22ã€23ç­‰åç»­å¯èƒ½æ‰©å±•çš„IPåŠ å…¥\n200 certs]# vi kubelet-csr.json\n{\n    \"CN\": \"k8s-kubelet\",\n    \"hosts\": [\n    \"127.0.0.1\",\n    \"172.27.139.10\",\n    \"172.27.139.118\",\n    \"172.27.139.120\",\n    \"172.27.139.123\",\n    \"172.27.139.124\",\n    \"172.27.139.125\",\n    \"172.27.139.126\",\n    \"172.27.139.127\",\n    \"172.27.139.128\"\n    ],\n    \"key\": {\n        \"algo\": \"rsa\",\n        \"size\": 2048\n    },\n    \"names\": [\n        {\n            \"C\": \"CN\",\n            \"ST\": \"beijing\",\n            \"L\": \"beijing\",\n            \"O\": \"od\",\n            \"OU\": \"ops\"\n        }\n    ]\n}\n\n200 certs]# cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=server kubelet-csr.json | cfssl-json -bare kubelet\n200 certs]#  ll |grep kubelet\n-rw-r--r-- 1 root root 1115 May 12 15:45 kubelet.csr\n-rw-r--r-- 1 root root  496 May 12 15:45 kubelet-csr.json\n-rw------- 1 root root 1679 May 12 15:45 kubelet-key.pem\n-rw-r--r-- 1 root root 1468 May 12 15:45 kubelet.pem\n~~~\n\n> **kubelet-csr-hosts**ï¼šæŠŠæ‰€æœ‰å¯èƒ½ç”¨åˆ°çš„IPéƒ½æ”¾è¿›æ¥\n\n~~~\n# åˆ†å‘è¯ä¹¦ï¼Œ21/22æœºå™¨\ncert]# cd /opt/kubernetes/server/bin/cert/\ncert]# scp hdss7-200:/opt/certs/kubelet.pem .\ncert]# scp hdss7-200:/opt/certs/kubelet-key.pem .\n\n# 21æœºå™¨ï¼Œä¿®æ”¹--serverçš„ipä¸ºè™šæ‹Ÿvip10ï¼š\ncert]# cd ../conf/\nconf]# kubectl config set-cluster myk8s \\\n  --certificate-authority=/opt/kubernetes/server/bin/cert/ca.pem \\\n  --embed-certs=true \\\n  --server=https://172.27.139.10:7443 \\\n  --kubeconfig=kubelet.kubeconfig\n\n# out: Cluster \"myk8s\" set.\nconf]# kubectl config set-credentials k8s-node \\\n  --client-certificate=/opt/kubernetes/server/bin/cert/client.pem \\\n  --client-key=/opt/kubernetes/server/bin/cert/client-key.pem \\\n  --embed-certs=true \\\n  --kubeconfig=kubelet.kubeconfig \n\n# out: User \"k8s-node\" set.\nconf]# kubectl config set-context myk8s-context \\\n  --cluster=myk8s \\\n  --user=k8s-node \\\n  --kubeconfig=kubelet.kubeconfig\n\nout: Context \"myk8s-context\" created.\nconf]# kubectl config use-context myk8s-context --kubeconfig=kubelet.kubeconfig\n\n#out: Switched to context \"myk8s-context\".\n# åšæƒé™æˆæƒï¼Œæ¨èæ–‡ç« https://www.jianshu.com/p/9991f189495f\nconf]# vi k8s-node.yaml\napiVersion: rbac.authorization.k8s.io/v1\nkind: ClusterRoleBinding\nmetadata:\n  name: k8s-node\nroleRef:\n  apiGroup: rbac.authorization.k8s.io\n  kind: ClusterRole\n  name: system:node\nsubjects:\n- apiGroup: rbac.authorization.k8s.io\n  kind: User\n  name: k8s-node\n  \nconf]# kubectl create -f k8s-node.yaml\n# out: clusterrolebinding.rbac.authorization.k8s.io/k8s-node created\nconf]# kubectl get clusterrolebinding k8s-node -o yaml\napiVersion: rbac.authorization.k8s.io/v1\nkind: ClusterRoleBinding\nmetadata:\n  creationTimestamp: \"2023-05-12T07:50:58Z\"\n  name: k8s-node\n  resourceVersion: \"2709\"\n  selfLink: /apis/rbac.authorization.k8s.io/v1/clusterrolebindings/k8s-node\n  uid: 704e0b50-857e-48d7-a028-ff46682d2761\nroleRef:\n  apiGroup: rbac.authorization.k8s.io\n  kind: ClusterRole\n  name: system:node\nsubjects:\n- apiGroup: rbac.authorization.k8s.io\n  kind: User\n  name: k8s-node\n\n# 22æœºå™¨ï¼Œå¤åˆ¶21æœºå™¨å³å¯\ncert]# cd ../conf/\nconf]# scp hdss7-21:/opt/kubernetes/server/bin/conf/kubelet.kubeconfig .\n~~~\n\n> **scp**ï¼šç”¨äº *Linux* ä¹‹é—´å¤åˆ¶æ–‡ä»¶å’Œç›®å½•\n>\n> **kubectl create -f**  ï¼šé€šè¿‡é…ç½®æ–‡ä»¶åæˆ–stdinåˆ›å»ºä¸€ä¸ªé›†ç¾¤èµ„æºå¯¹è±¡\n>\n> **kubectl get ... -o ...**  ï¼šåˆ—å‡ºPodä»¥åŠè¿è¡ŒPodèŠ‚ç‚¹ä¿¡æ¯ï¼ˆä½ å¯ä»¥è¯•ä¸‹ä¸åŠ -oå’ŒåŠ -oçš„åŒºåˆ«ï¼‰\n\n~~~\n# å‡†å¤‡pauseåŸºç¡€é•œåƒï¼Œ200æœºå™¨ï¼š\ncerts]# docker pull kubernetes/pause\ncerts]# docker images|grep pause\n# out: kubernetes/pause                latest                     f9d5de079539   8 years ago   240kB\ncerts]# docker tag f9d5de079539 harbor.od.com/public/pause:latest\ncerts]# docker push harbor.od.com/public/pause:latest\n~~~\n\n> **docker pull**ï¼šä¸‹è½½é•œåƒ\n>\n> **docker images**ï¼šåˆ—å‡ºæ‰€æœ‰çš„é•œåƒ\n>\n> - è¿™é‡ŒåŠ ä¸Š|grep ç®¡é“ç¬¦æ˜¯ä¸ºäº†è¿‡æ»¤å‡ºæ¥pauseé•œåƒ\n>\n> **docker tag**ï¼šç»™é•œåƒæ‰“åå­—\n>\n> **docker push**ï¼šå°†é•œåƒæ¨é€åˆ°æŒ‡å®šçš„ä»“åº“\n\n~~~\n# 21/21æœºå™¨ï¼Œæ³¨æ„ä¿®æ”¹ä¸»æœºåï¼Œæœ‰ä¸€å¤„hostname-overrideéœ€è¦æ”¹ï¼šhdss7-21\nbin]# vi /opt/kubernetes/server/bin/kubelet.sh\n#!/bin/sh\n./kubelet \\\n  --anonymous-auth=false \\\n  --cgroup-driver systemd \\\n  --cluster-dns 192.168.0.2 \\\n  --cluster-domain cluster.local \\\n  --runtime-cgroups=/systemd/system.slice \\\n  --kubelet-cgroups=/systemd/system.slice \\\n  --fail-swap-on=\"false\" \\\n  --client-ca-file ./cert/ca.pem \\\n  --tls-cert-file ./cert/kubelet.pem \\\n  --tls-private-key-file ./cert/kubelet-key.pem \\\n  --hostname-override hdss7-21.host.com \\\n  --image-gc-high-threshold 20 \\\n  --image-gc-low-threshold 10 \\\n  --kubeconfig ./conf/kubelet.kubeconfig \\\n  --log-dir /data/logs/kubernetes/kube-kubelet \\\n  --pod-infra-container-image harbor.od.com/public/pause:latest \\\n  --root-dir /data/kubelet\n  \nconf]# cd /opt/kubernetes/server/bin\nbin]# mkdir -p /data/logs/kubernetes/kube-kubelet /data/kubelet\nbin]# chmod +x kubelet.sh\n# æœ‰ä¸€å¤„è¦ä¿®æ”¹ä¸»æœºåï¼škube-kubelet-7-21\nbin]# vi /etc/supervisord.d/kube-kubelet.ini\n[program:kube-kubelet-7-21]\ncommand=/opt/kubernetes/server/bin/kubelet.sh     ; the program (relative uses PATH, can take args)\nnumprocs=1                                        ; number of processes copies to start (def 1)\ndirectory=/opt/kubernetes/server/bin              ; directory to cwd to before exec (def no cwd)\nautostart=true                                    ; start at supervisord start (default: true)\nautorestart=true              \t\t          ; retstart at unexpected quit (default: true)\nstartsecs=30                                      ; number of secs prog must stay running (def. 1)\nstartretries=3                                    ; max # of serial start failures (default 3)\nexitcodes=0,2                                     ; 'expected' exit codes for process (default 0,2)\nstopsignal=QUIT                                   ; signal used to kill process (default TERM)\nstopwaitsecs=10                                   ; max num secs to wait b4 SIGKILL (default 10)\nuser=root                                         ; setuid to this UNIX account to run the program\nredirect_stderr=true                              ; redirect proc stderr to stdout (default false)\nstdout_logfile=/data/logs/kubernetes/kube-kubelet/kubelet.stdout.log   ; stderr log path, NONE for none; default AUTO\nstdout_logfile_maxbytes=64MB                      ; max # logfile bytes b4 rotation (default 50MB)\nstdout_logfile_backups=4                          ; # of stdout logfile backups (default 10)\nstdout_capture_maxbytes=1MB                       ; number of bytes in 'capturemode' (default 0)\nstdout_events_enabled=false                       ; emit events on stdout writes (default false)\n\nbin]# supervisorctl update\nbin]# supervisorctl status\netcd-server-7-21                 RUNNING   pid 14765, uptime 5:02:11\nkube-apiserver-7-21              RUNNING   pid 16088, uptime 1:24:58\nkube-controller-manager-7-21     RUNNING   pid 18734, uptime 0:33:39\nkube-kubelet-7-21                RUNNING   pid 24802, uptime 0:00:53\nkube-scheduler-7-21              RUNNING   pid 18958, uptime 0:32:30\n\nbin]# kubectl get nodes\nNAME                STATUS   ROLES    AGE   VERSION\nhdss7-21.host.com   Ready    <none>   54s   v1.15.2\nhdss7-22.host.com   Ready    <none>   53s   v1.15.2\n\n# ç»™æ ‡ç­¾,21/22éƒ½ç»™ä¸Šmaster,node\nbin]# kubectl label node hdss7-21.host.com node-role.kubernetes.io/master=\nbin]# kubectl label node hdss7-21.host.com node-role.kubernetes.io/node=\nbin]# kubectl label node hdss7-22.host.com node-role.kubernetes.io/master=\nbin]# kubectl label node hdss7-22.host.com node-role.kubernetes.io/node=\nbin]# kubectl get nodes\n~~~\n\n<img src=\"assets/WX20230512-155833@2x.png\"  />\n\nå®Œæˆ\n\n\n\n### å®‰è£…éƒ¨ç½²è¿ç®—èŠ‚ç‚¹æœåŠ¡ï¼ˆkube-proxyï¼‰\n\n~~~\n# 200æœºå™¨ï¼Œç­¾å‘è¯ä¹¦è¯·æ±‚æ–‡ä»¶ï¼š\n200 certs]# vi kube-proxy-csr.json\n{\n    \"CN\": \"system:kube-proxy\",\n    \"key\": {\n        \"algo\": \"rsa\",\n        \"size\": 2048\n    },\n    \"names\": [\n        {\n            \"C\": \"CN\",\n            \"ST\": \"beijing\",\n            \"L\": \"beijing\",\n            \"O\": \"od\",\n            \"OU\": \"ops\"\n        }\n    ]\n}\n\n200 certs]# cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=client kube-proxy-csr.json |cfssl-json -bare kube-proxy-client\n200 certs]# ll |grep proxy\n-rw-r--r-- 1 root root 1005 May 12 16:04 kube-proxy-client.csr\n-rw------- 1 root root 1675 May 12 16:04 kube-proxy-client-key.pem\n-rw-r--r-- 1 root root 1379 May 12 16:04 kube-proxy-client.pem\n-rw-r--r-- 1 root root  267 May 12 16:04 kube-proxy-csr.json\n~~~\n\n\n\n~~~\n# åˆ†å‘è¯ä¹¦ï¼Œ21/22æœºå™¨ï¼š\ncd /opt/kubernetes/server/bin/cert\ncert]# scp hdss7-200:/opt/certs/kube-proxy-client.pem .\ncert]# scp hdss7-200:/opt/certs/kube-proxy-client-key.pem .\ncert]# cd ../conf/\n\n# 21æœºå™¨ï¼Œ--serverdçš„IPæ”¹æˆè™šæ‹Ÿvip 10ï¼š\nconf]# kubectl config set-cluster myk8s \\\n  --certificate-authority=/opt/kubernetes/server/bin/cert/ca.pem \\\n  --embed-certs=true \\\n  --server=https://172.27.139.10:7443 \\\n  --kubeconfig=kube-proxy.kubeconfig\n\n# out: Cluster \"myk8s\" set.\nconf]# kubectl config set-credentials kube-proxy \\\n  --client-certificate=/opt/kubernetes/server/bin/cert/kube-proxy-client.pem \\\n  --client-key=/opt/kubernetes/server/bin/cert/kube-proxy-client-key.pem \\\n  --embed-certs=true \\\n  --kubeconfig=kube-proxy.kubeconfig\n\n# out: User \"kube-proxy\" set.\nconf]# kubectl config set-context myk8s-context \\\n  --cluster=myk8s \\\n  --user=kube-proxy \\\n  --kubeconfig=kube-proxy.kubeconfig\n\n# out: Context \"myk8s-context\" created.\nconf]# kubectl config use-context myk8s-context --kubeconfig=kube-proxy.kubeconfig\n\n# out: Switched to context \"myk8s-context\".\n# 22æœºå™¨\nconf]# scp hdss7-21:/opt/kubernetes/server/bin/conf/kube-proxy.kubeconfig .\n\n\n# 21/22æœºå™¨ï¼š\ncd\n~]# lsmod |grep ip_vs\nip_vs                 145497  0 \nnf_conntrack          137239  7 ip_vs,nf_nat,nf_nat_ipv4,xt_conntrack,nf_nat_masquerade_ipv4,nf_conntrack_netlink,nf_conntrack_ipv4\nlibcrc32c              12644  3 ip_vs,nf_nat,nf_conntrack\n\n~]# vi ipvs.sh\n#!/bin/bash\nipvs_mods_dir=\"/usr/lib/modules/$(uname -r)/kernel/net/netfilter/ipvs\"\nfor i in $(ls $ipvs_mods_dir|grep -o \"^[^.]*\")\ndo\n  /sbin/modinfo -F filename $i &>/dev/null\n  if [ $? -eq 0 ];then\n    /sbin/modprobe $i\n  fi\ndone\n\n~]# chmod +x ipvs.sh\n~]# ./ipvs.sh\n~]# lsmod |grep ip_vs\n~~~\n\n> **lsmod**ï¼šæ˜¾ç¤ºå·²è½½å…¥ç³»ç»Ÿçš„æ¨¡å—\n>\n> - åé¢å¸¦çš„ç®¡é“ç¬¦åˆ™æ˜¯è¿‡æ»¤å‡ºip_vsæ¥\n>\n> **chmod +x**ï¼šç»™æ–‡ä»¶æ·»åŠ æ‰§è¡Œæƒé™\n>\n> **./ipvs.sh**ï¼šè¿è¡Œæ–‡ä»¶\n\n<img src=\"assets/WX20230512-161204@2x.png\" />\n\n~~~\n# 21/22æœºå™¨ï¼š\n~]# cd /opt/kubernetes/server/bin/\n# æ³¨æ„ä¿®æ”¹å¯¹åº”çš„æœºå™¨ipï¼Œæœ‰ä¸€å¤„hostname-overrideä¿®æ”¹ï¼šhdss7-21\nbin]# vi /opt/kubernetes/server/bin/kube-proxy.sh\n#!/bin/sh\n./kube-proxy \\\n  --cluster-cidr 172.7.0.0/16 \\\n  --hostname-override hdss7-21.host.com \\\n  --proxy-mode=ipvs \\\n  --ipvs-scheduler=nq \\\n  --kubeconfig ./conf/kube-proxy.kubeconfig\n  \nbin]# chmod +x kube-proxy.sh\nbin]# mkdir -p /data/logs/kubernetes/kube-proxy\n# æ³¨æ„æœºå™¨IPï¼Œæœ‰ä¸€å¤„ä¿®æ”¹ï¼škube-proxy-7-21]\nbin]# vi /etc/supervisord.d/kube-proxy.ini\n[program:kube-proxy-7-21]\ncommand=/opt/kubernetes/server/bin/kube-proxy.sh                     ; the program (relative uses PATH, can take args)\nnumprocs=1                                                           ; number of processes copies to start (def 1)\ndirectory=/opt/kubernetes/server/bin                                 ; directory to cwd to before exec (def no cwd)\nautostart=true                                                       ; start at supervisord start (default: true)\nautorestart=true                                                     ; retstart at unexpected quit (default: true)\nstartsecs=30                                                         ; number of secs prog must stay running (def. 1)\nstartretries=3                                                       ; max # of serial start failures (default 3)\nexitcodes=0,2                                                        ; 'expected' exit codes for process (default 0,2)\nstopsignal=QUIT                                                      ; signal used to kill process (default TERM)\nstopwaitsecs=10                                                      ; max num secs to wait b4 SIGKILL (default 10)\nuser=root                                                            ; setuid to this UNIX account to run the program\nredirect_stderr=true                                                 ; redirect proc stderr to stdout (default false)\nstdout_logfile=/data/logs/kubernetes/kube-proxy/proxy.stdout.log     ; stderr log path, NONE for none; default AUTO\nstdout_logfile_maxbytes=64MB                                         ; max # logfile bytes b4 rotation (default 50MB)\nstdout_logfile_backups=4                                             ; # of stdout logfile backups (default 10)\nstdout_capture_maxbytes=1MB                                          ; number of bytes in 'capturemode' (default 0)\nstdout_events_enabled=false                                          ; emit events on stdout writes (default false)\n\nbin]# supervisorctl update\nbin]# supervisorctl status\netcd-server-7-21                 RUNNING   pid 14765, uptime 5:21:04\nkube-apiserver-7-21              RUNNING   pid 16088, uptime 1:43:51\nkube-controller-manager-7-21     RUNNING   pid 18734, uptime 0:52:32\nkube-kubelet-7-21                RUNNING   pid 24802, uptime 0:19:46\nkube-proxy-7-21                  RUNNING   pid 32354, uptime 0:00:37\nkube-scheduler-7-21              RUNNING   pid 18958, uptime 0:51:23\n\n# è¿™ä¸ªå‰é¢å·²ç»å®‰è£… yum install ipvsadm -y\nbin]# ipvsadm -Ln\nIP Virtual Server version 1.2.1 (size=4096)\nProt LocalAddress:Port Scheduler Flags\n  -> RemoteAddress:Port           Forward Weight ActiveConn InActConn\nTCP  192.168.0.1:443 nq\n  -> 172.27.139.118:6443          Masq    1      0          0         \n  -> 172.27.139.120:6443          Masq    1      0          0  \n\nbin]# kubectl get svc\nNAME         TYPE        CLUSTER-IP    EXTERNAL-IP   PORT(S)   AGE\nkubernetes   ClusterIP   192.168.0.1   <none>        443/TCP   154m\n~~~\n\n> **ipvsadm**ï¼šç”¨äºè®¾ç½®ã€ç»´æŠ¤å’Œæ£€æŸ¥Linuxå†…æ ¸ä¸­è™šæ‹ŸæœåŠ¡å™¨åˆ—è¡¨çš„*å‘½ä»¤*\n>\n> **ipvsadm -Ln** ï¼šæŸ¥çœ‹å½“å‰é…ç½®çš„è™šæ‹ŸæœåŠ¡å’Œå„ä¸ªRSçš„æƒé‡\n\n<img src=\"assets/WX20230512-170820@2x.png\"  />\n\n~~~\n# éªŒè¯ä¸€ä¸‹é›†ç¾¤ï¼Œ21æœºå™¨(åœ¨ä»»æ„èŠ‚ç‚¹æœºå™¨ï¼Œæˆ‘é€‰çš„æ˜¯21)ï¼š\ncd\n~]# vi /root/nginx-ds.yaml\napiVersion: extensions/v1beta1\nkind: DaemonSet\nmetadata:\n  name: nginx-ds\nspec:\n  template:\n    metadata:\n      labels:\n        app: nginx-ds\n    spec:\n      containers:\n      - name: my-nginx\n        image: harbor.od.com/public/nginx:v1.7.9\n        ports:\n        - containerPort: 80\n        \n~]# kubectl create -f nginx-ds.yaml\n# outï¼šdaemonset.extensions/nginx-ds created\n~]# kubectl get pods -o wide\nNAME             READY   STATUS    RESTARTS   AGE   IP           NODE                NOMINATED NODE   READINESS GATES\nnginx-ds-rp8j5   1/1     Running   0          13s   172.7.22.2   hdss7-22.host.com   <none>           <none>\nnginx-ds-tv6dk   1/1     Running   0          13s   172.7.21.2   hdss7-21.host.com   <none>           <none>\n# ä»¥ä¸Šæ˜¯æˆåŠŸçš„çŠ¶æ€ï¼Œåœ¨21/22æœºå™¨éƒ½å¯ä»¥æŸ¥åˆ°\n~~~\n\n> **æ³¨æ„ï¼Œå¦‚æœä½ çš„podçš„wide22çš„ä¹Ÿåœ¨21ä¸Šæˆ–è€…ç±»ä¼¼æƒ…å†µï¼Œé‚£å°±æ˜¯ä½ çš„vi /etc/docker/daemon.jsonæ²¡æ”¹å¥½æœºå™¨åï¼Œéœ€è¦é‡æ–°åšè¿‡å…¨éƒ¨æœºå™¨**\n>\n> **kubectl create -f**  ï¼šé€šè¿‡é…ç½®æ–‡ä»¶åæˆ–stdinåˆ›å»ºä¸€ä¸ªé›†ç¾¤èµ„æºå¯¹è±¡\n>\n> **kubectl get ... -o wide**ï¼šæ˜¾ç¤ºç½‘ç»œæƒ…å†µ\n>\n> **nginx-ds.yamlè§£æï¼š**\n>\n> - å¯ä»¥å‚è€ƒè¿™ç¯‡æ–‡ç« [ç‚¹å‡»è·³è½¬](https://www.baidu.com/link?url=tFECOG31lKlcqDWeAZGF1VyjhzVAN9vUKHKEKKw5G8y0AC8MKpJxSZeL647MIFdw&wd=&eqid=dafe84b80019e4a3000000065e51d2e2)ï¼Œè¿™é‡Œçš„nginx-ds.yamlå»ºè®®è‡ªå·±æ‰‹æ•²ä¸€éï¼Œæ•²çš„åŒæ—¶è¦çŸ¥é“è‡ªå·±æ•²çš„æ˜¯ä»€ä¹ˆï¼Œè®°ä½ï¼Œyamlè¯­æ³•ä¸å…è®¸ä½¿ç”¨Tabé”®ï¼Œåªå…è®¸ç©ºæ ¼\n\n<img src=\"assets/WX20230512-171106@2x.png\"  />\n\næ­å–œ:tada::tada::tada:\n\næ­¤æ—¶ä½ å·²ç»éƒ¨ç½²å¥½K8Sé›†ç¾¤ï¼å½“ç„¶åªæœ‰é›†ç¾¤è¿˜è¿œè¿œä¸å¤Ÿï¼Œæˆ‘ä»¬è¿˜éœ€è¦æ›´å¤šçš„ä¸œè¥¿æ‰èƒ½ç»„æˆæˆ‘ä»¬çš„PaaSæœåŠ¡ï¼Œä¼‘æ¯ä¸€ä¸‹ç»§ç»­äº«å—å®ƒ:smiley:\n\nåç»­æš‚æœªæ¨å‡ºå…¬æœ‰äº‘ç‰ˆæœ¬ï¼Œç†è®ºä¸Šæ˜¯å®Œå…¨å¯è¡Œçš„ï¼Œå¦‚æœä½ æ˜¯å…¬æœ‰äº‘ç‰ˆæœ¬ä¸”å®Œå…¨éƒ¨ç½²å®Œæˆï¼Œè¯·ä¸€å®šè¦å‘Šè¯‰æˆ‘è¿™ä¸ªå¥½æ¶ˆæ¯\n"
        },
        {
          "name": "ç¬¬äº”ç« â€”â€”K8Sç»“åˆCI&CDæŒç»­äº¤ä»˜å’Œé›†ä¸­ç®¡ç†é…ç½®.md",
          "type": "blob",
          "size": 44.5361328125,
          "content": "## ç¬¬äº”ç« â€”â€”K8Sç»“åˆCI&CDæŒç»­äº¤ä»˜å’Œé›†ä¸­ç®¡ç†é…ç½®\n\n#### äº¤ä»˜DubboæœåŠ¡åˆ°K8Så‰è¨€\n\n> **WHAT**ï¼šé˜¿é‡Œå·´å·´å¼€æºçš„ä¸€ä¸ªé«˜æ€§èƒ½ä¼˜ç§€çš„[æœåŠ¡æ¡†æ¶](https://baike.baidu.com/item/%E6%9C%8D%E5%8A%A1%E6%A1%86%E6%9E%B6)ï¼Œä½¿å¾—åº”ç”¨å¯é€šè¿‡é«˜æ€§èƒ½çš„ RPC å®ç°æœåŠ¡çš„è¾“å‡ºå’Œè¾“å…¥åŠŸèƒ½ï¼Œå¯ä»¥å’Œ [1]  [Spring](https://baike.baidu.com/item/Spring)æ¡†æ¶æ— ç¼é›†æˆã€‚\n>\n> **WHY**ï¼šç”¨å®ƒæ¥å½“ä½œæˆ‘ä»¬ç°å®ç”Ÿäº§ä¸­çš„Appä¸šåŠ¡ï¼Œäº¤ä»˜åˆ°æˆ‘ä»¬çš„PaaSé‡Œ\n\n![1587274014276](assets/1587274014276.png)\n\n#### äº¤ä»˜æ¶æ„å›¾\n\n![1582455172381](assets/1582455172381.png)\n\n> **zkï¼ˆzookeeperï¼‰**ï¼šdubboæœåŠ¡çš„æ³¨å†Œä¸­å¿ƒæ˜¯é€šè¿‡zkæ¥åšçš„ï¼Œæˆ‘ä»¬ç”¨3ä¸ªzkç»„æˆä¸€ä¸ªé›†ç¾¤ï¼Œå°±è·Ÿetcdä¸€æ ·ï¼Œæœ‰ä¸€ä¸ªleaderä¸¤ä¸ªä»ï¼Œleaderæ­»äº†ç”±å…¶å®ƒæ¥å†³å®šè°å˜æˆleaderï¼Œå› ä¸ºzkæ˜¯æœ‰çŠ¶æ€çš„æœåŠ¡ï¼Œæ‰€ä»¥æˆ‘ä»¬æ”¾å®ƒæ”¾åœ¨é›†ç¾¤å¤–ï¼ˆçº¢æ¡†å¤–ï¼‰ï¼Œé›†ç¾¤å†…éƒ½æ˜¯æ— çŠ¶æ€çš„ã€‚\n>\n> **dubboå¾®æœåŠ¡**ï¼šåœ¨é›†ç¾¤å†…é€šè¿‡ç‚¹ç‚¹ç‚¹æ‰©å®¹ï¼ˆdashboardï¼‰ï¼Œå³å½“æœ‰ç§’æ€æˆ–è€…ä»€ä¹ˆçš„æ—¶å€™å°±å¯ä»¥æ‰©å±•ï¼Œè¿‡äº†åˆ™ç¼©å®¹ã€‚\n>\n> **git**ï¼šå¼€å‘æŠŠä»£ç ä¼ åˆ°gitä¸Šï¼Œè¿™é‡Œæˆ‘ä»¬ç”¨giteeï¼ˆç äº‘ï¼‰æ¥åšï¼Œä¹Ÿå¯ä»¥ç”¨GitHubæ¥ç€ï¼Œæ²¡ä»€ä¹ˆåŒºåˆ«\n>\n> **Jenkins**ï¼šç”¨JenkinsæŠŠgitçš„ä»£ç æ‹‰ä¸‹æ¥å¹¶ç¼–è¯‘æ‰“åŒ…æˆé•œåƒï¼Œç„¶åæé€åˆ°harbor\n>\n> **OPSæœåŠ¡å™¨ï¼ˆ7-200æœºå™¨ï¼‰**ï¼šç„¶åå°†harborçš„é•œåƒé€šè¿‡yamlåº”ç”¨åˆ°k8sé‡Œï¼Œç°åœ¨æˆ‘ä»¬æ˜¯éœ€è¦äº›yamlæ–‡ä»¶ï¼Œåé¢ä¼šç”¨spinnakeræ¥åšæˆç‚¹ç‚¹ç‚¹çš„æ–¹å¼\n>\n> **ç¬‘è„¸ï¼ˆç”¨æˆ·ï¼‰**ï¼šå¤–éƒ¨è®¿é—®é€šè¿‡ingressè½¬å‘åˆ°é›†ç¾¤å†…çš„dubboæ¶ˆè´¹è€…ï¼ˆwebæœåŠ¡ï¼‰ï¼Œç„¶åå°±å¯ä»¥è®¿é—®\n>\n> **æœ€ç»ˆç›®æ ‡**ï¼šå®ç°æ‰€æœ‰äº‹æƒ…éƒ½æ˜¯ç‚¹ç‚¹ç‚¹\n\næ¢³ç†ç›®å‰æœºå™¨æœåŠ¡è§’è‰²\n\n| ä¸»æœºå             | è§’è‰²                      | IP         |\n| :----------------- | ------------------------- | ---------- |\n| HDSS7-11.host.com  | k8sä»£ç†èŠ‚ç‚¹1ï¼Œzk1         | 10.4.7.11  |\n| HDSS7-12.host.com  | k8sä»£ç†èŠ‚ç‚¹1ï¼Œzk1         | 10.4.7.12  |\n| HDSS7-21.host.com  | k8sè¿ç®—èŠ‚ç‚¹1ï¼Œzk3         | 10.4.7.21  |\n| HDSS7-22.host.com  | k8sè¿ç®—èŠ‚ç‚¹2ï¼Œjenkins     | 10.4.7.22  |\n| HDSS7-200.host.com | k8sè¿ç»´èŠ‚ç‚¹ï¼ˆdockerä»“åº“ï¼‰ | 10.4.7.200 |\n\n\n\n### å®‰è£…éƒ¨ç½²zookeeper\n\n> **WHAT**ï¼šä¸»è¦æ˜¯ç”¨æ¥è§£å†³åˆ†å¸ƒå¼åº”ç”¨ä¸­ç»å¸¸é‡åˆ°çš„ä¸€äº›æ•°æ®ç®¡ç†é—®é¢˜ï¼Œå¦‚ï¼šç»Ÿä¸€å‘½åæœåŠ¡ã€çŠ¶æ€åŒæ­¥æœåŠ¡ã€é›†ç¾¤ç®¡ç†ã€åˆ†å¸ƒå¼åº”ç”¨é…ç½®é¡¹çš„ç®¡ç†ç­‰ã€‚ç®€å•æ¥è¯´zookeeper=æ–‡ä»¶ç³»ç»Ÿ+ç›‘å¬é€šçŸ¥æœºåˆ¶ã€‚[æ¨èæ–‡ç« ](https://blog.csdn.net/java_66666/article/details/81015302)\n>\n> **WHY**ï¼šæˆ‘ä»¬çš„dubboæœåŠ¡è¦æ³¨å†Œåˆ°zké‡Œï¼ŒæŠŠé…ç½®æ”¾åˆ°zkä¸Šï¼Œä¸€æ—¦é…ç½®ä¿¡æ¯å‘ç”Ÿå˜åŒ–ï¼Œzkå°†è·å–åˆ°æ–°çš„é…ç½®ä¿¡æ¯åº”ç”¨åˆ°ç³»ç»Ÿä¸­ã€‚\n\n~~~\n# 11/12/21æœºå™¨ï¼š\nmkdir /opt/src  # è¿™æ­¥æ˜¯æ²¡æœ‰srcæ–‡ä»¶å¤¹æ‰ä¼šè¿™ä¹ˆåš\ncd /opt/src\nsrc]# ç”±äºzkä¾èµ–javaç¯å¢ƒï¼Œä¸‹è½½æˆ‘ä¸Šä¼ çš„jdk-8u221-linux-x64.tar.gzæ”¾åˆ°è¿™ä¸ªç›®å½•\n# æœ€å¥½ç”¨æˆ‘ä¸Šä¼ çš„ï¼Œæˆ–è€…yum install -y java-1.8.0-openjdk*\nsrc]# mkdir /usr/java\nsrc]# tar xf jdk-8u221-linux-x64.tar.gz -C /usr/java\nsrc]# ll /usr/java/\nsrc]# ln -s /usr/java/jdk1.8.0_221/ /usr/java/jdk\n# ç²˜è´´åˆ°æœ€ä¸‹é¢\nsrc]# vi /etc/profile\nexport JAVA_HOME=/usr/java/jdk\nexport PATH=$JAVA_HOME/bin:$JAVA_HOME/bin:$PATH\nexport CLASSPATH=$CLASSPATH:$JAVA_HOME/lib:$JAVA_HOME/lib/tools.jar\n\nsrc]# source /etc/profile\nsrc]# java -version\n# out: java version \"1.8.0_221\"...\n\n# å®‰è£…zookeeper\nsrc]# wget https://archive.apache.org/dist/zookeeper/zookeeper-3.4.14/zookeeper-3.4.14.tar.gz\n# è¿™ä¸ªä¸‹è½½é€Ÿåº¦æ˜¯çœŸçš„æ…¢ï¼Œä½ æœ€å¥½ç”¨æˆ‘ä¸Šä¼ çš„åŒ…\nsrc]# tar xf zookeeper-3.4.14.tar.gz -C /opt\nsrc]# cd /opt\nopt]# ln -s /opt/zookeeper-3.4.14/ /opt/zookeeper\nopt]# mkdir -pv /data/zookeeper/data /data/zookeeper/logs\nopt]# vi /opt/zookeeper/conf/zoo.cfg\ntickTime=2000\ninitLimit=10\nsyncLimit=5\ndataDir=/data/zookeeper/data\ndataLogDir=/data/zookeeper/logs\nclientPort=2181\nserver.1=zk1.od.com:2888:3888\nserver.2=zk2.od.com:2888:3888\nserver.3=zk3.od.com:2888:3888\n\n~~~\n\n![1583027786123](assets/1583027786123.png)\n\n![1583028859934](assets/1583028859934.png)\n\n~~~\n# 11æœºå™¨æ·»åŠ è§£æï¼š\n~]# vi /var/named/od.com.zone\nserial å‰æ»šä¸€ä¸ª\n# æœ€ä¸‹é¢æ·»åŠ \nzk1                A   10.4.7.11\nzk2                A   10.4.7.12\nzk3                A   10.4.7.21\n\n~]# systemctl restart named\n~]# dig -t A zk1.od.com @10.4.7.11 +short\n# out: 10.4.7.11\n~~~\n\n\n\n~~~\n# é…ç½®myidï¼Œ11/12/21æœºå™¨ï¼š\n# æ³¨æ„ï¼Œ11æœºå™¨é…1ï¼Œ12æœºå™¨é…2ï¼Œ21æœºå™¨é…3,éœ€è¦ä¿®æ”¹å…±ä¸€å¤„ï¼š1\nopt]# vi /data/zookeeper/data/myid\n1\n\nopt]# /opt/zookeeper/bin/zkServer.sh start\nopt]# ps aux|grep zoo\nopt]# netstat -luntp|grep 2181\n~~~\n\n> **ps aux** ï¼šæŸ¥çœ‹è¿›ç¨‹æƒ…å†µçš„å‘½ä»¤\n\n![1580178079898](assets/1580178079898.png)\n\nå®Œæˆ\n\n\n\n### å®‰è£…éƒ¨ç½²Jenkins\n\n> **WHAT**ï¼š[Jenkinsä¸­æ–‡ç½‘](https://www.baidu.com/link?url=W22nPpmtH_sl0ovap9ypYFgfeS67PEutnmslKb9EZvm&wd=&eqid=de484ea10012b26f000000045e534b70)ï¼Œå¼•ç”¨ä¸€å¥è¯ï¼šæ„å»ºä¼Ÿå¤§ï¼Œæ— æ‰€ä¸èƒ½\n>\n> **WHY**ï¼šæˆ‘ä»¬çš„ä¹‹å‰çš„é•œåƒæ˜¯ä»ç½‘ä¸Šä¸‹è½½ä¸‹æ¥ç„¶åpushåˆ°harboré‡Œé¢è¢«åº”ç”¨åˆ°K8Sé‡Œï¼Œé‚£ä¹ˆæˆ‘ä»¬è‡ªå·±å¼€å‘çš„ä»£ç æ€ä¹ˆåšæˆé•œåƒå‘¢ï¼Ÿå°±éœ€è¦ç”¨åˆ°Jenkins\n\n~~~\n# 200æœºå™¨ï¼š\n~]# docker pull jenkins/jenkins:2.190.3\n~]# docker images|grep jenkins\n~]# docker tag 22b8b9a84dbe harbor.od.com/public/jenkins:v2.190.3\n~]# docker push harbor.od.com/public/jenkins:v2.190.3\n# ä¸‹é¢çš„å¯†é’¥ç”Ÿäº§ä½ è¦å¡«è‡ªå·±çš„é‚®ç®±\n~]# ssh-keygen -t rsa -b 2048 -C \"909336740@qq.com\" -N \"\" -f /root/.ssh/id_rsa\n# æ‹¿åˆ°å…¬é’¥é…ç½®åˆ°giteeé‡Œé¢å»\n~]# cat /root/.ssh/id_rsa.pub\n# =============å…¬é’¥é…ç½®åˆ°giteeçš„dubbo-demo-webï¼Œgiteeçš„é…ç½®å¯ä»¥çœ‹ä¸‹å›¾ï¼Œç”¨æˆ‘ä¸Šä¼ çš„ä»£ç åŒ…\n~]# mkdir /data/dockerfile\n~]# cd /data/dockerfile\ndockerfile]# mkdir jenkins\ndockerfile]# cd jenkins\njenkins]# vi Dockerfile\nFROM harbor.od.com/public/jenkins:v2.190.3\nUSER root\nRUN /bin/cp /usr/share/zoneinfo/Asia/Shanghai /etc/localtime &&\\ \n    echo 'Asia/Shanghai' >/etc/timezone\nADD id_rsa /root/.ssh/id_rsa\nADD config.json /root/.docker/config.json\nADD get-docker.sh /get-docker.sh\nRUN echo \"    StrictHostKeyChecking no\" >> /etc/ssh/ssh_config &&\\\n    /get-docker.sh\n\njenkins]# cp /root/.ssh/id_rsa .\njenkins]# cp /root/.docker/config.json .\njenkins]# curl -fsSL get.docker.com -o get-docker.sh\njenkins]# chmod +x get-docker.sh\n~~~\n\n> é…ç½®å…¬é’¥å’Œç§é’¥æ˜¯ä¸ºäº†è®©æˆ‘ä»¬çš„æœºå™¨èƒ½æ‰¾åˆ°æˆ‘ä»¬çš„gitï¼Œä¹Ÿè®©æˆ‘ä»¬çš„gitä»£ç ä¸è¢«åˆ«äººéšæ„ä½¿ç”¨ã€‚\n>\n> ä»¥ä¸‹æ˜¯giteeæ“ä½œæ–¹æ³•\n\n![1580701689468](assets/1580701689468.png)\n\n![1580701804448](assets/1580701804448.png)\n\n![1580702353514](assets/1580702353514.png)\n\n![1580702308419](assets/1580702308419.png)\n\n![1580702278913](assets/1580702278913.png)\n\n~~~\n> git add . # å…¨éƒ¨æäº¤å½“å‰ç›®å½•æ‰€æœ‰æ–°å¢æ–‡ä»¶\n# ç„¶åå†æ‰§è¡Œä¸‹é¢çš„æ­¥éª¤å³å¯åˆ°ä½ çš„giteeé‡Œé¢çœ‹äº†\n> git commit -m \"first commit\"\n> git remote add origin https://gitee.com/benjas/dubbo-demo-web-test.git\n> git push -u origin master\n~~~\n\n![1582682146083](assets/1582682146083.png)\n\nç›®å½•ç»“æ„å¿…é¡»å’Œæˆ‘çš„ä¸€æ ·\n\nç„¶åæŠŠå…¬é’¥é…ç½®è¿›å»ï¼Œç‚¹å‡»æ·»åŠ \n\n![1583032189990](assets/1583032189990.png)\n\n![1583032257343](assets/1583032257343.png)\n\næˆåŠŸ\n\næ–°å»ºä¸€ä¸ªinfraç§æœ‰ä»“åº“\n\n![1584696754306](assets/1584696754306.png)\n\n~~~\n# 200æœºå™¨ï¼Œå¼€å§‹buildé•œåƒï¼š\njenkins]# docker build . -t harbor.od.com/infra/jenkins:v2.190.3\njenkins]# docker push harbor.od.com/infra/jenkins:v2.190.3\njenkins]# docker run --rm harbor.od.com/infra/jenkins:v2.190.3 ssh -T git@gitee.com\n~~~\n\n> å¦‚æœå› ä¸ºç½‘ç»œåŸå› ä¸€ç›´buildå¤±è´¥çš„è¯·å¾€ä¸‹çœ‹ï¼ˆæˆ‘ç¬¬ä¸‰æ¬¡éƒ¨ç½²çš„æ—¶å€™ï¼Œbuildäº†3æ¬¡æ‰æˆåŠŸï¼‰ï¼ŒæˆåŠŸä¹Ÿä¼šå†’çº¢å­—ï¼Œä½†æ˜¯æœ‰Successfully\n\n![1580179904712](assets/1580179904712.png)\n\næˆåŠŸ\n\n##### buildä¸€ç›´å¤±è´¥è§£å†³åŠæ³•ï¼šç›´æ¥ç”¨æˆ‘åšå¥½çš„é•œåƒ\n\n~~~\n# 200æœºå™¨ï¼š\ncd /data/dockerfile/jenkins\njenkins]# æŠŠæˆ‘æ”¾åœ¨é‡Œé¢çš„åŒ…ä¸‹è½½åˆ°è¿™é‡Œ\njenkins]# docker load < jenkins-v2.190.3-with-docker.tar\njenkins]# docker images\n~~~\n\n![1584243805558](assets/1584243805558.png)\n\n~~~\n# 200æœºå™¨ï¼š\njenkins]# docker tag a25e4f7b2896 harbor.od.com/public/jenkins:v2.176.2\njenkins]# docker push harbor.od.com/public/jenkins:v2.176.2\njenkins]# vi Dockerfile\nFROM harbor.od.com/public/jenkins:v2.176.2\n# åˆ æ‰ ADD get-docker.sh/get-docker.shï¼Œå¦‚ä¸‹å›¾\n~~~\n\n![1580699790260](assets/1580699790260.png)\n\n~~~\n# 200æœºå™¨:\njenkins]# docker build . -t harbor.od.com/infra/jenkins:v2.176.2\njenkins]# docker tag ç¼–è¯‘é•œåƒçš„id harbor.od.com/infra/jenkins:v2.190.3\njenkins]# docker push harbor.od.com/infra/jenkins:v2.190.3\njenkins]# docker run --rm harbor.od.com/infra/jenkins:v2.190.3 ssh -T git@gitee.com\n~~~\n\n![1580179904712](assets/1580179904712.png)\n\næˆåŠŸæ ‡è¯†\n\n~~~\n# 21æœºå™¨ï¼Œåˆ›å»ºåç§°ç©ºé—´ï¼Œå¯¹åº”ç§æœ‰åŒ–ä»“åº“ï¼š\n~]# kubectl create ns infra\n~]# kubectl create secret docker-registry harbor --docker-server=harbor.od.com --docker-username=admin --docker-password=Harbor12345 -n infra\n~~~\n\n> **kubectl create secret**åˆ›å»ºç§æœ‰ä»“åº“\n>\n> - åé¢è·Ÿç€çš„æ˜¯å¯¹åº”çš„ä»“åº“ã€ç”¨æˆ·åã€ç”¨æˆ·å¯†ç ã€ä»“åº“åç§°infra\n\n~~~\n# ä¸‰éƒ¨æœºå™¨ï¼Œ21/22/200ï¼Œå‡†å¤‡å…±äº«å­˜å‚¨ï¼š\n~]# yum install nfs-utils -y\n~~~\n\n\n\n~~~\n# 200æœºå™¨ï¼Œåšå…±äº«å­˜å‚¨çš„å®¢æˆ·ç«¯ï¼š\njenkins]# vi /etc/exports\n/data/nfs-volume 10.4.7.0/24(rw,no_root_squash)\n\njenkins]# mkdir /data/nfs-volume\njenkins]# systemctl start nfs\njenkins]# systemctl enable nfs\njenkins]# cd /data/k8s-yaml/\nk8s-yaml]# mkdir jenkins\ncd jenkins\n# 200æœºå™¨ï¼Œå‡†å¤‡èµ„æºé…ç½®æ¸…å•ï¼š\njenkins]# vi dp.yaml\nkind: Deployment\napiVersion: extensions/v1beta1\nmetadata:\n  name: jenkins\n  namespace: infra\n  labels: \n    name: jenkins\nspec:\n  replicas: 1\n  selector:\n    matchLabels: \n      name: jenkins\n  template:\n    metadata:\n      labels: \n        app: jenkins \n        name: jenkins\n    spec:\n      volumes:\n      - name: data\n        nfs: \n          server: hdss7-200\n          path: /data/nfs-volume/jenkins_home\n      - name: docker\n        hostPath: \n          path: /run/docker.sock\n          type: ''\n      containers:\n      - name: jenkins\n        image: harbor.od.com/infra/jenkins:v2.190.3\n        imagePullPolicy: IfNotPresent\n        ports:\n        - containerPort: 8080\n          protocol: TCP\n        env:\n        - name: JAVA_OPTS\n          value: -Xmx512m -Xms512m\n        volumeMounts:\n        - name: data\n          mountPath: /var/jenkins_home\n        - name: docker\n          mountPath: /run/docker.sock\n      imagePullSecrets:\n      - name: harbor\n      securityContext: \n        runAsUser: 0\n  strategy:\n    type: RollingUpdate\n    rollingUpdate: \n      maxUnavailable: 1\n      maxSurge: 1\n  revisionHistoryLimit: 7\n  progressDeadlineSeconds: 600\n  \njenkins]# vi svc.yaml\nkind: Service\napiVersion: v1\nmetadata: \n  name: jenkins\n  namespace: infra\nspec:\n  ports:\n  - protocol: TCP\n    port: 80\n    targetPort: 8080\n  selector:\n    app: jenkins\n\njenkins]# vi ingress.yaml\nkind: Ingress\napiVersion: extensions/v1beta1\nmetadata: \n  name: jenkins\n  namespace: infra\nspec:\n  rules:\n  - host: jenkins.od.com\n    http:\n      paths:\n      - path: /\n        backend: \n          serviceName: jenkins\n          servicePort: 80\n          \njenkins]# mkdir /data/nfs-volume/jenkins_home\n# ç½‘é¡µæŸ¥çœ‹ï¼š\nk8s-yaml.od.comä¸‹æœ‰jenkinsç›®å½•\n# 21æœºå™¨ï¼Œæµ‹è¯•ï¼š\n~]# file /run/docker.sock\n# out: /run/docker.sock.socket\n~~~\n\n\n\n~~~\n# åº”ç”¨èµ„æºé…ç½®æ¸…å•,21æœºå™¨:\n~]# kubectl apply -f http://k8s-yaml.od.com/jenkins/dp.yaml\n~]# kubectl apply -f http://k8s-yaml.od.com/jenkins/svc.yaml\n~]# kubectl apply -f http://k8s-yaml.od.com/jenkins/ingress.yaml\n~]# kubectl get pods -n infra\n~]# kubectl get all -n infra\n~~~\n\n> å¦‚æœæ˜¯pendingçŠ¶æ€ï¼Œä¸€èˆ¬æ˜¯ä½ çš„å†…å­˜å ç”¨è¿‡å¤šï¼Œä½ çš„dashboardå¯èƒ½å¼€ä¸èµ·æ¥äº†ï¼Œä½†æ˜¯ä¸æ‰“ç´§ï¼Œç…§ç”¨\n\ninfraåç§°ç©ºé—´\n\n![1584697062782](assets/1584697062782.png)\n\nå¯åŠ¨æˆåŠŸ\n\n~~~\n# 11æœºå™¨ï¼Œè§£æåŸŸåï¼š\n~]# vi /var/named/od.com.zone\nserial å‰æ»šä¸€ä¸ª,åˆ°07\n# æœ€ä¸‹é¢æ·»åŠ \njenkins            A   10.4.7.10\n\n~]# systemctl restart named\n~]# dig -t A jenkins.od.com @10.4.7.11 +short\n#10.4.7.10\n~~~\n\n[è®¿é—®jenkins.od.com](jenkins.od.com)\n\n![1583035885506](assets/1583035885506.png)\n\n~~~\n# 200æœºå™¨æ‰¾å¯†ç ï¼Œä¸Šé¢çš„å¯†ç åœ¨initialAdminPasswordé‡Œï¼š\ncd /data/nfs-volume/jenkins_home\njenkins_home]# cat secrets/initialAdminPassword\n# catåˆ°çš„å¯†ç ç²˜åˆ°ä¸Šé¢å»\n~~~\n\nSkip Plugin Installationsè¿›æ¥\n\n![1583036011230](assets/1583036011230.png)\n\n~~~\n# jenkinsè´¦å·å¯†ç è®¾ç½®ï¼Œä¸€å®šè¦è·Ÿæˆ‘çš„ä¸€æ ·ï¼Œåé¢è¦ç”¨åˆ°çš„ï¼š\nè´¦å·ï¼šadmin\nå¯†ç ï¼šadmin123\nfull nameï¼šadmin\n# ç„¶åsave->save->start using Jenkinså³å¯\n~~~\n\n![1583036074145](assets/1583036074145.png)\n\n~~~\n# è¿›æ¥åè¦åšä¸¤ä»¶äº‹æƒ…ï¼Œç¬¬ä¸€ä»¶äº‹å°±æ˜¯è°ƒæ•´ä¸¤å®‰å…¨é€‰é¡¹ï¼š\n1ã€allow anonymous read acces å…è®¸åŒ¿åç”¨æˆ·è®¿é—®\n2ã€Prevent cross site request forgery exploits å…è®¸è·¨åŸŸ\n~~~\n\n![1583036109324](assets/1583036109324.png)\n\n![1580612141388](assets/1580612141388.png)\n\n#### å®‰è£…è“æµ·\n\n> **WHAT**ï¼šä»ä»ªè¡¨æ¿åˆ°å„ä¸ªPipelineè¿è¡Œçš„æŸ¥çœ‹åˆ†æ”¯å’Œç»“æœï¼Œä½¿ç”¨å¯è§†ç¼–è¾‘å™¨ä¿®æ”¹Pipelineä½œä¸ºä»£ç \n>\n> - è¿ç»­äº¤ä»˜ï¼ˆCDï¼‰Pipelineçš„å¤æ‚å¯è§†åŒ–ï¼Œå…è®¸å¿«é€Ÿå’Œç›´è§‚åœ°äº†è§£Pipelineçš„çŠ¶æ€ï¼ˆä¸‹é¢å›é¡¾æ„å»ºé•œåƒæµç¨‹çš„æ—¶å€™æœ‰ä½¿ç”¨åˆ°ï¼‰\n> - ...\n>\n> **WHY**ï¼šå½“ç„¶æ˜¯ä¸ºäº†è®©æˆ‘ä»¬èƒ½æ›´æ¸…æ™°æ˜äº†çš„çœ‹åˆ°æ„å»ºçš„æƒ…å†µ\n\n![1583036159177](assets/1583036159177.png)\n\n![1583036337529](assets/1583036337529.png)\n\n> è¿™é‡Œå¦‚æœæ²¡æœ‰å†…å®¹çš„ç‚¹ä¸€ä¸‹check outï¼Œå› ä¸ºè¯»å–çš„æ…¢çš„é—®é¢˜\n>\n> **ctrl+f**å‘¼å‡ºé¡µé¢æœç´¢\n\n![1583036408736](assets/1583036408736.png)\n\nç”±äºå®‰è£…è¿˜æ˜¯æ¯”è¾ƒæ…¢çš„ï¼ŒæŠŠè¿™ä¸ªå‹¾é€‰ä¸Šå°±å¯ä»¥å»åšåˆ«çš„äº‹æƒ…äº†\n\n![1583041128840](assets/1583041128840.png)\n\né‡å¯å®Œåä¼šå‡ºç°open blue oceanï¼Œè¡¨ç¤ºå®‰è£…æˆåŠŸ\n\n> ![1583056880950](assets/1583056880950.png)\n\nå®Œæˆï¼ˆè€Œä¸”ä½ å†å»æœç´¢blueæ˜¯æœä¸åˆ°çš„äº†ï¼‰\n\n#### ä¸€ç›´ä¸‹è½½ä¸äº†BlueOceanæ€ä¹ˆåŠ\n\næ–¹æ³•ä¸€ï¼ˆé€€å‡ºå†ä¸‹è½½æ³•ï¼Œæ­¤æ–¹æ³•ä¾ç„¶ä¾é ç½‘ç»œï¼‰ï¼š\n\nå›åˆ°ä¸Šä¸€é¡µ\n\n![1583036159177](assets/1583036159177.png)\n\nå†ç‚¹å‡»ä¸‹è½½\n\n![1583036408736](assets/1583036408736.png)\n\n\n\nå¯ä»¥çœ‹åˆ°ä¹‹å‰Failureçš„å†…å®¹åˆå¼€å§‹ä¸‹è½½äº†ï¼Œè€Œä¸”æœ‰ä¸€éƒ¨åˆ†å·²ç»æˆåŠŸ\n\n![1583056085304](assets/1583056085304.png)\n\næ–¹æ³•äºŒï¼ˆç¦»çº¿åŒ…è§£å‹ï¼‰ï¼š\n\næŠŠæˆ‘ä¸Šä¼ çš„jenkins_2.176_plugins.tar.gzä¸‹è½½è§£å‹åˆ°200æœºå™¨çš„/data/nfs-voluem/jenkins_home/plugins/\n\nç„¶åå»åˆ æ‰Jenkinsçš„podè®©å®ƒè‡ªåŠ¨é‡å¯ï¼Œå°±æœ‰äº†\n\n![1583056264561](assets/1583056264561.png)\n\n> #### å” å—‘ï¼š\n>\n> dashboardç›®å‰å¸¸ç”¨çš„ä¸¤ä¸ªç‰ˆæœ¬ï¼šv1.8.3ï¼Œv1.10.1\n>\n> Jenkinsï¼šæŠŠæºç ç¼–è¯‘æˆå¯æ‰§è¡Œçš„äºŒè¿›åˆ¶ç \n\n\n\n### å®‰è£…maven\n\n> **WHAT**ï¼šä¸€ä¸ªé¡¹ç›®ç®¡ç†å·¥å…·ï¼Œå¯ä»¥å¯¹ Java é¡¹ç›®è¿›è¡Œæ„å»ºã€ä¾èµ–ç®¡ç†ã€‚\n>\n> **WHY**ï¼šæ„å»ºé¡¹ç›®é•œåƒæ—¶éœ€è¦\n\n[ä½¿ç”¨å®˜ç½‘çš„](https://archive.apache.org/dist/maven/maven-3/)ï¼Œæˆ–è€…ç”¨æˆ‘ä¸Šä¼ çš„\n\n![1580692503213](assets/1580692503213.png)\n\n![1584697256442](assets/1584697256442.png)\n\n~~~\n# 200æœºå™¨ï¼š\nsrc]# ç½‘ä¸Šä¸‹è½½æˆ–è€…ç”¨æˆ‘ä¸Šä¼ çš„ï¼Œæ‹‰åˆ°è¿™é‡Œ\nsrc]# ll\nsrc]# mkdir /data/nfs-volume/jenkins_home/maven-3.6.1-8u232\n# ä¸Šé¢è¿™ä¸ª8u232çš„232æ˜¯æ ¹æ®ä¸‹å›¾ç§çš„Jenkinsç‰ˆæœ¬çš„232æ¥ç¡®å®šçš„\n~~~\n\n![1584697159389](assets/1584697159389.png)\n\n> ä¸‹å›¾æ˜¯EXECåˆ°dashboardé‡Œçš„Jenkinsï¼Œç„¶åè¾“å…¥java -version\n\n![1584697213960](assets/1584697213960.png)\n\nç¡®ä¿ä½ çš„Jenkinsæ˜¯æ²¡é—®é¢˜çš„\n\n~~~\n# è¿›å…¥harbo\ndocker login harbor.od.com\n# æ˜¯å¦èƒ½è¿æ¥gitee\nssh -i /root/.ssh/id_rsa -T git@gitee.com\n~~~\n\n![1583080186411](assets/1583080186411.png)\n\n~~~\n# 200æœºå™¨ï¼š\nsrc]# tar xfv apache-maven-3.6.1-bin.tar.gz -C /data/nfs-volume/jenkins_home/maven-3.6.1-8u232\nsrc]# cd /data/nfs-volume/jenkins_home/maven-3.6.1-8u232\nmaven-3.6.1-8u232]# ll\n# out: apache-maven-3.6.1\nmaven-3.6.1-8u232]# mv apache-maven-3.6.1/ ../\nmaven-3.6.1-8u232]# mv ../apache-maven-3.6.1/* .\nmaven-3.6.1-8u232]# ll\n~~~\n\n![1584697314787](assets/1584697314787.png)\n\n~~~\n# 200æœºå™¨,ä¿®æ”¹é•œåƒæºæˆé˜¿é‡Œæºï¼Œå¢åŠ ä»¥ä¸‹å†…å®¹ï¼š\nmaven-3.6.1-8u232]# vi conf/settings.xml\n    <mirror>\n      <id>nexus-aliyun</id>\n      <mirrorOf>*</mirrorOf>\n      <name>Nexus aliyun</name>\n      <url>https://maven.aliyun.com/repository/public</url>\n      <!-- æ—§åœ°å€ï¼šhttp://maven.allyun.com/nexus/content/groups/public --> \n    </mirror>\n~~~\n\n![1584697410112](assets/1584697410112.png)\n\n##### å…¶å®ƒçŸ¥è¯†ï¼ˆä¸éœ€è¦æ“ä½œï¼‰:\n\n~~~\n# 200æœºå™¨,åˆ‡æ¢jdkçš„å¤šä¸ªç‰ˆæœ¬çš„æ–¹æ³•ï¼š\ncd /data/nfs-volume/jenkins_home/\njenkins_home]# æŠŠjdkçš„å¦å¤–ç‰ˆæœ¬ä¸‹è½½ä¸‹æ¥ï¼Œç›´æ¥ç”¨æˆ‘çš„åŒ…\njenkins_home]# tar xf jdk-7u80-linux-x64.tar.gz -C ./\njenkins_home]# cd maven-3.6.1-8u232/\ncd bin/\nbin]# file mvn\n# out: mvn: POSIX shell script, ASCII text executable\nbin]# vi mvn\n#ç¼–è¾‘JAVA_HOME å³å¯æŒ‡å®šjdkç‰ˆæœ¬\n~~~\n\n\n\n### åˆ¶ä½œdubboå¾®æœåŠ¡çš„åº•åŒ…é•œåƒ\n\n~~~\n# 200æœºå™¨ï¼š\ncd /data/nfs-volume/jenkins_home/\njenkins_home]# docker pull docker.io/909336740/jre8:8u112\njenkins_home]# docker images|grep jre \njenkins_home]# docker push harbor.od.com/public/jre:8u112\njenkins_home]# cd /data/dockerfile\ndockerfile]# mkdir jre8\njre8]# cd jre8\njre8]# vi Dockerfile\nFROM harbor.od.com/public/jre:8u112\nRUN /bin/cp /usr/share/zoneinfo/Asia/Shanghai /etc/localtime &&\\\n    echo 'Asia/Shanghai' >/etc/timezone\nADD config.yml /opt/prom/config.yml\nADD jmx_javaagent-0.3.1.jar /opt/prom/\nWORKDIR /opt/project_dir\nADD entrypoint.sh /entrypoint.sh\nCMD [\"/entrypoint.sh\"]\n\njre8]# wget https://repo1.maven.org/maven2/io/prometheus/jmx/jmx_prometheus_javaagent/0.3.1/jmx_prometheus_javaagent-0.3.1.jar -O jmx_javaagent-0.3.1.jar\njre8]# vi config.yml\n---\nrules:\n  - pattern: '.*'\n\njre8]# vi entrypoint.sh\n#!/bin/sh\nM_OPTS=\"-Duser.timezone=Asia/Shanghai -javaagent:/opt/prom/jmx_javaagent-0.3.1.jar=$(hostname -i):${M_PORT:-\"12346\"}:/opt/prom/config.yml\"\nC_OPTS=${C_OPTS}\nJAR_BALL=${JAR_BALL}\nexec java -jar ${M_OPTS} ${C_OPTS} ${JAR_BALL}\n\njre8]# chmod +x entrypoint.sh\njre8]# ll\n~~~\n\n> **Dockerfileè§£æ**ï¼š\n>\n> - RUN æŠŠæ—¶åŒºæ”¹æˆä¸Šæµ·æ—¶åŒº\n> - ADD ç»™ä¸€ä¸ªç›‘æ§\n> - ADD æ”¶é›†jmxçš„ä¿¡æ¯\n> - WORKDIR å·¥ä½œç›®å½•\n> - CMD é»˜è®¤æ‰§è¡Œè„šæœ¬\n\n![1580718591217](assets/1580718591217.png)\n\nharboråˆ›å»ºbaseä»“åº“\n\n![1583076206921](assets/1583076206921.png)\n\n~~~\n# 200æœºå™¨ï¼Œå¼€å§‹buildé•œåƒï¼š\njre8]# docker build . -t harbor.od.com/base/jre8:8u112\njre8]# docker push harbor.od.com/base/jre8:8u112\n~~~\n\n> å›é¡¾ä¸€ä¸‹æˆ‘ä»¬çš„äº¤ä»˜æ¶æ„å›¾\n\n![1580997621696](assets/1580997621696.png)\n\n\n\n### ä½¿ç”¨JenkinsæŒç»­æ„å»ºäº¤ä»˜dubboæœåŠ¡çš„æä¾›è€…\n\n![1583076355039](assets/1583076355039.png)\n\n![1583076388875](assets/1583076388875.png)\n\n![1583076490229](assets/1583076490229.png)\n\næ„å»ºåä¸ªå‚æ•°\n\n1. ![1583076572332](assets/1583076572332.png)\n2. ![1583076620958](assets/1583076620958.png)\n3. ![1583076688952](assets/1583076688952.png)\n4. ![1583076729387](assets/1583076729387.png)\n5. ![1583076787792](assets/1583076787792.png)\n6. ![1583076845621](assets/1583076845621.png)\n7. ![1583076895447](assets/1583076895447.png)\n8. ![1583077033366](assets/1583077033366.png)\n9. ![1583077110044](assets/1583077110044.png)\n10. ![1583077171689](assets/1583077171689.png)\n11.  æŠŠä»¥ä¸‹å†…å®¹å¡«å†™ä¸‹é¢çš„Adnanced Project Options\n\n~~~shell\npipeline {\n  agent any \n    stages {\n      stage('pull') { //get project code from repo \n        steps {\n          sh \"git clone ${params.git_repo} ${params.app_name}/${env.BUILD_NUMBER} && cd ${params.app_name}/${env.BUILD_NUMBER} && git checkout ${params.git_ver}\"\n        }\n      }\n      stage('build') { //exec mvn cmd\n        steps {\n          sh \"cd ${params.app_name}/${env.BUILD_NUMBER}  && /var/jenkins_home/maven-${params.maven}/bin/${params.mvn_cmd}\"\n        }\n      }\n      stage('package') { //move jar file into project_dir\n        steps {\n          sh \"cd ${params.app_name}/${env.BUILD_NUMBER} && cd ${params.target_dir} && mkdir project_dir && mv *.jar ./project_dir\"\n        }\n      }\n      stage('image') { //build image and push to registry\n        steps {\n          writeFile file: \"${params.app_name}/${env.BUILD_NUMBER}/Dockerfile\", text: \"\"\"FROM harbor.od.com/${params.base_image}\nADD ${params.target_dir}/project_dir /opt/project_dir\"\"\"\n          sh \"cd  ${params.app_name}/${env.BUILD_NUMBER} && docker build -t harbor.od.com/${params.image_name}:${params.git_ver}_${params.add_tag} . && docker push harbor.od.com/${params.image_name}:${params.git_ver}_${params.add_tag}\"\n        }\n      }\n    }\n}\n~~~\n\n![1580783995614](assets/1580783995614.png)\n\n> æ³¨é‡Šï¼ˆæµæ°´çº¿è„šæœ¬ï¼‰ï¼š\n>\n> pull: æŠŠé¡¹ç›®å…‹éš†åˆ°ä»“åº“\n>\n> build: åˆ°æŒ‡å®šçš„åœ°æ–¹åˆ›å»º\n>\n> package: ç”¨å®Œmvnåæ‰“åŒ…åˆ°project_dir\n>\n> image: å¼„åˆ°æˆ‘ä»¬çš„dockerä»“åº“\n\n~~~\nå¡«å…¥å¯¹åº”çš„å‚æ•°ï¼š\napp_name:       dubbo-demo-service\nimage_name:     app/dubbo-demo-service\ngit_repo:       https://gitee.com/benjas/dubbo-demo-service.git\ngit_ver:        master\nadd_tag:        200301_2352\nmvn_dir:        ./\ntarget_dir:     ./dubbo-server/target\nmvn_cmd:        mvn clean package -Dmaven.test.skip=true\nbase_image:     base/jre8:8u112\nmaven:          3.6.1-8u232\n# æ³¨æ„çœ‹è„šæ³¨ï¼Œç‚¹å‡»Buildè¿›è¡Œæ„å»ºï¼Œç­‰å¾…æ„å»ºå®Œæˆã€‚\n~~~\n\n> **git_repo**ï¼šæ³¨æ„çš„åœ°å€æ˜¯å†™ä½ çš„åœ°å€\n>\n> **add_tag**ï¼šå†™ç°åœ¨çš„æ—¥æœŸ\n\n[^dubbo-serviceåŒ…]: dubbo-serviceåŒ…åœ¨æˆ‘ä¸Šä¼ çš„æ–‡ä»¶å¤¹é‡Œé¢ï¼Œä½ ä¸‹è½½åæ‹‰åˆ°ä½ æ–°å»ºçš„gitä»“åº“é‡Œé¢ï¼ˆå…¬å¼€ï¼‰ï¼Œç„¶åé…ä¸Šä½ çš„åœ°å€ï¼ˆè®°å¾—ä¹‹å‰çš„webæ˜¯é…äº†å…¬é’¥çš„ï¼Œå¦åˆ™æ‰¾ä¸åˆ°ï¼Œå…¬é’¥çš„æ–¹æ³•åœ¨ä¸Šé¢çš„ç« èŠ‚ï¼‰ï¼Œç›®å½•ç»“æ„é•¿è¿™ä¸ªæ ·å­\n\n![1583077468832](assets/1583077468832.png)\n\nHarboråˆ›å»ºå¯¹åº”çš„appç©ºé—´\n\n![1583082446323](assets/1583082446323.png)\n\n![1583077775076](assets/1583077775076.png)\n\n![1583129694897](assets/1583129694897.png)\n\n![1583129669192](assets/1583129669192.png)\n\n![1583129554275](assets/1583129554275.png)\n\n[æŸ¥çœ‹harbor](harbor.od.com)\n\n![1583132650158](assets/1583132650158.png)\n\n#### æŠ¥é”™ï¼š\n\n1ã€\n\n![1584530943674](assets/1584530943674.png)\n\nåŸå› ï¼šä½ æ„å»ºçš„å‚æ•°å†™é”™äº†ï¼Œå†å»æ£€æŸ¥ä¸€é ,éœ€æ ¹æ®gité¡¹ç›®åæ¥çš„ã€‚å‰é¢æ˜¯æˆªå›¾é»˜è®¤å€¼æ˜¯ï¼š./target ä¸å¯¹ï¼Œéœ€è¦ä¿®æ”¹æˆ./dubbo-server/target \n\n2ã€è¿æ¥ä¸äº†giteeï¼Œä¸€ç›´æ˜¾ç¤ºå¤±è´¥ï¼ˆç½‘ç»œæ³¢åŠ¨é—®é¢˜ï¼‰ï¼Œå¦‚å›¾\n\n![1583128285936](assets/1583128285936.png)\n\nè§£å†³åŠæ³•ï¼šå®‰è£…æœ¬åœ°gitlab\n\n~~~\n# 200æœºå™¨ï¼š\n~]# yum install curl policycoreutils openssh-server openssh-clients policycoreutils-python -y\n~]# cd /usr/local/src\nsrc]# å»è¯¥ç½‘å€æŠŠæ–‡ä»¶ä¸‹è½½ä¸‹æ¥https://mirrors.tuna.tsinghua.edu.cn/gitlab-ce/yum/el7/\nsrc]# ls\ngitlab-ce-11.11.8-ce.0.el7.x86_64.rpm\nsrc]# rpm -ivh gitlab-ce-11.11.8-ce.0.el7.x86_64.rpm\n# ä¿®æ”¹å¦‚ä¸‹å†…å®¹ï¼š\nsrc]# vim /etc/gitlab/gitlab.rb\nexternal_url \"http://gitlab.od.com:10000\"\nnginx['listen_port'] = 10000\n\n# 11æœºå™¨è§£æï¼š\n~]# vi /var/named/od.com.zone\nserialå‰æ»šä¸€ä½\ngitlab             A    10.4.7.200\n\nopt]# systemctl restart named\nopt]# dig -t A jenkins.od.com @10.4.7.11 +short\n# out:10.4.7.200\n\n# 200æœºå™¨ç»§ç»­ï¼Œä¸‹é¢è¿™æ­¥è¦å¾ˆä¹…ï¼Œæœ€åä¼šæœ‰Running handlers completeçš„å­—çœ¼ï¼Œç„¶åå›è½¦å³å¯\nsrc]# gitlab-ctl reconfigure\nsrc]# gitlab-ctl status\nrun: alertmanager: (pid 17983) 14s; run: log: (pid 17689) 90s\nrun: gitaly: (pid 17866) 20s; run: log: (pid 16947) 236s\nrun: gitlab-monitor: (pid 17928) 18s; run: log: (pid 17591) 108s\nrun: gitlab-workhorse: (pid 17897) 19s; run: log: (pid 17451) 141s\nrun: logrotate: (pid 17500) 127s; run: log: (pid 17515) 124s\nrun: nginx: (pid 17468) 138s; run: log: (pid 17482) 134s\nrun: node-exporter: (pid 17911) 19s; run: log: (pid 17567) 114s\nrun: postgres-exporter: (pid 17998) 13s; run: log: (pid 17716) 84s\nrun: postgresql: (pid 17109) 217s; run: log: (pid 17130) 216s\nrun: prometheus: (pid 17949) 17s; run: log: (pid 17654) 96s\nrun: redis: (pid 16888) 244s; run: log: (pid 16902) 243s\nrun: redis-exporter: (pid 17936) 18s; run: log: (pid 17624) 102s\nrun: sidekiq: (pid 17395) 155s; run: log: (pid 17412) 152s\nrun: unicorn: (pid 17337) 166s; run: log: (pid 17368) 162s\n~~~\n\nç„¶åæŠŠä»£ç ä¼ è¿›æ¥\n\n![1583129295099](assets/1583129295099.png)\n\nå®Œæˆ\n\n> æœŸé—´å¦‚æœcloneä¸‹æ¥çš„æ—¶å€™å¯†ç ä¸€ç›´ä¸å¯¹ï¼Œå°±ç”¨sshå¯†é’¥çš„æ–¹æ³•å…å¯†ç™»å½•ï¼Œæœ€åæ·»åŠ 200çš„å…¬é’¥åˆ°gitlabï¼Œbuildé•œåƒçš„æ—¶å€™ä¿®æ”¹git_repoå³å¯\n>\n> ~~~\n> git_repo:      http://gitlab.od.com:10000/909336740/dubbo-demo-service.git\n> ~~~\n>\n> \n\n2ã€è¿æ¥æˆåŠŸäº†ä½†æ˜¯ä¸€ç›´ä¸‹è½½ä¸äº†æ–‡ä»¶ç„¶åæŠ¥é”™ï¼ˆç½‘ç»œæ³¢åŠ¨é—®é¢˜ï¼‰ï¼Œå¦‚å›¾\n\n![1583128324746](assets/1583128324746.png)\n\nè§£å†³åŠæ³•ï¼šå¤šbuildå‡ æ¬¡ï¼Œä¸è¡Œå°±æŠŠaliyunåˆ æ‰ï¼ˆvi conf/settings.xmlï¼‰ï¼Œç”¨åŸå§‹çš„æºä¸‹è½½\n\n> PSï¼šæˆ‘ç¬¬ä¸€æ¬¡ä¸€æ¬¡è¿‡ï¼Œç¬¬ä¸‰æ¬¡çš„æ—¶å€™ï¼Œå¦‚å›¾ï¼Œæˆ‘æŠŠ27é‚£äº›åˆ æ‰ï¼Œå› ä¸ºè®¾ç½®äº†åªèƒ½30ä¸ªï¼Œæ€•çˆ†äº†ï¼Œæœ€ç»ˆåœ¨28æ¬¡çš„æ—¶å€™æˆåŠŸäº†\n>\n> ![1583129711754](assets/1583129711754.png)\n>\n> å¦‚ä½•åˆ é™¤\n>\n> ![1583129763175](assets/1583129763175.png)\n\nè¿™ä»¶äº‹æƒ…å‘Šè¯‰æˆ‘ä»¬ï¼Œå°½é‡ä¸ç”¨å…¬ç½‘çš„ï¼Œç‰¹åˆ«æ˜¯ç”Ÿäº§çš„æ—¶å€™åˆ†åˆ†é’Ÿå‡ ç™¾ä¸‡çš„è®¿é—®ï¼Œå¡è¿™ä¹ˆä¹…ï¼Œè€æ¿å¾—ç¥­å¤©\n\n\n\næœåŠ¡ç«™é•œåƒåŒ…å·²åˆ¶ä½œå®Œæˆï¼Œç°åœ¨å¼€å§‹åˆ¶ä½œèµ„æºé…ç½®æ¸…å•ã€‚\n\n~~~\n# 200æœºå™¨ï¼ŒæœåŠ¡è€…çš„èµ„æºæ¸…å•åªéœ€è¦ä¸€ä¸ªï¼š\njre8]# mkdir /data/k8s-yaml/dubbo-demo-service\njre8]# vi /data/k8s-yaml/dubbo-demo-service/dp.yaml\nkind: Deployment\napiVersion: extensions/v1beta1\nmetadata:\n  name: dubbo-demo-service\n  namespace: app\n  labels: \n    name: dubbo-demo-service\nspec:\n  replicas: 1\n  selector:\n    matchLabels: \n      name: dubbo-demo-service\n  template:\n    metadata:\n      labels: \n        app: dubbo-demo-service\n        name: dubbo-demo-service\n    spec:\n      containers:\n      - name: dubbo-demo-service\n        image: harbor.od.com/app/dubbo-demo-service:master_200301_2352\n        ports:\n        - containerPort: 20880\n          protocol: TCP\n        env:\n        - name: JAR_BALL\n          value: dubbo-server.jar\n        imagePullPolicy: IfNotPresent\n      imagePullSecrets:\n      - name: harbor\n      restartPolicy: Always\n      terminationGracePeriodSeconds: 30\n      securityContext: \n        runAsUser: 0\n      schedulerName: default-scheduler\n  strategy:\n    type: RollingUpdate\n    rollingUpdate: \n      maxUnavailable: 1\n      maxSurge: 1\n  revisionHistoryLimit: 7\n  progressDeadlineSeconds: 600\n~~~\n\n> ä¸Šé¢specé‡Œçš„imageåŒ…è¦å¯¹ä¸Šä½ ç°åœ¨harborçš„åå­—\n>\n> æ—¶é—´è¦æ”¹æˆå½“å‰çš„æ—¶é—´ï¼Œè¿™ä¸ªæ˜¯ä¸ºäº†åšæ ‡è®°ï¼Œå¦‚æœå‡ºç°é—®é¢˜äº†å¯ä»¥è¯´è¿™ä¸ªåŒ…æ˜¯ä»€ä¹ˆæ—¶å€™åŒ…ï¼Œæ˜¯ä¸æ˜¯è‡ªå·±éƒ¨çš„ï¼Œé˜²æ­¢èƒŒé”…\n\n~~~\n# 21æœºå™¨ï¼Œåº”ç”¨èµ„æºé…ç½®æ¸…å•ï¼š\n~]# kubectl create ns app\n~]# kubectl create secret docker-registry harbor --docker-server=harbor.od.com --docker-username=admin --docker-password=Harbor12345 -n app\n# out: secret/harbor created\n\n# 11æœºå™¨ï¼š\ncd /opt/zookeeper\nzookeeper~]# bin/zkServer.sh status\n### out:\nZooKeeper JMX enabled by default\nUsing config: /opt/zookeeper/bin/../conf/zoo.cfg\nMode: follower\n###\nzookeeper]# bin/zkCli.sh -server localhost:2181\n# è¿æ¥åˆ°zkï¼Œå‘ç°é‡Œé¢åªæœ‰zkæ²¡æœ‰dubbo\n[zk: localhost:2181(CONNECTED) 0] ls /\n#out: [zookeeper]\n# 22æœºå™¨ï¼Œåº”ç”¨dubboï¼š\n~]# kubectl apply -f http://k8s-yaml.od.com/dubbo-demo-service/dp.yaml\n# out: deployment.extensions/dubbo-demo-service created\n~~~\n\n![1583133750175](assets/1583133750175.png)\n\n![1583133771985](assets/1583133771985.png)\n\n![1583133814367](assets/1583133814367.png)\n\n> ç›¸å…³æŠ¥é”™ï¼š\n>\n> ![1584603379421](assets/1584603379421.png)\n>\n> åŸå› ï¼šå› ä¸ºä½ çš„æ–‡ä»¶ä¸è§äº†\n>\n> ![1584603402104](assets/1584603402104.png)\n\n~~~\n# 11æœºå™¨æŸ¥çœ‹ï¼Œè¿™æ—¶å€™å·²ç»ä¸æ­¢zkï¼Œè¿˜æœ‰dubboï¼š\n[zk: localhost:2181(CONNECTED) 0] ls /\n#out: [dubbo, zookeeper]\n[zk: localhost:2181(CONNECTED) 1] ls /dubbo\n[com.od.dubbotest.api.HelloService]\n~~~\n\n![1583133849488](assets/1583133849488.png)\n\n> æ­¤æ—¶dubboæœåŠ¡å·²ç»æ³¨å†Œåˆ°JKäº¤ä»˜ä¸­å¿ƒï¼Œé¡¹ç›®å·²ç»äº¤ä»˜æˆåŠŸ\n\n\n\n### å€ŸåŠ©BlueOceanæ’ä»¶å›é¡¾Jenkinsæµæ°´çº¿æ„å»ºåŸç†\n\n![1583133065281](assets/1583133065281.png)\n\n![1583133094833](assets/1583133094833.png)\n\n\n\n![1583133158000](assets/1583133158000.png)\n\n![1583133204015](assets/1583133204015.png)\n\n\n\n![1583133288421](assets/1583133288421.png)\n\n\n\n![1583133397745](assets/1583133397745.png)\n\n> **ä¸€èˆ¬dockerfileæ˜¯ç”±è°å†™**ï¼šæœ‰ä¸€äº›å…¬å¸æ˜¯è¿ç»´ç”¨Jenkinså†™ï¼Œä¹Ÿæœ‰äº›å…¬å¸æ˜¯å¼€å‘è‡ªå·±å†™çš„\n\n![1583132650158](assets/1583132650158.png)\n\n> **Jenkinsæµæ°´çº¿æ„å»ºå°±è¿™äº”æ­¥**ï¼šæ‹‰å–ä»£ç â€”â€”>ç¼–è¯‘ä»£ç â€”â€”>åˆ°æŒ‡å®šç›®å½•æ‰“åŒ…jarâ€”â€”>æ„å»ºé•œåƒ\n\næ­¤æ—¶æä¾›è€…å·²ç»åœ¨harboré‡Œï¼Œæˆ‘ä»¬è¿˜éœ€è¦æŠŠå®ƒå‘åˆ°æˆ‘ä»¬çš„k8sé‡Œï¼ˆè¿˜æœ‰æ¶ˆè´¹è€…è¿˜æ²¡æ“ä½œï¼‰\n\né—®é¢˜æ¥äº†ï¼Œå¦‚æœæœ‰å¾ˆå¤šçš„æä¾›è€…å’Œæ¶ˆè´¹è€…éœ€è¦æ³¨å†Œè¿›æ¥zkï¼Œæ€»ä¸èƒ½æ¯æ¬¡éƒ½ç”¨å‘½ä»¤è¡Œè¿æ¥åˆ°zkç„¶åls / å»æŸ¥çœ‹ï¼Œæ‰€ä»¥éœ€è¦ä¸€ä¸ªå›¾å½¢åŒ–ç•Œé¢ï¼Œä¹Ÿå°±æ˜¯ä¸‹é¢çš„dubbo-monitor\n\n\n\n### äº¤ä»˜dubbo-monitoråˆ°k8sé›†ç¾¤ï¼š\n\n> **WHAT**ä¸Šé¢å·²ç»è®²åˆ°ï¼Œæ³¨å†Œåˆ°zké‡Œçš„æ—¶å€™ä¸èƒ½æ€»æ˜¯æ‰“å¼€æœºå™¨è¿›å»æŸ¥çœ‹ï¼Œæˆ‘ä»¬å¾—æœ‰ä¸ªå›¾å½¢åŒ–ç•Œé¢\n\n~~~\n# 200æœºå™¨ï¼Œä¸‹è½½åŒ…ï¼š\ncd /opt/src\nsrc]# wget https://github.com/Jeromefromcn/dubbo-monitor/archive/master.zip\nsrc]# unzip master.zip\n# æ²¡æœ‰unzipçš„ï¼Œyum install unzip -y\nsrc]# mv dubbo-monitor-master /opt/src/dubbo-monitor\nsrc]# ll\n~~~\n\n![1583134970446](assets/1583134970446.png)\n\n~~~\n# ä¿®æ”¹æºç ï¼Œ200æœºå™¨ï¼š\nsrc]# vi /opt/src/dubbo-monitor/dubbo-monitor-simple/conf/dubbo_origin.properties\ndubbo.application.name=dubbo-monitor\ndubbo.application.owner=ben1234560\ndubbo.registry.address=zookeeper://zk1.od.com:2181?backup=zk2.od.com:2181,zk3.od.com:2181\ndubbo.protocol.port=20880\ndubbo.jetty.port=8080\ndubbo.jetty.directory=/dubbo-monitor-simple/monitor\ndubbo.charts.directory=/dubbo-monitor-simple/charts\ndubbo.statistics.directory=/dubbo-monitor-simple/statistics\n~~~\n\n![1583137417965](assets/1583137417965.png)\n\n~~~\n# 200æœºå™¨ï¼Œä¿®æ”¹ä½¿ç”¨å†…å­˜é…ç½®æ–‡ä»¶ï¼š\ncd /opt/src/dubbo-monitor/dubbo-monitor-simple/bin\n# ä¿®æ”¹ï¼ŒåŸæœ¬æ˜¯ï¼š-Xmx2g -Xms2g -Xmn256m PermSize=128m -Xms1g -Xmx1g -XX:PermSize=128m\nbin]# vi start.sh\nif [ -n \"$BITS\" ]; then\n    JAVA_MEM_OPTS=\" -server -Xmx128m -Xms128m -Xmn32m -XX:PermSize=16m -Xss256k -XX:+DisableExplicitGC -XX:+UseConcMarkSweepGC -XX:+CMSParallelRemarkEnabled -XX:+UseCMSCompactAtFullCollection -XX:LargePageSizeInBytes=128m -XX:+UseFastAccessorMethods -XX:+UseCMSInitiatingOccupancyOnly -XX:CMSInitiatingOccupancyFraction=70 \"\nelse\n    JAVA_MEM_OPTS=\" -server -Xms128m -Xmx128m -XX:PermSize=16m -XX:SurvivorRatio=2 -XX:+UseParallelGC \"\nfi\n\necho -e \"Starting the $SERVER_NAME ...\\c\"\nexec java $JAVA_OPTS $JAVA_MEM_OPTS $JAVA_DEBUG_OPTS $JAVA_JMX_OPTS -classpath $CONF_DIR:$LIB_JARS com.alibaba.dubbo.container.Main > $STDOUT_FILE 2>&1\n\n# å†å¾€ä¸‹çš„å…¨éƒ¨å†…å®¹åˆ æ‰ï¼Œå¦‚å›¾\n~~~\n\n![1583137508620](assets/1583137508620.png)\n\n~~~\n# 200æœºå™¨ï¼Œbuildï¼š\ncd /opt/src\nsrc]# cp -a dubbo-monitor /data/dockerfile/\nsrc]# cd /data/dockerfile/dubbo-monitor\ndubbo-monitor]# docker build . -t harbor.od.com/infra/dubbo-monitor:latest\n# outï¼šSuccessfully built ...  Successfully tagged ...\ndubbo-monitor]# docker push harbor.od.com/infra/dubbo-monitor:latest\n~~~\n\n![1583135594711](assets/1583135594711.png)\n\n~~~\n# 200æœºå™¨ï¼Œé…ç½®èµ„æºæ¸…å•ï¼š\ndubbo-monitor]# mkdir /data/k8s-yaml/dubbo-monitor\ndubbo-monitor]# cd /data/k8s-yaml/dubbo-monitor\ndubbo-monitor]# vi dp.yaml\nkind: Deployment\napiVersion: extensions/v1beta1\nmetadata:\n  name: dubbo-monitor\n  namespace: infra\n  labels: \n    name: dubbo-monitor\nspec:\n  replicas: 1\n  selector:\n    matchLabels: \n      name: dubbo-monitor\n  template:\n    metadata:\n      labels: \n        app: dubbo-monitor\n        name: dubbo-monitor\n    spec:\n      containers:\n      - name: dubbo-monitor\n        image: harbor.od.com/infra/dubbo-monitor:latest\n        ports:\n        - containerPort: 8080\n          protocol: TCP\n        - containerPort: 20880\n          protocol: TCP\n        imagePullPolicy: IfNotPresent\n      imagePullSecrets:\n      - name: harbor\n      restartPolicy: Always\n      terminationGracePeriodSeconds: 30\n      securityContext: \n        runAsUser: 0\n      schedulerName: default-scheduler\n  strategy:\n    type: RollingUpdate\n    rollingUpdate: \n      maxUnavailable: 1\n      maxSurge: 1\n  revisionHistoryLimit: 7\n  progressDeadlineSeconds: 600\n\ndubbo-monitor]# vi svc.yaml\nkind: Service\napiVersion: v1\nmetadata: \n  name: dubbo-monitor\n  namespace: infra\nspec:\n  ports:\n  - protocol: TCP\n    port: 8080\n    targetPort: 8080\n  selector: \n    app: dubbo-monitor\n\ndubbo-monitor]# ingress.yaml\nkind: Ingress\napiVersion: extensions/v1beta1\nmetadata: \n  name: dubbo-monitor\n  namespace: infra\nspec:\n  rules:\n  - host: dubbo-monitor.od.com\n    http:\n      paths:\n      - path: /\n        backend: \n          serviceName: dubbo-monitor\n          servicePort: 8080\n~~~\n\n> æ¯æ¬¡åˆ›å»ºå®Œyamlåï¼Œä½ éƒ½å¯ä»¥å»k8s-yaml.od.comç½‘å€çœ‹ä¸‹æœ‰æ²¡æœ‰åœ¨é‡Œé¢äº†\n\n~~~\n# åº”ç”¨èµ„æºæ¸…å•å‰ï¼Œå…ˆè§£æåŸŸåï¼Œ11æœºå™¨ï¼š\n11 ~]# vim /var/named/od.com.zone\n# serial å‰æ»šä¸€ä¸ª\ndubbo-monitor      A    10.4.7.10\n\n11 ~]# systemctl restart named\n11 ~]# dig -t A dubbo-monitor.od.com @10.4.7.11 +short\n# out: 10.4.7.10\n~~~\n\n![1583135902145](assets/1583135902145.png)\n\n~~~\n# 22æœºå™¨ï¼Œåº”ç”¨èµ„æºé…ç½®æ¸…å•ï¼š\n22 ~]# kubectl apply -f http://k8s-yaml.od.com/dubbo-monitor/dp.yaml\n22 ~]# kubectl apply -f http://k8s-yaml.od.com/dubbo-monitor/svc.yaml\n22 ~]# kubectl apply -f http://k8s-yaml.od.com/dubbo-monitor/ingress.yaml\n~~~\n\n![1580955553025](assets/1580955553025.png)\n\n> ç›¸å…³æŠ¥é”™ï¼špodæç¤ºCrashLoopBackOff\n>\n> æ’æŸ¥æ€è·¯ï¼šlogæˆ–è€…kubectl get eventæŠ¥é”™ä¿¡æ¯å¦‚ä¸‹\n>\n> ![1681349321605](assets/1681349321605.png)\n>\n> è¿›å…¥å®¹å™¨å†…æ‰§è¡Œstart.shæŠ¥é”™read-only file systemã€‚\n>\n> è§£å†³æ–¹æ³•ï¼šå‚è€ƒIssuesï¼ˆä½œè€…@stringguaiï¼‰https://github.com/ben1234560/k8s_PaaS/issues/33ï¼‰ï¼š\n>\n> 1ã€dubbo-monitor å¯åŠ¨æŠ¥ read-only file systemçš„é”™ï¼Œä¿®æ”¹bin/start.shï¼Œæ³¨é‡Šç¬¬ä¸€è¡Œ\"cp xxxxx\"ï¼Œæ‰‹åŠ¨cp dubbo_origin.properties dubbo.propertiesï¼Œåœ¨è¿›è¡Œé•œåƒçš„æ„å»º\n> 2ã€podèµ·ä¸æ¥çš„é—®é¢˜ï¼Œä¿®æ”¹bin/start.sh, å°†nohup java $JAVA_OPTSé‚£ä¸€è¡Œæœ€åçš„é‡å®šå‘å’Œåå°è¿è¡Œç¬¦& å»æ‰ ï¼Œå³å»æ‰â€œ2>&1 &â€\n\n[è®¿é—®ç½‘ç«™ http://dubbo-monitor.od.com](http://dubbo-monitor.od.com)\n\n![1583139242622](assets/1583139242622.png)\n\n![1583139255552](assets/1583139255552.png)\n\nç•Œé¢ç‰ˆçš„äº¤ä»˜é¡µé¢å®Œæˆã€‚\n\n> ç›¸å…³å°é—®é¢˜ï¼š\n>\n> å‘ç°podæœ‰é—®é¢˜ï¼Œå› ä¸ºä¹‹å‰çš„é…ç½®æ–‡ä»¶æ²¡ä¿®æ”¹å¥½ï¼Œé•œåƒæ˜¯èµ·ä¸æ¥çš„\n>\n> ![1583136107703](assets/1583136107703.png)\n>\n> è§£å†³åŠæ³•ï¼šä¿®æ”¹å¥½é…ç½®æ–‡ä»¶ï¼Œæ–°buildé•œåƒï¼Œç„¶åä¿®æ”¹dp.yamlæŒ‡å®šé•œåƒï¼Œç„¶åapply -f åº”ç”¨ï¼Œå†åˆ æ‰è¿™ä¸ªpodå³å¯\n\n#### äº¤ä»˜dubboæœåŠ¡çš„æ¶ˆè´¹è€…åˆ°K8S\n\nç™»å½•Jenkinsï¼Œè´¦å·ï¼šadminï¼Œå¯†ç ï¼šadmin123\n\n![1583139377309](assets/1583139377309.png)\n\n~~~\n# å¡«å…¥æŒ‡å®šå‚æ•°\napp_name:       dubbo-demo-consumer\nimage_name:     app/dubbo-demo-consumer\ngit_repo:        http://gitlab.od.com:10000/909336740/dubbo-demo-web.git\ngit_ver:        master\nadd_tag:        200302_1700\nmvn_dir:        ./\ntarget_dir:     ./dubbo-client/target\nmvn_cmd:        mvn clean package -e -q -Dmaven.test.skip=true\nbase_image:     base/jre8:8u112\nmaven:          3.6.1-8u232\n# ç‚¹å‡»Buildè¿›è¡Œæ„å»ºï¼Œç­‰å¾…æ„å»ºå®Œæˆï¼Œmvn_cmd é‡Œçš„ -e -qæ˜¯è®©è¾“å‡ºè¾“å‡ºçš„å¤šç‚¹ï¼Œå¯ä»¥çœ‹é‡Œé¢çš„å†…å®¹\n~~~\n\n![1583140213653](assets/1583140213653.png)\n\n> è¿™é‡Œçš„git_repoä½ åº”è¯¥ç”¨å…¬ç½‘çš„giteeæˆ–è€…GitHubï¼Œæˆ‘å› ä¸ºçœé’±ä¹°çš„ç½‘ç»œæœ‰äº›é—®é¢˜çš„æœºå™¨ï¼Œæ‰€ä»¥åªèƒ½ä¸€ç›´ç”¨gitlab\n\n![1583141273267](assets/1583141273267.png)\n\n![1583141305844](assets/1583141305844.png)\n\n> ç¬¬ä¸€æ¬¡ç¼–è¯‘æ¯”è¾ƒä¹…ï¼ˆå› ä¸ºè¦è¿œç¨‹ä¸‹è½½ä¸‹æ¥ï¼‰ï¼Œéœ€è¦è€å¿ƒç­‰å¾…ï¼Œ3åˆ†é’Ÿå·¦å³ï¼Œæœ€ç»ˆä¼šsuccessï¼Œæ­¤æ—¶harboré‡Œé¢å·²ç»æœ‰äº†\n\n![1583141341105](assets/1583141341105.png)\n\n> å¯ä»¥å»è“æµ·çœ‹æ„å»ºè¿‡ç¨‹ï¼Œè¿›å…¥æ–¹æ³•ä¸Šé¢å›é¡¾çš„æ—¶å€™æœ‰\n\n![1583141384774](assets/1583141384774.png)\n\n~~~\n# 200æœºå™¨ï¼Œå‡†å¤‡èµ„æºé…ç½®æ¸…å•ï¼š\nmkdir /data/k8s-yaml/dubbo-demo-consumer\ncd /data/k8s-yaml/dubbo-demo-consumer\ndubbo-demo-consumer]# vi dp.yaml\nkind: Deployment\napiVersion: extensions/v1beta1\nmetadata:\n  name: dubbo-demo-consumer\n  namespace: app\n  labels: \n    name: dubbo-demo-consumer\nspec:\n  replicas: 1\n  selector:\n    matchLabels: \n      name: dubbo-demo-consumer\n  template:\n    metadata:\n      labels: \n        app: dubbo-demo-consumer\n        name: dubbo-demo-consumer\n    spec:\n      containers:\n      - name: dubbo-demo-consumer\n        image: harbor.od.com/app/dubbo-demo-consumer:master_200302_1700\n        ports:\n        - containerPort: 8080\n          protocol: TCP\n        - containerPort: 20880\n          protocol: TCP\n        env:\n        - name: JAR_BALL\n          value: dubbo-client.jar\n        imagePullPolicy: IfNotPresent\n      imagePullSecrets:\n      - name: harbor\n      restartPolicy: Always\n      terminationGracePeriodSeconds: 30\n      securityContext: \n        runAsUser: 0\n      schedulerName: default-scheduler\n  strategy:\n    type: RollingUpdate\n    rollingUpdate: \n      maxUnavailable: 1\n      maxSurge: 1\n  revisionHistoryLimit: 7\n  progressDeadlineSeconds: 600\n\ndubbo-demo-consumer]# vi svc.yaml\nkind: Service\napiVersion: v1\nmetadata: \n  name: dubbo-demo-consumer\n  namespace: app\nspec:\n  ports:\n  - protocol: TCP\n    port: 8080\n    targetPort: 8080\n  selector: \n    app: dubbo-demo-consumer\n\ndubbo-demo-consumer]# vi ingress.yaml\nkind: Ingress\napiVersion: extensions/v1beta1\nmetadata: \n  name: dubbo-demo-consumer\n  namespace: app\nspec:\n  rules:\n  - host: demo.od.com\n    http:\n      paths:\n      - path: /\n        backend: \n          serviceName: dubbo-demo-consumer\n          servicePort: 8080\n~~~\n\n> æœ‰ingressäº†ï¼Œæ‰€ä»¥åº”ç”¨ä¹‹å‰ï¼Œæˆ‘ä»¬å¾—è§£æä¸€ä¸‹åŸŸå\n\n~~~\n# 11æœºå™¨ï¼Œè§£æåŸŸåï¼š\n11 ~]# vi /var/named/od.com.zone\nserial å‰æ»šä¸€ä¸ªåºå·\ndemo               A    10.4.7.10\n\n11 ~]# systemctl restart named\n11 ~]# dig -t A demo.od.com @10.4.7.11 +short\n#out: 10.4.7.10\n~~~\n\n![1583141600029](assets/1583141600029.png)\n\n~~~\n# 22æœºå™¨ï¼ˆ22è¿˜æ˜¯21éƒ½æ— æ‰€è°“ï¼‰ï¼Œåº”ç”¨èµ„æºé…ç½®æ¸…å•ï¼š\n22 ~]# kubectl apply -f http://k8s-yaml.od.com/dubbo-demo-consumer/dp.yaml\n22 ~]# kubectl apply -f http://k8s-yaml.od.com/dubbo-demo-consumer/svc.yaml\n22 ~]# kubectl apply -f http://k8s-yaml.od.com/dubbo-demo-consumer/ingress.yaml\n~~~\n\n![1580963332570](assets/1580963332570.png)\n\n[åˆ·æ–°dubbo-monitor-applicationç•Œé¢](http://dubbo-monitor.od.com/applications.html)\n\n![1583141734527](assets/1583141734527.png)\n\n~~~\nåœ¨æµè§ˆå™¨è¾“å…¥ä»¥ä¸‹ç½‘å€\nhttp://demo.od.com/hello?name=ben1234560\n~~~\n\n![1583141771920](assets/1583141771920.png)\n\næˆåŠŸ\n\n![1580972027995](assets/1580972027995.png)\n\n> æœ€é‡è¦çš„æ˜¯è½¯è´Ÿè½½å‡è¡¡åŠæ‰©å®¹ï¼Œä¹Ÿå°±æ˜¯å¯ä»¥éšæ„æ‰©å®¹åç«¯æˆ–å‰ç«¯ï¼Œä½ å¯ä»¥è¿™ä¹ˆè¯•è¯•ï¼Œå…ˆæŠŠæœåŠ¡è€…podæ§åˆ¶å™¨æ”¹æˆ3ä¸ª\n\n![1583141879765](assets/1583141879765.png)\n\n![1583141886649](assets/1583141886649.png)\n\n> æŠŠæ¶ˆè´¹è€…podæ”¹æˆä¸¤ä¸ª\n\n![1583141974794](assets/1583141974794.png)\n\n> è¿™æ ·ä¸€å…±å°±æ˜¯5ä¸ªï¼Œå®Œæˆæ‰©å®¹\n\nç„¶åç¼©å®¹ï¼Œå…ˆæŠŠæ¶ˆè´¹è€…æ”¹æˆ1ä¸ªï¼Œå†æŠŠæœåŠ¡è€…ä¹Ÿæ”¹æˆä¸€ä¸ª\n\n![1583142064082](assets/1583142064082.png)\n\n> åˆ·æ–°é¡µé¢ï¼Œå®Œæˆç¼©å®¹\n\n![1583142098269](assets/1583142098269.png)\n\n> è¿™æ ·çš„å¥½å¤„å°±æ˜¯ä½ å¯ä»¥éšæ„æ— ç¼éš™çš„æ‰©å®¹ç¼©å®¹ï¼Œå½“ç”¨æˆ·è®¿é—®é‡é«˜çš„æ—¶å€™æ‰©å®¹ï¼Œè®¿é—®é‡å°çš„æ—¶å€™ç¼©å®¹\n>\n\n\n\n### å®ç°dubboé›†ç¾¤çš„æ—¥å¸¸ç»´æŠ¤\n\n> **WHAT**ï¼šæ—¥å¸¸ä¸­è‚¯å®šæœ‰ä»£ç è¿­ä»£çš„æƒ…å†µï¼Œå¼€å‘æ›´æ–°äº†ä»£ç ï¼Œæˆ‘ä»¬è¿­ä»£App\n\næˆ‘ä»¬æ”¹äº†ä¸‹é¢çº¢æ¡†å†…çš„ä¸€äº›å†…å®¹ï¼Œæ¨¡æ‹Ÿå¼€å‘ä»£ç çš„è¿­ä»£\n\n![1582604101870](assets/1582604101870.png)\n\næ›´æ”¹å®Œåæäº¤åˆ°ä»“åº“\n\n![1582604137705](assets/1582604137705.png)\n\n![1582604248247](assets/1582604248247.png)\n\nå†ç”¨Jenkinsæ„å»º\n\n~~~\n# å¡«å…¥æŒ‡å®šå‚æ•°\napp_name:       dubbo-demo-consumer\nimage_name:     app/dubbo-demo-consumer\ngit_repo:       https://gitee.com/benjas/dubbo-demo-web.git\ngit_ver:        d76f474\nadd_tag:        200302_2311\nmvn_dir:        ./\ntarget_dir:     ./dubbo-client/target\nmvn_cmd:        mvn clean package -e -q -Dmaven.test.skip=true\nbase_image:     base/jre8:8u112\nmaven:          3.6.1-8u232\n# ç‚¹å‡»Buildè¿›è¡Œæ„å»ºï¼Œç­‰å¾…æ„å»ºå®Œæˆï¼Œmvn_cmd é‡Œçš„ -e -qæ˜¯è®©è¾“å‡ºè¾“å‡ºçš„å¤šç‚¹ï¼Œå¯ä»¥çœ‹é‡Œé¢çš„å†…å®¹\n~~~\n\n![1583161598444](assets/1583161598444.png)\n\nharboré‡Œé¢æœ‰äº†æ–°çš„é•œåƒ\n\n![1583161729247](assets/1583161729247.png)\n\n> æ³¨æ„ï¼Œæˆ‘è¿™é‡Œçš„ç‰ˆæœ¬å·æ˜¯æˆ‘åœ¨gitlabåšçš„ï¼ˆå› ä¸ºç½‘ç»œçœŸçš„ä¸æƒ³ï¼‰ï¼Œä¸Šé¢æ˜¯ä¸ºäº†æ¼”ç¤ºç”¨å…¬ç½‘çš„gitï¼Œæ‰€ä»¥æ­£ç¡®çš„åº”è¯¥æ˜¯è¿™ä¸ªåå­—d76f474_200302_2311\n\nåœ¨dashboardé‡Œé¢æ”¹é•œåƒå\n\n![1583161856968](assets/1583161856968.png)\n\n![1583161906128](assets/1583161906128.png)\n\n> åŒæ ·ï¼Œè¿™ä¸ªgitlabçš„ï¼Œå…¶å®åº”è¯¥æ˜¯d76f474_200302_2311\n\n~~~\nå†å»ä¸‹é¢è¿™ä¸ªç½‘å€ï¼Œåˆ·æ–°\nhttp://demo.od.com/hello?name=ben1234560\n~~~\n\n![1582613370939](assets/1582613370939.png)\n\nè¿™æ ·ä½ å°±å®Œæˆäº†ç‰ˆæœ¬è¿­ä»£\n\n![1580997705509](assets/1580997705509.png)\n\n[^å›é¡¾]: æ­¤æ—¶æˆ‘ä»¬åœ¨çœ‹ä¸€ä¸‹è¿™å¼ å›¾ï¼Œgitæˆ‘ä»¬ç”¨äº†ï¼ŒJenkinsç¼–è¯‘æ‰“åŒ…äº†ï¼Œingressèµ„æºæ¸…å•ï¼Œdubboå¾®æœåŠ¡èµ·äº†ï¼Œzkæ³¨å†Œä¸­å¿ƒåšäº†ï¼Œharborç§æœ‰ä»“åº“å®Œæˆäº†ï¼Œk8s-yamlç½‘å€æœ‰äº†ï¼Œkubernetesè¿æ¥äº†ï¼Œæ‰€æœ‰ä¸œè¥¿éƒ½å®ç°äº†ç‚¹ç‚¹ç‚¹ï¼Œå°±å·®OPSæœåŠ¡å™¨çš„è‡ªåŠ¨åŒ–ã€‚æˆ‘ä»¬éœ€è¦Jenkinsæ‰“åŒ…ååˆ°harborä»“åº“é‡Œåï¼Œè‡ªåŠ¨å˜æˆyamlåˆ°K8Sé‡Œã€‚\n\n> æˆ‘ä»¬çš„ç›®æ ‡æ˜¯å®ç°è‡ªåŠ¨åŒ–ï¼Œè§£æ”¾ç”Ÿäº§åŠ›ã€‚\n\n\n\n### å®æˆ˜K8Sé›†ç¾¤æ¯ç­æ€§æµ‹è¯•\n\n> **WHAT**ï¼šç”Ÿäº§ä¸­æ€»ä¼šé‡åˆ°çªç„¶å®•æœºç­‰æƒ…å†µï¼Œæˆ‘ä»¬éœ€è¦æ¥æ¨¡æ‹Ÿä¸€ä¸‹\n\nç”Ÿäº§ä¸Šï¼Œä¿è¯æœåŠ¡éƒ½æ˜¯èµ·ä¸¤ä»½ä»¥ä¸Šï¼Œæ‰€æœ‰æˆ‘ä»¬ç»™consumerå’Œserviceéƒ½èµ·ä¸¤ä»½\n\n![1584239463336](assets/1584239463336.png)\n\n![1581049921071](assets/1581049921071.png)\n\næˆ‘ä»¬å¯ä»¥çœ‹åˆ°21å’Œ22åˆ†åˆ«éƒ½æœ‰ä¸¤å°ï¼Œè¿™æ˜¯scheduleåšçš„èµ„æºåˆ†é…\n\næ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬æ¨¡æ‹Ÿä¸€å°æœåŠ¡å™¨ç‚¸äº†\n\n~~~\n# 21æœºå™¨ï¼š\n~]# halt\n~~~\n\n![1581043155735](assets/1581043155735.png)\n\n> å†å»demoç½‘å€ï¼Œå‘ç°å·²ç»è¿›ä¸å»äº†ï¼Œdashboardå·²ç»503äº†\n\n![1581043277189](assets/1581043277189.png)\n\n> å®¿ä¸»æœºçˆ†ç‚¸ï¼Œæˆ‘ä»¬çš„ç¬¬ä¸€ä»¶äº‹æƒ…ï¼Œå°±æ˜¯æŠŠç¦»çº¿çš„ä¸»æœºåˆ äº†ï¼ˆå¦‚æœä¸åˆ æ‰ï¼Œé‚£ä¹ˆk8sä¼šè®¤ä¸ºæ˜¯ç½‘ç»œæŠ–åŠ¨æˆ–è€…ä»€ä¹ˆé—®é¢˜ï¼Œä¼šä¸æ–­çš„é‡è¿ï¼‰\n\n~~~\n# 22æœºå™¨ï¼Œåˆ é™¤ç¦»çº¿ä¸»æœºï¼š\n~]# kubeclt delete node hdss7-21.host.com\n# out: node \"hdss7-21.host.com\" deleted\n~~~\n\n> åˆ é™¤äº†åï¼Œk8sæœ‰è‡ªæ„ˆæœºåˆ¶ï¼Œä¼šåœ¨22èŠ‚ç‚¹è‡ªå·±èµ·æ¥\n>\n> æˆ‘ä»¬åœ¨å»ç½‘å€æŸ¥çœ‹ï¼ˆæ—¶é—´å¯èƒ½æ…¢ä¸€äº›ï¼Œå½“ç„¶ä½ ä¸æ–­åˆ·æ–°çš„æ—¶å€™å¯èƒ½å‘ç°å¶å°”ä¼šæœ‰æŠ¥é”™ï¼Œç„¶ååˆåˆ·æ–°å°±åˆå¥½äº†ï¼Œä¸‹é¢ä¼šè®²åˆ°ï¼‰\n\n![1582613370939](assets/1582613370939.png)\n\n> æ­¤æ—¶å¯ä»¥çœ‹åˆ°dashboardå·²ç»åœ¨èµ·æ¥çš„çŠ¶æ€ï¼Œæˆ‘ä»¬çš„é…ç½®æ¯”è¾ƒå·®ï¼Œæ‰€ä»¥èµ·æ¥çš„æ¯”è¾ƒæ…¢\n>\n> ç°åœ¨çœ‹åˆ°å·²ç»èµ·æ¥äº†ï¼Œä½†æ˜¯ä¸‹é¢è¿˜æœ‰ä¸€ä¸ªbackoffçŠ¶æ€podï¼Œåº”è¯¥æ˜¯è´Ÿè½½çš„é—®é¢˜ï¼Œä¹Ÿå°±æ˜¯å¼•å‘ä¸Šé¢çš„ç½‘å€æœ‰æ—¶å€™åˆ·æ–°æ˜¯æŠ¥é”™çŠ¶æ€ï¼Œå› ä¸ºnginxçš„è´Ÿè½½\n\n![1584239156636](assets/1584239156636.png)\n\næˆ‘ä»¬å»æ”¹ä¸€ä¸‹nginx\n\n~~~\n# 11æœºå™¨ï¼Œå»åˆ°æœ€ä¸‹é¢æŠŠ21èŠ‚ç‚¹æ³¨é‡Šæ‰ï¼š\nvi /etc/nginx/nginx.conf\n# server.10.4.7.21:6443\n~~~\n\n![1584239144369](assets/1584239144369.png)\n\n~~~\n# 11æœºå™¨ï¼Œtraefikçš„21èŠ‚ç‚¹ä¹Ÿæ³¨é‡Šæ‰ï¼š\n~]# Vi /etc/ningx/conf.d/od.com.conf\n# server 10.4.7.21.81     max_fails=3 fail_timeout=10s;\n\n~]# nginx -s reload\n~~~\n\n![1581044038945](assets/1581044038945.png)\n\nè¿™æ—¶å€™ä½ å»åˆ·æ–°ç½‘å€ï¼Œå·²ç»ä¸ä¼šå‡ºç°å¶å°”æŠ¥é”™çš„çŠ¶å†µäº†ï¼Œå®¹å™¨ä¹Ÿå·²ç»èµ·æ¥äº†\n\n![1581048655265](assets/1581048655265.png)\n\nç°åœ¨ï¼Œæˆ‘ä»¬å·²ç»å®Œæˆäº†æœåŠ¡å™¨ï¼ˆä¸»æœºï¼‰ç‚¸äº†åçš„åº”æ€¥è§£å†³\n\n#### é›†ç¾¤æ¢å¤ï¼š\n\n~~~\n# 21æœºå™¨ï¼Œé‡æ–°è¿æ¥21æœºå™¨ï¼š\n~]# supervisorctl status\n~]# kubectl get nodes\n~]# kubectl label node hdss7-21.host.com node-role.kubernetes.io/master=\n# out: node/hdss7-21.host.comt labeled\n~]# kubectl label node hdss7-21.host.com node-role.kubernetes.io/node=\n# out: node/hdss7-21.host.com labeled\n~~~\n\n![1581049071994](assets/1581049071994.png)\n\n![1584239248833](assets/1584239248833.png)\n\n> æ‰€æœ‰å·²ç»èµ·æ¥äº†ï¼Œæˆ‘ä»¬åœ¨æŠŠè´Ÿè½½çš„æ³¨é‡Šæ”¹å›æ¥\n\n~~~\n# 11æœºå™¨ï¼Œä¿®æ”¹è´Ÿè½½ï¼š\n~]# vi /etc/nginx/nginx.conf\nserver.10.4.7.21:6443\n\n~]# vi /etc/ningx/conf.d/od.com.conf\nserver 10.4.7.21.81     max_fails=3 fail_timeout=10s;\n\nnginx -s reload\n~~~\n\n> è¿™æ—¶å€™æˆ‘ä»¬çœ‹ä¸€ä¸‹dubboæœåŠ¡éƒ½èµ·åœ¨å“ªé‡Œ\n\n~~~\n# 21æœºå™¨ï¼š\n~]# kubectl get pods -n app -o wide\n~~~\n\n![1584239281131](assets/1584239281131.png)\n\n![1581049691958](assets/1581049691958.png)\n\n> å¯ä»¥çœ‹åˆ°éƒ½æ˜¯åœ¨22æœºå™¨ä¸Šè¿è¡Œï¼Œæˆ‘ä»¬æœ‰è®¡åˆ’çš„åšä¸€ä¸‹è°ƒåº¦ï¼ˆèµ„æºå¹³è¡¡ï¼‰\n\n~~~\n# åˆ æ‰ä¸€ä¸ªconsumerå’Œä¸€ä¸ªserviceï¼Œ21æœºå™¨ï¼š\n~]# kubectl delete pods dubbo-demo-consumer-5874d7c89d-8dmk4 -n app\n~]# kubectl delete pods dubbo-demo-service-7754d5cb8b-78bhf -n app\n~~~\n\n![1581050095300](assets/1581050095300.png)\n\n![1581050205612](assets/1581050205612.png)\n\n~~~\n# 21æœºå™¨ï¼Œå¯ä»¥çœ‹åˆ°21æœºå™¨å’Œ22æœºå™¨éƒ½åˆ†åˆ«æ˜¯ä¸¤ä¸ªäº†ï¼š\n~]# kubectl get pods -n app -o wide\n~~~\n\n![1584239330451](assets/1584239330451.png)\n\næ­¤æ—¶æˆ‘ä»¬å»dashboardçœ‹ä¸€ä¸‹ï¼Œå‘ç°ä¸å¯ç”¨\n\n![1581050328121](assets/1581050328121.png)\n\n~~~\n# 21æœºå™¨,æŠŠdashboardåˆ æ‰è®©k8Sé‡æ–°è°ƒåº¦ï¼š\n~]# kubectl get pods -n kube-system\n~]# kubectl delete pods kubernetes-dashboard-76dcdb4677-kv8mq -n kube-system\n~~~\n\n![1581050421428](assets/1581050421428.png)\n\næˆåŠŸï¼Œæ˜¯ä¸æ˜¯æ¯”è¾ƒç®€å•ï¼Œè¿™å°±æ˜¯åˆ†å¸ƒå¼çš„èƒ½åŠ›\n\n~~~\n# 21æœºå™¨ï¼ŒæŸ¥çœ‹ä¸€ä¸‹iptablesè§„åˆ™æœ‰æ²¡æœ‰é—®é¢˜\nzookeeper]# iptables-save |grep -i postrouting\n# æŠŠæœ‰é—®é¢˜çš„è§„åˆ™åˆ äº†\nzookeeper]# iptables -t nat -D POSTROUTING -s 172.7.21.0/24 ! -o docker0 -j MASQUERADE\n# ä¿®æ”¹è§„åˆ™å¹¶å¯åŠ¨\nzookeeper]# iptables -t nat -I POSTROUTING -s 172.7.21.0/24 ! -d 172.7.0.0/16 ! -o docker0 -j MASQUERADE\nzookeeper]# iptables-save |grep -i postrouting\n~~~\n\n![1581090020941](assets/1581090020941.png)\n\nä¿®æ”¹å®Œæˆ\n\n"
        },
        {
          "name": "ç¬¬å…«ç« â€”â€”spinnakeréƒ¨ç½²ä¸åº”ç”¨.md",
          "type": "blob",
          "size": 50.2431640625,
          "content": "## ç¬¬å…«ç« â€”â€”spinnakeréƒ¨ç½²ä¸åº”ç”¨\n\n> ä»æœ¬ç« èŠ‚å¼€å§‹ï¼Œå¾ˆå¤šäº‹æƒ…æˆ‘ä¸å†æˆªå›¾è€Œæ˜¯ä¸€ç¬”å¸¦è¿‡ï¼Œä»¥ä¾¿ä½ æ›´å¥½çš„åŠ¨æ‰‹æ“ä½œï¼Œä¸è¿‡ï¼Œä¸€ç¬”å¸¦è¿‡çš„åœ°æ–¹æˆ‘ä¸€å®šä¸ä¼šç•™å¤§å‘ï¼Œè¿™ä¸ªä½ å¯ä»¥å®Œå…¨æ”¾å¿ƒ\n\n#### å…³äºIaaSã€PaaSã€SaaS\n\n![1581819941099](assets/1581819941099.png)\n\n> K8Sä¸æ˜¯ä¼ ç»Ÿæ„ä¹‰ä¸Šçš„Paaså¹³å°ï¼Œè€Œå¾ˆå¤šäº’è”ç½‘å…¬å¸éƒ½éœ€è¦çš„æ˜¯Paaså¹³å°ï¼Œè€Œä¸æ˜¯å•çº¯çš„K8Sï¼ŒK8SåŠå…¶å‘¨è¾¹ç”Ÿæ€ï¼ˆå¦‚logstashã€Prometheusç­‰ï¼‰æ‰æ˜¯Paaså¹³å°ï¼Œæ‰æ˜¯å…¬å¸éœ€è¦çš„\n\n#### è·å¾—PaaSèƒ½åŠ›çš„å‡ ä¸ªå¿…è¦æ¡ä»¶ï¼š\n\n- ç»Ÿä¸€åº”æœ‰çš„è¿è¡Œæ—¶ç¯å¢ƒï¼ˆdockerï¼‰\n- æœ‰IaaSèƒ½åŠ›ï¼ˆK8Sï¼‰\n- æœ‰å¯é çš„ä¸­é—´ä»¶é›†ç¾¤ã€æ•°æ®åº“é›†ç¾¤ï¼ˆDBAçš„ä¸»è¦å·¥ä½œï¼‰\n- æœ‰åˆ†å¸ƒå¼å­˜å‚¨é›†ç¾¤ï¼ˆå­˜å‚¨å·¥ç¨‹å¸ˆçš„ä¸»è¦å·¥ä½œï¼‰\n- æœ‰é€‚é…çš„ç›‘æ§ã€æ—¥å¿—ç³»ç»Ÿï¼ˆPrometheusã€ELKï¼‰\n- æœ‰å®Œå–„çš„CIã€CDç³»ç»Ÿï¼ˆJenkinsã€Spinnakerï¼‰\n\n> é˜¿é‡Œäº‘ã€è…¾è®¯äº‘ç­‰å‚å•†éƒ½æä¾›äº†K8Sä¸ºåº•çš„æœåŠ¡ï¼Œå³ä½ ä¹°äº†é›†ç¾¤å°±ç»™ä½ é…å¤‡äº†K8Sï¼Œä½†æˆ‘ä»¬ä¸èƒ½å®Œå…¨ä¾èµ–äºå‚å•†ï¼Œè€Œè¢«é’³åˆ¶ï¼ŒåŒæ—¶æˆ‘ä»¬ä¹Ÿéœ€è¦ä¸æ–­çš„å­¦ä¹ ä»¥å¤‡æ›´å¥½çš„ç†è§£å’Œä½¿ç”¨ï¼Œå…¬å¸è¶Šå¤§æ—¶è¶Šéœ€è¦è‡ªå·±åˆ›å»ºè€Œä¸æ˜¯ä¾èµ–äºå‚å•†ã€‚\n\n#### spinnakerç®€ä»‹\n\n> **WHAT**ï¼šé€šè¿‡çµæ´»å’Œå¯é…ç½® Pipelinesï¼Œå®ç°å¯é‡å¤çš„è‡ªåŠ¨åŒ–éƒ¨ç½²ï¼›æä¾›æ‰€æœ‰ç¯å¢ƒçš„å…¨å±€è§†å›¾ï¼Œå¯éšæ—¶æŸ¥çœ‹åº”ç”¨ç¨‹åºåœ¨å…¶éƒ¨ç½² Pipeline çš„çŠ¶æ€ï¼›æ˜“äºé…ç½®ã€ç»´æŠ¤å’Œæ‰©å±•ï¼›ç­‰ç­‰ï¼›\n\nä¸»è¦åŠŸèƒ½\n\n- é›†ç¾¤ç®¡ç†ï¼šä¸»è¦ç”¨äºç®¡ç†äº‘èµ„æºï¼Œå³ä¸»è¦æ˜¯IaaSçš„èµ„æº\n- éƒ¨è½ç®¡ç†ï¼šè´Ÿè´£å°†Jenkinsæµæ°´çº¿åˆ›å»ºçš„é•œåƒï¼Œéƒ¨ç½²åˆ°K8Sé›†ç¾¤ä¸­å»ï¼Œè®©æœåŠ¡çœŸæ­£è¿è¡Œèµ·æ¥ã€‚\n- æ¶æ„ï¼š[å®˜ç½‘åœ°å€](https://www.spinnaker.io/reference/architecture/)\n\n![1581822996520](assets/1581822996520.png)\n\n> Deckï¼šç‚¹ç‚¹ç‚¹é¡µé¢\n>\n> Gateï¼šç½‘å…³\n>\n> Igorï¼šç”¨æ¥å’ŒJenkinsé€šä¿¡\n>\n> Echoï¼šä¿¡æ¯é€šè®¯ç»„ä»¶\n>\n> Orcaï¼šä»»åŠ¡ç¼–æ’å¼•æ“\n>\n> Clouddriverï¼šäº‘è®¡ç®—åŸºç¡€è®¾æ–½\n>\n> Front50ï¼šç®¡ç†æŒä¹…åŒ–æ•°æ®\n>\n> å…¶ä¸­æˆ‘ä»¬ç”¨åˆ°redisã€minio\n>\n> éƒ¨ç½²é¡ºåºï¼šMinio-->Redis-->Clouddriver-->Front50-->Orca-->Echo-->Igor-->Gate-->Deck-->Nginx(æ˜¯é™æ€é¡µé¢æ‰€ä»¥éœ€è¦)\n\n### éƒ¨ç½²Spinnakerçš„Amoryå‘è¡Œç‰ˆ\n\n~~~\n# 200æœºå™¨ï¼Œå‡†å¤‡é•œåƒã€åœ¨èµ„æºæ¸…å•ï¼š\n~]# docker pull minio/minio:latest\n~]# docker images|grep minio\n~]# docker tag 7ea4a619ecfc harbor.od.com/armory/minio:latest\n# åœ¨æ­¤ä¹‹å‰ä½ åº”è¯¥åˆ›å»ºä¸€ä¸ªç§æœ‰armory\n# å¦åˆ™æŠ¥é”™ï¼šdenied: requested access to the resource is denied\n~]# docker push harbor.od.com/armory/minio:latest\n~]# mkdir -p /data/k8s-yaml/armory/minio\n~]# cd /data/k8s-yaml/armory/minio/\nminio]# vi dp.yaml\nkind: Deployment\napiVersion: extensions/v1beta1\nkind: Deployment\nmetadata:\n  labels:\n    name: minio\n  name: minio\n  namespace: armory\nspec:\n  progressDeadlineSeconds: 600\n  replicas: 1\n  revisionHistoryLimit: 7\n  selector:\n    matchLabels:\n      name: minio\n  template:\n    metadata:\n      labels:\n        app: minio\n        name: minio\n    spec:\n      containers:\n      - name: minio\n        image: harbor.od.com/armory/minio:latest\n        imagePullPolicy: IfNotPresent\n        ports:\n        - containerPort: 9000\n          protocol: TCP\n        args:\n        - server\n        - /data\n        env:\n        - name: MINIO_ACCESS_KEY\n          value: admin\n        - name: MINIO_SECRET_KEY\n          value: admin123\n        readinessProbe:\n          failureThreshold: 3\n          httpGet:\n            path: /minio/health/ready\n            port: 9000\n            scheme: HTTP\n          initialDelaySeconds: 10\n          periodSeconds: 10\n          successThreshold: 1\n          timeoutSeconds: 5\n        volumeMounts:\n        - mountPath: /data\n          name: data\n      imagePullSecrets:\n      - name: harbor\n      volumes:\n      - nfs:\n          server: hdss7-200\n          path: /data/nfs-volume/minio\n        name: data\n\nminio]# vi svc.yaml \napiVersion: v1\nkind: Service\nmetadata:\n  name: minio\n  namespace: armory\nspec:\n  ports:\n  - port: 80\n    protocol: TCP\n    targetPort: 9000\n  selector:\n    app: minio\n\nminio]# vi ingress.yaml \nkind: Ingress\napiVersion: extensions/v1beta1\nmetadata: \n  name: minio\n  namespace: armory\nspec:\n  rules:\n  - host: minio.od.com\n    http:\n      paths:\n      - path: /\n        backend: \n          serviceName: minio\n          servicePort: 80\n\n# åˆ›å»ºå¯¹åº”çš„å­˜å‚¨\nminio]# mkdir /data/nfs-volume/minio\n~~~\n\n\n\n~~~\n# 11æœºå™¨ï¼Œè§£æåŸŸåï¼š\nvi /var/named/od.com.zone\nserial å‰æ»šä¸€ä½\nminio              A    10.4.7.10\n\nsystemctl restart named\ndig -t A minio.od.com +short\n~~~\n\n> ä¸ºä»€ä¹ˆæ¯æ¬¡æ¯æ¬¡éƒ½ä¸ç”¨äº›od.comï¼Œæ˜¯å› ä¸ºç¬¬ä¸€è¡Œæœ‰$ORIGIN od.com. çš„å®æŒ‡ä»¤ï¼Œä¼šè‡ªåŠ¨è¡¥\n\n~~~\n# 22æœºå™¨ï¼š\n# åˆ›å»ºåç§°ç©ºé—´\n~]# kubectl create ns armory\n# å› ä¸ºarmoryä»“åº“æ˜¯ç§æœ‰çš„ï¼Œè¦åˆ›å»ºsecretï¼Œä¸ç„¶æ‹‰ä¸äº†\n~]# kubectl create secret docker-registry harbor --docker-server=harbor.od.com --docker-username=admin --docker-password=Harbor12345 -n armory\n~~~\n\nåœ¨amoryåç§°ç©ºé—´é‡Œé¢å°±èƒ½çœ‹åˆ°\n\n![1583994197390](assets/1583994197390.png)\n\n~~~\n# 22æœºå™¨ï¼Œåº”ç”¨æ¸…å•:\n~]# kubectl apply -f http://k8s-yaml.od.com/armory/minio/dp.yaml\n~]# kubectl apply -f http://k8s-yaml.od.com/armory/minio/svc.yaml\n~]# kubectl apply -f http://k8s-yaml.od.com/armory/minio/ingress.yaml\n~~~\n\n![1583994262819](assets/1583994262819.png)\n\n[minio.od.com](minio.od.com)\n\nè´¦æˆ·ï¼šadmin\n\nå¯†ç ï¼šadmin123\n\n![1583994292679](assets/1583994292679.png)\n\nå®Œæˆ\n\n\n\n### å®‰è£…éƒ¨ç½²redis\n\n~~~\n# 200æœºå™¨ï¼Œå‡†å¤‡é•œåƒã€èµ„æºæ¸…å•ï¼š\n~]# docker pull redis:4.0.14\n~]# docker images|grep redis\n~]# docker tag 6e221e67453d harbor.od.com/armory/redis:v4.0.14\n~]# docker push !$\n~]# mkdir /data/k8s-yaml/armory/redis\n~]# cd /data/k8s-yaml/armory/redis\nredis]# vi dp.yaml\nkind: Deployment\napiVersion: extensions/v1beta1\nkind: Deployment\nmetadata:\n  labels:\n    name: redis\n  name: redis\n  namespace: armory\nspec:\n  replicas: 1\n  revisionHistoryLimit: 7\n  selector:\n    matchLabels:\n      name: redis\n  template:\n    metadata:\n      labels:\n        app: redis\n        name: redis\n    spec:\n      containers:\n      - name: redis\n        image: harbor.od.com/armory/redis:v4.0.14\n        imagePullPolicy: IfNotPresent\n        ports:\n        - containerPort: 6379\n          protocol: TCP\n      imagePullSecrets:\n      - name: harbor\n\nredis]# vi svc.yaml\napiVersion: v1\nkind: Service\nmetadata:\n  name: redis\n  namespace: armory\nspec:\n  ports:\n  - port: 6379\n    protocol: TCP\n    targetPort: 6379\n  selector:\n    app: redis\n\n~~~\n\n\n\n~~~\n# 22æœºå™¨ï¼Œåº”ç”¨èµ„æºæ¸…å•ï¼š\n~]# kubectl apply -f http://k8s-yaml.od.com/armory/redis/dp.yaml\n~]# kubectl apply -f http://k8s-yaml.od.com/armory/redis/svc.yaml\n~~~\n\n> å»çœ‹podå·²ç»èµ·æ¥äº†\n>\n\n~~~\n# çœ‹podçš„ipèµ·åœ¨å“ªé‡Œäº†ï¼Œæˆ‘æ˜¯172.7.22.13ï¼Œ22æœºå™¨ï¼Œç¡®è®¤redisçš„æœåŠ¡èµ·æ¥äº†æ²¡ï¼š\n~]# docker ps -a|grep redis\n~]# telnet 172.7.22.13 6379\n~~~\n\n![1583994842832](assets/1583994842832.png)\n\nå®Œæˆ\n\n\n\n### å®‰è£…éƒ¨ç½²clouddriver\n\n~~~\n# 200æœºå™¨ï¼š\n~]# docker pull docker.io/armory/spinnaker-clouddriver-slim:release-1.8.x-14c9664\n~]# docker images|grep clouddriver\n~]# docker tag edb2507fdb62 harbor.od.com/armory/clouddriver:v1.8.x\n~]# docker push harbor.od.com/armory/clouddriver:v1.8.x\n~]# mkdir /data/k8s-yaml/armory/clouddriver\n~]# cd /data/k8s-yaml/armory/clouddriver/\nclouddriver] vi credentials\n[default]\naws_access_key_id=admin\naws_secret_access_key=admin123\n\n# åšè¯ä¹¦\n~]# cd /opt/certs/\n~]# cp client-csr.json admin-csr.json\n# ä¿®æ”¹ä¸€ä¸‹å†…å®¹\n~]# vi admin-csr.json\n    \"CN\": \"cluster-admin\"\n\n~]# cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=client admin-csr.json | cfssl-json -bare admin\n~~~\n\n![1584005779485](assets/1584005779485.png)\n\n~~~\n# 21æœºå™¨ï¼š\n~]# wget wget http://k8s-yaml.od.com/armory/clouddriver/credentials\n~]# kubectl create secret generic credentials --from-file=./credentials -n armory\n~]# scp hdss7-200:/opt/certs/ca.pem .\n~]# scp hdss7-200:/opt/certs/admin.pem .\n~]# scp hdss7-200:/opt/certs/admin-key.pem .\n\n~]# kubectl config set-cluster myk8s --certificate-authority=./ca.pem --embed-certs=true --server=https://10.4.7.10:7443 --kubeconfig=config\n~]# kubectl config set-credentials cluster-admin --client-certificate=./admin.pem --client-key=./admin-key.pem --embed-certs=true --kubeconfig=config\n~]# kubectl config set-context myk8s-context --cluster=myk8s --user=cluster-admin --kubeconfig=config\n~]# kubectl config use-context myk8s-context --kubeconfig=config\nkubectl create clusterrolebinding myk8s-admin --clusterrole=cluster-admin --user=cluster-admin\n~]# cd /root/.kube/\n.kube]# cp /root/config .\n.kube]# kubectl config view\n.kube]# kubectl get pods -n armory\n~~~\n\n![1584005992328](assets/1584005992328.png)\n\n~~~\n# 200æœºå™¨ï¼š\n~]# mkdir /root/.kube\n~]# cd /root/.kube\n.kube]# scp hdss7-21:/root/config .\n.kube]# cd \n~]# scp hdss7-21:/opt/kubernetes/server/bin/kubectl .\n~]# mv kubectl /usr/bin/\n~]# kubectl config view\n~]# kubectl get pods -n infra\n~~~\n\n![1584006160054](assets/1584006160054.png)\n\n~~~\n# 21æœºå™¨ï¼Œç»™æƒé™ï¼š\n.kube]# mv config default-kubeconfig\n.kube]# kubectl create configmap default-kubeconfig --from-file=./default-kubeconfig -n armory\n~~~\n\n![1584014708599](assets/1584014708599.png)\n\n~~~shell\n# 200æœºå™¨ï¼š\n~]# cd /data/k8s-yaml/armory/clouddriver/\nclouddriver]# vi init-env.yaml\nkind: ConfigMap\napiVersion: v1\nmetadata:\n  name: init-env\n  namespace: armory\ndata:\n  API_HOST: http://spinnaker.od.com/api\n  ARMORY_ID: c02f0781-92f5-4e80-86db-0ba8fe7b8544\n  ARMORYSPINNAKER_CONF_STORE_BUCKET: armory-platform\n  ARMORYSPINNAKER_CONF_STORE_PREFIX: front50\n  ARMORYSPINNAKER_GCS_ENABLED: \"false\"\n  ARMORYSPINNAKER_S3_ENABLED: \"true\"\n  AUTH_ENABLED: \"false\"\n  AWS_REGION: us-east-1\n  BASE_IP: 127.0.0.1\n  CLOUDDRIVER_OPTS: -Dspring.profiles.active=armory,configurator,local\n  CONFIGURATOR_ENABLED: \"false\"\n  DECK_HOST: http://spinnaker.od.com\n  ECHO_OPTS: -Dspring.profiles.active=armory,configurator,local\n  GATE_OPTS: -Dspring.profiles.active=armory,configurator,local\n  IGOR_OPTS: -Dspring.profiles.active=armory,configurator,local\n  PLATFORM_ARCHITECTURE: k8s\n  REDIS_HOST: redis://redis:6379\n  SERVER_ADDRESS: 0.0.0.0\n  SPINNAKER_AWS_DEFAULT_REGION: us-east-1\n  SPINNAKER_AWS_ENABLED: \"false\"\n  SPINNAKER_CONFIG_DIR: /home/spinnaker/config\n  SPINNAKER_GOOGLE_PROJECT_CREDENTIALS_PATH: \"\"\n  SPINNAKER_HOME: /home/spinnaker\n  SPRING_PROFILES_ACTIVE: armory,configurator,local\n\nclouddriver]# vi default-config.yaml\n# è¿™é‡Œçš„å†…å®¹åœ¨å¦å¤–æ”¾çš„default-config.yamlé‡Œï¼Œå› ä¸ºå®åœ¨å¤ªå¤§ï¼Œæ‰€ä»¥æ²¡åŠæ³•å¤åˆ¶è¿›æ¥\n\nclouddriver]# vi custom-config.yaml\nkind: ConfigMap\napiVersion: v1\nmetadata:\n  name: custom-config\n  namespace: armory\ndata:\n  clouddriver-local.yml: |\n    kubernetes:\n      enabled: true\n      accounts:\n        - name: cluster-admin\n          serviceAccount: false\n          dockerRegistries:\n            - accountName: harbor\n              namespace: []\n          namespaces:\n            - test\n            - prod\n          kubeconfigFile: /opt/spinnaker/credentials/custom/default-kubeconfig\n      primaryAccount: cluster-admin\n    dockerRegistry:\n      enabled: true\n      accounts:\n        - name: harbor\n          requiredGroupMembership: []\n          providerVersion: V1\n          insecureRegistry: true\n          address: http://harbor.od.com\n          username: admin\n          password: Harbor12345\n      primaryAccount: harbor\n    artifacts:\n      s3:\n        enabled: true\n        accounts:\n        - name: armory-config-s3-account\n          apiEndpoint: http://minio\n          apiRegion: us-east-1\n      gcs:\n        enabled: false\n        accounts:\n        - name: armory-config-gcs-account\n  custom-config.json: \"\"\n  echo-configurator.yml: |\n    diagnostics:\n      enabled: true\n  front50-local.yml: |\n    spinnaker:\n      s3:\n        endpoint: http://minio\n  igor-local.yml: |\n    jenkins:\n      enabled: true\n      masters:\n        - name: jenkins-admin\n          address: http://jenkins.od.com\n          username: admin\n          password: admin123\n      primaryAccount: jenkins-admin\n  nginx.conf: |\n    gzip on;\n    gzip_types text/plain text/css application/json application/x-javascript text/xml application/xml application/xml+rss text/javascript application/vnd.ms-fontobject application/x-font-ttf font/opentype image/svg+xml image/x-icon;\n\n    server {\n           listen 80;\n\n           location / {\n                proxy_pass http://armory-deck/;\n           }\n\n           location /api/ {\n                proxy_pass http://armory-gate:8084/;\n           }\n\n           rewrite ^/login(.*)$ /api/login$1 last;\n           rewrite ^/auth(.*)$ /api/auth$1 last;\n    }\n  spinnaker-local.yml: |\n    services:\n      igor:\n        enabled: true\n\nclouddriver]# vi dp.yaml\napiVersion: extensions/v1beta1\nkind: Deployment\nmetadata:\n  labels:\n    app: armory-clouddriver\n  name: armory-clouddriver\n  namespace: armory\nspec:\n  replicas: 1\n  revisionHistoryLimit: 7\n  selector:\n    matchLabels:\n      app: armory-clouddriver\n  template:\n    metadata:\n      annotations:\n        artifact.spinnaker.io/location: '\"armory\"'\n        artifact.spinnaker.io/name: '\"armory-clouddriver\"'\n        artifact.spinnaker.io/type: '\"kubernetes/deployment\"'\n        moniker.spinnaker.io/application: '\"armory\"'\n        moniker.spinnaker.io/cluster: '\"clouddriver\"'\n      labels:\n        app: armory-clouddriver\n    spec:\n      containers:\n      - name: armory-clouddriver\n        image: harbor.od.com/armory/clouddriver:v1.8.x\n        imagePullPolicy: IfNotPresent\n        command:\n        - bash\n        - -c\n        args:\n        - bash /opt/spinnaker/config/default/fetch.sh && cd /home/spinnaker/config\n          && /opt/clouddriver/bin/clouddriver\n        ports:\n        - containerPort: 7002\n          protocol: TCP\n        env:\n        - name: JAVA_OPTS\n          value: -Xmx512M\n        envFrom:\n        - configMapRef:\n            name: init-env\n        livenessProbe:\n          failureThreshold: 5\n          httpGet:\n            path: /health\n            port: 7002\n            scheme: HTTP\n          initialDelaySeconds: 600\n          periodSeconds: 3\n          successThreshold: 1\n          timeoutSeconds: 1\n        readinessProbe:\n          failureThreshold: 5\n          httpGet:\n            path: /health\n            port: 7002\n            scheme: HTTP\n          initialDelaySeconds: 180\n          periodSeconds: 3\n          successThreshold: 5\n          timeoutSeconds: 1\n        securityContext: \n          runAsUser: 0\n        volumeMounts:\n        - mountPath: /etc/podinfo\n          name: podinfo\n        - mountPath: /home/spinnaker/.aws\n          name: credentials\n        - mountPath: /opt/spinnaker/credentials/custom\n          name: default-kubeconfig\n        - mountPath: /opt/spinnaker/config/default\n          name: default-config\n        - mountPath: /opt/spinnaker/config/custom\n          name: custom-config\n      imagePullSecrets:\n      - name: harbor\n      volumes:\n      - configMap:\n          defaultMode: 420\n          name: default-kubeconfig\n        name: default-kubeconfig\n      - configMap:\n          defaultMode: 420\n          name: custom-config\n        name: custom-config\n      - configMap:\n          defaultMode: 420\n          name: default-config\n        name: default-config\n      - name: credentials\n        secret:\n          defaultMode: 420\n          secretName: credentials\n      - downwardAPI:\n          defaultMode: 420\n          items:\n          - fieldRef:\n              apiVersion: v1\n              fieldPath: metadata.labels\n            path: labels\n          - fieldRef:\n              apiVersion: v1\n              fieldPath: metadata.annotations\n            path: annotations\n        name: podinfo\n\nclouddriver]# vi svc.yaml\napiVersion: v1\nkind: Service\nmetadata:\n  name: armory-clouddriver\n  namespace: armory\nspec:\n  ports:\n  - port: 7002\n    protocol: TCP\n    targetPort: 7002\n  selector:\n    app: armory-clouddriver\n\nclouddriver]# kubectl apply -f ./init-env.yaml\nclouddriver]# kubectl apply -f ./default-config.yaml\nclouddriver]# kubectl apply -f ./custom-config.yaml\nclouddriver]# kubectl apply -f ./dp.yaml\nclouddriver]# kubectl apply -f ./svc.yaml\n~~~\n\n![1584014649148](assets/1584014649148.png)\n\n![1584015398060](assets/1584015398060.png)\n\n~~~\n# 21æœºå™¨(å› ä¸ºæˆ‘çš„minioåœ¨21æœºå™¨)ï¼š\n.kube]# docker ps -a|grep minio\n.kube]# docker exec -it 9f5592fb2950 /bin/sh\n/ # curl armory-clouddriver:7002/health\n~~~\n\n![1584015549913](assets/1584015549913.png)\n\nå®Œæˆ\n\n\n\n### å®‰è£…éƒ¨ç½²spinnakerå…¶ä½™ç»„ä»¶\n\néƒ¨ç½²æ•°æ®æŒä¹…åŒ–ç»„ä»¶â€”â€”Front50\n\n~~~\n# 200æœºå™¨ï¼š\n~]# docker pull docker.io/armory/spinnaker-front50-slim:release-1.8.x-93febf2\n~]# docker images|grep front50\n~]# docker tag 0d353788f4f2 harbor.od.com/armory/front50:v1.8.x\n~]# docker push harbor.od.com/armory/front50:v1.8.x\n~]# mkdir /data/k8s-yaml/armory/front50\n~]# cd /data/k8s-yaml/armory/front50/\nfront50]# vi dp.yaml\napiVersion: extensions/v1beta1\nkind: Deployment\nmetadata:\n  labels:\n    app: armory-front50\n  name: armory-front50\n  namespace: armory\nspec:\n  replicas: 1\n  revisionHistoryLimit: 7\n  selector:\n    matchLabels:\n      app: armory-front50\n  template:\n    metadata:\n      annotations:\n        artifact.spinnaker.io/location: '\"armory\"'\n        artifact.spinnaker.io/name: '\"armory-front50\"'\n        artifact.spinnaker.io/type: '\"kubernetes/deployment\"'\n        moniker.spinnaker.io/application: '\"armory\"'\n        moniker.spinnaker.io/cluster: '\"front50\"'\n      labels:\n        app: armory-front50\n    spec:\n      containers:\n      - name: armory-front50\n        image: harbor.od.com/armory/front50:v1.8.x\n        imagePullPolicy: IfNotPresent\n        command:\n        - bash\n        - -c\n        args:\n        - bash /opt/spinnaker/config/default/fetch.sh && cd /home/spinnaker/config\n          && /opt/front50/bin/front50\n        ports:\n        - containerPort: 8080\n          protocol: TCP\n        env:\n        - name: JAVA_OPTS\n          value: -javaagent:/opt/front50/lib/jamm-0.2.5.jar -Xmx1000M\n        envFrom:\n        - configMapRef:\n            name: init-env\n        livenessProbe:\n          failureThreshold: 3\n          httpGet:\n            path: /health\n            port: 8080\n            scheme: HTTP\n          initialDelaySeconds: 600\n          periodSeconds: 3\n          successThreshold: 1\n          timeoutSeconds: 1\n        readinessProbe:\n          failureThreshold: 3\n          httpGet:\n            path: /health\n            port: 8080\n            scheme: HTTP\n          initialDelaySeconds: 180\n          periodSeconds: 5\n          successThreshold: 8\n          timeoutSeconds: 1\n        volumeMounts:\n        - mountPath: /etc/podinfo\n          name: podinfo\n        - mountPath: /home/spinnaker/.aws\n          name: credentials\n        - mountPath: /opt/spinnaker/config/default\n          name: default-config\n        - mountPath: /opt/spinnaker/config/custom\n          name: custom-config\n      imagePullSecrets:\n      - name: harbor\n      volumes:\n      - configMap:\n          defaultMode: 420\n          name: custom-config\n        name: custom-config\n      - configMap:\n          defaultMode: 420\n          name: default-config\n        name: default-config\n      - name: credentials\n        secret:\n          defaultMode: 420\n          secretName: credentials\n      - downwardAPI:\n          defaultMode: 420\n          items:\n          - fieldRef:\n              apiVersion: v1\n              fieldPath: metadata.labels\n            path: labels\n          - fieldRef:\n              apiVersion: v1\n              fieldPath: metadata.annotations\n            path: annotations\n        name: podinfo\n\nfront50]# vi svc.yaml\napiVersion: v1\nkind: Service\nmetadata:\n  name: armory-front50\n  namespace: armory\nspec:\n  ports:\n  - port: 8080\n    protocol: TCP\n    targetPort: 8080\n  selector:\n    app: armory-front50\n\nfront50]# kubectl apply -f ./dp.yaml\nfront50]# kubectl apply -f ./svc.yaml\n~~~\n\n![1584023207016](assets/1584023207016.png)\n\n[minio.od.com](minio.od.com)\n\n![1584023230603](assets/1584023230603.png)\n\n#### éƒ¨ç½²ä»»åŠ¡ç¼–æ’ç»„ä»¶â€”â€”Orca\n\n~~~\n# 200æœºå™¨ï¼š\n~]# docker pull docker.io/armory/spinnaker-orca-slim:release-1.8.x-de4ab55\n~]# docker images|grep orca\n~]# docker tag 5103b1f73e04 harbor.od.com/armory/orca:v1.8.x\n~]# docker push harbor.od.com/armory/orca:v1.8.x\n~]# mkdir /data/k8s-yaml/orca\n~]# cd /data/k8s-yaml/orca/\norca]# vi dp.yaml\napiVersion: extensions/v1beta1\nkind: Deployment\nmetadata:\n  labels:\n    app: armory-orca\n  name: armory-orca\n  namespace: armory\nspec:\n  replicas: 1\n  revisionHistoryLimit: 7\n  selector:\n    matchLabels:\n      app: armory-orca\n  template:\n    metadata:\n      annotations:\n        artifact.spinnaker.io/location: '\"armory\"'\n        artifact.spinnaker.io/name: '\"armory-orca\"'\n        artifact.spinnaker.io/type: '\"kubernetes/deployment\"'\n        moniker.spinnaker.io/application: '\"armory\"'\n        moniker.spinnaker.io/cluster: '\"orca\"'\n      labels:\n        app: armory-orca\n    spec:\n      containers:\n      - name: armory-orca\n        image: harbor.od.com/armory/orca:v1.8.x\n        imagePullPolicy: IfNotPresent\n        command:\n        - bash\n        - -c\n        args:\n        - bash /opt/spinnaker/config/default/fetch.sh && cd /home/spinnaker/config\n          && /opt/orca/bin/orca\n        ports:\n        - containerPort: 8083\n          protocol: TCP\n        env:\n        - name: JAVA_OPTS\n          value: -Xmx1000M\n        envFrom:\n        - configMapRef:\n            name: init-env\n        livenessProbe:\n          failureThreshold: 5\n          httpGet:\n            path: /health\n            port: 8083\n            scheme: HTTP\n          initialDelaySeconds: 600\n          periodSeconds: 5\n          successThreshold: 1\n          timeoutSeconds: 1\n        readinessProbe:\n          failureThreshold: 3\n          httpGet:\n            path: /health\n            port: 8083\n            scheme: HTTP\n          initialDelaySeconds: 180\n          periodSeconds: 3\n          successThreshold: 5\n          timeoutSeconds: 1\n        volumeMounts:\n        - mountPath: /etc/podinfo\n          name: podinfo\n        - mountPath: /opt/spinnaker/config/default\n          name: default-config\n        - mountPath: /opt/spinnaker/config/custom\n          name: custom-config\n      imagePullSecrets:\n      - name: harbor\n      volumes:\n      - configMap:\n          defaultMode: 420\n          name: custom-config\n        name: custom-config\n      - configMap:\n          defaultMode: 420\n          name: default-config\n        name: default-config\n      - downwardAPI:\n          defaultMode: 420\n          items:\n          - fieldRef:\n              apiVersion: v1\n              fieldPath: metadata.labels\n            path: labels\n          - fieldRef:\n              apiVersion: v1\n              fieldPath: metadata.annotations\n            path: annotations\n        name: podinfo\n\norca]# vi svc.yaml\napiVersion: v1\nkind: Service\nmetadata:\n  name: armory-orca\n  namespace: armory\nspec:\n  ports:\n  - port: 8083\n    protocol: TCP\n    targetPort: 8083\n  selector:\n    app: armory-orca\n\norca]# kubectl apply -f ./dp.yaml\norca]# kubectl apply -f ./svc.yaml\n~~~\n\n\n\n#### éƒ¨ç½²æ¶ˆæ¯æ€»çº¿ç»„ä»¶â€”â€”Echo\n\n~~~\n# 200æœºå™¨ï¼š\n~]# docker pull docker.io/armory/echo-armory:c36d576-release-1.8.x-617c567\n~]# docker images|grep echo\n~]# docker tag 415efd46f474 harbor.od.com/armory/echo:v1.8.x\n~]# docker push harbor.od.com/armory/echo:v1.8.x\n~]# mkdir /data/k8s-yaml/echo\n~]# cd /data/k8s-yaml/echo/\necho]# vi dp.yaml\napiVersion: extensions/v1beta1\nkind: Deployment\nmetadata:\n  labels:\n    app: armory-echo\n  name: armory-echo\n  namespace: armory\nspec:\n  replicas: 1\n  revisionHistoryLimit: 7\n  selector:\n    matchLabels:\n      app: armory-echo\n  template:\n    metadata:\n      annotations:\n        artifact.spinnaker.io/location: '\"armory\"'\n        artifact.spinnaker.io/name: '\"armory-echo\"'\n        artifact.spinnaker.io/type: '\"kubernetes/deployment\"'\n        moniker.spinnaker.io/application: '\"armory\"'\n        moniker.spinnaker.io/cluster: '\"echo\"'\n      labels:\n        app: armory-echo\n    spec:\n      containers:\n      - name: armory-echo\n        image: harbor.od.com/armory/echo:v1.8.x\n        imagePullPolicy: IfNotPresent\n        command:\n        - bash\n        - -c\n        args:\n        - bash /opt/spinnaker/config/default/fetch.sh && cd /home/spinnaker/config\n          && /opt/echo/bin/echo\n        ports:\n        - containerPort: 8089\n          protocol: TCP\n        env:\n        - name: JAVA_OPTS\n          value: -javaagent:/opt/echo/lib/jamm-0.2.5.jar -Xmx1000M\n        envFrom:\n        - configMapRef:\n            name: init-env\n        livenessProbe:\n          failureThreshold: 3\n          httpGet:\n            path: /health\n            port: 8089\n            scheme: HTTP\n          initialDelaySeconds: 600\n          periodSeconds: 3\n          successThreshold: 1\n          timeoutSeconds: 1\n        readinessProbe:\n          failureThreshold: 3\n          httpGet:\n            path: /health\n            port: 8089\n            scheme: HTTP\n          initialDelaySeconds: 180\n          periodSeconds: 3\n          successThreshold: 5\n          timeoutSeconds: 1\n        volumeMounts:\n        - mountPath: /etc/podinfo\n          name: podinfo\n        - mountPath: /opt/spinnaker/config/default\n          name: default-config\n        - mountPath: /opt/spinnaker/config/custom\n          name: custom-config\n      imagePullSecrets:\n      - name: harbor\n      volumes:\n      - configMap:\n          defaultMode: 420\n          name: custom-config\n        name: custom-config\n      - configMap:\n          defaultMode: 420\n          name: default-config\n        name: default-config\n      - downwardAPI:\n          defaultMode: 420\n          items:\n          - fieldRef:\n              apiVersion: v1\n              fieldPath: metadata.labels\n            path: labels\n          - fieldRef:\n              apiVersion: v1\n              fieldPath: metadata.annotations\n            path: annotations\n        name: podinfo\n\necho]# vi svc.yaml\napiVersion: v1\nkind: Service\nmetadata:\n  name: armory-echo\n  namespace: armory\nspec:\n  ports:\n  - port: 8089\n    protocol: TCP\n    targetPort: 8089\n  selector:\n    app: armory-echo\n\necho]# kubectl apply -f ./dp.yaml\necho]# kubectl apply -f ./svc.yaml\n~~~\n\n#### éƒ¨ç½²æµæ°´çº¿äº¤äº’ç»„ä»¶â€”â€”Igor\n\n~~~~\n# 200æœºå™¨ï¼š\n~]# docker pull docker.io/armory/spinnaker-igor-slim:release-1.8-x-new-install-healthy-ae2b329\n~]# docker images|grep igor\n~]# docker tag 23984f5b43f6 harbor.od.com/armory/igor:v1.8.x\n~]# docker push harbor.od.com/armory/igor:v1.8.x\n~]# mkdir /data/k8s-yaml/igor\n~]# cd /data/k8s-yaml/igor/\nigor]# vi dp.yaml\napiVersion: extensions/v1beta1\nkind: Deployment\nmetadata:\n  labels:\n    app: armory-igor\n  name: armory-igor\n  namespace: armory\nspec:\n  replicas: 1\n  revisionHistoryLimit: 7\n  selector:\n    matchLabels:\n      app: armory-igor\n  template:\n    metadata:\n      annotations:\n        artifact.spinnaker.io/location: '\"armory\"'\n        artifact.spinnaker.io/name: '\"armory-igor\"'\n        artifact.spinnaker.io/type: '\"kubernetes/deployment\"'\n        moniker.spinnaker.io/application: '\"armory\"'\n        moniker.spinnaker.io/cluster: '\"igor\"'\n      labels:\n        app: armory-igor\n    spec:\n      containers:\n      - name: armory-igor\n        image: harbor.od.com/armory/igor:v1.8.x\n        imagePullPolicy: IfNotPresent\n        command:\n        - bash\n        - -c\n        args:\n        - bash /opt/spinnaker/config/default/fetch.sh && cd /home/spinnaker/config\n          && /opt/igor/bin/igor\n        ports:\n        - containerPort: 8088\n          protocol: TCP\n        env:\n        - name: IGOR_PORT_MAPPING\n          value: -8088:8088\n        - name: JAVA_OPTS\n          value: -Xmx1000M\n        envFrom:\n        - configMapRef:\n            name: init-env\n        livenessProbe:\n          failureThreshold: 3\n          httpGet:\n            path: /health\n            port: 8088\n            scheme: HTTP\n          initialDelaySeconds: 600\n          periodSeconds: 3\n          successThreshold: 1\n          timeoutSeconds: 1\n        readinessProbe:\n          failureThreshold: 3\n          httpGet:\n            path: /health\n            port: 8088\n            scheme: HTTP\n          initialDelaySeconds: 180\n          periodSeconds: 5\n          successThreshold: 5\n          timeoutSeconds: 1\n        volumeMounts:\n        - mountPath: /etc/podinfo\n          name: podinfo\n        - mountPath: /opt/spinnaker/config/default\n          name: default-config\n        - mountPath: /opt/spinnaker/config/custom\n          name: custom-config\n      imagePullSecrets:\n      - name: harbor\n      securityContext:\n        runAsUser: 0\n      volumes:\n      - configMap:\n          defaultMode: 420\n          name: custom-config\n        name: custom-config\n      - configMap:\n          defaultMode: 420\n          name: default-config\n        name: default-config\n      - downwardAPI:\n          defaultMode: 420\n          items:\n          - fieldRef:\n              apiVersion: v1\n              fieldPath: metadata.labels\n            path: labels\n          - fieldRef:\n              apiVersion: v1\n              fieldPath: metadata.annotations\n            path: annotations\n        name: podinfo\n\nigor]# vi svc.yaml\napiVersion: v1\nkind: Service\nmetadata:\n  name: armory-igor\n  namespace: armory\nspec:\n  ports:\n  - port: 8088\n    protocol: TCP\n    targetPort: 8088\n  selector:\n    app: armory-igor\n\nigor]# kubectl apply -f ./dp.yaml\nigor]# kubectl apply -f ./svc.yaml\n~~~~\n\n\n\n#### éƒ¨ç½²APIæä¾›ç»„ä»¶â€”â€”Gate\n\n~~~\n# 200æœºå™¨ï¼š\n~]# docker pull docker.io/armory/gate-armory:dfafe73-release-1.8.x-5d505ca\n~]# docker images|grep gate\n~]# docker tag b092d4665301 harbor.od.com/armory/gate:v1.8.x\n~]# docker push harbor.od.com/armory/gate:v1.8.x\n~]# mkdir /data/k8s-yaml/gate\n~]# cd /data/k8s-yaml/gate/\ngate]# vi dp.yaml\napiVersion: extensions/v1beta1\nkind: Deployment\nmetadata:\n  labels:\n    app: armory-gate\n  name: armory-gate\n  namespace: armory\nspec:\n  replicas: 1\n  revisionHistoryLimit: 7\n  selector:\n    matchLabels:\n      app: armory-gate\n  template:\n    metadata:\n      annotations:\n        artifact.spinnaker.io/location: '\"armory\"'\n        artifact.spinnaker.io/name: '\"armory-gate\"'\n        artifact.spinnaker.io/type: '\"kubernetes/deployment\"'\n        moniker.spinnaker.io/application: '\"armory\"'\n        moniker.spinnaker.io/cluster: '\"gate\"'\n      labels:\n        app: armory-gate\n    spec:\n      containers:\n      - name: armory-gate\n        image: harbor.od.com/armory/gate:v1.8.x\n        imagePullPolicy: IfNotPresent\n        command:\n        - bash\n        - -c\n        args:\n        - bash /opt/spinnaker/config/default/fetch.sh gate && cd /home/spinnaker/config\n          && /opt/gate/bin/gate\n        ports:\n        - containerPort: 8084\n          name: gate-port\n          protocol: TCP\n        - containerPort: 8085\n          name: gate-api-port\n          protocol: TCP\n        env:\n        - name: GATE_PORT_MAPPING\n          value: -8084:8084\n        - name: GATE_API_PORT_MAPPING\n          value: -8085:8085\n        - name: JAVA_OPTS\n          value: -Xmx1000M\n        envFrom:\n        - configMapRef:\n            name: init-env\n        livenessProbe:\n          exec:\n            command:\n            - /bin/bash\n            - -c\n            - wget -O - http://localhost:8084/health || wget -O - https://localhost:8084/health\n          failureThreshold: 5\n          initialDelaySeconds: 600\n          periodSeconds: 5\n          successThreshold: 1\n          timeoutSeconds: 1\n        readinessProbe:\n          exec:\n            command:\n            - /bin/bash\n            - -c\n            - wget -O - http://localhost:8084/health?checkDownstreamServices=true&downstreamServices=true\n              || wget -O - https://localhost:8084/health?checkDownstreamServices=true&downstreamServices=true\n          failureThreshold: 3\n          initialDelaySeconds: 180\n          periodSeconds: 5\n          successThreshold: 10\n          timeoutSeconds: 1\n        volumeMounts:\n        - mountPath: /etc/podinfo\n          name: podinfo\n        - mountPath: /opt/spinnaker/config/default\n          name: default-config\n        - mountPath: /opt/spinnaker/config/custom\n          name: custom-config\n      imagePullSecrets:\n      - name: harbor\n      securityContext:\n        runAsUser: 0\n      volumes:\n      - configMap:\n          defaultMode: 420\n          name: custom-config\n        name: custom-config\n      - configMap:\n          defaultMode: 420\n          name: default-config\n        name: default-config\n      - downwardAPI:\n          defaultMode: 420\n          items:\n          - fieldRef:\n              apiVersion: v1\n              fieldPath: metadata.labels\n            path: labels\n          - fieldRef:\n              apiVersion: v1\n              fieldPath: metadata.annotations\n            path: annotations\n        name: podinfo\n\ngate]# vi svc.yaml\napiVersion: v1\nkind: Service\nmetadata:\n  name: armory-gate\n  namespace: armory\nspec:\n  ports:\n  - name: gate-port\n    port: 8084\n    protocol: TCP\n    targetPort: 8084\n  - name: gate-api-port\n    port: 8085\n    protocol: TCP\n    targetPort: 8085\n  selector:\n    app: armory-gate\n\ngate]# kubectl apply -f ./dp.yaml\ngate]# kubectl apply -f ./svc.yaml\n~~~\n\n![1584023952250](assets/1584023952250.png)\n\n5ä¸ª\n\n#### éƒ¨ç½²å‰ç«¯ç½‘é¡µé¡¹ç›®â€”â€”Deck\n\n~~~\n# 200æœºå™¨ï¼š\n~]# docker pull docker.io/armory/deck-armory:d4bf0cf-release-1.8.x-0a33f94\n~]# docker images|grep deck\n~]# docker tag 9a87ba3b319f harbor.od.com/armory/deck:v1.8.x\n~]# docker push harbor.od.com/armory/deck:v1.8.x\n~]# mkdir /data/k8s-yaml/deck\n~]# cd /data/k8s-yaml/deck/\ndeck]# vi dp.yaml\napiVersion: extensions/v1beta1\nkind: Deployment\nmetadata:\n  labels:\n    app: armory-deck\n  name: armory-deck\n  namespace: armory\nspec:\n  replicas: 1\n  revisionHistoryLimit: 7\n  selector:\n    matchLabels:\n      app: armory-deck\n  template:\n    metadata:\n      annotations:\n        artifact.spinnaker.io/location: '\"armory\"'\n        artifact.spinnaker.io/name: '\"armory-deck\"'\n        artifact.spinnaker.io/type: '\"kubernetes/deployment\"'\n        moniker.spinnaker.io/application: '\"armory\"'\n        moniker.spinnaker.io/cluster: '\"deck\"'\n      labels:\n        app: armory-deck\n    spec:\n      containers:\n      - name: armory-deck\n        image: harbor.od.com/armory/deck:v1.8.x\n        imagePullPolicy: IfNotPresent\n        command:\n        - bash\n        - -c\n        args:\n        - bash /opt/spinnaker/config/default/fetch.sh && /entrypoint.sh\n        ports:\n        - containerPort: 9000\n          protocol: TCP\n        envFrom:\n        - configMapRef:\n            name: init-env\n        livenessProbe:\n          failureThreshold: 3\n          httpGet:\n            path: /\n            port: 9000\n            scheme: HTTP\n          initialDelaySeconds: 180\n          periodSeconds: 3\n          successThreshold: 1\n          timeoutSeconds: 1\n        readinessProbe:\n          failureThreshold: 5\n          httpGet:\n            path: /\n            port: 9000\n            scheme: HTTP\n          initialDelaySeconds: 30\n          periodSeconds: 3\n          successThreshold: 5\n          timeoutSeconds: 1\n        volumeMounts:\n        - mountPath: /etc/podinfo\n          name: podinfo\n        - mountPath: /opt/spinnaker/config/default\n          name: default-config\n        - mountPath: /opt/spinnaker/config/custom\n          name: custom-config\n      imagePullSecrets:\n      - name: harbor\n      volumes:\n      - configMap:\n          defaultMode: 420\n          name: custom-config\n        name: custom-config\n      - configMap:\n          defaultMode: 420\n          name: default-config\n        name: default-config\n      - downwardAPI:\n          defaultMode: 420\n          items:\n          - fieldRef:\n              apiVersion: v1\n              fieldPath: metadata.labels\n            path: labels\n          - fieldRef:\n              apiVersion: v1\n              fieldPath: metadata.annotations\n            path: annotations\n        name: podinfo\n\ndeck]# vi svc.yaml\napiVersion: v1\nkind: Service\nmetadata:\n  name: armory-deck\n  namespace: armory\nspec:\n  ports:\n  - port: 80\n    protocol: TCP\n    targetPort: 9000\n  selector:\n    app: armory-deck\n\ndeck]# kubectl apply -f ./dp.yaml\ndeck]# kubectl apply -f ./svc.yaml\n~~~\n\n#### éƒ¨ç½²å‰ç«¯ä»£ç†â€”â€”Nginx\n\n~~~\n# 200æœºå™¨ï¼š\n~]# docker pull nginx:1.12.2\n~]# docker images|grep nginx\n~]# docker tag 4037a5562b03 harbor.od.com/armory/nginx:v1.12.2\n~]# docker push harbor.od.com/armory/nginx:v1.12.2\n~]# mkdir /data/k8s-yaml/nginx\n~]# cd /data/k8s-yaml/nginx/\nnginx]# vi dp.yaml\napiVersion: extensions/v1beta1\nkind: Deployment\nmetadata:\n  labels:\n    app: armory-nginx\n  name: armory-nginx\n  namespace: armory\nspec:\n  replicas: 1\n  revisionHistoryLimit: 7\n  selector:\n    matchLabels:\n      app: armory-nginx\n  template:\n    metadata:\n      annotations:\n        artifact.spinnaker.io/location: '\"armory\"'\n        artifact.spinnaker.io/name: '\"armory-nginx\"'\n        artifact.spinnaker.io/type: '\"kubernetes/deployment\"'\n        moniker.spinnaker.io/application: '\"armory\"'\n        moniker.spinnaker.io/cluster: '\"nginx\"'\n      labels:\n        app: armory-nginx\n    spec:\n      containers:\n      - name: armory-nginx\n        image: harbor.od.com/armory/nginx:v1.12.2\n        imagePullPolicy: Always\n        command:\n        - bash\n        - -c\n        args:\n        - bash /opt/spinnaker/config/default/fetch.sh nginx && nginx -g 'daemon off;'\n        ports:\n        - containerPort: 80\n          name: http\n          protocol: TCP\n        - containerPort: 443\n          name: https\n          protocol: TCP\n        - containerPort: 8085\n          name: api\n          protocol: TCP\n        livenessProbe:\n          failureThreshold: 3\n          httpGet:\n            path: /\n            port: 80\n            scheme: HTTP\n          initialDelaySeconds: 180\n          periodSeconds: 3\n          successThreshold: 1\n          timeoutSeconds: 1\n        readinessProbe:\n          failureThreshold: 3\n          httpGet:\n            path: /\n            port: 80\n            scheme: HTTP\n          initialDelaySeconds: 30\n          periodSeconds: 3\n          successThreshold: 5\n          timeoutSeconds: 1\n        volumeMounts:\n        - mountPath: /opt/spinnaker/config/default\n          name: default-config\n        - mountPath: /etc/nginx/conf.d\n          name: custom-config\n      imagePullSecrets:\n      - name: harbor\n      volumes:\n      - configMap:\n          defaultMode: 420\n          name: custom-config\n        name: custom-config\n      - configMap:\n          defaultMode: 420\n          name: default-config\n        name: default-config\n\nnginx]# vi svc.yaml\napiVersion: v1\nkind: Service\nmetadata:\n  name: armory-nginx\n  namespace: armory\nspec:\n  ports:\n  - name: http\n    port: 80\n    protocol: TCP\n    targetPort: 80\n  - name: https\n    port: 443\n    protocol: TCP\n    targetPort: 443\n  - name: api\n    port: 8085\n    protocol: TCP\n    targetPort: 8085\n  selector:\n    app: armory-nginx\n\nnginx]# vi ingress.yaml\napiVersion: extensions/v1beta1\nkind: Ingress\nmetadata:\n  labels:\n    app: spinnaker\n    web: spinnaker.od.com\n  name: armory-nginx\n  namespace: armory\nspec:\n  rules:\n  - host: spinnaker.od.com\n    http:\n      paths:\n      - backend:\n          serviceName: armory-nginx\n          servicePort: 80\n~~~\n\n\n\n~~~\n# 11æœºå™¨ï¼Œè§£æåŸŸåï¼š\n~]# vi /var/named/od.com.zone\nserial å‰æ»šä¸€ä½\nspinnaker          A    10.4.7.10\n\n~]# systemctl restart named\n~]# dig -t A spinnaker.od.com +short\n#out: 10.4.7.10 \n~~~\n\n![1581925138470](assets/1581925138470.png)\n\n~~~\n# 200æœºå™¨ï¼Œåº”ç”¨èµ„æºæ¸…å•ï¼š\nnginx]# kubectl apply -f ./dp.yaml\nnginx]# kubectl apply -f ./svc.yaml\nnginx]# kubectl apply -f ./ingress.yaml\n~~~\n\n![1584024475469](assets/1584024475469.png)\n\n[spinnaker.od.com](spinnaker.od.com)\n\n![1584024561816](assets/1584024561816.png)\n\nå®Œæˆ\n\n\n\n### ä½¿ç”¨spinnakerç»“åˆJenkinsæ„å»ºé•œåƒ\n\næŠŠtestå’Œprodé‡Œçš„deploymentçš„dubboåˆ æ‰ï¼Œç»“æœå¦‚å›¾\n\n![1584024722628](assets/1584024722628.png)\n\n![1584024764124](assets/1584024764124.png)\n\nåˆ å®Œ\n\n\n\nè¿™æ—¶å€™spinnakerå·²ç»æ²¡äº†dubboäº†ï¼Œæˆ‘ä»¬åˆ›å»º\n\n![1584024817000](assets/1584024817000.png)\n\n![1584057829023](assets/1584057829023.png)\n\nåˆ·æ–°spinnakerï¼Œç‚¹è¿›å»ï¼Œå¦‚æœé¡µé¢æŠ–åŠ¨çš„å¯ä»¥è°ƒæˆ125æ¯”ä¾‹\n\næŸ¥çœ‹minio\n\n![1584058052650](assets/1584058052650.png)\n\nåˆ¶ä½œæµæ°´çº¿\n\n![1584058085990](assets/1584058085990.png)\n\n![1584058106075](assets/1584058106075.png)\n\n> å…ˆåˆ¶ä½œservice\n\næ·»åŠ 4ä¸ªå‚æ•°\n\n![1584058190590](assets/1584058190590.png)\n\n![1584058342950](assets/1584058342950.png)\n\n> ç‰ˆæœ¬å·ã€åˆ†æ”¯ã€commitID\n\n![1585354175145](assets/1585354175145.png)\n\n> æ ‡ç­¾ç­‰\n\n![1584058243942](assets/1584058243942.png)\n\n> åå­—\n\n![1584058287708](assets/1584058287708.png)\n\n> ä»“åº“å\n\n![1584058477180](assets/1584058477180.png)\n\n> ä¿å­˜åå¢åŠ ä¸€ä¸ªæµæ°´çº¿çš„é˜¶æ®µ\n\n![1584058493370](assets/1584058493370.png)\n\n![1584058537386](assets/1584058537386.png)\n\n> å¯ä»¥çœ‹åˆ°Jenkinså·²ç»è¢«åŠ è½½è¿›æ¥äº†ï¼Œä¸‹é¢çš„å‚æ•°åŒ–æ„å»ºçš„é€‰é¡¹ä¹Ÿè¢«åŠ è½½è¿›æ¥äº†\n\n~~~\n# å¡«å…¥å¯¹åº”å‚æ•°ï¼Œä¸‹é¢ä¸èƒ½å¤åˆ¶ç²˜è´´\n~~~\n\n![1584058979741](assets/1584058979741.png)\n\n> å»ºå¥½äº†ï¼Œè¿è¡Œ\n>\n\n![1584059021370](assets/1584059021370.png)\n\n![1584059050225](assets/1584059050225.png)\n\n> ç‚¹å‡»Detailsï¼Œç„¶åä¸‹æ‹‰å¯ä»¥çœ‹åˆ°#9ï¼Œç„¶åç‚¹è¿›å»\n>\n\n![1584063826998](assets/1584063826998.png)\n\n> è¿è¡Œä¸­æ˜¾ç¤ºè“æ¡ã€æˆåŠŸæ˜¯ç»¿æ¡ã€å¤±è´¥æ˜¯çº¢æ¡\n\n![1584063848587](assets/1584063848587.png)\n\n> è·³è½¬åˆ°Jenkinsäº†\n>\n\n![1584063864144](assets/1584063864144.png)\n\n> å®Œæˆåå»çœ‹harbor\n>\n\n![1584064090529](assets/1584064090529.png)\n\nåœ¨å…¬å¸ï¼Œæ–°ä¸Šé¡¹ç›®æŠ•äº§åªéœ€è¦è¿™æ ·ç‚¹ç‚¹ç‚¹å³å¯ã€‚\n\n\n\n### ä½¿ç”¨spinnakeré…ç½®dubboæœåŠ¡æä¾›è€…å‘å¸ƒè‡³K8S\n\n![1584064188189](assets/1584064188189.png)\n\n> å¼€å§‹åˆ¶ä½œdeploymentï¼Œä¹‹å‰æˆ‘ä»¬æ˜¯ç”¨yamlæ–‡æœ¬ï¼Œç°åœ¨æˆ‘ä»¬åªè¦ç‚¹ç‚¹ç‚¹\n\n![1584064212691](assets/1584064212691.png)\n\n![1584064339967](assets/1584064339967.png)\n\n> Accontï¼šè´¦æˆ·ï¼ˆé€‰æ‹©é›†ç¾¤ç®¡ç†å‘˜ï¼‰\n>\n> Namespaceï¼šæ‰€å‘å¸ƒçš„åç§°ç©ºé—´\n>\n> Detailï¼šé¡¹ç›®åå­—ï¼Œè¦å’Œgitçš„ä¿æŒä¸€è‡´\n>\n> Containersï¼šè¦ç”¨é‚£ä¸ªé•œåƒï¼Œä»harboré‡Œé€‰\n>\n> å¯¹å‡†é—®å·ä¼šæœ‰æ³¨é‡Š\n\n![1584064378399](assets/1584064378399.png)\n\n> Strategyï¼šå‘å¸ƒç­–ç•¥ï¼Œé€‰æ‹©æ»šåŠ¨å‡çº§ï¼Œè¿˜æœ‰ä¸ªå°±æ˜¯é‡æ–°æ„å»º\n\n![1584064490029](assets/1584064490029.png)\n\n> æŒ‚è½½æ—¥å¿—\n\n![1584065127079](assets/1584065127079.png)\n\n> è¦è¿æ¥åˆ°Prometheusçš„è®¾ç½®\n\n![1584065253695](assets/1584065253695.png)\n\n200æœºå™¨ï¼š cat /data/k8s-yaml/test/dubbo-demo-service/dp.yamlï¼Œå¤åˆ¶æŒ‡å®šValueå†…å®¹å¡«å…¥Value\n\n![1584065443152](assets/1584065443152.png)\n\n![1584065496089](assets/1584065496089.png)\n\n> ä¼ å…¥ç¯å¢ƒå˜é‡ï¼šä¸€ä¸ªæ˜¯JARã€ä¸€ä¸ªæ˜¯Apollo\n\n![1584065532833](assets/1584065532833.png)\n\n> æ§åˆ¶èµ„æºå¤§å°\n\n![1584065559311](assets/1584065559311.png)\n\n> æŒ‚è½½æ—¥å¿—\n\n![1584065607642](assets/1584065607642.png)\n\n> å°±ç»ªæ€§æ¢é’ˆï¼š\n>\n> â€‹\tæµ‹è¯•ç«¯å£ï¼š20880\n\n![1584065630673](assets/1584065630673.png)\n\n\n\n> æ‹¿ä»€ä¹ˆç”¨æˆ·å»æ‰§è¡Œ\n\nå¡«å†™ç¬¬äºŒä¸ªcontainerï¼Œé…filebeat\n\n![1584065690268](assets/1584065690268.png)\n\n![1584066057307](assets/1584066057307.png)\n\n![1584066134675](assets/1584066134675.png)\n\nä¿®æ”¹åº•åŒ…\n\n![1584068096613](assets/1584068096613.png)\n\n![1584068118456](assets/1584068118456.png)\n\næ›´æ”¹ç‰ˆæœ¬ï¼Œç‚¹è¿™é‡Œ\n\n![1584066764236](assets/1584066764236.png)\n\nç„¶åå†è¿™é‡Œä¿®æ”¹ä¸€äº›å†…å®¹\n\n~~~\n\"imageId\": \"harbor.od.com/${parameters.image_name}:${parameters.git_ver}_${parameters.add_tag}\",\n\"registry\": \"harbor.od.com\",\n\"repository\": \"${parameters.image_name}\",\n\"tag\": \"${parameters.git_ver}_${parameters.add_tag}\"\n~~~\n\n![1584066809117](assets/1584066809117.png)\n\n![1584066841074](assets/1584066841074.png)\n\n![1584066869312](assets/1584066869312.png)\n\nç„¶åupdateå¹¶save\n\n![1584066908437](assets/1584066908437.png)\n\n![1584066931500](assets/1584066931500.png)\n\n![1584067032466](assets/1584067032466.png)\n\n![1584067042410](assets/1584067042410.png)\n\nç¬¬ä¸€é˜¶æ®µå®Œæˆåå°±å¼€å§‹ç¬¬äºŒé˜¶æ®µ\n\n![1584067152277](assets/1584067152277.png)\n\n![1584067170255](assets/1584067170255.png)\n\nå…¨éƒ¨å®Œæˆåï¼ŒæŸ¥çœ‹K8S\n\n![1584067199269](assets/1584067199269.png)\n\n![1584067285901](assets/1584067285901.png)\n\n~~~\n# 22æœºå™¨\n~]# docker ps -a|grep dubbo-demo-service\n~]# docker exec -ti 0f46cfc60e82 bash\n#/ cd /logm\n#/ ls\n#/ cat stdout.log\n~~~\n\n![1584068666418](assets/1584068666418.png)\n\næœ‰æ—¥å¿—äº†\n\n\n\næŸ¥çœ‹kibanaçš„æ—¥å¿—\n\n![1584068537962](assets/1584068537962.png)\n\n![1584068699067](assets/1584068699067.png)\n\nå®Œæˆï¼ˆPSï¼šlogæ—¥å¿—å»åˆ°esé‡Œä¹Ÿéœ€è¦æ—¶é—´ï¼Œæˆ‘ç­‰äº†å¤§çº¦ä¸¤åˆ†é’Ÿï¼‰\n\n\n\n### ä½¿ç”¨spinnakeré…ç½®dubboæœåŠ¡æ¶ˆè´¹è€…åˆ°K8S\n\nåˆ›å»ºæµæ°´çº¿\n\n![1584078407553](assets/1584078407553.png)\n\n![1584078439769](assets/1584078439769.png)\n\n![1584078491859](assets/1584078491859.png)\n\n![1584078517624](assets/1584078517624.png)\n\n![1584078573644](assets/1584078573644.png)\n\n![1584078612786](assets/1584078612786.png)\n\n![1584078672019](assets/1584078672019.png)\n\n![1584083114651](assets/1584083114651.png)\n\nå…ˆåˆ¶ä½œé•œåƒï¼Œçœ‹æœ‰æ²¡æœ‰é—®é¢˜\n\n![1584079045516](assets/1584079045516.png)\n\n![1584079077761](assets/1584079077761.png)\n\nå»çœ‹ä¸€ä¸‹Jenkinsèƒ½ä¸èƒ½æ‰“åŒ…\n\n![1584079104250](assets/1584079104250.png)\n\n![1584079120220](assets/1584079120220.png)\n\nsuccesså\n\nç°åœ¨ç›¸å½“äºå·²ç»é…äº†dp.yamlï¼Œè¿™æ˜¯webé¡¹ç›®ï¼Œæ‰€ä»¥è¿˜è¦é…svcå’Œingress\n\n![1584079151477](assets/1584079151477.png)\n\n![1584079186625](assets/1584079186625.png)\n\n![1584079823806](assets/1584079823806.png)\n\n![1584079256815](assets/1584079256815.png)\n\n![1584079884058](assets/1584079884058.png)\n\nè¿™æ—¶å€™å·²ç»K8Sé‡Œå·²ç»æœ‰svcï¼ˆæˆ‘æŠŠåŸæ¥çš„åˆ æ‰äº†ï¼‰\n\n![1584079910637](assets/1584079910637.png)\n\nä»¥å‰çš„ingressæˆ‘ä¹Ÿé¡ºä¾¿åˆ äº†\n\n![1584079645933](assets/1584079645933.png)\n\nåšå®Œsvcè¿˜æœ‰ingress\n\n![1584079330070](assets/1584079330070.png)\n\n![1584079347814](assets/1584079347814.png)\n\n![1584080007523](assets/1584080007523.png)\n\nå»K8Sé‡Œçœ‹\n\n![1584080082818](assets/1584080082818.png)\n\nç„¶åç»§ç»­\n\n![1584080109009](assets/1584080109009.png)\n\n![1584080129596](assets/1584080129596.png)\n\n![1584080169008](assets/1584080169008.png)\n\n![1584083845728](assets/1584083845728.png)\n\n> ç¼–å·å¯èƒ½ä¸åŒï¼Œå› ä¸ºæˆ‘é‡æ–°åšäº†ä¸€ç‰ˆtomcatï¼Œä½†æ˜¯æ— æ‰€è°“ï¼Œåé¢æˆ‘ä»¬éƒ½ä¼šç”¨å˜é‡å¼„\n\n![1584080263076](assets/1584080263076.png)\n\n![1584083914202](assets/1584083914202.png)\n\n![1584080330316](assets/1584080330316.png)\n\n![1584080535614](assets/1584080535614.png)\n\nç¬¬äºŒä¸ªcontainer\n\nåŒæ ·200æœºå™¨å»æ‹¿é‚£æ®µ\n\n![1584081101719](assets/1584081101719.png)\n\n![1584081175808](assets/1584081175808.png)\n\nç¬¬ä¸‰ä¸ªcontainer\n\n![1584081304018](assets/1584081304018.png)\n\n![1584081338810](assets/1584081338810.png)\n\n![1584081381128](assets/1584081381128.png)\n\n![1584081394888](assets/1584081394888.png)\n\n~~~\n\"imageId\": \"harbor.od.com/${parameters.image_name}:${parameters.git_ver}_${parameters.add_tag}\",\n\"registry\": \"harbor.od.com\",\n\"repository\": \"${parameters.image_name}\",\n\"tag\": \"${parameters.git_ver}_${parameters.add_tag}\"\n~~~\n\n![1584081434175](assets/1584081434175.png)\n\nupdate\n\n![1584081462543](assets/1584081462543.png)\n\né¦–å…ˆï¼Œç½‘å€æ˜¯æ²¡æœ‰å†…å®¹çš„\n\n![1584081529356](assets/1584081529356.png)\n\n![1584081486194](assets/1584081486194.png)\n\nç»§ç»­æ„å»º\n\n![1584081573772](assets/1584081573772.png)\n\n![1584081698091](assets/1584081698091.png)\n\n> å¯ä»¥çœ‹åˆ°åªèŠ±äº†ä¸¤åˆ†é’Ÿä¸åˆ°\n\næŸ¥çœ‹K8Sé‡Œé¢èµ·æ¥äº†æ²¡æœ‰\n\n![1584081739090](assets/1584081739090.png)\n\nç„¶åå†åˆ·æ–°é¡µé¢\n\n![1584084336732](assets/1584084336732.png)\n\næµ‹è¯•é¡µé¢æ­£å¸¸ï¼Œå»kibanaï¼ˆç­‰æ•°æ®è¿‡æ¥åˆæ˜¯æ¼«é•¿çš„è¿‡ç¨‹ï¼‰\n\n![1584084381158](assets/1584084381158.png)\n\n![1584084728950](assets/1584084728950.png)\n\nå®Œæˆ\n\n\n\n### æ¨¡æ‹Ÿç”Ÿäº§ä¸Šä»£ç è¿­ä»£\n\nè¿™é‡Œæˆ‘å°±ç›´æ¥ç”¨gitlabï¼Œä½ ç”¨è‡ªå·±çš„gitå³å¯ï¼Œtomcatåˆ†æ”¯ï¼ˆ`dubbo-client/src/main/java/com/od/dubbotest/action/HelloAction.java`ï¼‰\n\n![1584085399503](assets/1584085399503.png)\n\nå¤åˆ¶id\n\n![1584085534421](assets/1584085534421.png)\n\n![1584085463078](assets/1584085463078.png)\n\n![1584085573303](assets/1584085573303.png)\n\n![1584085726806](assets/1584085726806.png)\n\nå®Œæˆååˆ·æ–°é¡µé¢\n\n![1584085742862](assets/1584085742862.png)\n\n> ç‰ˆæœ¬æ›´æ–°ä½ æœ€éœ€è¦ç‚¹è¿™ä¹ˆå‡ ä¸‹å°±å¯ä»¥äº†ï¼Œå…¨ç¨‹ç”¨ä¸åˆ°1åˆ†é’Ÿ\n\nç¡®è®¤ä¸€è‡´ï¼Œå¯ä»¥ä¸Šçº¿äº†\n\n![1584085802694](assets/1584085802694.png)\n\n![1584085844657](assets/1584085844657.png)\n\n![1584085871848](assets/1584085871848.png)\n\n![1584085899129](assets/1584085899129.png)\n\n![1584085940886](assets/1584085940886.png)\n\n![1584085965431](assets/1584085965431.png)\n\n![1584086000580](assets/1584086000580.png)\n\n![1584086046821](assets/1584086046821.png)\n\n![1584086075157](assets/1584086075157.png)\n\n![1584086138413](assets/1584086138413.png)\n\n![1584086157826](assets/1584086157826.png)\n\n![1584086175983](assets/1584086175983.png)\n\n![1584086277429](assets/1584086277429.png)\n\nç¬¬äºŒä¸ªcontainer\n\nåŒæ ·çš„æ–¹æ³•å»æ‹¿valueï¼šcat /data/k8s-yaml/prod/dubbo-demo-service/dp.yaml\n\n![1584086436864](assets/1584086436864.png)\n\n![1584086463792](assets/1584086463792.png)\n\nç¬¬ä¸‰ä¸ªcontainer\n\n![1584086522123](assets/1584086522123.png)\n\n![1584086550684](assets/1584086550684.png)\n\n\n\n![1584086871253](assets/1584086871253.png)\n\n~~~\n# æ·»åŠ ä»¥ä¸‹å†…å®¹\n\"imageId\": \"harbor.od.com/${parameters.image_name}:${parameters.git_ver}_${parameters.add_tag}\",\n\"registry\": \"harbor.od.com\",\n\"repository\": \"${parameters.image_name}\",\n\"tag\": \"${parameters.git_ver}_${parameters.add_tag}\"\n~~~\n\n![1584086852397](assets/1584086852397.png)\n\n![1584086900158](assets/1584086900158.png)\n\nçœ‹ä¸€ä¸‹å“ªä¸ªç‰ˆæœ¬é€šè¿‡æµ‹è¯•äº†\n\n![1584086932887](assets/1584086932887.png)\n\nå¤åˆ¶\n\n![1584086963769](assets/1584086963769.png)\n\n![1584087001949](assets/1584087001949.png)\n\n![1584087023343](assets/1584087023343.png)\n\n![1584087116902](assets/1584087116902.png)\n\nèµ·æ¥äº†ï¼Œæˆ‘ä»¬æŠŠprodç¯å¢ƒé‡Œé¢çš„serviceå’Œingressçš„consumerå¹²æ‰\n\n![1584087185801](assets/1584087185801.png)\n\n![1584087200129](assets/1584087200129.png)\n\nå¼€å§‹åˆ¶ä½œservices\n\n![1584087239935](assets/1584087239935.png)\n\n![1584087255667](assets/1584087255667.png)\n\n![1584087279759](assets/1584087279759.png)\n\nå†å»åšingress\n\n![1584087808345](assets/1584087808345.png)\n\n![1584087822173](assets/1584087822173.png)\n\ningressä¹Ÿå¥½äº†\n\nè·‘èµ·æ¥ï¼ˆå…¶å®å°±è·Ÿtestä¸€æ ·ï¼‰\n\n![1584088360303](assets/1584088360303.png)\n\n![1584088366782](assets/1584088366782.png)\n\n![1584088379944](assets/1584088379944.png)![1584088384747](assets/1584088384747.png)\n\n![1584088390258](assets/1584088390258.png)\n\n![1584088394971](assets/1584088394971.png)\n\n![1584088400134](assets/1584088400134.png)\n\n![1584088403965](assets/1584088403965.png)\n\nç¬¬äºŒä¸ªcontainer\n\n![1584089282070](assets/1584089282070.png)\n\n![1584089287727](assets/1584089287727.png)\n\n![1584089291709](assets/1584089291709.png)\n\n![1584089303135](assets/1584089303135.png)\n\n![1584089307606](assets/1584089307606.png)\n\n![1584089311723](assets/1584089311723.png)\n\nè¿™ä¸‹é¢çš„ä¿¡æ¯æ˜¯ç”¨testçš„ä¿¡æ¯ï¼Œå› ä¸ºtestå·²ç»æµ‹è¯•è¿‡æ²¡é—®é¢˜äº†\n\n![1584089319292](assets/1584089319292.png)\n\n![1584089345632](assets/1584089345632.png)\n\n![1584089352491](assets/1584089352491.png)\n\nä¼šæç¤ºæ›¿ä»£webï¼Œä¸åŒç®¡ï¼ŒRUN\n\n![1584089265210](assets/1584089265210.png)\n\næˆåŠŸ\n\nå½“ç„¶ä½ å¯èƒ½æ‹…å¿ƒtestçš„webçœŸçš„è¢«æ›¿ä»£äº†ï¼Œå¯ä»¥çœ‹ä¸€ä¸‹\n\n![1584089405816](assets/1584089405816.png)\n\nä¹Ÿæ˜¯æ²¡é—®é¢˜çš„ï¼Œæˆ‘ä»¬å†çœ‹ä¸‹kibanaæœ‰æ²¡æœ‰æ•°æ®\n\n![1584089444787](assets/1584089444787.png)\n\nä¹Ÿæœ‰\n\n### æ­å–œä½ ï¼Œé¡ºåˆ©æ¯•ä¸šï¼\n\n"
        },
        {
          "name": "ç¬¬å…­ç« â€”â€”åœ¨K8Sä¸­é›†æˆApolloé…ç½®ä¸­å¿ƒ.md",
          "type": "blob",
          "size": 63.1181640625,
          "content": "## ç¬¬å…­ç« â€”â€”åœ¨K8Sä¸­é›†æˆApolloé…ç½®ä¸­å¿ƒ\n\n> **å‰è¨€**ï¼š\n>\n> **è¿ç»´å…«è£å…«è€»**ï¼š\n>\n> - ä»¥å¯é…ç½®ä¸ºè£ï¼Œä»¥ç¡¬ç¼–ç ä¸ºè€»\n> - ä»¥äº’å¤‡ä¸ºè£ï¼Œä»¥å•ç‚¹ä¸ºè€»\n> - ä»¥éšæ—¶é‡å¯ä¸ºè£ï¼Œä»¥ä¸èƒ½è¿ç§»ä¸ºè€»\n> - ä»¥æ•´ä½“äº¤ä»˜ä¸ºè£ï¼Œä»¥éƒ¨åˆ†äº¤ä»˜ä¸ºè€»\n> - ä»¥æ— çŠ¶æ€ä¸ºè£ï¼Œä»¥æœ‰çŠ¶æ€ä¸ºè€»\n> - ä»¥æ ‡å‡†åŒ–ä¸ºè£ï¼Œä»¥ç‰¹æ®ŠåŒ–ä¸ºè€»\n> - ä»¥è‡ªåŠ¨åŒ–å·¥å…·ä¸ºè£ï¼Œä»¥æ‰‹åŠ¨å’Œäººè‚‰ä¸ºè€»\n> - ä»¥æ— äººå€¼å®ˆä¸ºè£ï¼Œä»¥äººå·¥ä»‹å…¥ä¸ºè€»\n>\n> **ç›®å‰æˆ‘ä»¬äº¤ä»˜è¿›K8Sé›†ç¾¤çš„ä¸¤ä¸ªdubboå¾®æœåŠ¡å’Œmonitorï¼Œå®ƒä»¬çš„é…ç½®éƒ½æ˜¯å†™æ­»åœ¨å®¹å™¨é‡Œçš„**\n>\n> **é…ç½®ç®¡ç†çš„ç°çŠ¶**ï¼š\n>\n> - é…ç½®æ•£ä¹±æ ¼å¼ä¸æ ‡å‡†ï¼ˆXMLã€iniã€confã€yaml...ï¼‰\n> - ä¸»è¦é‡‡ç”¨æœ¬åœ°é™æ€é…ç½®ï¼Œåº”ç”¨å¤šå‰¯æœ¬é›†ä¸‹é…ç½®ä¿®æ”¹éº»çƒ¦\n> - æ˜“å¼•å‘ç”Ÿäº§äº‹æ•…ï¼ˆæµ‹è¯•ç¯å¢ƒã€ç”Ÿäº§ç¯å¢ƒé…ç½®æ··ç”¨ï¼‰\n> - é…ç½®ç¼ºä¹å®‰å…¨å®¡è®¡å’Œç‰ˆæœ¬æ§åˆ¶åŠŸèƒ½ï¼ˆconfig reviewï¼‰\n> - ä¸åŒç¯å¢ƒçš„åº”ç”¨ï¼Œé…ç½®ä¸åŒï¼Œé€ æˆå¤šæ¬¡æ‰“åŒ…ï¼Œæµ‹è¯•å¤±è´¥\n>\n> **é…ç½®ä¸­å¿ƒæ˜¯ä»€ä¹ˆï¼Ÿ**ï¼š\n>\n> - é¡¾åæ€ä¹‰ï¼Œå°±æ˜¯é›†ä¸­ç®¡ç†åº”ç”¨ç¨‹åºé…ç½®çš„â€œä¸­å¿ƒâ€\n\n\n\n> å¸¸è§çš„é…ç½®ä¸­å¿ƒï¼š\n>\n> - SprigCloudConfig\n> - K8S ConfigMap\n> - Apolloï¼šåŸºäºSprigCloudConfig\n> - ...\n>\n> ç›®å‰å…·æœ‰äº‰è®®çš„ä¸€èˆ¬æ˜¯ä½¿ç”¨Apolloè¿˜æ˜¯SprigCloudConfigï¼Œçœ‹å¯¹æ¯”å›¾ï¼Œæ‰€ä»¥æˆ‘ä»¬ä½¿ç”¨Apolloï¼Œè€Œä¸”Apolloæ˜¯åŸºäºSprigCloudConfigï¼Œä¹Ÿå°±æ˜¯ä½ äº¤ä»˜äº†Apolloä¹Ÿç›¸å½“äºäº¤ä»˜äº†å¾®æœåŠ¡\n\n![1582622382181](assets/1582622382181.png)\n\n### configmapä½¿ç”¨è¯¦è§£\n\n> **WHAT**ï¼šå°±æ˜¯ä¸ºäº†è®©é•œåƒ å’Œ é…ç½®æ–‡ä»¶è§£è€¦ï¼Œä»¥ä¾¿å®ç°é•œåƒçš„å¯ç§»æ¤æ€§å’Œå¯å¤ç”¨æ€§ï¼Œå› ä¸ºä¸€ä¸ªconfigMapå…¶å®å°±æ˜¯ä¸€ç³»åˆ—é…ç½®ä¿¡æ¯çš„é›†åˆï¼Œå°†æ¥å¯ç›´æ¥æ³¨å…¥åˆ°Podä¸­çš„å®¹å™¨ä½¿ç”¨\n>\n> **WHY**ï¼šä¸ºäº†é…åˆApolloä½¿ç”¨\n\nä½¿ç”¨configmapç®¡ç†åº”ç”¨é…ç½®ï¼Œéœ€è¦å…ˆæ‹†åˆ†ç¯å¢ƒï¼Œæ‹†åˆ†æœªtestå’Œproç¯å¢ƒæ¥æ¨¡æ‹Ÿå®é™…å·¥ä½œ\n\nå…ˆæŠŠdubboçš„æœåŠ¡ï¼ˆæ¶ˆè´¹è€…/æœåŠ¡ç«™/ç›‘è§†è€…ï¼‰éƒ½scaleæˆ0ï¼Œè¿™æ ·å°±æ²¡æœ‰å®¹å™¨åœ¨é‡Œé¢è·‘äº†\n\n![1583162321302](assets/1583162321302.png)\n\n![1583162339688](assets/1583162339688.png)\n\næ‹†åˆ†zkæˆæµ‹è¯•ç¯å¢ƒå’Œç”Ÿäº§ç¯å¢ƒæ¥æ¨¡æ‹Ÿå®é™…æƒ…å†µï¼Œå¦‚ä¸‹ï¼š\n\n| ä¸»æœºå            | è§’è‰²                 | ip        |\n| ----------------- | -------------------- | --------- |\n| HDSS7-11.host.com | zk1.od.com(Testç¯å¢ƒ) | 10.4.7.11 |\n| HDSS7-12.host.com | zk2.od.com(Prodç¯å¢ƒ) | 10.4.7.12 |\n\nä¹‹å‰æ˜¯11ã€12ã€21ä¸€å…±3å°ï¼Œæˆ‘ä»¬å…ˆæŠŠ21æ‹†äº†\n\n~~~\n# 11/12/21æœºå™¨ï¼Œåœæ‰zookeeperå¹¶åˆ æ‰ç›¸å…³dataæ–‡ä»¶å’Œlogæ–‡ä»¶çš„å†…å®¹ï¼š\n~]# cd /opt/zookeeper\nzookeeper]# bin/zkServer.sh stop\n# åœä¸æ‰å°± kill -9 id æ€æ‰\nzookeeper]# ps aux|grep zoo\nzookeeper]# cd /data/zookeeper/data/\ndata]# rm -fr ./*\ncd ../logs/\nlogs]# rm -fr ./*\n~~~\n\n> **kill -9**ï¼šå¼ºåˆ¶æ€æ­»è¯¥è¿›ç¨‹\n\n![1581059149533](assets/1581059149533.png)\n\n~~~\n# 11/12æœºå™¨ï¼Œä¿®æ”¹zoo.cfgé…ç½®ï¼š\nzookeeper]# cd /opt/zookeeper/conf\nzookeeper]# vi zoo.cfg\n# æŠŠä¸‹é¢çš„ä¸‰è¡Œéƒ½åˆ æ‰ï¼Œä¸éœ€è¦ç»„æˆé›†ç¾¤ï¼Œå¦‚å›¾\n~~~\n\n![1581059640346](assets/1581059640346.png)\n\n~~~\n# 11/12æœºå™¨ï¼Œå¯åŠ¨zkï¼š\ncd /opt/zookeeper/\nzookeeper]# bin/zkServer.sh start\nzookeeper]# ps aux|grep zoo\nzookeeper]# bin/zkServer.sh status\n~~~\n\n![1584697777390](assets/1584697777390.png)\n\nMode: standalone æ¨¡å¼ï¼Œæ‹†åˆ†å®Œæˆ\n\n~~~\n# 200æœºå™¨ï¼Œå‡†å¤‡èµ„æºé…ç½®æ¸…å•ï¼š\n~]# vi /data/k8s-yaml/dubbo-monitor/cm.yaml\napiVersion: v1\nkind: ConfigMap\nmetadata:\n  name: dubbo-monitor-cm\n  namespace: infra\ndata:\n  dubbo.properties: |\n    dubbo.container=log4j,spring,registry,jetty\n    dubbo.application.name=simple-monitor\n    dubbo.application.owner=ben1234560\n    dubbo.registry.address=zookeeper://zk1.od.com:2181\n    dubbo.protocol.port=20880\n    dubbo.jetty.port=8080\n    dubbo.jetty.directory=/dubbo-monitor-simple/monitor\n    dubbo.charts.directory=/dubbo-monitor-simple/charts\n    dubbo.statistics.directory=/dubbo-monitor-simple/statistics\n    dubbo.log4j.file=/dubbo-monitor-simple/logs/dubbo-monitor.log\n    dubbo.log4j.level=WARN\n\n~]# vi /data/k8s-yaml/dubbo-monitor/dp2.yaml\nkind: Deployment\napiVersion: extensions/v1beta1\nmetadata:\n  name: dubbo-monitor\n  namespace: infra\n  labels: \n    name: dubbo-monitor\nspec:\n  replicas: 1\n  selector:\n    matchLabels: \n      name: dubbo-monitor\n  template:\n    metadata:\n      labels: \n        app: dubbo-monitor\n        name: dubbo-monitor\n    spec:\n      containers:\n      - name: dubbo-monitor\n        image: harbor.od.com/infra/dubbo-monitor:latest\n        ports:\n        - containerPort: 8080\n          protocol: TCP\n        - containerPort: 20880\n          protocol: TCP\n        imagePullPolicy: IfNotPresent\n        volumeMounts:\n          - name: configmap-volume\n            mountPath: /dubbo-monitor-simple/conf\n      volumes:\n        - name: configmap-volume\n          configMap:\n            name: dubbo-monitor-cm\n      imagePullSecrets:\n      - name: harbor\n      restartPolicy: Always\n      terminationGracePeriodSeconds: 30\n      securityContext: \n        runAsUser: 0\n      schedulerName: default-scheduler\n  strategy:\n    type: RollingUpdate\n    rollingUpdate: \n      maxUnavailable: 1\n      maxSurge: 1\n  revisionHistoryLimit: 7\n  progressDeadlineSeconds: 600\n~~~\n\n\n\n~~~\n# å¯¹æ¯”ä¸¤ä¸ªdpæœ‰ä»€ä¹ˆä¸åŒï¼Œ200æœºå™¨ï¼š\ncd /data/k8s-yaml/dubbo-monitor/\ndubbo-monitor]# vimdiff dp.yaml dp2.yaml\n#:qall é€€å‡º\n~~~\n\n> **vimdiff **ï¼šç¼–è¾‘åŒä¸€æ–‡ä»¶çš„ä¸åŒå†å²ç‰ˆæœ¬ï¼Œå¯¹å„æ–‡ä»¶çš„å†…å®¹è¿›è¡Œæ¯”å¯¹ä¸è°ƒæ•´\n>\n> æ²¡æœ‰vimdiff çš„ä¸‹è½½ yum install vim -y\n\n![1583198466051](assets/1583198466051.png)\n\n> è¿™é‡Œä¸¤ä¸ªæ–‡ä»¶ä¸åŒçš„åœ°æ–¹ï¼Œæ³¨æ„ï¼Œè¿™é‡Œçš„imageçš„ç‰ˆæœ¬å› ä¸ºæˆ‘çš„æ“ä½œé—®é¢˜æ‰€ä»¥ä¸€ä¸ªv2ä¸€ä¸ªæ²¡æœ‰vï¼Œä½ çš„åº”è¯¥æ˜¯éƒ½æ²¡æœ‰çš„\n\n~~~\n# 200æœºå™¨ï¼Œæ›¿æ¢dpï¼š\ndubbo-monitor]# mv dp.yaml /tmp/\ndubbo-monitor]# mv dp2.yaml dp.yaml\n~~~\n\n> **mv**ï¼šå¦‚æœmvåæ˜¯ç›®å½•ï¼Œåˆ™æ˜¯ç§»åŠ¨ï¼Œå¦‚æœæ˜¯æ–‡ä»¶åï¼Œåˆ™æ˜¯æ›´æ”¹åå­—\n\n~~~\n# åº”ç”¨èµ„æºé…ç½®æ¸…å•ï¼Œ22æœºå™¨ï¼š\n~]# kubectl apply -f http://k8s-yaml.od.com/dubbo-monitor/cm.yaml\n~]# kubectl apply -f http://k8s-yaml.od.com/dubbo-monitor/dp.yaml\n# çœ‹ä¸€ä¸‹ç›¸å…³å®¹å™¨æœ‰æ²¡æœ‰èµ·æ¥\n~~~\n\n![1583198817470](assets/1583198817470.png)\n\n![1583198829279](assets/1583198829279.png)\n\n![1583198887392](assets/1583198887392.png)\n\n![1583199215057](assets/1583199215057.png)\n\næˆ‘ä»¬æ”¹æˆzk2\n\n![1583199496585](assets/1583199496585.png)\n\nåœ¨åˆ æ‰è¿™ä¸ªpodé‡å¯\n\n![1583199525277](assets/1583199525277.png)\n\nåˆ·æ–°é¡µé¢å˜æˆzk2äº†\n\n![1583199653453](assets/1583199653453.png)\n\nå®Œæˆ\n\n\n\n#### æŠ¥é”™ä¿¡æ¯\n\n> flannelé‡å¯æŠ¥é”™é—®é¢˜\n\n~~~\n# flannelé‡å¯éœ€è¦å¢åŠ ä»¥ä¸‹å†…å®¹ï¼Œæ·»åŠ åœ¨æœ€ä¸‹é¢:\n21 ~]# vi /etc/sipervisord.d/flannel.ini\nkillasgroup=true\nstopasgroup=true\n~~~\n\n#### å¦‚ä½•æ’é”™ï¼š\n\n~~~\n# æŸ¥çœ‹æ—¶é—´æ˜¯å¦æ­£å¸¸\ndate\n\n# æŸ¥çœ‹kubernetesçš„æŠ¥é”™\n21 ~]# tail -fn 200/data/logs/kubernetes/kube-kubelet/kubelet.stdout.log\n\n# å¯ä»¥é‡å¯docker å’Œ kubelet\n21 ~]# systemctl restart docker \n21 ~]# ps aux|grep kubelet\n21 ~]# kill -9 id\n\n# æŸ¥çœ‹supervisorçš„çŠ¶æ€\n21 ~]# supervisorctl status\n\n# æŸ¥çœ‹è·¯ç”±çŠ¶æ€ï¼Œæ˜¯å¦èƒ½pingé€šå…¶å®ƒæœºå™¨\n21 ~]# route -n\n21 ~]# ping 172.7.22.2\n\n# æŸ¥çœ‹flannelæƒ…å†µ\n21 ~]# tail -fn 200 /data/logs/flanneld/flanneld.stdout.log\n# 12flannelä¸»æœºå™¨ä¸Šgetç½‘ç»œï¼Œå¦‚æœerroråˆ™åŠ å…¥backend\n12 ~]# ./etcdctl get /coreos.com/network/config\n\n# æŠ¥é”™iptablesï¼Œè®©æœºå™¨ä¸€é‡å¯å°±è‡ªåŠ¨ä½¿ç”¨ï¼Œ21/22æœºå™¨\n~]# service iptables save\n# out: [ok]\n~~~\n\n#### cmå¯¹è±¡çš„å¦ä¸€ç§åˆ›å»ºæ–¹æ³•ï¼ˆå¯ä¸åšï¼‰ï¼š\n\n~~~\n# 22æœºå™¨ï¼š\ncd /opt/kubernetes/server/bin/conf\n# å½“å‰ç›®å½•ä¸‹è¦åˆkubelet.kubeconfigçš„æ–‡ä»¶\nconf]# kubectl create cm kubelet-cm --from-file=./kubelet.kubeconfig\n#out: configmap/kubelet-cm created\n~~~\n\nå¯ä»¥åœ¨dashoboardçš„defaultåç§°ç©ºé—´ä¸‹Config Mapsçœ‹åˆ°\n\néšåè®°å¾—åˆ é™¤\n\n\n\n#### å®˜æ–¹Apolloæ¡†æ¶ï¼š\n\n> **WHAT**ï¼šè¯·å‚è€ƒ[å®˜æ–¹æ€»ä½“è®¾è®¡](https://www.apolloconfig.com/#/zh/design/apollo-design)ï¼ŒApolloæ¡†æ¶çš„ç‰¹æ€§ä¹Ÿå·²ç»åœ¨ä¸Šé¢è·ŸSpring Cloudåšäº†å¯¹æ¯”ã€‚æ›´å¤šçš„è§£é‡Šå¯ä»¥å‚è€ƒ[å®˜æ–¹ç‰¹æ€§æ–‡æ¡£](https://github.com/apolloconfig/apollo#features)\n>\n> **WHY**ï¼šç”¨è¯¥æ¡†æ¶å®ç°æ¯”Spring Cloudæ›´ä¼˜çš„èƒ½åŠ›ï¼Œæ›´å¤šå¯¹æ¯”å¯å‚è€ƒ[Nacosã€Apolloã€Spring Cloud Configå¾®æœåŠ¡é…ç½®ä¸­å¿ƒå¯¹æ¯”](https://www.jianshu.com/p/2f0ae9c7f2e1)\n\n![1587274472834](assets/1587274472834.png)\n\n#### ç®€åŒ–Apolloæ¡†æ¶ï¼š\n\n> **WHY**ï¼š\n>\n> å‚è€ƒ[å®˜æ–¹å¾®æœåŠ¡æ¶æ„](https://mp.weixin.qq.com/s/-hUaQPzfsl9Lm3IqQW3VDQ)ä½¿ç”¨Apolloæ¶æ„V1\n>\n> Meta Serverï¼š\n>\n> - Portalé€šè¿‡åŸŸåè®¿é—®MetaServerè·å–AdminServiceçš„åœ°å€åˆ—è¡¨\n> - Clienté€šè¿‡åŸŸåè®¿é—®MetaServerè·å–ConfigServiceçš„åœ°å€åˆ—è¡¨\n> - ç›¸å½“äºä¸€ä¸ªEureka Proxy\n> - é€»è¾‘è§’è‰²ï¼Œå’ŒConfigServiceä½åœ¨ä¸€èµ·éƒ¨ç½²\n>\n> Eurekaï¼š\n>\n> - ç”¨äºæœåŠ¡å‘ç°å’Œæ³¨å†Œ\n> - Config/AdminServiceæ³¨å†Œå®ä¾‹å¹¶å®šæœŸæŠ¥å¿ƒè·³\n> - å’ŒConfigServiceä½åœ¨ä¸€èµ·éƒ¨ç½²\n>\n> å¯ä»¥çœ‹åˆ°Eurekaå’ŒZookeeperæ˜¯ä¸€æ ·çš„åŠŸèƒ½ï¼Œæ‰€ä»¥ä¸å†æ­å»ºé‡å¤çš„åŠŸèƒ½æœåŠ¡ã€‚\n>\n> è€Œä¸ºä»€ä¹ˆä½¿ç”¨Zookeeperï¼Œæ€»å¾—æ¥è¯´EurekaåŸºäºAPä¿è¯é«˜å¯ç”¨ï¼Œé‡åˆ°é—®é¢˜ï¼Œæ—¶å¯ä»¥ç‰ºç‰²å…¶ä¸€è‡´æ€§æ¥ä¿è¯ç³»ç»ŸæœåŠ¡çš„**é«˜å¯ç”¨æ€§**ï¼Œæ—¢è¿”å›æ—§æ•°æ®ã€‚ZookeeperåŸºäºCPï¼Œè¿½æ±‚**æ•°æ®ä¸€è‡´æ€§**ã€‚å®é™…ä¸šåŠ¡ä½¿ç”¨ä»€ä¹ˆè¦åŸºäºä¸šåŠ¡è€ƒé‡ã€‚\n\n![1584698746125](assets/1584698746125.png)\n\n![1584698613252](assets/1584698613252.png)\n\n> Clienté€šè¿‡æ¨æ‹‰ç»“åˆå’ŒConfigServiceäº¤äº’ï¼Œç„¶åConfigServiceå»æ‹¿ConfigDBé‡Œé¢çš„é…ç½®ç»™Clientç«¯è¿”å›å»ã€‚\n>\n> Portalæ˜¯Apolloçš„ä¸€ä¸ªä»ªè¡¨ç›˜ï¼Œé€šè¿‡è°ƒç”¨AdminServiceå»åŒæ­¥ä¿®æ”¹ConfigDBé‡Œé¢çš„é…ç½®\n>\n> å…ˆäº¤ä»˜ConfigServiceï¼Œç„¶åäº¤ä»˜AdminServiceï¼Œæœ€ååŠ portal\n\n\n\n### äº¤ä»˜Apollo-ConfigServiceåˆ°K8S\n\n[å®˜ç½‘https://github.com/ctripcorp/apollo/](https://github.com/ctripcorp/apollo/)\n\n##### å®‰è£…éƒ¨ç½²MySQLæ•°æ®åº“ï¼ˆä½œä¸º`ConfigDB`/`PortalDB`ï¼‰\n\n~~~~\n# æ›´æ–°yumæºï¼Œ11æœºå™¨ï¼š\n~]# vi /etc/yum.repos.d/MariaDB.repo\n[mariadb]\nname = MariaDB\nbaseurl = https://mirrors.ustc.edu.cn/mariadb/yum/10.1/centos7-amd64/\ngpgkey=https://mirrors.ustc.edu.cn/mariadb/yum/RPM-GPG-KEY-MariaDB\ngpgcheck=1\n\n# å¯¼å…¥GPG-KEY\n~]# rpm --import https://mirrors.ustc.edu.cn/mariadb/yum/RPM-GPG-KEY-MariaDB\n~]# yum list mariadb --show-duplicates\n# out: mariadb.x86_64\n~]# yum makecache\n# out:Metadata Cache Created\n# æ›´æ–°æ•°æ®åº“ç‰ˆæœ¬\n~]# yum list mariadb-server --show-duplicates\n~]# yum install mariadb-server -y\n# ç¼–è¾‘åŸºç¡€é…ç½®\n# å¢åŠ éƒ¨åˆ†å†…å®¹\n~] vi /etc/my.cnf.d/server.cnf\n[mysqld]\ncharacter_set_server = utf8mb4\ncollation_server = utf8mb4_general_ci\ninit_connect = \"SET NAMES 'utf8mb4'\"\n~~~~\n\n![1583202954447](assets/1583202954447.png)\n\n~~~\n# 11æœºå™¨ï¼Œä¿®æ”¹åŸºç¡€é…ç½®,å¹¶å¯åŠ¨ï¼š\n# åœ¨æ”¹å†…å®¹ä¸‹å¢åŠ ï¼Œå­—ç¬¦é›†\n~]# vi /etc/my.cnf.d/mysql-clients.cnf\n[mysql]\ndefault-character-set = utf8mb4\n\n~]# systemctl start mariadb\n~~~\n\n![1583202999075](assets/1583202999075.png)\n\n~~~\n# 11æœºå™¨ï¼Œè®¾ç½®,mysqlå¯†ç ï¼š\n~]# mysqladmin -uroot password\n# è¿™é‡Œæ˜¯è®¾ç½®å¯†ç ï¼š123456\n~]# mysql -uroot -p\n# è¿™é‡Œæ˜¯è¾“å…¥å¯†ç \nnone)]> \\s\n# ç¡®å®šSERVER\\DB\\CLIENT\\CONN éƒ½æ˜¯utf8\n~~~\n\n![1583203114762](assets/1583203114762.png)\n\n~~~\n# 11æœºå™¨ï¼š\nnone)]> show databases;\nnone)]> drop database test;\nnone)]> exit\n# æŸ¥çœ‹æ•°æ®åº“æ˜¯å¦æ­£å¸¸\n~]# ps aux|grep mysql\n~]# netstat luntp|grep 3306\n~]# wget https://raw.githubusercontent.com/ctripcorp/apollo/1.5.1/scripts/db/migration/configdb/V1.0.0__initialization.sql -O apolloconfig.sql\n~]# cat apolloconfig.sql\n~]# mysql -uroot -p < apolloconfig.sql\n# è¾“å…¥å¯†ç \n~] mysql -uroot -p\n# è¾“å¯†ç \nnone)]> show databases;\n~~~\n\n![1581148090694](assets/1581148090694.png)\n\n~~~\n# 11æœºå™¨ï¼Œåˆ›å»ºå…¶å®ƒæƒé™ç”¨æˆ·è€Œä¸æ˜¯ç›´æ¥ç»™rootæƒé™ï¼š\nnone)]> use ApolloConfigDB;\nApolloConfigDB]> show tables;\nApolloConfigDB]> grant INSERT,DELETE,UPDATE,SELECT on ApolloConfigDB.* to 'apolloconfig'@'10.4.7.%' identified by \"123456\";\nApolloConfigDB]> select user,host from mysql.user;\n~~~\n\n![1583203450336](assets/1583203450336.png)\n\n~~~\n# 11æœºå™¨,ä¿®æ”¹åˆå§‹æ•°æ®ï¼š\nApolloConfigDB]> show tables;\nApolloConfigDB]> select * from ServerConfig\\G\nApolloConfigDB]> update ApolloConfigDB.ServerConfig set ServerConfig.Value=\"http://config.od.com/eureka\" where ServerConfig.Key=\"eureka.service.url\";\nApolloConfigDB]> select * from ServerConfig\\G\n~~~\n\nåŸï¼š\n\n![1583203490999](assets/1583203490999.png)\n\næ”¹å\n\n![1583203522358](assets/1583203522358.png)\n\n~~~\n# 11æœºå™¨ï¼Œè§£æåŸŸåï¼š\n~]# vi /var/named/od.com.zone\nserial å‰æ»šä¸€ä½\nconfig             A    10.4.7.10\n\n~]# systemctl restart named\n~~~\n\n![1583203561891](assets/1583203561891.png)\n\n~~~\n# 21æœºå™¨ï¼Œæµ‹è¯•ä¸‹21æœºå™¨èƒ½ä¸èƒ½æŸ¥åˆ°(11æœºå™¨æ˜¯è‚¯å®šèƒ½æŸ¥åˆ°çš„)ï¼š\n~]# dig -t A config.od.com @192.168.0.2 +short\n# out:10.4.7.10\n~~~\n\n[åŒ…çš„å®˜ç½‘åœ°å€](https://github.com/ctripcorp/apollo/releases/tag/v1.5.1)![1583204125452](assets/1583204125452.png)\n\n~~~\n# 200æœºå™¨ï¼Œåˆ¶ä½œdockeré•œåƒï¼š\ncd /opt/src\nsrc]# wget https://github.com/ctripcorp/apollo/releases/download/v1.5.1/apollo-configservice-1.5.1-github.zip\n# æˆ–è€…å»å®˜ç½‘ä¸‹è½½æˆ–è€…ç”¨æˆ‘çš„ä¸Šä¼ çš„åŒ…\nsrc]# mkdir /data/dockerfile/apollo-configservice\nsrc]# unzip -o apollo-configservice-1.5.1-github.zip -d /data/dockerfile/apollo-configservice\nsrc]# cd /data/dockerfile/apollo-configservice/\napollo-configservice]# rm -rf apollo-configservice-1.5.1-sources.jar\napollo-configservice]# ll\n~~~\n\n![1581232250106](assets/1581232250106.png)\n\n~~~\n# 11æœºå™¨ï¼Œè§£æåŸŸåï¼š\n~]# vi /var/named/od.com.zone\nserial å‰æ»šä¸€ä½\nmysql              A    10.4.7.11\n\n~]# systemctl restart named\n~]# dig -t A mysql.od.com @10.4.7.11 +short\n# out: 10.4.7.11\n~~~\n\n![1582636827536](assets/1582636827536.png)\n\n~~~~\n# 200æœºå™¨ï¼Œä¿®æ”¹è´¦æˆ·å¯†ç ï¼š\ncd /data/dockerfile/apollo-configservice/config\nconfig]# vi application-github.properties\nspring.datasource.url = jdbc:mysql://mysql.od.com:3306/ApolloConfigDB?characterEncoding=utf8\nspring.datasource.username = apolloconfig\nspring.datasource.password = 123456\n~~~~\n\n![1581232483973](assets/1581232483973.png)\n\n~~~\n# 200æœºå™¨ï¼š\ncd /data/dockerfile/apollo-configservice/scripts\nscripts]# rm -f shutdown.sh\n# å…¨éƒ¨åˆ æ‰ï¼Œæ¢æˆä»¥ä¸‹å†…å®¹\nscripts]# vi startup.sh\n#!/bin/bash\nSERVICE_NAME=apollo-configservice\n## Adjust log dir if necessary\nLOG_DIR=/opt/logs/apollo-config-server\n## Adjust server port if necessary\nSERVER_PORT=8080\nAPOLLO_CONFIG_SERVICE_NAME=$(hostname -i)\nSERVER_URL=\"http://${APOLLO_CONFIG_SERVICE_NAME}:${SERVER_PORT}\"\n\n## Adjust memory settings if necessary\nexport JAVA_OPTS=\"-Xms128m -Xmx128m -Xss256k -XX:MetaspaceSize=128m -XX:MaxMetaspaceSize=384m -XX:NewSize=256m -XX:MaxNewSize=256m -XX:SurvivorRatio=8\"\n\n## Only uncomment the following when you are using server jvm\n#export JAVA_OPTS=\"$JAVA_OPTS -server -XX:-ReduceInitialCardMarks\"\n\n########### The following is the same for configservice, adminservice, portal ###########\nexport JAVA_OPTS=\"$JAVA_OPTS -XX:ParallelGCThreads=4 -XX:MaxTenuringThreshold=9 -XX:+DisableExplicitGC -XX:+ScavengeBeforeFullGC -XX:SoftRefLRUPolicyMSPerMB=0 -XX:+ExplicitGCInvokesConcurrent -XX:+HeapDumpOnOutOfMemoryError -XX:-OmitStackTraceInFastThrow -Duser.timezone=Asia/Shanghai -Dclient.encoding.override=UTF-8 -Dfile.encoding=UTF-8 -Djava.security.egd=file:/dev/./urandom\"\nexport JAVA_OPTS=\"$JAVA_OPTS -Dserver.port=$SERVER_PORT -Dlogging.file=$LOG_DIR/$SERVICE_NAME.log -XX:HeapDumpPath=$LOG_DIR/HeapDumpOnOutOfMemoryError/\"\n\n# Find Java\nif [[ -n \"$JAVA_HOME\" ]] && [[ -x \"$JAVA_HOME/bin/java\" ]]; then\n    javaexe=\"$JAVA_HOME/bin/java\"\nelif type -p java > /dev/null 2>&1; then\n    javaexe=$(type -p java)\nelif [[ -x \"/usr/bin/java\" ]];  then\n    javaexe=\"/usr/bin/java\"\nelse\n    echo \"Unable to find Java\"\n    exit 1\nfi\n\nif [[ \"$javaexe\" ]]; then\n    version=$(\"$javaexe\" -version 2>&1 | awk -F '\"' '/version/ {print $2}')\n    version=$(echo \"$version\" | awk -F. '{printf(\"%03d%03d\",$1,$2);}')\n    # now version is of format 009003 (9.3.x)\n    if [ $version -ge 011000 ]; then\n        JAVA_OPTS=\"$JAVA_OPTS -Xlog:gc*:$LOG_DIR/gc.log:time,level,tags -Xlog:safepoint -Xlog:gc+heap=trace\"\n    elif [ $version -ge 010000 ]; then\n        JAVA_OPTS=\"$JAVA_OPTS -Xlog:gc*:$LOG_DIR/gc.log:time,level,tags -Xlog:safepoint -Xlog:gc+heap=trace\"\n    elif [ $version -ge 009000 ]; then\n        JAVA_OPTS=\"$JAVA_OPTS -Xlog:gc*:$LOG_DIR/gc.log:time,level,tags -Xlog:safepoint -Xlog:gc+heap=trace\"\n    else\n        JAVA_OPTS=\"$JAVA_OPTS -XX:+UseParNewGC\"\n        JAVA_OPTS=\"$JAVA_OPTS -Xloggc:$LOG_DIR/gc.log -XX:+PrintGCDetails\"\n        JAVA_OPTS=\"$JAVA_OPTS -XX:+UseConcMarkSweepGC -XX:+UseCMSCompactAtFullCollection -XX:+UseCMSInitiatingOccupancyOnly -XX:CMSInitiatingOccupancyFraction=60 -XX:+CMSClassUnloadingEnabled -XX:+CMSParallelRemarkEnabled -XX:CMSFullGCsBeforeCompaction=9 -XX:+CMSClassUnloadingEnabled  -XX:+PrintGCDateStamps -XX:+PrintGCApplicationConcurrentTime -XX:+PrintHeapAtGC -XX:+UseGCLogFileRotation -XX:NumberOfGCLogFiles=5 -XX:GCLogFileSize=5M\"\n    fi\nfi\n\nprintf \"$(date) ==== Starting ==== \\n\"\n\ncd `dirname $0`/..\nchmod 755 $SERVICE_NAME\".jar\"\n./$SERVICE_NAME\".jar\" start\n\nrc=$?;\n\nif [[ $rc != 0 ]];\nthen\n    echo \"$(date) Failed to start $SERVICE_NAME.jar, return code: $rc\"\n    exit $rc;\nfi\n\ntail -f /dev/null\n~~~\n\n> [Apolloå®˜æ–¹æ–‡æ¡£](https://github.com/ctripcorp/apollo/blob/1.5.1/scripts/apollo-on-kubernetes/apollo-config-server/scripts/startup-kubernetes.sh)\n>\n> ä¸Šè¿°ä»£ç æ˜¯ä»Apolloå®˜ç½‘æ‹‰ä¸‹æ¥çš„ï¼Œä¸è¿‡ç¬¬7è¡Œå¤šäº†ä¸€è¡ŒAPOLLO_CONFIG_SERVICE_NAME=$(hostname -i)\n>\n> å…¶ä¸­export JAVA_OPTSä¿®æ”¹äº†ä¸‹èµ„æºï¼Œæ”¹å°äº†\n\n~~~\n# 200æœºå™¨ï¼Œç»™æƒé™ï¼š\nscripts]# chmod u+x startup.sh\nscripts]# ll\n~~~\n\n![1581233647557](assets/1581233647557.png)\n\n~~~\n# 200æœºå™¨ï¼Œåšdockerfileï¼š\ncd /data/dockerfile/apollo-configservice\napollo-configservice]# vi Dockerfile\nFROM 909336740/jre8:8u112\n\nENV VERSION 1.5.1\n\nRUN ln -sf /usr/share/zoneinfo/Asia/Shanghai /etc/localtime &&\\\n    echo \"Asia/Shanghai\" > /etc/timezone\n\nADD apollo-configservice-${VERSION}.jar /apollo-configservice/apollo-configservice.jar\nADD config/ /apollo-configservice/config\nADD scripts/ /apollo-configservice/scripts\n\nCMD [\"/apollo-configservice/scripts/startup.sh\"]\n~~~\n\n> [å‚è€ƒApolloå®˜ç½‘æ–‡æ¡£](https://github.com/ctripcorp/apollo/blob/1.5.1/scripts/apollo-on-kubernetes/apollo-config-server/Dockerfile)\n\n![1583219072270](assets/1583219072270.png)\n\n~~~\n# 200æœºå™¨,åˆ¶ä½œå®¹å™¨ï¼š\napollo-configservice]# docker build . -t harbor.od.com/infra/apollo-configservice:v1.5.1\napollo-configservice]# docker push harbor.od.com/infra/apollo-configservice:v1.5.1\n~~~\n\n![1583205129961](assets/1583205129961.png)\n\n~~~\n# åˆ¶ä½œèµ„æºé…ç½®æ¸…å•ï¼Œ200æœºå™¨ï¼š\n~]# mkdir /data/k8s-yaml/apollo-configservice\n~]# cd /data/k8s-yaml/apollo-configservice\napollo-configservice]# vi cm.yaml\napiVersion: v1\nkind: ConfigMap\nmetadata:\n  name: apollo-configservice-cm\n  namespace: infra\ndata:\n  application-github.properties: |\n    # DataSource\n    spring.datasource.url = jdbc:mysql://mysql.od.com:3306/ApolloConfigDB?characterEncoding=utf8\n    spring.datasource.username = apolloconfig\n    spring.datasource.password = 123456\n    eureka.service.url = http://config.od.com/eureka\n  app.properties: |\n    appId=100003171\n\napollo-configservice]# vi dp.yaml\nkind: Deployment\napiVersion: extensions/v1beta1\nmetadata:\n  name: apollo-configservice\n  namespace: infra\n  labels: \n    name: apollo-configservice\nspec:\n  replicas: 1\n  selector:\n    matchLabels: \n      name: apollo-configservice\n  template:\n    metadata:\n      labels: \n        app: apollo-configservice \n        name: apollo-configservice\n    spec:\n      volumes:\n      - name: configmap-volume\n        configMap:\n          name: apollo-configservice-cm\n      containers:\n      - name: apollo-configservice\n        image: harbor.od.com/infra/apollo-configservice:v1.5.1\n        ports:\n        - containerPort: 8080\n          protocol: TCP\n        volumeMounts:\n        - name: configmap-volume\n          mountPath: /apollo-configservice/config\n        terminationMessagePath: /dev/termination-log\n        terminationMessagePolicy: File\n        imagePullPolicy: IfNotPresent\n      imagePullSecrets:\n      - name: harbor\n      restartPolicy: Always\n      terminationGracePeriodSeconds: 30\n      securityContext: \n        runAsUser: 0\n      schedulerName: default-scheduler\n  strategy:\n    type: RollingUpdate\n    rollingUpdate: \n      maxUnavailable: 1\n      maxSurge: 1\n  revisionHistoryLimit: 7\n  progressDeadlineSeconds: 600\n\napollo-configservice]# vi svc.yaml\nkind: Service\napiVersion: v1\nmetadata: \n  name: apollo-configservice\n  namespace: infra\nspec:\n  ports:\n  - protocol: TCP\n    port: 8080\n    targetPort: 8080\n  selector: \n    app: apollo-configservice\n\napollo-configservice]# vi ingress.yaml\nkind: Ingress\napiVersion: extensions/v1beta1\nmetadata: \n  name: apollo-configservice\n  namespace: infra\nspec:\n  rules:\n  - host: config.od.com\n    http:\n      paths:\n      - path: /\n        backend: \n          serviceName: apollo-configservice\n          servicePort: 8080\n~~~\n\n![1583205384294](assets/1583205384294.png)\n\n~~~\n# åº”ç”¨èµ„æºé…ç½®æ¸…å•ï¼Œ22æœºå™¨ï¼š\n~]# kubectl apply -f http://k8s-yaml.od.com/apollo-configservice/cm.yaml\n~]# kubectl apply -f http://k8s-yaml.od.com/apollo-configservice/dp.yaml\n~]# kubectl apply -f http://k8s-yaml.od.com/apollo-configservice/svc.yaml\n~]# kubectl apply -f http://k8s-yaml.od.com/apollo-configservice/ingress.yaml\n~~~\n\n![1583206365045](assets/1583206365045.png)\n\nèµ„æºç»™çš„å°‘ï¼Œå¯èƒ½ç¨å¾®æ…¢äº†ä¸€äº›ï¼Œç‚¹è¿›å»->ç‚¹å³ä¸Šè§’çš„LOGSï¼Œæ—¥å¿—æœ‰ç‚¹å¤šï¼Œè®°å¾—ç‚¹å‡»å³ä¸‹è§’çš„ç¿»é¡µ\n\n[æµè§ˆå™¨è®¿é—®config.od.com](config.od.com)\n\né¼ æ ‡å¯¹ç€èµ·æ¥çš„Apolloï¼Œå¯ä»¥çœ‹åˆ°å³ä¸‹è§’æœ‰ç½‘å€\n\n![1583206733615](assets/1583206733615.png)\n\n~~~\n# 22æœºå™¨ï¼Œcurlï¼š\n~]# curl http://172.7.22.5:8080/info\n~~~\n\n![1583206773094](assets/1583206773094.png)\n\næˆåŠŸ\n\n\n\n### Apollo-ConfigServiceè¿æ¥æ•°æ®åº“IPåˆ†æ\n\n~~~\n# 11æœºå™¨ï¼š\n~]# mysql -uroot -p\nnone)]> show processlist;\n~~~\n\n![1583207560779](assets/1583207560779.png)\n\n![1583207586526](assets/1583207586526.png)\n\n> åŸæœ¬æ˜¯172.7.22.5ï¼Œè¿æ¥åˆ°æ•°æ®çš„æ˜¯10.4.7.22ï¼Œå› ä¸ºåšäº†NATè½¬æ¢ï¼Œå®ƒå¸¦äº†é¢å…·\n>\n\n\n\n### äº¤ä»˜Apollo-adminservice\n\n[å®˜ç½‘ä¸‹è½½https://github.com/ctripcorp/apollo/releases/tag/v1.5.1](https://github.com/ctripcorp/apollo/releases/tag/v1.5.1)\n\n![1584698854148](assets/1584698854148.png)\n\n~~~\n# 200æœºå™¨ï¼š\ncd /opt/src\nsrc]# wget https://github.com/ctripcorp/apollo/releases/download/v1.5.1/apollo-adminservice-1.5.1-github.zip\nsrc]# mkdir /data/dockerfile/apollo-adminservice\nsrc]# unzip -o apollo-adminservice-1.5.1-github.zip -d /data/dockerfile/apollo-adminservice\nsrc]# cd /data/dockerfile/apollo-adminservice\napollo-adminservice]# rm -fr apollo-adminservice-1.5.1-sources.jar\napollo-adminservice]# rm -f apollo-adminservice.conf\napollo-adminservice]# cd scripts/\nscripts]# rm -f shutdown.sh\n# åˆ æ‰åŸæ¥çš„å…¨éƒ¨å†…å®¹ï¼Œæ·»åŠ ä»¥ä¸‹æ–°çš„å†…å®¹\nscripts]# vi startup.sh\n#!/bin/bash\nSERVICE_NAME=apollo-adminservice\n## Adjust log dir if necessary\nLOG_DIR=/opt/logs/apollo-admin-server\n## Adjust server port if necessary\nSERVER_PORT=8080\nAPOLLO_ADMIN_SERVICE_NAME=$(hostname -i)\n# SERVER_URL=\"http://localhost:${SERVER_PORT}\"\nSERVER_URL=\"http://${APOLLO_ADMIN_SERVICE_NAME}:${SERVER_PORT}\"\n\n## Adjust memory settings if necessary\n#export JAVA_OPTS=\"-Xms2560m -Xmx2560m -Xss256k -XX:MetaspaceSize=128m -XX:MaxMetaspaceSize=384m -XX:NewSize=1536m -XX:MaxNewSize=1536m -XX:SurvivorRatio=8\"\n\n## Only uncomment the following when you are using server jvm\n#export JAVA_OPTS=\"$JAVA_OPTS -server -XX:-ReduceInitialCardMarks\"\n\n########### The following is the same for configservice, adminservice, portal ###########\nexport JAVA_OPTS=\"$JAVA_OPTS -XX:ParallelGCThreads=4 -XX:MaxTenuringThreshold=9 -XX:+DisableExplicitGC -XX:+ScavengeBeforeFullGC -XX:SoftRefLRUPolicyMSPerMB=0 -XX:+ExplicitGCInvokesConcurrent -XX:+HeapDumpOnOutOfMemoryError -XX:-OmitStackTraceInFastThrow -Duser.timezone=Asia/Shanghai -Dclient.encoding.override=UTF-8 -Dfile.encoding=UTF-8 -Djava.security.egd=file:/dev/./urandom\"\nexport JAVA_OPTS=\"$JAVA_OPTS -Dserver.port=$SERVER_PORT -Dlogging.file=$LOG_DIR/$SERVICE_NAME.log -XX:HeapDumpPath=$LOG_DIR/HeapDumpOnOutOfMemoryError/\"\n\n# Find Java\nif [[ -n \"$JAVA_HOME\" ]] && [[ -x \"$JAVA_HOME/bin/java\" ]]; then\n    javaexe=\"$JAVA_HOME/bin/java\"\nelif type -p java > /dev/null 2>&1; then\n    javaexe=$(type -p java)\nelif [[ -x \"/usr/bin/java\" ]];  then\n    javaexe=\"/usr/bin/java\"\nelse\n    echo \"Unable to find Java\"\n    exit 1\nfi\n\nif [[ \"$javaexe\" ]]; then\n    version=$(\"$javaexe\" -version 2>&1 | awk -F '\"' '/version/ {print $2}')\n    version=$(echo \"$version\" | awk -F. '{printf(\"%03d%03d\",$1,$2);}')\n    # now version is of format 009003 (9.3.x)\n    if [ $version -ge 011000 ]; then\n        JAVA_OPTS=\"$JAVA_OPTS -Xlog:gc*:$LOG_DIR/gc.log:time,level,tags -Xlog:safepoint -Xlog:gc+heap=trace\"\n    elif [ $version -ge 010000 ]; then\n        JAVA_OPTS=\"$JAVA_OPTS -Xlog:gc*:$LOG_DIR/gc.log:time,level,tags -Xlog:safepoint -Xlog:gc+heap=trace\"\n    elif [ $version -ge 009000 ]; then\n        JAVA_OPTS=\"$JAVA_OPTS -Xlog:gc*:$LOG_DIR/gc.log:time,level,tags -Xlog:safepoint -Xlog:gc+heap=trace\"\n    else\n        JAVA_OPTS=\"$JAVA_OPTS -XX:+UseParNewGC\"\n        JAVA_OPTS=\"$JAVA_OPTS -Xloggc:$LOG_DIR/gc.log -XX:+PrintGCDetails\"\n        JAVA_OPTS=\"$JAVA_OPTS -XX:+UseConcMarkSweepGC -XX:+UseCMSCompactAtFullCollection -XX:+UseCMSInitiatingOccupancyOnly -XX:CMSInitiatingOccupancyFraction=60 -XX:+CMSClassUnloadingEnabled -XX:+CMSParallelRemarkEnabled -XX:CMSFullGCsBeforeCompaction=9 -XX:+CMSClassUnloadingEnabled  -XX:+PrintGCDateStamps -XX:+PrintGCApplicationConcurrentTime -XX:+PrintHeapAtGC -XX:+UseGCLogFileRotation -XX:NumberOfGCLogFiles=5 -XX:GCLogFileSize=5M\"\n    fi\nfi\n\nprintf \"$(date) ==== Starting ==== \\n\"\n\ncd `dirname $0`/..\nchmod 755 $SERVICE_NAME\".jar\"\n./$SERVICE_NAME\".jar\" start\n\nrc=$?;\n\nif [[ $rc != 0 ]];\nthen\n    echo \"$(date) Failed to start $SERVICE_NAME.jar, return code: $rc\"\n    exit $rc;\nfi\n\ntail -f /dev/null\n\n\n\n\n# 200æœºå™¨ï¼Œä¿®æ”¹è´¦æˆ·å¯†ç ï¼š\nconfig]# cd /data/dockerfile/apollo-adminservice/config\nconfig]# vi application-github.properties\nspring.datasource.url = jdbc:mysql://mysql.od.com:3306/ApolloConfigDB?characterEncoding=utf8\nspring.datasource.username = apolloconfig\nspring.datasource.password = 123456\n~~~\n\n> [startup.shå®˜æ–¹åœ°å€](https://github.com/ctripcorp/apollo/blob/1.5.1/scripts/apollo-on-kubernetes/apollo-admin-server/scripts/startup-kubernetes.sh)\n>\n> ä¿®æ”¹å¤„ä¸ºï¼š\n>\n> SERVER_PORT=8080  # å› ä¸ºdockerç½‘ç»œç©ºé—´æ˜¯äº’ç›¸éš”ç¦»ï¼Œç”¨8080å³å¯\n>\n> APOLLO_ADMIN_SERVICE_NAME=$(hostname -i)\n\næ­¤å¤„ç”± â€œ**å—å®«ä¹˜é£**â€  è¡¥å……é…ç½®ä¿®æ”¹ ï¼šhttps://github.com/nangongchengfeng\n\n\n\n~~~\n# 200æœºå™¨ï¼Œåˆ¶ä½œdockerfileï¼š\ncd /data/dockerfile/apollo-adminservice\napollo-adminservice]# ll\napollo-adminservice]# vi Dockerfile\nFROM 909336740/jre8:8u112\n\nENV VERSION 1.5.1\n\nRUN ln -sf /usr/share/zoneinfo/Asia/Shanghai /etc/localtime &&\\\n    echo \"Asia/Shanghai\" > /etc/timezone\n\nADD apollo-adminservice-${VERSION}.jar /apollo-adminservice/apollo-adminservice.jar\nADD config/ /apollo-adminservice/config\nADD scripts/ /apollo-adminservice/scripts\n\nCMD [\"/apollo-adminservice/scripts/startup.sh\"]\n\napollo-adminservice]# docker build . -t harbor.od.com/infra/apollo-adminservice:v1.5.1\napollo-adminservice]# docker push harbor.od.com/infra/apollo-adminservice:v1.5.1\n~~~\n\n![1583207853169](assets/1583207853169.png)\n\n![1583219005442](assets/1583219005442.png)\n\nçœ‹ä»¥ä¸‹harborä»“åº“æœ‰æ²¡æœ‰\n\n![1583208050305](assets/1583208050305.png)\n\n##### é‡æ–°å¤ä¹ ä¸€ä¸‹äº¤ä»˜è¿‡ç¨‹ï¼šæå®šé•œåƒ-æå®šèµ„æºé…ç½®æ¸…å•-åº”ç”¨èµ„æºé…ç½®æ¸…å•\n\n~~~\n# 200æœºå™¨ï¼Œåˆ¶ä½œèµ„æºé…ç½®æ¸…å•ï¼š\nmkdir /data/k8s-yaml/apollo-adminservice\ncd /data/k8s-yaml/apollo-adminservice\napollo-adminservice]# vi cm.yaml\napiVersion: v1\nkind: ConfigMap\nmetadata:\n  name: apollo-adminservice-cm\n  namespace: infra\ndata:\n  application-github.properties: |\n    # DataSource\n    spring.datasource.url = jdbc:mysql://mysql.od.com:3306/ApolloConfigDB?characterEncoding=utf8\n    spring.datasource.username = apolloconfig\n    spring.datasource.password = 123456\n    eureka.service.url = http://config.od.com/eureka\n  app.properties: |\n    appId=100003172\n\napollo-adminservice]# vi dp.yaml\nkind: Deployment\napiVersion: extensions/v1beta1\nmetadata:\n  name: apollo-adminservice\n  namespace: infra\n  labels: \n    name: apollo-adminservice\nspec:\n  replicas: 1\n  selector:\n    matchLabels: \n      name: apollo-adminservice\n  template:\n    metadata:\n      labels: \n        app: apollo-adminservice \n        name: apollo-adminservice\n    spec:\n      volumes:\n      - name: configmap-volume\n        configMap:\n          name: apollo-adminservice-cm\n      containers:\n      - name: apollo-adminservice\n        image: harbor.od.com/infra/apollo-adminservice:v1.5.1\n        ports:\n        - containerPort: 8080\n          protocol: TCP\n        volumeMounts:\n        - name: configmap-volume\n          mountPath: /apollo-adminservice/config\n        terminationMessagePath: /dev/termination-log\n        terminationMessagePolicy: File\n        imagePullPolicy: IfNotPresent\n      imagePullSecrets:\n      - name: harbor\n      restartPolicy: Always\n      terminationGracePeriodSeconds: 30\n      securityContext: \n        runAsUser: 0\n      schedulerName: default-scheduler\n  strategy:\n    type: RollingUpdate\n    rollingUpdate: \n      maxUnavailable: 1\n      maxSurge: 1\n  revisionHistoryLimit: 7\n  progressDeadlineSeconds: 600\n~~~\n\n![1583208130534](assets/1583208130534.png)\n\n~~~\n# 22æœºå™¨ï¼Œåº”ç”¨èµ„æºé…ç½®æ¸…å•ï¼š\n~]# kubectl apply -f http://k8s-yaml.od.com/apollo-adminservice/cm.yaml\n~]# kubectl apply -f http://k8s-yaml.od.com/apollo-adminservice/dp.yaml\n~~~\n\n![1583217458560](assets/1583217458560.png)\n\n~~~\n# 11æœºå™¨ï¼ŒæŸ¥çœ‹æ•°æ®åº“è¿æ¥IPï¼š\n~]# mysql -uroot -p\nnone)]> show processlist;\n~~~\n\nå¤šäº†æ›´å¤šçš„22è¿æ¥\n\n![1583217487662](assets/1583217487662.png)\n\n[config.od.comè®¿é—®åœ°å€](config.od.com)\n\né¼ æ ‡å¯¹ç€èµ·æ¥çš„Apolloï¼Œå¯ä»¥çœ‹åˆ°å³ä¸‹è§’æœ‰ç½‘å€\n\n![1583217527372](assets/1583217527372.png)\n\n~~~\n# 22æœºå™¨ï¼Œcurlï¼š\n~]# curl http://172.7.22.7:8080/info\n~~~\n\n![1583217575749](assets/1583217575749.png)\n\n[^è¯¾å¤–é¢˜1]: äº¤ä»˜å®Œconfigå’Œadminåï¼Œæˆ‘ä»¬å‘ç°ï¼Œäº¤ä»˜åˆ°K8Sé‡Œé¢çš„æœåŠ¡å¦‚æ­¤ä¹‹å®¹æ˜“ï¼Œé‚£ä¹ˆé—®é¢˜æ¥äº†ï¼Œäº¤ä»˜åˆ°K8Så’Œäº¤ä»˜åˆ°ç‰©ç†æœºæˆ–è€…è™šæ‹Ÿæœºé‡Œï¼Œé‚£é‡Œæœ‰å¾ˆå¤§çš„åŒºåˆ«ï¼Œä¸ºä»€ä¹ˆK8Sæ›´å¥½ã€‚\n[^è¯¾å¤–é¢˜2]: å°è¯•ç”¨ç‚¹ç‚¹ç‚¹çš„æ–¹å¼åœ¨dashboardé‡Œé¢æ‰©å®¹adminserviceå’Œconfigservice\n\n\n\n### äº¤ä»˜Apollo-Portalå‰ï¼Œæ•°æ®åº“åˆå§‹åŒ–\n\n[å®˜ç½‘åœ°å€](https://github.com/ctripcorp/apollo/releases/tag/v1.5.1)\n\n~~~\n# 200æœºå™¨ï¼Œåˆ¶ä½œé•œåƒ-ä¸‹è½½åŒ…å¹¶æ•´ç†ï¼š\ncd /opt/src/\n~]# wget https://github.com/ctripcorp/apollo/releases/download/v1.5.1/apollo-portal-1.5.1-github.zip\nsrc]# mkdir /data/dockerfile/apollo-portal\nsrc]# unzip -o apollo-portal-1.5.1-github.zip -d /data/dockerfile/apollo-portal\nsrc]# cd /data/dockerfile/apollo-portal\napollo-portal]# rm -f apollo-portal-1.5.1-sources.jar\napollo-portal]# rm -f apollo-portal.conf\napollo-portal]# rm -f scripts/shutdown.sh\n~~~\n\n[sqlå®˜ç½‘ç½‘å€-éœ€è¦raw](https://github.com/ctripcorp/apollo/blob/master/scripts/apollo-on-kubernetes/db/portal-db/apolloportaldb.sql)\n\n**æ³¨æ„ï¼š**è¿™ä¸ªæ•°æ®åº“åœ°å€å·²ç»404\n\nå¯ä»¥å°è¯•ä½¿ç”¨è¿™ä¸ªæ•°æ®åº“åœ°å€ï¼šhttps://github.com/apolloconfig/apollo/blob/master/scripts/sql/apolloportaldb.sql\n\nç›¸å…³èµ„æ–™ï¼šhttps://www.apolloconfig.com/#/zh/deployment/distributed-deployment-guide?id=_21-%e5%88%9b%e5%bb%ba%e6%95%b0%e6%8d%ae%e5%ba%93\n\n~~~\n# 11æœºå™¨ï¼Œæ•°æ®åº“åˆå§‹åŒ–ï¼š\n~]# wget https://raw.githubusercontent.com/ctripcorp/apollo/master/scripts/apollo-on-kubernetes/db/portal-db/apolloportaldb.sql -O apolloportal.sql\n~]# ll\n~~~\n\n![1583217807056](assets/1583217807056.png)\n\n~~~\n# 11æœºå™¨ï¼š\n~]# mysql -uroot -p\nnone)]> source ./apolloportal.sql\nnone)]> show databases;\nnone)]> use ApolloPortalDB\nApolloportalDB]> show tables;\nApolloportalDB]> grant INSERT,DELETE,UPDATE,SELECT on ApolloPortalDB.* to \"apolloportal\"@\"10.4.7.%\" identified by \"123456\";\nApolloportalDB]> select user,host from mysql.user;\nApolloportalDB]> select * from ServerConfig\\G\nApolloportalDB]> update ServerConfig set Value='[{\"orgId\":\"ben01\",\"orgName\":\"Linuxå­¦é™¢\"},{\"orgId\":\"ben02\",\"orgName\":\"äº‘è®¡ç®—å­¦é™¢\"},{\"orgId\":\"ben03\",\"orgName\":\"Pythonå­¦é™¢\"}]' where Id=2;\nApolloportalDB]> select * from ServerConfig\\G\n~~~\n\n![1583217921425](assets/1583217921425.png)\n\nåŸ![1583217963849](assets/1583217963849.png)\n\næ”¹å\n\n![1583218104712](assets/1583218104712.png)\n\nå®Œæˆ\n\n\n\n### åˆ¶ä½œPortalçš„dockeré•œåƒï¼Œå¹¶äº¤ä»˜\n\n~~~\n# 200æœºå™¨ï¼Œæ›´æ–°startup:\ncd /data/dockerfile/apollo-portal/scripts/\n# å…¨éƒ¨åˆ æ‰æ¢æˆä¸‹é¢çš„\nscripts]# vi startup.sh\n#!/bin/bash\nSERVICE_NAME=apollo-portal\n## Adjust log dir if necessary\nLOG_DIR=/opt/logs/apollo-portal-server\n## Adjust server port if necessary\nSERVER_PORT=8080\nAPOLLO_PORTAL_SERVICE_NAME=$(hostname -i)\n# SERVER_URL=\"http://localhost:$SERVER_PORT\"\nSERVER_URL=\"http://${APOLLO_PORTAL_SERVICE_NAME}:${SERVER_PORT}\"\n\n## Adjust memory settings if necessary\n#export JAVA_OPTS=\"-Xms2560m -Xmx2560m -Xss256k -XX:MetaspaceSize=128m -XX:MaxMetaspaceSize=384m -XX:NewSize=1536m -XX:MaxNewSize=1536m -XX:SurvivorRatio=8\"\n\n## Only uncomment the following when you are using server jvm\n#export JAVA_OPTS=\"$JAVA_OPTS -server -XX:-ReduceInitialCardMarks\"\n\n########### The following is the same for configservice, adminservice, portal ###########\nexport JAVA_OPTS=\"$JAVA_OPTS -XX:ParallelGCThreads=4 -XX:MaxTenuringThreshold=9 -XX:+DisableExplicitGC -XX:+ScavengeBeforeFullGC -XX:SoftRefLRUPolicyMSPerMB=0 -XX:+ExplicitGCInvokesConcurrent -XX:+HeapDumpOnOutOfMemoryError -XX:-OmitStackTraceInFastThrow -Duser.timezone=Asia/Shanghai -Dclient.encoding.override=UTF-8 -Dfile.encoding=UTF-8 -Djava.security.egd=file:/dev/./urandom\"\nexport JAVA_OPTS=\"$JAVA_OPTS -Dserver.port=$SERVER_PORT -Dlogging.file=$LOG_DIR/$SERVICE_NAME.log -XX:HeapDumpPath=$LOG_DIR/HeapDumpOnOutOfMemoryError/\"\n\n# Find Java\nif [[ -n \"$JAVA_HOME\" ]] && [[ -x \"$JAVA_HOME/bin/java\" ]]; then\n    javaexe=\"$JAVA_HOME/bin/java\"\nelif type -p java > /dev/null 2>&1; then\n    javaexe=$(type -p java)\nelif [[ -x \"/usr/bin/java\" ]];  then\n    javaexe=\"/usr/bin/java\"\nelse\n    echo \"Unable to find Java\"\n    exit 1\nfi\n\nif [[ \"$javaexe\" ]]; then\n    version=$(\"$javaexe\" -version 2>&1 | awk -F '\"' '/version/ {print $2}')\n    version=$(echo \"$version\" | awk -F. '{printf(\"%03d%03d\",$1,$2);}')\n    # now version is of format 009003 (9.3.x)\n    if [ $version -ge 011000 ]; then\n        JAVA_OPTS=\"$JAVA_OPTS -Xlog:gc*:$LOG_DIR/gc.log:time,level,tags -Xlog:safepoint -Xlog:gc+heap=trace\"\n    elif [ $version -ge 010000 ]; then\n        JAVA_OPTS=\"$JAVA_OPTS -Xlog:gc*:$LOG_DIR/gc.log:time,level,tags -Xlog:safepoint -Xlog:gc+heap=trace\"\n    elif [ $version -ge 009000 ]; then\n        JAVA_OPTS=\"$JAVA_OPTS -Xlog:gc*:$LOG_DIR/gc.log:time,level,tags -Xlog:safepoint -Xlog:gc+heap=trace\"\n    else\n        JAVA_OPTS=\"$JAVA_OPTS -XX:+UseParNewGC\"\n        JAVA_OPTS=\"$JAVA_OPTS -Xloggc:$LOG_DIR/gc.log -XX:+PrintGCDetails\"\n        JAVA_OPTS=\"$JAVA_OPTS -XX:+UseConcMarkSweepGC -XX:+UseCMSCompactAtFullCollection -XX:+UseCMSInitiatingOccupancyOnly -XX:CMSInitiatingOccupancyFraction=60 -XX:+CMSClassUnloadingEnabled -XX:+CMSParallelRemarkEnabled -XX:CMSFullGCsBeforeCompaction=9 -XX:+CMSClassUnloadingEnabled  -XX:+PrintGCDateStamps -XX:+PrintGCApplicationConcurrentTime -XX:+PrintHeapAtGC -XX:+UseGCLogFileRotation -XX:NumberOfGCLogFiles=5 -XX:GCLogFileSize=5M\"\n    fi\nfi\n\nprintf \"$(date) ==== Starting ==== \\n\"\n\ncd `dirname $0`/..\nchmod 755 $SERVICE_NAME\".jar\"\n./$SERVICE_NAME\".jar\" start\n\nrc=$?;\n\nif [[ $rc != 0 ]];\nthen\n    echo \"$(date) Failed to start $SERVICE_NAME.jar, return code: $rc\"\n    exit $rc;\nfi\n\ntail -f /dev/null\n\n\n# 200æœºå™¨ï¼Œä¿®æ”¹è´¦æˆ·å¯†ç ï¼š\nconfig]# cd /data/dockerfile/apollo-portal/config\nconfig]# vi application-github.properties\nspring.datasource.url = jdbc:mysql://mysql.od.com:3306/ApolloPortalDB?characterEncoding=utf8\nspring.datasource.username = apolloportal\nspring.datasource.password = 123456\n\n\n~~~\n\n> [portal_startupå®˜ç½‘åœ°å€](https://github.com/ctripcorp/apollo/blob/1.5.1/scripts/apollo-on-kubernetes/apollo-portal-server/scripts/startup-kubernetes.sh)\n>\n> ä»…æœ‰ä»¥ä¸‹ä¸¤å¤„ä¸åŒï¼š\n>\n> SERVER_PORT=8080\n> APOLLO_PORTAL_SERVICE_NAME=$(hostname -i)\n\næ­¤å¤„ç”± â€œ**å—å®«ä¹˜é£**â€  è¡¥å……é…ç½®ä¿®æ”¹ ï¼šhttps://github.com/nangongchengfeng\n\n\n\n~~~\n# 200æœºå™¨ï¼Œåˆ¶ä½œdockerfileï¼š\ncd /data/dockerfile/apollo-portal/\napollo-portal]# vi Dockerfile\nFROM 909336740/jre8:8u112\n\nENV VERSION 1.5.1\n\nRUN ln -sf /usr/share/zoneinfo/Asia/Shanghai /etc/localtime &&\\\n    echo \"Asia/Shanghai\" > /etc/timezone\n\nADD apollo-portal-${VERSION}.jar /apollo-portal/apollo-portal.jar\nADD config/ /apollo-portal/config\nADD scripts/ /apollo-portal/scripts\n\nCMD [\"/apollo-portal/scripts/startup.sh\"]\n\napollo-portal]# docker build . -t harbor.od.com/infra/apollo-portal:v1.5.1\napollo-portal]# docker push harbor.od.com/infra/apollo-portal:v1.5.1\n~~~\n\n![1583218938233](assets/1583218938233.png)\n\n![1583219229803](assets/1583219229803.png)\n\n~~~\n# 200æœºå™¨ï¼š\nmkdir /data/k8s-yaml/apollo-portal\ncd /data/k8s-yaml/apollo-portal\napollo-portal]# vi cm.yaml\napiVersion: v1\nkind: ConfigMap\nmetadata:\n  name: apollo-portal-cm\n  namespace: infra\ndata:\n  application-github.properties: |\n    # DataSource\n    spring.datasource.url = jdbc:mysql://mysql.od.com:3306/ApolloPortalDB?characterEncoding=utf8\n    spring.datasource.username = apolloportal\n    spring.datasource.password = 123456\n  app.properties: |\n    appId=100003173\n  apollo-env.properties: |\n    dev.meta=http://config.od.com\n\napollo-portal]# vi dp.yaml\nkind: Deployment\napiVersion: extensions/v1beta1\nmetadata:\n  name: apollo-portal\n  namespace: infra\n  labels: \n    name: apollo-portal\nspec:\n  replicas: 1\n  selector:\n    matchLabels: \n      name: apollo-portal\n  template:\n    metadata:\n      labels: \n        app: apollo-portal \n        name: apollo-portal\n    spec:\n      volumes:\n      - name: configmap-volume\n        configMap:\n          name: apollo-portal-cm\n      containers:\n      - name: apollo-portal\n        image: harbor.od.com/infra/apollo-portal:v1.5.1\n        ports:\n        - containerPort: 8080\n          protocol: TCP\n        volumeMounts:\n        - name: configmap-volume\n          mountPath: /apollo-portal/config\n        terminationMessagePath: /dev/termination-log\n        terminationMessagePolicy: File\n        imagePullPolicy: IfNotPresent\n      imagePullSecrets:\n      - name: harbor\n      restartPolicy: Always\n      terminationGracePeriodSeconds: 30\n      securityContext: \n        runAsUser: 0\n      schedulerName: default-scheduler\n  strategy:\n    type: RollingUpdate\n    rollingUpdate: \n      maxUnavailable: 1\n      maxSurge: 1\n  revisionHistoryLimit: 7\n  progressDeadlineSeconds: 600\n\napollo-portal]# vi svc.yaml\nkind: Service\napiVersion: v1\nmetadata: \n  name: apollo-portal\n  namespace: infra\nspec:\n  ports:\n  - protocol: TCP\n    port: 8080\n    targetPort: 8080\n  selector: \n    app: apollo-portal\n\napollo-portal]# vi ingress.yaml\nkind: Ingress\napiVersion: extensions/v1beta1\nmetadata: \n  name: apollo-portal\n  namespace: infra\nspec:\n  rules:\n  - host: portal.od.com\n    http:\n      paths:\n      - path: /\n        backend: \n          serviceName: apollo-portal\n          servicePort: 8080\n~~~\n\n![1583219397807](assets/1583219397807.png)\n\n~~~\n# 11æœºå™¨ï¼Œè§£æåŸŸåï¼š\n~]# vi /var/named/od.com.zone\nserial å‰æ»šä¸€ä½\nportal             A    10.4.7.10\n\n~]# systemctl restart named\n~]# dig -t A portal.od.com @10.4.7.11 +short\n# out: 10.4.7.10\n~~~\n\n![1583219385915](assets/1583219385915.png)\n\n~~~\n# 22æœºå™¨ï¼Œåº”ç”¨èµ„æºé…ç½®æ¸…å•ï¼š\n~]# kubectl apply -f http://k8s-yaml.od.com/apollo-portal/cm.yaml\n~]# kubectl apply -f http://k8s-yaml.od.com/apollo-portal/dp.yaml\n~]# kubectl apply -f http://k8s-yaml.od.com/apollo-portal/svc.yaml\n~]# kubectl apply -f http://k8s-yaml.od.com/apollo-portal/ingress.yaml\n~~~\n\nå¯ä»¥æŸ¥çœ‹èµ·æ¥çš„portalçš„logsæ—¥å¿—ï¼Œå¯èƒ½ç¨å¾®æœ‰äº›æ…¢\n\n[æµè§ˆå™¨è¾“å…¥portal.od.com](portal.od.com)\n\n```\nUsername: apollo\nPassword: admin\n```\n\n![1583221254589](assets/1583221254589.png)\n\n> ç¬¬ä¸€ä»¶äº‹ï¼Œä¿®æ”¹å¯†ç ï¼Œä»»ä½•å¼€æºè½¯ä»¶çš„ç¬¬ä¸€ä»¶äº‹ï¼Œå°±æ˜¯ä¿®æ”¹é»˜è®¤å¯†ç \n>\n\n![1584699514174](assets/1584699514174.png)\n\n![1583221587411](assets/1583221587411.png)\n\n![1583222001345](assets/1583222001345.png)\n\nå»çœ‹ä¸€ä¸‹å¯¹æ¥æ•°æ®åº“æƒ…å†µ\n\n![1583222020754](assets/1583222020754.png)\n\n~~~\n\n~~~\n\nè¯•è¯•æŸ¥è¯¢ï¼ŒæŸ¥è¯¢keyï¼Œä¹Ÿè¯•è¯•ä½¿ç”¨ä¿å­˜æ›´æ–°\n\n~~~\nkey:organizations\nvalue:[{\"orgId\":\"ben01\",\"orgName\":\"Linuxå­¦é™¢\"},{\"orgId\":\"ben02\",\"orgName\":\"äº‘è®¡ç®—å­¦é™¢\"},{\"orgId\":\"ben03\",\"orgName\":\"Pythonå­¦é™¢\"},{\"orgId\":\"ben03\",\"orgName\":\"å¤§æ•°æ®å­¦é™¢\"}]\n~~~\n\n![1583222152917](assets/1583222152917.png)\n\n~~~\n# 11æœºå™¨ï¼ŒæŸ¥è¯¢æ˜¯å¦æ›´æ–°ï¼š\n~]# mysql -uroot -p\nnone)]> use ApolloPortalDB;\nApolloPortalDB]> select * from ServerConfig\\G\n~~~\n\n![1583222202986](assets/1583222202986.png)\n\næˆåŠŸ\n\nä½¿ç”¨Apolloï¼Œåˆ›å»ºé¡¹ç›®ï¼Œæäº¤\n\n![1583222246074](assets/1583222246074.png)\n\n~~~\n# å¡«å…¥å¯¹åº”å‚æ•°ï¼Œå¹¶æäº¤ï¼š\nAppId:dubbo-demo-service\n~~~\n\n![1583222350430](assets/1583222350430.png)\n\n![1583222393771](assets/1583222393771.png)\n\nå®Œæˆ\n\n\n\n### dubboæœåŠ¡æä¾›è€…è¿æ¥Apolloå®æˆ˜\n\né¦–å…ˆæˆ‘ä»¬åœ¨gitæ–°å»ºä¸€ä¸ªApolloåˆ†æ”¯ï¼Œä»¥ä¸‹æ˜¯æ“ä½œæ–¹æ³•\n\nå»ºè®®ç›´æ¥ä½¿ç”¨å…¬ç½‘çš„ https://gitee.com/benjas/dubbo-demo-service.git æˆ–è€…æ‹·è´ä¸€ä»½\n\n**gitåˆ›å»ºåˆ†æ”¯å¹¶ä¸Šä¼ ä»£ç ï¼ˆæˆ–è€…ç›´æ¥forkæˆ‘ï¼‰ï¼Œæ³¨æ„ï¼Œä¸‹å›¾é…çš„æ˜¯gitlabé‡Œé¢webçš„ï¼Œç°åœ¨ä½ è¦æ“ä½œçš„æ˜¯è‡ªå·±gitçš„serviceï¼Œå› ä¸ºserviceæ²¡æˆªå›¾ï¼Œæ‰€ä»¥æˆ‘ç”¨webçš„æ›¿ä»£**\n\n1. åˆ‡æ¢èº«ä»½\n\n   ~~~\n   # ä¸Šä¼ é¡¹ç›®çš„æ–‡ä»¶å¤¹æ‰“å¼€ï¼Œç„¶åcdåˆ°é™„è¿‘çš„æ–°å»ºçš„apolloæ–‡ä»¶å¤¹ï¼Œå…‹éš†é¡¹ç›®å¹¶åˆ‡æ¢èº«ä»½ï¼š\n   $ git http://gitlab.od.com:10000/909336740/dubbo-demo-web.git\n   $ cd dubbo-demo-web/\n   $ git branch apollo\n   $ git checkout apollo\n   ~~~\n\n   ![1583287244483](assets/1583287244483.png)\n\n   å°†Apolloåˆ†æ”¯çš„æ–‡ä»¶å…¨éƒ¨æ‹‰æ¥è¿™ä¸ªæ–‡ä»¶å¤¹ï¼Œé€‰æ‹©æ›¿æ¢é‡åæ–‡ä»¶\n\n   ![1583287180864](assets/1583287180864.png)\n\n2. æŠŠapolloçš„ä»£ç å…¨éƒ¨æ‹‰è¿‡å»è¦†ç›–ï¼Œå¹¶ä¸Šä¼ ä»£ç \n\n   ~~~\n   $ git add .\n   $ git commit -m \"apollo commit#1\"\n   $ git push -u origin apollo\n   ~~~\n\n   ![1583287633875](assets/1583287633875.png)\n\n   ![1582680560428](assets/1582680560428.png)\n\n   å®Œæˆï¼Œå½“ç„¶ä½ å¯ä»¥ç›´æ¥forkæˆ‘çš„\n\n   ![1582680588102](assets/1582680588102.png)\n\n\n\n#### ç»§ç»­ä¸»çº¿\n\nå»ºè®®ç›´æ¥ä½¿ç”¨å…¬ç½‘çš„ https://gitee.com/benjas/dubbo-demo-service.git æˆ–è€…æ‹·è´ä¸€ä»½\n\nåœ¨Apollo portalé‡Œåˆ›å»ºç›¸åº”ä¸¤ä¸ªé…ç½®é¡¹ï¼ˆæ³¨æ„çœ‹æ¸…ä½ç½®ï¼Œæ˜¯ ï¼šresources ä¸‹çš„ï¼‰\n\n![1582680643369](assets/1582680643369.png)\n\næ–°å¢é…ç½®é¡¹ï¼Œå¹¶æäº¤\n\n![1583223092507](assets/1583223092507.png)\n\n![1583223148433](assets/1583223148433.png)\n\nå‘å¸ƒ\n\n![1583223168662](assets/1583223168662.png)\n\n![1583223190037](assets/1583223190037.png)\n\næˆ‘ä»¬å·²ç»é…ç½®å¥½äº†ï¼Œç„¶åéœ€è¦ç”¨Jenkinsåˆ¶ä½œé•œåƒ\n\nå»ºè®®ç›´æ¥ä½¿ç”¨å…¬ç½‘çš„ https://gitee.com/benjas/dubbo-demo-service.git æˆ–è€…æ‹·è´ä¸€ä»½\n\n~~~\n# å¡«å…¥å¯¹åº”å‚æ•°\napp_name: dubbo-demo-service\nimage_name: app/dubbo-demo-service\ngit_repo: https://gitee.com/benjas/dubbo-demo-service.git\ngit_ver: apollo\nadd_tag: 200303_1615\ntarget_dir: ./dubbo-server/target\nbase_image: base/jre8:8u112\n~~~\n\n> æ³¨æ„ï¼Œæˆ‘è¿™é‡Œç”¨çš„æ˜¯gitlabï¼Œå› ä¸ºç½‘ç»œé—®é¢˜ï¼Œä½ ç”¨è‡ªå·±çš„å…¬ç½‘gitå³å¯\n\n![1583223413973](assets/1583223413973.png)\n\nå»#38çš„consoleé‡ŒæŸ¥çœ‹æƒ…å†µ\n\n![1583223612917](assets/1583223612917.png)\n\n#### æŠ¥é”™é—®é¢˜ï¼š\n\n![1581324514061](assets/1581324514061.png)\n\nè¯¥æŠ¥é”™çš„åŸå› æ˜¯mirrorsæ²¡æœ‰æ”¹å¯¹\n\n~~~\n# 200æœºå™¨ï¼š\ncd /data/nfs-volume/jenkins_home/maven-3.6.1-8u232/conf\nconf]# vi settings.xml\n~~~\n\nä¿®æ”¹å®Œä¸Šé¢çš„å†…å®¹åä¿å­˜å†å»é‡æ–°æ„å»º\n\n\n\n#### ç»§ç»­ä¸»çº¿\n\n![1583223754285](assets/1583223754285.png)\n\né•œåƒåˆ¶ä½œå®Œæˆ\n\n~~~\n# 200æœºå™¨ï¼Œä¿®æ”¹æŒ‡å®šçš„é•œåƒï¼Œå¹¶æ·»åŠ éƒ¨åˆ†å†…å®¹ï¼š\ncd /data/k8s-yaml/dubbo-demo-service/\ndubbo-demo-service]# vi dp.yaml\n        image: harbor.od.com/app/dubbo-demo-service:apollo_200303_1615\n        ports:\n        - containerPort: 20880\n          protocol: TCP\n        env:\n        - name: JAR_BALL\n          value: dubbo-server.jar\n        - name: C_OPTS\n          value: -Denv=dev -Dapollo.meta=http://config.od.com\n        imagePullPolicy: IfNotPresent\n~~~\n\n![1583223916007](assets/1583223916007.png)\n\n~~~\n# 22æœºå™¨ï¼Œåº”ç”¨ï¼š\n~]# kubectl apply -f http://k8s-yaml.od.com/dubbo-demo-service/dp.yaml\n# out: deployment.extensions/dubbo-demo-service configured\n~~~\n\n![1583224029500](assets/1583224029500.png)\n\nå»LOGSæŸ¥çœ‹ï¼Œå¯ä»¥çœ‹åˆ°è¿æ¥äº†Apollo\n\n![1583227298634](assets/1583227298634.png)\n\n> PSï¼šè¿™é‡Œçš„podåå­—ä½ å¯èƒ½è§‰å¾—ä¸ä¸€æ ·ï¼Œå› ä¸ºæˆ‘é•œåƒå¼„é”™äº†ï¼Œé‡æ–°æ”¹äº†ä¸€é\n\n![1583227711909](assets/1583227711909.png)\n\nå½“ä½ æŠŠserviceæ‰©å®¹æˆä¸¤ä¸ªå\n\n![1583227780562](assets/1583227780562.png)\n\nå¯ä»¥çœ‹åˆ°å˜æˆä¸¤ä¸ªå®ä¾‹\n\n![1583227821344](assets/1583227821344.png)\n\nåœ¨monitoré‡Œå¯ä»¥çœ‹åˆ°ç«¯å£æ˜¯20880ï¼ˆæ³¨æ„å¿…é¡»è¿æ¥çš„æ˜¯zk1ï¼Œæ€ä¹ˆä¿®æ”¹ä¸Šé¢æœ‰ï¼Œå…ˆæ”¹cmï¼Œç„¶ååˆ æ‰podè®©å®ƒè‡ªåŠ¨é‡å¯ï¼‰\n\n![1583229093925](assets/1583229093925.png)\n\n![1583229141970](assets/1583229141970.png)\n\næˆ‘ä»¬å»Apolloæ”¹ä¸€ä¸‹ç«¯å£ï¼Œæ”¹æˆ20881ï¼Œå¹¶å‘å¸ƒ\n\n![1583229265526](assets/1583229265526.png)\n\n![1583229275645](assets/1583229275645.png)\n\né‡å¯ä¸¤ä¸ªserviceçš„podsï¼ˆå°±æ˜¯åˆ æ‰è®©å®ƒä»¬è‡ªåŠ¨é‡å¯ï¼‰\n\n![1583229312442](assets/1583229312442.png)\n\nåˆ·æ–°dubbo-monitorï¼Œå¯ä»¥çœ‹åˆ°ç«¯å£å·²ç»å˜æˆ20881\n\n![1583229337601](assets/1583229337601.png)\n\nè¿˜å¯ä»¥æ”¹æˆzk2\n\n![1583229498782](assets/1583229498782.png)\n\n> ä½œä¸šï¼šæ”¹æˆzk2åï¼Œéœ€è¦åˆ æ‰å¯¹åº”çš„podï¼Œç„¶åè®©å…¶ä¹Ÿåœ¨zk2ï¼Œç„¶åè¿˜éœ€è¦æŠŠmonitorä¹Ÿæ”¹æˆzk2ï¼Œæ–¹æ³•åœ¨ä¸Šé¢æœ‰ã€‚è¿™ä¸ªä½œä¸šä¸€å®šè¦åšï¼Œä¸ç„¶ä¸‹é¢ä¼šæŠ¥é”™ï¼Œå…·ä½“æ˜¯å“ªé‡ŒæŠ¥é”™æˆ‘ä¼šæç¤º\n\næœ€åæˆ‘æ”¹å›æ¥äº†20880ç«¯å£ï¼Œä½†æ˜¯ä¾ç„¶ç”¨çš„zk2\n\nå®Œæˆ\n\n\n\n### dubboæœåŠ¡æ¶ˆè´¹è€…è¿æ¥Apolloå®æˆ˜\n\nåŒæ ·ï¼Œæˆ‘æ˜¯æœ‰Apolloåˆ†æ”¯çš„ï¼Œæ“ä½œæ–¹æ³•å’Œä¸Šé¢çš„serviceæœåŠ¡ä¸€æ ·\n\n![1582682538181](assets/1582682538181.png)\n\nåˆ›å»ºé¡¹ç›®\n\n![1583287914567](assets/1583287914567.png)\n\næ–°å¢é…ç½®ï¼Œå¹¶å‘å¸ƒ\n\n![1583289334584](assets/1583289334584.png)\n\n![1583289365597](assets/1583289365597.png)\n\nç”¨Jenkinsæ„å»ºdubboæ¶ˆè´¹è€…\n\n~~~\n# å¡«å…¥å¯¹åº”å‚æ•°\napp_name: dubbo-demo-consumer\nimage_name: app/dubbo-demo-consumer\ngit_repo: http://gitlab.od.com:10000/909336740/dubbo-demo-web.git\ngit_ver: apollo\nadd_tag: 200304_1040\ntarget_dir: ./dubbo-client/target\nbase_image: base/jre8:8u112\n~~~\n\n> æ³¨æ„ï¼Œæˆ‘è¿™é‡Œç”¨çš„æ˜¯gitlabï¼Œå› ä¸ºç½‘ç»œé—®é¢˜ï¼Œä½ ç”¨è‡ªå·±çš„å…¬ç½‘gitå³å¯\n\n![1583290002445](assets/1583290002445.png)\n\n![1583290022279](assets/1583290022279.png)\n\n![1583290134412](assets/1583290134412.png)\n\n~~~\n# 200æœºå™¨ï¼Œä¿®æ”¹é…ç½®ï¼š\ncd /data/k8s-yaml/dubbo-demo-consumer/\ndubbo-demo-consumer]# vi dp.yaml\n        image: harbor.od.com/app/dubbo-demo-consumer:apollo_200304_1040\n        ports:\n        - containerPort: 8080\n          protocol: TCP\n        - containerPort: 20880\n          protocol: TCP\n        env:\n        - name: JAR_BALL\n          value: dubbo-client.jar\n        - name: C_OPTS\n          value: -Denv=dev -Dapollo.meta=http://config.od.com\n        imagePullPolicy: IfNotPresent\n~~~\n\n![1583290251350](assets/1583290251350.png)\n\n~~~\n# åº”ç”¨èµ„æºé…ç½®æ¸…å•ï¼Œ22æœºå™¨ï¼š\n~]# kubectl apply -f http://k8s-yaml.od.com/dubbo-demo-consumer/dp.yaml\n# out: deployment.extensions/dubbo-demo-consumer configured\n~~~\n\n![1583290331910](assets/1583290331910.png)\n\n![1583291244653](assets/1583291244653.png)\n\nå†å»Applicationså¯ä»¥çœ‹åˆ°å·²ç»èµ·æ¥äº†\n\n~~~\n# æµè§ˆå™¨è®¿é—®demo.od.com/hello?name=apollo\n~~~\n\n![1583291263893](assets/1583291263893.png)\n\n> å¦‚æœä½ ç™»å½•çš„æ˜¯è¿™ä¸ªç•Œé¢ï¼Œé‚£ä¹ˆä½ æ²¡æœ‰åšä½œä¸šï¼šæ”¹serviceçš„zk1æˆzk2ï¼Œè¿™ä¸ªconsumerå·²ç»æ˜¯zk2çš„ï¼Œè€Œserviceè¿˜æ˜¯zk1ï¼Œå½“ç„¶ä¸èƒ½å“åº”\n>\n> ![1583290792208](assets/1583290792208.png)\n\n\n\n#### å®ç°ä»£ç è¿­ä»£\n\nä¿®æ”¹ä»£ç ï¼Œç„¶åcommit\n\n![1582682749719](assets/1582682749719.png)\n\n![1582682870930](assets/1582682870930.png)\n\nJenkinsæ„å»º\n\n~~~\n# å¡«å…¥å¯¹åº”å‚æ•°\napp_name: dubbo-demo-consumer\nimage_name: app/dubbo-demo-consumer\ngit_repo: http://gitlab.od.com:10000/909336740/dubbo-demo-web.git\ngit_ver: apollo\nadd_tag: 200304_1145\ntarget_dir: ./dubbo-client/target\nbase_image: base/jre8:8u112\n~~~\n\n> æ³¨æ„ï¼Œæˆ‘è¿™é‡Œç”¨çš„æ˜¯gitlabï¼Œå› ä¸ºç½‘ç»œé—®é¢˜ï¼Œä½ ç”¨è‡ªå·±çš„å…¬ç½‘gitå³å¯\n\n![1583293563142](assets/1583293563142.png)\n\n![1583293832408](assets/1583293832408.png)\n\n~~~\n# 200æœºå™¨ä¿®æ”¹ä½¿ç”¨çš„é•œåƒï¼š\ncd /data/k8s-yaml/dubbo-demo-consumer/\ndubbo-demo-consumer]# vi dp.yaml\nimage: harbor.od.com/app/dubbo-demo-consumer:apollo_200304_1145\n~~~\n\n\n\n~~~\n# 22æœºå™¨åº”ç”¨ï¼š\n~]# kubectl apply -f http://k8s-yaml.od.com/dubbo-demo-consumer/dp.yaml\n# out: deployment.extensions/dubbo-demo-consumer configured\n~~~\n\n![1583294170202](assets/1583294170202.png)\n\n~~~\n# æµè§ˆå™¨è®¿é—®demo.od.com/hello?name=apollo\n~~~\n\n![1583294184192](assets/1583294184192.png)\n\n\n\n### å®æˆ˜Apolloåˆ†ç¯å¢ƒç®¡ç†dubboæœåŠ¡-äº¤ä»˜Apollo-configservice\n\n> æˆ‘ä»¬è¦å®ç°æµ‹è¯•ç¯å¢ƒå’Œç”Ÿäº§ç¯å¢ƒåªéœ€è¦æ‰“åŒ…ä¸€ä¸ªé•œåƒ\n>\n\nå…ˆå¼€å§‹åˆ†ç¯å¢ƒ\n\n~~~\n# 11æœºå™¨ï¼Œè§£æåŸŸåï¼š\n~]# vi /var/named/od.com.zone\nserial å‰æ»šä¸€ä½\nzk-test            A    10.4.7.11\nzk-prod            A    10.4.7.12\n\n~]# systemctl restart named\n~]# dig -t A zk-test.od.com +short\n# out: 10.4.7.11\n~]# dig -t A zk-prod.od.com +short\n# out: 10.4.7.12\n~~~\n\nå…³é—­deploymenté‡Œçš„æ¶ˆè´¹è€…å’ŒæœåŠ¡è€…ï¼ˆæ”¹æˆscale 0ï¼Œå…ˆæ¶ˆè´¹è€…åæœåŠ¡è€…ï¼‰\n\n![1583301119606](assets/1583301119606.png)\n\n~~~\n# åˆ›å»ºä¸¤ä¸ªåç§°ç©ºé—´ï¼Œ 21æœºå™¨ï¼š\n~]# kubectl create ns test\n# out:namespace/test created\n~]# kubectl create secret docker-registry harbor --docker-server=harbor.od.com --docker-username=admin --docker-password=Harbor12345 -n test\n# out:secret/harbor created\n~]# kubectl create ns prod\n# out:namespace/prod created\n~]# kubectl create secret docker-registry harbor --docker-server=harbor.od.com --docker-username=admin --docker-password=Harbor12345 -n prod\n# out:secret/harbor created\n~~~\n\n![1583301237979](assets/1583301237979.png)\n\nå»çœ‹ä¸€ä¸‹dashboardé‡Œé¢çš„Namespaces\n\n![1583301259487](assets/1583301259487.png)\n\næŠŠadminã€portalã€configéƒ½scaleæˆ0\n\n![1583301320962](assets/1583301320962.png)\n\n~~~\n# 11æœºå™¨ï¼Œå»ºåº“ï¼š\n~]# vi apolloconfig.sql\n# å¢åŠ Testå…³é”®å­—\n~~~\n\n![1583301385286](assets/1583301385286.png)\n\n~~~\n# 11æœºå™¨ï¼Œæµ‹è¯•ç¯å¢ƒï¼š\n~]# mysql -uroot -p < apolloconfig.sql\n~]# mysql -uroot -p\nnone)]> show databases;\nnone)]> use ApolloConfigTestDB;\nApolloConfigTestDB]> select * from ServerConfig\\G\nApolloConfigTestDB]> update ApolloConfigTestDB.ServerConfig set ServerConfig.Value=\"http://config-test.od.com/eureka\" where ServerConfig.Key=\"eureka.service.url\";\nApolloConfigTestDB]> select * from ServerConfig\\G\nApolloConfigTestDB]> grant INSERT,DELETE,UPDATE,SELECT on ApolloConfigTestDB.* to \"apolloconfig\"@\"10.4.7.%\" identified by \"123456\";\n~~~\n\n![1583301481115](assets/1583301481115.png)\n\n~~~\n# 11æœºå™¨ï¼Œç”Ÿäº§ç¯å¢ƒï¼š\n~]# vi apolloconfig.sql\n# ä¿®æ”¹æˆProdå…³é”®å­—\n~]# mysql -uroot -p < apolloconfig.sql\n~]# mysql -uroot -p\nnone)]> show databases;\nnone)]> use ApolloConfigProdDB;\nApolloConfigProdDB]> select * from ServerConfig\\G\nApolloConfigProdDB]> update ApolloConfigProdDB.ServerConfig set ServerConfig.Value=\"http://config-prod.od.com/eureka\" where ServerConfig.Key=\"eureka.service.url\";\nApolloConfigProdDB]> select * from ServerConfig\\G\nApolloConfigProdDB]> grant INSERT,DELETE,UPDATE,SELECT on ApolloConfigProdDB.* to \"apolloconfig\"@\"10.4.7.%\" identified by \"123456\";\n~~~\n\n![1583301626767](assets/1583301626767.png)\n\n~~~~\n# 11æœºå™¨ï¼Œä¿®æ”¹æ”¯æŒç±»å‹ï¼š\nnone)]> use ApolloPortalDB;\nApolloPortalDB]> show tables;\nApolloPortalDB]> select * from ServerConfig\\G\nApolloPortalDB]> update ServerConfig set Value='fat,pro' where Id=1;\nApolloPortalDB]> select * from Serverconfig\\G\n~~~~\n\næ”¹å\n\n![1583302030474](assets/1583302030474.png)\n\n> PSæŒ‰ç†æ¥è¯´ä½ åº”è¯¥åªæœ‰devï¼Œä½†æ˜¯å¥½åƒApolloæ›´æ–°äº†ï¼Œä¸€å¼€å§‹å°±æœ‰4ç§æ”¯æŒçš„ç±»å‹ï¼Œåªè¦ä½ ç¡®ä¿æœ‰fatå’Œproå³å¯\n\n~~~\n# 200æœºå™¨ï¼š\ncd /data/k8s-yaml/apollo-portal/\n# éœ€æ”¹ä»¥ä¸‹å†…å®¹\napollo-portal]# vi cm.yaml\n  apollo-env.properties: |\n    fat.meta=http://config-test.od.com\n    pro.meta=http://config-prod.od.com\n~~~\n\n![1583302159311](assets/1583302159311.png)\n\n~~~\n# 22æœºå™¨ï¼Œåº”ç”¨ï¼š\n~]# kubectl apply -f http://k8s-yaml.od.com/apollo-portal/cm.yaml\n# out: configmap/apollo-portal configured\n~~~\n\n![1583302232037](assets/1583302232037.png)\n\nå®Œæˆ\n\n\n\n### å®æˆ˜ä½¿ç”¨Apolloåˆ†ç¯å¢ƒç®¡ç†dubboæœåŠ¡â€”â€”äº¤ä»˜Apollo-portalå’Œadminservice\n\n~~~\n# åˆ¶ä½œèµ„æºé…ç½®æ¸…å•,200æœºå™¨ï¼š\ncd /data/k8s-yaml/\nk8s-yaml]# mkdir -pv test/{apollo-configservice,apollo-adminservice,dubbo-demo-service,dubbo-demo-consumer}\nk8s-yaml]# mkdir -pv prod/{apollo-configservice,apollo-adminservice,dubbo-demo-service,dubbo-demo-consumer}\nk8s-yaml]# cd test/apollo-configservice/\napollo-configservice]# cp -a /data/k8s-yaml/apollo-configservice/cm.yaml .\napollo-configservice]# cp -a /data/k8s-yaml/apollo-configservice/svc.yaml .\napollo-configservice]# cp -a /data/k8s-yaml/apollo-configservice/dp.yaml .\napollo-configservice]# cp -a /data/k8s-yaml/apollo-configservice/ingress.yaml .\n# ä¿®æ”¹æˆtestï¼Œä¸‰å¤„\napollo-configservice]# vi cm.yaml\n  namespace: test\n    spring.datasource.url = jdbc:mysql://mysql.od.com:3306/ApolloConfigTestDB?characterEncoding=utf8\n    spring.service.url = http://config-test.od.com/eureka\n\n# ä¿®æ”¹æˆtestï¼Œä¸€å¤„\napollo-configservice]# vi dp.yaml\n  namespace: test\n\n# ä¿®æ”¹æˆtestï¼Œä¸€å¤„\napollo-configservice]# vi svc.yaml\n  namespace: test\n\n# ä¿®æ”¹æˆtestï¼Œä¸¤å¤„\napollo-configservice]# vi ingress.yaml\n  namespace: test\n  - host: config-test.od.com\n~~~\n\n\n\n~~~\n# 11æœºå™¨ï¼Œè§£æåŸŸåï¼š\n~]# vi /var/named/od.com.zone\nserial å‰æ»šä¸€ä½\nconfig-test        A    10.4.7.10\nconfig-prod        A    10.4.7.10\n\n~]# systemctl restart named\n~~~\n\n![1582683284142](assets/1582683284142.png)\n\n~~~\n# åº”ç”¨èµ„æºé…ç½®æ¸…å•ï¼Œ22æœºå™¨ï¼š\n~]# kubectl apply -f http://k8s-yaml.od.com/test/apollo-configservice/cm.yaml\n~]# kubectl apply -f http://k8s-yaml.od.com/test/apollo-configservice/dp.yaml\n~]# kubectl apply -f http://k8s-yaml.od.com/test/apollo-configservice/svc.yaml\n~]# kubectl apply -f http://k8s-yaml.od.com/test/apollo-configservice/ingress.yaml\n~~~\n\n\n\n~~~~\n# 200æœºå™¨ï¼Œåˆ¶ä½œprodçš„ï¼š\ncd /data/k8s-yaml/prod/apollo-configservice/\napollo-configservice]# cp ../../test/apollo-configservice/*.yaml .\n# ä¿®æ”¹æˆprodï¼Œä¸‰å¤„\napollo-configservice]# vi cm.yaml\n  namespace: prod\n    spring.datasource.url = jdbc:mysql://mysql.od.com:3306/ApolloConfigProdDB?characterEncoding=utf8\n    spring.service.url = http://config-prod.od.com/eureka\n\n# ä¿®æ”¹æˆprodï¼Œä¸€å¤„\napollo-configservice]# vi dp.yaml\n  namespace: prod\n\n# ä¿®æ”¹æˆprodï¼Œä¸€å¤„\napollo-configservice]# vi svc.yaml\n  namespace: prod\n\n# ä¿®æ”¹æˆprodï¼Œä¸¤å¤„\napollo-configservice]# vi ingress.yaml\n  namespace: prod\n  - host: config-prod.od.com\n~~~~\n\n\n\n~~~~\n# åº”ç”¨èµ„æºæ¸…å•ï¼Œ22æœºå™¨ï¼š\n~]# kubectl apply -f http://k8s-yaml.od.com/prod/apollo-configservice/cm.yaml\n~]# kubectl apply -f http://k8s-yaml.od.com/prod/apollo-configservice/dp.yaml\n~]# kubectl apply -f http://k8s-yaml.od.com/prod/apollo-configservice/svc.yaml\n~]# kubectl apply -f http://k8s-yaml.od.com/prod/apollo-configservice/ingress.yaml\n~~~~\n\n![1581347383718](assets/1581347383718.png)\n\nç¡®è®¤ä½ çš„nslookup.exe æœ‰æ²¡æœ‰ï¼ˆä¸€èˆ¬æ˜¯æœ‰çš„ï¼‰\n\n![1581347525407](assets/1581347525407.png)\n\n~~~\n# è®¿é—®config-test.od.com\nconfig.od.comå·²ç»æ²¡äº†\n~~~\n\n![1583304944456](assets/1583304944456.png)\n\n~~~~\n# è®¿é—®config-prod.od.com\nprodå¯èƒ½è¿˜æ²¡å¥½ï¼Œæ¥ç€å¾€ä¸‹é¢åšï¼Œtestèƒ½èµ·æ¥ï¼Œprodè‚¯å®šä¹Ÿèƒ½èµ·æ¥\n~~~~\n\n![1583304959338](assets/1583304959338.png)\n\n> å¯ä»¥çœ‹åˆ°testå’Œprodåœ¨ä¸¤ä¸ªä¸åŒçš„å®¹å™¨é‡Œï¼Œè¿™å°±æ˜¯æˆ‘ä»¬æ¨¡æ‹Ÿçš„åˆ†ç¯å¢ƒ\n\n~~~\n# 200æœºå™¨ï¼š\ncd /data/k8s-yaml/test/apollo-adminservice/\napollo-adminservice]# cp -a /data/k8s-yaml/apollo-adminservice/*.yaml .\n# ä¿®æ”¹æˆtestï¼Œä¸‰å¤„\napollo-adminservice]# vi cm.yaml\n  namespace: test\n    spring.datasource.url = jdbc:mysql://mysql.od.com:3306/ApolloConfigTestDB?\n    spring.service.url = http://config-test.od.com/eureka\n\n# ä¿®æ”¹æˆtestï¼Œä¸€å¤„\napollo-adminservice]# vi dp.yaml\n  namespace: test\n\napollo-adminservice]# cd ../../prod/apollo-adminservice\napollo-adminservice]# cp -a ../../test/apollo-adminservice/*.yaml .\n# ä¿®æ”¹æˆprodï¼Œä¸‰å¤„\napollo-adminservice]# vi cm.yaml\n  namespace: prod\n    spring.datasource.url = jdbc:mysql://mysql.od.com:3306/ApolloConfigProdDB?characterEncoding=utf8\n    spring.service.url = http://config-prod.od.com/eureka\n\n# ä¿®æ”¹æˆprodï¼Œä¸€å¤„\napollo-adminservice]# vi dp.yaml\n  namespace: prod\n~~~\n\n\n\n~~~\n# åº”ç”¨ï¼Œ22æœºå™¨ï¼š\n~]# kubectl apply -f http://k8s-yaml.od.com/test/apollo-adminservice/cm.yaml\n~]# kubectl apply -f http://k8s-yaml.od.com/test/apollo-adminservice/dp.yaml\n~]# kubectl apply -f http://k8s-yaml.od.com/prod/apollo-adminservice/cm.yaml\n~]# kubectl apply -f http://k8s-yaml.od.com/prod/apollo-adminservice/dp.yaml\n~~~\n\n![1583304745055](assets/1583304745055.png)\n\n![1583304817198](assets/1583304817198.png)\n\n~~~\n# 11æœºå™¨ï¼Œæ¸…é™¤æ•°æ®ï¼š\nmysql -uroot -p\nnone)]> use ApolloPortalDB;\nApolloProtalDB]> select * from App;\nApolloProtalDB]> select * from AppNamespace;\nApolloProtalDB]> truncate table App;\nApolloProtalDB]> truncate table AppNamespace;\n~~~\n\n![1583305105464](assets/1583305105464.png)\n\næŠŠportal scaleæˆ1\n\n![1583305172038](assets/1583305172038.png)\n\nä½¿ç”¨æŸ¥è¯¢åŠŸèƒ½æŸ¥è¯¢ä¸‹\n\n![1583305255615](assets/1583305255615.png)\n\n```bash\napollo.portal.envs\n```\n\n\n\n![1583305298870](assets/1583305298870.png)\n\næˆåŠŸ\n\n\n\n### å®æˆ˜å‘å¸ƒdubboè¿æ¥Apolloåˆ°ä¸åŒç¯å¢ƒ\n\nåˆ›å»ºé¡¹ç›®\n\n[portal.od.com](portal.od.com)\n\n![1583305340551](assets/1583305340551.png)\n\n![1583305381813](assets/1583305381813.png)\n\nç°åœ¨ä¹Ÿå¯ä»¥çœ‹åˆ°ç¯å¢ƒåˆ—è¡¨æœ‰ä¸¤ä¸ªäº†\n\n![1583305431837](assets/1583305431837.png)\n\næµ‹è¯•ç¯å¢ƒæ–°å¢é…ç½®é¡¹ï¼Œå¹¶å‘å¸ƒ\n\n![1583305535156](assets/1583305535156.png)\n\n![1583305580379](assets/1583305580379.png)\n\n![1583305601716](assets/1583305601716.png)\n\nç”Ÿäº§ç¯å¢ƒæ–°å¢é…ç½®é¡¹ï¼Œå¹¶å‘å¸ƒ\n\n![1583305663692](assets/1583305663692.png)\n\n![1583312777104](assets/1583312777104.png)\n\n![1583312803655](assets/1583312803655.png)\n\nserviceé…ç½®å¥½äº†ï¼Œå†é…ç½®consumer\n\n![1583305834462](assets/1583305834462.png)\n\næµ‹è¯•ç¯å¢ƒæ–°å¢é…ç½®é¡¹ï¼Œå¹¶å‘å¸ƒ\n\n![1583305939762](assets/1583305939762.png)\n\n![1583305965712](assets/1583305965712.png)\n\nç”Ÿäº§ç¯å¢ƒæ–°å¢é…ç½®é¡¹ï¼Œå¹¶å‘å¸ƒ\n\n![1583306013898](assets/1583306013898.png)\n\n![1583306034551](assets/1583306034551.png)\n\n![1583306049712](assets/1583306049712.png)\n\n~~~\n# 200æœºå™¨ï¼Œåˆ¶ä½œæµ‹è¯•ç¯å¢ƒserviceï¼š\ncd /data/k8s-yaml/test/dubbo-demo-service/\ndubbo-demo-service]# cp -a /data/k8s-yaml/dubbo-demo-service/*.yaml .\n# ä¿®æ”¹ä¸‰å¤„\ndubbo-demo-service]# vi dp.yaml\n  namespace: test\n        env:\n        - name: JAR_BALL\n          value: dubbo-server.jar\n        - name: C_OPTS\n          value: -Denv=fat -Dapollo.meta=http://config-test.od.com\n~~~\n\n\n~~~\n# åº”ç”¨ï¼Œ22æœºå™¨ï¼š\n~]# kubectl apply -f http://k8s-yaml.od.com/test/dubbo-demo-service/dp.yaml\n~~~\n\n![1583306650482](assets/1583306650482.png)\n\n~~~\n# 200æœºå™¨ï¼Œåˆ¶ä½œæµ‹è¯•ç¯å¢ƒconsumerï¼š\ncd /data/k8s-yaml/test/dubbo-demo-consumer/\ndubbo-demo-consumer]# cp -a /data/k8s-yaml/dubbo-demo-consumer/*.yaml .\n# ä¿®æ”¹ä¸‰å¤„\ndubbo-demo-consumer]# vi dp.yaml\n  namespace: test\n        - name: JAR_BALL\n          value: dubbo-client.jar\n        - name: C_OPTS\n          value: -Denv=fat -Dapollo.meta=http://config-test.od.com\n\n# ä¿®æ”¹ä¸€å¤„\ndubbo-demo-consumer]# vi svc.yaml\n  namespace: test\n\n# ä¿®æ”¹ä¸€å¤„\ndubbo-demo-consumer]# vi ingress.yaml\n  namespace: test\n  - host: demo-test.od.com\n~~~\n\n\n\n~~~\n# 11æœºå™¨ï¼Œæ–°å¢è§£æï¼š\n~]# vi /var/named/od.com.zone\nserial å‰æ»šä¸€ä½\ndemo-test          A    10.4.7.10\n\n~]# systemctl restart named\n~~~\n\n![1583306813921](assets/1583306813921.png)\n\n~~~\n# åº”ç”¨ï¼Œ22æœºå™¨ï¼š\n~]# kubectl apply -f http://k8s-yaml.od.com/test/dubbo-demo-consumer/dp.yaml\n~]# kubectl apply -f http://k8s-yaml.od.com/test/dubbo-demo-consumer/svc.yaml\n~]# kubectl apply -f http://k8s-yaml.od.com/test/dubbo-demo-consumer/ingress.yaml\n~~~\n\næŸ¥çœ‹dashboardçš„å¯åŠ¨æƒ…å†µ\n\n![1583307076131](assets/1583307076131.png)\n\næ­¤æ—¶çš„monitorè¿˜æ˜¯zk2ï¼Œæˆ‘ä»¬æ”¹æˆzk-test\n\n![1583307422408](assets/1583307422408.png)\n\n![1583307483922](assets/1583307483922.png)\n\nupdateç„¶ååˆ æ‰å¯¹åº”çš„podè®©å®ƒè‡ªåŠ¨é‡å¯\n\n![1583307517718](assets/1583307517718.png)\n\n![1583307567245](assets/1583307567245.png)\n\n![1583307586774](assets/1583307586774.png)\n\n~~~\n# æµè§ˆå™¨è¾“å…¥ï¼šdemo-test.od.com/hello?name=test\n~~~\n\n![1583310055796](assets/1583310055796.png)\n\nå®Œæˆ\n\nå¼€å§‹åšç”Ÿäº§ç¯å¢ƒ\n\n~~~\n# 11æœºå™¨ï¼Œæ–°å¢è§£æï¼š\n~]# vi /var/named/od.com.zone\nserial å‰æ»šä¸€ä½\ndemo-prod          A    10.4.7.10\n\n~]# systemctl restart named\n~~~\n\n![1581350791800](assets/1581350791800.png)\n\n~~~\n# 200æœºå™¨ï¼Œåˆ¶ä½œç”Ÿäº§ç¯å¢ƒserviceï¼š\ncd /data/k8s-yaml/prod/dubbo-demo-service/\ndubbo-demo-service]# cp -a ../../test/dubbo-demo-service/*.yaml .\n# å…±ä¿®æ”¹ä¸‰å¤„\ndubbo-demo-service]# vi dp.yaml\n  namespace: prod\n        env:\n        - name: JAR_BALL\n          value: dubbo-server.jar\n        - name: C_OPTS\n          value: -Denv=pro -Dapollo.meta=http://apollo-configservice:8080\n~~~\n\n[^å…³äºhttp://apollo-configservice:8080]: ç›´æ¥ç”¨è¿™ä¸ªå’Œç”¨http://config-test.od.comæ˜¯æ²¡æœ‰åŒºåˆ«çš„ï¼Œhttp://config-test.od.comæ˜¯å¤šäº†ä¸€å±‚åä»£ï¼Œè€Œapollo-configservice:8080æ˜¯å› ä¸ºå®ƒä»¬åœ¨åŒä¸€åç§°ç©ºé—´é‡Œï¼Œæ‰€ä»¥å¯ä»¥è¿™ä¹ˆä½¿ç”¨\n\n~~~\n# åº”ç”¨ï¼Œ22æœºå™¨ï¼š\n~]# kubectl apply -f http://k8s-yaml.od.com/prod/dubbo-demo-service/dp.yaml\n~~~\n\n![1583310378331](assets/1583310378331.png)\n\nä½ è¿˜å¯ä»¥å»LOGSæ—¥å¿—é‡Œé¢çœ‹çœ‹\n\n~~~\n# 200æœºå™¨ï¼Œåˆ¶ä½œç”Ÿäº§ç¯å¢ƒconsumerï¼š\ncd /data/k8s-yaml/prod/dubbo-demo-consumer/\ndubbo-demo-consumer]# cp -a /data/k8s-yaml/dubbo-demo-consumer/*.yaml .\n# å…±ä¿®æ”¹ä¸‰å¤„\ndubbo-demo-consumer]# vi dp.yaml\n  namespace: prod\n        env:\n        - name: JAR_BALL\n          value: dubbo-client.jar\n        - name: C_OPTS\n          value: -Denv=pro -Dapollo.meta=http://apollo-configservice:8080\n        imagePullPolicy: IfNotPresent\n\n# å…±ä¿®æ”¹ä¸€å¤„\ndubbo-demo-consumer]# vi svc.yaml\n  namespace: prod\n\n# å…±ä¿®æ”¹ä¸¤å¤„\ndubbo-demo-consumer]# vi ingress.yaml\n  namespace: prod\nspec:\n  rules:\n  - host: demo-prod.od.com\n~~~\n\n\n\n~~~\n# åº”ç”¨ï¼Œ22æœºå™¨ï¼š\n~]# kubectl apply -f http://k8s-yaml.od.com/prod/dubbo-demo-consumer/dp.yaml\n~]# kubectl apply -f http://k8s-yaml.od.com/prod/dubbo-demo-consumer/svc.yaml\n~]# kubectl apply -f http://k8s-yaml.od.com/prod/dubbo-demo-consumer/ingress.yaml\n~~~\n\n~~~\n# æµè§ˆå™¨è¾“å…¥ï¼šdemo-prod.od.com/hello?name=prod\n~~~\n\n![1583313070558](assets/1583313070558.png)\n\nå®Œæˆ\n\n> æŠ¥é”™ï¼š![1583312899877](assets/1583312899877.png)\n>\n> æˆ‘å»LOGSé‡Œé¢çœ‹äº†ä¸€ä¸‹ï¼Œå‘ç°æˆ‘Apolloé…å¾—portå†™é”™äº†ï¼Œå†™æˆäº†dubbo-portï¼Œåº”è¯¥æ˜¯dubbo.portï¼Œæ”¹å›æ¥å°±å¯ä»¥äº†ï¼Œåˆ æ‰serviceå¾—podé‡æ–°å¯åŠ¨ï¼Œåˆ æ‰consumerçš„podé‡æ–°å¯åŠ¨\n\n\n\n### å®æˆ˜æ¼”ç¤ºé¡¹ç›®ææµ‹ï¼Œå‘ç‰ˆæµç¨‹\n\n> æ¨¡æ‹Ÿé¡¹ç›®ææµ‹åˆ°å‘å¸ƒä¸Šçº¿ï¼Œè¿™é‡Œç”¨å¾—gitlabï¼Œä½ æœ‰å¯ä»¥äº†è§£ä¸€ä¸‹gitlabæ˜¯é•¿ä»€ä¹ˆæ ·å­çš„ï¼Œè¿˜æœ‰æ€ä¹ˆæ“ä½œçš„\n\nä¿®æ”¹æºä»£ç ï¼Œå¹¶commit\n\n![1583313961163](assets/1583313961163.png)\n\n![1583313975564](assets/1583313975564.png)\n\n> gitlabè·Ÿgitteeåœ¨æ›´æ–°ä»£ç çš„ç¼–å·æœ‰æ‰€åŒºåˆ«\n\n![1583314181056](assets/1583314181056.png)\n\nJenkinsæ„å»º\n\n~~~\n# å¡«å…¥å¯¹åº”å‚æ•°ï¼Œç„¶åbuild\napp_name: dubbo-demo-consumer\nimage_name: app/dubbo-demo-consumer\ngit_repo: http://gitlab.od.com:10000/909336740/dubbo-demo-web.git\ngit_ver: 535826b1239fedba0df3799b7b3b8585d56e9e18\nadd_tag: 200304_1730\ntarget_dir: ./dubbo-client/target\nbase_image: base/jre8:8u112\n~~~\n\n![1583314459402](assets/1583314459402.png)\n\n![1583314584034](assets/1583314584034.png)\n\nå…ˆåˆ°æµ‹è¯•ç¯å¢ƒå‘å¸ƒï¼Œä¿®æ”¹tag\n\n![1583314731675](assets/1583314731675.png)\n\n![1583316573117](assets/1583316573117.png)\n\né‡å¯æˆåŠŸï¼Œåˆ·æ–°æµ‹è¯•ç¯å¢ƒçš„é¡µé¢ï¼ŒæŸ¥çœ‹æƒ…å†µ\n\n![1583314816036](assets/1583314816036.png)\n\nåˆ·æ–°ç”Ÿäº§ç¯å¢ƒçš„é¡µé¢ï¼ŒæŸ¥çœ‹æƒ…å†µï¼Œè¿˜æ²¡æ”¹å˜\n\n![1583314831690](assets/1583314831690.png)\n\næˆ‘ä»¬æ¥ä¿®æ”¹prodçš„ï¼Œè¿™æ—¶å€™å·²ç»ä¸éœ€è¦å†å»Jenkinsæ‰“åŒ…é•œåƒäº†\n\n![1583316530331](assets/1583316530331.png)\n\n![1583316573117](assets/1583316573117.png)\n\næ›´æ–°å®Œå¯åŠ¨podå\n\nå†æ¥åˆ·æ–°ç”Ÿäº§ç¯å¢ƒçš„é¡µé¢\n\n![1583316620715](assets/1583316620715.png)\n\nå·²ç»æ”¹å˜ï¼ŒæˆåŠŸ\n\n"
        },
        {
          "name": "ç¬¬å››ç« â€”â€”dashboardæ’ä»¶åŠk8så®æˆ˜äº¤ä»˜.md",
          "type": "blob",
          "size": 17.482421875,
          "content": "## ç¬¬å››ç« â€”â€”dashboardæ’ä»¶åŠk8så®æˆ˜äº¤ä»˜\n\n> å¼•è¨€ï¼šåœ¨é›†ç¾¤çš„ç« èŠ‚ï¼Œæˆ‘ä»¬å¼€å§‹ä½¿ç”¨äº¤ä»˜æœåŠ¡çš„å½¢å¼æ¥äº¤ä»˜ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬ä¹Ÿä¼šæŒç»­ä½¿ç”¨è¿™ç§æ–¹å¼æ¥äº¤ä»˜ï¼Œæµç¨‹ï¼š**å‡†å¤‡é•œåƒâ€”>å‡†å¤‡èµ„æºé…ç½®æ¸…å•â€”>è§£æåŸŸåï¼ˆæ²¡æœ‰ingressåˆ™ä¸éœ€è¦ï¼‰â€”>åº”ç”¨é…ç½®æ¸…å•â€”>å®Œæˆ**\n\n### dashboardå®‰è£…éƒ¨ç½²\n\n> **WHAT**ï¼šå‘ä¼ä¸šå±•ç¤ºåº¦é‡ä¿¡æ¯å’Œå…³é”®ä¸šåŠ¡æŒ‡æ ‡ï¼ˆ[KPI](https://baike.baidu.com/item/KPI)ï¼‰ç°çŠ¶çš„[æ•°æ®è™šæ‹ŸåŒ–](https://baike.baidu.com/item/%E6%95%B0%E6%8D%AE%E8%99%9A%E6%8B%9F%E5%8C%96/6734581)å·¥å…·\n>\n> **WHY**ï¼šæˆ‘ä»¬ç›®å‰éƒ½æ˜¯ç”¨æœºå™¨å»å®‰è£…éƒ¨ç½²èµ„æºï¼Œä½†æˆ‘ä»¬ä»¥åä¸å¯èƒ½åŠ¨ä¸åŠ¨å°±ä¸Šä¸»æœºï¼Œé‚£æ ·éå¸¸ä¸å®‰å…¨ï¼Œè€Œä¸”å¼€å‘äººå‘˜ç­‰ä¹Ÿéœ€è¦çœ‹åˆ°PODçš„æƒ…å†µï¼Œä¸å¯èƒ½è®©ä»–ä»¬ä¹Ÿç™»å½•ä¸»æœºå»æŸ¥çœ‹ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦ä¸€ä¸ªæœ‰æƒé™æ§åˆ¶çš„ç•Œé¢å±•ç¤ºå’Œæ§åˆ¶çš„å·¥å…·\n\n~~~\n# 200æœºå™¨ï¼Œå‡†å¤‡é•œåƒï¼š\ncd /data/k8s-yaml/\nk8s-yaml]# docker pull k8scn/kubernetes-dashboard-amd64:v1.8.3\nk8s-yaml]# docker images|grep dashboard\nk8s-yaml]# docker tag fcac9aa03fd6 harbor.od.com/public/dashboard:v1.8.3\nk8s-yaml]# docker push harbor.od.com/public/dashboard:v1.8.3\n~~~\n\n> å¤ä¹ ï¼špushæ‹‰å–ã€imagesæ˜¾ç¤ºæ‰€æœ‰é•œåƒã€|grepç®¡é“ç¬¦ï¼Œç”¨äºç­›é€‰ã€tagæ‰“æ ‡ç­¾ã€pushä¸Šä¼ \n\n~~~\n# 200æœºå™¨ï¼Œå‡†å¤‡èµ„æºé…ç½®æ¸…å•\nk8s-yaml]# mkdir /data/k8s-yaml/dashboard\nk8s-yaml]# cd /data/k8s-yaml/dashboard/\ndashboard]# vi rbac.yaml\napiVersion: v1\nkind: ServiceAccount\nmetadata:\n  labels:\n    k8s-app: kubernetes-dashboard\n    addonmanager.kubernetes.io/mode: Reconcile\n  name: kubernetes-dashboard-admin\n  namespace: kube-system\n---\napiVersion: rbac.authorization.k8s.io/v1\nkind: ClusterRoleBinding\nmetadata:\n  name: kubernetes-dashboard-admin\n  namespace: kube-system\n  labels:\n    k8s-app: kubernetes-dashboard\n    addonmanager.kubernetes.io/mode: Reconcile\nroleRef:\n  apiGroup: rbac.authorization.k8s.io\n  kind: ClusterRole\n  name: cluster-admin\nsubjects:\n- kind: ServiceAccount\n  name: kubernetes-dashboard-admin\n  namespace: kube-system\n  \ndashboard]# vi dp.yaml\napiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: kubernetes-dashboard\n  namespace: kube-system\n  labels:\n    k8s-app: kubernetes-dashboard\n    kubernetes.io/cluster-service: \"true\"\n    addonmanager.kubernetes.io/mode: Reconcile\nspec:\n  selector:\n    matchLabels:\n      k8s-app: kubernetes-dashboard\n  template:\n    metadata:\n      labels:\n        k8s-app: kubernetes-dashboard\n      annotations:\n        scheduler.alpha.kubernetes.io/critical-pod: ''\n    spec:\n      priorityClassName: system-cluster-critical\n      containers:\n      - name: kubernetes-dashboard\n        image: harbor.od.com/public/dashboard:v1.8.3\n        resources:\n          limits:\n            cpu: 100m\n            memory: 300Mi\n          requests:\n            cpu: 50m\n            memory: 100Mi\n        ports:\n        - containerPort: 8443\n          protocol: TCP\n        args:\n          # PLATFORM-SPECIFIC ARGS HERE\n          - --auto-generate-certificates\n        volumeMounts:\n        - name: tmp-volume\n          mountPath: /tmp\n        livenessProbe:\n          httpGet:\n            scheme: HTTPS\n            path: /\n            port: 8443\n          initialDelaySeconds: 30\n          timeoutSeconds: 30\n      volumes:\n      - name: tmp-volume\n        emptyDir: {}\n      serviceAccountName: kubernetes-dashboard-admin\n      tolerations:\n      - key: \"CriticalAddonsOnly\"\n        operator: \"Exists\"\n\t\t\ndashboard]# vi svc.yaml\napiVersion: v1\nkind: Service\nmetadata:\n  name: kubernetes-dashboard\n  namespace: kube-system\n  labels:\n    k8s-app: kubernetes-dashboard\n    kubernetes.io/cluster-service: \"true\"\n    addonmanager.kubernetes.io/mode: Reconcile\nspec:\n  selector:\n    k8s-app: kubernetes-dashboard\n  ports:\n  - port: 443\n    targetPort: 8443\n\t\n\t\ndashboard]# vi ingress.yaml\napiVersion: extensions/v1beta1\nkind: Ingress\nmetadata:\n  name: kubernetes-dashboard\n  namespace: kube-system\n  annotations:\n    kubernetes.io/ingress.class: traefik\nspec:\n  rules:\n  - host: dashboard.od.com\n    http:\n      paths:\n      - backend:\n          serviceName: kubernetes-dashboard\n          servicePort: 443\n~~~\n\n> <a href=\"https://github.com/ben1234560/k8s_PaaS/blob/master/%E5%8E%9F%E7%90%86%E5%8F%8A%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/Kubernetes%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5.md#rbac%E5%9F%BA%E4%BA%8E%E8%A7%92%E8%89%B2%E7%9A%84%E6%9D%83%E9%99%90%E6%8E%A7%E5%88%B6\">RBAC:åŸºäºè§’è‰²çš„æƒé™æ§åˆ¶</a>\n\n~~~\n# 11æœºå™¨ï¼Œè§£æåŸŸåï¼š\n~]# vi /var/named/od.com.zone\nserial å‰æ»šä¸€ä½\ndashboard          A    10.4.7.10\n\n~]# systemctl restart named\n~]# dig -t A dashboard.od.com @10.4.7.11 +short\n~~~\n\n![1579173292893](assets/1579173292893.png)\n\n~~~\n# é€‰æ‹©ä»»æ„è¿ç®—èŠ‚ç‚¹ï¼Œæˆ‘é€‰çš„æ˜¯22æœºå™¨ï¼Œåº”ç”¨èµ„æºé…ç½®æ¸…å•ï¼š\n# é€‰æ‹©åº”ç”¨èŠ‚ç‚¹ï¼Œ22æœºå™¨\n~]# kubectl apply -f http://k8s-yaml.od.com/dashboard/rbac.yaml\n~]# kubectl apply -f http://k8s-yaml.od.com/dashboard/dp.yaml\n~]# kubectl apply -f http://k8s-yaml.od.com/dashboard/svc.yaml\n~]# kubectl apply -f http://k8s-yaml.od.com/dashboard/ingress.yaml\n~]# kubectl get pods -n kube-system\n~]# kubectl get svc -n kube-system\n~]# kubectl get ingress -n kube-system\n~~~\n\n![1579173213311](assets/1579173213311.png)\n\n[è®¿é—®dashboard.od.com](dashboard.od.com)\n\n![1579173501791](assets/1579173501791.png)\n\nå…ˆè·³è¿‡\n\n![1579173539350](assets/1579173539350.png)\n\nå®Œæˆ\n\n\n\n### K8Sä»ªè¡¨ç›˜é‰´æƒ\n\n> ä¸Šé¢è¿™ç§æ˜¯ä¸éœ€è¦ç™»å½•å°±å¯ä»¥æ¥å…¥ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨éœ€è¦ç™»å½•çš„ç‰ˆæœ¬ï¼Œè€Œä¸”åˆ†æƒï¼Œå³ç®¡ç†å‘˜ç”¨ç®¡ç†å‘˜çš„æƒé™ï¼Œæ™®é€šç”¨æˆ·ç”¨æ™®é€šç”¨æˆ·çš„æƒé™\n\n~~~\n# 200æœºå™¨ï¼Œåšè¯ä¹¦ï¼š\ncd /opt/certs\ncerts]# (umask 077; openssl genrsa -out dashboard.od.com.key 2048)\n# æ²¡æœ‰opensslçš„yum install openssl\ncerts]# openssl req -new -key dashboard.od.com.key -out dashboard.od.com.csr -subj \"/CN=dashboard.od.com/C=CN/ST=BJ/L=Beijing/O=ben1234560/OU=ops\"\ncerts]# openssl x509 -req -in dashboard.od.com.csr -CA ca.pem -CAkey ca-key.pem -CAcreateserial -out dashboard.od.com.crt -days 3650\ncerts]# cfssl-certinfo -cert dashboard.od.com.crt\n~~~\n\n\n\n~~~\n# æ‹·è´åˆ°11æœºå™¨çš„nginx:\n~]# cd /etc/nginx/\nnginx]# mkdir certs\nnginx]# cd certs/\ncerts]# scp hdss7-200:/opt/certs/dashboard.od.com.crt .\ncerts]# scp hdss7-200:/opt/certs/dashboard.od.com.key .\ncerts]# cd ../conf.d/\nconf.d]# vi dashboard.od.com.conf\nserver {\n    listen       80;\n    server_name  dashboard.od.com;\n\n    rewrite ^(.*)$ https://${server_name}$1 permanent;\n}\nserver {\n    listen       443 ssl;\n    server_name  dashboard.od.com;\n\n    ssl_certificate \"certs/dashboard.od.com.crt\";\n    ssl_certificate_key \"certs/dashboard.od.com.key\";\n    ssl_session_cache shared:SSL:1m;\n    ssl_session_timeout  10m;\n    ssl_ciphers HIGH:!aNULL:!MD5;\n    ssl_prefer_server_ciphers on;\n\n    location / {\n        proxy_pass http://default_backend_traefik;\n        proxy_set_header Host       $http_host;\n        proxy_set_header x-forwarded-for $proxy_add_x_forwarded_for;\n    }\n}\n\nconf.d]# nginx -t\nconf.d]# nginx -s reload\n~~~\n\n> **nginx -t**ï¼šæ£€æŸ¥nginxæ–‡ä»¶è¯­æ³•\n>\n> **nginx -s reload**ï¼šçƒ­é…ç½®ï¼Œå³ä¸ç”¨é‡å¯çš„æ›´æ–°\n\n~~~\n# 200æœºå™¨ï¼Œå‰é¢æˆ‘ä»¬éƒ¨ç½²çš„æ˜¯dashboard1.8ï¼Œç°åœ¨æˆ‘ä»¬è¯•ä¸‹1.10\ncerts]# docker pull hexun/kubernetes-dashboard-amd64:v1.10.1\ncerts]# docker images|grep dash\ncerts]# docker tag f9aed6605b81 harbor.od.com/public/dashboard:v1.10.1\ncerts]# docker push harbor.od.com/public/dashboard:v1.10.1\ncerts]# cd /data/k8s-yaml/dashboard/\n# ä¿®æ”¹ä»¥ä¸‹ç‰ˆæœ¬ä¿¡æ¯ï¼Œäº¦æˆ–è€…å»dashboardä¿®æ”¹\ndashboard]# vi dp.yaml\nimage: harbor.od.com/public/dashboard:v1.10.1\n~~~\n\n![1579228852242](assets/1579228852242.png)\n\n![1579228939094](assets/1579228939094.png)\n\n1.10.1ç‰ˆæœ¬æ˜¯å¼ºåˆ¶ç™»å½•çš„ï¼Œè¿™æ—¶å€™ï¼Œæ‹¿tokenå»ç™»å½•\n\n~~~\n# 21æœºå™¨ï¼š\n~]# kubectl get secret -n kube-system\n# kubernetes-dashboard-admin-token-gq266\n~]# kubectl describe secret kubernetes-dashboard-admin-token-gq266 -n kube-system\n# token:eyJhbGciOiJSUzI1NiIsImtpZCI6IiJ9.eyJpc3MiOiJrdWJlcm5ldGVzL3NlcnZpY2VhY2NvdW50Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9uYW1lc3BhY2UiOiJrdWJlLXN5c3RlbSIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VjcmV0Lm5hbWUiOiJrdWJlcm5ldGVzLWRhc2hib2FyZC1hZG1pbi10b2tlbi1ncTI2NiIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VydmljZS1hY2NvdW50Lm5hbWUiOiJrdWJlcm5ldGVzLWRhc2hib2FyZC1hZG1pbiIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VydmljZS1hY2NvdW50LnVpZCI6IjY5MjM2OTY1LWIwOGMtNDYxNi1hOTIwLWRkMmIzNjMzOTcyZCIsInN1YiI6InN5c3RlbTpzZXJ2aWNlYWNjb3VudDprdWJlLXN5c3RlbTprdWJlcm5ldGVzLWRhc2hib2FyZC1hZG1pbiJ9.tTE7xZKgOm_o4S7Jq5iwudTXj66IWNz-1fv6y_ZxjgAJR8Jusa-DgDJppdATl_OZ7b1HPvKAA8T68ll2TzCpvoJe_rSyrCawrM9KxFVM7ZfyvNfIqScP5YqevV8GnvSkC50qMj3xClv9YM1Yo5ersgrB8bqYTqPIUPYwXsyBH-PA7PNVMWBHSeq6OzOUR4sM5IwSFKtNAvoM2Nxug7MY0wgUI2c3zFHeIe3d3do8zUWJClxKZG6HqABhEYICRL_zXFGQnoz8wyQsoSSg0YcctLY1BcvXYfzCvYVn953m_cz6t-WALhFW5kyqMz_JUODosl7povdJ0LW0pHzuicQYQA\n~~~\n\n> dashboard-admin-tokenæŒ‡çš„æ˜¯adminæƒé™ï¼Œå³ç®¡ç†å‘˜æƒé™\n\n![1579228067217](assets/1579228067217.png)\n\n![1579228151724](assets/1579228151724.png)\n\n[åˆ·æ–°dashboard.od.com](dashboard.od.com)\n\n![1579228224683](assets/1579228224683.png)\n\n![1579229142905](assets/1579229142905.png)\n\næ­¤æ—¶ç®¡ç†å‘˜æ˜¯éœ€è¦å¯†é’¥ç™»å½•äº†ï¼Œç™»å½•åæœ‰æ‰€æœ‰çš„æƒé™ï¼Œæˆ‘ä»¬å†æ¥åšæ™®é€šç”¨æˆ·\n\n[å‚è€ƒçš„å®˜æ–¹ç½‘å€](https://github.com/kubernetes/kubernetes/blob/master/cluster/addons/dashboard/)\n\n~~~\n# 200æœºå™¨ï¼š\ncd /data/k8s-yaml/dashboard/\ndashboard]# vi rbac-minimal.yaml\napiVersion: v1\nkind: ServiceAccount\nmetadata:\n  labels:\n    k8s-app: kubernetes-dashboard\n    addonmanager.kubernetes.io/mode: Reconcile\n  name: kubernetes-dashboard\n  namespace: kube-system\n---\nkind: Role\napiVersion: rbac.authorization.k8s.io/v1\nmetadata:\n  labels:\n    k8s-app: kubernetes-dashboard\n    addonmanager.kubernetes.io/mode: Reconcile\n  name: kubernetes-dashboard-minimal\n  namespace: kube-system\nrules:\n  # Allow Dashboard to get, update and delete Dashboard exclusive secrets.\n- apiGroups: [\"\"]\n  resources: [\"secrets\"]\n  resourceNames: [\"kubernetes-dashboard-key-holder\", \"kubernetes-dashboard-certs\"]\n  verbs: [\"get\", \"update\", \"delete\"]\n  # Allow Dashboard to get and update 'kubernetes-dashboard-settings' config map.\n- apiGroups: [\"\"]\n  resources: [\"configmaps\"]\n  resourceNames: [\"kubernetes-dashboard-settings\"]\n  verbs: [\"get\", \"update\"]\n  # Allow Dashboard to get metrics from heapster.\n- apiGroups: [\"\"]\n  resources: [\"services\"]\n  resourceNames: [\"heapster\"]\n  verbs: [\"proxy\"]\n- apiGroups: [\"\"]\n  resources: [\"services/proxy\"]\n  resourceNames: [\"heapster\", \"http:heapster:\", \"https:heapster:\"]\n  verbs: [\"get\"]\n---\napiVersion: rbac.authorization.k8s.io/v1\nkind: RoleBinding\nmetadata:\n  name: kubernetes-dashboard-minimal\n  namespace: kube-system\n  labels:\n    k8s-app: kubernetes-dashboard\n    addonmanager.kubernetes.io/mode: Reconcile\nroleRef:\n  apiGroup: rbac.authorization.k8s.io\n  kind: Role\n  name: kubernetes-dashboard-minimal\nsubjects:\n- kind: ServiceAccount\n  name: kubernetes-dashboard\n  namespace: kube-system\n\n~~~\n\n>  **rbac-minimal.yamlï¼š**\n>\n> - è¿™é‡Œçš„nameå˜æˆäº†name: kubernetes-dashboardï¼Œå·²ç»ä¸æ˜¯adminï¼Œæƒé™å°äº›\n> - rulesï¼šå¯ä»¥çœ‹åˆ°rulesç»™çš„ä¸€äº›æ¯”è¾ƒå°çš„æƒé™\n> - RoleBindingï¼šè§’è‰²ç»‘å®š\n> - ä¸ŠåŠæ®µæ˜¯å®˜æ–¹æ–‡æ¡£é‡Œé¢çš„dp.yamlï¼Œä¸‹é¢å¤§ç­æ®µæ˜¯rbac-minimal.yaml\n\n~~~\n# 22æœºå™¨ï¼Œåº”ç”¨æ¸…å•ï¼š\n~]# kubectl apply -f http://k8s-yaml.od.com/dashboard/rbac-minimal.yaml\n~~~\n\n![1582440867131](assets/1582440867131.png)\n\n~~~\n# 200æœºå™¨ï¼Œä¿®æ”¹ä»¥ä¸‹å†…å®¹ï¼š\ndashboard]# vi dp.yaml\nserviceAccountName: kubernetes-dashboard\n~~~\n\n> ä¸Šé¢çš„æ„æ€å¦‚æœæ²¡æœ‰ä»¤ç‰Œè¿›æ¥é»˜è®¤æ˜¯æ™®é€šç”¨æˆ·ï¼Œä¹‹å‰é»˜è®¤æ˜¯adminç”¨æˆ·\n\n![1582440913272](assets/1582440913272.png)\n\n~~~\n# 22æœºå™¨ï¼Œç„¶åå†å›æ¥åº”ç”¨dpï¼š\n~]# kubectl apply -f http://k8s-yaml.od.com/dashboard/dp.yaml\n~]# kubectl get pods -n kube-system\n~]# kubectl get secret -n kube-system\n# ç°åœ¨å¯ä»¥çœ‹åˆ°æœ‰ä¸¤ä¸ªtoken\n~]# kubectl describe secret kubernetes-dashboard-token-g67v7 -n kube-system\n~~~\n\n[é‡æ–°ç™»å½•dashboard.od.com](dashboard.od.com)\n\n![1579228224683](assets/1579228224683.png)\n\næœ‰å¾ˆå¤šæƒé™éƒ½æ²¡æœ‰\n\n![1582441754702](assets/1582441754702.png)\n\n> ç”Ÿäº§ä¸Šï¼Œæˆ‘ä»¬åº”è¯¥ç”¨1.10çš„ç‰ˆæœ¬ï¼Œå› ä¸ºç™»å½•éœ€è¦tokenï¼Œè€Œä¸æ˜¯è°è¿‡æ¥éƒ½å¯ä»¥skipè¿›æ¥ç”¨rootæƒé™ï¼Œé™¤äº†çœŸæ­£çš„ç®¡ç†å‘˜ï¼Œå…¶ä»–äººéƒ½ä¸åº”è¯¥æœ‰ç®¡ç†å‘˜æƒé™ï¼Œè€Œæ˜¯å…¶ä»–äººå¯ä»¥çœ‹/ä¿®æ”¹è‡ªå·±åç§°ç©ºé—´ï¼ˆNamespaceï¼‰çš„æƒé™ï¼Œä½ åªéœ€è¦é…ç½®rbac-xxx.yamlçš„æ–‡ä»¶å¹¶åº”ç”¨å³å¯\n\n~~~\n# 200æœºå™¨ï¼Œæ”¹å›ç”¨æ¥çš„1.8.3ï¼Œæœ‰skipæŒ‰é’®æ¯”è¾ƒæ–¹ä¾¿å­¦ä¹ ï¼š\n# ä¿®æ”¹ä¸€ä¸‹ä¸¤æ®µå†…å®¹\ndashboard]# vi dp.yaml\nimage: harbor.od.com/public/dashboard:v1.8.3\nserviceAccountName: kubernetes-dashboard-admin\n# 22æœºå™¨\n~]# kubectl apply -f http://k8s-yaml.od.com/dashboard/dp.yaml\n~]# kubectl get pods -n kube-system\n~~~\n\n![1579230932021](assets/1579230932021.png)\n\n\n\n### dashboardâ€”â€”heapsterï¼ˆå¯ä¸åšï¼‰\n\n> **WHAT**ï¼šè®©dashboardæœ‰æ›´å¤šå›¾å½¢åŒ–çš„å°æ’ä»¶ï¼Œä¸è¿‡ç›®å‰ç”±äºæ”¶é›†çš„æ•°æ®å±•ç¤ºçš„å›¾å¹¶ä¸é‚£ä¹ˆå‡†ç¡®ï¼Œæ‰€ä»¥å¯ä»¥ä¸ç”¨éƒ¨ç½²ä»…ä½œäº†è§£\n\n~~~\n# 200æœºå™¨ï¼Œå‡†å¤‡é•œåƒã€èµ„æºé…ç½®æ¸…å•ï¼š\ndashboard]# mkdir heapster\ndashboard]# cd heapster/\nheapster]# docker pull quay.io/bitnami/heapster:1.5.4\nheapster]# docker images|grep heapster\ndocker tag c359b95ad38b harbor.od.com/public/heapster:v1.5.4\nheapster]# docker push harbor.od.com/public/heapster:v1.5.4\nheapster]# vi rbac.yaml\napiVersion: v1\nkind: ServiceAccount\nmetadata:\n  name: heapster\n  namespace: kube-system\n---\nkind: ClusterRoleBinding\napiVersion: rbac.authorization.k8s.io/v1beta1\nmetadata:\n  name: heapster\nroleRef:\n  apiGroup: rbac.authorization.k8s.io\n  kind: ClusterRole\n  name: system:heapster\nsubjects:\n- kind: ServiceAccount\n  name: heapster\n  namespace: kube-system\n\nheapster]# vi dp.yaml\napiVersion: extensions/v1beta1\nkind: Deployment\nmetadata:\n  name: heapster\n  namespace: kube-system\nspec:\n  replicas: 1\n  template:\n    metadata:\n      labels:\n        task: monitoring\n        k8s-app: heapster\n    spec:\n      serviceAccountName: heapster\n      containers:\n      - name: heapster\n        image: harbor.od.com/public/heapster:v1.5.4\n        imagePullPolicy: IfNotPresent\n        command:\n        - /opt/bitnami/heapster/bin/heapster\n        - --source=kubernetes:https://kubernetes.default\n\t\t\nheapster]# vi svc.yaml\napiVersion: v1\nkind: Service\nmetadata:\n  labels:\n    task: monitoring\n    # For use as a Cluster add-on (https://github.com/kubernetes/kubernetes/tree/master/cluster/addons)\n    # If you are NOT using this as an addon, you should comment out this line.\n    kubernetes.io/cluster-service: 'true'\n    kubernetes.io/name: Heapster\n  name: heapster\n  namespace: kube-system\nspec:\n  ports:\n  - port: 80\n    targetPort: 8082\n  selector:\n    k8s-app: heapster\n~~~\n\n\n\n~~~\n# 22æœºå™¨ï¼Œåº”ç”¨èµ„æºé…ç½®æ¸…å•ï¼š\n~]# kubectl apply -f http://k8s-yaml.od.com/dashboard/heapster/rbac.yaml\n~]# kubectl apply -f http://k8s-yaml.od.com/dashboard/heapster/dp.yaml\n~]# kubectl apply -f http://k8s-yaml.od.com/dashboard/heapster/svc.yaml\n~]# kubectl get pods -n kube-system\n~~~\n\n![1579233334649](assets/1579233334649.png)\n\nå®Œæˆ\n\n\n\n### K8Så¹³æ»‘å‡çº§æŠ€å·§\n\n> **WHAT**ï¼šä¸éœ€è¦åšè¿‡å¤šçš„æ“ä½œï¼Œç‰¹åˆ«æ˜¯å…³é—­æœåŠ¡å™¨ç­‰ï¼Œè€Œå‡çº§çš„æ–¹å¼\n>\n> **WHY**ï¼šç”Ÿäº§ä¸­æˆ‘ä»¬çš„æœåŠ¡æ¯å…³ä¸€ç§’é’Ÿï¼ŒæŸå¤±çš„åˆ©æ¶¦å¯èƒ½æ˜¯ä¸Šç™¾ä¸‡ï¼Œè€Œç°åœ¨å¾ˆå¤šå‚å•†ï¼Œç‰¹åˆ«æ˜¯æ¸¸æˆï¼Œéƒ½ä¼šå†™ç€ä»€ä¹ˆæ—¶å€™å‡çº§ä½†å¯ä»¥æ­£å¸¸è¿è¡Œçš„å…¬å‘Šï¼Œè€Œä¸”å‡çº§çš„æ—¶é—´ä¸€èˆ¬æ˜¯åœ¨æµé‡ä½è°·ï¼Œæµé‡ä½è°·æŒ‡çš„æ˜¯ç”¨æˆ·ä½¿ç”¨é‡æœ€å°‘çš„æ—¶å€™\n\n~~~\n# 21èŠ‚ç‚¹\n~]# kubectl get node\n~]# kubectl get pod -n kube-system -o wide\n~~~\n\n![1579233625104](assets/1579233625104.png)\n\n~~~\n# 11æœºå™¨ï¼Œåœæ‰7å±‚ç½‘ç»œ(åªéœ€åšä¸€æ¬¡)\n~]# vi /etc/nginx/nginx.conf\n# æŠŠæœ€ä¸‹é¢çš„server21æ³¨é‡Šæ‰\n~]# vi /etc/nginx/conf.d/od.com.conf\n# æŠŠserver21æ³¨é‡Šæ‰\n~]# nginx -s reload\n~~~\n\n![1579241900984](assets/1579241900984.png)\n\n![1579241962440](assets/1579241962440.png)\n\n~~~\n# 21/22æœºå™¨:\nsrc]# kubectl delete node hdss7-21.host.com\n# ä»¥ä¸‹æ“ä½œå¯èƒ½éœ€è¦ä¸æ–­åˆ·æ–°ï¼Œå› ä¸ºè°ƒåº¦å™¨çŸ¥é“ä½ çš„nodeå…³é—­ï¼Œæ‰ä¼šå¼€å§‹è¿ç§»åˆ°å…¶å®ƒnodeï¼ˆä¼šè‡ªåŠ¨å¹³è¡¡èµ„æºï¼‰ï¼Œæ³¨æ„çœ‹IP\nsrc]# kubectl get nodes\nsrc]# kubectl get pod -n kube-system -o wide\n# æˆ‘ä»¬æ¥çœ‹ä¸‹dnsæœ‰æ²¡æœ‰é—®é¢˜\ndig -t A kubernetes.default.svc.cluster.local @192.168.0.2 +short\n# out:192.168.0.1\n~~~\n\n![1579241869769](assets/1579241869769.png)\n\n~~~\n# 21/22æœºå™¨:\ncd /opt/src\næŠŠè¦å‡çº§çš„ç‰ˆæœ¬æ‹‰è¿›æ¥\nopt]# mkdir /opt/123\nopt]# cd src\nsrc]# tar xfv kubernetes-server-linux-amd64-v1.15.4.tar.gz -C /opt/123\nsrc]# ll\n# æŠŠåå­—æ”¹ä¸‹\nsrc]# cd /opt/123\n123]# mv kubernetes/ ../kubernetes-v1.15.4\nsrc]# cd ..\nopt]# ll\n# è¿™æ—¶å€™ä¼šæœ‰ä¸ª1.15.2å’Œ1.15.4\ncd /kubernetes-v1.15.4\n# åˆ æ‰ä¸éœ€è¦çš„ä¸œè¥¿\nkubernetes-v1.15.4]# rm -f kubernetes-src.tar.gz\nkubernetes-v1.15.4]# cd server/bin\nbin]# rm -f *.tar\nbin]# rm -f *_tag\nbin]# mkdir conf\nbin]# mkdir cert\nbin]# cd cert/\ncert]# cp /opt/kubernetes/server/bin/cert/* .\ncert]# cd ../conf/\nconf]# cp /opt/kubernetes/server/bin/conf/* .\nconf]# cd ..\nbin]# cp /opt/kubernetes/server/bin/*.sh .\nbin]# cd /opt\nopt]# rm -rf kubernetes\nopt]# ln -s /opt/kubernetes-v1.15.4/ /opt/kubernetes\n# ç”Ÿäº§ä¸Šæ˜¯ä¸€ä¸ªä¸€ä¸ªæ¥ï¼Œæˆ‘è¿™é‡Œæ˜¯ä¸€èµ·\nopt]# supervisorctl restart all\nopt]# supervisorctl status\nopt]# kubectl get nodes\n~~~\n\n![1579246714293](assets/1579246714293.png)\n\n> å¦‚æœæœ‰å‡ºç°èµ·ä¸æ¥çš„æƒ…å†µï¼š\n>\n> â€‹\tå…ˆç”¨ps aux|grep [åå­—]\n>\n> â€‹\tkill -9 [id]\n>\n> â€‹\tå†å¯åŠ¨supervisorctl start [åå­—]\n\nå®Œæˆ\n\nä¸‹é¢æ˜¯ç¬¬ä¸‰æ¬¡åšçš„ç»“æœ\n\n![1582964650641](assets/1582964650641.png)\n\n<a href=\"https://github.com/ben1234560/k8s_PaaS/blob/master/%E5%8E%9F%E7%90%86%E5%8F%8A%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/Kubernetes%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5.md#%E6%B0%B4%E5%B9%B3%E6%89%A9%E5%B1%95%E5%92%8C%E6%BB%9A%E5%8A%A8%E5%8D%87%E7%BA%A7\">æ°´å¹³æ‰©å±•å’Œæ»šåŠ¨å‡çº§è¡¥å……</a>"
        },
        {
          "name": "ç»ˆç« â€”â€”å¸¸ç”¨æ“ä½œå‘½ä»¤åŠç›¸å…³æ–¹æ¡ˆ.md",
          "type": "blob",
          "size": 6.08203125,
          "content": "## ç»ˆç« â€”â€”å¸¸ç”¨æ“ä½œå‘½ä»¤åŠç›¸å…³æ–¹æ¡ˆ\n\n> æœ¬ç« èŠ‚ä¼šå¢åŠ ä¸€äº›åœ¨å·¥ä½œä¸­å¸¸ç”¨çš„æ“ä½œï¼Œä»¥åŠå¼€å‘äº¤ä»˜çš„ä¸€äº›è´´è¿‘åœºæ™¯çš„ç»„ä»¶åŠå·¥å…·ä»£æ›¿åŸæœ¬æ•™ç¨‹ä¸­çš„å†…å®¹\n\n\n\n## å‘½ä»¤\n\n### æŸ¥-PODçº§\n\nK8sæŸ¥æ—¥å¿—ä¿¡æ¯ï¼ˆdescribeå³å¯åŠ¨æ—¶çš„æè¿°ï¼Œåœ¨æœ€ä¸‹é¢çš„Eventé‡Œã€‚logsæ˜¯deployå†™å¥½çš„è¾“å‡ºæ—¥å¿—ï¼‰\n\n~~~\n# å…ˆæ‰¾åˆ°å¯¹åº”çš„podç©ºé—´å’Œåå­—ï¼Œç¬¬ä¸€åˆ—æ˜¯ç©ºé—´åï¼ˆNAMESPACEï¼‰ï¼Œç¬¬äºŒåˆ—æ˜¯podåï¼ˆPODNAMEï¼‰\nkubectl get po -A | grep $PODNAME \nkubectl describe po -n$NAMESPACE $PODNAME\nkubectl logs -n$NAMESPACE $PODNAME\n# è¿›å…¥åˆ°podé‡Œ\nkubectl exec -it -n$NAMESPACE $PODNAME -- /bin/bash\n~~~\n\nk8sæŸ¥æ‰¾podé…ç½®å†…å®¹\n\n~~~\nkubectl get $DEPLOY -n$NAMESPACE -o yaml |grep $SEARCH_SOMETHINE\n~~~\n\n> æŸ¥çœ‹å“ªä¸ªåç§°ç©ºé—´ä¸­é‚£ä¸ªç±»å‹é…ç½®é‡Œæœ‰è¿™ä¸ªå†…å®¹ï¼Œ-o yaml è¾“å‡ºyamlæ ¼å¼å†…å®¹\n\næŸ¥æŸä¸ªæœåŠ¡ip\n\n~~~\nkubectl get svc $DEPLOYNAME -n$NAMESPACE\n~~~\n\nk8sæŸ¥æ‰¾å…¨éƒ¨æœªè¿è¡ŒæˆåŠŸçš„podï¼Œ-AæŒ‡å…¨éƒ¨ï¼Œowideå¯ä»¥çœ‹åˆ°æ˜¯åœ¨å“ªä¸ªå®¿ä¸»ä¸‹\n\n~~~\nkubectl get pod -Aowide | grep -ivE 'running|completed' \n~~~\n\næ›´å¼ºå¤§çš„æŸ¥çœ‹æœªè¿è¡ŒæˆåŠŸçš„å‘½ä»¤ï¼Œå› ä¸ºæœ‰çš„podè™½ç„¶å¤„äºrunningä½†è¿˜æ˜¯0/1ï¼Œå³æœªå°±ç»ªçŠ¶æ€ï¼Œä¸‹é¢å‘½ä»¤èƒ½æŠŠæœªå°±ç»ªçš„ä¹Ÿè¿‡æ»¤å‡ºæ¥\n\n~~~\nIFS_OlD=$IFS;IFS=$'\\n';for i in `kubectl get po -A -owide|grep -v NAME|grep -v Comple`;do desire=`echo $i|awk '{print $3}'|awk -F '/' '{print $1}'`;reality=`echo $i|awk '{print $3}'|awk -F '/' '{print $2}'`;if [[ \"$desire\" != \"$reality\" ]];then echo $i; fi; done;IFS=$IFS_OLD\n~~~\n\n\n\n### æŸ¥-NODEçº§\n\n~~~\n# æŸ¥çœ‹æœ‰å¤šä¸ªèŠ‚ç‚¹\nkubectl get nodes\n# æŸ¥çœ‹é›†ç¾¤ä¿¡æ¯\nkubectl cluster-info\n# æ˜¾ç¤ºèŠ‚ç‚¹çš„èµ„æºä½¿ç”¨æƒ…å†µ\nkubectl top node\n~~~\n\næŸ¥çœ‹nodeçš„èµ„æºä½¿ç”¨æƒ…å†µ\n\n~~~\nfor node in `kubectl get node | awk '{print $1}'|grep -v NAME`;do echo \"======$node\"; echo \"==Capacity:\" ;kubectl describe  node $node | grep -A 12 \"Capacity:\" | grep -E \"cpu:|memory:|nvidia.com\\/gpu|vcuda-core|vcuda-memory:\"; echo \"=request&limit:\"; kubectl describe node $node |grep -E \"cpu | memory  |nvidia.com/gpu                             |vcuda-core               |vcuda-memory                \" ;done\n~~~\n\n\n\n\n\n### åˆ ï¼ˆé‡å¯ï¼Œé‡äº‹ä¸å†³é‡å¯podï¼‰\n\né‡å¯/åˆ é™¤ä¸åŒç©ºé—´ä¸‹çš„ä¸åŒæ¡ä»¶çš„podï¼Œ-Açœ‹åˆ°å…¨éƒ¨\n\n~~~\nkubectl get pod -A | grep -E 'testA| testB' | awk '{print $1\" \"$2}' | while read line ; do kubectl delete pod -n $line ; done\n~~~\n\n> å¯ä»¥å…ˆä½¿ç”¨å¦‚ä¸‹å‘½ä»¤ç¡®è®¤è¿‡æ»¤å‡ºæ¥çš„å‘½åç©ºé—´å’Œpodæ˜¯å¦ä¸€è‡´ï¼Œå…¶ä¸­testAå’ŒtestBæ˜¯è¦è¿‡æ»¤å‡ºæ¥çš„podå\n>\n> ~~~\n> kubectl get pod -A | grep -E 'testA| testB' | awk '{print $1\" \"$2}' \n> ~~~\n>\n> ä¹Ÿå¯ä»¥ä½¿ç”¨å¦‚ä¸‹æ–¹æ³•æ¥é‡å¯/åˆ é™¤ä¸åŒå‘½åç©ºé—´ä¸‹érunningçŠ¶æ€çš„pod\n>\n> ~~~\n> kubectl get pod -A | grep -ivE 'running|completed' | awk '{print $1\" \"$2}' | while read line ; do kubectl delete pod -n $line ; done\n> ~~~\n>\n> å¼ºåˆ¶é‡å¯ï¼Œåœ¨delete pod åé¢è·Ÿä¸Š --grace-period=0 --force\n>\n> ~~~\n> kubectl get pod -A | grep -ivE 'running|completed' | awk '{print $1\" \"$2}' | while read line ; do kubectl delete pod --grace-period=0 --force -n $line ; done\n> ~~~\n>\n> \n\nå…¨éƒ¨é‡å¯/åˆ é™¤æŒ‡å®šç©ºé—´ä¸‹çš„pod\n\n~~~\nkubectl delete pods --all -n$NAMESPACE\nkubectl delete --all pods --namespace=$NAMESPACE\n~~~\n\n> åˆ é™¤deployä¹‹å‰å¯ä»¥å…ˆæ‰¹é‡ä¸‹è½½åˆ°ä¸€ä¸ªæ–‡ä»¶ï¼Œkubectl get deploy -n$NAMESPACE -o yaml > backup.yamlï¼Œç„¶åå†æ‰¹é‡åˆ›å»º kubectl create -f backup.yaml  -n$NAMESPACE\n\næ‰¹é‡é‡å¯/åˆ é™¤æŒ‡å®šç©ºé—´ä¸‹çš„pod\n\n~~~\nkubectl get pods -n$NAMESPACE| grep -v Running | awk '{print $1}' | xargs kubectl delete pod -n$NAMESPACE\n~~~\n\n> grep -vï¼šåå–æ²¡æœ‰runningçŠ¶æ€çš„pod\n>\n>  awk '{print $1}' ï¼šstdinå‡ºæ¥podåå­—ï¼Œä¼ é€’ç»™xargsä½¿ç”¨\n\n\n\n### å¢\n\n~~~\n# ä¸€èˆ¬æœ‰ç°æˆçš„xxx.yamlæ–‡ä»¶ï¼Œå¦‚ä¸‹ï¼š\napiVersion: v1\nkind: Pod\nmetadata:\n  name: my-pod\nspec:\n  containers:\n  - name: my-container\n    image: nginx\n    ports:\n    - containerPort: 80\n# å®šä¹‰äº†ä¸€ä¸ªåä¸º my-pod çš„ Podï¼Œå®ƒè¿è¡Œä¸€ä¸ªå•ç‹¬çš„å®¹å™¨ï¼Œè¯¥å®¹å™¨ä½¿ç”¨ nginx é•œåƒï¼Œå¹¶ä¸”å¼€æ”¾äº† 80 ç«¯å£ã€‚\nkubectl apply -f pod-example.yaml\n# æˆ–è€…ç›´æ¥è¿è¡Œå‘½ä»¤\nkubectl run my-pod --image=nginx --port=80\n~~~\n\n\n\n### æ”¹\n\n~~~\n# ä»¥ä¸Šé¢åˆ›å»ºçš„podä¸ºä¾‹å­ï¼Œå…ˆå¯¼å‡ºyamlåˆ°æœ¬åœ°ã€‚ä¸€èˆ¬éƒ½æœ‰å‘½åç©ºé—´\nkubectl get deploy -n$NAMESPACE my-deployment -o yaml > my-deployment.yaml\n\n# ç¼–è¾‘ç°æœ‰çš„deployï¼Œç¼–è¾‘åä¿å­˜é€€å‡º\nkubectl edit deploy -n$NAMESPACE my-deployment\n\n# å¼‚å¸¸å›æ»šæ–¹æ³•ä¸€ï¼š\nkubectl rollout undo deployment my-deployment\n# å¼‚å¸¸å›æ»šæ–¹æ³•äºŒï¼ˆapplyä¹‹å‰ä¿ç•™çš„yamlæ–‡ä»¶ï¼Œæ¢å¤æ—§é…ç½®ï¼‰ï¼š\nkubectl apply -f my-deployment.yaml\n~~~\n\n\n\n## ç›¸å…³æ–¹æ¡ˆ\n\n### å…³äºç›‘æ§\n\nç¬¬ä¸ƒç« èŠ‚ä¸­ï¼Œæˆ‘ä»¬ç”¨åˆ°Promtheusæ¥åšç›‘æ§ï¼Œéšç€ä¸æ–­æ›´æ–°æ¢ä»£ï¼Œä¸ºäº†æ›´è½»ä¾¿ã€å¿«é€Ÿå’Œç®€æ´ï¼Œä»¥åŠæ›´å¥½çš„å…¼å®¹å…¶ä»–ä¸åŒç¨‹åºï¼Œæˆ‘ä»¬ä¼šé‡‡ç”¨Jaegerã€ELKã€Telegrafã€Grafanaçš„ç»„åˆï¼Œå†åŠ ä¸Šæ—¶åºæ•°æ®åº“InfluxDBã€‚å»æ‰Dashboardã€Promtheusï¼Œå› ä¸ºå®¢æˆ·åªéœ€è¦å¼€å‘å¹³å°ï¼Œè€Œä¸éœ€è¦é¢‘ç¹çš„ä¿®æ”¹k8sã€‚\n\n- **Jaegerï¼šåˆ†å¸ƒå¼è¿½è¸ªç³»ç»Ÿ**ï¼ˆgoè¯­è¨€ï¼‰ï¼Œå¾®æœåŠ¡ç³»ç»Ÿæ›´éœ€è¦å…¨é“¾è·¯è·Ÿè¸ªï¼Œä¼ ç»Ÿä¸­ï¼Œé¡µé¢bugæˆ‘ä»¬ä¼šå¼€å§‹æ’æŸ¥å‰ç«¯é—®é¢˜ï¼Œå‰ç«¯ç¡®è®¤æ²¡é—®é¢˜è¯´è°ƒç”¨æ¥å£æœ‰é”™è¯¯æ—¥å¿—ï¼Œæˆ‘ä»¬åœ¨å»çœ‹åç«¯ï¼Œçœ‹å®Œåç«¯è¯´åº•å±‚å°±æŠ¥é”™æˆ‘ä»¬å†å»æ’æŸ¥é›†ç¾¤é—®é¢˜å®åœ¨å¤ªè€—è´¹æ—¶é—´äº†ï¼Œè€Œå…¨é“¾è·¯è·Ÿè¸ªå¯ä»¥ç›´æ¥æ˜äº†çš„çœ‹åˆ°æ˜¯å“ªä¸€ç¯èŠ‚çš„é—®é¢˜ã€‚\n- **ELKï¼šESã€Logstashã€Kibana**\n- **Telegrafï¼šæ•°æ®é‡‡é›†å·¥å…·**ï¼ˆgoè¯­è¨€ï¼‰ï¼Œä»£æ›¿Prometheus\n- **InfluxDBï¼šæ—¶åºæ•°æ®åº“**ï¼ˆgoè¯­è¨€ï¼‰ï¼Œä»£æ›¿TSDBï¼Œå„ä¸ªæŒ‡æ ‡éƒ½é«˜äºTSDBï¼Œéšç€æ¨å‡ºæ—¶é—´è¶Šæ¥è¶Šä¹…ï¼Œå¯¹å¸‚é¢ä¸Šçš„äº§å“ä¹Ÿå·²ç»å¾ˆå…¼å®¹äº†ã€‚\n- **Grafanaï¼šç›‘æ§æŒ‡æ ‡å±•ç¤ºå·¥å…·**ï¼ˆgoè¯­è¨€ï¼‰\n\n##### å…³äºInfluxDBåœ¨å®é™…åº”ç”¨ä¸­é‡åˆ°çš„æƒ…å†µ\n\nåœ¨ç”Ÿäº§ä¸­ç”±äºæœºå™¨æ•°è¿‡å¤šï¼Œä½¿ç”¨é»˜è®¤é…ç½®çš„InfluxDBç›´æ¥æ’‘çˆ†å†…å­˜ï¼Œé‡å¯å†…å­˜ä¼šé€æ¸å¢å¤§ç„¶åæŒ‚æ‰ï¼Œä¹Ÿæ²¡åŠæ³•è¿›å…¥ï¼Œä¼šæŠ¥refusedå¹¶æç¤ºç¡®è®¤æ˜¯å¦åœ¨runningï¼Œè§£å†³åŠæ³•æ˜¯ç›´æ¥æŠŠinfluxå¯¹åº”çš„è·¯å¾„ä¸‹å¤§çš„æ•°æ®ç›®å½•_retentionç»“å°¾ä¸‹çš„æ•°å­—æ–‡ä»¶å¤¹å…¨éƒ¨åˆ æ‰ï¼Œè¿™æ ·å°±æœ‰è¶³å¤Ÿçš„ç©ºé—´ï¼Œè¿›å…¥influxä¿®æ”¹æ•°æ®ä¿å­˜æ—¥æœŸ`alter retention policy \"db_name__retention\" on \"db_name\" duration 7d default`"
        },
        {
          "name": "è½¯ä»¶åŒ…",
          "type": "tree",
          "content": null
        }
      ]
    }
  ]
}