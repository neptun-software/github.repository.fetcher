{
  "metadata": {
    "timestamp": 1736712360138,
    "page": 35,
    "hasNextPage": true,
    "endCursor": "Y3Vyc29yOjQw",
    "completionStatus": "IN_PROGRESS"
  },
  "repositories": [
    {
      "nameWithOwner": "librespeed/speedtest",
      "stars": 12496,
      "defaultBranch": "master",
      "files": [
        {
          "name": ".github",
          "type": "tree",
          "content": null
        },
        {
          "name": ".gitignore",
          "type": "blob",
          "size": 0.0791015625,
          "content": "results/idObfuscation_salt.php\nbackend/getIP_serverLocation.php\ndb-dir/\n.vscode/\n"
        },
        {
          "name": ".logo",
          "type": "tree",
          "content": null
        },
        {
          "name": "Dockerfile",
          "type": "blob",
          "size": 1.11328125,
          "content": "FROM php:8-apache\n\n# use docker-php-extension-installer for automatically get the right packages installed\nADD --chmod=0755 https://github.com/mlocati/docker-php-extension-installer/releases/latest/download/install-php-extensions /usr/local/bin/\n\n\n# Install extensions\nRUN install-php-extensions iconv gd pdo pdo_mysql pdo_pgsql pgsql\n\nRUN rm -f /usr/src/php.tar.xz /usr/src/php.tar.xz.asc \\\n    && apt autoremove -y \\\n    && rm -rf /var/lib/apt/lists/*\n\n# Prepare files and folders\nRUN mkdir -p /speedtest/\n\n# Copy sources\nCOPY backend/ /speedtest/backend\n\nCOPY results/*.php /speedtest/results/\nCOPY results/*.ttf /speedtest/results/\n\nCOPY *.js /speedtest/\nCOPY favicon.ico /speedtest/\n\nCOPY docker/servers.json /servers.json\n\nCOPY docker/*.php /speedtest/\nCOPY docker/entrypoint.sh /\n\n# Prepare default environment variables\nENV TITLE=LibreSpeed\nENV MODE=standalone\nENV PASSWORD=password\nENV TELEMETRY=false\nENV ENABLE_ID_OBFUSCATION=false\nENV REDACT_IP_ADDRESSES=false\nENV WEBPORT=8080\n\n# https://httpd.apache.org/docs/2.4/stopping.html#gracefulstop\nSTOPSIGNAL SIGWINCH\n\n# Final touches\nEXPOSE ${WEBPORT}\nCMD [\"bash\", \"/entrypoint.sh\"]\n"
        },
        {
          "name": "Dockerfile.alpine",
          "type": "blob",
          "size": 1.3671875,
          "content": "FROM php:8-alpine\nRUN apk add --quiet --no-cache \\\n    bash \\\n    apache2 \\\n    php-apache2 \\\n    php-ctype \\\n    php-gd \\\n    php-openssl \\\n    php-pdo \\\n    php-pdo_mysql \\\n    php-pdo_pgsql \\\n    php-pdo_sqlite \\\n    php-pgsql \\\n    php-session \\\n    php-sqlite3\n\n# use docker-php-extension-installer for automatically get the right packages installed\nADD --chmod=0755 https://github.com/mlocati/docker-php-extension-installer/releases/latest/download/install-php-extensions /usr/local/bin/\n\n\n\n# Install extensions\nRUN install-php-extensions iconv gd pdo pdo_mysql pdo_pgsql pgsql\n\nRUN ln -sf /dev/stdout /var/log/apache2/access.log && \\\n    ln -sf /dev/stderr /var/log/apache2/error.log\n\n# Prepare files and folders\nRUN mkdir -p /speedtest/\n\n# Copy sources\nCOPY backend/ /speedtest/backend\n\nCOPY results/*.php /speedtest/results/\nCOPY results/*.ttf /speedtest/results/\n\nCOPY *.js /speedtest/\nCOPY favicon.ico /speedtest/\n\nCOPY docker/servers.json /servers.json\n\nCOPY docker/*.php /speedtest/\nCOPY docker/entrypoint.sh /\n\n# Prepare default environment variables\nENV TITLE=LibreSpeed\nENV MODE=standalone\nENV PASSWORD=password\nENV TELEMETRY=false\nENV ENABLE_ID_OBFUSCATION=false\nENV REDACT_IP_ADDRESSES=false\nENV WEBPORT=8080\n\n# https://httpd.apache.org/docs/2.4/stopping.html#gracefulstop\nSTOPSIGNAL SIGWINCH\n\nWORKDIR /var/www/html\n\n# Final touches\nEXPOSE ${WEBPORT}\nCMD [\"bash\", \"/entrypoint.sh\"]\n"
        },
        {
          "name": "LICENSE",
          "type": "blob",
          "size": 7.47265625,
          "content": "                   GNU LESSER GENERAL PUBLIC LICENSE\n                       Version 3, 29 June 2007\n\n Copyright (C) 2007 Free Software Foundation, Inc. <https://fsf.org/>\n Everyone is permitted to copy and distribute verbatim copies\n of this license document, but changing it is not allowed.\n\n\n  This version of the GNU Lesser General Public License incorporates\nthe terms and conditions of version 3 of the GNU General Public\nLicense, supplemented by the additional permissions listed below.\n\n  0. Additional Definitions.\n\n  As used herein, \"this License\" refers to version 3 of the GNU Lesser\nGeneral Public License, and the \"GNU GPL\" refers to version 3 of the GNU\nGeneral Public License.\n\n  \"The Library\" refers to a covered work governed by this License,\nother than an Application or a Combined Work as defined below.\n\n  An \"Application\" is any work that makes use of an interface provided\nby the Library, but which is not otherwise based on the Library.\nDefining a subclass of a class defined by the Library is deemed a mode\nof using an interface provided by the Library.\n\n  A \"Combined Work\" is a work produced by combining or linking an\nApplication with the Library.  The particular version of the Library\nwith which the Combined Work was made is also called the \"Linked\nVersion\".\n\n  The \"Minimal Corresponding Source\" for a Combined Work means the\nCorresponding Source for the Combined Work, excluding any source code\nfor portions of the Combined Work that, considered in isolation, are\nbased on the Application, and not on the Linked Version.\n\n  The \"Corresponding Application Code\" for a Combined Work means the\nobject code and/or source code for the Application, including any data\nand utility programs needed for reproducing the Combined Work from the\nApplication, but excluding the System Libraries of the Combined Work.\n\n  1. Exception to Section 3 of the GNU GPL.\n\n  You may convey a covered work under sections 3 and 4 of this License\nwithout being bound by section 3 of the GNU GPL.\n\n  2. Conveying Modified Versions.\n\n  If you modify a copy of the Library, and, in your modifications, a\nfacility refers to a function or data to be supplied by an Application\nthat uses the facility (other than as an argument passed when the\nfacility is invoked), then you may convey a copy of the modified\nversion:\n\n   a) under this License, provided that you make a good faith effort to\n   ensure that, in the event an Application does not supply the\n   function or data, the facility still operates, and performs\n   whatever part of its purpose remains meaningful, or\n\n   b) under the GNU GPL, with none of the additional permissions of\n   this License applicable to that copy.\n\n  3. Object Code Incorporating Material from Library Header Files.\n\n  The object code form of an Application may incorporate material from\na header file that is part of the Library.  You may convey such object\ncode under terms of your choice, provided that, if the incorporated\nmaterial is not limited to numerical parameters, data structure\nlayouts and accessors, or small macros, inline functions and templates\n(ten or fewer lines in length), you do both of the following:\n\n   a) Give prominent notice with each copy of the object code that the\n   Library is used in it and that the Library and its use are\n   covered by this License.\n\n   b) Accompany the object code with a copy of the GNU GPL and this license\n   document.\n\n  4. Combined Works.\n\n  You may convey a Combined Work under terms of your choice that,\ntaken together, effectively do not restrict modification of the\nportions of the Library contained in the Combined Work and reverse\nengineering for debugging such modifications, if you also do each of\nthe following:\n\n   a) Give prominent notice with each copy of the Combined Work that\n   the Library is used in it and that the Library and its use are\n   covered by this License.\n\n   b) Accompany the Combined Work with a copy of the GNU GPL and this license\n   document.\n\n   c) For a Combined Work that displays copyright notices during\n   execution, include the copyright notice for the Library among\n   these notices, as well as a reference directing the user to the\n   copies of the GNU GPL and this license document.\n\n   d) Do one of the following:\n\n       0) Convey the Minimal Corresponding Source under the terms of this\n       License, and the Corresponding Application Code in a form\n       suitable for, and under terms that permit, the user to\n       recombine or relink the Application with a modified version of\n       the Linked Version to produce a modified Combined Work, in the\n       manner specified by section 6 of the GNU GPL for conveying\n       Corresponding Source.\n\n       1) Use a suitable shared library mechanism for linking with the\n       Library.  A suitable mechanism is one that (a) uses at run time\n       a copy of the Library already present on the user's computer\n       system, and (b) will operate properly with a modified version\n       of the Library that is interface-compatible with the Linked\n       Version.\n\n   e) Provide Installation Information, but only if you would otherwise\n   be required to provide such information under section 6 of the\n   GNU GPL, and only to the extent that such information is\n   necessary to install and execute a modified version of the\n   Combined Work produced by recombining or relinking the\n   Application with a modified version of the Linked Version. (If\n   you use option 4d0, the Installation Information must accompany\n   the Minimal Corresponding Source and Corresponding Application\n   Code. If you use option 4d1, you must provide the Installation\n   Information in the manner specified by section 6 of the GNU GPL\n   for conveying Corresponding Source.)\n\n  5. Combined Libraries.\n\n  You may place library facilities that are a work based on the\nLibrary side by side in a single library together with other library\nfacilities that are not Applications and are not covered by this\nLicense, and convey such a combined library under terms of your\nchoice, if you do both of the following:\n\n   a) Accompany the combined library with a copy of the same work based\n   on the Library, uncombined with any other library facilities,\n   conveyed under the terms of this License.\n\n   b) Give prominent notice with the combined library that part of it\n   is a work based on the Library, and explaining where to find the\n   accompanying uncombined form of the same work.\n\n  6. Revised Versions of the GNU Lesser General Public License.\n\n  The Free Software Foundation may publish revised and/or new versions\nof the GNU Lesser General Public License from time to time. Such new\nversions will be similar in spirit to the present version, but may\ndiffer in detail to address new problems or concerns.\n\n  Each version is given a distinguishing version number. If the\nLibrary as you received it specifies that a certain numbered version\nof the GNU Lesser General Public License \"or any later version\"\napplies to it, you have the option of following the terms and\nconditions either of that published version or of any later version\npublished by the Free Software Foundation. If the Library as you\nreceived it does not specify a version number of the GNU Lesser\nGeneral Public License, you may choose any version of the GNU Lesser\nGeneral Public License ever published by the Free Software Foundation.\n\n  If the Library as you received it specifies that a proxy can decide\nwhether future versions of the GNU Lesser General Public License shall\napply, that proxy's public statement of acceptance of any version is\npermanent authorization for you to choose that version for the\nLibrary.\n"
        },
        {
          "name": "README.md",
          "type": "blob",
          "size": 3.83984375,
          "content": "![LibreSpeed Logo](https://github.com/librespeed/speedtest/blob/master/.logo/logo3.png?raw=true)\n\n# LibreSpeed\n\nNo Flash, No Java, No Websocket, No Bullshit.\n\nThis is a very lightweight speed test implemented in Javascript, using XMLHttpRequest and Web Workers.\n\n## Try it\n\n[Take a speed test](https://librespeed.org)\n\n## Compatibility\n\nAll modern browsers are supported: IE11, latest Edge, latest Chrome, latest Firefox, latest Safari.\nWorks with mobile versions too.\n\n## Features\n\n* Download\n* Upload\n* Ping\n* Jitter\n* IP Address, ISP, distance from server (optional)\n* Telemetry (optional)\n* Results sharing (optional)\n* Multiple Points of Test (optional)\n\n![Screenrecording of a running Speedtest](https://speedtest.fdossena.com/mpot_v6.gif)\n\n## Server requirements\n\n* A reasonably fast web server with Apache 2 (nginx, IIS also supported)\n* PHP 5.4 or newer (other backends also available)\n* MariaDB or MySQL database to store test results (optional, Microsoft SQL Server, PostgreSQL and SQLite also supported)\n* A fast! internet connection\n\n## Installation\n\nAssuming you have PHP and a web server installed, the installation steps are quite simple.\n\n1. Download the source code and extract it\n1. Copy the following files to your web server's shared folder (ie. /var/www/html/speedtest for Apache): index.html, speedtest.js, speedtest_worker.js, favicon.ico and the backend folder\n1. Optionally, copy the results folder too, and set up the database using the config file in it.\n1. Be sure your permissions allow execute (755).\n1. Visit YOURSITE/speedtest/index.html and voila!\n\n### Installation Video\n\nThis video shows the installation process of a standalone LibreSpeed server: [Quick start installation guide for Debian 12](https://fdossena.com/?p=speedtest/quickstart_deb12.frag)\n\nMore videos will be added later.\n\n## Android app\n\nA template to build an Android client for your LibreSpeed installation is available [here](https://github.com/librespeed/speedtest-android).\n\n## CLI client\n\nA command line client is available [here](https://github.com/librespeed/speedtest-cli).\n\n## Docker\n\nA docker image is available on [GitHub](https://github.com/librespeed/speedtest/pkgs/container/speedtest), check our [docker documentation](doc_docker.md) for more info about it.\nThe image is built every week to include an updated version of the ipinfo-DB used for ISP detection. Also this ensures, that the latest security patches in PHP are installed. Therefore we recommend to use the `latest` image.\n\n## Go backend\n\nA Go implementation is available in the [`speedtest-go`](https://github.com/librespeed/speedtest-go) repo, maintained by [Maddie Zhan](https://github.com/maddie).\n\n## Rust backend\n\nA Rust implementation is available in the [`speedtest-rust`](https://github.com/librespeed/speedtest-rust) repo, maintained by [Sudo Dios](https://github.com/sudodios).\n\n## Node.js backend\n\nA partial Node.js implementation is available in the `node` branch, developed by [dunklesToast](https://github.com/dunklesToast). It's not recommended to use at the moment.\n\n## Donate\n\n[![Donate with Liberapay](https://liberapay.com/assets/widgets/donate.svg)](https://liberapay.com/fdossena/donate)\n[Donate with PayPal](https://www.paypal.me/sineisochronic)\n\n## License\n\nCopyright (C) 2016-2024 Federico Dossena\n\nThis program is free software: you can redistribute it and/or modify\nit under the terms of the GNU Lesser General Public License as published by\nthe Free Software Foundation, either version 3 of the License, or\n(at your option) any later version.\n\nThis program is distributed in the hope that it will be useful,\nbut WITHOUT ANY WARRANTY; without even the implied warranty of\nMERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\nGNU General Public License for more details.\n\nYou should have received a copy of the GNU Lesser General Public License\nalong with this program.  If not, see <https://www.gnu.org/licenses/lgpl>.\n"
        },
        {
          "name": "backend",
          "type": "tree",
          "content": null
        },
        {
          "name": "doc.md",
          "type": "blob",
          "size": 45.5869140625,
          "content": "# LibreSpeed\n\n> by Federico Dossena\n> Version 5.4.1\n> [https://github.com/librespeed/speedtest/](https://github.com/librespeed/speedtest/)\n\n## Introduction\n\nLibreSpeed is a Free and Open Source speed test that you can host on your server(s), and users can run in their browser.\n\n__Features:__\n\n* Download test\n* Upload test\n* Ping and Jitter test\n* IP address, ISP and distance detection\n* Telemetry (optional)\n* Results sharing (optional)\n* Multiple Points of Test (optional)\n\n__Browser support:__\nThe test supports any browser that supports XHR Level 2 and Web Workers. JavaScript must be enabled.\n\nThe following browsers are officially supported:\n\n* Internet Explorer 11\n* Microsoft Edge (last 2 versions)\n* Mozilla Firefox (latest ESR and last 2 versions)\n* Google Chrome and other Chromium-based browsers (last 2 versions)\n* Apple Safari (last 2 versions)\n* Opera (last 2 versions)\n\nClient side, the test can use up to 500MB of RAM on very fast connections.\n\n## Quick start guides\n\nThis video shows the installation process of a standalone LibreSpeed server: [Quick start installation guide for Debian 12](https://fdossena.com/?p=speedtest/quickstart_deb12.frag)\n\nMore videos will be added later.\n\n## Installation\n\n### Single server, PHP\n\nServer side, you'll need:\n\n* Apache 2 (nginx and IIS also supported). A fast internet connection is required (possibly gigabit), and the web server must accept large POST requests (up to 20MB)\n* PHP 5.4 or newer (8.0 required for ISP and distance detection), a 64-bit version is strongly recommended\n* OpenSSL and its PHP module (this is usually installed automatically by most distros)\n* If you want to store test results (telemetry), one of the following:\n  * MySQL/MariaDB and its PHP PDO module\n  * PostgreSQL and its PHP PDO module\n  * SQLite 3 and its PHP PDO module\n  * MSSQL and its PHP PDO module (Windows only)\n* If you want to enable results sharing (these are usually installed automatically by most distros when you install PHP):\n  * FreeType 2 and its PHP module\n  * The PHP gd library\n\nLet's install the speed test.\n\nPut all files on your web server via FTP or by copying them directly. You can install it in the root, or in a subdirectory.\n\n__Important:__ The speed test needs write permissions in the installation folder!\n\n#### ipinfo.io\n\nThe speed test uses the [ipinfo.io](https://ipinfo.io) offline database to detect ISP and country (CC-BY-SA 4.0 license), enabled by default.\nIt's possible to use the full [ipinfo.io](https://ipinfo.io) API to detect distance from server as well. This is completely optional and can be enabled by obtaining an [access token](https://ipinfo.io) and putting it in `backend/getIP_ipInfo_apikey.php`. When this feature is enabled, the offline database will only be used as fallback.\n\n#### Telemetry and results sharing\n\nThe test supports storing test results and can generate shareable images that users can embed in forum signatures and such.\n\nTo use this function, you will need a database. The test supports MySQL, PostgreSQL and SQLite as backends.\n\n##### Creating the database\n\nThis step is only required for MySQL, PostgreSQL and MSSQL. If you want to use SQLite, skip to the next step.\n\nLog into your database using phpMyAdmin or a similar software and create a new database. Inside the `results` folder you will find `telemetry_mysql.sql`, `telemetry_postgresql.sql` and `telemetry_mssql.sql`, which are templates for MySQL, PostgreSQL and MSSQL respectively. Import the one you need, and you will see a `speedtest_users` table in the database. You can delete the templates afterwards.\n\n##### Configuring telemetry\n\nOpen `results/telemetry_settings.php` in a text editor. Set `$db_type` to either `mysql`,`postgresql`, `mssql` or `sqlite`.\n\nIf you chose to use SQLite, you might want to change `$Sqlite_db_file` to another path where you want the database to be stored. Just make sure that the file cannot be downloaded by users. Sqlite doesn't require any additional configuration, you can skip the rest of this section.\n\nIf you chose to use MySQL, you must set your database credentials:\n\n```php\n$MySql_username=\"USERNAME\"; //your database username\n$MySql_password=\"PASSWORD\"; //your database password\n$MySql_hostname=\"DB_HOSTNAME\"; //database address, usually localhost\n$MySql_databasename=\"DB_NAME\"; //the name of the database where you loaded telemetry_mysql.sql\n```\n\nIf you chose to use PostgreSQL, you must set your database credentials:\n\n```php\n$PostgreSql_username=\"USERNAME\"; //your database username\n$PostgreSql_password=\"PASSWORD\"; //your database password\n$PostgreSql_hostname=\"DB_HOSTNAME\"; //database address, usually localhost\n$PostgreSql_databasename=\"DB_NAME\"; //the name of the database where you loaded telemetry_postgresql.sql\n```\n\nIfyou chose to use MSSQL, you must set your database credentials:\n\n```php\n$MsSql_server = 'DB_HOSTNAME';\n$MsSql_databasename = 'DB_NAME';\n$MsSql_WindowsAuthentication = true;   //true or false\n$MsSql_username = 'USERNAME';          //not used if MsSql_WindowsAuthentication is true\n$MsSql_password = 'PASSWORD';          //not used if MsSql_WindowsAuthentication is true\n$MsSql_TrustServerCertificate = true;  //true, false or comment out for driver default\n```\n\n##### Results sharing\n\nThis feature generates an image that can be share by the user containing the download, upload, ping, jitter and ISP (if enabled).\n\nBy default, the telemetry generates a progressive ID for each test. Even if no sensitive information is leaked, you might not want users to be able to guess other test IDs. To avoid this, you can turn on ID obfuscation, which turns IDs into a reversible hash, much like YouTube video IDs.\n\nTo enable ID obfuscation, edit `results/telemetry_settings.php` and set `$enable_id_obfuscation` to `true`. From now on, all test IDs will be obfuscated using a unique salt. The IDs in the database are still progressive, but users will only know their obfuscated versions and won't be able to easily guess other IDs.\n\n__Important:__ ID obfuscation currently only works on 64-bit PHP!\n\nWhile you're editing `results/telemetry_settings.php`, you might want to set `$redact_ip_addresses` to `true`, this way, all IP addresses will be removed from the telemetry for better privacy. This is disabled by default.\n\n##### Seeing the results\n\nA basic front-end for visualizing and searching tests by ID is available in `results/stats.php`.\n\nA login is required to access the interface. __Important__: change the default password in `results/telemetry_settings.php`.\n\n#### The end\n\nNow that the test is installed, the default page uses telemetry and results sharing. If you want another UI, you can easily customize `index.html` or one of the examples in the `examples` folder (the best starting point for most people is `example-singleServer-gauges.html`).\n\nIf you're not using telemetry and results sharing, you can delete the `results` folder too.\n\nDetails about the examples and how to make custom UIs will be discussed later.\n\n#### Privacy\n\nTelemetry contains personal information (according to GDPR definition), therefore it is important to treat this data respectfully of national and international laws, especially if you plan to offer the service in the European Union.\n\nDefault `index.html` and `example-multipleServers-full.html` both contain a privacy policy for the service: you MUST read it, change it if necessary, and add your email address for data deletion requests. __Failure to comply with GDPR regulations can get you in serious trouble.__\n\n### Multiple servers, PHP\n\nThe speed test can automatically choose between multiple test points and use the one with the lowest ping in a list.\n\nNote that this is an advanced use case and it is recommended that you already know how to use the speed test with a single server.\n\nWe must distinguish 2 types of servers:\n\n* __Frontend server__: hosts the UI, the JS files, and optionally telemetry and results sharing stuff. You only need 1 of these, and this is the server that your clients will first connect to.\n* __Test backends__: the servers used to actually perform the test. There can be 1+ of these, and they only host the backend files.\n\n#### Frontend server\n\nThis is the server that your users will first connect to. It hosts the UI, the JS files, and optionally telemetry and results sharing stuff.\n\nRequirements:\n\n* Apache 2 (nginx and IIS also supported). A fast connection is not mandatory, but is still recommended\n* PHP 5.4 or newer, a 64-bit version is strongly recommended\n* If you want to store test results (telemetry), one of the following:\n  * MySQL/MariaDB and its PHP PDO module\n  * PostgreSQL and its PHP PDO module\n  * SQLite 3 and its PHP PDO module\n  * MSSQL and its PHP PDO module (Windows only)\n* If you want to enable results sharing (these are usually installed automatically by most distros when you install PHP):\n  * FreeType 2 and its PHP module\n  * The PHP gd library\n\nTo install the speed test frontend, copy the following files to your web server:\n\n* `speedtest.js`\n* `speedtest_worker.js`\n* Optionally, the `results` folder\n* `index.html` (or one of the example UIs in the `examples` folder)\n\n__Important:__ The speed test needs write permissions in the installation folder!\n\n##### Server list\n\nEdit `index.html` and uncomment the list of servers:\n\n```js\nvar SPEEDTEST_SERVERS=[\n /*{\n  name:\"Example Server 1\", //user friendly name for the server\n  server:\"//test1.mydomain.com/\", //URL to the server. // at the beginning will be replaced with http:// or https:// automatically\n  dlURL:\"backend/garbage.php\",  //path to download test on this server (garbage.php or replacement)\n  ulURL:\"backend/empty.php\",  //path to upload test on this server (empty.php or replacement)\n  pingURL:\"backend/empty.php\",  //path to ping/jitter test on this server (empty.php or replacement)\n  getIpURL:\"backend/getIP.php\"  //path to getIP on this server (getIP.php or replacement)\n },\n {\n  name:\"Example Server 2\", //user friendly name for the server\n  server:\"//test2.example.com/\", //URL to the server. // at the beginning will be replaced with http:// or https:// automatically\n  dlURL:\"garbage.php\",  //path to download test on this server (garbage.php or replacement)\n  ulURL:\"empty.php\",  //path to upload test on this server (empty.php or replacement)\n  pingURL:\"empty.php\",  //path to ping/jitter test on this server (empty.php or replacement)\n  getIpURL:\"getIP.php\"  //path to getIP on this server (getIP.php or replacement)\n }*/\n //add other servers here, comma separated\n];\n```\n\nReplace the demo servers with your test points. Each server in the list is an object containing:\n\n* `\"name\"`: user friendly name for this test point\n* `\"server\"`: URL to the server. If your server only supports HTTP or HTTPS, put http:// or https:// at the beginning, respectively; if it supports both, put // at the beginning and it will be replaced automatically\n* `\"dlURL\"`: path to the download test on this server (garbage.php or replacement)\n* `\"ulURL\"`: path to the upload test on this server (empty.php or replacement)\n* `\"pingURL\"`: path to the ping test on this server (empty.php or replacement)\n* `\"getIpURL\"`: path to getIP on this server (getIP.php or replacement)\n\nNone of these parameters can be omitted.\n\n__Important__: You can't mix HTTP with HTTPS; if the frontend uses HTTP, you won't be able to connect to HTTPS backends, and viceversa.\n\n__Important__: For HTTPS, all your servers must have valid certificates or the browser will refuse to connect.\n\nIf your list of servers changes often, you might not want to have it hardcoded in the HTML file. LibreSpeed can load the server list from a JSON file. To do this, remove the server list and replace it with the URL to your server list, like this:\n\n```js\nvar SPEEDTEST_SERVERS=\"your URL here\";\n```\n\nThe URL doesn't need to be complete, it can just point to a file in the current directory. The URL should point to a JSON file with the same format used above:\n\n```js\n[\n    {\n        \"name\":...\n    },\n    ...\n]\n```\n\n__Important:__ The same origin policy applies to which URLs you can and cannot load with this method. If possible, it's best to just point it to a file on the current server.\n\n##### Telemetry and results sharing in multiple server scenarios\n\nTelemetry is stored on the frontend server. The setup procedure is the same as the single server version.\n\n#### Test backends\n\nThese are the servers that will actually be used to perform the test.\n\nRequirements:\n\n* Apache 2 (nginx and IIS also supported). A fast internet connection is required (possibly gigabit), and the web server must accept large POST requests (up to 20MB)\n* PHP 5.4 or newer (8.0 required for ISP and distance detection)\n* OpenSSL and its PHP module (this is usually installed automatically by most distros)\n\nTo install a backend, simply copy all the files in the `backend` folder to your backend server.\n\n__Important:__ The speed test needs write permissions in the installation folder!\n\n#### ipinfo.io, see single server\n\nsee [above](#ipinfoio)\n\n## Making a custom front-end\n\nThis section explains how to use speedtest.js in your webpages.\n\nThe best way to learn is by looking at the provided examples.\n\n__Single server:__\n\n* `example-singleServer-basic.html`: The most basic configuration possible. Runs the test with the default settings when the page is loaded and displays the results with no fancy graphics.\n* `example-singleServer-pretty.html`: A more sophisticated example with a nicer layout and a start/stop button. __This is the best starting point for most users__\n* `example-singleServer-progressBar.html`: Same as `example-singleServer-pretty.html` but adds a progress indicator\n* `example-singleServer-customSettings.html`: Same as `example-singleServer-pretty.html` but configures the test so that it only performs download and upload tests, and with a fixed length instead of automatic\n* `example-singleServer-gauges.html`: The most sophisticated example, with the same functionality as `example-singleServer-pretty.html` but adds gauges. This is also a good starting point, but the gauges may slow down underpowered devices\n* `example-singleServer-chart.html`: Shows how to use the test with the Chart.js library\n* default `index.html`: A full UI that supports both single server and multiple servers installations and even has a dark theme\n\n__Multiple servers:__\n\n* `example-multipleServers-pretty.html`: Same as `example-singleServer-pretty.html` but with multiple test points. Server selection is fully automatic\n* `example-multipleServers-full.html`: Same as default `index.html` but with multiple test points. Server selection is automatic but the server can be changed afterwards by the user\n\n### Initialization\n\nTo use the speed test in your page, first you need to load it:\n\n```xml\n<script type=\"text/javascript\" src=\"speedtest.js\"></script>\n```\n\nAfter loading, you can initialize the test:\n\n```js\nvar s=new Speedtest();\n```\n\n### Event handlers\n\nNow, you can set up event handlers to update your UI:\n\n```js\ns.onupdate=function(data){\n    //update your UI here\n}\ns.onend=function(aborted){\n    //end of the test\n    if(aborted){\n        //something to do if the test was aborted instead of ending normally\n    }\n}\n```\n\nThe `onupdate` event handler will be called periodically by the test with data coming from the speed test worker thread. The `data` argument is an object containing the following:\n\n* __testState__: an integer between -1 and 5\n  * `-1` = Test not started yet\n  * `0` = Test starting\n  * `1` = Download test in progress\n  * `2` = Ping + Jitter test in progress\n  * `3` = Upload test in progress\n  * `4` = Test finished\n  * `5` = Test aborted\n* __dlStatus__: either\n  * Empty string (not started or aborted)\n  * Download speed in Megabit/s as a number with 2 decimals\n  * The string \"Fail\" (test failed)\n* __ulStatus__: either\n  * Empty string (not started or aborted)\n  * Upload speed in Megabit/s as a number with 2 decimals\n  * The string \"Fail\" (test failed)\n* __pingStatus__: either\n  * Empty string (not started or aborted)\n  * Estimated ping in milliseconds as a number with 2 decimals\n  * The string \"Fail\" (test failed)\n* __clientIp__: either\n  * Empty string (not fetched yet or failed)\n  * The client's IP address as a string (with ISP info if enabled)\n* __jitterStatus__: either\n  * Empty string (not started or aborted)\n  * Estimated jitter in milliseconds as a number with 2 decimals (lower = stable connection)\n  * The string \"Fail\" (test failed)\n* __dlProgress__: the progress of the download test as a number between 0 and 1\n* __ulProgress__: the progress of the upload test as a number between 0 and 1\n* __pingProgress__: the progress of the ping+jitter test as a number between 0 and 1\n* __testId__: when telemetry is active, this is the ID of the test in the database. This is null until the test is finished, or if telemetry encounters an error. This ID is used for results sharing\n\nThe `onend` event handler will be called at the end of the test (`onupdate` will be called first), with a boolean telling you if the test was aborted (either manually or because of an error) or if it ended normally.\n\n### Test parameters\n\nBefore starting the test, you can change some of the settings from their default values. You might want to do this to better adapt the speed test to a specific scenario, such as a satellite connection. To change a setting, use\n\n```js\ns.setParameter(\"parameter_name\",value);\n```\n\nFor instance, to enable telemetry we can use:\n\n```js\ns.setParameter(\"telemetry_level\",\"basic\");\n```\n\nAnd now the test results will be stored and we will get our test ID at the end of the test (along with the other data)\n\n__Main parameters:__\n\n* __time_dl_max__: Maximum duration of the download test in seconds. If auto duration is disabled, this is used as the duration of the test.\n  * Default: `15`\n  * Recommended: `>=5`\n* __time_ul_max__: Maximum duration of the upload test in seconds. If auto duration is disabled, this is used as the duration of the test.\n  * Default: `15`\n  * Recommended: `>=10`\n* __time_auto__: Automatically determine the duration of the download and upload tests, making them faster on faster connections, to avoid wasting data.\n  * Default: `true`\n* __count_ping__: How many pings to perform in the ping test\n  * Default: `10`\n  * Recommended: `>=3, <30`\n* __url_dl__: path to garbage.php or a large file to use for the download test.\n  * Default: `garbage.php`\n  * __Important:__ path is relative to js file\n* __url_ul__: path to an empty file or empty.php to use for the upload test\n  * Default: `empty.php`\n  * __Important:__ path is relative to js file\n* __url_ping__: path to an empty file or empty.php to use for the ping test\n  * Default: `empty.php`\n  * __Important:__ path is relative to js file\n* __url_getIp__: path to getIP.php or replacement\n  * Default: `getIP.php`\n  * __Important:__ path is relative to js file\n* __url_telemetry__: path to telemetry.php or replacement\n  * Default: `results/telemetry.php`\n  * __Important:__ path is relative to js file\n  * __Note:__ you can ignore this parameter if you're not using the telemetry\n* __telemetry_level__: The type of telemetry to use. See the telemetry section for more info about this\n  * Default: `none`\n  * `basic`: send results only\n  * `full`: send results and timing information, even for aborted tests\n  * `debug`: same as full but also sends debug information. Not recommended.\n* __test_order__: the order in which tests will be performed. You can use this to change the order of the test, or to only enable specific tests. Each character represents an operation:\n  * `I`: get IP\n  * `D`: download test\n  * `U`: upload test\n  * `P`: ping + jitter test\n  * `_`: delay 1 second\n  * Default test order: `IP_D_U`\n  * __Important:__ Tests can only be run once\n  * __Important:__ On Firefox, it is better to run the upload test last\n* __getIp_ispInfo__: if true, the server will try to get ISP info and pass it along with the IP address. This will add `isp=true` to the request to `url_getIp`. getIP.php accomplishes this using ipinfo.io\n  * Default: `true`\n* __getIp_ispInfo_distance__: if true, the server will try to get an estimate of the distance from the client to the speed test server. This will add a `distance` argument to the request to `url_getIp`. `__getIp_ispInfo__` must be enabled in order for this to work. getIP.php accomplishes this using ipinfo.io (API key required)\n  * `km`: estimate distance in kilometers\n  * `mi`: estimate distance in miles\n  * not set: do not measure distance\n  * Default: `km`\n\n__Advanced parameters:__ (Seriously, don't change these unless you know what you're doing)\n\n* __telemetry_extra__: Extra data that you want to be passed to the telemetry. This is a string field, if you want to pass an object, make sure you use ``JSON.stringify``. This string will be added to the database entry for this test.\n* __enable_quirks__: enables browser-specific optimizations. These optimizations override some of the default settings. They do not override settings that are explicitly set.\n  * Default: `true`\n* __garbagePhp_chunkSize__: size of chunks sent by garbage.php in megabytes\n  * Default: `100`\n  * Recommended: `>=10`\n  * Maximum: `1024`\n* __xhr_dlMultistream__: how many streams should be opened for the download test\n  * Default: `6`\n  * Recommended: `>=3`\n  * Default override: 3 on Edge if enable_quirks is true\n  * Default override: 5 on Chromium-based if enable_quirks is true\n* __xhr_ulMultistream__: how many streams should be opened for the upload test\n  * Default: `3`\n  * Recommended: `>=1`\n* __xhr_ul_blob_megabytes__: size in megabytes of the blobs sent during the upload test\n  * Default: `20`\n  * Default override: 4 on Chromium-based mobile browsers (limitation introduced around version 65). This will be forced\n  * Default override: IE11 and Edge currently use a different method for the upload test. This parameter is ignored\n* __xhr_multistreamDelay__: how long should the multiple streams be delayed (in ms)\n  * Default: `300`\n  * Recommended: `>=100`, `<=700`\n* __xhr_ignoreErrors__: how to react to errors in download/upload streams and the ping test\n  * `0`: Fail test on error (behaviour of previous versions of this test)\n  * `1`: Restart a stream/ping when it fails\n  * `2`: Ignore all errors\n  * Default: `1`\n  * Recommended: `1`\n* __time_dlGraceTime__: How long to wait (in seconds) before actually measuring the download speed. This is a good idea because we want to wait for the TCP window to be at its maximum (or close to it)\n  * Default: `1.5`\n  * Recommended: `>=0`\n* __time_ulGraceTime__: How long to wait (in seconds) before actually measuring the upload speed. This is a good idea because we want to wait for the buffers to be full (avoids the peak at the beginning of the test)\n  * Default: `3`\n  * Recommended: `>=1`\n* __ping_allowPerformanceApi__: toggles use of Performance API to improve accuracy of Ping/Jitter test on browsers that support it.\n  * Default: `true`\n  * Default override: `false` on Firefox because its performance API implementation is inaccurate\n* __useMebibits__: use mebibits/s instead of megabits/s for the speeds\n  * Default: `false`\n* __overheadCompensationFactor__: compensation for HTTP and network overhead. Default value assumes typical MTUs used over the Internet. You might want to change this if you're using this in your internal network with different MTUs, or if you're using IPv6 instead of IPv4.\n  * Default: `1.06` probably a decent estimate for all overhead. This was measured empirically by comparing the measured speed and the speed reported by my the network adapter.\n  * `1048576/925000`: old default value. This is probably too high.\n  * `1.0513`: HTTP+TCP+IPv6+ETH, over the Internet (empirically tested, not calculated)\n  * `1.0369`: Alternative value for HTTP+TCP+IPv4+ETH, over the Internet (empirically tested, not calculated)\n  * `1.081`: Yet another alternative value for over the Internet (empirically tested, not calculated)\n  * `1514 / 1460`: TCP+IPv4+ETH, ignoring HTTP overhead\n  * `1514 / 1440`: TCP+IPv6+ETH, ignoring HTTP overhead\n  * `1`: ignore overheads. This measures the speed at which you actually download and upload files rather than the raw connection speed\n\n### Multiple Points of Test\n\nIf you want to use more than one test server, this is the time to add all your test points and select the best one. Skip this part if you don't want to use this feature.\n\nThe best way to do this is to declare an array with all your servers, and give it to the speed test:\n\n```js\nvar SPEEDTEST_SERVERS=[\n server1,\n server2,\n ...\n];\ns.addTestPoints(SPEEDTEST_SERVERS);\n```\n\nEach server in the list is an object containing:\n\n* `name`: user friendly name for this test point\n* `server`: URL to the server. If your server only supports HTTP or HTTPS, put `http://` or `https://` at the beginning, respectively; if it supports both, put `//` at the beginning and it will be replaced automatically\n* `dlURL`: path to the download test on this server (garbage.php or replacement)\n* `ulURL`: path to the upload test on this server (empty.php or replacement)\n* `pingURL`: path to the ping test on this server (empty.php or replacement)\n* `getIpURL`: path to getIP on this server (getIP.php or replacement)\n\nNone of these parameters can be omitted.\n\nExample:\n\n```js\n{\n name:\"Milano, IT\",\n server:\"http://backend1.myspeedtest.net/\",\n dlURL:\"garbage.php\",\n ulURL:\"empty.php\",\n pingURL:\"empty.php\",\n getIpURL:\"getIP.php\"\n}\n```\n\nNow, we can run the server selector:\n\n```js\ns.selectServer(function(server){\n    //do something\n})\n```\n\nThe `selectServer` function is asynchronous in order to avoid freeing the UI, and it will run a callback function when it is done choosing the server with the lowest ping.\nThe `server` argument is the selected server, and you can display it in the UI if you want. __You cannot start the test until the selection is done!__\n\nYou can also set the test point manually (for instance, from a combobox in the UI):\n\n```js\ns.setSelectedServer(server)\n```\n\nwhere `server` is the server that you want to use.\n\n### Running the test\n\nFinally, we can run the test:\n\n```js\ns.start();\n```\n\nDuring the test, your `onupdate` event handler will be called periodically with data that you can use to update your UI. Your `onend` handler will be called at the end of the test.\n\nYou can abort the test at any time:\n\n```js\ns.abort();\n```\n\nWhen the test is finished, you can run it again if you want, or you can just destroy `s`.\n\n## Implementation details\n\nThe purpose of this section is to help developers who want to make changes to the inner workings of the speed test.\nIt will be divided into 4 sections: `speedtest.js`, `speedtest_worker.js`, the `backend` files and the `results` files.\n\n### `speedtest.js`\n\nThis is the main interface between your webpage and the speed test.\nIt hides the speed test web worker to the page, and provides many convenient functions to control the test.\n\nYou can think of this as a finite state machine. These are the states (use getState() to see them):\n\n* __0__: here you can change the speed test settings (such as test duration) with the `setParameter(\"parameter\",value)` function. From here you can either start the test using `start()` (goes to state 3) or you can add multiple test points using `addTestPoint(server)` or `addTestPoints(serverList)` (goes to state 1). Additionally, this is the perfect moment to set up callbacks for the `onupdate(data)` and `onend(aborted)` events.\n* __1__: here you can add test points. You only need to do this if you want to use multiple test points.\n    A server is defined as an object like this:\n\n    ```jsonc\n    {\n        name: \"User friendly name\",\n        server:\"http://yourBackend.com/\",   //  <---- URL to your server. You can specify http:// or https://. If your server supports both, just write // without the protocol\n        dlURL:\"garbage.php\" //   <----- path to garbage.php or its replacement on the server\n        ulURL:\"empty.php\"  //  <----- path to empty.php or its replacement on the server\n        pingURL:\"empty.php\"  //  <----- path to empty.php or its replacement on the server. This is used to ping the server by this selector\n        getIpURL:\"getIP.php\"  //  <----- path to getIP.php or its replacement on the server\n    }\n    ```\n\n    While in state 1, you can only add test points, you cannot change the test settings. When you're done, use selectServer(callback) to select the test point with the lowest ping. This is asynchronous, when it's done, it will call your callback function and move to state 2. Calling setSelectedServer(server) will manually select a server and move to state 2.\n* __2__: test point selected, ready to start the test. Use `start()` to begin, this will move to state 3\n* __3__: test running. Here, your `onupdate` event callback will be called periodically, with data coming from the worker about speed and progress. A data object will be passed to your `onupdate` function, with the following items:\n        - `dlStatus`: download speed in Mbit/s\n        - `ulStatus`: upload speed in Mbit/s\n        - `pingStatus`: ping in ms\n        - `jitterStatus`: jitter in ms\n        - `dlProgress`: progress of the download test as a float 0-1\n        - `ulProgress`: progress of the upload test as a float 0-1\n        - `pingProgress`: progress of the ping/jitter test as a float 0-1\n        - `testState`: state of the test (-1=not started, 0=starting, 1=download test, 2=ping+jitter test, 3=upload test, 4=finished, 5=aborted)\n        - `clientIp`: IP address of the client performing the test (and optionally ISP and distance)\n    At the end of the test, the `onend` function will be called, with a boolean specifying whether the test was aborted or if it ended normally.\n    The test can be aborted at any time with `abort()`.\n    At the end of the test, it will move to state 4\n* __4__: test finished. You can run it again by calling `start()` if you want.\n\n#### List of functions in the Speedtest class\n\n##### getState()\n\nReturns the state of the test: 0=adding settings, 1=adding servers, 2=server selection done, 3=test running, 4=done\n\n##### setParameter(parameter,value)\n\nChange one of the test settings from their defaults.\n\n* parameter: string with the name of the parameter that you want to set\n* value: new value for the parameter\n\nInvalid values or nonexistant parameters will be ignored by the speed test worker.\n\n##### addTestPoint(server)\n\nAdd a test point (multiple points of test)\n\n* server: the server to be added as an object. Must contain the following elements:\n\n    ```jsonc\n    {\n        name: \"User friendly name\",\n        server:\"http://yourBackend.com/\",   // URL to your server. You can specify http:// or https://. If your server supports both, just write // without the protocol\n        dlURL:\"garbage.php\", //  path to garbage.php or its replacement on the server\n        ulURL:\"empty.php\", //   path to empty.php or its replacement on the server\n        pingURL:\"empty.php\", //   path to empty.php or its replacement on the server. This is used to ping the server by this selector\n        getIpURL:\"getIP.php\", //   path to getIP.php or its replacement on the server\n    }\n    ```\n\nNote that this will add `mpot`:`true` to the parameters sent to the speed test worker.\n\n##### addTestPoints(list)\n\nSame as addTestPoint, but you can pass an array of servers\n\n##### loadServerList(url,result)\n\nLoads a list of servers from a JSON file pointed by the `url`.\n\nThe process is asynchronous and the `result` function will be called when it's done. If the request succeeded, an array containing the list of loaded servers will be passed to the function, otherwise `null` will be passed.\n\n##### getSelectedServer()\n\nReturns the selected server (multiple points of test)\n\n##### setSelectedServer()\n\nManually selects one of the test points (multiple points of test)\n\n##### selectServer(result)\n\nAutomatically selects a server from the list of added test points. The server with the lowest ping will be chosen. (multiple points of test)\n\nThe selector checks multiple servers in parallel (default: 6 streams) to speed things up if the list of servers is long.\n\nThe process is asynchronous and the passed `result` callback function will be called when it's done, then the test can be started.\n\n##### start()\n\nStarts the test.\n\nNote (multiple points of test): the selected server will be added to the `telemetry_extra` string. If this string was already set, then `telemetry_extra` will be a JSON string containing both the server and the original string\n\nDuring the test, the `onupdate(data)` callback function will be called periodically with data from the worker.\nAt the end of the test, the `onend(aborted)` function will be called with a boolean telling you if the test was aborted or if it ended normally.\n\n##### abort()\n\nAborts the test while it's running.\n\n### `speedtest_worker.js`\n\nThis is where the actual speed test code is. It receives the settings from the main thread, runs the test, and reports back the results.\n\nThe worker accepts 3 commands:\n\n* `start`: starts the test. Optionally, test settings can be passed as a JSON string after the word start and a space\n* `status`: returns the current status as a JSON string. The status string contents are the ones described in the Event handlers section in the section about making a custom front-end.\n* `abort`: aborts the test\n\n#### Parameters\n\nIn addition to the parameters listed in the Test settings section in the section about making a custom front-end, there is one additional setting:\n\n* `mpot`: set this to true to run the test with multiple points of test. This will add `cors=true` to all requests (all responses will contain CORS headers) and enable some extra quirks.\n    Default: `false`\n\n#### Download test\n\nThe download test is performed by transferring large blobs of garbage data using XHR from the server to the client.\n\nThe test uses multiple streams. If a stream finishes the download, it is restarted. The amount of downloaded data for each stream is tracked using the XHR Level 2 `onprogress` event.\n\nThe test streams are not perfectly synchronized because we don't want them to finish all at the same time if they do.\n\nEvery 200ms, a timer updates the `dlStatus` string with the current speed and calculates a \"bonus\" time by which to shorten the test depending on how high the speed is, (when `time_auto` is set to `true`).\n\nSee the code for more implementation details.\n\n#### Upload test\n\nThis works similarly to the download test, but in reverse. A large blob of garbage data is generated and it is sent to the server repeatedly using multiple streams.\n\nTo keep track of the amount of transferred data, the XHR Level 2 `upload.onprogress` event is used.\n\nThis test has a couple of complications:\n\n* Some browsers don't have a working `upload.onprogress` event. For this, we use a small blobs instead of a large one and we keep track of progress using the `onload` event. This is referred to as IE11 Workaround (but the same bug was also found in some versions of Edge and Safari)\n* When `mpot` is set to `true`, an empty request must first be sent in order to load the CORS headers before the test can start\n\nSee the code for more implementation details.\n\n#### Ping + Jitter test\n\nThe Ping/Jitter test __is NOT an ICMP ping__. This is a common misconception. You cannot use ICMP over HTTP, and certainly not in a browser.\n\nThis test works by creating a persistent HTTP connection to the server, and then repeatedly downloading an empty file, and measuring how long it takes between the request and the response.\n\nTiming can be measured as a simple timestamp difference or with the Performance API if available.\n\nJitter is the variance in ping times.\n\nSee the code for more implementation details.\n\n### `backend` files\n\n#### `garbage.php`\n\nUses OpenSSL to generate a stream of incompressible garbage data for the download test.\n\nIf accepts a `ckSize` GET parameter, which specifies how much garbage data to generate in megabytes (4-1024).\n\n#### `empty.php`\n\nAn empty file used for the upload and ping test. It only sends headers to create the connection.\n\n#### `getIP.php`\n\nReturns client IP, ISP and distance from the server.\n\nGET parameters:\n\n* `isp`: if set, fetches ISP info from ipinfo.io\n* `distance`: if set, calculates distance from server. You can specify `km` or `mi` for the format.\n\nIf `isp` is set, the output is a JSON string containing:\n\n* `processedString`: string that can be displayed to the user\n* `rawIspInfo`: info about the client as a JSON string, straight from ipinfo.io\n\nIf `isp` is not set, the output is just a string containing the client's IP address.\n\nNote: if your server is behind some proxy, firewall, VPN, etc., the client's IP address may not be detected properly. If this happens, you must analyze the traffic coming from the client to find the name of the HTTP header that contains the original IP address. `getIP.php` contains some of these headers but not all of them.\n\n#### CORS headers\n\nAll these files will send the following CORS headers if the GET parameter `cors=true` is passed to them:\n\n```header\nAccess-Control-Allow-Origin: *\nAccess-Control-Allow-Methods: GET, POST\nAccess-Control-Allow-Headers: Content-Encoding, Content-Type\n```\n\n### `results` files\n\n#### `telemetry.php`\n\nThis file stores telemetry information into the database.\n\nData is passed as POST parameters:\n\n* `ispinfo`: ISP info (if enabled, empty string otherwise)\n* `extra`: the `telemetry_extra` string passed to the worker (if set, empty string otherwise)\n* `dl`: download speed\n* `ul`: upload speed\n* `ping`: ping time\n* `jitter`: jitter value\n* `log`: telemetry log (if `telemetry_level` is set to `full` or higher, empty string otherwise)\n\n#### `index.php`\n\nGenerates a shareable results image for a given test ID.\n\nGET parameters:\n\n* `id`: ID of the test you want to display\n\nThe looks of this image can be customized by editing the variables in this file.\n\n#### `idObfuscation.php`\n\nContains the implementation of ID obfuscation and deobfuscation.\n\nSee the code for the implementation details, it's basically a bunch of bitwise operations.\n\n#### `stats.php`\n\nSimple UI to display and search test results. Not required to run the test.\n\n## Alternative backends\n\nIf for some reason you can't or don't want to use PHP, the speed test can run with other backends, or even no backend (with limited functionality).\n\nYou will need replacements for `backend/garbage.php` and `backend/empty.php` and optionally `backend/getIP.php`, and the test needs to know where to find them:\n\n```js\n//Speed test initialization\nvar s=new Speedtest();\n...\n//Custom backend\ns.setParameter(\"url_dl\",\"URL to your garbage.php replacement\");\ns.setParameter(\"url_ul\",\"URL to your empty.php replacement\");\ns.setParameter(\"url_ping\",\"URL to your empty.php replacement\");\ns.setParameter(\"url_getIp\",\"URL to your getIP.php replacement\");\n```\n\n### Replacement for `garbage.php`\n\nA replacement for `garbage.php` must generate incompressible garbage data.\n\nA large file (10-100 Mbytes) is a possible replacement. You can get one [here](http://downloads.fdossena.com/geth.php?r=speedtest-bigfile).\n\nA symlink to `/dev/urandom` is also ok.\n\nIf you want to make your own backend, see the section on the implementation details of `garbage.php`.\n\n#### Replacement for `empty.php`\n\nYour replacement must simply respond with a HTTP code 200 and send nothing else. You may want to send additional headers to disable caching. The test assumes that `Connection:keep-alive` is sent by the server.\n\nAn empty file can be used for this.\n\nIf you want to make your own backend, see the section on the implementation details of `empty.php`.\n\n#### Replacement for `getIP.php`\n\nYour replacement can simply respond with the client's IP as plaintext or do something more fancy.\n\nIf you want to make your own backend, see the section on the implementation details of `getIP.php`.\n\n### No backend\n\nThe speed test can run, albeit with limited functionality, using only a web server as backend, with no PHP or other server-side scripting.\n\nYou will be able to run the download and upload test, but no IP, ISP and distance detection, no telemetry and results sharing, and only a single point of test.\n\nTo do this, you will need:\n\n* A replacement for `garbage.php`: a large incompressible file, like [this](http://downloads.fdossena.com/geth.php?r=speedtest-bigfile). We'll call this `backend/garbage.dat`\n* A replacement for `empty.php`: an empty file will do. We'll call this `backend/empty.dat`\n\nNow you need to configure the test to use them. Look for `s=new Speedtest()` and right below it, put the following:\n\n```js\ns.setParameter(\"url_dl\",\"backend/garbage.dat\");\ns.setParameter(\"url_ul\",\"backend/empty.dat\");\ns.setParameter(\"url_ping\",\"backend/empty.dat\");\ns.setParameter(\"test_order\",\"P_D_U\");\n```\n\nThis will point to our static files and set the test to only do ping/jitter, download and upload tests.\n\n## Troubleshooting\n\nThese are the most common issues reported by users, and how to fix them. If you still need help, contact me at [info@fdossena.com](mailto:info@fdossena.com).\n\n### Download test gives very low result\n\nAre garbage.php and empty.php (or your replacements) reachable?\nPress F12, select network and start the test. Do you see errors? (cancelled requests are not errors)\nIf a small download starts, open it in a text editor. Does it say it's missing openssl_random_pseudo_bytes()? In this case, install OpenSSL (this is usually included when you install Apache and PHP on most distros).\n\n#### Upload test is inaccurate, and/or I see lag spikes\n\nCheck your server's maximum POST size, make sure it's at least 20Mbytes, possibly more\n\n#### Download and/or upload results are slightly too optimistic\n\nThe test was fine tuned to run over a typical IPv4 internet connection. If you're using it under different conditions, see the `overheadCompensationFactor` parameter.\n\n#### All tests are wrong, give extremely high results, browser lags/crashes\n\nYou're running the test on localhost, therefore it is trying to measure the speed of your loopback interface. The test is meant to be run over an Internet connection, from a different machine.\n\n#### Ping test shows double the actual ping\n\nMake sure your server is sending the `Connection:keep-alive` header\n\n#### The server is behind a load balancer, proxy, etc. and I get the wrong IP address\n\nEdit getIP.php and replace lines 14-23 with what is more appropriate in your scenario.\nExample: `$ip = $_SERVER['HTTP_X_FORWARDED_FOR'];`\n\n#### The results sharing just generates a blank image\n\nIf the image doesn't display and the browser displays a broken image icon, FreeType2 is not installed or configured properly.\nIf the image is blank, this usually happens because PHP can't find the font files inside the `results` folder. You can fix your PHP config or edit `results/index.php` and use absolute paths for the fonts. This is a [known issue with PHP](http://php.net/manual/en/function.imagefttext.php) and no real solution is known.\n\n#### My server is behind Cloudflare and I can't reach full speed on some of the tests\n\nThis is not a speed test related issue, as it can be replicated in virtually any HTTP file upload/download.\nGo to your domain's DNS settings and change \"DNS and HTTP proxy (CDN)\" to \"DNS only\", and wait for the settings to be applied (can take a few minutes).\n\n#### On Windows Server, using IIS, the upload test doesn't work, CORS errors are visible in the console\n\nThis is a configuration issue. Make a file called web.config in wwwroot and adapt the following code:\n\n```xml\n<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n<configuration>\n  <system.webServer>\n    <cors enabled=\"true\" failUnlistedOrigins=\"false\">\n      <add origin=\"*\">\n        <allowHeaders allowAllRequestedHeaders=\"true\" />\n        <allowMethods>\n          <add method=\"GET\" />\n          <add method=\"POST\" />\n          <add method=\"PUT\" />\n          <add method=\"DELETE\" />\n          <add method=\"OPTIONS\" />\n        </allowMethods>\n        <exposeHeaders>\n        </exposeHeaders>\n      </add>\n    </cors>\n  </system.webServer>\n</configuration>\n```\n\n#### ID obfuscation doesn't work (incorrect output, blank results image)\n\nID obfuscation only works on 64-bit PHP (requires PHP_INT_SIZE to be 8).\nNote that older versions of PHP 5 on Windows use PHP_INT_SIZE of 4, even if they're 64 bit. If you're in this situation, update your PHP install.\n\nAlso, make sure that the web server has write permission on the `results` folder.\n\n## Known bugs and limitations\n\n### General\n\n* The ping/jitter test is measured by seeing how long it takes for an empty XHR to complete. It is not an actual ICMP ping. Different browsers may also show different results, especially on very fast connections on slow devices.\n\n### IE specific\n\n* The upload test is not precise on very fast connections with high latency (will probably be fixed by Edge 17)\n* On IE11, a same origin policy error is erroneously triggered under unknown conditions. Seems to be related to running the test from unusual URLs like a top level domain (for instance <http://abc/speedtest>). These are bugs in IE11's implementation of the same origin policy, not in the speed test itself.\n* On IE11, under unknown circumstances, on some systems the test can only be run once, after which speedtest_worker.js will not be loaded by IE until the browser is restarted. This is a rare bug in IE11.\n\n### Firefox specific\n\n* On some Linux systems with hardware acceleration turned off, the page rendering makes the browser lag, reducing the accuracy of the ping/jitter test, and potentially even the download and upload tests on very fast connections.\n\n## Contributing\n\nSince this is an open source project, you can modify it.\n\nIf you made some changes that you think should make it into the main project, send a Pull Request on GitHub, or contact me at [info@fdossena.com](mailto:info@fdossena.com).\nWe don't require you to use a specific coding convention, write the code however you want and we'll change the formatting if necessary.\n\nDonations are also appreciated: you can donate with [PayPal](https://www.paypal.me/sineisochronic) or [Liberapay](https://liberapay.com/fdossena/donate).\n\n## License\n\nThis software is under the GNU LGPL license, Version 3 or newer.\n\nTo put it short: you are free to use, study, modify, and redistribute this software and modified versions of it, for free or for money.\nYou can also use it in proprietary software but all changes to this software must remain under the same GNU LGPL license.\n\nContact me at [info@fdossena.com](mailto:info@fdossena.com) for other licensing models.\n"
        },
        {
          "name": "doc_docker.md",
          "type": "blob",
          "size": 7.94140625,
          "content": "# Using the docker image\n\nA docker version of LibreSpeed is available here: [GitHub Packages](https://github.com/librespeed/speedtest/pkgs/container/speedtest)\n\n# Alpine Linux variant\n\nAn Alpine Linux based docker version of LibreSpeed is also available here: [GitHub Packages](https://github.com/librespeed/speedtest/pkgs/container/speedtest) under all the tags that have the `-alpine` suffix. This variant is significantly smaller but can have slightly different behaviour due to its toolchain being based in [musl](https://en.wikipedia.org/wiki/Musl) libc as mentioned in [here](https://alpinelinux.org/about/).\n\n## Quickstart\n\nIf you just want to try it, the fastest way is:\n\n```shell\ndocker run -p 80:8080 -d --name speedtest --rm ghcr.io/librespeed/speedtest\n```\n\nThen go with your browser to port 80 of your server and try it out. If port 80 is already in use, adjust the first number in 80:8080 above.\nDefault is to run in standalone mode.\n\n## Docker Compose\n\nIn production environments we would recommend using docker-compose.\n\nTo start the container using [docker compose](https://docs.docker.com/compose/) the following `docker-compose.yml` configuration can be used:\n\n```yml\nversion: '3.7'\nservices:\n  speedtest:\n    container_name: speedtest\n    image: ghcr.io/librespeed/speedtest:latest\n    restart: always\n    environment:\n      MODE: standalone\n      #TITLE: \"LibreSpeed\"\n      #TELEMETRY: \"false\"\n      #ENABLE_ID_OBFUSCATION: \"false\"\n      #REDACT_IP_ADDRESSES: \"false\"\n      #PASSWORD:\n      #EMAIL:\n      #DISABLE_IPINFO: \"false\"\n      #IPINFO_APIKEY: \"your api key\"\n      #DISTANCE: \"km\"\n      #WEBPORT: 8080\n    ports:\n      - \"80:8080\" # webport mapping (host:container)\n```\n\nPlease adjust the environment variables according to the intended operating mode.\n\n## Standalone mode\n\nIf you want to install LibreSpeed on a single server, you need to configure it in standalone mode. To do this, set the `MODE` environment variable to `standalone`.\n\nThe test can be accessed on port 80.\n\nHere's a list of additional environment variables available in this mode:\n\n* __`TITLE`__: Title of your speed test. Default value: `LibreSpeed`\n* __`TELEMETRY`__: Whether to enable telemetry or not. If enabled, you maybe want your data to be persisted. See below. Default value: `false`\n* __`ENABLE_ID_OBFUSCATION`__: When set to true with telemetry enabled, test IDs are obfuscated, to avoid exposing the database internal sequential IDs. Default value: `false`\n* __`REDACT_IP_ADDRESSES`__: When set to true with telemetry enabled, IP addresses and hostnames are redacted from the collected telemetry, for better privacy. Default value: `false`\n* __`DB_TYPE`__: When set to one of the supported DB-Backends it will use this instead of the default sqlite database backend. TELEMETRY has to be set to `true`. Also you have to create the database as described in [doc.md](doc.md#creating-the-database). Supported backend types are:\n  * sqlite - no additional settings required\n  * mysql, postgresql - set additional env-variables:\n    * DB_HOSTNAME - Name or IP of the DB server\n    * DB_PORT (mysql only) - Port where DB is running\n    * DB_NAME - Name of the telemetry db\n    * DB_USERNAME, DB_PASSWORD - credentials of the user with read and update permissions to the db\n  * mssql - not supported in docker image yet (feel free to open a PR with that, has to be done in `entrypoint.sh`)\n* __`PASSWORD`__: Password to access the stats page. If not set, stats page will not allow accesses.\n* __`EMAIL`__: Email address for GDPR requests. Must be specified when telemetry is enabled.\n* __`DISABLE_IPINFO`__: If set to `true`, ISP info and distance will not be fetched from either [ipinfo.io](https://ipinfo.io) or the offline database. Default: value: `false`\n* __`IPINFO_APIKEY`__: API key for [ipinfo.io](https://ipinfo.io). Optional, but required if you want to use the full [ipinfo.io](https://ipinfo.io) APIs (required for distance measurement)\n* __`DISTANCE`__: When `DISABLE_IPINFO` is set to false, this specifies how the distance from the server is measured. Can be either `km` for kilometers, `mi` for miles, or an empty string to disable distance measurement. Requires an [ipinfo.io](https://ipinfo.io) API key. Default value: `km`\n* __`WEBPORT`__: Allows choosing a custom port for the included web server. Default value: `8080`. Note that you will have to expose it through docker with the -p argument. This is not the port where the service is exposed outside docker!\n\nIf telemetry is enabled, a stats page will be available at `http://your.server/results/stats.php`, but a password must be specified.\n\n### Persist sqlite database\n\nDefault DB driver is sqlite. The DB file is written to `/database/db.sql`.\n\nSo if you want your data to be persisted over image updates, you have to mount a volume with `-v $PWD/db-dir:/database`.\n\n#### Example Standalone Mode with telemetry\n\nThis command starts LibreSpeed in standalone mode, with persisted telemetry, ID obfuscation and a stats password, on port 86:\n\n```shell\ndocker run -e MODE=standalone -e TELEMETRY=true -e ENABLE_ID_OBFUSCATION=true -e PASSWORD=\"yourPasswordHere\" -e WEBPORT=86 -p 86:86 -v $PWD/db-dir/:/database -it ghcr.io/librespeed/speedtest\n```\n\n## Multiple Points of Test\n\nFor multiple servers, you need to set up 1+ LibreSpeed backends, and 1 LibreSpeed frontend.\n\n### Backend mode\n\nIn backend mode, LibreSpeed provides only a test point with no UI. To do this, set the `MODE` environment variable to `backend`.\n\nThe following backend files can be accessed on port 80: `garbage.php`, `empty.php`, `getIP.php`\n\nHere's a list of additional environment variables available in this mode:\n\n* __`IPINFO_APIKEY`__: API key for [ipinfo.io](https://ipinfo.io). Optional, but required if you want to use the full [ipinfo.io](https://ipinfo.io) APIs (required for distance measurement). If no API key is provided, the offline database will be used instead.\n\n#### Example Backend mode\n\nThis command starts LibreSpeed in backend mode, with the default settings, on port 80:\n\n```shell\ndocker run -e MODE=backend -p 80:8080 -it ghcr.io/librespeed/speedtest\n```\n\n### Frontend mode\n\nIn frontend mode, LibreSpeed serves clients the Web UI and a list of servers. To do this:\n\n* Set the `MODE` environment variable to `frontend`\n* Create a servers.json file with your test points. The syntax is the following:\n\n    ```jsonc\n    [\n        {\n            \"name\": \"Friendly name for Server 1\",\n            \"server\" :\"//server1.mydomain.com/\",\n            \"dlURL\" :\"garbage.php\",\n            \"ulURL\" :\"empty.php\",\n            \"pingURL\" :\"empty.php\",\n            \"getIpURL\" :\"getIP.php\"\n        },\n        {\n            \"name\": \"Friendly name for Server 2\",\n            \"server\" :\"https://server2.mydomain.com/\",\n            \"dlURL\" :\"garbage.php\",\n            \"ulURL\" :\"empty.php\",\n            \"pingURL\" :\"empty.php\",\n            \"getIpURL\" :\"getIP.php\"\n        },\n        //...more servers...\n    ]\n    ```\n\n    Note: if a server only supports HTTP or HTTPS, specify the protocol in the server field. If it supports both, just use `//`.\n* Mount this file to `/servers.json` in the container (example at the end of this file)\n\nThe test can be accessed on port 80.\n\nThe list of environment variables available in this mode is the same as [above in standalone mode](#standalone-mode).\n\n#### Example Frontend mode\n\nThis command starts LibreSpeed in frontend mode, with a given `servers.json` file, and with telemetry, ID obfuscation, and a stats password and a persistant sqlite database for results:\n\n```shell\ndocker run -e MODE=frontend -e TELEMETRY=true -e ENABLE_ID_OBFUSCATION=true -e PASSWORD=\"yourPasswordHere\" -v $PWD/servers.json:/servers.json -v $PWD/db-dir/:/database -p 80:80 -it ghcr.io/librespeed/speedtest\n```\n\n### Dual mode\n\nIn dual mode, LibreSpeed operates as a standalone server that can also connect to other test points.\nTo do this:\n\n* Set the `MODE` environment variable to `dual`\n* Follow the `servers.json` instructions for the frontend mode\n* The first server entry should be the local server, using the server endpoint address that a client can access.\n"
        },
        {
          "name": "docker",
          "type": "tree",
          "content": null
        },
        {
          "name": "examples",
          "type": "tree",
          "content": null
        },
        {
          "name": "favicon.ico",
          "type": "blob",
          "size": 16.560546875,
          "content": null
        },
        {
          "name": "index.html",
          "type": "blob",
          "size": 15.099609375,
          "content": "<!DOCTYPE html>\n<html>\n<head>\n<link rel=\"shortcut icon\" href=\"favicon.ico\">\n<meta name=\"viewport\" content=\"width=device-width, initial-scale=1, shrink-to-fit=no, user-scalable=no\" />\n<meta charset=\"UTF-8\" />\n<script type=\"text/javascript\" src=\"speedtest.js\"></script>\n<script type=\"text/javascript\">\nfunction I(i){return document.getElementById(i);}\n\n//LIST OF TEST SERVERS. Leave empty if you're doing a standalone installation. See documentation for details\nvar SPEEDTEST_SERVERS=[\n\t/*{\t//this server doesn't actually exist, remove it\n\t\tname:\"Example Server 1\", //user friendly name for the server\n\t\tserver:\"//test1.mydomain.com/\", //URL to the server. // at the beginning will be replaced with http:// or https:// automatically\n\t\tdlURL:\"backend/garbage.php\",  //path to download test on this server (garbage.php or replacement)\n\t\tulURL:\"backend/empty.php\",  //path to upload test on this server (empty.php or replacement)\n\t\tpingURL:\"backend/empty.php\",  //path to ping/jitter test on this server (empty.php or replacement)\n\t\tgetIpURL:\"backend/getIP.php\"  //path to getIP on this server (getIP.php or replacement)\n\t},\n\t{\t//this server doesn't actually exist, remove it\n\t\tname:\"Example Server 2\", //user friendly name for the server\n\t\tserver:\"//test2.example.com/\", //URL to the server. // at the beginning will be replaced with http:// or https:// automatically\n\t\tdlURL:\"garbage.php\",  //path to download test on this server (garbage.php or replacement)\n\t\tulURL:\"empty.php\",  //path to upload test on this server (empty.php or replacement)\n\t\tpingURL:\"empty.php\",  //path to ping/jitter test on this server (empty.php or replacement)\n\t\tgetIpURL:\"getIP.php\"  //path to getIP on this server (getIP.php or replacement)\n\t}*/\n\t//add other servers here, comma separated\n];\n\n//INITIALIZE SPEEDTEST\nvar s=new Speedtest(); //create speed test object\ns.setParameter(\"telemetry_level\",\"basic\"); //enable basic telemetry (for results sharing)\n\n//SERVER AUTO SELECTION\nfunction initServers(){\n\tif(SPEEDTEST_SERVERS.length==0){ //standalone installation\n\t\t//just make the UI visible\n\t\tI(\"loading\").className=\"hidden\";\n\t\tI(\"serverArea\").style.display=\"none\";\n\t\tI(\"testWrapper\").className=\"visible\";\n\t\tinitUI();\n\t}else{ //multiple servers\n\t\tvar noServersAvailable=function(){\n\t\t\tI(\"message\").innerHTML=\"No servers available\";\n\t\t}\n\t\tvar runServerSelect=function(){\n\t\t\ts.selectServer(function(server){\n\t\t\t\tif(server!=null){ //at least 1 server is available\n\t\t\t\t\tI(\"loading\").className=\"hidden\"; //hide loading message\n\t\t\t\t\t//populate server list for manual selection\n\t\t\t\t\tfor(var i=0;i<SPEEDTEST_SERVERS.length;i++){\n\t\t\t\t\t\tif(SPEEDTEST_SERVERS[i].pingT==-1) continue;\n\t\t\t\t\t\tvar option=document.createElement(\"option\");\n\t\t\t\t\t\toption.value=i;\n\t\t\t\t\t\toption.textContent=SPEEDTEST_SERVERS[i].name;\n\t\t\t\t\t\tif(SPEEDTEST_SERVERS[i]===server) option.selected=true;\n\t\t\t\t\t\tI(\"server\").appendChild(option);\n\t\t\t\t\t}\n\t\t\t\t\t//show test UI\n\t\t\t\t\tI(\"testWrapper\").className=\"visible\";\n\t\t\t\t\tinitUI();\n\t\t\t\t}else{ //no servers are available, the test cannot proceed\n\t\t\t\t\tnoServersAvailable();\n\t\t\t\t}\n\t\t\t});\n\t\t}\n\t\tif(typeof SPEEDTEST_SERVERS === \"string\"){\n\t\t\t//need to fetch list of servers from specified URL\n\t\t\ts.loadServerList(SPEEDTEST_SERVERS,function(servers){\n\t\t\t\tif(servers==null){ //failed to load server list\n\t\t\t\t\tnoServersAvailable();\n\t\t\t\t}else{ //server list loaded\n\t\t\t\t\tSPEEDTEST_SERVERS=servers;\n\t\t\t\t\trunServerSelect();\n\t\t\t\t}\n\t\t\t});\n\t\t}else{\n\t\t\t//hardcoded server list\n\t\t\ts.addTestPoints(SPEEDTEST_SERVERS);\n\t\t\trunServerSelect();\n\t\t}\n\t}\n}\n\nvar meterBk=/Trident.*rv:(\\d+\\.\\d+)/i.test(navigator.userAgent)?\"#EAEAEA\":\"#80808040\";\nvar dlColor=\"#6060AA\",\n\tulColor=\"#616161\";\nvar progColor=meterBk;\n\n//CODE FOR GAUGES\nfunction drawMeter(c,amount,bk,fg,progress,prog){\n\tvar ctx=c.getContext(\"2d\");\n\tvar dp=window.devicePixelRatio||1;\n\tvar cw=c.clientWidth*dp, ch=c.clientHeight*dp;\n\tvar sizScale=ch*0.0055;\n\tif(c.width==cw&&c.height==ch){\n\t\tctx.clearRect(0,0,cw,ch);\n\t}else{\n\t\tc.width=cw;\n\t\tc.height=ch;\n\t}\n\tctx.beginPath();\n\tctx.strokeStyle=bk;\n\tctx.lineWidth=12*sizScale;\n\tctx.arc(c.width/2,c.height-58*sizScale,c.height/1.8-ctx.lineWidth,-Math.PI*1.1,Math.PI*0.1);\n\tctx.stroke();\n\tctx.beginPath();\n\tctx.strokeStyle=fg;\n\tctx.lineWidth=12*sizScale;\n\tctx.arc(c.width/2,c.height-58*sizScale,c.height/1.8-ctx.lineWidth,-Math.PI*1.1,amount*Math.PI*1.2-Math.PI*1.1);\n\tctx.stroke();\n\tif(typeof progress !== \"undefined\"){\n\t\tctx.fillStyle=prog;\n\t\tctx.fillRect(c.width*0.3,c.height-16*sizScale,c.width*0.4*progress,4*sizScale);\n\t}\n}\nfunction mbpsToAmount(s){\n\treturn 1-(1/(Math.pow(1.3,Math.sqrt(s))));\n}\nfunction format(d){\n    d=Number(d);\n    if(d<10) return d.toFixed(2);\n    if(d<100) return d.toFixed(1);\n    return d.toFixed(0);\n}\n\n//UI CODE\nvar uiData=null;\nfunction startStop(){\n    if(s.getState()==3){\n\t\t//speed test is running, abort\n\t\ts.abort();\n\t\tdata=null;\n\t\tI(\"startStopBtn\").className=\"\";\n\t\tI(\"server\").disabled=false;\n\t\tinitUI();\n\t}else{\n\t\t//test is not running, begin\n\t\tI(\"startStopBtn\").className=\"running\";\n\t\tI(\"shareArea\").style.display=\"none\";\n\t\tI(\"server\").disabled=true;\n\t\ts.onupdate=function(data){\n            uiData=data;\n\t\t};\n\t\ts.onend=function(aborted){\n            I(\"startStopBtn\").className=\"\";\n            I(\"server\").disabled=false;\n            updateUI(true);\n            if(!aborted){\n                //if testId is present, show sharing panel, otherwise do nothing\n                try{\n                    var testId=uiData.testId;\n                    if(testId!=null){\n                        var shareURL=window.location.href.substring(0,window.location.href.lastIndexOf(\"/\"))+\"/results/?id=\"+testId;\n                        I(\"resultsImg\").src=shareURL;\n                        I(\"resultsURL\").value=shareURL;\n                        I(\"testId\").innerHTML=testId;\n                        I(\"shareArea\").style.display=\"\";\n                    }\n                }catch(e){}\n            }\n\t\t};\n\t\ts.start();\n\t}\n}\n//this function reads the data sent back by the test and updates the UI\nfunction updateUI(forced){\n\tif(!forced&&s.getState()!=3) return;\n\tif(uiData==null) return;\n\tvar status=uiData.testState;\n\tI(\"ip\").textContent=uiData.clientIp;\n\tI(\"dlText\").textContent=(status==1&&uiData.dlStatus==0)?\"...\":format(uiData.dlStatus);\n\tdrawMeter(I(\"dlMeter\"),mbpsToAmount(Number(uiData.dlStatus*(status==1?oscillate():1))),meterBk,dlColor,Number(uiData.dlProgress),progColor);\n\tI(\"ulText\").textContent=(status==3&&uiData.ulStatus==0)?\"...\":format(uiData.ulStatus);\n\tdrawMeter(I(\"ulMeter\"),mbpsToAmount(Number(uiData.ulStatus*(status==3?oscillate():1))),meterBk,ulColor,Number(uiData.ulProgress),progColor);\n\tI(\"pingText\").textContent=format(uiData.pingStatus);\n\tI(\"jitText\").textContent=format(uiData.jitterStatus);\n}\nfunction oscillate(){\n\treturn 1+0.02*Math.sin(Date.now()/100);\n}\n//update the UI every frame\nwindow.requestAnimationFrame=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.msRequestAnimationFrame||(function(callback,element){setTimeout(callback,1000/60);});\nfunction frame(){\n\trequestAnimationFrame(frame);\n\tupdateUI();\n}\nframe(); //start frame loop\n//function to (re)initialize UI\nfunction initUI(){\n\tdrawMeter(I(\"dlMeter\"),0,meterBk,dlColor,0);\n\tdrawMeter(I(\"ulMeter\"),0,meterBk,ulColor,0);\n\tI(\"dlText\").textContent=\"\";\n\tI(\"ulText\").textContent=\"\";\n\tI(\"pingText\").textContent=\"\";\n\tI(\"jitText\").textContent=\"\";\n\tI(\"ip\").textContent=\"\";\n}\n</script>\n<style type=\"text/css\">\n\thtml,body{\n\t\tborder:none; padding:0; margin:0;\n\t\tbackground:#FFFFFF;\n\t\tcolor:#202020;\n\t}\n\tbody{\n\t\ttext-align:center;\n\t\tfont-family:\"Roboto\",sans-serif;\n\t}\n\th1{\n\t\tcolor:#404040;\n\t}\n\t#loading{\n\t\tbackground-color:#FFFFFF;\n\t\tcolor:#404040;\n\t\ttext-align:center;\n\t}\n\tspan.loadCircle{\n\t\tdisplay:inline-block;\n\t\twidth:2em;\n\t\theight:2em;\n\t\tvertical-align:middle;\n\t\tbackground:url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAIAAAACACAMAAAD04JH5AAAAP1BMVEUAAAB2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZyFzwnAAAAFHRSTlMAEvRFvX406baecwbf0casimhSHyiwmqgAAADpSURBVHja7dbJbQMxAENRahnN5lkc//5rDRAkDeRgHszXgACJoKiIiIiIiIiIiIiIiIiIiIj4HHspsrpAVhdVVguzrA4OWc10WcEqpwKbnBo0OU1Q5NSpsoJFTgOecrrdEag85DRgktNqfoEdTjnd7hrEHMEJvmRUYJbTYk5Agy6nau6Abp5Cm7mDBtRdPi9gyKdU7w4p1fsLvyqs8hl4z9/w3n/Hmr9WoQ65lAU4d7lMYOz//QboRR5jBZibLMZdAR6O/Vfa1PlxNr3XdS3HzK/HVPRu/KnLs8iAOh993VpRRERERMT/fAN60wwWaVyWwAAAAABJRU5ErkJggg==');\n\t\tbackground-size:2em 2em;\n\t\tmargin-right:0.5em;\n\t\tanimation: spin 0.6s linear infinite;\n\t}\n\t@keyframes spin{\n\t\t0%{transform:rotate(0deg);}\n\t\t100%{transform:rotate(359deg);}\n\t}\n\t#startStopBtn{\n\t\tdisplay:inline-block;\n\t\tmargin:0 auto;\n\t\tcolor:#6060AA;\n\t\tbackground-color:rgba(0,0,0,0);\n\t\tborder:0.15em solid #6060FF;\n\t\tborder-radius:0.3em;\n\t\ttransition:all 0.3s;\n\t\tbox-sizing:border-box;\n\t\twidth:8em; height:3em;\n\t\tline-height:2.7em;\n\t\tcursor:pointer;\n\t\tbox-shadow: 0 0 0 rgba(0,0,0,0.1), inset 0 0 0 rgba(0,0,0,0.1);\n\t}\n\t#startStopBtn:hover{\n\t\tbox-shadow: 0 0 2em rgba(0,0,0,0.1), inset 0 0 1em rgba(0,0,0,0.1);\n\t}\n\t#startStopBtn.running{\n\t\tbackground-color:#FF3030;\n\t\tborder-color:#FF6060;\n\t\tcolor:#FFFFFF;\n\t}\n\t#startStopBtn:before{\n\t\tcontent:\"Start\";\n\t}\n\t#startStopBtn.running:before{\n\t\tcontent:\"Abort\";\n\t}\n\t#serverArea{\n\t\tmargin-top:1em;\n\t}\n\t#server{\n\t\tfont-size:1em;\n\t\tpadding:0.2em;\n\t}\n\t#test{\n\t\tmargin-top:2em;\n\t\tmargin-bottom:12em;\n\t}\n\tdiv.testArea{\n\t\tdisplay:inline-block;\n\t\twidth:16em;\n\t\theight:12.5em;\n\t\tposition:relative;\n\t\tbox-sizing:border-box;\n\t}\n\tdiv.testArea2{\n\t\tdisplay:inline-block;\n\t\twidth:14em;\n\t\theight:7em;\n\t\tposition:relative;\n\t\tbox-sizing:border-box;\n\t\ttext-align:center;\n\t}\n\tdiv.testArea div.testName{\n\t\tposition:absolute;\n\t\ttop:0.1em; left:0;\n\t\twidth:100%;\n\t\tfont-size:1.4em;\n\t\tz-index:9;\n\t}\n\tdiv.testArea2 div.testName{\n        display:block;\n        text-align:center;\n        font-size:1.4em;\n\t}\n\tdiv.testArea div.meterText{\n\t\tposition:absolute;\n\t\tbottom:1.55em; left:0;\n\t\twidth:100%;\n\t\tfont-size:2.5em;\n\t\tz-index:9;\n\t}\n\tdiv.testArea2 div.meterText{\n        display:inline-block;\n        font-size:2.5em;\n\t}\n\tdiv.meterText:empty:before{\n\t\tcontent:\"0.00\";\n\t}\n\tdiv.testArea div.unit{\n\t\tposition:absolute;\n\t\tbottom:2em; left:0;\n\t\twidth:100%;\n\t\tz-index:9;\n\t}\n\tdiv.testArea2 div.unit{\n\t\tdisplay:inline-block;\n\t}\n\tdiv.testArea canvas{\n\t\tposition:absolute;\n\t\ttop:0; left:0; width:100%; height:100%;\n\t\tz-index:1;\n\t}\n\tdiv.testGroup{\n\t\tdisplay:block;\n        margin: 0 auto;\n\t}\n\t#shareArea{\n\t\twidth:95%;\n\t\tmax-width:40em;\n\t\tmargin:0 auto;\n\t\tmargin-top:2em;\n\t}\n\t#shareArea > *{\n\t\tdisplay:block;\n\t\twidth:100%;\n\t\theight:auto;\n\t\tmargin: 0.25em 0;\n\t}\n\t#privacyPolicy{\n        position:fixed;\n        top:2em;\n        bottom:2em;\n        left:2em;\n        right:2em;\n        overflow-y:auto;\n        width:auto;\n        height:auto;\n        box-shadow:0 0 3em 1em #000000;\n        z-index:999999;\n        text-align:left;\n        background-color:#FFFFFF;\n        padding:1em;\n\t}\n\ta.privacy{\n        text-align:center;\n        font-size:0.8em;\n        color:#808080;\n        padding: 0 3em;\n\t}\n    div.closePrivacyPolicy {\n        width: 100%;\n        text-align: center;\n    }\n    div.closePrivacyPolicy a.privacy {\n        padding: 1em 3em;\n    }\n\t@media all and (max-width:40em){\n\t\tbody{\n\t\t\tfont-size:0.8em;\n\t\t}\n\t}\n\tdiv.visible{\n\t\tanimation: fadeIn 0.4s;\n\t\tdisplay:block;\n\t}\n\tdiv.hidden{\n\t\tanimation: fadeOut 0.4s;\n\t\tdisplay:none;\n\t}\n\t@keyframes fadeIn{\n\t\t0%{\n\t\t\topacity:0;\n\t\t}\n\t\t100%{\n\t\t\topacity:1;\n\t\t}\n\t}\n\t@keyframes fadeOut{\n\t\t0%{\n\t\t\tdisplay:block;\n\t\t\topacity:1;\n\t\t}\n\t\t100%{\n\t\t\tdisplay:block;\n\t\t\topacity:0;\n\t\t}\n\t}\n\t@media all and (prefers-color-scheme: dark){\n\t\thtml,body,#loading{\n\t\t\tbackground:#202020;\n\t\t\tcolor:#F4F4F4;\n\t\t\tcolor-scheme:dark;\n\t\t}\n\t\th1{\n\t\t\tcolor:#E0E0E0;\n\t\t}\n\t\ta{\n\t\t\tcolor:#9090FF;\n\t\t}\n\t\t#privacyPolicy{\n\t\t\tbackground:#000000;\n\t\t}\n\t\t#resultsImg{\n\t\t\tfilter: invert(1);\n\t\t}\n\t}\n</style>\n<title>LibreSpeed</title>\n</head>\n<body onload=\"initServers()\">\n<h1>LibreSpeed</h1>\n<div id=\"loading\" class=\"visible\">\n\t<p id=\"message\"><span class=\"loadCircle\"></span>Selecting a server...</p>\n</div>\n<div id=\"testWrapper\" class=\"hidden\">\n\t<div id=\"startStopBtn\" onclick=\"startStop()\"></div><br/>\n\t<a class=\"privacy\" href=\"#\" onclick=\"I('privacyPolicy').style.display=''\">Privacy</a>\n\t<div id=\"serverArea\">\n\t\tServer: <select id=\"server\" onchange=\"s.setSelectedServer(SPEEDTEST_SERVERS[this.value])\"></select>\n\t</div>\n\t<div id=\"test\">\n\t\t<div class=\"testGroup\">\n            <div class=\"testArea2\">\n\t\t\t\t<div class=\"testName\">Ping</div>\n\t\t\t\t<div id=\"pingText\" class=\"meterText\" style=\"color:#AA6060\"></div>\n\t\t\t\t<div class=\"unit\">ms</div>\n\t\t\t</div>\n\t\t\t<div class=\"testArea2\">\n\t\t\t\t<div class=\"testName\">Jitter</div>\n\t\t\t\t<div id=\"jitText\" class=\"meterText\" style=\"color:#AA6060\"></div>\n\t\t\t\t<div class=\"unit\">ms</div>\n\t\t\t</div>\n\t\t</div>\n\t\t<div class=\"testGroup\">\n\t\t\t<div class=\"testArea\">\n\t\t\t\t<div class=\"testName\">Download</div>\n\t\t\t\t<canvas id=\"dlMeter\" class=\"meter\"></canvas>\n\t\t\t\t<div id=\"dlText\" class=\"meterText\"></div>\n\t\t\t\t<div class=\"unit\">Mbit/s</div>\n\t\t\t</div>\n\t\t\t<div class=\"testArea\">\n\t\t\t\t<div class=\"testName\">Upload</div>\n\t\t\t\t<canvas id=\"ulMeter\" class=\"meter\"></canvas>\n\t\t\t\t<div id=\"ulText\" class=\"meterText\"></div>\n\t\t\t\t<div class=\"unit\">Mbit/s</div>\n\t\t\t</div>\n\t\t</div>\n\t\t<div id=\"ipArea\">\n\t\t\t<span id=\"ip\"></span>\n\t\t</div>\n\t\t<div id=\"shareArea\" style=\"display:none\">\n\t\t\t<h3>Share results</h3>\n\t\t\t<p>Test ID: <span id=\"testId\"></span></p>\n\t\t\t<input type=\"text\" value=\"\" id=\"resultsURL\" readonly=\"readonly\" onclick=\"this.select();this.focus();this.select();document.execCommand('copy');alert('Link copied')\"/>\n\t\t\t<img src=\"\" id=\"resultsImg\" />\n\t\t</div>\n\t</div>\n\t<a href=\"https://github.com/librespeed/speedtest\">Source code</a>\n</div>\n<div id=\"privacyPolicy\" style=\"display:none\">\n    <h2>Privacy Policy</h2>\n    <p>This HTML5 speed test server is configured with telemetry enabled.</p>\n    <h4>What data we collect</h4>\n    <p>\n        At the end of the test, the following data is collected and stored:\n        <ul>\n            <li>Test ID</li>\n            <li>Time of testing</li>\n            <li>Test results (download and upload speed, ping and jitter)</li>\n            <li>IP address</li>\n            <li>ISP information</li>\n            <li>Approximate location (inferred from IP address, not GPS)</li>\n            <li>User agent and browser locale</li>\n            <li>Test log (contains no personal information)</li>\n        </ul>\n    </p>\n    <h4>How we use the data</h4>\n    <p>\n        Data collected through this service is used to:\n        <ul>\n            <li>Allow sharing of test results (sharable image for forums, etc.)</li>\n            <li>To improve the service offered to you (for instance, to detect problems on our side)</li>\n        </ul>\n        No personal information is disclosed to third parties.\n    </p>\n    <h4>Your consent</h4>\n    <p>\n        By starting the test, you consent to the terms of this privacy policy.\n    </p>\n    <h4>Data removal</h4>\n    <p>\n        If you want to have your information deleted, you need to provide either the ID of the test or your IP address. This is the only way to identify your data, without this information we won't be able to comply with your request.<br/><br/>\n        Contact this email address for all deletion requests: <a href=\"mailto:PUT@YOUR_EMAIL.HERE\">TO BE FILLED BY DEVELOPER</a>.\n    </p>\n    <br/><br/>\n    <div class=\"closePrivacyPolicy\">\n        <a class=\"privacy\" href=\"#\" onclick=\"I('privacyPolicy').style.display='none'\">Close</a>\n    </div>\n    <br/>\n</div>\n</body>\n</html>\n"
        },
        {
          "name": "results",
          "type": "tree",
          "content": null
        },
        {
          "name": "speedtest.js",
          "type": "blob",
          "size": 16.5927734375,
          "content": "/*\n\tLibreSpeed - Main\n\tby Federico Dossena\n\thttps://github.com/librespeed/speedtest/\n\tGNU LGPLv3 License\n*/\n\n/*\n   This is the main interface between your webpage and the speed test.\n   It hides the speed test web worker to the page, and provides many convenient functions to control the test.\n\n   The best way to learn how to use this is to look at the basic example, but here's some documentation.\n\n   To initialize the test, create a new Speedtest object:\n    let s=new Speedtest();\n   Now you can think of this as a finite state machine. These are the states (use getState() to see them):\n   - 0: here you can change the speed test settings (such as test duration) with the setParameter(\"parameter\",value) method. From here you can either start the test using start() (goes to state 3) or you can add multiple test points using addTestPoint(server) or addTestPoints(serverList) (goes to state 1). Additionally, this is the perfect moment to set up callbacks for the onupdate(data) and onend(aborted) events.\n   - 1: here you can add test points. You only need to do this if you want to use multiple test points.\n        A server is defined as an object like this:\n        {\n            name: \"User friendly name\",\n            server:\"http://yourBackend.com/\",     <---- URL to your server. You can specify http:// or https://. If your server supports both, just write // without the protocol\n            dlURL:\"garbage.php\"    <----- path to garbage.php or its replacement on the server\n            ulURL:\"empty.php\"    <----- path to empty.php or its replacement on the server\n            pingURL:\"empty.php\"    <----- path to empty.php or its replacement on the server. This is used to ping the server by this selector\n            getIpURL:\"getIP.php\"    <----- path to getIP.php or its replacement on the server\n        }\n        While in state 1, you can only add test points, you cannot change the test settings. When you're done, use selectServer(callback) to select the test point with the lowest ping. This is asynchronous, when it's done, it will call your callback function and move to state 2. Calling setSelectedServer(server) will manually select a server and move to state 2.\n    - 2: test point selected, ready to start the test. Use start() to begin, this will move to state 3\n    - 3: test running. Here, your onupdate event callback will be called periodically, with data coming from the worker about speed and progress. A data object will be passed to your onupdate function, with the following items:\n            - dlStatus: download speed in Mbit/s\n            - ulStatus: upload speed in Mbit/s\n            - pingStatus: ping in ms\n            - jitterStatus: jitter in ms\n            - dlProgress: progress of the download test as a float 0-1\n            - ulProgress: progress of the upload test as a float 0-1\n            - pingProgress: progress of the ping/jitter test as a float 0-1\n            - testState: state of the test (-1=not started, 0=starting, 1=download test, 2=ping+jitter test, 3=upload test, 4=finished, 5=aborted)\n            - clientIp: IP address of the client performing the test (and optionally ISP and distance)\n        At the end of the test, the onend function will be called, with a boolean specifying whether the test was aborted or if it ended normally.\n        The test can be aborted at any time with abort().\n        At the end of the test, it will move to state 4\n    - 4: test finished. You can run it again by calling start() if you want.\n */\n\nfunction Speedtest() {\n  this._serverList = []; //when using multiple points of test, this is a list of test points\n  this._selectedServer = null; //when using multiple points of test, this is the selected server\n  this._settings = {}; //settings for the speed test worker\n  this._state = 0; //0=adding settings, 1=adding servers, 2=server selection done, 3=test running, 4=done\n  console.log(\n    \"LibreSpeed by Federico Dossena v5.4.1 - https://github.com/librespeed/speedtest\"\n  );\n}\n\nSpeedtest.prototype = {\n  constructor: Speedtest,\n  /**\n   * Returns the state of the test: 0=adding settings, 1=adding servers, 2=server selection done, 3=test running, 4=done\n   */\n  getState: function() {\n    return this._state;\n  },\n  /**\n   * Change one of the test settings from their defaults.\n   * - parameter: string with the name of the parameter that you want to set\n   * - value: new value for the parameter\n   *\n   * Invalid values or nonexistant parameters will be ignored by the speed test worker.\n   */\n  setParameter: function(parameter, value) {\n    if (this._state == 3)\n      throw \"You cannot change the test settings while running the test\";\n    this._settings[parameter] = value;\n    if(parameter === \"telemetry_extra\"){\n        this._originalExtra=this._settings.telemetry_extra;\n    }\n  },\n  /**\n   * Used internally to check if a server object contains all the required elements.\n   * Also fixes the server URL if needed.\n   */\n  _checkServerDefinition: function(server) {\n    try {\n      if (typeof server.name !== \"string\")\n        throw \"Name string missing from server definition (name)\";\n      if (typeof server.server !== \"string\")\n        throw \"Server address string missing from server definition (server)\";\n      if (server.server.charAt(server.server.length - 1) != \"/\")\n        server.server += \"/\";\n      if (server.server.indexOf(\"//\") == 0)\n        server.server = location.protocol + server.server;\n      if (typeof server.dlURL !== \"string\")\n        throw \"Download URL string missing from server definition (dlURL)\";\n      if (typeof server.ulURL !== \"string\")\n        throw \"Upload URL string missing from server definition (ulURL)\";\n      if (typeof server.pingURL !== \"string\")\n        throw \"Ping URL string missing from server definition (pingURL)\";\n      if (typeof server.getIpURL !== \"string\")\n        throw \"GetIP URL string missing from server definition (getIpURL)\";\n    } catch (e) {\n      throw \"Invalid server definition\";\n    }\n  },\n  /**\n   * Add a test point (multiple points of test)\n   * server: the server to be added as an object. Must contain the following elements:\n   *  {\n   *       name: \"User friendly name\",\n   *       server:\"http://yourBackend.com/\",   URL to your server. You can specify http:// or https://. If your server supports both, just write // without the protocol\n   *       dlURL:\"garbage.php\"   path to garbage.php or its replacement on the server\n   *       ulURL:\"empty.php\"   path to empty.php or its replacement on the server\n   *       pingURL:\"empty.php\"   path to empty.php or its replacement on the server. This is used to ping the server by this selector\n   *       getIpURL:\"getIP.php\"   path to getIP.php or its replacement on the server\n   *   }\n   */\n  addTestPoint: function(server) {\n    this._checkServerDefinition(server);\n    if (this._state == 0) this._state = 1;\n    if (this._state != 1) throw \"You can't add a server after server selection\";\n    this._settings.mpot = true;\n    this._serverList.push(server);\n  },\n  /**\n   * Same as addTestPoint, but you can pass an array of servers\n   */\n  addTestPoints: function(list) {\n    for (let i = 0; i < list.length; i++) this.addTestPoint(list[i]);\n  },\n  /**\n   * Load a JSON server list from URL (multiple points of test)\n   * url: the url where the server list can be fetched. Must be an array with objects containing the following elements:\n   *  {\n   *       \"name\": \"User friendly name\",\n   *       \"server\":\"http://yourBackend.com/\",   URL to your server. You can specify http:// or https://. If your server supports both, just write // without the protocol\n   *       \"dlURL\":\"garbage.php\"   path to garbage.php or its replacement on the server\n   *       \"ulURL\":\"empty.php\"   path to empty.php or its replacement on the server\n   *       \"pingURL\":\"empty.php\"   path to empty.php or its replacement on the server. This is used to ping the server by this selector\n   *       \"getIpURL\":\"getIP.php\"   path to getIP.php or its replacement on the server\n   *   }\n   * result: callback to be called when the list is loaded correctly. An array with the loaded servers will be passed to this function, or null if it failed\n   */\n  loadServerList: function(url,result) {\n    if (this._state == 0) this._state = 1;\n    if (this._state != 1) throw \"You can't add a server after server selection\";\n    this._settings.mpot = true;\n    let xhr = new XMLHttpRequest();\n    xhr.onload = function(){\n      try{\n        const servers=JSON.parse(xhr.responseText);\n        for(let i=0;i<servers.length;i++){\n          this._checkServerDefinition(servers[i]);\n        }\n        this.addTestPoints(servers);\n        result(servers);\n      }catch(e){\n        result(null);\n      }\n    }.bind(this);\n    xhr.onerror = function(){result(null);}\n    xhr.open(\"GET\",url);\n    xhr.send();\n  },\n  /**\n   * Returns the selected server (multiple points of test)\n   */\n  getSelectedServer: function() {\n    if (this._state < 2 || this._selectedServer == null)\n      throw \"No server is selected\";\n    return this._selectedServer;\n  },\n  /**\n   * Manually selects one of the test points (multiple points of test)\n   */\n  setSelectedServer: function(server) {\n    this._checkServerDefinition(server);\n    if (this._state == 3)\n      throw \"You can't select a server while the test is running\";\n    this._selectedServer = server;\n    this._state = 2;\n  },\n  /**\n   * Automatically selects a server from the list of added test points. The server with the lowest ping will be chosen. (multiple points of test)\n   * The process is asynchronous and the passed result callback function will be called when it's done, then the test can be started.\n   */\n  selectServer: function(result) {\n    if (this._state != 1) {\n      if (this._state == 0) throw \"No test points added\";\n      if (this._state == 2) throw \"Server already selected\";\n      if (this._state >= 3)\n        throw \"You can't select a server while the test is running\";\n    }\n    if (this._selectServerCalled) throw \"selectServer already called\"; else this._selectServerCalled=true;\n    /*this function goes through a list of servers. For each server, the ping is measured, then the server with the function selected is called with the best server, or null if all the servers were down.\n     */\n    const select = function(serverList, selected) {\n      //pings the specified URL, then calls the function result. Result will receive a parameter which is either the time it took to ping the URL, or -1 if something went wrong.\n      const PING_TIMEOUT = 2000;\n      let USE_PING_TIMEOUT = true; //will be disabled on unsupported browsers\n      if (/MSIE.(\\d+\\.\\d+)/i.test(navigator.userAgent)) {\n        //IE11 doesn't support XHR timeout\n        USE_PING_TIMEOUT = false;\n      }\n      const ping = function(url, rtt) {\n        url += (url.match(/\\?/) ? \"&\" : \"?\") + \"cors=true\";\n        let xhr = new XMLHttpRequest();\n        let t = new Date().getTime();\n        xhr.onload = function() {\n          if (xhr.responseText.length == 0) {\n            //we expect an empty response\n            let instspd = new Date().getTime() - t; //rough timing estimate\n            try {\n              //try to get more accurate timing using performance API\n              let p = performance.getEntriesByName(url);\n              p = p[p.length - 1];\n              let d = p.responseStart - p.requestStart;\n              if (d <= 0) d = p.duration;\n              if (d > 0 && d < instspd) instspd = d;\n            } catch (e) {}\n            rtt(instspd);\n          } else rtt(-1);\n        }.bind(this);\n        xhr.onerror = function() {\n          rtt(-1);\n        }.bind(this);\n        xhr.open(\"GET\", url);\n        if (USE_PING_TIMEOUT) {\n          try {\n            xhr.timeout = PING_TIMEOUT;\n            xhr.ontimeout = xhr.onerror;\n          } catch (e) {}\n        }\n        xhr.send();\n      }.bind(this);\n\n      //this function repeatedly pings a server to get a good estimate of the ping. When it's done, it calls the done function without parameters. At the end of the execution, the server will have a new parameter called pingT, which is either the best ping we got from the server or -1 if something went wrong.\n      const PINGS = 3, //up to 3 pings are performed, unless the server is down...\n        SLOW_THRESHOLD = 500; //...or one of the pings is above this threshold\n      const checkServer = function(server, done) {\n        let i = 0;\n        server.pingT = -1;\n        if (server.server.indexOf(location.protocol) == -1) done();\n        else {\n          const nextPing = function() {\n            if (i++ == PINGS) {\n              done();\n              return;\n            }\n            ping(\n              server.server + server.pingURL,\n              function(t) {\n                if (t >= 0) {\n                  if (t < server.pingT || server.pingT == -1) server.pingT = t;\n                  if (t < SLOW_THRESHOLD) nextPing();\n                  else done();\n                } else done();\n              }.bind(this)\n            );\n          }.bind(this);\n          nextPing();\n        }\n      }.bind(this);\n      //check servers in list, one by one\n      let i = 0;\n      const done = function() {\n        let bestServer = null;\n        for (let i = 0; i < serverList.length; i++) {\n          if (\n            serverList[i].pingT != -1 &&\n            (bestServer == null || serverList[i].pingT < bestServer.pingT)\n          )\n            bestServer = serverList[i];\n        }\n        selected(bestServer);\n      }.bind(this);\n      const nextServer = function() {\n        if (i == serverList.length) {\n          done();\n          return;\n        }\n        checkServer(serverList[i++], nextServer);\n      }.bind(this);\n      nextServer();\n    }.bind(this);\n\n    //parallel server selection\n    const CONCURRENCY = 6;\n    let serverLists = [];\n    for (let i = 0; i < CONCURRENCY; i++) {\n      serverLists[i] = [];\n    }\n    for (let i = 0; i < this._serverList.length; i++) {\n      serverLists[i % CONCURRENCY].push(this._serverList[i]);\n    }\n    let completed = 0;\n    let bestServer = null;\n    for (let i = 0; i < CONCURRENCY; i++) {\n      select(\n        serverLists[i],\n        function(server) {\n          if (server != null) {\n            if (bestServer == null || server.pingT < bestServer.pingT)\n              bestServer = server;\n          }\n          completed++;\n          if (completed == CONCURRENCY) {\n            this._selectedServer = bestServer;\n            this._state = 2;\n            if (result) result(bestServer);\n          }\n        }.bind(this)\n      );\n    }\n  },\n  /**\n   * Starts the test.\n   * During the test, the onupdate(data) callback function will be called periodically with data from the worker.\n   * At the end of the test, the onend(aborted) function will be called with a boolean telling you if the test was aborted or if it ended normally.\n   */\n  start: function() {\n    if (this._state == 3) throw \"Test already running\";\n    this.worker = new Worker(\"speedtest_worker.js?r=\" + Math.random());\n    this.worker.onmessage = function(e) {\n      if (e.data === this._prevData) return;\n      else this._prevData = e.data;\n      const data = JSON.parse(e.data);\n      try {\n        if (this.onupdate) this.onupdate(data);\n      } catch (e) {\n        console.error(\"Speedtest onupdate event threw exception: \" + e);\n      }\n      if (data.testState >= 4) {\n\t  clearInterval(this.updater);\n        this._state = 4;\n        try {\n          if (this.onend) this.onend(data.testState == 5);\n        } catch (e) {\n          console.error(\"Speedtest onend event threw exception: \" + e);\n        }\n      }\n    }.bind(this);\n    this.updater = setInterval(\n      function() {\n        this.worker.postMessage(\"status\");\n      }.bind(this),\n      200\n    );\n    if (this._state == 1)\n        throw \"When using multiple points of test, you must call selectServer before starting the test\";\n    if (this._state == 2) {\n      this._settings.url_dl =\n        this._selectedServer.server + this._selectedServer.dlURL;\n      this._settings.url_ul =\n        this._selectedServer.server + this._selectedServer.ulURL;\n      this._settings.url_ping =\n        this._selectedServer.server + this._selectedServer.pingURL;\n      this._settings.url_getIp =\n        this._selectedServer.server + this._selectedServer.getIpURL;\n      if (typeof this._originalExtra !== \"undefined\") {\n        this._settings.telemetry_extra = JSON.stringify({\n          server: this._selectedServer.name,\n          extra: this._originalExtra\n        });\n      } else\n        this._settings.telemetry_extra = JSON.stringify({\n          server: this._selectedServer.name\n        });\n    }\n    this._state = 3;\n    this.worker.postMessage(\"start \" + JSON.stringify(this._settings));\n  },\n  /**\n   * Aborts the test while it's running.\n   */\n  abort: function() {\n    if (this._state < 3) throw \"You cannot abort a test that's not started yet\";\n    if (this._state < 4) this.worker.postMessage(\"abort\");\n  }\n};\n"
        },
        {
          "name": "speedtest_worker.js",
          "type": "blob",
          "size": 27.50390625,
          "content": "/*\n\tLibreSpeed - Worker\n\tby Federico Dossena\n\thttps://github.com/librespeed/speedtest/\n\tGNU LGPLv3 License\n*/\n\n// data reported to main thread\nlet testState = -1; // -1=not started, 0=starting, 1=download test, 2=ping+jitter test, 3=upload test, 4=finished, 5=abort\nlet dlStatus = \"\"; // download speed in megabit/s with 2 decimal digits\nlet ulStatus = \"\"; // upload speed in megabit/s with 2 decimal digits\nlet pingStatus = \"\"; // ping in milliseconds with 2 decimal digits\nlet jitterStatus = \"\"; // jitter in milliseconds with 2 decimal digits\nlet clientIp = \"\"; // client's IP address as reported by getIP.php\nlet dlProgress = 0; //progress of download test 0-1\nlet ulProgress = 0; //progress of upload test 0-1\nlet pingProgress = 0; //progress of ping+jitter test 0-1\nlet testId = null; //test ID (sent back by telemetry if used, null otherwise)\n\nlet log = \"\"; //telemetry log\nfunction tlog(s) {\n\tif (settings.telemetry_level >= 2) {\n\t\tlog += Date.now() + \": \" + s + \"\\n\";\n\t}\n}\nfunction tverb(s) {\n\tif (settings.telemetry_level >= 3) {\n\t\tlog += Date.now() + \": \" + s + \"\\n\";\n\t}\n}\nfunction twarn(s) {\n\tif (settings.telemetry_level >= 2) {\n\t\tlog += Date.now() + \" WARN: \" + s + \"\\n\";\n\t}\n\tconsole.warn(s);\n}\n\n// test settings. can be overridden by sending specific values with the start command\nlet settings = {\n\tmpot: false, //set to true when in MPOT mode\n\ttest_order: \"IP_D_U\", //order in which tests will be performed as a string. D=Download, U=Upload, P=Ping+Jitter, I=IP, _=1 second delay\n\ttime_ul_max: 15, // max duration of upload test in seconds\n\ttime_dl_max: 15, // max duration of download test in seconds\n\ttime_auto: true, // if set to true, tests will take less time on faster connections\n\ttime_ulGraceTime: 3, //time to wait in seconds before actually measuring ul speed (wait for buffers to fill)\n\ttime_dlGraceTime: 1.5, //time to wait in seconds before actually measuring dl speed (wait for TCP window to increase)\n\tcount_ping: 10, // number of pings to perform in ping test\n\turl_dl: \"backend/garbage.php\", // path to a large file or garbage.php, used for download test. must be relative to this js file\n\turl_ul: \"backend/empty.php\", // path to an empty file, used for upload test. must be relative to this js file\n\turl_ping: \"backend/empty.php\", // path to an empty file, used for ping test. must be relative to this js file\n\turl_getIp: \"backend/getIP.php\", // path to getIP.php relative to this js file, or a similar thing that outputs the client's ip\n\tgetIp_ispInfo: true, //if set to true, the server will include ISP info with the IP address\n\tgetIp_ispInfo_distance: \"km\", //km or mi=estimate distance from server in km/mi; set to false to disable distance estimation. getIp_ispInfo must be enabled in order for this to work\n\txhr_dlMultistream: 6, // number of download streams to use (can be different if enable_quirks is active)\n\txhr_ulMultistream: 3, // number of upload streams to use (can be different if enable_quirks is active)\n\txhr_multistreamDelay: 300, //how much concurrent requests should be delayed\n\txhr_ignoreErrors: 1, // 0=fail on errors, 1=attempt to restart a stream if it fails, 2=ignore all errors\n\txhr_dlUseBlob: false, // if set to true, it reduces ram usage but uses the hard drive (useful with large garbagePhp_chunkSize and/or high xhr_dlMultistream)\n\txhr_ul_blob_megabytes: 20, //size in megabytes of the upload blobs sent in the upload test (forced to 4 on chrome mobile)\n\tgarbagePhp_chunkSize: 100, // size of chunks sent by garbage.php (can be different if enable_quirks is active)\n\tenable_quirks: true, // enable quirks for specific browsers. currently it overrides settings to optimize for specific browsers, unless they are already being overridden with the start command\n\tping_allowPerformanceApi: true, // if enabled, the ping test will attempt to calculate the ping more precisely using the Performance API. Currently works perfectly in Chrome, badly in Edge, and not at all in Firefox. If Performance API is not supported or the result is obviously wrong, a fallback is provided.\n\toverheadCompensationFactor: 1.06, //can be changed to compensate for transport overhead. (see doc.md for some other values)\n\tuseMebibits: false, //if set to true, speed will be reported in mebibits/s instead of megabits/s\n\ttelemetry_level: 0, // 0=disabled, 1=basic (results only), 2=full (results and timing) 3=debug (results+log)\n\turl_telemetry: \"results/telemetry.php\", // path to the script that adds telemetry data to the database\n\ttelemetry_extra: \"\", //extra data that can be passed to the telemetry through the settings\n    forceIE11Workaround: false //when set to true, it will force the IE11 upload test on all browsers. Debug only\n};\n\nlet xhr = null; // array of currently active xhr requests\nlet interval = null; // timer used in tests\nlet test_pointer = 0; //pointer to the next test to run inside settings.test_order\n\n/*\n  this function is used on URLs passed in the settings to determine whether we need a ? or an & as a separator\n*/\nfunction url_sep(url) {\n\treturn url.match(/\\?/) ? \"&\" : \"?\";\n}\n\n/*\n\tlistener for commands from main thread to this worker.\n\tcommands:\n\t-status: returns the current status as a JSON string containing testState, dlStatus, ulStatus, pingStatus, clientIp, jitterStatus, dlProgress, ulProgress, pingProgress\n\t-abort: aborts the current test\n\t-start: starts the test. optionally, settings can be passed as JSON.\n\t\texample: start {\"time_ul_max\":\"10\", \"time_dl_max\":\"10\", \"count_ping\":\"50\"}\n*/\nthis.addEventListener(\"message\", function(e) {\n\tconst params = e.data.split(\" \");\n\tif (params[0] === \"status\") {\n\t\t// return status\n\t\tpostMessage(\n\t\t\tJSON.stringify({\n\t\t\t\ttestState: testState,\n\t\t\t\tdlStatus: dlStatus,\n\t\t\t\tulStatus: ulStatus,\n\t\t\t\tpingStatus: pingStatus,\n\t\t\t\tclientIp: clientIp,\n\t\t\t\tjitterStatus: jitterStatus,\n\t\t\t\tdlProgress: dlProgress,\n\t\t\t\tulProgress: ulProgress,\n\t\t\t\tpingProgress: pingProgress,\n\t\t\t\ttestId: testId\n\t\t\t})\n\t\t);\n\t}\n\tif (params[0] === \"start\" && testState === -1) {\n\t\t// start new test\n\t\ttestState = 0;\n\t\ttry {\n\t\t\t// parse settings, if present\n\t\t\tlet s = {};\n\t\t\ttry {\n\t\t\t\tconst ss = e.data.substring(5);\n\t\t\t\tif (ss) s = JSON.parse(ss);\n\t\t\t} catch (e) {\n\t\t\t\ttwarn(\"Error parsing custom settings JSON. Please check your syntax\");\n\t\t\t}\n\t\t\t//copy custom settings\n\t\t\tfor (let key in s) {\n\t\t\t\tif (typeof settings[key] !== \"undefined\") settings[key] = s[key];\n\t\t\t\telse twarn(\"Unknown setting ignored: \" + key);\n\t\t\t}\n\t\t\tconst ua = navigator.userAgent;\n\t\t\t// quirks for specific browsers. apply only if not overridden. more may be added in future releases\n\t\t\tif (settings.enable_quirks || (typeof s.enable_quirks !== \"undefined\" && s.enable_quirks)) {\n\t\t\t\tif (/Firefox.(\\d+\\.\\d+)/i.test(ua)) {\n\t\t\t\t\tif (typeof s.ping_allowPerformanceApi === \"undefined\") {\n\t\t\t\t\t\t// ff performance API sucks\n\t\t\t\t\t\tsettings.ping_allowPerformanceApi = false;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\tif (/Edge.(\\d+\\.\\d+)/i.test(ua)) {\n\t\t\t\t\tif (typeof s.xhr_dlMultistream === \"undefined\") {\n\t\t\t\t\t\t// edge more precise with 3 download streams\n\t\t\t\t\t\tsettings.xhr_dlMultistream = 3;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\tif (/Chrome.(\\d+)/i.test(ua) && !!self.fetch) {\n\t\t\t\t\tif (typeof s.xhr_dlMultistream === \"undefined\") {\n\t\t\t\t\t\t// chrome more precise with 5 streams\n\t\t\t\t\t\tsettings.xhr_dlMultistream = 5;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t\tif (/Edge.(\\d+\\.\\d+)/i.test(ua)) {\n\t\t\t\t//Edge 15 introduced a bug that causes onprogress events to not get fired, we have to use the \"small chunks\" workaround that reduces accuracy\n\t\t\t\tsettings.forceIE11Workaround = true;\n\t\t\t}\n\t\t\tif (/PlayStation 4.(\\d+\\.\\d+)/i.test(ua)) {\n\t\t\t\t//PS4 browser has the same bug as IE11/Edge\n\t\t\t\tsettings.forceIE11Workaround = true;\n\t\t\t}\n\t\t\tif (/Chrome.(\\d+)/i.test(ua) && /Android|iPhone|iPad|iPod|Windows Phone/i.test(ua)) {\n\t\t\t\t//cheap af\n\t\t\t\t//Chrome mobile introduced a limitation somewhere around version 65, we have to limit XHR upload size to 4 megabytes\n\t\t\t\tsettings.xhr_ul_blob_megabytes = 4;\n\t\t\t}\n\t\t\tif (/^((?!chrome|android|crios|fxios).)*safari/i.test(ua)) {\n\t\t\t\t//Safari also needs the IE11 workaround but only for the MPOT version\n\t\t\t\tsettings.forceIE11Workaround = true;\n\t\t\t}\n\t\t\t//telemetry_level has to be parsed and not just copied\n\t\t\tif (typeof s.telemetry_level !== \"undefined\") settings.telemetry_level = s.telemetry_level === \"basic\" ? 1 : s.telemetry_level === \"full\" ? 2 : s.telemetry_level === \"debug\" ? 3 : 0; // telemetry level\n\t\t\t//transform test_order to uppercase, just in case\n\t\t\tsettings.test_order = settings.test_order.toUpperCase();\n\t\t} catch (e) {\n\t\t\ttwarn(\"Possible error in custom test settings. Some settings might not have been applied. Exception: \" + e);\n\t\t}\n\t\t// run the tests\n\t\ttverb(JSON.stringify(settings));\n\t\ttest_pointer = 0;\n\t\tlet iRun = false,\n\t\t\tdRun = false,\n\t\t\tuRun = false,\n\t\t\tpRun = false;\n\t\tconst runNextTest = function() {\n\t\t\tif (testState == 5) return;\n\t\t\tif (test_pointer >= settings.test_order.length) {\n\t\t\t\t//test is finished\n\t\t\t\tif (settings.telemetry_level > 0)\n\t\t\t\t\tsendTelemetry(function(id) {\n\t\t\t\t\t\ttestState = 4;\n\t\t\t\t\t\tif (id != null) testId = id;\n\t\t\t\t\t});\n\t\t\t\telse testState = 4;\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tswitch (settings.test_order.charAt(test_pointer)) {\n\t\t\t\tcase \"I\":\n\t\t\t\t\t{\n\t\t\t\t\t\ttest_pointer++;\n\t\t\t\t\t\tif (iRun) {\n\t\t\t\t\t\t\trunNextTest();\n\t\t\t\t\t\t\treturn;\n\t\t\t\t\t\t} else iRun = true;\n\t\t\t\t\t\tgetIp(runNextTest);\n\t\t\t\t\t}\n\t\t\t\t\tbreak;\n\t\t\t\tcase \"D\":\n\t\t\t\t\t{\n\t\t\t\t\t\ttest_pointer++;\n\t\t\t\t\t\tif (dRun) {\n\t\t\t\t\t\t\trunNextTest();\n\t\t\t\t\t\t\treturn;\n\t\t\t\t\t\t} else dRun = true;\n\t\t\t\t\t\ttestState = 1;\n\t\t\t\t\t\tdlTest(runNextTest);\n\t\t\t\t\t}\n\t\t\t\t\tbreak;\n\t\t\t\tcase \"U\":\n\t\t\t\t\t{\n\t\t\t\t\t\ttest_pointer++;\n\t\t\t\t\t\tif (uRun) {\n\t\t\t\t\t\t\trunNextTest();\n\t\t\t\t\t\t\treturn;\n\t\t\t\t\t\t} else uRun = true;\n\t\t\t\t\t\ttestState = 3;\n\t\t\t\t\t\tulTest(runNextTest);\n\t\t\t\t\t}\n\t\t\t\t\tbreak;\n\t\t\t\tcase \"P\":\n\t\t\t\t\t{\n\t\t\t\t\t\ttest_pointer++;\n\t\t\t\t\t\tif (pRun) {\n\t\t\t\t\t\t\trunNextTest();\n\t\t\t\t\t\t\treturn;\n\t\t\t\t\t\t} else pRun = true;\n\t\t\t\t\t\ttestState = 2;\n\t\t\t\t\t\tpingTest(runNextTest);\n\t\t\t\t\t}\n\t\t\t\t\tbreak;\n\t\t\t\tcase \"_\":\n\t\t\t\t\t{\n\t\t\t\t\t\ttest_pointer++;\n\t\t\t\t\t\tsetTimeout(runNextTest, 1000);\n\t\t\t\t\t}\n\t\t\t\t\tbreak;\n\t\t\t\tdefault:\n\t\t\t\t\ttest_pointer++;\n\t\t\t}\n\t\t};\n\t\trunNextTest();\n\t}\n\tif (params[0] === \"abort\") {\n\t\t// abort command\n        if (testState >= 4) return;\n\t\ttlog(\"manually aborted\");\n\t\tclearRequests(); // stop all xhr activity\n\t\trunNextTest = null;\n\t\tif (interval) clearInterval(interval); // clear timer if present\n\t\tif (settings.telemetry_level > 1) sendTelemetry(function() {});\n\t\ttestState = 5; //set test as aborted\n\t\tdlStatus = \"\";\n\t\tulStatus = \"\";\n\t\tpingStatus = \"\";\n\t\tjitterStatus = \"\";\n        clientIp = \"\";\n\t\tdlProgress = 0;\n\t\tulProgress = 0;\n\t\tpingProgress = 0;\n\t}\n});\n// stops all XHR activity, aggressively\nfunction clearRequests() {\n\ttverb(\"stopping pending XHRs\");\n\tif (xhr) {\n\t\tfor (let i = 0; i < xhr.length; i++) {\n\t\t\ttry {\n\t\t\t\txhr[i].onprogress = null;\n\t\t\t\txhr[i].onload = null;\n\t\t\t\txhr[i].onerror = null;\n\t\t\t} catch (e) {}\n\t\t\ttry {\n\t\t\t\txhr[i].upload.onprogress = null;\n\t\t\t\txhr[i].upload.onload = null;\n\t\t\t\txhr[i].upload.onerror = null;\n\t\t\t} catch (e) {}\n\t\t\ttry {\n\t\t\t\txhr[i].abort();\n\t\t\t} catch (e) {}\n\t\t\ttry {\n\t\t\t\tdelete xhr[i];\n\t\t\t} catch (e) {}\n\t\t}\n\t\txhr = null;\n\t}\n}\n// gets client's IP using url_getIp, then calls the done function\nlet ipCalled = false; // used to prevent multiple accidental calls to getIp\nlet ispInfo = \"\"; //used for telemetry\nfunction getIp(done) {\n\ttverb(\"getIp\");\n\tif (ipCalled) return;\n\telse ipCalled = true; // getIp already called?\n\tlet startT = new Date().getTime();\n\txhr = new XMLHttpRequest();\n\txhr.onload = function() {\n\t\ttlog(\"IP: \" + xhr.responseText + \", took \" + (new Date().getTime() - startT) + \"ms\");\n\t\ttry {\n\t\t\tconst data = JSON.parse(xhr.responseText);\n\t\t\tclientIp = data.processedString;\n\t\t\tispInfo = data.rawIspInfo;\n\t\t} catch (e) {\n\t\t\tclientIp = xhr.responseText;\n\t\t\tispInfo = \"\";\n\t\t}\n\t\tdone();\n\t};\n\txhr.onerror = function() {\n\t\ttlog(\"getIp failed, took \" + (new Date().getTime() - startT) + \"ms\");\n\t\tdone();\n\t};\n\txhr.open(\"GET\", settings.url_getIp + url_sep(settings.url_getIp) + (settings.mpot ? \"cors=true&\" : \"\") + (settings.getIp_ispInfo ? \"isp=true\" + (settings.getIp_ispInfo_distance ? \"&distance=\" + settings.getIp_ispInfo_distance + \"&\" : \"&\") : \"&\") + \"r=\" + Math.random(), true);\n\txhr.send();\n}\n// download test, calls done function when it's over\nlet dlCalled = false; // used to prevent multiple accidental calls to dlTest\nfunction dlTest(done) {\n\ttverb(\"dlTest\");\n\tif (dlCalled) return;\n\telse dlCalled = true; // dlTest already called?\n\tlet totLoaded = 0.0, // total number of loaded bytes\n\t\tstartT = new Date().getTime(), // timestamp when test was started\n\t\tbonusT = 0, //how many milliseconds the test has been shortened by (higher on faster connections)\n\t\tgraceTimeDone = false, //set to true after the grace time is past\n\t\tfailed = false; // set to true if a stream fails\n\txhr = [];\n\t// function to create a download stream. streams are slightly delayed so that they will not end at the same time\n\tconst testStream = function(i, delay) {\n\t\tsetTimeout(\n\t\t\tfunction() {\n\t\t\t\tif (testState !== 1) return; // delayed stream ended up starting after the end of the download test\n\t\t\t\ttverb(\"dl test stream started \" + i + \" \" + delay);\n\t\t\t\tlet prevLoaded = 0; // number of bytes loaded last time onprogress was called\n\t\t\t\tlet x = new XMLHttpRequest();\n\t\t\t\txhr[i] = x;\n\t\t\t\txhr[i].onprogress = function(event) {\n\t\t\t\t\ttverb(\"dl stream progress event \" + i + \" \" + event.loaded);\n\t\t\t\t\tif (testState !== 1) {\n\t\t\t\t\t\ttry {\n\t\t\t\t\t\t\tx.abort();\n\t\t\t\t\t\t} catch (e) {}\n\t\t\t\t\t} // just in case this XHR is still running after the download test\n\t\t\t\t\t// progress event, add number of new loaded bytes to totLoaded\n\t\t\t\t\tconst loadDiff = event.loaded <= 0 ? 0 : event.loaded - prevLoaded;\n\t\t\t\t\tif (isNaN(loadDiff) || !isFinite(loadDiff) || loadDiff < 0) return; // just in case\n\t\t\t\t\ttotLoaded += loadDiff;\n\t\t\t\t\tprevLoaded = event.loaded;\n\t\t\t\t}.bind(this);\n\t\t\t\txhr[i].onload = function() {\n\t\t\t\t\t// the large file has been loaded entirely, start again\n\t\t\t\t\ttverb(\"dl stream finished \" + i);\n\t\t\t\t\ttry {\n\t\t\t\t\t\txhr[i].abort();\n\t\t\t\t\t} catch (e) {} // reset the stream data to empty ram\n\t\t\t\t\ttestStream(i, 0);\n\t\t\t\t}.bind(this);\n\t\t\t\txhr[i].onerror = function() {\n\t\t\t\t\t// error\n\t\t\t\t\ttverb(\"dl stream failed \" + i);\n\t\t\t\t\tif (settings.xhr_ignoreErrors === 0) failed = true; //abort\n\t\t\t\t\ttry {\n\t\t\t\t\t\txhr[i].abort();\n\t\t\t\t\t} catch (e) {}\n\t\t\t\t\tdelete xhr[i];\n\t\t\t\t\tif (settings.xhr_ignoreErrors === 1) testStream(i, 0); //restart stream\n\t\t\t\t}.bind(this);\n\t\t\t\t// send xhr\n\t\t\t\ttry {\n\t\t\t\t\tif (settings.xhr_dlUseBlob) xhr[i].responseType = \"blob\";\n\t\t\t\t\telse xhr[i].responseType = \"arraybuffer\";\n\t\t\t\t} catch (e) {}\n\t\t\t\txhr[i].open(\"GET\", settings.url_dl + url_sep(settings.url_dl) + (settings.mpot ? \"cors=true&\" : \"\") + \"r=\" + Math.random() + \"&ckSize=\" + settings.garbagePhp_chunkSize, true); // random string to prevent caching\n\t\t\t\txhr[i].send();\n\t\t\t}.bind(this),\n\t\t\t1 + delay\n\t\t);\n\t}.bind(this);\n\t// open streams\n\tfor (let i = 0; i < settings.xhr_dlMultistream; i++) {\n\t\ttestStream(i, settings.xhr_multistreamDelay * i);\n\t}\n\t// every 200ms, update dlStatus\n\tinterval = setInterval(\n\t\tfunction() {\n\t\t\ttverb(\"DL: \" + dlStatus + (graceTimeDone ? \"\" : \" (in grace time)\"));\n\t\t\tconst t = new Date().getTime() - startT;\n\t\t\tif (graceTimeDone) dlProgress = (t + bonusT) / (settings.time_dl_max * 1000);\n\t\t\tif (t < 200) return;\n\t\t\tif (!graceTimeDone) {\n\t\t\t\tif (t > 1000 * settings.time_dlGraceTime) {\n\t\t\t\t\tif (totLoaded > 0) {\n\t\t\t\t\t\t// if the connection is so slow that we didn't get a single chunk yet, do not reset\n\t\t\t\t\t\tstartT = new Date().getTime();\n\t\t\t\t\t\tbonusT = 0;\n\t\t\t\t\t\ttotLoaded = 0.0;\n\t\t\t\t\t}\n\t\t\t\t\tgraceTimeDone = true;\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\tconst speed = totLoaded / (t / 1000.0);\n\t\t\t\tif (settings.time_auto) {\n\t\t\t\t\t//decide how much to shorten the test. Every 200ms, the test is shortened by the bonusT calculated here\n\t\t\t\t\tconst bonus = (5.0 * speed) / 100000;\n\t\t\t\t\tbonusT += bonus > 400 ? 400 : bonus;\n\t\t\t\t}\n\t\t\t\t//update status\n\t\t\t\tdlStatus = ((speed * 8 * settings.overheadCompensationFactor) / (settings.useMebibits ? 1048576 : 1000000)).toFixed(2); // speed is multiplied by 8 to go from bytes to bits, overhead compensation is applied, then everything is divided by 1048576 or 1000000 to go to megabits/mebibits\n\t\t\t\tif ((t + bonusT) / 1000.0 > settings.time_dl_max || failed) {\n\t\t\t\t\t// test is over, stop streams and timer\n\t\t\t\t\tif (failed || isNaN(dlStatus)) dlStatus = \"Fail\";\n\t\t\t\t\tclearRequests();\n\t\t\t\t\tclearInterval(interval);\n\t\t\t\t\tdlProgress = 1;\n\t\t\t\t\ttlog(\"dlTest: \" + dlStatus + \", took \" + (new Date().getTime() - startT) + \"ms\");\n\t\t\t\t\tdone();\n\t\t\t\t}\n\t\t\t}\n\t\t}.bind(this),\n\t\t200\n\t);\n}\n// upload test, calls done function when it's over\nlet ulCalled = false; // used to prevent multiple accidental calls to ulTest\nfunction ulTest(done) {\n\ttverb(\"ulTest\");\n\tif (ulCalled) return;\n\telse ulCalled = true; // ulTest already called?\n\t// garbage data for upload test\n\tlet r = new ArrayBuffer(1048576);\n\tconst maxInt = Math.pow(2, 32) - 1;\n\ttry {\n\t\tr = new Uint32Array(r);\n\t\tfor (let i = 0; i < r.length; i++) r[i] = Math.random() * maxInt;\n\t} catch (e) {}\n\tlet req = [];\n\tlet reqsmall = [];\n\tfor (let i = 0; i < settings.xhr_ul_blob_megabytes; i++) req.push(r);\n\treq = new Blob(req);\n\tr = new ArrayBuffer(262144);\n\ttry {\n\t\tr = new Uint32Array(r);\n\t\tfor (let i = 0; i < r.length; i++) r[i] = Math.random() * maxInt;\n\t} catch (e) {}\n\treqsmall.push(r);\n\treqsmall = new Blob(reqsmall);\n\tconst testFunction = function() {\n\t\tlet totLoaded = 0.0, // total number of transmitted bytes\n\t\t\tstartT = new Date().getTime(), // timestamp when test was started\n\t\t\tbonusT = 0, //how many milliseconds the test has been shortened by (higher on faster connections)\n\t\t\tgraceTimeDone = false, //set to true after the grace time is past\n\t\t\tfailed = false; // set to true if a stream fails\n\t\txhr = [];\n\t\t// function to create an upload stream. streams are slightly delayed so that they will not end at the same time\n\t\tconst testStream = function(i, delay) {\n\t\t\tsetTimeout(\n\t\t\t\tfunction() {\n\t\t\t\t\tif (testState !== 3) return; // delayed stream ended up starting after the end of the upload test\n\t\t\t\t\ttverb(\"ul test stream started \" + i + \" \" + delay);\n\t\t\t\t\tlet prevLoaded = 0; // number of bytes transmitted last time onprogress was called\n\t\t\t\t\tlet x = new XMLHttpRequest();\n\t\t\t\t\txhr[i] = x;\n\t\t\t\t\tlet ie11workaround;\n\t\t\t\t\tif (settings.forceIE11Workaround) ie11workaround = true;\n\t\t\t\t\telse {\n\t\t\t\t\t\ttry {\n\t\t\t\t\t\t\txhr[i].upload.onprogress;\n\t\t\t\t\t\t\tie11workaround = false;\n\t\t\t\t\t\t} catch (e) {\n\t\t\t\t\t\t\tie11workaround = true;\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\tif (ie11workaround) {\n\t\t\t\t\t\t// IE11 workaround: xhr.upload does not work properly, therefore we send a bunch of small 256k requests and use the onload event as progress. This is not precise, especially on fast connections\n\t\t\t\t\t\txhr[i].onload = xhr[i].onerror = function() {\n\t\t\t\t\t\t\ttverb(\"ul stream progress event (ie11wa)\");\n\t\t\t\t\t\t\ttotLoaded += reqsmall.size;\n\t\t\t\t\t\t\ttestStream(i, 0);\n\t\t\t\t\t\t};\n\t\t\t\t\t\txhr[i].open(\"POST\", settings.url_ul + url_sep(settings.url_ul) + (settings.mpot ? \"cors=true&\" : \"\") + \"r=\" + Math.random(), true); // random string to prevent caching\n\t\t\t\t\t\ttry {\n\t\t\t\t\t\t\txhr[i].setRequestHeader(\"Content-Encoding\", \"identity\"); // disable compression (some browsers may refuse it, but data is incompressible anyway)\n\t\t\t\t\t\t} catch (e) {}\n\t\t\t\t\t\t//No Content-Type header in MPOT branch because it triggers bugs in some browsers\n\t\t\t\t\t\txhr[i].send(reqsmall);\n\t\t\t\t\t} else {\n\t\t\t\t\t\t// REGULAR version, no workaround\n\t\t\t\t\t\txhr[i].upload.onprogress = function(event) {\n\t\t\t\t\t\t\ttverb(\"ul stream progress event \" + i + \" \" + event.loaded);\n\t\t\t\t\t\t\tif (testState !== 3) {\n\t\t\t\t\t\t\t\ttry {\n\t\t\t\t\t\t\t\t\tx.abort();\n\t\t\t\t\t\t\t\t} catch (e) {}\n\t\t\t\t\t\t\t} // just in case this XHR is still running after the upload test\n\t\t\t\t\t\t\t// progress event, add number of new loaded bytes to totLoaded\n\t\t\t\t\t\t\tconst loadDiff = event.loaded <= 0 ? 0 : event.loaded - prevLoaded;\n\t\t\t\t\t\t\tif (isNaN(loadDiff) || !isFinite(loadDiff) || loadDiff < 0) return; // just in case\n\t\t\t\t\t\t\ttotLoaded += loadDiff;\n\t\t\t\t\t\t\tprevLoaded = event.loaded;\n\t\t\t\t\t\t}.bind(this);\n\t\t\t\t\t\txhr[i].upload.onload = function() {\n\t\t\t\t\t\t\t// this stream sent all the garbage data, start again\n\t\t\t\t\t\t\ttverb(\"ul stream finished \" + i);\n\t\t\t\t\t\t\ttestStream(i, 0);\n\t\t\t\t\t\t}.bind(this);\n\t\t\t\t\t\txhr[i].upload.onerror = function() {\n\t\t\t\t\t\t\ttverb(\"ul stream failed \" + i);\n\t\t\t\t\t\t\tif (settings.xhr_ignoreErrors === 0) failed = true; //abort\n\t\t\t\t\t\t\ttry {\n\t\t\t\t\t\t\t\txhr[i].abort();\n\t\t\t\t\t\t\t} catch (e) {}\n\t\t\t\t\t\t\tdelete xhr[i];\n\t\t\t\t\t\t\tif (settings.xhr_ignoreErrors === 1) testStream(i, 0); //restart stream\n\t\t\t\t\t\t}.bind(this);\n\t\t\t\t\t\t// send xhr\n\t\t\t\t\t\txhr[i].open(\"POST\", settings.url_ul + url_sep(settings.url_ul) + (settings.mpot ? \"cors=true&\" : \"\") + \"r=\" + Math.random(), true); // random string to prevent caching\n\t\t\t\t\t\ttry {\n\t\t\t\t\t\t\txhr[i].setRequestHeader(\"Content-Encoding\", \"identity\"); // disable compression (some browsers may refuse it, but data is incompressible anyway)\n\t\t\t\t\t\t} catch (e) {}\n\t\t\t\t\t\t//No Content-Type header in MPOT branch because it triggers bugs in some browsers\n\t\t\t\t\t\txhr[i].send(req);\n\t\t\t\t\t}\n\t\t\t\t}.bind(this),\n\t\t\t\tdelay\n\t\t\t);\n\t\t}.bind(this);\n\t\t// open streams\n\t\tfor (let i = 0; i < settings.xhr_ulMultistream; i++) {\n\t\t\ttestStream(i, settings.xhr_multistreamDelay * i);\n\t\t}\n\t\t// every 200ms, update ulStatus\n\t\tinterval = setInterval(\n\t\t\tfunction() {\n\t\t\t\ttverb(\"UL: \" + ulStatus + (graceTimeDone ? \"\" : \" (in grace time)\"));\n\t\t\t\tconst t = new Date().getTime() - startT;\n\t\t\t\tif (graceTimeDone) ulProgress = (t + bonusT) / (settings.time_ul_max * 1000);\n\t\t\t\tif (t < 200) return;\n\t\t\t\tif (!graceTimeDone) {\n\t\t\t\t\tif (t > 1000 * settings.time_ulGraceTime) {\n\t\t\t\t\t\tif (totLoaded > 0) {\n\t\t\t\t\t\t\t// if the connection is so slow that we didn't get a single chunk yet, do not reset\n\t\t\t\t\t\t\tstartT = new Date().getTime();\n\t\t\t\t\t\t\tbonusT = 0;\n\t\t\t\t\t\t\ttotLoaded = 0.0;\n\t\t\t\t\t\t}\n\t\t\t\t\t\tgraceTimeDone = true;\n\t\t\t\t\t}\n\t\t\t\t} else {\n\t\t\t\t\tconst speed = totLoaded / (t / 1000.0);\n\t\t\t\t\tif (settings.time_auto) {\n\t\t\t\t\t\t//decide how much to shorten the test. Every 200ms, the test is shortened by the bonusT calculated here\n\t\t\t\t\t\tconst bonus = (5.0 * speed) / 100000;\n\t\t\t\t\t\tbonusT += bonus > 400 ? 400 : bonus;\n\t\t\t\t\t}\n\t\t\t\t\t//update status\n\t\t\t\t\tulStatus = ((speed * 8 * settings.overheadCompensationFactor) / (settings.useMebibits ? 1048576 : 1000000)).toFixed(2); // speed is multiplied by 8 to go from bytes to bits, overhead compensation is applied, then everything is divided by 1048576 or 1000000 to go to megabits/mebibits\n\t\t\t\t\tif ((t + bonusT) / 1000.0 > settings.time_ul_max || failed) {\n\t\t\t\t\t\t// test is over, stop streams and timer\n\t\t\t\t\t\tif (failed || isNaN(ulStatus)) ulStatus = \"Fail\";\n\t\t\t\t\t\tclearRequests();\n\t\t\t\t\t\tclearInterval(interval);\n\t\t\t\t\t\tulProgress = 1;\n\t\t\t\t\t\ttlog(\"ulTest: \" + ulStatus + \", took \" + (new Date().getTime() - startT) + \"ms\");\n\t\t\t\t\t\tdone();\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}.bind(this),\n\t\t\t200\n\t\t);\n\t}.bind(this);\n\tif (settings.mpot) {\n\t\ttverb(\"Sending POST request before performing upload test\");\n\t\txhr = [];\n\t\txhr[0] = new XMLHttpRequest();\n\t\txhr[0].onload = xhr[0].onerror = function() {\n\t\t\ttverb(\"POST request sent, starting upload test\");\n\t\t\ttestFunction();\n\t\t}.bind(this);\n\t\txhr[0].open(\"POST\", settings.url_ul);\n\t\txhr[0].send();\n\t} else testFunction();\n}\n// ping+jitter test, function done is called when it's over\nlet ptCalled = false; // used to prevent multiple accidental calls to pingTest\nfunction pingTest(done) {\n\ttverb(\"pingTest\");\n\tif (ptCalled) return;\n\telse ptCalled = true; // pingTest already called?\n\tconst startT = new Date().getTime(); //when the test was started\n\tlet prevT = null; // last time a pong was received\n\tlet ping = 0.0; // current ping value\n\tlet jitter = 0.0; // current jitter value\n\tlet i = 0; // counter of pongs received\n\tlet prevInstspd = 0; // last ping time, used for jitter calculation\n\txhr = [];\n\t// ping function\n\tconst doPing = function() {\n\t\ttverb(\"ping\");\n\t\tpingProgress = i / settings.count_ping;\n\t\tprevT = new Date().getTime();\n\t\txhr[0] = new XMLHttpRequest();\n\t\txhr[0].onload = function() {\n\t\t\t// pong\n\t\t\ttverb(\"pong\");\n\t\t\tif (i === 0) {\n\t\t\t\tprevT = new Date().getTime(); // first pong\n\t\t\t} else {\n\t\t\t\tlet instspd = new Date().getTime() - prevT;\n\t\t\t\tif (settings.ping_allowPerformanceApi) {\n\t\t\t\t\ttry {\n\t\t\t\t\t\t//try to get accurate performance timing using performance api\n\t\t\t\t\t\tlet p = performance.getEntries();\n\t\t\t\t\t\tp = p[p.length - 1];\n\t\t\t\t\t\tlet d = p.responseStart - p.requestStart;\n\t\t\t\t\t\tif (d <= 0) d = p.duration;\n\t\t\t\t\t\tif (d > 0 && d < instspd) instspd = d;\n\t\t\t\t\t} catch (e) {\n\t\t\t\t\t\t//if not possible, keep the estimate\n\t\t\t\t\t\ttverb(\"Performance API not supported, using estimate\");\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\t//noticed that some browsers randomly have 0ms ping\n\t\t\t\tif (instspd < 1) instspd = prevInstspd;\n\t\t\t\tif (instspd < 1) instspd = 1;\n\t\t\t\tconst instjitter = Math.abs(instspd - prevInstspd);\n\t\t\t\tif (i === 1) ping = instspd;\n\t\t\t\t/* first ping, can't tell jitter yet*/ else {\n\t\t\t\t\tif (instspd < ping) ping = instspd; // update ping, if the instant ping is lower\n\t\t\t\t\tif (i === 2) jitter = instjitter;\n\t\t\t\t\t//discard the first jitter measurement because it might be much higher than it should be\n\t\t\t\t\telse jitter = instjitter > jitter ? jitter * 0.3 + instjitter * 0.7 : jitter * 0.8 + instjitter * 0.2; // update jitter, weighted average. spikes in ping values are given more weight.\n\t\t\t\t}\n\t\t\t\tprevInstspd = instspd;\n\t\t\t}\n\t\t\tpingStatus = ping.toFixed(2);\n\t\t\tjitterStatus = jitter.toFixed(2);\n\t\t\ti++;\n\t\t\ttverb(\"ping: \" + pingStatus + \" jitter: \" + jitterStatus);\n\t\t\tif (i < settings.count_ping) doPing();\n\t\t\telse {\n\t\t\t\t// more pings to do?\n\t\t\t\tpingProgress = 1;\n\t\t\t\ttlog(\"ping: \" + pingStatus + \" jitter: \" + jitterStatus + \", took \" + (new Date().getTime() - startT) + \"ms\");\n\t\t\t\tdone();\n\t\t\t}\n\t\t}.bind(this);\n\t\txhr[0].onerror = function() {\n\t\t\t// a ping failed, cancel test\n\t\t\ttverb(\"ping failed\");\n\t\t\tif (settings.xhr_ignoreErrors === 0) {\n\t\t\t\t//abort\n\t\t\t\tpingStatus = \"Fail\";\n\t\t\t\tjitterStatus = \"Fail\";\n\t\t\t\tclearRequests();\n\t\t\t\ttlog(\"ping test failed, took \" + (new Date().getTime() - startT) + \"ms\");\n\t\t\t\tpingProgress = 1;\n\t\t\t\tdone();\n\t\t\t}\n\t\t\tif (settings.xhr_ignoreErrors === 1) doPing(); //retry ping\n\t\t\tif (settings.xhr_ignoreErrors === 2) {\n\t\t\t\t//ignore failed ping\n\t\t\t\ti++;\n\t\t\t\tif (i < settings.count_ping) doPing();\n\t\t\t\telse {\n\t\t\t\t\t// more pings to do?\n\t\t\t\t\tpingProgress = 1;\n\t\t\t\t\ttlog(\"ping: \" + pingStatus + \" jitter: \" + jitterStatus + \", took \" + (new Date().getTime() - startT) + \"ms\");\n\t\t\t\t\tdone();\n\t\t\t\t}\n\t\t\t}\n\t\t}.bind(this);\n\t\t// send xhr\n\t\txhr[0].open(\"GET\", settings.url_ping + url_sep(settings.url_ping) + (settings.mpot ? \"cors=true&\" : \"\") + \"r=\" + Math.random(), true); // random string to prevent caching\n\t\txhr[0].send();\n\t}.bind(this);\n\tdoPing(); // start first ping\n}\n// telemetry\nfunction sendTelemetry(done) {\n\tif (settings.telemetry_level < 1) return;\n\txhr = new XMLHttpRequest();\n\txhr.onload = function() {\n\t\ttry {\n\t\t\tconst parts = xhr.responseText.split(\" \");\n\t\t\tif (parts[0] == \"id\") {\n\t\t\t\ttry {\n\t\t\t\t\tlet id = parts[1];\n\t\t\t\t\tdone(id);\n\t\t\t\t} catch (e) {\n\t\t\t\t\tdone(null);\n\t\t\t\t}\n\t\t\t} else done(null);\n\t\t} catch (e) {\n\t\t\tdone(null);\n\t\t}\n\t};\n\txhr.onerror = function() {\n\t\tconsole.log(\"TELEMETRY ERROR \" + xhr.status);\n\t\tdone(null);\n\t};\n\txhr.open(\"POST\", settings.url_telemetry + url_sep(settings.url_telemetry) + (settings.mpot ? \"cors=true&\" : \"\") + \"r=\" + Math.random(), true);\n\tconst telemetryIspInfo = {\n\t\tprocessedString: clientIp,\n\t\trawIspInfo: typeof ispInfo === \"object\" ? ispInfo : \"\"\n\t};\n\ttry {\n\t\tconst fd = new FormData();\n\t\tfd.append(\"ispinfo\", JSON.stringify(telemetryIspInfo));\n\t\tfd.append(\"dl\", dlStatus);\n\t\tfd.append(\"ul\", ulStatus);\n\t\tfd.append(\"ping\", pingStatus);\n\t\tfd.append(\"jitter\", jitterStatus);\n\t\tfd.append(\"log\", settings.telemetry_level > 1 ? log : \"\");\n\t\tfd.append(\"extra\", settings.telemetry_extra);\n\t\txhr.send(fd);\n\t} catch (ex) {\n\t\tconst postData = \"extra=\" + encodeURIComponent(settings.telemetry_extra) + \"&ispinfo=\" + encodeURIComponent(JSON.stringify(telemetryIspInfo)) + \"&dl=\" + encodeURIComponent(dlStatus) + \"&ul=\" + encodeURIComponent(ulStatus) + \"&ping=\" + encodeURIComponent(pingStatus) + \"&jitter=\" + encodeURIComponent(jitterStatus) + \"&log=\" + encodeURIComponent(settings.telemetry_level > 1 ? log : \"\");\n\t\txhr.setRequestHeader(\"Content-Type\", \"application/x-www-form-urlencoded\");\n\t\txhr.send(postData);\n\t}\n}\n"
        }
      ]
    }
  ]
}